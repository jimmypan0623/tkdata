**程式名稱G11.人工製費分攤表
SET EXCL OFF
CLOSE ALL
CLEAR 
QTY=0
AREA1='G11_1'
FLG='0'
FCH=''
CHK=''
IF !USED('A01')
    SELE 0
    USE A01
ELSE 
   SELE A01
ENDIF
SET ORDER TO A01      
IF !USED('A14')
    SELE 0
    USE A14
ELSE 
   SELE A14
ENDIF
SET ORDER TO 1  
IF !USED('A23')
   SELE 0
   USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'G11'   
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1
G06='G06'+LEFT(DTOS(DATE()),6)   &&月報表檔
IF !USED('&G06')
   SELE 0
   USE (G06) ALIA G06  
ELSE
   SELE G06
ENDIF
SET ORDER TO 1 
SET RELATION TO F02 INTO A14
G08='G10'+LEFT(DTOS(DATE()),6)   &&月報表檔
IF !USED('&G08')
   SELE 0
   USE (G08) ALIA G08  
ELSE
   SELE G08
ENDIF
SET ORDER TO 1
SELECT F01,F05, SUM(F03),SUM(F04) FROM G08 GROUP BY F01,F05 ORDER BY F01,F05 INTO CURSOR G11_2 NOWAIT
CREATE CURSOR G11_1;
(F01 C(43),F02 C(5),F03 N (13),F04 N(16))
INDEX ON F01+F02 TAG G11_11
INDEX ON F02+F01 TAG G11_12
SET ORDER TO 1
SET RELATION TO F01 INTO B01
SET RELATION TO F02 INTO G06 ADDI
SELECT G11_2
GO TOP
DO WHILE !EOF()
       SELECT G11_1
       APPEND BLANK
       REPLACE F01 WITH G11_2.F01
       REPLACE F02 WITH G11_2.F05
       REPLACE F03 WITH G11_2.SUM_F03
       REPLACE F04 WITH G11_2.SUM_F04
       SELECT G11_2
       SKIP
ENDDO
SELECT G11_2
USE
SELECT G11_1 
GO TOP
*****************
G11FORM=CREATEOBJECT("TKG11")
G11FORM.SHOW  
DEFINE CLASS TKG11 AS FORM
  CAPTION='G11.人工製費分攤表'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
*!*	  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
*!*	      AUTOCENTER=.T.
*!*	  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
*!*	      AUTOCENTER=.T.
*!*	  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
*!*	      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      LEFT=INT_015*660,;
      AUTOCENTER =.T.,;
      CAPTION='資料筆數',;
      TOP=INT_015*9
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      TOP=INT_015*9
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
           AUTOCENTER=.T.,;  
          WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
            AUTOCENTER=.T.                  
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=9,;            
      RECORDSOURCE='G11_1',; 
      HEIGHT=INT_015*500,;     
      WIDTH=INT_015*780,;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',; 
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7',;      
      COLUMN8.NAME='COLUMN8',;            
      COLUMN9.NAME='COLUMN9'       
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;      
      TOP=INT_015*0,;
      LEFT=INT_015*435             
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*0,;
      LEFT=INT_015*220,;
      ENABLED=.T.,;
      VISIBLE=.T.  
*****************                       
PROCEDURE INIT
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.
       CHK_STR=THISFORM.MTH_LIST.DISPLAYVALUE       
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*169
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*70
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*70 
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*75       
       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*80    
       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*80  
       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*80             
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='產出品號'
	   THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='流水編號'
  	   THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='部門名稱'
  	   THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='總 工 點'
  	   THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='生產數量' 
  	   THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='使用工點'   	   
  	   THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='直接人工'   	
  	   THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='間接費用'   	
  	   THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='間接材料'   	
	   THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G11_1.F01'
	   THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01.F99'
	   THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
	   THISFORM.GRID1.COLUMN4.CONTROLSOURCE='G06.F07'
	   THISFORM.GRID1.COLUMN5.CONTROLSOURCE='G11_1.F03'
	   THISFORM.GRID1.COLUMN6.CONTROLSOURCE="G11_1.F04"   	   
	   THISFORM.GRID1.COLUMN7.CONTROLSOURCE="ROUND(G06.F03*G11_1.F04/G06.F07,2)"
	   THISFORM.GRID1.COLUMN8.CONTROLSOURCE="ROUND(G06.F04*G11_1.F04/G06.F07,2)"	   
	   THISFORM.GRID1.COLUMN9.CONTROLSOURCE="ROUND(G06.F12*G11_1.F04/G06.F07,2)"	   
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID1.SETFOCUS
       JK='產出品號'
  ENDPROC     
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依產出品號排列')   
           .ADDITEM('依加工部門排列') 
       ENDWITH      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE
       SELECT G11_1
       IF THIS.DISPLAYVALUE='依產出品號排列'          
          SET ORDER TO 1
          THISFORM.GRID1.COLUMN1.WIDTH=INT_015*169
          THISFORM.GRID1.COLUMN2.WIDTH=INT_015*70
          THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70
          THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='產出品號'
	      THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='流水編號'
  	      THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='部門名稱'         
	      THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G11_1.F01'
	      THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01.F99'
	      THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'  	       
          JK='產出品號'
       ELSE
          SET ORDER TO 2
          THISFORM.GRID1.COLUMN1.WIDTH=INT_015*70       
          THISFORM.GRID1.COLUMN2.WIDTH=INT_015*169
          THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70    
  	      THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='部門名稱'         
  	      THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='產出品號'
  	      THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='流水編號'
	      THISFORM.GRID1.COLUMN1.CONTROLSOURCE='A14.F02'  	        
		  THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G11_1.F01'
	      THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B01.F99'	              
          JK='加工部門'       
       ENDIF
       THISFORM.GRID1.SETFOCUS
  ENDPROC   
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       CHK_STR=THISFORM.MTH_LIST.DISPLAYVALUE       

       SELECT G08
       USE
       SELE G11_1
       SET RELATION OFF INTO B01
       SET RELATION OFF INTO G06
       USE
       SELECT G06
       SET RELATION OFF INTO A14
       USE     
       G06='G06'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&G06')
          SELE 0
          USE (G06) ALIA G06
       ELSE
          SELE G06
       ENDIF
       SET ORDER TO 1                             
       SET RELATION TO F02 INTO A14
       G08='G08'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&G10')
          SELE 0
          USE (G08) ALIA G08
       ELSE
          SELE G08
       ENDIF
       SET ORDER TO 1                      
       SELECT F01,F05, SUM(F03),SUM(F04) FROM G08 GROUP BY F01,F05 ORDER BY F01,F05 INTO CURSOR G11_2 NOWAIT
       CREATE CURSOR G11_1;
       (F01 C(43),F02 C(5),F03 N (13),F04 N(16))
       INDEX ON F01+F02 TAG G11_11
       INDEX ON F02+F01 TAG G11_12
       SET ORDER TO 1
       SET RELATION TO F01 INTO B01
       SET RELATION TO F02 INTO G06 ADDI
       SELECT G11_2
       GO TOP
       DO WHILE !EOF()
          SELECT G11_1
          APPEND BLANK
          REPLACE F01 WITH G11_2.F01
          REPLACE F02 WITH G11_2.F05
          REPLACE F03 WITH G11_2.SUM_F03
          REPLACE F04 WITH G11_2.SUM_F04
          SELECT G11_2
          SKIP
       ENDDO
       SELECT G11_2
       USE
       SELECT G11_1 
       GO TOP
       THISFORM.GRID1.RECORDSOURCE='G11_1'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*169
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*70
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*70 
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*75       
       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*80    
       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*80  
       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*80             
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='產出品號'
	   THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='流水編號'
  	   THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='部門名稱'
  	   THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='總 工 點'
  	   THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='生產數量' 
  	   THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='使用工點'   	   
  	   THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='直接人工'   	
  	   THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='相關費用'   	
  	   THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='間接材料'   	  	   
	   THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G11_1.F01'
	   THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01.F99'
	   THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
	   THISFORM.GRID1.COLUMN4.CONTROLSOURCE='G06.F07'
	   THISFORM.GRID1.COLUMN5.CONTROLSOURCE='G11_1.F03'
	   THISFORM.GRID1.COLUMN6.CONTROLSOURCE="G11_1.F04"         
	   THISFORM.GRID1.COLUMN7.CONTROLSOURCE="ROUND(G06.F03*G11_1.F04/G06.F07,2)"
	   THISFORM.GRID1.COLUMN8.CONTROLSOURCE="ROUND(G06.F04*G11_1.F04/G06.F07,2)"	   
	   THISFORM.GRID1.COLUMN9.CONTROLSOURCE="ROUND(G06.F12*G11_1.F04/G06.F07,2)"	   
       THISFORM.GRID1.SETFOCUS                           
	   THISFORM.REFRESH
	   thisform.grid1.setfocus        
  ENDPROC     
*********************************                  
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.REC_COUNT.CAPTION=STR(RECCOUNT('G11_1'))
       FCH=THISFORM.ACTIVECONTROL.NAME
       CHK=''
       THISFORM.REFRESH
  ENDPROC       
ENDDEFINE        
***********************************************列印程序
PROCEDURE PNT_PRC  
    SELECT G11_1
    IF KEY()='F01+F02'
        SELECT G11_1.F01,B01.F99,A14.F02,G06.F07,G11_1.F03,G11_1.F04,ROUND(G06.F03*G11_1.F04/G06.F07,2),ROUND(G06.F04*G11_1.F04/G06.F07,2),ROUND(G06.F12*G11_1.F04/G06.F07,2) FROM G11_1,B01,A14,G06 WHERE B01.F01=G11_1.F01;
        AND A14.F01=G11_1.F02 AND G06.F02=G11_1.F02 AND ROUND(G06.F03*G11_1.F04/G06.F07,2)+ROUND(G06.F04*G11_1.F04/G06.F07,2)+ROUND(G06.F12*G11_1.F04/G06.F07,2)>0 ORDER BY G11_1.F01,G11_1.F02  NOWAIT
        IF _TALLY>0
           REPORT FORM ALLTRIM(INT_116)+'G11A' TO PRINT PROMPT PREVIEW
           COPY TO KK1 TYPE XL5
       ENDIF
    ELSE
        SELECT G11_1.F01,B01.F99,A14.F02,G06.F07,G11_1.F03,G11_1.F04,ROUND(G06.F03*G11_1.F04/G06.F07,2),ROUND(G06.F04*G11_1.F04/G06.F07,2),ROUND(G06.F12*G11_1.F04/G06.F07,2) FROM G11_1,B01,A14,G06 WHERE B01.F01=G11_1.F01;
        AND A14.F01=G11_1.F02 AND G06.F02=G11_1.F02 AND ROUND(G06.F03*G11_1.F04/G06.F07,2)+ROUND(G06.F04*G11_1.F04/G06.F07,2)+ROUND(G06.F12*G11_1.F04/G06.F07,2)>0 ORDER BY G11_1.F02,G11_1.F01  NOWAIT
        IF _TALLY>0
           REPORT FORM ALLTRIM(INT_116)+'G11B' TO PRINT PROMPT PREVIEW
           COPY TO KK1 XLS
       ENDIF   
    ENDIF   
ENDPROC
***********************************************列印範圍選定
