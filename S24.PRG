**程式名稱:S24.年假紀錄查詢
SET EXCL OFF
CLOSE ALL
CLEAR 
PRG_NO='S24'
AREA1='S0B_TEMP'
FLG='0'
FCH=''
CHK=''
HK=''
IF !USED('A01')	&&操作人員資料設定
   SELECT  0
   USE A01
ELSE 
   SELECT  A01
ENDIF
SET ORDER TO A01    
IF !USED('A23')	&&月份檔
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO A231   
IF !USED('S05')  &&人事薪資基本檔
   SELECT  0
   USE S05 
ELSE
   SELECT  S05
ENDIF
SET ORDER TO S051 
IF !USED('A02')	&&權限設定檔
   SELECT  0
   USE A02 INDE A02
ELSE
   SELECT  A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'S24'   
IF !USED('S0A')  &&年度缺勤紀錄檔
   SELE 0
   USE S0A
ELSE
   SELE S0A
ENDIF
SET ORDER TO S0A1 
SELECT S0A.F01,SUM(F07) FROM S0A WHERE F05='A1' AND LEFT(DTOS(F08),4)=LEFT(DTOS(DATE()),4)  GROUP BY S0A.F01 INTO CURSOR S0A_TEMP
INDE ON F01 TAG S0A_TEMP1
SET ORDER TO S0A_TEMP1
IF !USED('S0B')	&&年假記錄檔 
   SELECT  0
   USE S0B
ELSE
   SELECT  S0B
ENDIF
SET ORDER TO S0B1
IF A02.F08 <> '*'
    SELECT A01
    SEEK SYS_OPER
    IF FOUND() 
         SELECT S05.F01,S05.F02,S05.F11,S05.F12 FROM S05 WHERE S05.F01=A01.F12  AND S05.F30='1' INTO CURSOR S05_TEMP
         SELECT * FROM S0B WHERE S0B.F01=A01.F12 ORDER BY S0B.F03 INTO CURSOR S0B_TEMP READWRITE 
         INDE ON F01+F03 TAG S0B_TEMP1
         SET ORDER TO S0B_TEMP1
         SELECT S05_TEMP
         GO TOP
         DO WHILE !EOF()
                SELECT S0B_TEMP
                SEEK S05_TEMP.F01+LEFT(DTOS(DATE()),4)
                IF !FOUND()
                     SELECT S0B_TEMP
                     APPEND BLANK 
                     REPLACE S0B_TEMP.F01 WITH S05_TEMP.F01
                     REPLACE S0B_TEMP.F02 WITH S05_TEMP.F02
                     REPLACE S0B_TEMP.F03 WITH LEFT(DTOS(DATE()),4)
                     REPLACE S0B_TEMP.F04 WITH S05_TEMP.F11
*!*	                     REPLACE S0B_TEMP.F05 WITH S05_TEMP.F12
                     REPLACE S0B_TEMP.F05 WITH IIF(SEEK(S05_TEMP.F01,'S0A_TEMP'),S0A_TEMP.SUM_F07,0)
                ENDIF
                SELECT S05_TEMP
                SKIP
         ENDDO
         SELECT S05_TEMP
         USE
    ELSE
         SELECT * FROM S0B WHERE EMPTY(S0B.F01) ORDER BY S0B.F03 INTO CURSOR S0B_TEMP READWRITE
         INDE ON F01+F03 TAG S0B_TEMP1   
         SET ORDER TO S0B_TEMP1   
    ENDIF
ELSE
     SELECT S05.F01,S05.F02,S05.F11,S05.F12 FROM S05 WHERE F30='1' ORDER BY S05.F01  INTO CURSOR S05_TEMP
     SELECT * FROM S0B  ORDER BY S0B.F01,S0B.F03 INTO CURSOR S0B_TEMP READWRITE 
     INDE ON F01+F03 TAG S0B_TEMP1
     SET ORDER TO S0B_TEMP1
     SELECT S05_TEMP
     GO TOP
     DO WHILE !EOF()
            SELECT S0B_TEMP
            SEEK S05_TEMP.F01+LEFT(DTOS(DATE()),4)
            IF !FOUND()
                 SELECT S0B_TEMP
                 APPEND BLANK 
                 REPLACE S0B_TEMP.F01 WITH S05_TEMP.F01
                 REPLACE S0B_TEMP.F02 WITH S05_TEMP.F02
                 REPLACE S0B_TEMP.F03 WITH LEFT(DTOS(DATE()),4)
                 REPLACE S0B_TEMP.F04 WITH S05_TEMP.F11
*!*	                 REPLACE S0B_TEMP.F05 WITH S05_TEMP.F12
 		         REPLACE S0B_TEMP.F05 WITH IIF(SEEK(S05_TEMP.F01,'S0A_TEMP'),S0A_TEMP.SUM_F07,0)
            ENDIF
            SELECT S05_TEMP
           SKIP
     ENDDO
     SELECT S05_TEMP
     USE     
ENDIF
SELECT S0B_TEMP
SET ORDER TO S0B_TEMP1
GO TOP
*********
S24FORM=CREATEOBJECT("TKS24")
S24FORM.SHOW  
DEFINE CLASS TKS24 AS FORM
  CAPTION='S24.年假紀錄查詢'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*791
  WINDOWTYPE=1      
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=6,;            
      RECORDSOURCE='S0B_TEMP',; 
      HEIGHT=INT_015*500,;     
      WIDTH=INT_015*780,;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',; 
      COLUMN5.NAME='COLUMN5',;             
      COLUMN6.NAME='COLUMN6'
   ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*0,;
      LEFT=INT_015*205,;
      ENABLED=.T.,;
      VISIBLE=.T.            
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;      
      TOP=INT_015*0,;
      LEFT=INT_015*405                                                         
  PROCEDURE INIT
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)   
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')   
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='人員編號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='人員姓名'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='年假年度'		
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='可休天數'	   
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='已休天數'
       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='剩餘天數'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='S0B_TEMP.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='S0B_TEMP.F02'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='S0B_TEMP.F03'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='S0B_TEMP.F04'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='S0B_TEMP.F05'
       THISFORM.GRID1.COLUMN6.CONTROLSOURCE="S0B_TEMP.F04-S0B_TEMP.F05"
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID1.SETFOCUS    
        IF  THISFORM.GRID1.ACTIVEROW=0 
              THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.   
        ELSE
              THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
        ENDIF       
       JK='人員編號'
  ENDPROC                 
********
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       FCH=THISFORM.ACTIVECONTROL.NAME
       CHK=''
       THISFORM.REFRESH
  ENDPROC       
ENDDEFINE      
***********************************************列印程序
PROCEDURE PNT_PRC  
   SELECT S0B_TEMP
   ANS_RANGE=CREATEOBJECT("ANS_RANGE")  
   ANS_RANGE.SHOW    
ENDPROC 
***********************************************列印範圍選定
DEFINE CLASS ANS_RANGE AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION='請輸入列印資料範圍'
  TOP=INT_015*200
  LEFT=INT_015*250 
  HEIGHT=INT_015*155
  WIDTH=INT_015*280
  FONTSIZE=INT_015*9
  MOVABLE=.F.
  MAXBUTTON=.F.
  MINBUTTON=.F.   
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_RANGE'
  ADD OBJECT LABEL3 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*26,;
      CAPTION='起始年假年度',;
      NAME='LABEL3'
  ADD OBJECT TEXT3 AS TEXTBOX WITH;
      TOP=INT_015*20,;
      LEFT=INT_015*110,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*60,; 
      MAXLENGTH=4,;
      NAME='TEXT3'      
  ADD OBJECT LABEL4 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*56,;
      CAPTION='截止年假年度',;
      NAME='LABEL4'
  ADD OBJECT TEXT4 AS TEXTBOX WITH;
      TOP=INT_015*50,;
      LEFT=INT_015*110,;
      HEIGHT=INT_015*25,;   
      WIDTH=INT_015*60,;     
      MAXLENGTH=4,;   
      NAME='TEXT4'      
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*86,;
      CAPTION='起始員工編號',;
      NAME='LABEL1'
  ADD OBJECT TEXT1 AS TEXTBOX WITH;
      TOP=INT_015*80,;
      LEFT=INT_015*110,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*60,; 
      MAXLENGTH=4,;
      NAME='TEXT1'      
  ADD OBJECT LABEL2 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*116,;
      CAPTION='截止員工編號',;
      NAME='LABEL2'
  ADD OBJECT TEXT2 AS TEXTBOX WITH;
      TOP=INT_015*110,;
      LEFT=INT_015*110,;
      HEIGHT=INT_015*25,;   
      WIDTH=INT_015*60,;     
      MAXLENGTH=4,;   
      NAME='TEXT2'    
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*190,;    
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*70,;    
      TOP=INT_015*35,;  
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;        
      CAPTION='\<P.列         印',;
      TOOLTIPTEXT='列印所輸入的範圍鍵值!快速鍵->ALT+Y',;
      NAME='CMND1' 
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      LEFT=INT_015*190,;
      TOP=INT_015*95,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*70,; 
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;        
      CAPTION='\<C.取        消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND3'
  PROCEDURE INIT 
      THISFORM.SETALL('FONTSIZE',INT_015*10,'TEXTBOX')
      THISFORM.SETALL('FONTSIZE',INT_015*10,'LABEL')      
      THISFORM.SETALL('FONTSIZE',INT_015*10,'COMMANDBUTTON')    
      THISFORM.LABEL1.CAPTION='起始員工編號' 
      THISFORM.LABEL2.CAPTION='截止員工編號' 
      THISFORM.TEXT1.VALUE=S0B_TEMP.F01
      THISFORM.TEXT2.VALUE=S0B_TEMP.F01       
      THISFORM.TEXT3.VALUE=S0B_TEMP.F03       
      THISFORM.TEXT4.VALUE=S0B_TEMP.F03             
  ENDPROC   
  *** 
  PROCEDURE CMND1.CLICK 
      IF  EMPTY(THISFORM.TEXT3.VALUE)
           =MESSAGEBOX('起始年假年度不得為空白!',0+64,'提示訊息視窗')
           THISFORM.TEXT3.SETFOCUS
  	   RETURN 
      ENDIF  
      IF  EMPTY(THISFORM.TEXT4.VALUE)
           =MESSAGEBOX('截止年假年度不得為空白!',0+64,'提示訊息視窗')
           THISFORM.TEXT4.SETFOCUS
  	   RETURN 
      ENDIF        
      IF  LEN(ALLTRIM(THISFORM.TEXT3.VALUE)) <> 4
           =MESSAGEBOX('起始年假年度必須為西元年共四碼!',0+64,'提示訊息視窗')
           THISFORM.TEXT3.SETFOCUS
  	   RETURN 
      ENDIF        
      IF  LEN(ALLTRIM(THISFORM.TEXT4.VALUE)) <> 4
           =MESSAGEBOX('截止年假年度必須為西元年共四碼!',0+64,'提示訊息視窗')
           THISFORM.TEXT4.SETFOCUS
  	   RETURN 
      ENDIF           
      IF  EMPTY(THISFORM.TEXT1.VALUE)
           =MESSAGEBOX('起始編號不得為空白!',0+64,'提示訊息視窗')
           THISFORM.TEXT1.SETFOCUS
  	   RETURN 
      ENDIF
      IF  EMPTY(THISFORM.TEXT2.VALUE)
           =MESSAGEBOX('截止編號不得為空白!',0+64,'提示訊息視窗')
           THISFORM.TEXT2.SETFOCUS
  	   RETURN 
      ENDIF      
      SELECT  * FROM S0B_TEMP WHERE F01>=THISFORM.TEXT1.VALUE AND F01<=THISFORM.TEXT2.VALUE AND F03>=THISFORM.TEXT3.VALUE AND F03<=THISFORM.TEXT4.VALUE ORDER BY F01 NOWAIT
      IF  _TALLY >0
	  REPORT FORM ALLTRIM(INT_116)+'S24'  TO PRINTER PROMPT  PREVIEW  
      ELSE
	   =MESSAGEBOX('查無此範圍資料',0+48,'警示')
	   THISFORM.TEXT1.SETFOCUS
	   RETURN     
      ENDIF                                                         
     THISFORM.CMND3.CLICK
  ENDPROC   
  ****
  PROCEDURE CMND3.CLICK
      THISFORM.RELEASE
  ENDPROC      
  PROC CMND1.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND1.TOP=INT_015*36
             THISFORM.CMND1.LEFT=INT_015*191
  ENDPROC     
  PROC CMND1.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND1.TOP=INT_015*35
             THISFORM.CMND1.LEFT=INT_015*190                  
  ENDPROC     
  PROC CMND3.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND3.TOP=INT_015*96
             THISFORM.CMND3.LEFT=INT_015*191
  ENDPROC     
  PROC CMND3.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND3.TOP=INT_015*95
             THISFORM.CMND3.LEFT=INT_015*190                  
  ENDPROC   
ENDDEFINE                