***程式名稱B23.簡易盤點表
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
R=0
AREA1='B23_1'
AREA2='B23'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'B23'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO A091
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET FILTER TO F04='*'
SET ORDER TO A141            
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1   
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO B011     
*!*	SET FILTER TO !EMPTY(F98)
IF !USED('B11')
   SELE 0
   USE B11 INDE B11
ELSE
   SELE B11
ENDIF
SET ORDER TO B111  
SELECT B11.F01,B11.F03,SUM(B11.F04) FROM B11 GROUP BY B11.F01,B11.F03 INTO CURSOR B11_2 ORDER BY B11.F01,B11.F03 NOWAIT
CREATE CURSOR B11_1 (F01 C(5),F03 C(43),F04 N(14,4))
INDEX ON F01+F03 TAG B11_11
SET ORDER TO 1
SELECT B11_2
GO TOP
DO WHILE !EOF()
   SELECT B11_1
   APPEND BLANK
   REPLACE F01 WITH B11_2.F01
   REPLACE F03 WITH B11_2.F03
   REPLACE F04 WITH B11_2.SUM_F04
  SELECT B11_2
  SKIP
ENDDO
SELECT B11_2
USE
SELECT B11
USE
IF !USED('B22')
   SELE 0
   USE B22 INDE B22
ELSE
   SELE B22
ENDIF
SET ORDER TO B221  
IF !USED('B23')
   SELE 0
   USE B23 INDE B23
ELSE
   SELE B23
ENDIF
SET ORDER TO B231     
SET RELA TO F05 INTO B01
SET RELA TO F02+F05 INTO B11_1 ADDI
CREATE CURSOR B23_1;
(F01 C(10),F02 C(5),F03 C(5),F04 D(8),F07 C(17),F08 C(1),F09 C(17),F10 C(10),F90 C(17))
INDE ON F01 TAG B23_11
INDE ON F02 TAG B23_12
SELE F01,F02,F03,F04,F07,F08,F09,F10,F90 FROM B23 GROUP BY F01 ORDER BY F01 INTO CURSOR B23_TEMP
SELE B23_TEMP
GO TOP
DO WHILE !EOF()
   SELE B23_1
   APPEND BLANK
   REPL F01 WITH B23_TEMP.F01
   REPL F02 WITH B23_TEMP.F02
   REPL F03 WITH B23_TEMP.F03
   REPL F04 WITH B23_TEMP.F04
   REPL F07 WITH B23_TEMP.F07
   REPL F08 WITH B23_TEMP.F08
   REPL F09 WITH B23_TEMP.F09
   REPL F10 WITH B23_TEMP.F10
   REPL F90 WITH B23_TEMP.F90
   SELE B23_TEMP
   SKIP   
ENDDO
SELE B23_TEMP
USE   
SELE B23_1
SET ORDER TO B23_11
SET RELA TO F02 INTO A14
SET RELA TO F03 INTO A01 ADDI
*********************
B23FORM=CREATEOBJECT("TKB23")
B23FORM.SHOW  
DEFINE CLASS TKB23 AS FORM
  CAPTION='B23.簡易盤點表'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKB23'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=3,;            
      RECORDSOURCE='B23_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3'
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=4,;            
      RECORDSOURCE='B23',; 
      LINKMASTER='B23_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER='B231',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*558          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*88,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<A.轉盤點差異表',;
      NAME='ANS_BOTT'   
  ADD OBJECT VRT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*105,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*100,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<V.反轉盤點差異表',;
      NAME='VRT_BOTT'            
**********                   
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*15
          .WIDTH=INT_015*50
          .CAPTION='盤點單號'          
     ENDWITH
  THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('LBLF02','LABEL')     
     WITH THIS.LBLF02
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*40
          .WIDTH=INT_015*50  
          .CAPTION='盤點部門'
     ENDWITH  
     THIS.ADDOBJECT('LBLF021','LABEL')     
     WITH THIS.LBLF021
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*40
          .AUTOSIZE=.T.
          .CAPTION=''
     ENDWITH   
     THIS.ADDOBJECT('TXTF02','TXTF02')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH                              
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*65
         .WIDTH=INT_015*50
         .CAPTION='盤點人員'
     ENDWITH 
      THIS.ADDOBJECT('LBLF031','LABEL')
     WITH THIS.LBLF031
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*65
          .AUTOSIZE=.T.
          .CAPTION=''
     ENDWITH 
     THIS.ADDOBJECT('TXTF03','TXTF03') 
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH      
    THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*90
         .WIDTH=INT_015*100
         .CAPTION='備註說明'
     ENDWITH
    THIS.ADDOBJECT('TXTF07','TEXTBOX')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*150
          .HEIGHT=INT_015*25
          .MAXLENGTH=20
     ENDWITH 
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*15
         .WIDTH=INT_015*60
         .CAPTION='盤點日期'
     ENDWITH  
   THIS.ADDOBJECT('TXTF04','TEXTBOX')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*9
          .WIDTH=INT_015*70
          .HEIGHT=INT_015*25
     ENDWITH      
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*130
         .WIDTH=INT_015*50
         .CAPTION='狀        態'
     ENDWITH    
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*130
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*70
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*70
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*95
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*95
         .AUTOSIZE=.T.
     ENDWITH        
  ENDPROC   
PROCEDURE PAGEFRAME1.PAGE2.INIT
  THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05  
	    .VISIBLE=.T.
            .LEFT=INT_015*14
            .TOP=INT_015*18
	    .WIDTH=INT_015*50
            .CAPTION='料品編號'
    ENDWITH  
 THIS.ADDOBJECT('LBLF051','LABEL')
     WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*327
	 .TOP=INT_015*18
	 .AUTOSIZE=.T.
     ENDWITH     
  THIS.ADDOBJECT('TXTF05','TXTF05')
	WITH THIS.TXTF05      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF05'  
       ENDWITH   
 THIS.ADDOBJECT('LBLF10','LABEL')
    WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*43
         .WIDTH=INT_015*50
         .CAPTION='單        位'         
   ENDWITH   
  THIS.ADDOBJECT('LBLF101','LABEL')
    WITH THIS.LBLF101
         .VISIBLE=.T.
         .LEFT=INT_015*66
         .TOP=INT_015*43
         .WIDTH=INT_015*50
         .CAPTION=''         
  ENDWITH      	
 THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='實盤數量'         
   ENDWITH   
THIS.ADDOBJECT('TXTF06','TEXTBOX')
	WITH THIS.TXTF06
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*64
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .ALIGNMENT=1
	     .INPUTMASK='999999999.9999'
	     .NAME='TXTF06'	    
     ENDWITH  
    THIS.ADDOBJECT('LBLF09','LABEL')
    WITH THIS.LBLF09
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*143
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF091','LABEL')
    WITH THIS.LBLF091
        .VISIBLE=.T.           
        .LEFT=INT_015*380
        .TOP=INT_015*143
        .AUTOSIZE=.T.
    ENDWITH    
  ENDPROC 
********     
PROC INIT       
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)  
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='盤點單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='盤點部門'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='部門簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B23_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B23_1.F02'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*70
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*55
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(B23_1.F08),RGB(255,0,0),IIF(B23_1.F08<>'2',RGB(0,255,255),''))","COLUMN")     
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')           
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='單位'
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='實盤數量'
       THISFORM.GRID2.LINKMASTER='B23_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B23.F05'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='B01.F04'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B23.F06'
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*30
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*80
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. EMPTY(B23_1.F08)   &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. EMPTY(B23_1.F08)   &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08)  .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
          THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.)  .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
       ENDIF          
*       THISFORM.KEY_LIST.DISPLAYVALUE='依盤差單號排列'      
       JK='盤差單號'
       SELE B23_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B23_1.F01
  ENDPROC     
********************     
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELECT  B23_1       
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(B23_1.F08),RGB(255,0,0),IIF(B23_1.F08<>'2',RGB(0,255,255),''))","COLUMN")     
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
     ENDIF              
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.        
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''       
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''                   
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. EMPTY(B23_1.F08)&&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. EMPTY(B23_1.F08) &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
  ENDPROC
  ***********
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
       SELE B23
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.    
        THISFORM.GRID2.SETFOCUS    
     ENDIF 
     THISFORM.ANS_BOTT.ENABLED=.F. 
     THISFORM.VRT_BOTT.ENABLED=.F. 
     IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. EMPTY(B23_1.F08) &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. EMPTY(B23_1.F08) &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
     ENDIF
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. EMPTY(B23_1.F08) &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC
********************    
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B23_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=B23_1.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=B23_1.F03
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=B23_1.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=B23_1.F07
       THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=A01.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(EMPTY(B23_1.F08),'尚未處理',IIF(B23_1.F08<>'2','已轉至B22.盤點差異表 表號：'+B23_1.F10,'已轉B09.盤差調整單 單號：'+IIF(SEEK(B23_1.F10,'B22'),B22.F08,'')+'    B22.盤點差異表 表號：'+B23_1.F10))
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.BACKCOLOR=IIF(EMPTY(B23_1.F08),RGB(255,0,0),IIF(B23_1.F08<>'2',RGB(0,255,255),RGB(58,186,152)))
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=B23_1.F09
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=B23_1.F90
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. EMPTY(B23_1.F08)  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. EMPTY(B23_1.F08) &&判斷有無刪除的權限
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T. 
          THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED    
          THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                            
       ENDIF   
       CHK=''     
*       THISFORM.REFRESH
  ENDPROC    
 ***************  
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=B23.F05
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=B23.F06      
       THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=B23.F09
       THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=B01.F04
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM. CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ENDIF   
*       THISFORM.REFRESH
  ENDPROC      
**************             
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依盤點單號排列')
           .ADDITEM('依盤點部門排列')
           .VALUE=1
       ENDWITH
  ENDPROC 
***********   
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE B23_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依盤點單號排列'
               SET ORDER TO B23_11 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='盤點單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B23_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*70
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='盤點部門'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B23_1.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='部門簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*55           
          CASE THIS.DISPLAYVALUE='依盤點部門排列'
               SET ORDER TO B23_12
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='盤點部門'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B23_1.F02'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*55
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='盤點單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B23_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70                                                                                                            
       ENDCASE 
        THISFORM.GRID1.SETFOCUS
  ENDPROC  
****************
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.VRT_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
*       IF INT_099=.T.
          H='B070 '+SUBSTR(DTOS(DATE()),3,4)
          SELE A24   
          SET ORDER TO 1
          SEEK H           
          IF FOUND() 
             PO_NO=F08
             RLOCK()
             DELE 
             UNLOCK
          ELSE
             SELE A09
             SEEK H            
             IF .NOT.FOUND()                                                  &&如果為本月第一張訂單則重頭開始編號
		  APPEND BLANK                                                
		  REPL F01 WITH 'B070 '
		  REPL F02 WITH  SUBSTR(DTOS(DATE()),3,4)
		  REPL F05 WITH 'BJ'+F02
		  REPL F06 WITH '簡易盤點表'
		  REPL F08 WITH ALLTRIM(F05)+'0000'
	      ENDIF
		    LOCK()
*		    PO_NO=RIGHT(F08,4)
		    HX=VAL(RIGHT(F08,4))+1
*		    PO_NO='0000'
		    PO_NO=LEFT(F08,6)+PADL(ALLTRIM(STR(HX)),4,'0')
		    REPL F08 WITH PO_NO                                             &&記錄本訂單號碼,本月份後續的訂單號碼將以此往下編
		    UNLOCK
          ENDIF   
          THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.    
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.F.
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=DATE()
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''
          THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
          THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''
          THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''        
          THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''  
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''          
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''                  
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=0  
        THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=''       
     ENDIF   
  ENDPROC  
***********  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='B23'
       THISFORM.GRID2.CHILDORDER='B231'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B23.F05'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='B01.F04'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B23.F06' 
       SELE B23_1 
       SET ORDER TO B23_11
       COD=SYS(21)
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'B23_1')=.T.
*          IF INT_099=.T.
             SELE A24
             SEEK 'B070 '+SUBSTR(DTOS(DATE()),3,4)
             IF FOUND()
                DO WHILE F08=PO_NO
                   RLOCK()
                   DELE
                   UNLOCK
                   SKIP
                ENDDO   
                SELE A09
                SEEK 'B070 '+SUBSTR(DTOS(DATE()),3,4)
                IF FOUND()
                    RLOCK()
		           HX=VAL(RIGHT(F08,4))+1
   		           PO_NO=LEFT(F08,6)+PADL(ALLTRIM(STR(HX)),4,'0')
		           REPL F08 WITH PO_NO                                             &&記錄本訂單號碼,本月份後續的訂單號碼將以此往下編
		           UNLOCK
		           THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
		           THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
		        ENDIF   		           
             ENDIF   
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF IIF(SEEK('B'+SUBSTR(DTOS(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'B22'),B22.F06='2',.F.)
          =MESSAGEBOX('此盤點部門已將此盤點日期之B22.盤點差異表轉至B09.盤差單,故無法新增!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'A01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('人員基本資料中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF 
       SELE B23_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       IF MESSAGEBOX('是否匯入目前庫存數量?',4+32+256,'請確認') = 6
          IF !USED('B11')
             SELECT 0
             USE B11
          ELSE
             SELECT B11
          ENDIF
          SET ORDER TO 1                
          SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          IF FOUND()
             DO WHILE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                SELECT B23
                APPEND BLANK
                REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
                REPLACE F05 WITH B11.F03
                REPLACE F06 WITH B11.F04
                REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                SELECT B11
                SKIP             
             ENDDO
             SELECT B11
             USE
          ENDIF
          THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
          THISFORM.GRID2.SETFOCUS  
       ELSE
          THISFORM.ORPGROUP.NEW_BOTT.CLICK
       ENDIF
       THISFORM.REFRESH
    ELSE
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
          RETURN
       ENDIF   
*!*	       IF INDEXSEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,.F.,'B23','B231')=.T.           
*!*	          =MESSAGEBOX('此料號在此張盤點表中重複!',0+48,'提示訊息視窗')
*!*	          THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
*!*	          THISFORM.PAGEFRAME1.PAGE2.TXTF05.REFRESH
*!*	          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
*!*	          RETURN            
*!*	       ENDIF
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE)
           =MESSAGEBOX('實盤數量不得為零!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
          RETURN
       ENDIF   
       SELECT B23_1
       REPLACE F08 WITH ''         
       SELECT  B23
       SET ORDER TO B231   && F01+F05
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
       IF FOUND()
           REPLACE F06 WITH B23.F06+THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
           REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ELSE
          APPEND BLANK
          LOCK()
          IF RLOCK()
              REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
              REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
              REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
              REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
              REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
              REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
              REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
              REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          ENDIF
       ENDIF   
       UNLOCK ALL      
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
       THISFORM.GRID2.ENABLED=.T.
       THISFORM.GRID2.SETFOCUS  
       THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
  ENDPROC
***************
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.VRT_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE B23_1
        PO_NO=B23_1.F01
        SELE RECNO() FROM B23 WHERE B23.F01=PO_NO AND B23.F08<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'B23')
           LL1=RLOCK(KK1,'B23')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE B23_1           
           UNLOCK ALL
           REPL F08 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
        ELSE 
           DO FILE_IMPACT
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ENDIF   
     ELSE                         
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.         
        SELE B23                                                      &&處理表身修改
        IF RLOCK('B23') 
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
        ELSE  
           DO FILE_IMPACT 
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       ENDIF        
     ENDIF   
     RELEASE ALL LIKE BK*
  ENDPROC
****************  
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
      	  IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
               =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
               THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
               RETURN            
          ENDIF
          IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'A01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
              =MESSAGEBOX('人員基本資料中無此編號請先建立!',0+64,'提示訊息視窗')
              THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
              RETURN            
         ENDIF 
           SELECT  B23
           SET ORDER TO B231   && F01+F05
           SEEK B23_1.F01
           IF FOUND()
              DO WHILE F01=B23_1.F01
                 REPLACE  F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                 REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                 REPLACE  F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
                 REPLACE  F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                 REPLACE  F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                 
                 SKIP
              ENDDO    
           ENDIF        
           SELECT  B23_1
           REPLACE  F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
           REPLACE  F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
           REPLACE  F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
           REPLACE  F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           UNLOCK ALL    
     ELSE                                                        &&表身修改確認     
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE)
            =MESSAGEBOX('實盤數量不得為零!',0+48,'提示訊息視窗')          
            THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
            RETURN
       ENDIF          
       SELECT  B23                    
       REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE     
       REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')              
       UNLOCK ALL
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
*******************    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
     IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          IF ALIA()='B23_1'           &&刪除整張訂單
                SELECT  B23_1    
                PO_NO=B23_1.F01  
                IF B23_1.F08='2'    
                    =MESSAGEBOX('此筆資料已轉至B09.盤差調整單,故不得刪除!',0+48,'提示訊息視窗')   
                    RETURN   
                ELSE     
                    IF B23_1.F08='1'     
                         =MESSAGEBOX('此筆資料已轉至B22.盤點差異表,故不得刪除!',0+48,'提示訊息視窗')            
                         RETURN 
	            ELSE
	                    SELECT  RECNO() FROM B23 WHERE B23.F01=PO_NO  .AND.  EMPTY(B23.F08) .AND.  EMPTY(B23.F10) INTO ARRAY BK1              
	                    JJ1=''                
	                    IF _TALLY>0   
	                        FOR I= 1 TO ALEN(BK1)
	                                JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
	                        ENDFOR    
	                        KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
	                        RLOCK(KK1,'B23')
	                        LL1=RLOCK(KK1,'B23')
	                    ELSE
	                        LL1=.T.   
	                    ENDIF                   
	                    IF LL1=.T. AND RLOCK('B23_1') 
	                        SELECT B23
	                        GO TOP
	                        FOR I=1 TO ALEN(BK1)
	                                GO BK1(I) 
		                        SELECT B23
		                        DELETE 
	                        ENDFOR   
	                        SELECT  B23_1
	                        DELETE
	                        UNLOCK ALL  
	                        IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)
	                            SELECT  A24
	                            SET ORDER TO 1
	                            APPEND BLANK
	                            LOCK()
	                            REPL F01 WITH 'B070 '
	                            REPL F02 WITH SUBSTR(DTOS(DATE()),3,4)
	                            REPL F05 WITH 'BJ'+F02
	                            REPL F06 WITH '簡易盤點表'
	                            REPL F08 WITH PO_NO
	                            UNLOCK
	                       ENDIF  
	                   ELSE
	                       DO FILE_IMPACT                  
	                   ENDIF
	             ENDIF    
             ENDIF     
            THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
                THISFORM.VRT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B23_1.F08<>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B23_1.F08<>'2'  &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                
                THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                                
             ENDIF     
          ELSE        &&刪除單筆資料 
              SELECT  B23                                                       
              IF RLOCK('B23')    
                   IF B23.F08='1'
                        =MESSAGEBOX('此筆資料已轉至B22.盤點差異表,故不得刪除!',0+48,'提示訊息視窗') 
                        RETURN  
                   ELSE
                       IF B23.F08='2'
                            =MESSAGEBOX('此筆資料已轉至B09.盤差調整單,故不得刪除!',0+48,'提示訊息視窗')   
                            RETURN
                       ELSE    
                            SELECT  B23
                            DELE
                            SKIP -1
                            IF BOF()
                                GO TOP
                            ENDIF 
                      ENDIF 	
                  ENDIF 	    
              ELSE
                 DO FILE_IMPACT                  
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              THISFORM.ANS_BOTT.ENABLED=.F.
              THISFORM.VRT_BOTT.ENABLED=.F.
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                 SELECT  B23_1                        
                 PO_NO=B23_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)
                      SELE A24
                      SET ORDER TO 1
                      APPEND BLANK
                      LOCK()
                      REPL F01 WITH 'B070 '
                      REPL F02 WITH SUBSTR(DTOS(DATE()),3,4)
		      REPL F05 WITH 'BJ'+F02
                      REPL F06 WITH '簡易盤點表'
                      REPL F08 WITH PO_NO
                      UNLOCK                 
                 ENDIF
                 SELE B23_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF
       RELEASE ALL LIKE BK*   
  ENDPROC  
********************
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
          THISFORM.GRID1.ENABLED=.T.
          THISFORM.GRID2.ENABLED=.T.
          THISFORM.GRID1.SETFOCUS
          THISFORM.KEY_LIST.ENABLED=.T.   
          THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08) .AND. IIF(A02.F08='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED    
          THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED    
           IF THISFORM.GRID2.ACTIVEROW=0  
               THISFORM.PAGEFRAME1.ACTIVEPAGE=1
               THISFORM.REFRESH  
          ENDIF  
      ELSE
          THISFORM.GRID1.ENABLED=.F.
          THISFORM.GRID2.ENABLED=.T.
          THISFORM.GRID2.SETFOCUS
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
         IF THISFORM.GRID2.ACTIVEROW=0
            SELE A24         
            SET ORDER TO 1
            APPEND BLANK
            LOCK()
            REPL F01 WITH 'B070 '
            REPL F02 WITH SUBSTR(DTOS(DATE()),3,4)
            REPL F05 WITH 'BJ'+F02
            REPL F06 WITH '簡易盤點表'
            REPL F08 WITH PO_NO
            SELE B23_1
            DELE
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL               
  ENDPROC
*************
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'B23'
            THISFORM.GRID2.RECORDSOURCE='B23'
            THISFORM.GRID2.CHILDORDER='B231'
            THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B23.F05'
            THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
            THISFORM.GRID2.COLUMN3.CONTROLSOURCE='B01.F04'
            THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B23.F06' 
	  ENDIF   
	    IF INT_099=.T.
            SELE A24         
            SET ORDER TO 1
            APPEND BLANK
            LOCK()
            REPL F01 WITH 'B070 '
            REPL F02 WITH SUBSTR(DTOS(DATE()),3,4)
            REPL F05 WITH 'BJ'+F02
            REPL F06 WITH '簡易盤點表'
            REPL F08 WITH PO_NO
            UNLOCK
         ENDIF   
         SELE B23_1
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依盤點單號排列'
                 SET ORDER TO B23_11
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依盤點部門排列'
                 SET ORDER TO B23_12
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC
***************       
  PROC ANS_BOTT.CLICK     &&B22.轉盤點差異表程序
    PO_NO=B23_1.F01        &&盤點表號
    PA_NO=B23_1.F02        &&盤點部門
    PO_DATE=B23_1.F04   &&盤點日期
    IF MESSAGEBOX('是否確認資料無誤可以轉至B22.盤點差異表?',4+32+256,'請確認') = 6
       IF  IIF(INDEXSEEK('B'+ALLTRIM(SUBSTR(DTOS(PO_DATE),3,4)+PA_NO),.T.,'B22','B221'),B22.F06<>'2' ,.T.)&&判斷該部門是否已轉至盤差單
          SELECT  RECNO() FROM B23 WHERE ALLTRIM(B23.F01)=ALLTRIM(PO_NO)  .AND. EMPTY(F08) INTO ARRAY BK1              
          JJ1=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK1)
                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
             ENDFOR    
             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
             RLOCK(KK1,'B23')
             LL1=RLOCK(KK1,'B23')
          ELSE
             LL1=.T.   
          ENDIF    
          IF LL1=.T. 
             IF LEN(ALLTRIM(JJ1))>0 
               WAIT WINDOW "資料轉出中,請稍後!" AT 0,150 NOWAIT NOCLEAR
             	PO='B'+ALLTRIM(SUBSTR(DTOS(PO_DATE),3,4)+PA_NO)
                SELECT  B23
                GO TOP
                FOR I= 1 TO ALEN(BK1)
                    GO BK1(I) 
                    SELECT B22
                    SET ORDER TO B222   && F01+F02
                    SEEK ALLTRIM(PO)+SPACE(10-LEN(ALLTRIM(PO)))+B23.F05 
		    IF FOUND()  .AND. B22.F06<>'2' 	&&找尋是否已存在B23.盤點表之單號(盤點表有的資料)
		        REPLACE  B22.F03 WITH IIF(INDEXSEEK(B23.F02+B23.F05,.T.,'B11_1','B11_11'),B11_1.F04,0)    &&庫存數量(最新庫存數量)
                        REPLACE  B22.F04 WITH B22.F04+B23.F06									        &&實盤數量
                        REPLACE  B22.F05 WITH B22.F04-B22.F03										&&差異數量
                        REPLACE  B22.F07 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
                        REPLACE  B22.F09 WITH IIF(INDEXSEEK(B23.F05,.T.,'B01','B011'),B01.F37,0)			&&平均單價(最新平均單價)
		   ELSE 					&&若否則表示無存在盤點表的資料及未盤點到的資料故須加增資料  
		        APPEND BLANK 
		        REPLACE  B22.F01 WITH PO
		        REPLACE  B22.F02 WITH B23.F05
                        REPLACE  B22.F03 WITH IIF(INDEXSEEK(B23.F02+B23.F05,.T.,'B11_1','B11_11'),B11_1.F04,0)	&&庫存數量(最新庫存數量)
                        REPLACE  B22.F04 WITH B23.F06
                        REPLACE  B22.F05 WITH B22.F04-B22.F03
                        REPLACE  B22.F07 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
                        REPLACE  B22.F09 WITH IIF(INDEXSEEK(B23.F05,.T.,'B01','B011'),B01.F37,0)			&&平均單價(最新平均單價)
                  ENDIF          
                    SELE B23
                    REPL F08 WITH '1'  &&表示已轉B22.盤點差異表  
                    REPL F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    REPL F10 WITH PO
               ENDFOR
              ****加入現有B11_1庫存數量但B22.簡易盤點表中卻無資料的料號
                    SELECT F03,F04 FROM B11_1 WHERE  B11_1.F01 = PA_NO ORDER BY F03 INTO CURSOR B11_1_TEMP 
                    SELECT B11_1_TEMP 
                    GO TOP
                    DO WHILE !EOF()
                    	   SELECT B22
                           SET ORDER TO B222 && F01+F02
                           SEEK ALLTRIM(PO)+SPACE(10-LEN(ALLTRIM(PO)))+B11_1_TEMP.F03
                           IF !FOUND() 
	                    	   APPEND BLANK 
			           REPLACE  B22.F01 WITH PO
			           REPLACE  B22.F02 WITH B11_1_TEMP.F03
	                           REPLACE  B22.F03 WITH B11_1_TEMP.F04
	                           REPLACE  B22.F04 WITH 0
	                           REPLACE  B22.F05 WITH B11_1_TEMP.F04*(-1)
	                           REPLACE  B22.F07 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
	                           REPLACE  B22.F09 WITH IIF(INDEXSEEK(B11_1_TEMP.F03,.T.,'B01','B011'),B01.F37,0) 
			   ENDIF        
			   SELECT B11_1_TEMP
			   SKIP   
		    ENDDO    
		    SELECT B11_1_TEMP
		    USE
		    SELE B23_1
                    REPL F08 WITH '1'
                    REPL F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
                    REPL F10 WITH 'B'+ALLTRIM(SUBSTR(PO_NO,3,4)+ALLTRIM(B23.F02))
                    =MESSAGEBOX('已轉入B22.盤點差異表,表號為'+B23_1.F10,0+48,'請至B22.盤點差異表中再次確認')           
            ELSE
                =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                 SELECT  B23_1
                 REPLACE  F08 WITH '2'
                 THISFORM.GRID1.SETFOCUS
           ENDIF           
             THIS.ENABLED=.F.
             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
             UNLOCK ALL
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
             ENDIF
             THISFORM.REFRESH
        ELSE
            DO FILE_IMPACT
            UNLOCK ALL
            RETURN
       ENDIF   
          UNLOCK ALL
         RELEASE ALL LIKE BK*
      ELSE
           =MESSAGEBOX('此盤點部門已將此月份之盤點差異表轉至盤差單,故無法將資料轉至盤點差異表!',0+64,'提示訊息視窗')
      ENDIF     
    ENDIF    
    THISFORM.GRID1.SETFOCUS  
    THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
    THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                          
    WAIT CLEAR
  ENDPROC
***************       
  PROC VRT_BOTT.CLICK     &&反轉盤點差異表程序  
     IF MESSAGEBOX('是否確定反轉此筆資料',4+32+256,'請確認') = 6	        
          IF ALIA()='B23_1'           
                SELECT  B23_1    
                PO_NO=B23_1.F01  
                B22_NO=B23_1.F10
                IF B23_1.F08='2'    
                    =MESSAGEBOX('此筆資料已轉至B09.盤差調整單,故不得反轉!',0+48,'提示訊息視窗')   
                    RETURN   
                ELSE     
	            SELECT  RECNO() FROM B23 WHERE B23.F01=PO_NO  .AND.  B23.F08='1'  INTO ARRAY BK1              
	            JJ1=''                
	            IF _TALLY>0   
	                FOR I= 1 TO ALEN(BK1)
	                        JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
	                ENDFOR    
	                KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
	                RLOCK(KK1,'B23')
	                LL1=RLOCK(KK1,'B23')
	            ELSE
	                LL1=.T.   
	            ENDIF                   
	            IF LL1=.T. AND RLOCK('B23_1') 
	                SELECT B23
	                GO TOP
	                FOR I=1 TO ALEN(BK1)
	                       GO BK1(I) 
	                       PO='B'+ALLTRIM(SUBSTR(DTOS(B23.F04),3,4)+B23.F02)
	                       SELECT B22
	                       SET ORDER TO B222  && F01+F02
	                       SEEK ALLTRIM(PO)+SPACE(10-LEN(ALLTRIM(PO)))+B23.F05 
		               IF FOUND() .AND. B22.F06<>'2'  
		                   REPLACE B22.F04 WITH B22.F04-B23.F06
		                   REPLACE B22.F05 WITH B22.F04-B22.F03
		                   IF B22.F03=0 .AND. B22.F05=0
		                        SELECT B22
		                        DELETE   
		                   ENDIF
		                ENDIF 
		                SELECT B23
		                REPLACE B23.F08 WITH ''
		                REPLACE B23.F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
		                REPLACE B23.F10 WITH ''
	                 ENDFOR   
	                 SELECT  B23_1
	                 REPLACE B23_1.F08 WITH ''
	                 REPLACE B23_1.F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
	                 REPLACE B23_1.F10 WITH ''
	                 UNLOCK ALL  
	                 SELECT F10 FROM B23 WHERE ALLTRIM(F10)=ALLTRIM(B22_NO) .AND. F08='1' INTO CURSOR B22_TEMP
	                 SELECT B22_TEMP
	                 IF RECCOUNT('B22_TEMP')=0 
	                     DELETE FROM B22  WHERE  ALLTRIM(B22.F01)=ALLTRIM(B22_NO) .AND. F06<>'2'
	                 ENDIF
	                 SELECT B22_TEMP
	                 USE	                 
	                 THISFORM.VRT_BOTT.ENABLED=.F.
	                 =MESSAGEBOX('此反轉作業成功!',0+64,'提示訊息視窗') 
	             ELSE
	                  DO FILE_IMPACT                  
	             ENDIF
	        ENDIF    
           ENDIF  
      ENDIF        
      THISFORM.GRID1.SETFOCUS
      THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B23_1.F08<>'2' &&判斷有無修改的權限
      THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B23_1.F08<>'2'  &&判斷有無刪除的權限
      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
      THISFORM.ANS_BOTT.ENABLED=EMPTY(B23_1.F08) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                
      THISFORM.VRT_BOTT.ENABLED=IIF(B23_1.F08='1',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                                
       RELEASE ALL LIKE BK*   
  ENDPROC  
ENDDEFINE    
***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=B23_1.F01     
     SELECT B23.F01,;
            B23.F02,;
            B23.F03,;
            B23.F04,;                    
            B23.F05,;
            B23.F06,;
            B23.F07,;
            A01.F03,;
            A14.F02,;
            B01.F02;            
     FROM B23,A01,A14,B01 WHERE B23.F01=LK .AND. A14.F01=B23.F02 .AND. B01.F01=B23.F05 .AND. A01.F01=B23.F03  ORDER BY B23.F05 NOWAIT
     IF _TALLY >0
        FILENAME=F01
        REPORT FORM ALLTRIM(INT_116)+'B23' TO PRINT PROMPT PREVIEW
        COPY TO &FILENAME TYPE XL5
     ENDIF  
ENDPROC
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
       ENDIF        
       IF _TALLY>0
          MTR_SEEK=CREATEOBJECT("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'     
       ENDIF          
    ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')      
  ENDPROC
ENDDEFINE
***************************************************特殊欄位------------------部門
DEFINE CLASS TXTF02 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F04='*'
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE F04='*'
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=CREATEOBJECT("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')         
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------盤點人員
DEFINE CLASS TXTF03 AS TEXTBOX
   READONLY=.T.
   MAXLENGTH=5
   FONTSIZE=INT_015*9   
   PROCEDURE INTERACTIVECHANGE
     IF AT('?',ALLTRIM(THIS.VALUE))<>0
        IF AT('?',ALLTRIM(THIS.VALUE))>1             
           SELECT F01,F03 FROM A01 INTO CURSOR MAN ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
        ELSE
           SELECT F01,F03 FROM A01 INTO CURSOR MAN ORDER BY F01    
        ENDIF   
        VDR_SEEK=createobject("MAN_SEEK")  
        VDR_SEEK.SHOW    
        THIS.VALUE=FLG
        THIS.REFRESH
        FLG='0'        
     ENDIF  
      THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'A01'),A01.F03,'')  
  ENDPROC
ENDDEFINE
