***程式名稱:料品使用對象調撥單
close all
clear 
FLG='0'
FCH=''
CHK=''
CHK_STR=''
R=0
QTY=0
TQTY=0
AREA1='B12_1'
AREA2='B12'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
IF !USED('B13')
   SELECT 0
   USE B13
ELSE
   SELECT B13
ENDIF
SET ORDER TO 1      
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1      
B39='B39'+LEFT(DTOS(DATE()),6)   &&未過帳單據查詢檔
IF !USED('&B39')
   SELE 0
   USE (B39) ALIA B39
ELSE
   SELE B39
ENDIF
SET ORDER TO 1      
SELE A23
SET ORDER TO 1
SEEK DTOS(CTOD(LEFT(DTOC(DATE()),5)+'/'+'01'))
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'B36'
IF !USED('C01')
   SELE 0
   USE C01
ELSE 
   SELE C01
ENDIF
SET ORDER TO 1     
CREATE CURSOR C01_1(F01 C(5),F02 C(4),F04 C(40))
INDE ON F01 TAG C01_1
SELE F01,F02,F04 FROM C01 INTO CURSOR C01_2 ORDER BY F01 
GO TOP
DO WHILE !EOF()
   SELE C01_1
   APPEND BLANK
   REPL F01 WITH C01_2.F01
   REPL F02 WITH C01_2.F02   
   REPL F04 WITH C01_2.F04
   SELE C01_2
   SKIP
ENDDO   
SELE C01_2
USE 
SELE C01_1
SET ORDER TO 1     
IF !USED('A14')
   SELE 0
   USE A14 INDE A14
ELSE
   SELE A14
ENDIF
SET FILTER TO F04='*' AND F01<>INT_190
SET ORDER TO 1  
GO TOP
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1   
set filter to !EMPTY(F98) 
IF !USED('B11')
   SELE 0
   USE B11 INDE B11
ELSE
   SELE B11
ENDIF
SET ORDER TO B111  
B12='B12'+LEFT(DTOS(DATE()),6)
B121='B121'+LEFT(DTOS(DATE()),6)
IF !USED('&B12')
   SELE 0
   USE (B12) ALIA B12
ELSE
   SELE B12
ENDIF
SET ORDER TO 1      
SET RELA TO F03 INTO B01
CREATE CURSOR B12_1;
(F01 C(10),F02 C(2),F05 C(5),F07 C(5),F08 C(5),F09 C(1),F11 C(100),F10 C(17),F90 C(17))
INDE ON F01 TAG B12_11
INDE ON F05 TAG B12_12
INDE ON F07 TAG B12_13
INDE ON F08 TAG B12_14
SELE F01,F02,F07,F05,F09,F11,F08,F10,F90 FROM B12 GROUP BY F01 ORDER BY F01 INTO CURSOR B12_2
SELE B12_2
GO TOP
DO WHILE !EOF()
   SELE B12_1
   APPEND BLANK
   REPL F01 WITH B12_2.F01
   REPL F02 WITH B12_2.F02
   REPL F07 WITH B12_2.F07
   REPL F05 WITH B12_2.F05
   REPL F09 WITH B12_2.F09
   REPL F11 WITH B12_2.F11
   REPL F08 WITH B12_2.F08
   REPL F10 WITH B12_2.F10
   REPL F90 WITH B12_2.F90
   SELE B12_2
   SKIP   
ENDDO
SELE B12_2
USE   
SELE B12_1
SET ORDER TO 1
SET RELA TO F07 INTO C01
SET RELATION TO F05 INTO A14 ADDI
SET RELA TO F08 INTO C01_1 ADDI
B36form=createobject("tkB36")
B36form.show  
define class tkB36 as form
  caption='B36.料品使用對象調撥單'
*!*	  autocenter=.t.
  controlbox=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  WIDTH=INT_015*789
  windowtype=1
  NAME='TKB36'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      autocenter=.t.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      autocenter=.t.
  ADD OBJECT grid1 AS grid1 WITH;
      columncount=7,;            
      RECORDSOURCE='B12_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;      
      COLUMN6.NAME='COLUMN6',;      
      COLUMN7.NAME='COLUMN7'      
  ADD OBJECT grid2 AS grid2 WITH;
      columncount=4,;            
      RECORDSOURCE='B12',; 
      LINKMASTER='B12_1',;
      RELATIONALEXPR='F01',;
      childorder=B121,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*558          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.過帳',;
      NAME='ANS_BOTT'                    
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='料品使用對象調撥單號'          
     ENDWITH
	THIS.ADDOBJECT('LBLF05','LABEL')
	WITH THIS.LBLF05  
	     .VISIBLE=INT_028
         .LEFT=INT_015*14
         .TOP=INT_015*38
	     .WIDTH=INT_015*50
         .CAPTION='處理部門'
    ENDWITH           
	THIS.ADDOBJECT('LBLF051','LABEL')
	WITH THIS.LBLF051  
	     .VISIBLE=INT_028
         .LEFT=INT_015*115
         .TOP=INT_015*38
	     .AUTOSIZE=.T.
         .CAPTION=''
    ENDWITH               
     THIS.ADDOBJECT('LBLF07','LABEL')     
     WITH THIS.LBLF07
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*63
          .WIDTH=INT_015*50  
          .CAPTION='撥出對象'
     ENDWITH            
     THIS.ADDOBJECT('LBLF071','LABEL')     
     WITH THIS.LBLF071
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*63
          .AUTOSIZE=.T.
     ENDWITH                 
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='撥入對象'
     ENDWITH    
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*88
         .AUTOSIZE=.T. 
     ENDWITH    
     THIS.ADDOBJECT('LBLF11','LABEL')
     WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH    
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*13
         .WIDTH=INT_015*50
         .CAPTION='調撥日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='過  帳  碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF101','LABEL')
     WITH THIS.LBLF101
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*88
         .AUTOSIZE=.T.
     ENDWITH        
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF05','TXTF05')          
     WITH THIS.TXTF05
          .VISIBLE=INT_028
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH             
     THIS.ADDOBJECT('TXTF07','TXTF07')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
     THIS.ADDOBJECT('TXTF08','TXTF08')          
     WITH THIS.TXTF08
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH                               
     THIS.ADDOBJECT('TXTF11','TEXTBOX')          
     WITH THIS.TXTF11
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*134
          .WIDTH=INT_015*300
          .HEIGHT=INT_015*25
          .MAXLENGTH=100
     ENDWITH      
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*9
          .WIDTH=INT_015*40
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH        
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF03','LABEL')
	WITH THIS.LBLF03  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF031','LABEL')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*347
	     .TOP=INT_015*18
	     .autosize=.t.
	ENDWITH     
    THIS.ADDOBJECT('LBLF04','Label')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='調撥數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF13','Label')
    WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='用        途'         
    ENDWITH         
    THIS.ADDOBJECT('LBLF10','LABEL')
    WITH THIS.LBLF10
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*143
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF101','LABEL')
    WITH THIS.LBLF101
        .VISIBLE=.T.           
        .LEFT=INT_015*380
        .TOP=INT_015*143
        .AUTOSIZE=.T.
    ENDWITH    
	THIS.ADDOBJECT('TXTF03','TXTF03')
	WITH THIS.TXTF03      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*216
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF03'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF04','TEXTBOX')
	WITH THIS.TXTF04
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*64
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999999.9999'
	     .NAME='TXTF04'	    
	ENDWITH     
	THIS.ADDOBJECT('TXTF13','TEXTBOX')
	WITH THIS.TXTF13
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*89
	     .WIDTH=INT_015*300
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=100
	     .NAME='TXTF13'	    
	ENDWITH     	
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     SELE B12_1         
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B12_1.F09<>'2',RGB(255,0,0),'')","COLUMN")         
        THISFORM.GRID1.ENABLED=.T.      
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF                 
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''            
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B12_1.F09<>'2' &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B12_1.F09<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B12_1.F09='2',.F.,.T.) .AND. (IIF(A02.F11='*',.T.,.F.) OR sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ')) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE B12  
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF     
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B12.F09<>'2'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B12.F09<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B12.F09='2',.F.,.T.) .AND. (IIF(A02.F11='*',.T.,.F.) .OR. sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ')) .AND. !THISFORM.SHRGROUP.ENABLED
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. B12_1.F09<>'2' &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.
  ENDPROC     
  PROC INIT       
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')     
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')         
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER') 
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='調撥單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='處理部門編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='處理部門簡稱'       
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='撥出對象編號'
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='撥出對象簡稱'
       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='撥入對象編號'
       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='撥入對象簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B12_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B12_1.F05'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'  
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B12_1.F07'       
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='C01.F04'
       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='B12_1.F08'
       THISFORM.GRID1.COLUMN7.CONTROLSOURCE='C01_1.F04'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*80       
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B12_1.F09<>'2',RGB(255,0,0),'')","COLUMN")         
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'       
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.grid2.COLUMN3.HEADER1.CAPTION='調撥數量'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='安全資料'
	   THISFORM.GRID2.LINKMASTER='B12_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B12.F03'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B12.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B12.F10'
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*135
       THISFORM.grid1.READONLY=.T.      
       THISFORM.grid2.READONLY=.T.            
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B12_1.F09<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B12_1.F09<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(B12_1.F09='2',.F.,.T.)  .AND. (IIF(A02.F11='*',.T.,.F.) OR sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ')) .AND. !THISFORM.SHRGROUP.ENABLED
       ENDIF          
*       THISFORM.KEY_LIST.DISPLAYVALUE='依料品處理部門調撥單號排列'      
       JK='調撥單號'
       SELE B12_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B12_1.F01
  ENDPROC               
  PROC KEY_LIST.INIT 
       with this 
           .additem('依調撥單號排列')
           .additem('依處理部門排列')           
           .additem('依撥出對象排列')
           .additem('依撥入對象排列')
           .VALUE=1
       endwith             
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE B12_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依調撥單號排列'
               set order to B12_11
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='調撥單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B12_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='處理部門編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B12_1.F05'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='處理部門簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80               
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='撥出對象編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B12_1.F07'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='撥出對象簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='C01.F04'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='撥入對象編號'
               THISFORM.GRID1.COLUMN6.CONTROLSOURCE='B12_1.F08'
               THISFORM.GRID1.COLUMN6.WIDTH=INT_015*49               
               THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='撥入對象簡稱'
               THISFORM.GRID1.COLUMN7.CONTROLSOURCE='C01_1.F04'
               THISFORM.GRID1.COLUMN7.WIDTH=INT_015*80                    
          CASE THIS.DISPLAYVALUE='依處理部門排列'
               set order to B12_12
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='處理部門編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B12_1.F05'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='處理部門簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80                             
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='撥出對象編號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B12_1.F07'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='撥出對象簡稱'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C01.F04'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='撥入對象編號'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='B12_1.F08'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='撥入對象簡稱'
               THISFORM.GRID1.COLUMN6.CONTROLSOURCE='C01_1.F04'
               THISFORM.GRID1.COLUMN6.WIDTH=INT_015*58                             
               THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='調撥單號'
               THISFORM.GRID1.COLUMN7.CONTROLSOURCE='B12_1.F01'
               THISFORM.GRID1.COLUMN7.WIDTH=INT_015*81                                                                                 
          CASE THIS.DISPLAYVALUE='依撥出對象排列'
               set order to B12_13
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='撥出對象編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B12_1.F07'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='撥出對象簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C01.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='撥入對象編號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B12_1.F08'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='撥入對象簡稱'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C01_1.F04'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*58                             
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='處理部門編號'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='B12_1.F05'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='處理部門簡稱'
               THISFORM.GRID1.COLUMN6.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN6.WIDTH=INT_015*80                                            
               THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='調撥單號'
               THISFORM.GRID1.COLUMN7.CONTROLSOURCE='B12_1.F01'
               THISFORM.GRID1.COLUMN7.WIDTH=INT_015*81                 
          CASE THIS.DISPLAYVALUE='依撥入對象排列'
               set order to B12_14
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='撥入對象編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B12_1.F08'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='撥入對象簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C01_1.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*58                             
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='撥出對象編號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B12_1.F07'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='撥出對象簡稱'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C01.F04'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*80               
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='處理部門編號'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='B12_1.F05'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='處理部門簡稱'
               THISFORM.GRID1.COLUMN6.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN6.WIDTH=INT_015*80                                            
               THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='調撥單號'
               THISFORM.GRID1.COLUMN7.CONTROLSOURCE='B12_1.F01'
               THISFORM.GRID1.COLUMN7.WIDTH=INT_015*81                                                            
       ENDCASE 
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.childorder=''
       SELE A24
       USE
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1             
       SELE B39
       USE
       B39='B39'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B39')
          SELE 0
          USE (B39) ALIA B39
       ELSE
          SELE B39
       ENDIF
       SET ORDER TO 1                                  
       SELE B12
       set rela off into b01
       SET RELA OFF INTO B12_1
       USE
       SELE B12_1
       SET RELATION OFF INTO A14
       SET RELA OFF INTO C01
       SET RELA OFF INTO C01_1
       USE
       B12='B12'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       B121='B121'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B12')
          SELE 0
          USE (B12) ALIA B12
       ELSE
          SELE B12
       ENDIF
       SET ORDER TO 1      
       SET RELA TO F03 INTO B01
       CREATE CURSOR B12_1;
       (F01 C(10),F02 C(2),F07 C(5),F05 C(5),F09 C(1),F11 C(100),F08 C(5),F10 C(17),F90 C(17))
       INDE ON F01 TAG B12_11
       INDE ON F05 TAG B12_12
       INDE ON F07 TAG B12_13
       INDE ON F08 TAG B12_14
       SELE F01,F02,F07,F05,F09,F11,F08,F10,F90 FROM B12 GROUP BY F01 ORDER BY F01 INTO CURSOR B12_2
       SELE B12_2
       GO TOP
       DO WHILE !EOF()
          SELE B12_1
          APPEND BLANK
          REPL F01 WITH B12_2.F01
          REPL F02 WITH B12_2.F02
          REPL F07 WITH B12_2.F07
          REPL F05 WITH B12_2.F05
          REPL F11 WITH B12_2.F11
          REPL F09 WITH B12_2.F09
          REPL F08 WITH B12_2.F08
          REPL F10 WITH B12_2.F10
          REPL F90 WITH B12_2.F90
          SELE B12_2
          SKIP
       ENDDO
       SELE B12_2
       USE   
       SELE B12_1
       SET ORDER TO 1
       SET RELA TO F07 INTO C01
       SET RELATION TO F05 INTO A14 ADDI
       SET RELA TO F08 INTO C01_1 ADDI
       THISFORM.GRID1.RECORDSOURCE='B12_1'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B12_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B12_1.F07'       
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='C01.F04'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B12_1.F08'              
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='C01_1.F04'
       THISFORM.GRID2.RECORDSOURCE='B12'
	   THISFORM.GRID2.LINKMASTER='B12_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=B121  
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B12.F03'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B12.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B12.F10'            
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   thisform.grid1.setfocus        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B12_1.F09<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B12_1.F09<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.ANS_BOTT.ENABLED=IIF(B12_1.F09='2',.F.,.T.)  .AND. (IIF(A02.F11='*',.T.,.F.) OR sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ')) .AND. !THISFORM.SHRGROUP.ENABLED               
       ENDIF          
*!*	       THISFORM.KEY_LIST.DISPLAYVALUE='依出貨單號排列'      
*!*	       JK='訂單編號'
*!*	       SELE B12_1
*!*	       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B12_1.F01	   
*       THISFORM.REFRESH       
  ENDPROC
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B12_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=B12_1.F11
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=B12_1.F07
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=B12_1.F05
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=C01.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=B12_1.F08
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=C01_1.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=B12_1.F02
       THISFORM.PAGEFRAME1.PAGE1.lblF091.caption=B12_1.F09
       THISFORM.PAGEFRAME1.PAGE1.lblF101.caption=B12_1.F10
       THISFORM.PAGEFRAME1.PAGE1.lblf901.caption=B12_1.F90
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B12_1.F09<>'2'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B12_1.F09<>'2' &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED=IIF(B12_1.F09='2',.F.,.T.) .AND. (IIF(A02.F11='*',.T.,.F.) OR sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ')) .AND. !THISFORM.SHRGROUP.ENABLED        
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=B12.F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=B12.F04     
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=B12.F13      
       THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=B12.F10
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=B12_1.F01
*       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       if thisform.pageframe1.activepage=1
          thisform.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       thisform.refresh
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
*       IF INT_099=.T.
          H='B035 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          SELE A24   
          SET ORDER TO 1
          SEEK H           
          IF FOUND() 
             PO_NO=F08
             RLOCK()
             DELE 
             UNLOCK
          ELSE
             SELE A09
             SEEK H            
             IF !FOUND()                                                  &&如果為本月第一張訂單則重頭開始編號
		  APPEND BLANK                                                
		  REPLACE  f01 WITH 'B035 '
	          REPLACE  f02 WITH  SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
	          REPLACE  F05 WITH 'BO'+f02
	          REPLACE  F06 WITH '料品使用對象調撥單'
	          REPLACE  F08 WITH ALLTRIM(F05)+'0000'
	      ENDIF
              LOCK()
              HX=VAL(RIGHT(F08,4))+1
              PO_NO=LEFT(F08,6)+PADL(ALLTRIM(STR(HX)),4,'0')
              REPLACE  F08 WITH PO_NO                                             &&記錄本訂單號碼,本月份後續的訂單號碼將以此往下編
              UNLOCK
          ENDIF       
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
          thisform.PAGEFRAME1.PAGE1.txtf01.readonly=.t.
          IF INT_028
             THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
          ELSE 
             THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          ENDIF   
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.        
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.    
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''                
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''        
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''          
        THISFORM.PAGEFRAME1.PAGE2.lblF031.caption=''                  
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=''               
     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE B12_1
        PO_NO=B12_1.F01
        SELE RECNO() FROM B12 WHERE B12.F01=PO_NO AND F09<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'B12')
           LL1=RLOCK(KK1,'B12')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE B12_1           
           UNLOCK ALL
           REPL F09 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.           
           THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           IF INT_028
              THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
           ELSE 
              THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
           ENDIF              
        ELSE 
           DO file_impact
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        endif   
     ELSE                         
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
        SELE B12                                                      &&處理表身修改
        IF RLOCK('B12') 
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
        ELSE  
           DO file_impact 
           unlock all
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       endif        
     ENDIF   
     RELEASE ALL LIKE BK*
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          if ALIA()='B12_1'           &&刪除整張訂單
             SELE B12_1             
                PO_NO=B12_1.F01
                SELE RECNO() FROM B12 WHERE B12.F01=PO_NO  AND B12.F09<>'2' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'B12')
                   LL1=RLOCK(KK1,'B12')
                ELSE
                   LL1=.T.   
                ENDIF                   
                IF LL1=.T. AND RLOCK('B12_1')       
                   DELE FROM B12 WHERE B12.F01=PO_NO
                   SELE B39                     &&刪除未過帳單據紀錄
                   SEEK A02.F03+B12_1.F01                   
                   IF FOUND()
                      DELE
                   ENDIF   
                   SELE B12_1
                   DELE
                   UNLOCK ALL
                   IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      SELE A24
                      SEEK 'B035 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      IF !FOUND()
                          APPEND BLANK
                          LOCK()
                          REPLACE  F01 WITH 'B035 '
                          REPLACE  F02 WITH SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                          REPLACE  F05 WITH 'BO'+f02
                          REPLACE  F06 WITH '料品使用對象調撥單'
                          REPLACE  F08 WITH PO_NO
                          UNLOCK
                      ENDIF   
                   ENDIF  
                ELSE
                   DO file_impact                  
                ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B12_1.F09>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B12_1.F09<>'2' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(B12_1.F09='2',.F.,.T.) .AND. (IIF(A02.F11='*',.T.,.F.) OR sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ'))  .AND. !THISFORM.SHRGROUP.ENABLED                
             ENDIF     
          ELSE        
              SELE B12                                                      &&刪除單筆資料  
              IF RLOCK('B12')       
                  SELE B12
                  DELE
                  SKIP -1
                  IF BOF()
                     GO TOP
                  ENDIF   
              ELSE
                 DO file_impact                  
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                 SELE B39                           &&刪除未過帳單據紀錄       
                 SEEK A02.F03+B12_1.F01
                 IF FOUND()
                    DELE
                 ENDIF                    
                 SELE B12_1                        
                 PO_NO=B12_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      SELE A24
                      SEEK 'B035 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      IF !FOUND()
                          APPEND BLANK
                          LOCK()
                          REPLACE  F01 WITH 'B035 '
                          REPLACE  F02 WITH SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
		                  REPLACE  F05 WITH 'BO'+f02
                          REPLACE  F06 WITH '料品使用對象調撥單'
                          REPLACE  F08 WITH PO_NO
                          UNLOCK                                           
                      ENDIF    
                 ENDIF
                 SELE B12_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF
       RELEASE ALL LIKE BK*   
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='B12'
       THISFORM.GRID2.CHILDORDER=B121
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B12.F03'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B12.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B12.F10'       
       SELE B12_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'B12_1')=.T.   &&如果編號重複
             SELE A24
             SEEK 'B035 '+SUBSTR(DTOS(DATE()),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
             IF FOUND()
                 DO WHILE F01+F02+F08='B035 '+SUBSTR(DTOS(DATE()),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                        RLOCK()
                        DELE
                        UNLOCK
                        SKIP
                 ENDDO   
             ENDIF                    
             SELE A09
             SEEK 'B035 '+SUBSTR(DTOS(DATE()),3,4)
             IF FOUND()
                 RLOCK()
                 HX=VAL(RIGHT(F08,4))+1
                 PO_NO=LEFT(F08,6)+PADL(ALLTRIM(STR(HX)),4,'0')
                 REPLACE  F08 WITH PO_NO                                             &&記錄本訂單號碼,本月份後續的訂單號碼將以此往下編
                 UNLOCK
                 THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
                 THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
	     ENDIF   		           
       ENDIF
       IF !SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')
           =MESSAGEBOX('無此工作部門!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
           SET ORDER TO &COD                      
           RETURN
       ENDIF           
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'C01')=.F. AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE)
          =MESSAGEBOX('無此客戶編號請先建立!,否則使用對象請保持空白',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE,'C01_1')=.F. AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE)
          =MESSAGEBOX('無此客戶編號請先建立!,否則使用對象請保持空白',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF       
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('調撥日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          =MESSAGEBOX('撥出對象與撥入對象不得相同!',0+48,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
          SET ORDER TO &COD          
          RETURN           
       ENDIF
       SELE B12_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE          
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          REPLACE F10 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       SELE B39
       APPEND BLANK
       REPL F01 WITH A02.F03
       REPL F02 WITH B12_1.F01
       REPL F03 WITH B12_1.F02
       REPL F05 WITH B12_1.F05
       REPL F06 WITH IIF(SEEK(B12_1.F05,'A14'),A14.F02,'')
       REPL F04 WITH B12_1.F08
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B12')=.T.           
          =MESSAGEBOX('此料號在此張調撥單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN            
       ENDIF           
       SELE B12
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE          
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          REPLACE F10 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF
       UNLOCK ALL         
       seek thisform.pageframe1.page1.txtf01.value+thisform.pageframe1.page2.txtf03.value
       thisform.grid2.enabled=.t.
       thisform.grid2.setfocus  
       THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('調撥日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
       IF !SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14','A141')
           =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
           RETURN
       ENDIF           
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'C01')=.F. AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE)
          =MESSAGEBOX('無此客戶編號請先建立!,否則使用對象請保持空白',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE,'C01_1')=.F. AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE)
          =MESSAGEBOX('無此客戶編號請先建立!,否則使用對象請保持空白',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
          RETURN            
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          =MESSAGEBOX('撥出對象與撥入對象不得相同!',0+48,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
          RETURN           
       ENDIF       
           SELE B12
           SEEK B12_1.F01
           IF FOUND()
              DO WHILE F01=B12_1.F01
                 REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                 REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                 REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE                 
                 REPL F11 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE
                 REPL F10 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                 
                 REPL F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
                 SKIP
              ENDDO    
           ENDIF        
        SELE B12_1
           REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
           REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE           
           REPL F11 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE
           REPL F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
           REPL F10 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           UNLOCK ALL
    
     ELSE                                                        &&表身修改確認     
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE<>B12.F01+B12.F03
          IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B12')=.T.                            
             =MESSAGEBOX('此料號在此張出貨單重複!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
             RETURN            
          ENDIF    
       ENDIF           
       SELE B12                    
       REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
       REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE      
       REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE      
       REPLACE F10 WITH DTOC(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                      
       UNLOCK ALL
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.T.      
      THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1  
          THISFORM.grid1.ENABLED=.T.
         THISFORM.grid2.ENABLED=.T. 
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
      ELSE
          THISFORM.grid1.ENABLED=.F.
         THISFORM.grid2.ENABLED=.T. 
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
              SELE A24         
              SEEK 'B035 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
              IF !FOUND()
                  APPEND BLANK
                  LOCK()
                  REPLACE  F01 WITH 'B035 '
                  REPLACE  F02 WITH SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
		          REPLACE  F05 WITH 'BO'+f02
                  REPLACE  F06 WITH '料品使用對象調撥單'
                  REPLACE  F08 WITH PO_NO
               ENDIF    
               SELE B39
               SEEK A02.F03+B12_1.F01
               SET ORDER TO 1
               IF FOUND()
                   DELE            
               ENDIF   
               SELE B12_1
               DELE
               THISFORM.PAGEFRAME1.ACTIVEPAGE=1
               THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
      THISFORM.ANS_BOTT.ENABLED=IIF(B12_1.F09='2',.F.,.T.) .AND. (IIF(A02.F11='*',.T.,.F.) OR sys_oper$IIF(SEEK(B12_1.F07,'C01'),C01.F18+C01.F23+C01.F33,'ZZZZZZZZZZZZZZZ')) .AND. !THISFORM.SHRGROUP.ENABLED               
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'B12'
            THISFORM.GRID2.RECORDSOURCE='B12'
            THISFORM.GRID2.CHILDORDER=B121
  	        THISFORM.grid2.COLUMN1.CONTROLSOURCE='B12.F03'
	        THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	        THISFORM.grid2.COLUMN3.CONTROLSOURCE='B12.F04'
	        THISFORM.grid2.COLUMN4.CONTROLSOURCE='B12.F10'         
	     ENDIF   
	     IF INT_099=.T.
                 SELE A24         
                 SEEK 'B035 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                 IF !FOUND()
                     APPEND BLANK
                     LOCK()
                     REPLACE  F01 WITH 'B035 '
                     REPLACE  F02 WITH SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
		             REPLACE  F05 WITH 'BO'+f02
                     REPLACE  F06 WITH '料品使用對象調撥單'
                     REPLACE  F08 WITH PO_NO
                     UNLOCK
                 ENDIF    
         ENDIF   
         SELE B12_1
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依調撥單號排列'
                 SET ORDER TO 1
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依處理部門排列'
                 SET ORDER TO 2                 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依撥出對象排列'
                 SET ORDER TO 3
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依撥入對象排列'
                 SET ORDER TO 4
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK     &&過帳程序
       if messagebox('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	 
          SELE RECNO() FROM B12 WHERE B12.F01=B12_1.F01  AND F09<>'2' INTO ARRAY BK1              
          JJ1=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK1)
                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
             ENDFOR    
             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
             RLOCK(KK1,'B12')
             LL1=RLOCK(KK1,'B12')
          ELSE
             LL1=.T.   
          ENDIF                   
          IF LL1=.T. 
             IF LEN(ALLTRIM(JJ1))>0 
                SELE B12
                FOR I= 1 TO ALEN(BK1)                      
                    GO BK1(I) 
                    SELE B11                                            &&部門庫存明細檔 
                    SEEK B12.F05+B12.F03+B12.F07  &&撥出對象庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+(B12.F04)*(-1)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02))
                          ENDIF
                       ENDIF   
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B12.F05
                       REPL F03 WITH B12.F03
                       REPL F04 WITH (B12.F04)*(-1)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02))
                       REPLACE F08 WITH B12.F07
                    ENDIF   
                    SEEK B12.F05+B12.F03+B12.F08     &&撥入對象庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+B12.F04
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02))
                          ENDIF   
                       ENDIF
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B12.F05
                       REPL F03 WITH B12.F03
                       REPL F04 WITH B12.F04
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02))
                       REPLACE F08 WITH B12.F08
                    ENDIF                            
                    SELECT B13
                    APPEND BLANK
                    REPLACE F01 WITH B12.F01
                    REPLACE F02 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B12.F02)
                    REPLACE F03 WITH B12.F03
                    REPLACE F04 WITH B12.F04
                    REPLACE F05 WITH B12.F05
                    REPLACE F07 WITH B12.F07
                    REPLACE F08 WITH B12.F08
                    REPLACE F09 WITH B12.F13
                    REPLACE F10 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    *******
                    SELE B12                       &&
                    REPL F09 WITH '2'
                    REPL F90 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 ENDFOR   
                 SELE B39                    &&未過帳庫存單據查詢檔
                 SEEK A02.F03+B12_1.F01
                  IF FOUND()
                     DELE
                  ENDIF                                             
                  SELE B12_1
                  REPL F09 WITH '2'
                  REPL F90 WITH dtoc(DATE())+' '+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
             ELSE
                =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                SELE B12_1
                REPL F09 WITH '2'
             ENDIF           
             THIS.ENABLED=.F.
             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
             UNLOCK ALL
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
             ENDIF
             THISFORM.REFRESH
          ELSE
            DO file_impact
            unlock all
            return
          ENDIF   
          unlock all
         RELEASE ALL LIKE BK*
      ENDIF      
  ENDPROC  
enddefine    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=B12_1.F01     
     HK=LEFT(DTOC(A23.F01),5)
     FRMDPT=IIF(SEEK(B12_1.F07,'C01'),C01.F04,'')
     TODDPT=IIF(SEEK(B12_1.F08,'C01_1'),C01_1.F04,'')
     SELECT B12.F01,;
            B12.F02,;
            B12.F03,;
            B12.F04,;                    
            B12.F07,;
            B12.F05,;
            B12.F11,;
            B12.F08,;
            B12.F13,;
            B01.F02;            
     FROM B12,B01 WHERE B12.F01=LK AND B01.F01=B12.F03 ORDER BY B12.F03 NOWAIT
     IF _tally >0
*        REPORT FORM ALLTRIM(INT_116)+'B36' PREVIEW
         report form ALLTRIM(INT_116)+'B36' to print prompt 
     ENDIF  
ENDPROC
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=20
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F01 = ANY(SELECT F03 FROM B11 WHERE B11.F08+B11.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)      
       ELSE
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND F01 = ANY(SELECT F03 FROM B11 WHERE B11.F08+B11.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)      
       ENDIF        
       IF _TALLY>0
          MTR_SEEK=createobject("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'     
       ENDIF          
    ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')      
  ENDPROC

ENDDEFINE

***************************************************特殊欄位------------------撥出對象
DEFINE CLASS TXTF07 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9       
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF     
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F04,'')         
  ENDPROC
ENDDEFINE  
*************************************************特殊欄位------------------撥入對象
DEFINE CLASS TXTF08 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9       
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM C01_1 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM C01_1 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF     
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(SEEK(THIS.VALUE,'C01_1'),C01_1.F04,'')         
  ENDPROC
ENDDEFINE  

***************************************************特殊輸入欄位設定-----------部門
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F04='*' AND F01 <>INT_190
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE F04='*' AND F01<>INT_190
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=createobject("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF       
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')  
  ENDPROC
ENDDEFINE