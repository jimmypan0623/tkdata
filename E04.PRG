***程式名稱:製令加工單
close all
clear 
FLG=''
FCH=''
CHK=''
CHK_STR=''
FTR_STR=''
R=0
RK=''
QTY=0
TQTY=0
AREA1='E03'
AREA2='E11'     
RTE_TABLE='E07'
RTG_NB=0   &&存放製程數之變數
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021    
SEEK sys_oper+'E04'
IF !USED('A14')
   SELE 0
   USE A14
ELSE
   SELE A14
ENDIF
SET FILTER TO F05='*'
SET ORDER TO 1 
IF !USED('E08')
   SELECT 0
   USE E08
ELSE
   SELECT E08
ENDIF
SET ORDER TO E083      
IF !USED('E06')
   SELE 0
   USE E06
ELSE
   SELE E06
ENDIF
SET ORDER TO E061      
IF !USED('E16')
   SELE 0
   USE E16 
ELSE
   SELE E16
ENDIF
SET ORDER TO E164
IF !USED('C20')
   SELECT 0
   USE C20
ELSE
   SELECT C20
ENDIF
SET ORDER TO 1      
IF !USED('C05')
   SELE 0
   USE C05
ELSE
   SELE C05
ENDIF
SET ORDER TO C054
IF !USED('C04')
   SELE 0
   USE C04 
ELSE
   SELE C04
ENDIF
SET ORDER TO C041 
IF !USED('C03')
   SELE 0
   USE C03
ELSE 
   SELE C03
ENDIF
SET ORDER TO C031       
IF !USED('C01')
   SELE 0
   USE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011      
IF !USED('B01')
   SELE 0
   USE B01 
ELSE
   SELE B01
ENDIF
SET ORDER TO B011           

IF !USED('F06')
    SELE 0 
    USE F06
ELSE
    SELE F06
ENDIF
SET ORDER TO F061        
IF !USED('E00')
   SELE 0
   USE E00
ELSE
   SELE E00
ENDIF
SET ORDER TO 1 
IF !USED('E05')
   SELE 0
   USE E05
ELSE
   SELE E05
ENDIF
SET ORDER TO E051 
IF !USED('E07')
   SELE 0
   USE E07
ELSE
   SELE E07
ENDIF
SET ORDER TO E071      
IF !USED('F07')
   SELE 0
   USE F07
ELSE
   SELE F07
ENDIF
SET ORDER TO F071
IF !USED('F01')
   SELE 0
   USE F01
ELSE
   SELE F01
ENDIF
SET ORDER TO F013
IF !USED('F02')
   SELE 0
   USE F02
ELSE
   SELE F02
ENDIF
SET ORDER TO F021            
IF !USED('E03')
   SELECT 0
   USE E03
ELSE 
   SELE E03
ENDIF
SET ORDER TO E031         
SET RELATION TO F08 INTO C01 
SET RELATION TO F14 INTO A14 ADDI
IF !USED('E11')
   SELE 0
   USE E11
ELSE 
   SELE E11
ENDIF
SET ORDER TO E111
SET RELA TO F04 INTO B01
SET RELA TO F11 INTO E00 ADDI
E04form=createobject("TKE04")
E04form.show  
define class TKE04 as form
  caption='E04.製令加工單'
*!*	  autocenter=.t.
  controlbox=.F.
  BORDERSTYLE=3  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  WIDTH=INT_015*789
  windowtype=1
  NAME='TKE04'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.       
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*255,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;                     
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT PASS_CND AS LABEL WITH;
      LEFT=INT_015*250,;
      TOP=INT_015*230,;
      CAPTION='',;
      AUTOSIZE=.T.           
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      autocenter=.t.
  ADD OBJECT grid1 AS grid1 WITH;
      columncount=5,;            
      RECORDSOURCE='E03',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'            
  ADD OBJECT grid2 AS grid2 WITH;
      HEIGHT=INT_015*263,;
      TOP=INT_015*257,;
      columncount=7,;            
      RECORDSOURCE='E11',; 
      LINKMASTER='E03',;
      RELATIONALEXPR='F03',;
      childorder='E111',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7'          
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.                             
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.               
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*221,;
      LEFT=INT_015*660          
  ADD OBJECT RTG_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*75,;      
      CAPTION='\<T.製程部門',;
      NAME='RTG_BOTT'                             
  ADD OBJECT ISB_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*135,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*70,;      
      CAPTION='\<B.更換代料',;
      NAME='ISB_BOTT'                         
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;      
      CAPTION='\<A.確認',;
      NAME='ANS_BOTT'                             
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*7
         .WIDTH=INT_015*50
         .CAPTION='完成品號'
     ENDWITH
     THIS.ADDOBJECT('LBLF011','LABEL')
     WITH THIS.LBLF011
          .VISIBLE=.T.
          .LEFT=INT_015*326
          .TOP=INT_015*7          
          .AUTOSIZE=.T.         
     ENDWITH          
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*32
         .WIDTH=INT_015*50
         .CAPTION='版        本'
     ENDWITH     
     THIS.ADDOBJECT('LBLF20','LABEL')
     WITH THIS.LBLF20
         .VISIBLE=.T.
         .LEFT=INT_015*189
         .TOP=INT_015*32
         .WIDTH=INT_015*50
         .CAPTION='完工類別'
     ENDWITH          
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*57
          .WIDTH=INT_015*50
          .CAPTION='製令編號'          
     ENDWITH     
     THIS.ADDOBJECT('LBLF14','LABEL')
     WITH THIS.LBLF14
         .VISIBLE=.T.
         .LEFT=INT_015*189
         .TOP=INT_015*57
         .WIDTH=INT_015*50
         .CAPTION='完工部門'
     ENDWITH          
     THIS.ADDOBJECT('LBLF141','LABEL')
     WITH THIS.LBLF141
         .VISIBLE=.T.
         .LEFT=INT_015*295
         .TOP=INT_015*57
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH               
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*82
         .WIDTH=INT_015*50
         .CAPTION='上線日期'
     ENDWITH          
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*189
         .TOP=INT_015*82
         .WIDTH=INT_015*370
         .CAPTION='應完工日'
     ENDWITH                              
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='需求客戶'
     ENDWITH                    
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*116
         .TOP=INT_015*107
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH                
     THIS.ADDOBJECT('LBLF12','LABEL')
     WITH THIS.LBLF12
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*132
         .WIDTH=INT_015*370
         .CAPTION='工作說明'
     ENDWITH                             
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*32
         .WIDTH=INT_015*370
         .CAPTION='需製數量'
     ENDWITH               
     THIS.ADDOBJECT('LBLF15','LABEL')
     WITH THIS.LBLF15
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*57
         .WIDTH=INT_015*370
         .CAPTION='備品數量'
     ENDWITH               
     THIS.ADDOBJECT('LBLF05','LABEL')
     WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*82
         .WIDTH=INT_015*50
         .CAPTION='已完工量'
     ENDWITH                    
     THIS.ADDOBJECT('LBLF051','LABEL')
     WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*429
         .TOP=INT_015*82
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH                         
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='取消數量'
     ENDWITH                    
     THIS.ADDOBJECT('LBLF101','LABEL')
     WITH THIS.LBLF101
         .VISIBLE=.T.
         .LEFT=INT_015*429
         .TOP=INT_015*107
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH                
     THIS.ADDOBJECT('LBLE07','LABEL')
     WITH THIS.LBLE07
         .VISIBLE=.T.
         .LEFT=INT_015*14    
         .TOP=INT_015*157
         .WIDTH=INT_015*50
         .CAPTION='待製途程'
     ENDWITH                              
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*130    
         .TOP=INT_015*212
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH       
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*180    
         .TOP=INT_015*212
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH            
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*310    
         .TOP=INT_015*212
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH       
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*360    
         .TOP=INT_015*212
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH                        
      THIS.ADDOBJECT('RTGBOX','EDITBOX')&&文書編輯EDITBOX
      WITH THIS.RTGBOX
                  .LEFT=INT_015*64
                 .TOP=INT_015*153
                 .WIDTH=INT_015*475
                 .HEIGHT=INT_015*48
                 .FONTSIZE=INT_015*8
                 .VISIBLE=.T.
                 .READONLY=.T.
                 .MAXLENGTH=600
                 .NAME='RTGBOX'           
      ENDWITH     
     THIS.ADDOBJECT('TXTF01','TXTF01')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*3
          .WIDTH=INT_015*261
          .HEIGHT=INT_015*25
          .MAXLENGTH=43
     ENDWITH        
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*28
          .WIDTH=INT_015*30
          .HEIGHT=INT_015*25
          .MAXLENGTH=3
     ENDWITH                  
  THIS.ADDOBJECT('OPTIONGROUP20','OPTIONGROUP')
     WITH THIS.OPTIONGROUP20
          .VISIBLE=.T.
          .LEFT=INT_015*240
          .TOP=INT_015*28
	  .HEIGHT=INT_015*25
	  .WIDTH=INT_015*104
	  .BUTTONCOUNT=2
	  .VALUE=1
	  .ENABLED=.F.
	  .NAME='OPTIONGROUP20'
	  .OPTION1.CAPTION='正常'
	  .OPTION1.TOP=INT_015*5
	  .OPTION1.FONTSIZE=INT_015*9	  
	  .OPTION1.AUTOSIZE=.T.
	  .OPTION1.LEFT=INT_015*5
	  .OPTION1.NAME='OPTION1'
	  .OPTION2.CAPTION='重工'
	  .OPTION2.TOP=INT_015*5
	  .OPTION2.FONTSIZE=INT_015*9	  
	  .OPTION2.AUTOSIZE=.T.
	  .OPTION2.LEFT=INT_015*50
	  .OPTION2.NAME='OPTION2'     
     ENDWITH          	     
     THIS.ADDOBJECT('TXTF03','TXTF03')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*53
          .WIDTH=INT_015*100
          .HEIGHT=INT_015*25
          .MAXLENGTH=12
     ENDWITH             
     THIS.ADDOBJECT('TXTF14','TXTF14')          
     WITH THIS.TXTF14
          .VISIBLE=.T.
          .LEFT=INT_015*240
          .TOP=INT_015*53
          .WIDTH=INT_015*50
          .HEIGHT=INT_015*25
     ENDWITH                       
     THIS.ADDOBJECT('TXTF06','TEXTBOX')          
     WITH THIS.TXTF06
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*78
          .WIDTH=INT_015*70
          .HEIGHT=INT_015*25
     ENDWITH                       
     THIS.ADDOBJECT('TXTF07','TEXTBOX')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*240
          .TOP=INT_015*78
          .WIDTH=INT_015*70
          .HEIGHT=INT_015*25
     ENDWITH                            
     THIS.ADDOBJECT('TXTF08','TXTF08')          
     WITH THIS.TXTF08
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*103
          .WIDTH=INT_015*50
          .HEIGHT=INT_015*25
     ENDWITH                                 
     THIS.ADDOBJECT('TXTF12','TEXTBOX')          
     WITH THIS.TXTF12
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*128
          .WIDTH=INT_015*335
          .HEIGHT=INT_015*25
          .MAXLENGTH=65
     ENDWITH                                 
     THIS.ADDOBJECT('TXTF04','TEXTBOX')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*428
          .TOP=INT_015*28
          .WIDTH=INT_015*90
          .HEIGHT=INT_015*90
          .INPUTMASK='999999999'
     ENDWITH                                     
     THIS.ADDOBJECT('TXTF15','TEXTBOX')          
     WITH THIS.TXTF15
          .VISIBLE=.T.
          .LEFT=INT_015*428
          .TOP=INT_015*53
          .WIDTH=INT_015*90
          .HEIGHT=INT_015*90
          .INPUTMASK='999999999'
     ENDWITH                                           
  ENDPROC     
  ***
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF04','LABEL')
	WITH THIS.LBLF04
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*7
	     .WIDTH=INT_015*50
         .CAPTION='材料品號'
    ENDWITH  
	THIS.ADDOBJECT('LBLF041','LABEL')
	WITH THIS.LBLF041
	     .VISIBLE=.T.
         .LEFT=INT_015*327
         .TOP=INT_015*7
	     .AUTOSIZE=.T.
         .CAPTION=''
    ENDWITH      
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*32
	     .WIDTH=INT_015*50
	     .CAPTION='版        本'
	ENDWITH     
    THIS.ADDOBJECT('LBLF10','LABEL')
    WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='需求日期'
	ENDWITH     
    THIS.ADDOBJECT('LBLF11','LABEL')
    WITH THIS.LBLF11
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*82
	     .WIDTH=INT_015*50
	     .CAPTION='投入製程'
	ENDWITH     		 	   
    THIS.ADDOBJECT('LBLF111','LABEL')
    WITH THIS.LBLF111
         .VISIBLE=.T.
	     .LEFT=INT_015*110
	     .TOP=INT_015*82
	     .AUTOSIZE=.T.
	     .CAPTION=''
	ENDWITH     		 
    THIS.ADDOBJECT('LBLF18','LABEL')
    WITH THIS.LBLF18
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*107
	     .WIDTH=INT_015*50
	     .CAPTION='供料方式'
	ENDWITH     		 	   		
    THIS.ADDOBJECT('LBLF181','LABEL')
    WITH THIS.LBLF181
         .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*107
	     .AUTOSIZE=.T.
	     .CAPTION=''
	ENDWITH     		 	   			
    THIS.ADDOBJECT('LBLF14','Label')
    WITH THIS.LBLF14
         .VISIBLE=.T.
         .LEFT=INT_015*328
         .TOP=INT_015*32
         .WIDTH=INT_015*50
         .CAPTION='代用料數'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF141','Label')
    WITH THIS.LBLF141
         .VISIBLE=.T.
         .LEFT=INT_015*379
         .TOP=INT_015*32
         .AUTOSIZE=.T.
         .CAPTION=''         
    ENDWITH         
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.
	     .LEFT=INT_015*328
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='單位用量'
	ENDWITH     
	THIS.ADDOBJECT('LBLF061','LABEL')
    WITH THIS.LBLF061
         .VISIBLE=.T.
	     .LEFT=INT_015*379
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='1/'
	ENDWITH     
    THIS.ADDOBJECT('LBLF20','LABEL')
    WITH THIS.LBLF20
         .VISIBLE=.T.
	     .LEFT=INT_015*328
	     .TOP=INT_015*82
	     .WIDTH=INT_015*50
	     .CAPTION='耗損率％'
	ENDWITH     	
    THIS.ADDOBJECT('LBLF07','LABEL')
    WITH THIS.LBLF07
         .VISIBLE=.T.    
         .LEFT=INT_015*328
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='應領數量'       
    ENDWITH        
    THIS.ADDOBJECT('LBLF071','LABEL')
    WITH THIS.LBLF071
         .VISIBLE=.T.    
         .LEFT=INT_015*379
         .TOP=INT_015*107
         .AUTOSIZE=.T.
         .CAPTION='0'       
    ENDWITH            
    THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
         .VISIBLE=.T.    
         .LEFT=INT_015*328
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='已領數量'       
    ENDWITH        
    THIS.ADDOBJECT('LBLF081','LABEL')
    WITH THIS.LBLF081
         .VISIBLE=.T.    
         .LEFT=INT_015*379
         .TOP=INT_015*132
         .AUTOSIZE=.T.
         .CAPTION='0'       
    ENDWITH            
    THIS.ADDOBJECT('LBLF09','LABEL')
    WITH THIS.LBLF09
         .VISIBLE=.T.    
         .LEFT=INT_015*328
         .TOP=INT_015*157
         .WIDTH=INT_015*50
         .CAPTION='已耗用量'       
    ENDWITH        
    THIS.ADDOBJECT('LBLF091','LABEL')
    WITH THIS.LBLF091
         .VISIBLE=.T.    
         .LEFT=INT_015*379
         .TOP=INT_015*157
         .AUTOSIZE=.T.
         .CAPTION='0'       
    ENDWITH                
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*182
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF121','LABEL')
    WITH THIS.LBLF121
        .VISIBLE=.T.           
        .LEFT=INT_015*380
        .TOP=INT_015*182
        .AUTOSIZE=.T.
    ENDWITH        
    THIS.ADDOBJECT('LBLF15','LABEL')
    WITH THIS.LBLF15
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*132
	     .WIDTH=INT_015*50
	     .CAPTION='使用廠牌'
	ENDWITH     		 	   	
    THIS.ADDOBJECT('LBLF16','LABEL')
    WITH THIS.LBLF16
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*157
	     .WIDTH=INT_015*50
	     .CAPTION='備註說明'
	ENDWITH     		 	   		
	THIS.ADDOBJECT('TXTF04','TXTF04')
	WITH THIS.TXTF04      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*3
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF04'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF05','TEXTBOX')
	WITH THIS.TXTF05
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*28
	     .WIDTH=INT_015*30
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=3
	     .NAME='TXTF05'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF10','TEXTBOX')
    WITH THIS.TXTF10
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*53
         .WIDTH=INT_015*70
         .HEIGHT=INT_015*25         
         .NAME='TXTF10'
    ENDWITH             	
    THIS.ADDOBJECT('TXTF11','TXTF11')
    WITH THIS.TXTF11
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*78
         .WIDTH=INT_015*40
         .HEIGHT=INT_015*25
         .MAXLENGTH=4
         .NAME='TXTF11'
    ENDWITH             
    THIS.ADDOBJECT('SPLY_TYPE','SPLY_TYPE')

    THIS.ADDOBJECT('TXTF15','TEXTBOX')
    WITH THIS.TXTF15
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*128
         .WIDTH=INT_015*224
         .HEIGHT=INT_015*25
         .MAXLENGTH=30
         .NAME='TXTF15'
    ENDWITH                 
    THIS.ADDOBJECT('TXTF16','TEXTBOX')
    WITH THIS.TXTF16
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*153
         .WIDTH=INT_015*224
         .HEIGHT=INT_015*25
         .MAXLENGTH=30
         .NAME='TXTF16'
    ENDWITH                     
    THIS.ADDOBJECT('TXTF06','TEXTBOX')
    WITH THIS.TXTF06
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*53
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='999999.9999'
         .NAME='TXTF06'
    ENDWITH         
    THIS.ADDOBJECT('TXTF20','TEXTBOX')
    WITH THIS.TXTF20
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*78
         .WIDTH=INT_015*45
         .HEIGHT=INT_015*25
         .INPUTMASK='99.99'
         .NAME='TXTF20'
    ENDWITH             
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     SELE E03
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(E03.F11=.F.,RGB(255,0,0),'')","COLUMN")              
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS   
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.ISB_BOTT.ENABLED=.F.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
     ENDIF                
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.RTG_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.RTGBOX.VALUE=''                
        THISFORM.PAGEFRAME1.PAGE1.LBLF141.CAPTION=''    
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''      
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限 
        THISFORM.ANS_BOTT.ENABLED=!E03.F11 .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.RTG_BOTT.ENABLED=IIF(E03.F04+E03.F15=E03.F05,.F.,.T.)
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   

  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE E11
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF   
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.        
        THISFORM.ISB_BOTT.ENABLED=.F.        
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF041.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF071.CAPTION='0'        
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION='0'                
        THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION='0'                        
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=''     
        THISFORM.PAGEFRAME1.PAGE2.LBLF141.CAPTION='0'   
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)   &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限 
*        THISFORM.ISB_BOTT.ENABLED=E11.F14>0        
        THISFORM.ANS_BOTT.ENABLED=!E03.F11 .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED        &&判斷有無確認的權限
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)    &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.RTG_BOTT.ENABLED=.F.     
  ENDPROC     
  PROC INIT       
       SELE E03    
       SET ORDER TO 1
       GO BOTT
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.       
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(E03.F11=.F.,RGB(255,0,0),'')","COLUMN")  
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)              
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='製令編號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='完成品號'    
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='版        次'          
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='部門編號'          
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門簡稱'                        
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='E03.F03'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='E03.F01'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='E03.F02'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='E03.F14'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'              
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*90
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*30      
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50      
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60                     
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='使用材料編號'       
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='版本'              
       THISFORM.grid2.COLUMN3.HEADER1.CAPTION='需求日期'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='單位用量'	  
	   THISFORM.grid2.COLUMN5.HEADER1.CAPTION='應領數量'
	   THISFORM.grid2.COLUMN6.HEADER1.CAPTION='投入製程'
	   THISFORM.grid2.COLUMN7.HEADER1.CAPTION='供料方式'	   	   
	   THISFORM.GRID2.LINKMASTER='E03'
       THISFORM.GRID2.RELATIONALEXPR='F01+F02+F03'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='E11.F04'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='E11.F05'	   
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='E11.F10'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE="IIF(IIF(SEEK(E11.F04,'B01'),B01.F39,'')='C','1/'+ALLTRIM(STR(E11.F06)),TRANSFORM(E11.F06,'@R 9999999.9999'))"
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE='E11.F07'
  	   THISFORM.grid2.COLUMN6.CONTROLSOURCE='E00.F04'
  	   THISFORM.grid2.COLUMN7.CONTROLSOURCE="IIF(E11.F18='1','廠內發料',IIF(E11.F18='2','廠商自備','客戶提供'))"
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
       THISFORM.grid2.COLUMN2.WIDTH=INT_015*30
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN4.ALIGNMENT=2
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*50
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*60
       THISFORM.grid1.READONLY=.T.      
       THISFORM.grid2.READONLY=.T.            
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限 
          THISFORM.ANS_BOTT.ENABLED=!E03.F11  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依製令編號排列'      
       JK='製令編號'
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=E03.F03       
       THISFORM.GRID1.SETFOCUS       
  ENDPROC               
  PROC KEY_LIST.INIT 
       WITH THIS 
           .additem('依製令編號排列')      
           .additem('依完成品號排列')                    
           .ADDITEM('依加工部門排列')
       ENDWITH
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE E03
       DO CASE
          CASE THIS.DISPLAYVALUE='依製令編號排列'
               set order to E031
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='製令編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='E03.F03'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*90
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='完成品號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='E03.F01'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='版次'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='E03.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*30
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='部門編號'               
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='E03.F14'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門簡稱'               
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60                         
          CASE THIS.DISPLAYVALUE='依完成品號排列'
               set order to E032
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='完成品號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='E03.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='版次'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='E03.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*30
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='製令編號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='E03.F03'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*90        
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='部門編號'               
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='E03.F14'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門簡稱'               
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60               
          CASE THIS.DISPLAYVALUE='依加工部門排列'
               set order to E033 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='部門編號'               
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='E03.F14'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門簡稱'               
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60                      
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='完成品號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='E03.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*149
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='版次'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='E03.F02'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*30
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='製令編號'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='E03.F03'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*90                                                                                                                                                                               
       ENDCASE 
       THISFORM.grid1.SETFOCUS
  ENDPROC        
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex       
       THISFORM.PASS_CND.BACKCOLOR=IIF(E03.F11=.T.,RGB(0,255,0),RGB(255,0,0))            
       THISFORM.PASS_CND.CAPTION=IIF(E03.F11=.T.,'    已確認    ','    未確認    ')       
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=E03.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF011.caption=IIF(SEEK(E03.F01,'B01'),B01.F02,'')
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=E03.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=E03.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=E03.F06
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=E03.F07
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=E03.F08       
       THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=E03.F12       
       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=E03.F14
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=E03.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE=E03.F15       
       THISFORM.PAGEFRAME1.PAGE1.OPTIONGROUP20.VALUE=VAL(E03.F20)       
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.caption=TRANSFORM(E03.F05,'@R 99999999')
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.caption=IIF(SEEK(E03.F08,'C01'),C01.F04,'')
       THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=TRANSFORM(E03.F10,'@R 99999999')
       THISFORM.PAGEFRAME1.PAGE1.LBLF141.caption=A14.F02  
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=E03.F09
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=E03.F90
       THISFORM.PAGEFRAME1.PAGE1.RTGBOX.VALUE=ROUTE(E03.F03,SPACE(0))
       RTG_NB=OCCURS('》',THISFORM.PAGEFRAME1.PAGE1.RTGBOX.VALUE)       
       THISFORM.ANS_BOTT.ENABLED=!E03.F11 .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED        
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.RTG_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.RTG_BOTT.ENABLED=IIF(E03.F04+E03.F15=E03.F05,.F.,.T.)
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=E11.F04
       THISFORM.PAGEFRAME1.PAGE2.LBLF041.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=E11.F05
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=E11.F06
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.INPUTMASK=IIF(B01.F39='C','999999','999999.9999')
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.LEFT=INT_015*IIF(B01.F39='C',399,379)
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.WIDTH=INT_015*IIF(B01.F39='C',65,100)
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=E11.F20
       THISFORM.PAGEFRAME1.PAGE2.LBLF071.CAPTION=TRANSFORM(E11.F07,'@R 99999999.9999')
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=TRANSFORM(E11.F08,'@R 99999999.9999')       
       THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=TRANSFORM(E11.F09,'@R 99999999.9999')              
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=E11.F05
       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=E11.F10
       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=E11.F11    
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=E11.F15              
       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=E11.F16      
       THISFORM.PAGEFRAME1.PAGE2.LBLF181.CAPTION=IIF(E11.F18='1','廠內發料',IIF(E11.F18='2','廠商自備','客戶提供'))
       THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=E00.F04
       THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=E11.F12       
       THISFORM.PAGEFRAME1.PAGE2.LBLF141.CAPTION=TRANSFORM(E11.F14,'@R 999')
       THISFORM.PAGEFRAME1.PAGE2.LBLF20.VISIBLE=IIF(B01.F39='B',.T.,.F.)                    
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.VISIBLE=IIF(B01.F39='B',.T.,.F.)             
       THISFORM.ISB_BOTT.ENABLED=IIF(E11.F14>0,.T.,.F.)
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  AND (E11.F13+E11.F17)=0 
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.) AND (E11.F13+E11.F17)=0       
*       THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=ALLTRIM(STR(F02.F11))
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
       if thisform.pageframe1.activepage=1
          thisform.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       thisform.refresh
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.RTG_BOTT.ENABLED=.F.
    THISFORM.ISB_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.        
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE='' 
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS                
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''      
        THISFORM.PAGEFRAME1.PAGE1.OPTIONGROUP20.ENABLED=.T.        
        THISFORM.PAGEFRAME1.PAGE1.OPTIONGROUP20.VALUE=1                
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=DATE()  
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=DATE()
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''                  
        THISFORM.PAGEFRAME1.PAGE1.TXTF14.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=0
        THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE=0                
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION='0'        
        THISFORM.PAGEFRAME1.PAGE1.LBLF141.CAPTION=''     
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''            
        THISFORM.PAGEFRAME1.PAGE1.RTGBOX.VALUE=''
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS        
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=''         
        THISFORM.PAGEFRAME1.PAGE2.LBLF041.CAPTION=''                            
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF071.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=DATE()   
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''                
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=0        
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION='0'        
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE2.LBLF141.CAPTION='0'  
        THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VISIBLE=.T.  
        THISFORM.PAGEFRAME1.PAGE2.LBLF181.CAPTION=''                                  
     ENDIF   
  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
                SELECT F10,F15 FROM E07 WHERE (F15<F09 .OR. F10>0) .AND. F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE NOWAIT
                IF _TALLY>0
                    =MESSAGEBOX('此製令已有發包或完工未過帳量,不得修改!',0+48,'提示訊息視窗')
                    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK                    
                    RETURN                    
                ENDIF                    
                
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.     
     THISFORM.RTG_BOTT.ENABLED=.F.
     THISFORM.ISB_BOTT.ENABLED=.F.                    
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.        
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
        PO_NO='CA'+LEFT(E03.F03,8)
        SELE RECNO() FROM E11 WHERE E11.F01=E03.F03  INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'E11')
           LL1=RLOCK(KK1,'E11')
        ELSE 
           LL1=.T.
        ENDIF   
        IF E03.F16=.T.   &&如果為最後製令
           SELE RECNO() FROM C04 WHERE C04.F03+C04.F04=PO_NO+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE  INTO ARRAY BK2
           JJ2=''                
           IF _TALLY>0                   
              FOR I= 1 TO ALEN(BK2)
                  JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
              ENDFOR  
              KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
              RLOCK(KK2,'C04')
              LL2=RLOCK(KK2,'C04')
           ELSE 
              LL2=.T.
           ENDIF           
        ELSE
           LL2=.T.
        ENDIF   
        SELE RECNO() FROM E06 WHERE E06.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE INTO ARRAY BK3
        JJ3=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK3)
               JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
           ENDFOR  
           KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')
           RLOCK(KK3,'E06')
           LL3=RLOCK(KK3,'E06')
        ELSE 
           LL3=.T.
        ENDIF                   
        SELE RECNO() FROM E16 WHERE E16.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE INTO ARRAY BK4
        JJ4=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK4)
               JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
           ENDFOR  
           KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')
           RLOCK(KK4,'E16')
           LL4=RLOCK(KK4,'E16')
        ELSE 
           LL4=.T.
        ENDIF                           
        IF RLOCK('E03') .AND. LL1 .AND. LL2 .AND. LL3 .AND. LL4=.T.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF14.READONLY=.F.           
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
        ELSE
           DO file_impact
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
        endif        
     ELSE                                                      &&處理表身修改   
        SELE RECNO() FROM E16 WHERE E16.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE INTO ARRAY BK4
        JJ4=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK4)
               JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
           ENDFOR  
           KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')
           RLOCK(KK4,'E16')
           LL4=RLOCK(KK4,'E16')
        ELSE 
           LL4=.T.
        ENDIF                                         
        IF RLOCK('E11') .AND. LL4
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VISIBLE=.T. 
           THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE=VAL(E11.F18)
           THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS           
        ELSE  
           DO file_impact 
           unlock all
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       endif             
     ENDIF  
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
      IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6      
          if thisform.pageframe1.activepage=1          &&刪除整組BOM
              SELECT F10,F15 FROM E07 WHERE (F15<F09 .OR. F10>0) .AND. F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE NOWAIT
                IF _TALLY>0
                    =MESSAGEBOX('此製令已有發包或完工未過帳量,不得刪除!',0+48,'提示訊息視窗')
                    RETURN
                ENDIF                  
              IF E03.F05>0 AND E03.F05+E03.F10<>E03.F04+E03.F15
                 
                   =MESSAGEBOX('已有完工數量!不得整組刪除!',0+48,'提示訊息視窗')
                   THISFORM.GRID1.SETFOCUS
                   RETURN
              ENDIF
              IF  E03.F05+E03.F10=E03.F04+E03.F15    
                  IF A02.F12<>'*'
                     =MESSAGEBOX('雖已全數完工但你無權限整組刪除!',0+48,'提示訊息視窗')
                     THISFORM.GRID1.SETFOCUS
                     RETURN
                  ENDIF
              ENDIF   
              
              SELE E03        
              PO_NO=E03.F03
              SELE RECNO() FROM E16 WHERE E16.F01=PO_NO INTO ARRAY BK4
              JJ4=''                
              IF _TALLY>0   
                 FOR I= 1 TO ALEN(BK4)
                     JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
                 ENDFOR    
                 KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')              
                 RLOCK(KK4,'E16')
                 LL4=RLOCK(KK4,'E16')
              ELSE
                 LL4=.T.   
             ENDIF                           
             IF E03.F16=.T.                           &&如果為最後製令  
                 SELE RECNO() FROM C04 WHERE C04.F03+C04.F04='CA'+LEFT(PO_NO,8)+E03.F01 INTO ARRAY BK3
                 JJ3=''                
                 IF _TALLY>0   
                     FOR I= 1 TO ALEN(BK3)
                           JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
                     ENDFOR    
                     KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
                     RLOCK(KK3,'C04')
                     LL3=RLOCK(KK3,'C04')
                 ELSE
                     LL3=.T.   
                 ENDIF       
             ELSE                   
                  LL3=.T.
             ENDIF                                                         
             SELE RECNO() FROM E06 WHERE E06.F01=PO_NO  INTO ARRAY BK2             
             JJ2=''                
             IF _TALLY>0   
                 FOR I= 1 TO ALEN(BK2)
                     JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                 ENDFOR    
                 KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
                 RLOCK(KK2,'E06')
                 LL2=RLOCK(KK2,'E06')
             ELSE
                 LL2=.T.   
             ENDIF                                    
             SELE RECNO() FROM E07 WHERE E07.F01=PO_NO  INTO ARRAY BK5
             JJ5=''                
             IF _TALLY>0   
                FOR I= 1 TO ALEN(BK5)
                    JJ5=JJ5+ALLTRIM(STR(BK5(I)))+','
                ENDFOR    
                KK5=STUFF(JJ5,RAT(',',JJ5,1),1,'')              
                RLOCK(KK5,'E07')
                LL5=RLOCK(KK5,'E07')
             ELSE
                LL5=.T.   
             ENDIF                                                 
             SELE RECNO() FROM E11 WHERE E11.F01=E03.F03  INTO ARRAY BK1              
             JJ1=''                
             IF _TALLY>0   
                FOR I= 1 TO ALEN(BK1)
                    JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                ENDFOR    
                KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                RLOCK(KK1,'E11')
                LL1=RLOCK(KK1,'E11')
             ELSE
                LL1=.T.   
             ENDIF                   
             IF LL5 .AND. LL1 .AND. LL2 .AND. LL3 .AND. LL4 .AND. RLOCK('E03')                   
                 IF E03.F11=.T.                         &&如果此子製令已確認過
                      IF LEN(JJ4)>0
                           SELECT E16                
                            SEEK E03.F03
                            IF FOUND()
                               DO WHILE F01=E03.F03
                                  SELECT E08            
                                  SEEK E16.F02
                                  IF FOUND()
                                     REPLACE F20 WITH F20+E16.F04
                                  ELSE
                                     APPEND BLANK
                                     REPLACE F01 WITH E16.F03
                                     REPLACE F02 WITH E16.F02
                                     REPLACE F20 WITH E16.F04
                                  ENDIF
                                  SELECT E16
                                  DELETE 
                                  SKIP
                               ENDDO   
                            ENDIF         
*!*	                            DELE FROM E16 WHERE E16.F01=E03.F03                          
                      ENDIF                    
                 ENDIF             
                 SELECT E06                 
                 SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE  
                 IF FOUND()
                    SELECT E08
                    SEEK E06.F02
                    IF FOUND()
                       REPLACE F20 WITH F20+E06.F04*(-1)
                    ELSE
                       APPEND BLANK
                       REPLACE F01 WITH E06.F03
                       REPLACE F02 WITH E06.F02
                       REPLACE F20 WITH E06.F04*(-1)
                    ENDIF
                    SELECT E06
                    DELE
                 ENDIF
*!*	                DELE FROM E06 WHERE E06.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE                                                                                             
                IF E03.F16=.T.      &&若為訂單最後製程                
                     SELE C04
                     SEEK 'CA'+LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,8)+E03.F01
                     IF FOUND()
                         REPLACE  F11 WITH F11+E03.F04*(-1)
                         REPLACE F14 WITH F14+(-1)
                    ENDIF    
                ENDIF   
                SELE E11    
                DELE FROM E11 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE           
                SELE E07
                DELE FROM E07 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE       
                SELE E03
                DELE
                SKIP -1
                IF BOF()
                   GO TOP
                ENDIF   
                UNLOCK ALL
             ELSE
                DO file_impact                  
             ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.                 
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)    &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=!E03.F11 .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED                           
             ENDIF     
          ELSE                                                                &&刪除單筆資料  
                SELECT F10,F15 FROM E07 WHERE (F15<F09 .OR. F10>0) .AND. F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE NOWAIT
                IF _TALLY>0
                    =MESSAGEBOX('此製令已有發包或完工未過帳量,不得刪除!',0+48,'提示訊息視窗')
                    RETURN
                ENDIF           
                IF E03.F05>0 AND E03.F05+E03.F10<>E03.F04+E03.F15 
                   =MESSAGEBOX('已有完工數量!不得刪除!',0+48,'提示訊息視窗')
                   THISFORM.GRID2.SETFOCUS
                   RETURN
                ENDIF  
                IF E03.F05+E03.F10=E03.F04+E03.F15
                  IF A02.F12<>'*'
                     =MESSAGEBOX('雖已全數完工但你無權限刪除!',0+48,'提示訊息視窗')
                     THISFORM.GRID2.SETFOCUS
                     RETURN
                  ENDIF
              ENDIF   
               IF E03.F16=.T.                           &&如果為最後製令  
                   PO_NO=E03.F03+E03.F01
                   SELE RECNO() FROM C04 WHERE C04.F03+C04.F04='CA'+LEFT(PO_NO,8)+RIGHT(PO_NO,43) INTO ARRAY BK4
                   JJ4=''                
                   IF _TALLY>0   
                       FOR I= 1 TO ALEN(BK4)
                              JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
                       ENDFOR    
                       KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')              
                       RLOCK(KK4,'C04')
                       LL4=RLOCK(KK4,'C04')
                    ELSE
                       LL4=.T.   
                    ENDIF       
                ELSE                   
                    LL4=.T.
                ENDIF                                                                
                SELE E11
                PO_NO=E03.F03+E11.F04
                SELE RECNO() FROM E16 WHERE F01+F02=PO_NO  INTO ARRAY BK3             
                JJ3=''                
                IF _TALLY>0   
                     FOR I= 1 TO ALEN(BK3)
                             JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
                     ENDFOR    
                      KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
                      RLOCK(KK3,'E16')
                      LL3=RLOCK(KK3,'E16')
                ELSE
                     LL3=.T.   
                ENDIF                        
                IF LL4 .AND. LL3 .AND. RLOCK('E11')      
                     IF E11.F18<>'2'   &&如果非為廠商供料    
                        SELECT E16
                        SEEK PO_NO
                        IF FOUND()                       
                           SELECT E08
                           SEEK E16.F02                     
                          IF  FOUND()                        
                              REPLACE F20 WITH F20+E16.F04
                           ELSE
                              APPEND BLANK
                              REPLACE F01 WITH E16.F03
                              REPLACE F02 WITH E16.F02
                              REPLACE F20 WITH E16.F04
                           ENDIF
                        ENDIF                                 
                         DELE FROM E16 WHERE F01+F02=PO_NO           
                     ENDIF   
                     SELE E11                                                                 
                     DELE
                     SKIP -1
                     IF BOF()
                        GO TOP
                     ENDIF   
                ELSE
                     DO file_impact                  
                ENDIF                   
                THISFORM.GRID2.SETFOCUS
                 IF TQTY= -1                                          &&如果是承接替換代用料程序
                      THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=CHK_STR         &&直接執行表身新增程序  
                      THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=FTR_STR
                      THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=UKEF
                      THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=QTY
                      THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=RK
                      THISFORM.SHRGROUP.SHURE1_BOTT.CLICK                                                                 
                 ELSE
                       IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空                     
                            IF E03.F16=.T.    &&如果為最後製程    
                                SELE C04
                                SEEK 'CA'+LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,8)+E03.F01
                                IF FOUND()
                                    REPLACE F11 WITH F11+E03.F04*(-1)
                                    REPLACE F14 WITH F14+(-1)
                                ENDIF
                            ENDIF       
                           SELE E06                
                           SEEK E03.F03
                           IF FOUND()
                              SELECT E08
                              SEEK E06.F02
                              IF FOUND()
                                 REPLACE F20 WITH F20+E06.F04*(-1)
                              ELSE
                                 APPEND BLANK
                                 REPLACE F01 WITH E06.F03
                                 REPLACE F02 WITH E06.F02
                                 REPLACE F20 WITH E06.F04*(-1)
                              ENDIF
                              SELECT E06
                              DELE
                           ENDIF
*!*	                           DELE FROM E06 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                           SELE E07
                           DELE FROM E07 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                           SELE E03                  
                           DELE                               &&連表頭也要刪除
                           SKIP -1
                           IF BOF()
                               GO TOP
                           ENDIF   
                           THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                           THISFORM.REFRESH          
*                    THISFORM.ANS_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.)                 
                           THISFORM.GRID1.SETFOCUS  
                  ENDIF
             ENDIF   
          ENDIF
       ENDIF
       RELEASE ALL LIKE BK*   
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1                             &&表頭新增確認
       THISFORM.GRID2.RECORDSOURCE='E11'
       THISFORM.GRID2.CHILDORDER='E111'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='E11.F04'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='E11.F05'	   
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='E11.F10'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE="IIF(IIF(SEEK(E11.F04,'B01'),B01.F39,'')='C','1/'+ALLTRIM(STR(E11.F06)),TRANSFORM(E11.F06,'@R 9999999.999'))"
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE='E11.F07'
  	   THISFORM.grid2.COLUMN6.CONTROLSOURCE='E00.F04'
  	   THISFORM.grid2.COLUMN7.CONTROLSOURCE="IIF(E11.F18='1','廠內發料',IIF(E11.F18='2','廠商自備','客戶提供'))"
       SELE E03
       COD=SYS(21)
       SET ORDER TO E031
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('製令號碼不得空白!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF       
*!*	       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'E03')=.T.
*!*	          =MESSAGEBOX('此製令號碼重複!',0+48,'提示訊息視窗')
*!*	          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
*!*	          SET ORDER TO &COD
*!*	          RETURN            
*!*	       ENDIF                            
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'F01')=.F.
          =MESSAGEBOX('此版本完成品號尚未建立資料或是確認!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          SET ORDER TO &COD          
          RETURN  
       ENDIF
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          =MESSAGEBOX('版本不得空白!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF       
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE>THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          =MESSAGEBOX('上線日期不得大於需求日期',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF                                   
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE) .OR. SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE,'C01')=.F.
          =MESSAGEBOX('無此客戶編號!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF                            
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE) .OR. SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE,'A14')=.F.
          =MESSAGEBOX('無此部門編號!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF                
       PO_NO=LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,10)
            
       IF SEEK(PO_NO+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'C05','C054')=.F. .OR.;
          IIF(SEEK(PO_NO+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'C05','C054'),C05.F06,'')<>;
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          =MESSAGEBOX('無此出貨計劃!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF       
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE<=0
          =MESSAGEBOX('需製數量不得小於等於 0 !',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF                            
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE>IIF(SEEK(PO_NO;
          +THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'C04','C041'),MIN(C04.F05-C04.F11,C04.F10),0)
          =MESSAGEBOX('需製數量不得大於'+TRANSFORM(MIN(C04.F05-C04.F11,C04.F10),'@R 99999999999')+'!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF                
       SELE C03
       SEEK PO_NO
       IF FOUND()
          RLOCK()
          IF RLOCK()
             REPLACE F11 WITH F11+1
          ELSE
             DO file_impact
             THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
          ENDIF
       ENDIF                 
       SELE C04
       SEEK PO_NO+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF FOUND()
          RLOCK()
          IF RLOCK()
             REPL F11 WITH F11+THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
             REPL F14 WITH F14+1
          ELSE
             DO file_impact
             THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
          ENDIF      
       ENDIF   
         &&呼叫主程式中製令展開程序  
       DO MANUFACTURE_OD WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,;
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE,THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,;
       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE,ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.OPTIONGROUP20.VALUE))   &&呼叫主程式中製令展開程序

**********************************       
*       UNLOCK
       SELE E03
       SEEK SUBSTR(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,3,8)+PADL(ALLTRIM(STR(C03.F11)),2,'0')
       SET ORDER TO &COD                     
*       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
*!*	       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
*!*	       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
*       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
       THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.REFRESH

    ELSE                                                                                           &&表身新增確認    
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE)
          =MESSAGEBOX('物料基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN        
       ENDIF    
       IF seek(thisform.pageframe1.page1.txtF03.value+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE;
          +THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,'E11')=.T.
          =MESSAGEBOX('此材料編號已建立!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN
       ENDIF
       
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE<=0
          =MESSAGEBOX('用料數量不得小於等於零',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
          RETURN
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE<0
          =MESSAGEBOX('損耗率不得小於零',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF20.SETFOCUS
          RETURN
       ENDIF          
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE)
           =MESSAGEBOX('製程不得空白!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF11.SETFOCUS
           RETURN
       ENDIF    
       IF SEEK(E03.F03+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072')=.F.
           =MESSAGEBOX('無此製程編號!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF11.SETFOCUS
           RETURN           
       ENDIF
       IF E03.F11=.T. .AND. THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE<>2  &&如果已經確認且不為廠商自備物料
           SELE E16
           APPEND BLANK
           REPLACE  F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
           REPLACE  F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
           REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
           IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E00'),E00.F05,'')='3'                            
              REPLACE  F04 WITH CEILING((E03.F04+E03.F15)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100))
           ELSE
              IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01'),B01.F39,'')='C'
                 REPLACE  F04 WITH CEILING((E03.F04+E03.F15)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE^(-1))
              ELSE
              
                 REPLACE  F04 WITH ROUND((E03.F04+E03.F15)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100),4)
              ENDIF   
           ENDIF   
           REPLACE  F06 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072'),E07.F08,'')
           REPLACE  F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPLACE  F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           REPLACE  F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
           REPLACE F13 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
           SELECT E08   &&寫入最終結餘量
           SEEK E16.F02
           IF FOUND()
              REPLACE F20 WITH F20+E16.F04*(-1)
           ELSE
              APPEND BLANK
              REPLACE F01 WITH E16.F03
              REPLACE F02 WITH E16.F02
              REPLACE F20 WITH E16.F04*(-1)
           ENDIF
       ENDIF       
       SELE E11
       APPEND BLANK       
       rlock()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE          
          IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E00'),E00.F05,'')='3'             
             REPLACE F07 WITH CEILING(THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100))
          ELSE
             IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01'),B01.F39,'')='C'
                REPLACE F07 WITH CEILING(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE^(-1))                          
             ELSE
                REPLACE F07 WITH ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100),4)                          
             ENDIF   
          ENDIF
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F14 WITH IIF(SEEK(F04+F05,'F02'),F02.F11,0)
          REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE     
          REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE     
          REPLACE F18 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
      UNLOCK ALL         
      SELE E11
      seek thisform.pageframe1.page1.txtF03.value+THISFORM.PAGEFRAME1.PAGE2.TXTF04.value+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE       
      thisform.grid2.enabled=.t.
      thisform.grid2.setfocus  

*!*	      SELE E03
*!*	      REPL F05 WITH .F.
      IF TQTY<>-1              &&如果不是承接代料更換流程
         THISFORM.ORPGROUP.NEW_BOTT.CLICK      
      ELSE
         THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
      ENDIF   
    ENDIF  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1                            &&表頭修改確認
        DTT=.F.
        EUF=.F.
        IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
           =MESSAGEBOX('版本不得空白!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
           RETURN
        ENDIF
        IF THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE<>E03.F14
           IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE) .OR. SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE,'A14')=.F.
              =MESSAGEBOX('無此部門編號!',0+48,'提示訊息視窗')
              THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
              RETURN            
           ELSE
               IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE))=4  AND RTG_NB>1     &&若加工部門改為廠內生產部門且製程數不只一個
                   IF MESSAGEBOX('是否將所有製程之加工部門都修改為'+THISFORM.PAGEFRAME1.PAGE1.LBLF141.CAPTION+'?',4+32+0,'請確認') =6
                       DTT=.T.                       
                   ENDIF
               ELSE  
                       DTT=.T.         &&若改為協力廠商編號或是只有一個製程則連問都不需要問即將所有的製程的加工部門全部改為此部門編號  
               ENDIF             
           ENDIF                        
        ENDIF   
        IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE<>E03.F04+E03.F15 .OR. THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE<>E03.F06 &&如果修改數量或交期
           IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE<0
              =MESSAGEBOX('需製數量不得小於等於 0 !',0+48,'提示訊息視窗')
              THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
              RETURN
           ENDIF   
           IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE<E03.F05+E03.F13+E03.F10+E03.F17
              =MESSAGEBOX('需製數量與備品量不得小於已完工量'+TRANSFORM(E03.F05+E03.F13+E03.F10+E03.F17,'@R 99999999999')+'!',0+48,'提示訊息視窗')
              THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
              RETURN
           ENDIF                         
           IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE>E03.F04+E03.F15
              IF SEEK(E03.F03,'E07')=.F.
                 =MESSAGEBOX('此製令已無法再增加數量生產!請另新增子製令生產!',0+48,'提示訊息視窗')
                 THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
                 RETURN                 
              ENDIF
           ENDIF
           EUF=.T.
           IF E03.F16=.T. AND THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE<>E03.F04   &&若是最終成品且修改數量
              PO_NO='CA'+LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,8)
              IF THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE>IIF(SEEK(PO_NO;
                 +THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'C04','C041'),C04.F05-C04.F11+E03.F04,0)
                 =MESSAGEBOX('需製數量不得大於訂單未排量'+TRANSFORM((C04.F05-C04.F11+E03.F04),'@R 99999999999')+'!',0+48,'提示訊息視窗')
                 THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
                 RETURN            
              ENDIF                                
              SELE C04                                                    
              SEEK PO_NO+E03.F01
              IF FOUND()
                 REPL F11 WITH F11+E03.F04*(-1)                  &&訂單已排量先回歸為未排此張製令之前的數量   
                 REPL F11 WITH F11+THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE    &&再轉為目前修改的數量 
              ENDIF
           ENDIF                                              
           SELE E11        
           SEEK E03.F03
           IF FOUND()
              DO WHILE F01=E03.F03
                 IF E03.F11=.T. AND E11.F18<>'2'   &&如果已確認用料且不為廠商自備物料
                    SELE E16
                    SEEK E11.F01+E11.F04
                    IF FOUND()  
                       SELECT E08   && 先將預期結餘量還原
                       SEEK E16.F02
                       IF FOUND()
                          REPLACE F20 WITH F20+E16.F04
                       ELSE
                          APPEND BLANK
                          REPLACE F01 WITH E16.F03
                          REPLACE F02 WITH E16.F02
                          REPLACE F20 WITH E16.F04
                       ENDIF
                       SELE E16
                       IF IIF(SEEK(E11.F11,'E00'),E00.F05,'')='3'                           
                           REPLACE  F04 WITH CEILING((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE)*E11.F06*(1+E11.F20/100))-E11.F09
                           
                       ELSE
                          IF IIF(SEEK(E11.F04,'B01'),B01.F39,'')='C'
                              REPLACE  F04 WITH CEILING((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE)*E11.F06^(-1))-E11.F09
                          ELSE
                             REPLACE  F04 WITH ROUND((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE)*E11.F06*(1+E11.F20/100),4)-E11.F09
                          ENDIF 
                       ENDIF    
                       SELECT E08   && 再將預期結餘量減掉新數量
                       SEEK E16.F02
                       IF FOUND()
                          REPLACE F20 WITH F20+E16.F04*(-1)
                       ELSE
                          APPEND BLANK
                          REPLACE F01 WITH E16.F03
                          REPLACE F02 WITH E16.F02
                          REPLACE F20 WITH E16.F04*(-1)
                       ENDIF
                       SELECT E16
                       IF F04<=0
                          DELETE
                       ELSE   
                          IF F04<F05
                             REPLACE F05 WITH F04
                          ENDIF    
                          REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE-IIF(SEEK(E11.F04,'B01'),B01.F31,0)
                          IF DTT=.T.   &&如果所有製程的加工部門都改成跟表頭一樣的部門編號
                             REPLACE  F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE     
                             IF IIF(SEEK(E11.F01+E11.F11,'E07','E072'),E07.F98,.F.)=.T.
                                REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE                             
                             ENDIF                              
                          ENDIF   
                          REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                 
                          REPLACE F13 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
                       ENDIF   
                    ENDIF               
                 ENDIF                    
                 SELE E11
                 IF IIF(SEEK(E11.F11,'E00'),E00.F05,'')='3'                                     
                    REPLACE F07 WITH CEILING((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE)*E11.F06*(1+E11.F20/100))  &&應領數量跟已領量或已完工量無關
                 ELSE
                    IF IIF(SEEK(E11.F04,'B01'),B01.F39,'')='C'
                       REPLACE F07 WITH CEILING((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE)*E11.F06^(-1))  &&應領數量跟已領量或已完工量無關
                    ELSE
                       REPLACE F07 WITH ROUND((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE)*E11.F06*(1+E11.F20/100),4)  &&應領數量跟已領量或已完工量無關
                    ENDIF   
                 ENDIF    
                 IF F08>F07
                     REPLACE F08 WITH F07
                 ENDIF    
                 REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE-IIF(SEEK(E11.F04,'B01'),B01.F31,0)                 
                 SKIP
              ENDDO             
           ENDIF   
        ELSE       &&若只改加工部門或其他
           SELE E11
           SEEK E03.F03
           IF FOUND()
              DO WHILE E11.F01=E03.F03
                     SELE E16
                     SEEK E11.F01+E11.F04
                     IF FOUND()
                         IF DTT=.T.
                             REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
                        ELSE
                             IF IIF(SEEK(E11.F01+E11.F11,'E07','E072'),E07.F98,.F.)=.T.
                                  REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE                             
                             ENDIF
                        ENDIF   
                        REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                   ENDIF
                 SELE E11
                 SKIP
              ENDDO
           ENDIF                             
        ENDIF                      &&如果修改數量或交期之判別終           
        SELE E06
        SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
        IF FOUND()
           REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
           REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE-E03.F05                                   
           REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE       
           REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPLACE F15 WITH F04
        ENDIF
        SELECT E07  &&製程與其加工部門檔
        SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
        IF FOUND()
             DO WHILE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                     IF DTT=.T. OR F98=.T. &&若是全部製程要改成跟表頭一樣或是最後製程
                         REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
                     ENDIF
                     IF EUF=.T.    &&若有修改加工數量或交期
                        REPLACE F09 WITH CEILING((THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE-E03.F05)*E07.F99^IIF(IIF(SEEK(E07.F07,'E00'),E00.F05,'')='4',-1,1))
                        IF F09<=0 
                           DELETE
                        ELSE   
                           REPLACE F15 WITH F09
                        ENDIF   
                     ENDIF
                     SKIP
             ENDDO
        ENDIF
        SELE E03
        REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE        
        REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
        REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
        REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
        REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE
        REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE            
        REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE 
        REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE         
        REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                   
        REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE
        REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE   
        REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF15.VALUE            
     ELSE                                                            &&表身修改確認
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE)
           =MESSAGEBOX('製程不得空白!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF11.SETFOCUS
           RETURN
       ENDIF         
        IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072')=.F.
           =MESSAGEBOX('此組加工品無此製程',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF11.SETFOCUS
           RETURN
        ENDIF
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE<=0
           =MESSAGEBOX('單位用量不得小於等於零',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
           RETURN
        ENDIF        
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE<0
           =MESSAGEBOX('損耗率不得小於零',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF20.SETFOCUS
           RETURN
        ENDIF                
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100)*(E03.F04+E03.F15)<E11.F09
           =MESSAGEBOX('應領數量不得小於已耗用量',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
           RETURN
        ENDIF    
        IF E03.F11=.T.    &&如果此製令已確認
             DO CASE
                   CASE (THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE<>E11.F10 .OR. THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE<>E11.F06 .OR.;
                              THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE<>E11.F20) .AND. (VAL(E11.F18) % 2<>0 .AND. THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE % 2=0) &&如果數量與交期改變而且從廠內發料改成廠商自備
                               IF LEN(ALLTRIM(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072'),E07.F08,'')))=4
                                   =MESSAGEBOX('廠內加工之製程供料方式不得改為廠商自備!',0+48,'提示訊息視窗')
                                   THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.SETFOCUS
                                   RETURN
                               ELSE
                                   SELE E16
                                   SEEK E11.F01+E11.F04
                                   IF FOUND()
                                      SELECT E08    &&預期結餘量加回去
                                      SEEK E16.F02
                                      IF FOUND()
                                         REPLACE F20 WITH F20+E16.F04
                                      ELSE
                                         APPEND BLANK
                                         REPLACE F01 WITH E16.F03
                                         REPLACE F02 WITH E16.F02
                                         REPLACE F20 WITH E16.F04
                                      ENDIF
                                      SELECT E16
                                      DELETE 
                                   ENDIF
                               ENDIF   
                   CASE (THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE<>E11.F10 .OR. THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE<>E11.F06 .OR.;
                              THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE<>E11.F20) .AND. (VAL(E11.F18) % 2=0 .AND. THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE % 2<>0) &&如果數量與交期改變而且從廠商自備改成發料
                              SELECT  E16               &&新增領料計劃
                              APPEND BLANK
                              REPLACE  F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                              REPLACE  F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
                              REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
                              IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E00'),E00.F05,'')='3'                                 
                                 REPLACE  F04 WITH CEILING((E03.F04+E03.F15-E03.F05-F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100))
                              ELSE
                                 IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01'),B01.F39,'')='C'
                                    REPLACE  F04 WITH CEILING((E03.F04+E03.F15-E03.F05-F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE^(-1))
                                 ELSE
                                    REPLACE  F04 WITH ROUND((E03.F04+E03.F15-E03.F05-F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100),4)
                                 ENDIF  
                              ENDIF   
                              REPLACE  F06 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072'),E07.F08,'')
                              REPLACE  F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                              REPLACE  F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                              REPLACE  F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
                              REPLACE F13 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
                               SELECT E08    &&預期結餘量也要去減
                               SEEK E16.F02
                               IF FOUND()
                                  REPLACE F20 WITH F20+E16.F04*(-1)
                               ELSE
                                  APPEND BLANK
                                  REPLACE F01 WITH E16.F03
                                  REPLACE F02 WITH E16.F02
                                  REPLACE F20 WITH E16.F04*(-1)
                               ENDIF
                   CASE (THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE<>E11.F10 .OR. THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE<>E11.F06 .OR.;
                                THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE<>E11.F20) .AND. (VAL(E11.F18) = THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE ) &&如果數量與交期改變而且供料方式不變              
                                IF VAL(E11.F18) % 2<>0  &&若非廠商自備料
                                     SELE E16
                                     SEEK E11.F01+E11.F04
                                     IF FOUND()
                                        SELECT E08    &&預期結餘量先還原
                                        SEEK E16.F02
                                        IF FOUND()
                                           REPLACE F20 WITH F20+E16.F04
                                        ELSE
                                           APPEND BLANK
                                           REPLACE F01 WITH E16.F03
                                           REPLACE F02 WITH E16.F02
                                           REPLACE F20 WITH E16.F04
                                        ENDIF
                                         SELECT E16
                                         REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
                                         IF THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE<>E11.F06 .OR. THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE<>E11.F20
                                              IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E00'),E00.F05,'')='3'                                              
                                                 REPLACE  F04 WITH CEILING((E03.F04+E03.F15-E03.F05-E03.F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100))                                                 
                                              ELSE
                                                 IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01'),B01.F39,'')='C'
                                                    REPLACE  F04 WITH CEILING((E03.F04+E03.F15-E03.F05-E03.F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE^(-1))
                                                 ELSE
                                                    REPLACE  F04 WITH ROUND((E03.F04+E03.F15-E03.F05-E03.F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100),4)
                                                 ENDIF   
                                              ENDIF   
                                              IF F04<F05
                                                  REPLACE F05 WITH F04
                                              ENDIF    
                                         ENDIF   
                                         REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                                         REPLACE F13 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
                                         SELECT E08    &&預期結餘量也要去減
                                         SEEK E16.F02
                                         IF FOUND()
                                            REPLACE F20 WITH F20+E16.F04*(-1)
                                         ELSE
                                            APPEND BLANK
                                            REPLACE F01 WITH E16.F03
                                            REPLACE F02 WITH E16.F02
                                            REPLACE F20 WITH E16.F04*(-1)
                                         ENDIF
                                     ENDIF                                            
                                ENDIF
                   CASE (THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=E11.F10 .AND. THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=E11.F06 .AND.;
                              THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=E11.F20) .AND. (VAL(E11.F18) % 2<>0 .AND. THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE % 2=0) &&如果數量與交期不變而且從發料改成廠商自備
                               IF LEN(ALLTRIM(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072'),E07.F08,'')))=4
                                   =MESSAGEBOX('廠內加工之製程供料方式不得改為廠商自備!',0+48,'提示訊息視窗')
                                   THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.SETFOCUS
                                   RETURN
                               ELSE                              
                                  SELE E16
                                  SEEK E11.F01+E11.F04
                                  IF FOUND()
                                     SELECT E08    &&預期結餘量加回去
                                     SEEK E16.F02
                                     IF FOUND()
                                        REPLACE F20 WITH F20+E16.F04
                                     ELSE
                                        APPEND BLANK
                                        REPLACE F01 WITH E16.F03
                                        REPLACE F02 WITH E16.F02
                                        REPLACE F20 WITH E16.F04
                                     ENDIF
                                     SELECT E16
                                      DELETE 
                                  ENDIF
                               ENDIF   
                   CASE (THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=E11.F10 .AND. THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=E11.F06 .AND.;
                             THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=E11.F20) .AND. (VAL(E11.F18) % 2=0 .AND. THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE % 2<>0) &&如果數量與交期不變而且從廠商自備改成發料
                              SELE E16               &&新增領料計劃
                              APPEND BLANK
                              REPLACE  F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                              REPLACE  F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
                              REPLACE  F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
                              IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E00'),E00.F05,'')='3'
                                 REPLACE  F04 WITH CEILING((E03.F04+E03.F15-E03.F05-E03.F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100))
                              ELSE
                                 IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01'),B01.F39,'')='C'   
                                    REPLACE  F04 WITH CEILING((E03.F04+E03.F15-E03.F05-E03.F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE^(-1))
                                 ELSE
                                    REPLACE  F04 WITH ROUND((E03.F04+E03.F15-E03.F05-E03.F10)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100),4)
                                 ENDIF   
                              ENDIF    
                              REPLACE  F06 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E07','E072'),E07.F08,'')
                              REPLACE  F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                              REPLACE  F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                              REPLACE  F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
                              REPLACE F13 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))     
                              SELECT E08    &&預期結餘量也要去減
                               SEEK E16.F02
                               IF FOUND()
                                  REPLACE F20 WITH F20+E16.F04*(-1)
                               ELSE
                                  APPEND BLANK
                                  REPLACE F01 WITH E16.F03
                                  REPLACE F02 WITH E16.F02
                                  REPLACE F20 WITH E16.F04*(-1)
                               ENDIF
                   OTHERWISE
                              SELE E16
                              SEEK E11.F01+E11.F04
                              IF FOUND()
                                  REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
                                  REPLACE F13 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
                              ENDIF
                  ENDCASE
        ENDIF
        SELE E11
        REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
        REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE      
        IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'E00'),E00.F05,'')='3'  
           REPLACE F07 WITH CEILING(THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(E03.F04+E03.F15)*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100))
        ELSE
           IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE,'B01'),B01.F39,'')='C'  
              REPLACE F07 WITH CEILING((E03.F04+E03.F15)*THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE^(-1))
           ELSE
              REPLACE F07 WITH ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE*(E03.F04+E03.F15)*(1+THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE/100),4)
           ENDIF   
        ENDIF   
        IF F08>F07
            REPLACE F08 WITH F07
        ENDIF    
        REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
        REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
        REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
        REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE
        REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE        
        REPLACE F18 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VALUE))
        REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
     ENDIF           
     
 *      ELSE
*         DO file_impact
*          return   
*       ENDIF   
     RELEASE ALL LIKE BK*
     UNLOCK ALL
     THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ANS_BOTT.ENABLED=!E03.F11
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.OPTIONGROUP20.ENABLED=.F.              
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.        
      THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.T.        
      THISFORM.PAGEFRAME1.PAGE1.TXTF14.READONLY=.T.             
      THISFORM.PAGEFRAME1.PAGE2.TXTF04.READONLY=.T. 
      THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.T. 
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.      
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.      
      THISFORM.PAGEFRAME1.PAGE2.SPLY_TYPE.VISIBLE=.F.    
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1  
         THISFORM.grid2.ENABLED=.T.                         
         THISFORM.grid1.ENABLED=.T.     
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.RTG_BOTT.ENABLED=IIF(E03.F04+E03.F15=E03.F05,.F.,.T.)
      ELSE

         THISFORM.ISB_BOTT.ENABLED=.T.      
         THISFORM.grid2.ENABLED=.T.                       
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
            SELE E03
            DELE
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH               
         ENDIF  

      ENDIF       
      UNLOCK ALL

  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'E11'
            THISFORM.GRID2.RECORDSOURCE='E11'
            THISFORM.GRID2.CHILDORDER='E111'
     	    THISFORM.grid2.COLUMN1.CONTROLSOURCE='E11.F04'
      	    THISFORM.grid2.COLUMN2.CONTROLSOURCE='E11.F05'	   
	        THISFORM.grid2.COLUMN3.CONTROLSOURCE='E11.F10'
	        THISFORM.grid2.COLUMN4.CONTROLSOURCE="IIF(IIF(SEEK(E11.F04,'B01'),B01.F39,'')='C','1/'+ALLTRIM(STR(E11.F06)),TRANSFORM(E11.F06,'@R 9999999.999'))"
	        THISFORM.grid2.COLUMN5.CONTROLSOURCE='E11.F07'
  	        THISFORM.grid2.COLUMN6.CONTROLSOURCE='E00.F04'
       	    THISFORM.grid2.COLUMN7.CONTROLSOURCE="IIF(E11.F18='1','廠內發料',IIF(E11.F18='2','廠商自備','客戶提供'))"
	     ENDIF   
      ENDIF  
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC   
  PROCEDURE RTG_BOTT.CLICK
      PO_NO=E03.F03
      RTG_SEEK=CREATEOBJECT('RTG_SEEK')
      RTG_SEEK.SHOW
      FLG='0'
      AREA1='E03'      
      SELE E03
  ENDPROC
  PROCEDURE ISB_BOTT.CLICK
         TQTY=0         
         CHK_STR=''
         FTR_STR=''
         UKEF=''        
         SUB_CHG_SEEK=createobject("SUB_CHG_SEEK")  
         SUB_CHG_SEEK.SHOW                         
         AREA1='E03'
         SELE E11          
         IF TQTY=1
            REPLACE F15 WITH UKEF
            REPLACE F04 WITH CHK_STR
            REPLACE F05 WITH FTR_STR
            REPLACE F14 WITH 0
         ENDIF                  
         TQTY=0        
         CHK_STR=''         
         FTR_STR=''        
         UKEF=''         
  ENDPROC
  PROCEDURE ANS_BOTT.CLICK        &&製令用料確認程序
     IF MESSAGEBOX('是否確認資料無誤?',4+32+256,'請確認') = 6	        
        SELE E11
        SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
        IF FOUND()
           DO WHILE E11.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
              IF E11.F18<>'2'    &&若是該料不為廠商自備才做物料需求計算                 
                 SELE E16
                 APPEND BLANK
                 REPLACE F01 WITH E11.F01
                 REPLACE F02 WITH E11.F04
                 REPLACE F03 WITH E11.F10
                 REPLACE F04 WITH E11.F07
                 REPLACE F06 WITH IIF(SEEK(E11.F01+E11.F11,'E07','E072'),E07.F08,'')
                 REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 REPLACE F09 WITH E03.F01
                 REPLACE F12 WITH E11.F11
                 REPLACE F13 WITH E11.F18
                 SELECT E08    &&預期結餘量也要去減
                 SEEK E16.F02
                 IF FOUND()
                    REPLACE F20 WITH F20+E16.F04*(-1)
                 ELSE
                    APPEND BLANK
                    REPLACE F01 WITH E16.F03
                    REPLACE F02 WITH E16.F02
                    REPLACE F20 WITH E16.F04*(-1)
                 ENDIF
              ENDIF
              SELE E11
              REPLACE F14 WITH 0
              SKIP
           ENDDO
        ENDIF
        SELE E06
        SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
 
        IF FOUND()
           IF IIF(SEEK(E06.F02,'B01'),B01.F97,'')<>'Y'
              SELECT E08
              SEEK E06.F02
              IF FOUND()
                 REPLACE F20 WITH F20+E06.F04*(-1)
              ELSE
                 APPEND BLANK
                 REPLACE F01 WITH E06.F03
                 REPLACE F02 WITH E06.F02
                 REPLACE F20 WITH E06.F04*(-1)
              ENDIF
              SELECT E06
              DELETE 
           ELSE   
              REPLACE F09 WITH '1'
              REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')      
           ENDIF   
        ENDIF
        SELE E03
        REPLACE F11 WITH .T.
        REPLACE F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
        THIS.ENABLED=.F.
     ENDIF           
        IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
           SELE E03
           THISFORM.GRID1.SETFOCUS
        ELSE
           SELE E11
           THISFORM.GRID2.SETFOCUS
        ENDIF            

  ENDPROC  
enddefine    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK1=E03.F03
     LK2=E03.F01
     LK3=E03.F02
     LK4=E03.F12
     LK5=E03.F06
     LK6=E03.F07
     LK7=E03.F08
     LK8=E03.F04+E03.F15-E03.F05
     SELE E07.F06 PRO_ORD,;   &&製程順序 
          E07.F08 DPT,;         &&加工部門編號
          E07.F13 RMK,;       &&製程備註說明                         
          E07.F99 FQCY,;     &&單位加工次數
          E07.F09 TQCY,;     &&總加工次數
          E11.F11 PRO_NO,;   &&投入製程編號     
          E00.F04 PRO_NAME,;   &&製程名稱  
          E11.F04 MTRL,;   &&材料編號
          E11.F05 VRSN2,;   &&材料版本
          E11.F06 UNIT_QTY,;   &&單位用量
          E11.F07 SHD_QTY,;   &&應領數量
          E11.F15 BRAND,;   &&廠牌
          E11.F20 LSE,;                &&耗損率          
          E11.F16 REMARK,;   &&備註說明
          E11.F18 PVT,;       &&供料方式
          B01.F02 MTRL_NAME;  &&品名規格          
          FROM E11,E07,E00,B01 WHERE  E07.F01=LK1;
           AND E11.F01=LK1 AND E11.F11=E07.F07;
          AND E00.F01=E07.F07;
          AND B01.F01=E11.F04;
          ORDER BY E07.F06,E11.F04 INTO CURSOR E04_1 NOWAIT
     IF _tally >0          
          CREATE CURSOR E04_2;
          (DPT C(5),PRO_ORD C(3),FQCY N(7),TQCY N(9),PRO_NO C(4),RMK C(30),PRO_NAME C(10),MTRL C(43),MTRL_NO N(3),VRSN2 C(3),UNIT_QTY N(11,4),SHD_QTY N(11,4),BRAND C(20),LSE N(5,2),REMARK C(30),PVT C(1),MTRL_NAME C(20))
          INDE ON PRO_ORD+MTRL TAG E04_21
          SELE E04_1
          MTRNO=0
          GO TOP
          DO WHILE !EOF()
                 SELE E04_2
                 MTRNO=MTRNO+1
                 APPEND BLANK
                 REPLACE DPT WITH E04_1.DPT
                 REPLACE  PRO_ORD WITH E04_1.PRO_ORD
                 REPLACE RMK WITH E04_1.RMK
                 REPLACE  FQCY WITH E04_1.FQCY
                 REPLACE TQCY WITH E04_1.TQCY
                 REPL PRO_NO  WITH E04_1.PRO_NO
                 REPLACE  PRO_NAME WITH E04_1.PRO_NAME
                 REPLACE MTRL_NO WITH MTRNO
                 REPLACE  MTRL WITH E04_1.MTRL
                 REPLACE  VRSN2 WITH E04_1.VRSN2
                 REPLACE  UNIT_QTY WITH E04_1.UNIT_QTY
                 REPLACE  SHD_QTY WITH E04_1.SHD_QTY
                 REPLACE  SHD_QTY WITH E04_1.SHD_QTY
                 REPLACE  REMARK WITH E04_1.REMARK
                 REPLACE BRAND WITH E04_1.BRAND
                 REPLACE LSE WITH E04_1.LSE
                 REPLACE PVT WITH E04_1.PVT
                 REPLACE  MTRL_NAME WITH E04_1.MTRL_NAME
                 SELE E04_1
                 SKIP
                 IF E04_2.PRO_ORD<> E04_1.PRO_ORD
                    MTRNO=0
                 ENDIF   
          ENDDO
         SELE E04_1
         USE 
         SELE E07.F06,E07.F07,E07.F08,E07.F99,E07.F09,E07.F13,E00.F04 FROM E07,E00 WHERE E00.F01=E07.F07 AND E07.F01=LK1 AND E07.F07 NOT IN (SELE PRO_NO FROM E04_2) INTO CURSOR E04_3
         IF _TALLY>0
            SELE E04_3
            GO TOP
            DO WHILE !EOF()
               SELE E04_2
               APPEND BLANK
               REPLACE DPT WITH E04_3.F08
               REPL PRO_ORD WITH E04_3.F06
               REPL PRO_NO WITH E04_3.F07
               REPL RMK WITH E04_3.F13           
               REPL FQCY WITH E04_3.F99
               REPLACE TQCY WITH E04_3.F09
               REPL PRO_NAME WITH E04_3.F04
               SELE E04_3
               SKIP
            ENDDO
            SELE E04_3
            USE
         ENDIF         
         SELE E04_2
         SET ORDER TO 1
         GO TOP
*!*	        REPORT FORM ALLTRIM(INT_116)+'E04' PREVIEW
        report form ALLTRIM(INT_116)+'E04' to print  prompt  
     ELSE
         =MESSAGEBOX('本製令已全部完工!無法列印!',0+48,'提示訊息視窗')   
     ENDIF  
ENDPROC
************************************************特殊輸入欄位的設定----代用料號
DEFINE CLASS TXTF07 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02,F97 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE  LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02,F97 FROM B01 INTO CURSOR MTR ORDER BY F01  
       ENDIF        
       IF _TALLY>0
          MAN_SEEK=createobject("MTR_SEEK")  
          MAN_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'     
       ENDIF    
    ENDIF  
    THISFORM.LBLF071.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')   
    THISFORM.TXTF08.READONLY=IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F97,'')='Y',.F.,.T.)   
  ENDPROC
ENDDEFINE
************************************************特殊輸入欄位的設定----製程輸入
DEFINE CLASS TXTF11 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=4
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT E07.F07,E00.F04 FROM E07,E00 INTO CURSOR RTE ORDER BY E07.F06 WHERE  LEFT(E07.F07,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND E07.F01=E03.F03 .AND. E00.F01=E07.F07
       ELSE
          SELECT E07.F07,E00.F04 FROM E07,E00 INTO CURSOR RTE ORDER BY E07.F06 WHERE E07.F01=E03.F03 AND E00.F01=E07.F07
       ENDIF        
       IF _TALLY>0
          RTE_SEEK=createobject("RTE_SEEK")  
          RTE_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'     
       ENDIF    
    ENDIF  
    THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=IIF(SEEK(THIS.VALUE,'E00'),E00.F04,'')   
  ENDPROC
ENDDEFINE
************************************************特殊輸入欄位的設定----表身料號
DEFINE CLASS TXTF04 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02,F97 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE  LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02,F97 FROM B01 INTO CURSOR MTR ORDER BY F01  
       ENDIF        
       IF _TALLY>0
          MAN_SEEK=createobject("MTR_SEEK")  
          MAN_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'     
       ENDIF    
    ENDIF  
    THISFORM.PAGEFRAME1.PAGE2.LBLF041.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')   
    THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F97,'')='Y',.F.,.T.)  
    THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE-IIF(SEEK(THIS.VALUE,'B01'),B01.F31,0)
    THISFORM.PAGEFRAME1.PAGE2.TXTF06.LEFT=INT_015*IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F39,'')='C',399,379)  
    THISFORM.PAGEFRAME1.PAGE2.TXTF06.WIDTH=INT_015*IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F39,'')='C',65,100)  
    THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=VAL(IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F39,'')='C',IIF(SEEK(E03.F01,'C20'),C20.F03,'1'),'1'))
    THISFORM.PAGEFRAME1.PAGE2.TXTF06.INPUTMASK=IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F39,'')='C','999999','999999.9999')  
    THISFORM.PAGEFRAME1.PAGE2.LBLF20.VISIBLE=IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F39,'')='B',.T.,.F.)  
    THISFORM.PAGEFRAME1.PAGE2.TXTF20.VISIBLE=IIF(IIF(SEEK(THIS.VALUE,'B01'),B01.F39,'')='B',.T.,.F.)    
  ENDPROC
ENDDEFINE

***************************************************特殊欄位------------------加工部門
DEFINE CLASS TXTF14 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F05='*'
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE  F05='*'
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=CREATEOBJECT("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF   
       IF AREA1='E03'
          THISFORM.PAGEFRAME1.PAGE1.LBLF141.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')  
       ELSE
          THISFORM.LBLF081.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')  
       ENDIF   
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------表頭加工品號
DEFINE CLASS TXTF01 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       DO CASE
          CASE AT('?',ALLTRIM(THIS.VALUE))>1 AND EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)                 
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE LEFT(C05.F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F02,F03 INTO CURSOR BHD       
          CASE AT('?',ALLTRIM(THIS.VALUE))>1 AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)  
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE C05.F01=LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,10) AND LEFT(C05.F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F02,F03 INTO CURSOR BHD       
          CASE AT('?',ALLTRIM(THIS.VALUE))=1 AND EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F02,F03 INTO CURSOR BHD          
          CASE AT('?',ALLTRIM(THIS.VALUE))=1 AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE) 
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE C05.F01=LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,10) AND F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F02,F03 INTO CURSOR BHD                                                          
       ENDCASE               
       IF _TALLY>0
          BOM_HEAD=createobject("BOM_HEAD")  
          BOM_HEAD.SHOW    
          THIS.VALUE=FLG
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=CHK_STR
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=UKEF
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=QTY
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=FTR_STR
          THIS.REFRESH
          FLG='0'     
          CHK_STR=''
       ENDIF    
    ELSE
          
    ENDIF  
    THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=IIF(SEEK(THIS.VALUE,'F01'),F01.F02,'')
    THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'F01'),F01.F06,'')
    THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'F01'),F01.F07,'')
    THISFORM.PAGEFRAME1.PAGE1.LBLF141.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE,'A14'),A14.F02,'')
    THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')
    THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE-IIF(SEEK(THIS.VALUE,'B01'),B01.F31,0)
    THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE,'C01'),C01.F04,'')
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------子製令號碼
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=12
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       DO CASE
          CASE AT('?',ALLTRIM(THIS.VALUE))>1 AND EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)          
               SELECT F01,F02,F03,F04,F06 FROM C05 WHERE LEFT(C05.F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F01,F03 INTO CURSOR MODER
          CASE AT('?',ALLTRIM(THIS.VALUE))>1 AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)          
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE C05.F02=LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,10) AND LEFT(C05.F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F01,F03 INTO CURSOR MODER
          CASE AT('?',ALLTRIM(THIS.VALUE))=1 AND EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F01,F03 INTO CURSOR MODER
          CASE AT('?',ALLTRIM(THIS.VALUE))=1 AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
               SELECT F02,F01,F03,F04,F06 FROM C05 WHERE C05.F02=LEFT(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,10) AND F01+F02=ANY(SELECT F03+F04 FROM C04 WHERE F05-F11>0) AND F02=ANY(SELECT F01 FROM F01 WHERE F05=.T.) ORDER BY F02,F03 INTO CURSOR MODER                                                         
       ENDCASE               
       IF _TALLY>0
          MODER_SEEK=createobject("MODER_SEEK")  
          MODER_SEEK.SHOW    
          THIS.VALUE=FLG
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=CHK_STR
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=UKEF
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=QTY
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=FTR_STR
          FLG='0'     
          CHK_STR=''
          UKEF=''
          QTY=0
          FTR_STR=''

       ENDIF
    ELSE
                
    ENDIF  
    THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'F01'),F01.F02,'')
    THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'F01'),F01.F06,'')
    THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'F01'),F01.F07,'')
    THISFORM.PAGEFRAME1.PAGE1.LBLF141.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE,'A14'),A14.F02,'')
    THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')
    THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE-IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'B01'),B01.F31,0)
    THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE,'C01'),C01.F04,'')
  ENDPROC
ENDDEFINE
*********************************************************************代用料代換畫面
define class SUB_CHG_SEEK as form
  autocenter=.t.
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*245
  WIDTH=INT_015*580
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='SUB_CHG_SEEK'
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;    
      LEFT=INT_015*3,;
      WIDTH=INT_015*573,;
      HEIGHT=INT_015*240
  add object GRID1 as GRID with;          
      AUTOCENTER=.T.,;
      TOP=INT_015*2,;
      LEFT=INT_015*10,;
      WIDTH=INT_015*563,;      
      HEIGHT=INT_015*205,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=4,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
  add object cmnd1 as commandbutton with;
      LEFT=INT_015*213,;
      TOP=INT_015*210,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<S.選取',;
      TOOLTIPTEXT='選取此筆資料更換!快速鍵->ALT+C'
      name='cmnd1'      
  add object cmnd2 as commandbutton with;
      LEFT=INT_015*263,;
      TOP=INT_015*210,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<C.取消',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+C'
      name='cmnd2'
      procedure init        
        AREA1='F06' 
        SELE F06
        SET RELA TO F07 INTO B01        
        SET FILTER TO F01+F02+F03+F04+F05=E03.F01+E03.F02+E11.F11+E11.F04+E11.F05
         SEEK E03.F01+E03.F02+E11.F11+E11.F04+E11.F05
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='F06'        
         thisform.setall('readonly',.t.,'textbox')
         THISFORM.caption='更換代用料號               原材料為:'+E11.F04         
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='代用料號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='F06.F07'         
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01.F02'                           
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*170	        
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='版本'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='F06.F08'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*30
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='使用廠牌'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='F06.F06'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*224        
         THISFORM.GRID1.SETFOCUS
         FCH='GRID1'

         THISFORM.CMND2.ENABLED=.T.                     
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XColIndex     

         FCH=THISFORM.ACTIVECONTROL.NAME 
      ENDPROC 
      PROCEDURE CMND1.CLICK
         TQTY=1
         CHK_STR=F06.F07
         FTR_STR=F06.F08
         UKEF=F06.F06
        
         THISFORM.CMND2.CLICK
      ENDPROC
      procedure cmnd2.click
         SELE F06
         SET RELA OFF INTO B01
         SET FILTER TO
         thisform.release         
      endproc    

enddefine            
**********************************************************子製令搜尋畫面
define class MODER_SEEK as form
  autocenter=.t.
  caption='可排程製令一覽表'
  fontsize=INT_015*9
  HEIGHT=INT_015*420
  WIDTH=INT_015*680
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='MODER_SEEK'
  add object GRDMO as GRID with;          
      AUTOCENTER=.T.,;
      top=0,;
      WIDTH=INT_015*680,;      
      HEIGHT=INT_015*350,;  
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=6,;            
      RECORDSOURCE='MODER',;      
      NAME='GRDMO',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;             
      COLUMN4.NAME='COLUMN4',;             
      COLUMN5.NAME='COLUMN5',;             
      COLUMN6.NAME='COLUMN6'           
  add object cmnd1 as commandbutton with;
      autosize=.t.,;
      left=INT_015*20,;    
      HEIGHT=INT_015*25,;   
      top=INT_015*370,;  
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      caption='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      name='cmnd1'
  add object cmnd2 as commandbutton with;
      autosize=.t.,;
      left=INT_015*130,;
      top=INT_015*370,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;      
      caption='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      name='cmnd2'
      procedure init 
         THISFORM.GRDMO.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRDMO.SETALL('FONTSIZE',INT_015*9,'HEADER')      
         THISFORM.GRDMO.COLUMN1.HEADER1.CAPTION='訂單號碼'
         THISFORM.GRDMO.COLUMN1.WIDTH=INT_015*80
         THISFORM.GRDMO.COLUMN1.CONTROLSOURCE='MODER.F01'
         THISFORM.GRDMO.COLUMN2.HEADER1.CAPTION='料品編號'
         THISFORM.GRDMO.COLUMN2.WIDTH=INT_015*149
         THISFORM.GRDMO.COLUMN2.CONTROLSOURCE='MODER.F02'
         THISFORM.GRDMO.COLUMN3.HEADER1.CAPTION='客戶編號'
         THISFORM.GRDMO.COLUMN3.WIDTH=INT_015*50
         THISFORM.GRDMO.COLUMN3.CONTROLSOURCE='MODER.F06'         
         THISFORM.GRDMO.COLUMN4.HEADER1.CAPTION='客戶簡稱'
         THISFORM.GRDMO.COLUMN4.WIDTH=INT_015*50
         THISFORM.GRDMO.COLUMN4.CONTROLSOURCE="IIF(SEEK(MODER.F06,'C01'),C01.F05,'')"
         THISFORM.GRDMO.COLUMN5.HEADER1.CAPTION='出貨日期'
         THISFORM.GRDMO.COLUMN5.WIDTH=INT_015*70
         THISFORM.GRDMO.COLUMN5.CONTROLSOURCE='MODER.F03'         
         THISFORM.GRDMO.COLUMN6.HEADER1.CAPTION='出貨數量'
         THISFORM.GRDMO.COLUMN6.WIDTH=INT_015*100
         THISFORM.GRDMO.COLUMN6.CONTROLSOURCE='MODER.F04'                                       
      ENDPROC
      PROC GRDMO.AFTERROWCOLCHANGE
       LPARAMETERS XColIndex
       FCH='GRDMO'
      ENDPROC 
      procedure cmnd1.click                               
*          FLG=SUBSTR(MODER.F03,3,8)+PADL(ALLTRIM(STR(IIF(SEEK(MODER.F03,'C03','C031'),C03.F11,0)+1)),2,'0')+CHR(64+VAL(PADL(ALLTRIM(STR(MODER.F14+1)),2,'0')))
          FLG=MODER.F01
          CHK_STR=MODER.F02          
          FTR_STR=MODER.F06
          QTY=MODER.F04
          UKEF=MODER.F03      
          SELE MODER
          USE     
          THISFORM.RELEASE 
      endproc
      procedure cmnd2.click
          FLG=''   
          CHK_STR=''
          QTY=0
          FTR_STR=''
          UKEF=DATE()
          SELE MODER
          USE               
          thisform.release
      endproc 
enddefine    
**********************************************************BOM表頭搜尋畫面
define class BOM_HEAD as form
  autocenter=.t.
  caption='出貨計劃'
  fontsize=INT_015*9
  HEIGHT=INT_015*280
  WIDTH=INT_015*500
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='BOM_HEAD'
  add object GRDF01 as GRID with;          
      AUTOCENTER=.T.,;
      top=0,;
      WIDTH=INT_015*500,;      
      HEIGHT=INT_015*250,;  
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=6,;            
      RECORDSOURCE='BHD',;      
      NAME='GRDF01',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6'
  add object cmnd1 as commandbutton with;
      autosize=.t.,;
      left=INT_015*20,;    
      HEIGHT=INT_015*25,;   
      top=INT_015*252,;  
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      caption='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      name='cmnd1'
  add object cmnd2 as commandbutton with;
      autosize=.t.,;
      left=INT_015*130,;
      top=INT_015*252,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;      
      caption='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      name='cmnd2'
      procedure init 
         THISFORM.GRDF01.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRDF01.SETALL('FONTSIZE',INT_015*9,'HEADER')      
         THISFORM.GRDF01.COLUMN1.HEADER1.CAPTION='料      號'
         THISFORM.GRDF01.COLUMN1.WIDTH=INT_015*149
         THISFORM.GRDF01.COLUMN1.CONTROLSOURCE='BHD.F02'
         THISFORM.GRDF01.COLUMN2.HEADER1.CAPTION='客戶編號'
         THISFORM.GRDF01.COLUMN2.WIDTH=INT_015*50
         THISFORM.GRDF01.COLUMN2.CONTROLSOURCE='BHD.F06'         
         THISFORM.GRDF01.COLUMN3.HEADER1.CAPTION='客戶簡稱'
         THISFORM.GRDF01.COLUMN3.WIDTH=INT_015*50
         THISFORM.GRDF01.COLUMN3.CONTROLSOURCE="IIF(SEEK(BHD.F06,'C01'),C01.F05,'')"            
         THISFORM.GRDF01.COLUMN4.HEADER1.CAPTION='訂單號碼'
         THISFORM.GRDF01.COLUMN4.WIDTH=INT_015*80
         THISFORM.GRDF01.COLUMN4.CONTROLSOURCE='BHD.F01'
         THISFORM.GRDF01.COLUMN5.HEADER1.CAPTION='交      期'
         THISFORM.GRDF01.COLUMN5.WIDTH=INT_015*60         
         THISFORM.GRDF01.COLUMN5.CONTROLSOURCE='BHD.F03'
         THISFORM.GRDF01.COLUMN6.HEADER1.CAPTION='出貨數量'
         THISFORM.GRDF01.COLUMN6.WIDTH=100
         THISFORM.GRDF01.COLUMN6.CONTROLSOURCE='BHD.F04'                  
      ENDPROC
      PROC GRDF01.AFTERROWCOLCHANGE
       LPARAMETERS XColIndex
       FLG=BHD.F02
       CHK_STR=BHD.F01
       FTR_STR=BHD.F06
       UKEF=BHD.F03
       QTY=BHD.F04
      ENDPROC 
      procedure cmnd1.click                               
          SELE BHD
          USE     
          THISFORM.RELEASE 
      endproc
      procedure cmnd2.click
          FLG=''   
          CHK_STR=''
          QTY=0
          SELE BHD
          USE               
          thisform.release
      endproc 
enddefine    
***************************************************特殊輸入欄位設定-----------客戶
DEFINE CLASS TXTF08 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          IF EMPTY(A02.F12)
             SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) 
          ELSE
             SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
          ENDIF
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F04,'')  
  ENDPROC
ENDDEFINE    
*********************************************************************供料方式
DEFINE CLASS SPLY_TYPE AS COMBOBOX
  LEFT=INT_015*65
  TOP=INT_015*103
  HEIGHT=INT_015*25
  WIDTH=INT_015*80
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  ROWSOURCETYPE=1
  VALUE=1
  STYLE=2
  NAME='SPLY_TYPE'
  PROCEDURE INIT
     WITH THIS 
          .ADDITEM('廠內發料')
          .ADDITEM('廠商自備')          
          .ADDITEM('客戶提供')          
     ENDWITH   
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
     THISFORM.PAGEFRAME1.PAGE2.LBLF181.CAPTION=THIS.DISPLAYVALUE
     
  ENDPROC
ENDDEFINE  
*********************************************************************製程加工部門更換或是製程備註說明
define class RTG_SEEK as form
  autocenter=.t.
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*390
  WIDTH=INT_015*550
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='RTG_SEEK'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      LEFT=INT_015*3,;
      WIDTH=INT_015*545,;
      HEIGHT=INT_015*85
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;    
      LEFT=INT_015*3,;
      TOP=INT_015*87,;
      WIDTH=INT_015*545,;
      HEIGHT=INT_015*265
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      LEFT=INT_015*3,;
      TOP=INT_015*354,;
      WIDTH=INT_015*545,;
      HEIGHT=INT_015*35    
  ADD OBJECT cmdgroup as cmdgroup with;      
      TOP=INT_015*319,;
      LEFT=INT_015*10
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      TOP=INT_015*355,;
      LEFT=INT_015*10
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      VISIBLE=.F.    
  ADD OBJECT LBLF07 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*5,;
      WIDTH=INT_015*50,;
      HEIGHT=INT_015*25,;
      CAPTION='製程編號'
  ADD OBJECT LBLF06 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*5,;
      WIDTH=INT_015*50,;
      HEIGHT=INT_015*25,;
      CAPTION='製程順序'      
  ADD OBJECT LBLF071 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*96,;
      HEIGHT=INT_015*25,;
      AUTOSIZE=.T.
  ADD OBJECT LBLF08 AS LABEL WITH;
      TOP=INT_015*58,;
      LEFT=INT_015*5,;
      WIDTH=INT_015*50,;
      HEIGHT=INT_015*25,;
      CAPTION='加工部門'
  ADD OBJECT LBLF081 AS LABEL WITH;
      TOP=INT_015*58,;
      LEFT=INT_015*106,;
      WIDTH=INT_015*50,;
      HEIGHT=INT_015*25,;
      AUTOSIZE=.T.
  ADD OBJECT LBLF13 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*185,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      CAPTION='製程備註說明'            
  ADD OBJECT LBLF99 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*185,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      CAPTION='每組加工基數'         
  ADD OBJECT LBLF991 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*266,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      CAPTION='1/'                         
  ADD OBJECT LBLF09 AS LABEL WITH;
      TOP=INT_015*58,;
      LEFT=INT_015*185,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      CAPTION='剩餘加工次數'      
  ADD OBJECT LBLF091 AS LABEL WITH;
      TOP=INT_015*58,;
      LEFT=INT_015*266,;
      HEIGHT=INT_015*25,;
      AUTOSIZE=.T.
      CAPTION=''            
  ADD OBJECT LBLF04 AS LABEL WITH;
      TOP=INT_015*365,;
      LEFT=INT_015*290,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      CAPTION='安全資料'      
  ADD OBJECT LBLF041 AS LABEL WITH;
      TOP=INT_015*365,;
      LEFT=INT_015*341,;
      HEIGHT=INT_015*25,;
      AUTOSIZE=.T.
      CAPTION=''                  
  ADD OBJECT LBLRTG AS LABEL WITH;
      TOP=INT_015*328,;
      LEFT=INT_015*290,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      CAPTION='總製程數'      
  ADD OBJECT LBLRTG1 AS LABEL WITH;
      TOP=INT_015*328,;
      LEFT=INT_015*341,;
      HEIGHT=INT_015*25,;
      AUTOSIZE=.T.
      CAPTION=''                        
  ADD OBJECT TXTF07 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*35,;
      HEIGHT=INT_015*25,;
      NAME='TXTF07'
  ADD OBJECT TXTF06 AS TEXTBOX WITH;
      TOP=INT_015*29,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*30,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=3,;
      NAME='TXTF06'            
  ADD OBJECT TXTF08 AS TXTF14 WITH;
      TOP=INT_015*54,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*45,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=5,;
      NAME='TXTF08'      
  ADD OBJECT TXTF13 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*266,;
      WIDTH=INT_015*180,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=30,;
      NAME='TXTF13'      
  ADD OBJECT TXTF99 AS TEXTBOX WITH;
      TOP=INT_015*29,;
      LEFT=INT_015*266,;
      WIDTH=INT_015*65,;
      HEIGHT=INT_015*25,;
      INPUTMASK='9999999',;
      NAME='TXTF99'            
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*55,;
      LEFT=INT_015*330                
  add object GRID1 as GRID with;          
      AUTOCENTER=.T.,;
      LEFT=INT_015*10,;
      TOP=INT_015*91,;
      WIDTH=INT_015*530,;      
      HEIGHT=INT_015*230,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=8,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7',;      
      COLUMN8.NAME='COLUMN8'      
  add object cmnd2 as commandbutton with;
      LEFT=INT_015*141,;
      TOP=INT_015*359,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<X.離開',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+X'
      name='cmnd2'
      procedure init 
          THISFORM.Caption='製程加工部門與說明設定           完成品號:'+E03.F01+'  '+'版次:'+E03.F02+SPACE(8)+'未完工量:'+ALLTRIM(STR(E03.F04+E03.F15-E03.F05))
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX') 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')          
         AREA1='E07' 
         SELE E07
         SET FILTER TO F01=PO_NO
         SET RELA TO F07 INTO E00
         SET RELA TO F08 INTO A14 ADDI
         SEEK PO_NO
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='E07'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.PNT_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.ESC_BOTT.VISIBLE=.F.
 *        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
*         THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.         
         THISFORM.SHRGROUP.VISIBLE=.F.
         THISFORM.SHRGROUP.ENABLED=.F.         
         thisform.setall('readonly',.t.,'textbox')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='製程編號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*48
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='E07.F07'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='製程名稱'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE="E00.F04"
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='順序'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE="E07.F06"
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*25                 
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='部門編號'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='E07.F08'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE="A14.F02"
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60         
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='加工基數'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE="IIF(E00.F05='4','1/','')+ALLTRIM(STR(E07.F99))"
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*60                     
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='剩餘次數'
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE="E07.F09"
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*60            
         THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='製程備註說明'
         THISFORM.GRID1.COLUMN8.CONTROLSOURCE="E07.F13"
         THISFORM.LBLRTG1.CAPTION=ALLTRIM(STR(RTG_NB))
         THISFORM.GRID1.COLUMN8.WIDTH=INT_015*150      
         THISFORM.GRID1.SETFOCUS
         FCH='GRID1'
         IF THISFORM.GRID1.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.            
            THISFORM.LBLF071.CAPTION=''
            THISFORM.LBLF081.CAPTION=''
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(F15=0,.F.,.T.) .AND. IIF(E07.F10>0,.F.,.T.)
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(F15=0,.F.,.T.) .AND. IIF(E07.F10>0,.F.,.T.)
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(E03.F13>0,.F.,.T.)  
         ENDIF
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XColIndex
         THISFORM.TXTF07.VALUE=E07.F07
         THISFORM.TXTF06.VALUE=E07.F06         
         THISFORM.TXTF08.VALUE=E07.F08
         THISFORM.TXTF99.VALUE=E07.F99       
         THISFORM.TXTF99.LEFT=INT_015*266+IIF(E00.F05='4',20,0)  
         THISFORM.LBLF071.CAPTION=E00.F04
         THISFORM.LBLF081.CAPTION=A14.F02
         THISFORM.LBLF091.CAPTION=TRANSFORM(E07.F09,'@R 99999999999')
         THISFORM.TXTF13.VALUE=E07.F13
         THISFORM.LBLF041.CAPTION=E07.F04        
         FCH=THISFORM.ACTIVECONTROL.NAME 
         IF THIS.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.            
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.         
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(E07.F15=0,.F.,.T.) .AND. IIF(E07.F10>0,.F.,.T.)
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(E07.F15=0,.F.,.T.)   .AND. IIF(E07.F10>0,.F.,.T.)                                    
         ENDIF                     
      ENDPROC 
      procedure cmnd2.click
         SELE E07
         SET ORDER TO E072   && F01+F07+F08         
         HJ=''
         EJ=''
         IF E03.F11=.T.   &&如果製令已確認
              SELECT E16
              SEEK E03.F03
              IF FOUND()
                   DO WHILE E16.F01=E03.F03
                          SELECT E07
                          SEEK E16.F01+E16.F12
                          IF !FOUND()
                               HJ=E16.F02
                               EJ=E16.F12
                          ENDIF
                          SELECT E16
                          SKIP
                   ENDDO
              ENDIF
         ELSE                   &&   若製令尚未確認
             SELECT E11
             SEEK E03.F03
             IF FOUND()
                 DO WHILE E11.F01=E03.F03
                        SELECT E07
                        SEEK E11.F01+E11.F11
                        IF !FOUND()
                            HJ=E11.F04
                            EJ=E11.F11
                        ENDIF    
                        SELECT E11
                        SKIP
                 ENDDO
             ENDIF
         ENDIF    
         IF !EMPTY(HJ)
             =MESSAGEBOX('料號:'+ALLTRIM(HJ)+'之投入製程'+EJ+ALLTRIM(IIF(SEEK(EJ,'E00'),E00.F04,''))+'未建立在表頭中,或是請於表身先做投入製程修改',0+48,'警告訊息視窗')
*!*	             SELECT E07 
*!*	             SET ORDER TO E071   && F01+F06
*!*	             THISFORM.GRID1.SETFOCUS
*!*	             RETURN                          
         ENDIF
         SELECT E07
         SET RELATION OFF INTO E00
         SET RELATION OFF INTO A14
         SET FILTER TO            
         SET ORDER TO E071               
         thisform.release         
      endproc    
      PROC ORPGROUP.NEW_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.      
           THISFORM.GRID1.ENABLED=.F.
           SELECT RECNO() FROM E07 WHERE E07.F01=PO_NO INTO ARRAY BK1 ORDER BY E07.F01,E07.F06
           JJ1=''
           IF _TALLY>0         
               FOR I= 1 TO ALEN(BK1)
                   JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
               ENDFOR    
               KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')           
               RLOCK(KK1,'E07')
               LL1=RLOCK(KK1,'E07')
           ELSE
               LL1=.T.
           ENDIF                                                   
           IF LL1=.T.
              THISFORM.SetAll('READONLY',.F.,'TEXTBOX')
*              THISFORM.TXTF07.READONLY=.F.
               THISFORM.TXTF07.VALUE=''
              THISFORM.LBLF071.CAPTION=''               
               THISFORM.TXTF06.VALUE=PADL(ALLTRIM(STR(RTG_NB+1)),3,'0')
               THISFORM.TXTF99.VALUE=1               
              THISFORM.TXTF08.READONLY=.F.
              THISFORM.TXTF08.VALUE=E03.F14
              THISFORM.LBLF081.CAPTION=IIF(SEEK(E03.F14,'A14'),A14.F02,'')   
              THISFORM.LBLF091.CAPTION='0'              
               THISFORM.TXTF13.VALUE=''                       
              THISFORM.TXTF07.SETFOCUS
          ELSE  
              DO file_impact
              THISFORM.GRID1.SETFOCUS
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK                           
          ENDIF
      ENDPROC      
      PROC ORPGROUP.EDIT_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.      
           THISFORM.GRID1.ENABLED=.F.           
           SELECT RECNO() FROM E07 WHERE E07.F01=PO_NO INTO ARRAY BK1 ORDER BY E07.F01,E07.F06
           JJ1=''
           IF _TALLY>0         
               FOR I= 1 TO ALEN(BK1)
                   JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
               ENDFOR    
               KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')           
               RLOCK(KK1,'E07')
               LL1=RLOCK(KK1,'E07')
           ELSE
               LL1=.T.
           ENDIF                                        
           IF LL1=.T.
              THISFORM.TXTF07.READONLY=.T.
              THISFORM.TXTF08.READONLY=.F.
              THISFORM.TXTF06.SETFOCUS
           ELSE              
              DO file_impact
              THISFORM.GRID1.SETFOCUS
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK               
           ENDIF                 
      ENDPROC
      PROCEDURE ORPGROUP.DEL_BOTT.CLICK
            IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6                          
                     SELECT RECNO() FROM E07 WHERE E07.F01=PO_NO INTO ARRAY BK1 ORDER BY E07.F01,E07.F06
                     JJ1=''
                     IF _TALLY>0         
                         FOR I= 1 TO ALEN(BK1)
                             JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                         ENDFOR    
                         KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')           
                         RLOCK(KK1,'E07')
                         LL1=RLOCK(KK1,'E07')
                     ELSE
                         LL1=.T.
                     ENDIF                             
                     IF LL1=.T.                 
                          SELECT E07            
                          H=RTG_NB-VAL(E07.F06)          
                          T=VAL(F06)+1       
                          DELETE 
                          FOR I=1 TO H
                                  SEEK PO_NO+PADL(ALLTRIM(STR(T)),3,'0')
                                  REPLACE F06 WITH PADL(ALLTRIM(STR(VAL(F06)-1)),3,'0')    
                                  IF VAL(F06)=RTG_NB
                                     IF F08<>E03.F14
                                        =MESSAGEBOX('製程最後加工部門必須等於製令完工部門!',0+48,'提示訊息視窗')
                                        REPLACE F08 WITH E03.F14
                                     ENDIF                                            
                                     REPLACE F98 WITH .T.
                                  ELSE     
                                     REPLACE F98 WITH  .F. 
                                  ENDIF    
                                   T=T+1          
                          ENDFOR              
                          RTG_NB=RTG_NB-1
                          THISFORM.LBLRTG1.CAPTION=ALLTRIM(STR(RTG_NB))
                      ELSE
                           DO file_impact
                      ENDIF  
                 UNLOCK ALL
                 RELEASE ALL LIKE BK*                                  
            ENDIF            
            THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK
                 IF SEEK(PO_NO+THISFORM.TXTF07.VALUE,'E07','E072')
                     =MESSAGEBOX('製程重覆!',0+48,'提示訊息視窗')
                     THISFORM.TXTF07.SETFOCUS
                     RETURN
                 ENDIF
                 IF SEEK(THISFORM.TXTF08.VALUE,'A14')=.F.
                      =MESSAGEBOX('無此加工部門編號',0+48,'請修正成正確部門編號')
                      THISFORM.TXTF08.SETFOCUS
                      RETURN
                  ENDIF    
                  IF VAL(THISFORM.TXTF06.VALUE)=0
                       =MESSAGEBOX('製程順序必須為阿拉伯數字,且必須大於 0!',0+48,'提示訊息視窗')
                       THISFORM.TXTF06.SETFOCUS
                       RETURN
                   ENDIF    
                  IF VAL(THISFORM.TXTF06.VALUE)>RTG_NB+1
                       =MESSAGEBOX('此數字,不得大於 '+ALLTRIM(STR(RTG_NB+1)),0+48,'提示訊息視窗')
                       THISFORM.TXTF06.SETFOCUS
                       RETURN
                   ENDIF                   
                   K=PADL(ALLTRIM(STR(VAL(THISFORM.TXTF06.VALUE))),3,'0')
                   SELECT E07
                   SEEK PO_NO+PADL(ALLTRIM(STR((RTG_NB))),3,'0')
                   REPLACE F98 WITH .F.
                   APPEND BLANK
                   REPLACE F01 WITH PO_NO
                   REPLACE F02 WITH E03.F01
                   REPLACE F03 WITH E03.F02
                   REPLACE F06 WITH PADL(ALLTRIM(STR(RTG_NB+1)),3,'0')
                   REPLACE F07 WITH THISFORM.TXTF07.VALUE
                   REPLACE F08 WITH THISFORM.TXTF08.VALUE
                   REPLACE F98 WITH .T.
                   REPLACE F99 WITH THISFORM.TXTF99.VALUE
                   REPLACE F09 WITH CEILING((E03.F04+E03.F15-E03.F05)*F99^IIF(IIF(SEEK(F07,'E00'),E00.F05,'')='4',-1,1))    
                   REPLACE F15 WITH F09      
                   REPLACE F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                   RTG_NB=RTG_NB+1
                   THISFORM.LBLRTG1.CAPTION=ALLTRIM(STR(RTG_NB))
                   IF K<F06                     &&如果不為最後製程順序則重新排序                   
                       H=VAL(E07.F06)-VAL(K)
                       T=VAL(F06)-1
                       REPLACE F06 WITH '000'
                       FOR I=1 TO H
                              SEEK PO_NO+PADL(ALLTRIM(STR(T)),3,'0')
                               REPLACE F06 WITH PADL(ALLTRIM(STR(VAL(F06)+1)),3,'0')    
                               IF VAL(F06)=RTG_NB          
                                  IF F08<>E03.F14
                                     =MESSAGEBOX('製程最後加工部門必須等於製令完工部門!',0+48,'提示訊息視窗')
                                     REPLACE F08 WITH E03.F14
                                  ENDIF                                                              
                                  REPLACE F98 WITH .T.                                  
                               ELSE     
                                    REPLACE F98 WITH  .F. 
                                ENDIF    
                               T=T-1          
                       ENDFOR
                       SEEK PO_NO+'000'
                       REPLACE F06 WITH K                       
                       IF VAL(K)=RTG_NB
                          IF F08<>E03.F14
                             =MESSAGEBOX('製程最後加工部門必須等於製令完工部門!',0+48,'提示訊息視窗')
                             REPLACE F08 WITH E03.F14
                          ENDIF                                 
                          REPLACE F98 WITH .T.
                        ELSE
                            REPLACE F98 WITH .F.    
                        ENDIF    
                   ENDIF                       
                   THISFORM.GRID1.ENABLED=.T.
                   SEEK PO_NO+K
                   THISFORM.GRID1.SETFOCUS
                   THISFORM.GRID1.ENABLED=.F.
                   THISFORM.ORPGROUP.NEW_BOTT.CLICK
      ENDPROC
      PROC SHRGROUP.SHURE2_BOTT.CLICK
                 IF SEEK(THISFORM.TXTF08.VALUE,'A14')=.F.
                      =MESSAGEBOX('無此加工部門編號',0+48,'請修正成正確部門編號')
                      THISFORM.TXTF08.SETFOCUS
                      RETURN
                  ENDIF    
                  IF VAL(THISFORM.TXTF06.VALUE)=0
                       =MESSAGEBOX('製程順序必須為阿拉伯數字,且必須大於 0!',0+48,'提示訊息視窗')
                       THISFORM.TXTF06.SETFOCUS
                       RETURN
                   ENDIF    
                  IF VAL(THISFORM.TXTF06.VALUE)>RTG_NB
                       =MESSAGEBOX('此數字,不得大於 '+ALLTRIM(STR(RTG_NB)),0+48,'提示訊息視窗')
                       THISFORM.TXTF06.SETFOCUS
                       RETURN
                   ENDIF             
                   SELECT E07
                        IF THISFORM.TXTF08.VALUE<>E07.F08  &&如果更改製程部門
                             SELE E16
                             SET ORDER TO E169
                             SEEK E03.F03+THISFORM.TXTF07.VALUE
                             IF FOUND()
                                 H=0
                                 DO WHILE F01+F12=E03.F03+THISFORM.TXTF07.VALUE
                                        REPL F06 WITH THISFORM.TXTF08.VALUE 
                                        H=H+F05
                                        SKIP                         
                                 ENDDO   
                                 IF H>0
                                     =MESSAGEBOX('記得將為生產此製令所領之物料移轉至'+THISFORM.LBLF081.CAPTION,0+48,'提示訓息視窗')
                                 ENDIF
                             ENDIF     
                             SET ORDER TO E164      
                             SELE E07
                             REPL F08 WITH THISFORM.TXTF08.VALUE
                         ENDIF   
                         REPLACE F99 WITH THISFORM.TXTF99.VALUE
                         IF THISFORM.TXTF99.VALUE*(E03.F04+E03.F15-E03.F05)<>F09
                             REPLACE F15 WITH F15+(F09-CEILING(THISFORM.TXTF99.VALUE^(IIF(E00.F05='4',-1,1))*(E03.F04+E03.F15-E03.F05)))*(-1)
                             REPLACE F09 WITH CEILING(THISFORM.TXTF99.VALUE^(IIF(E00.F05='4',-1,1))*(E03.F04+E03.F15-E03.F05))                             
                        ENDIF                        
                        REPLACE F13 WITH THISFORM.TXTF13.VALUE           
                        REPL F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                                                                                 
                   IF VAL(THISFORM.TXTF06.VALUE)<>VAL(E07.F06)          &&如果製程順序改變
                       H=ABS(VAL(E07.F06)-VAL(THISFORM.TXTF06.VALUE))
                       K=PADL(ALLTRIM(STR(VAL(THISFORM.TXTF06.VALUE))),3,'0')
                       U=IIF(VAL(THISFORM.TXTF06.VALUE)<VAL(E07.F06),-1,1)
                       T=VAL(F06)+U
                       REPLACE F06 WITH '000'
                       FOR I=1 TO H
                              SEEK E03.F03+PADL(ALLTRIM(STR(T)),3,'0')
                               REPLACE F06 WITH PADL(ALLTRIM(STR(VAL(F06)+U*(-1))),3,'0')    
                               IF VAL(F06)=RTG_NB
                                  IF F08<>E03.F14
                                     =MESSAGEBOX('製程最後加工部門必須等於製令完工部門!',0+48,'提示訊息視窗')
                                     REPLACE F08 WITH E03.F14
                                  ENDIF                                  
                                  REPLACE F98 WITH .T.
                               ELSE     
                                  REPLACE F98 WITH  .F. 
                                ENDIF    
                               T=T+U             
                       ENDFOR
                       SEEK E03.F03+'000'
                       REPLACE F06 WITH K                       
                       IF VAL(K)=RTG_NB
                          IF F08<>E03.F14
                              =MESSAGEBOX('製程最後加工部門必須等於製令完工部門!',0+48,'提示訊息視窗')
                              REPLACE F08 WITH E03.F14
                          ENDIF                                 
                          REPLACE F98 WITH .T.
                        ELSE
                             REPLACE F98 WITH .F.    
                        ENDIF    
                       SEEK PO_NO+K
                   ENDIF      
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
      ENDPROC
      PROC SHRGROUP.ABANDON_BOTT.CLICK
           THISFORM.SHRGROUP.ENABLED=.F.
           THISFORM.SHRGROUP.VISIBLE=.F.
           THISFORM.ORPGROUP.ENABLED=.T.
           THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.CMDGROUP.ENABLED=.T.
           THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
           THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
           THISFORM.TXTF08.READONLY=.T.
           THISFORM.CMND2.ENABLED=.T.
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.T.
           THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.                                                    
           THISFORM.GRID1.ENABLED=.T.
           THISFORM.GRID1.SETFOCUS
           UNLOCK ALL
      ENDPROC
      PROC SHRGROUP.FINISH_BOTT.CLICK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
      ENDPROC
      PROCEDURE TXTF07.INTERACTIVECHANGE
            IF AT('?',ALLTRIM(THIS.VALUE))<>0
                IF AT('?',ALLTRIM(THIS.VALUE))>1             
                   SELECT E00.F01 F07,E00.F04 FROM E00 INTO CURSOR RTE  WHERE  LEFT(E00.F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND E00.F01 NOT IN (SELE F07 FROM E07 WHERE F01=PO_NO) ORDER BY E00.F01
                ELSE
                    SELECT E00.F01 F07,E00.F04 FROM E00 INTO CURSOR RTE  WHERE E00.F01 NOT IN (SELE F07 FROM E07 WHERE F01=PO_NO) ORDER BY E00.F01 
                ENDIF        
                IF _TALLY>0
                    RTE_SEEK=createobject("RTE_SEEK")  
                    RTE_SEEK.SHOW    
                    THIS.VALUE=FLG
                    THIS.REFRESH
                     FLG='0'     
                ENDIF    
            ENDIF  
            THISFORM.LBLF071.CAPTION=IIF(SEEK(THIS.VALUE,'E00'),E00.F04,'') 
            THISFORM.TXTF99.LEFT=INT_015*266+IIF(E00.F05='4',20,0)  
            THISFORM.TXTF99.VALUE=VAL(IIF(E00.F05='4',IIF(SEEK(E03.F01,'C20'),C20.F03,'1'),'1'))
    ENDPROC
enddefine            

