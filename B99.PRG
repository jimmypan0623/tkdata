***程式名稱 B99.各項單據記錄
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
R=0
CH=1
AREA1='B99_1'
AREA2='B99'
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1
FIRST_DATE=LEFT(DTOS(A23.F01),6) &&系統月份檔第一筆開帳月份
GO BOTTOM
LAST_DATE=LEFT(DTOS(A23.F01),6)  &&系統月份檔最後一筆開帳月份
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'B99'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET ORDER TO 1         
GO TOP   
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1  
IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011
IF !USED('C03')
   SELE 0
   USE C03 INDE C03
ELSE
   SELE C03
ENDIF
SET ORDER TO C033
IF !USED('C04')
   SELE 0
   USE C04 INDE C04
ELSE
   SELE C04
ENDIF
SET ORDER TO C041
IF !USED('D01')
   SELE 0
   USE D01 INDE D01
ELSE
   SELE D01
ENDIF
SET ORDER TO D011     
IF !USED('P04')
   SELE 0
   USE P04 INDE P04
ELSE
   SELE P04
ENDIF
SET ORDER TO P041          
IF !USED('P05')
   SELE 0
   USE P05 INDE P05
ELSE
   SELE P05
ENDIF
SET ORDER TO P051          
***************
B99AFORM=CREATEOBJECT("TKB99A")
B99AFORM.SHOW       
DEFINE CLASS TKB99A AS FORM
  AUTOCENTER=.T.
  CAPTION='B99 各項單據記錄'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*300
  WIDTH=INT_015*340
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='TKB99A'
  ADD OBJECT LBF AS LABEL WITH;
      LEFT=INT_015*50,;
      TOP=INT_015*10,;
      AUTOSIZE=.T.,;
      BACKCOLOR=RGB(255,255,0),;
      CAPTION='請選擇預查詢之單據及輸入查詢之日期範圍'
   ADD OBJECT CHKF01 AS CHECKBOX WITH;
      LEFT=INT_015*40,;
      TOP=INT_015*50,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='出貨單'    
   ADD OBJECT CHKF02 AS CHECKBOX WITH;
      LEFT=INT_015*130,;
      TOP=INT_015*50,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='出貨退回單'   
   ADD OBJECT CHKF03 AS CHECKBOX WITH;
      LEFT=INT_015*230,;
      TOP=INT_015*50,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='移轉單'      
  ADD OBJECT CHKF04 AS CHECKBOX WITH;
      LEFT=INT_015*40,;
      TOP=INT_015*80,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='外購進貨單'   
     ADD OBJECT CHKF05 AS CHECKBOX WITH;
      LEFT=INT_015*130,;
      TOP=INT_015*80,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='內購進貨單'   
   ADD OBJECT CHKF06 AS CHECKBOX WITH;
      LEFT=INT_015*230,;
      TOP=INT_015*80,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='進貨退出單'              
   ADD OBJECT CHKF07 AS CHECKBOX WITH;
      LEFT=INT_015*40,;
      TOP=INT_015*110,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='製令領料單'              
   ADD OBJECT CHKF08 AS CHECKBOX WITH;
      LEFT=INT_015*130,;
      TOP=INT_015*110,;
      ALIGNMENT=0,;
      AUTOSIZE=.T.,;
      CAPTION='委外入庫單'                           
  ADD OBJECT LBLF01 AS LABEL WITH;
      LEFT=INT_015*50,;
      TOP=INT_015*150,;
      WIDTH=INT_015*50,;
      CAPTION='起始日期'
  ADD OBJECT TXTF01 AS TEXTBOX WITH;
      LEFT=INT_015*100,;
      TOP=INT_015*145,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;
      MAXLENGTH=7,;
      INPUTMASK='9999/99',;   
      NAME='TXTF01'      
  ADD OBJECT LBLF02 AS LABEL WITH;
      LEFT=INT_015*190,;
      TOP=INT_015*150,;
      WIDTH=INT_015*50,;
      CAPTION='終止日期'        
  ADD OBJECT TXTF02 AS TEXTBOX WITH;
      LEFT=INT_015*240,;
      TOP=INT_015*145,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;
      MAXLENGTH=7,;
      INPUTMASK='9999/99',;   
      NAME='TXTF02'    
  ADD OBJECT LBLF03 AS LABEL WITH;
      LEFT=INT_015*130,;
      TOP=INT_015*200,;
      AUTOSIZE=.T.,;
      CAPTION=''             
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*90,;
      TOP=INT_015*250,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='\<Y.確認',;
      TOOLTIPTEXT='確認所查詢條件',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*180,;
      TOP=INT_015*250,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此查詢尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
*************      
 PROCEDURE INIT 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'CHECKBOX') 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')          
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
         THISFORM.TXTF01.VALUE=LEFT(DTOS(DATE()),4)+'/'+SUBSTR(DTOS(DATE()),5,2)
         THISFORM.TXTF02.VALUE=LEFT(DTOS(DATE()),4)+'/'+SUBSTR(DTOS(DATE()),5,2)
 ENDPROC
 ************
 PROCEDURE CMND1.CLICK
       DO CASE
            CASE THISFORM.CHKF01.VALUE=0 .AND. THISFORM.CHKF02.VALUE=0 .AND. THISFORM.CHKF03.VALUE=0 .AND. ;
                       THISFORM.CHKF04.VALUE=0 .AND. THISFORM.CHKF05.VALUE=0  .AND. THISFORM.CHKF06.VALUE=0 .AND. THISFORM.CHKF07.VALUE=0 .AND. THISFORM.CHKF08.VALUE=0
                        =MESSAGEBOX('最少須選擇一項單據',0+64,'提示視窗')
                        THISFORM.CHKF01.SETFOCUS
                        RETURN
            CASE  LEN(ALLTRIM(THISFORM.TXTF01.VALUE))=1 .OR. LEN(ALLTRIM(THISFORM.TXTF01.VALUE))<>7
                        =MESSAGEBOX('起始日期格式不正確',0+64,'提示視窗')
                        THISFORM.TXTF01.VALUE=''
            		THISFORM.TXTF01.SETFOCUS
                        RETURN
          CASE    IIF(SEEK(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),'A23'),.F.,.T.)
             		=MESSAGEBOX('起始日期於系統中尚未有資料,系統開檔日為'+FIRST_DATE+',請重新輸入!',0+64,'提示視窗')
            		THISFORM.TXTF01.SETFOCUS
                        RETURN              
          CASE    LEN(ALLTRIM(THISFORM.TXTF02.VALUE))=1 .OR. LEN(ALLTRIM(THISFORM.TXTF02.VALUE))<>7
                        =MESSAGEBOX('終止日期格式不正確',0+64,'提示視窗')
            		THISFORM.TXTF02.SETFOCUS
                        RETURN                    
          CASE    IIF(SEEK(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),'A23'),.F.,.T.)
             		=MESSAGEBOX('終止日期於系統中尚未有資料,目前統開檔日已到'+LAST_DATE+',請重新輸入!',0+64,'提示視窗')
            		THISFORM.TXTF02.SETFOCUS
                        RETURN                             
          CASE  CTOD(THISFORM.TXTF02.VALUE+'/01')<CTOD(THISFORM.TXTF01.VALUE+'/01')
                        =MESSAGEBOX('終止日期不得小於起始日期',0+64,'提示視窗')
            		THISFORM.TXTF02.SETFOCUS
                        RETURN                  
      ENDCASE 
CREATE CURSOR B99;
(F01 C(10),F02 D(8),F03 C(43),F04 N(13),F05 C(8),F06 C(5),F07 C(50),F08 C(5),F09 C(8),F10 C(30),F11 C(8),F13 N(8),F14 C(20),F15 C(30),F16 C(4),F17 N(14,6),F18 N(11,6),F19 N(15,3),F20 C(10),F21 C(5),F22 C(8))
INDE ON F03+F06 TAG B991
INDE ON F06+F03 TAG B992  
SET RELA TO F03 INTO B01 
**********
*F01單號,F02日期,F03料號,F04異動數量,F05對象簡稱,F06對象編號,F07用途,F08需求客戶
*F09需求客戶簡稱,F10備註,F11統一編號,F13 無價量,F14 PO/NO,F15 客戶品號
*F16幣別,F17單價,F18匯率,F19金額小計,F20發票號碼,F21 出貨\退貨部門編號,F22 出貨\退貨部門簡稱
*******出貨單
IF THISFORM.CHKF01.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B04'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B04'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
		IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF    
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F10='2' 
		    	        THISFORM.LBLF03.CAPTION='出貨單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F06,'C01'),C01.F05,'')
				REPLACE F06 WITH &H1..F06
				REPLACE F07 WITH '訂'+&H1..F07
	*!*				REPLACE F08 WITH F06
	*!*				REPLACE F09 WITH F05
				REPLACE F10 WITH &H1..F21
				REPLACE F11 WITH IIF(SEEK(F06,'C01'),C01.F10,'')			
				REPLACE F13 WITH &H1..F13
				REPLACE F14 WITH IIF(SEEK(&H1..F06+&H1..F07,'C03'),C03.F14,'') 
	      			REPLACE F15 WITH IIF(SEEK(&H1..F07+&H1..F03,'C04'),C04.F17,'') 
				REPLACE F16 WITH &H1..F14
				REPLACE F17 WITH &H1..F15
				REPLACE F18 WITH &H1..F16
				REPLACE F19 WITH &H1..F17
				REPLACE F20 WITH &H1..F20
				REPLACE F21 WITH &H1..F05
				REPLACE F22 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')
			 ENDIF	
			 SELECT &H1
			 SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	       IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B04'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B04'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO
ENDIF	
*******出貨退回單
IF THISFORM.CHKF02.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B05'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B05'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
		IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF    
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F12='2'
		    	       THISFORM.LBLF03.CAPTION='出貨退回單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F10,'C01'),C01.F05,'')
				REPLACE F06 WITH &H1..F10
				REPLACE F07 WITH '訂'+&H1..F11
 
				REPLACE F10 WITH &H1..F21
				REPLACE F11 WITH IIF(SEEK(F06,'C01'),C01.F10,'')				
				REPLACE F13 WITH &H1..F15
				REPLACE F14 WITH IIF(SEEK(&H1..F10+&H1..F11,'C03'),C03.F14,'') 
	      			REPLACE F15 WITH IIF(SEEK(&H1..F11+&H1..F03,'C04'),C04.F17,'')
				REPLACE F16 WITH &H1..F16
				REPLACE F17 WITH &H1..F17
				REPLACE F18 WITH &H1..F18
				REPLACE F19 WITH IIF(F18=1,ROUND(F04*F17,INT_069),ROUND(F04*F17*F18,INT_069))
				REPLACE F20 WITH &H1..F20
				REPLACE F21 WITH &H1..F05
				REPLACE F22 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')				
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	       IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B05'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B05'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO
ENDIF
*************移轉單
IF THISFORM.CHKF03.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B06'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B06'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
	    	IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF     
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F07='2'
		    	        THISFORM.LBLF03.CAPTION='移轉單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F79
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')
				REPLACE F06 WITH &H1..F05 &&轉出部門
				REPLACE F07 WITH F05+'移轉至'+&H1..F10+IIF(SEEK(ALLTRIM(&H1..F10),'A14'),A14.F02,'')
				REPLACE F21 WITH &H1..F10 &&存放部門
				REPLACE F22 WITH IIF(SEEK(&H1..F10,'A14'),A14.F02,'')							
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	        IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B06'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B06'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO	
ENDIF 	
*************外購進貨單
IF THISFORM.CHKF04.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='P12'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='P12'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
	    	IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF     
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F10='2'
		    	        THISFORM.LBLF03.CAPTION='外購進貨單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F07,'D01'),D01.F04,'')
	*!*				REPLACE F06 WITH IIF(SEEK(RIGHT(ALLTRIM(&H1..F08),LEN(ALLTRIM(&H1..F08))-(AT(' ',&H1..F08)+1)),'C01'),C01.F01,'')
				REPLACE F06 WITH &H1..F07
				REPLACE F07 WITH '採'+&H1..F09+' 請'+&H1..F08
				REPLACE F08 WITH IIF(SEEK(LEFT(&H1..F08,10),'P05'),P05.F04,'') 
				REPLACE F09 WITH IIF(SEEK(LEFT(&H1..F08,10),'P05'),P05.F05,'') 
				REPLACE F10 WITH &H1..F21
				REPLACE F11 WITH IIF(SEEK(F06,'D01'),D01.F06,'')			
				REPLACE F14 WITH IIF(SEEK(LEFT(&H1..F08,10),'P05'),IIF(SEEK(P05.F04+P05.F06,'C03'),C03.F14,''),'') 
*!*					PONO=P05.F06&&客戶訂單單號
*!*		      			REPLACE F15 WITH IIF(SEEK(PONO+&H1..F03,'C04'),C04.F17,'')
                REPLACE F15 WITH IIF(SEEK(&H1..F09+&H1..F03,'P04'),P04.F13,'')
				REPLACE F16 WITH &H1..F16
				REPLACE F17 WITH IIF(A02.F10='*',&H1..F17,0)
				REPLACE F18 WITH IIF(A02.F10='*',&H1..F18,0)
				REPLACE F19 WITH IIF(A02.F10='*',IIF(F18=1,ROUND(F04*F17,INT_069),ROUND(F04*F17*F18,INT_069)),0)
				REPLACE F20 WITH &H1..F20
				REPLACE F21 WITH &H1..F05
				REPLACE F22 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')				
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE	RIGHT(ALLTRIM(&H1..F08),LEN(ALLTRIM(&H1..F08))-(AT(' ',&H1..F08)+1))
	       ENDIF  
	        IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='P12'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='P12'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO
ENDIF	
*************內購進貨單
IF THISFORM.CHKF05.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B02'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B02'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
	    	IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF     
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F10='2'
		    	        THISFORM.LBLF03.CAPTION='內購進貨單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F07,'D01'),D01.F04,'')
				REPLACE F06 WITH &H1..F07
				IIF(SEEK(RIGHT(ALLTRIM(&H1..F08),LEN(ALLTRIM(&H1..F08))-(AT(' ',&H1..F08)+1)),'C01'),C01.F01,'')
				REPLACE F07 WITH '採'+&H1..F09+' 請'+&H1..F08
	*!*				REPLACE F08 WITH 
	*!*				REPLACE F09 WITH
				REPLACE F10 WITH &H1..F21
				REPLACE F11 WITH IIF(SEEK(F06,'D01'),D01.F06,'')			
				REPLACE F16 WITH &H1..F16
				REPLACE F17 WITH IIF(A02.F10='*',&H1..F17,0)
				REPLACE F18 WITH IIF(A02.F10='*',&H1..F18,0)
				REPLACE F19 WITH IIF(A02.F10='*',IIF(F18=1,ROUND(F04*F17,INT_069),ROUND(F04*F17*F18,INT_069)),0)
				REPLACE F20 WITH &H1..F20
				REPLACE F21 WITH &H1..F05
				REPLACE F22 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')				
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	        IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B02'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B02'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO
ENDIF	
*******進貨退出單
IF THISFORM.CHKF06.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B03'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B03'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
		IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF    
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F10='2'
		    	        THISFORM.LBLF03.CAPTION='進貨退回單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F07,'D01'),D01.F04,'')
				REPLACE F06 WITH &H1..F07
				REPLACE F07 WITH '採'+&H1..F09+'  '+&H1..F08
	*!*				REPLACE F08 WITH  
	*!*				REPLACE F09 WITH
				REPLACE F10 WITH &H1..F21
				REPLACE F11 WITH IIF(SEEK(F06,'D01'),D01.F06,'')				
				REPLACE F16 WITH &H1..F15
				REPLACE F17 WITH IIF(A02.F10='*',&H1..F16,0)
				REPLACE F18 WITH IIF(A02.F10='*',&H1..F18,0)
				REPLACE F19 WITH IIF(A02.F10='*',IIF(F18=1,ROUND(F04*F17,INT_069),ROUND(F04*F17*F18,INT_069)),0)
				REPLACE F20 WITH &H1..F20
				REPLACE F21 WITH &H1..F05
				REPLACE F22 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')				
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	       IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B03'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B03'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO
ENDIF	
*****製令領料單
IF THISFORM.CHKF07.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B08'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B08'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
	    	IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF     
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F13='2'
		    	        THISFORM.LBLF03.CAPTION='製令領料單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F08
				REPLACE F04 WITH &H1..F12
				REPLACE F05 WITH IIF(SEEK(&H1..F07,'A14'),A14.F02,'')
				REPLACE F06 WITH &H1..F07 &&轉出部門
				REPLACE F07 WITH F05+'發料給'+&H1..F04+IIF(SEEK(ALLTRIM(&H1..F04),'A14'),A14.F02,'')+'生產'
				REPLACE F21 WITH &H1..F04 &&存放部門
				REPLACE F22 WITH IIF(SEEK(&H1..F04,'A14'),A14.F02,'')							
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	        IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B08'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B08'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO	
ENDIF 	
*****委外入庫單
IF THISFORM.CHKF08.VALUE=1
	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	H1='B07'+ALLTRIM(S1)
	F1=ALLTRIM(H1)+'.DBF'
	S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	H2='B07'+ALLTRIM(S2)
	F2=ALLTRIM(H2)+'.DBF'
	DO  WHILE  FILE('&F1')=.T.   
	    	IF !USED('&F1')
	   	    SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF     
	    	SELECT &H1
	    	GO TOP	
	    	DO  WHILE !EOF()
	    		IF &H1..F10='2' AND &H1..F13='1'
		    	        THISFORM.LBLF03.CAPTION='委外入庫單  '+S1
		    		SELECT 0
				SELECT B99
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02)
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH IIF(SEEK(&H1..F14,'A14'),A14.F02,'')
				REPLACE F06 WITH &H1..F14 &&轉出部門
				REPLACE F07 WITH '委:'+&H1..F15+'製:'+&H1..F09
				&&REPLACE F11 WITH IIF(SEEK(F06,'D01'),D01.F06,'')			
				REPLACE F16 WITH &H1..F16
				REPLACE F17 WITH &H1..F17
				REPLACE F18 WITH &H1..F18
				REPLACE F19 WITH IIF(F18=1,ROUND(F04*F17,INT_069),ROUND(F04*F17*F18,INT_069))
				REPLACE F20 WITH &H1..F20
				REPLACE F21 WITH &H1..F05
				REPLACE F22 WITH IIF(SEEK(&H1..F05,'A14'),A14.F02,'')	
									
			ENDIF	
			SELECT &H1
			SKIP
		ENDDO     
		IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	        IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	    S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	    H1='B07'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	      ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='B07'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	     ENDIF    
	ENDDO	
ENDIF 	
*************
CREATE CURSOR B99_1 (F02 C(40),F03 C(43),F04 N(12),F05 N(12),F06 N(12),F07 N(12),F08 N(12),F09 N(12))
INDE ON F03 TAG B99_11
SELE F03 FROM B99 GROUP BY F03 ORDER BY F03 INTO CURSOR B99_3 
SELE B99_3
GO TOP
DO WHILE !EOF()
   SELE B99_1
   APPEND BLANK
   REPL F02 WITH IIF(SEEK(B99_3.F03,'B01'),B01.F02,'')
   REPL F03 WITH B99_3.F03
   REPL F04 WITH TOTAL1(B99_3.F03)+TOTAL13(B99_3.F03)
   REPL F05 WITH TOTAL2(B99_3.F03)
   REPL F06 WITH TOTAL3(B99_3.F03)
   REPL F07 WITH TOTAL7(B99_3.F03)
   REPL F08 WITH TOTAL9(B99_3.F03)
   REPL F09 WITH TOTAL11(B99_3.F03)+TOTAL15(B99_3.F03)
   SELE B99_3
   SKIP   
ENDDO
SELE B99_3
USE
SELE B99_1
SET ORDER TO 1
******
CREATE CURSOR B99_2 (F02 C(8),F03 C(5),F04 N(12),F05 N(12),F06 N(12),F07 N(12),F08 N(12),F09 N(12))
INDE ON F03 TAG B99_21
SELE F05,F06 FROM B99 GROUP BY F06 ORDER BY F06 INTO CURSOR B99_3 
SELE B99_3
GO TOP
DO WHILE !EOF()
   SELE B99_2
   APPEND BLANK
   REPL F02 WITH B99_3.F05
   REPL F03 WITH B99_3.F06
   REPL F04 WITH TOTAL4(B99_3.F06)+TOTAL14(B99_3.F06)
   REPL F05 WITH TOTAL5(B99_3.F06)
   REPL F06 WITH TOTAL6(B99_3.F06)
   REPL F07 WITH TOTAL8(B99_3.F06)
   REPL F08 WITH TOTAL10(B99_3.F06)
   REPL F09 WITH TOTAL12(B99_3.F06)+TOTAL16(B99_3.F06)
   SELE B99_3
   SKIP   
ENDDO
SELE B99_3
USE      
SELECT B99_2
SET ORDER TO B99_21
SELECT B99
SET ORDER TO B991
ST=ALLTRIM(THISFORM.TXTF01.VALUE)+'至'+ALLTRIM(THISFORM.TXTF02.VALUE)
DATA_RANG=LEFT(THISFORM.TXTF01.VALUE,4)+RIGHT(THISFORM.TXTF01.VALUE,2)+'至'+LEFT(THISFORM.TXTF02.VALUE,4)+RIGHT(THISFORM.TXTF02.VALUE,2)
B99BFORM=CREATEOBJECT("TKB99B")
B99BFORM.SHOW       	 
 THISFORM.CMND2.CLICK		
 ENDPROC
 *******
 PROCEDURE CMND2.CLICK        
           IF !USED('A05')
              SELECT 0
              USE A05
           ELSE
              SELECT A05
           ENDIF
           SET ORDER TO 1
           SEEK sys_oper+'B99'
           IF FOUND()
              DELETE 
           ENDIF         
           CLOSE TABLE ALL
           THISFORM.RELEASE 
           RETURN  
      ENDPROC      
ENDDEFINE  
***********        
DEFINE CLASS TKB99B AS FORM
  CAPTION='B99.各項單據記錄'+'      資料範圍'+ST
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKB99B'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*230,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=2,;            
      RECORDSOURCE='B99_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      TOP=INT_015*220,;
      HEIGHT=INT_015*300,;
      COLUMNCOUNT=11,;            
      RECORDSOURCE='B99',; 
      LINKMASTER='B99_1',;
      RELATIONALEXPR='F03',;
      CHILDORDER='B991',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7',;
      COLUMN8.NAME='COLUMN8',;
      COLUMN9.NAME='COLUMN9',;
      COLUMN10.NAME='COLUMN10',;
      COLUMN11.NAME='COLUMN11'      
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.                             
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.       
  ADD OBJECT EXCEL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*10,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*65 ,;       
      FONTSIZE=INT_015*9,;
      CAPTION='\<E.轉EXCEL',;
      NAME='EXCEL_BOTT'             
 **************          
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='料品編號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF011','LABEL')         
     WITH THIS.LBLF011
         .VISIBLE=.T.
         .LEFT=INT_015*333
         .TOP=INT_015*13
         .AUTOSIZE=.T.
     ENDWITH
     THIS.ADDOBJECT('TXTF01','TEXTBOX')
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*8
          .WIDTH=INT_015*261
     ENDWITH 
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*39
         .WIDTH=INT_015*50
         .CAPTION='出貨總數'
     ENDWITH
     THIS.ADDOBJECT('TXTF10','TEXTBOX')
     WITH THIS.TXTF10
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .WIDTH=INT_015*75
          .TOP=INT_015*34
     ENDWITH 
   THIS.ADDOBJECT('LBLF13','LABEL')
     WITH THIS.LBLF13
          .VISIBLE=.T.
          .LEFT=INT_015*250
          .TOP=INT_015*39
          .WIDTH=INT_015*75
          .CAPTION='出貨退回總數'
     ENDWITH
  THIS.ADDOBJECT('TXTF13','TEXTBOX')
     WITH THIS.TXTF13
          .VISIBLE=.T.
          .LEFT=INT_015*325
          .WIDTH=INT_015*75
          .TOP=INT_015*34
     ENDWITH      
   THIS.ADDOBJECT('LBLF11','LABEL')
     WITH THIS.LBLF11
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*65
          .WIDTH=INT_015*50
          .CAPTION='進貨總數'
     ENDWITH
  THIS.ADDOBJECT('TXTF11','TEXTBOX')
     WITH THIS.TXTF11
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .WIDTH=INT_015*75
          .TOP=INT_015*60
     ENDWITH
   THIS.ADDOBJECT('LBLF14','LABEL')
     WITH THIS.LBLF14
          .VISIBLE=.T.
          .LEFT=INT_015*250
          .TOP=INT_015*65
          .WIDTH=INT_015*75
          .CAPTION='進貨退回總數'
     ENDWITH
  THIS.ADDOBJECT('TXTF14','TEXTBOX')
     WITH THIS.TXTF14
          .VISIBLE=.T.
          .LEFT=INT_015*325
          .WIDTH=INT_015*75
          .TOP=INT_015*60
     ENDWITH           
  THIS.ADDOBJECT('LBLF12','LABEL')
     WITH THIS.LBLF12
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*91
          .WIDTH=INT_015*50
          .CAPTION='移轉總數'
     ENDWITH
  THIS.ADDOBJECT('TXTF12','TEXTBOX')
     WITH THIS.TXTF12
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .WIDTH=INT_015*75
          .TOP=INT_015*86
     ENDWITH    
  ENDPROC  
******************   
 PROCEDURE PAGEFRAME1.PAGE2.INIT
  THIS.ADDOBJECT('LBLF03','LABEL')
	WITH THIS.LBLF03  
	 .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	 .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH
   THIS.ADDOBJECT('LBLF031','LABEL')         
     WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*155
         .TOP=INT_015*18
         .AUTOSIZE=.T.
         .CAPTION=''         
     ENDWITH 
   THIS.ADDOBJECT('TXTF03','TEXTBOX')
	WITH THIS.TXTF03      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*74
	     .HEIGHT=INT_015*25
	     .NAME='TXTF03'  
	ENDWITH   
  THIS.ADDOBJECT('LBLF21','LABEL')
	WITH THIS.LBLF21  
	 .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*43
	 .WIDTH=INT_015*50
         .CAPTION='部門編號'
    ENDWITH
   THIS.ADDOBJECT('TXTF21','TEXTBOX')
	WITH THIS.TXTF21      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .NAME='TXTF21'  
	ENDWITH  	
   THIS.ADDOBJECT('LBLF22','LABEL')         
     WITH THIS.LBLF22
         .VISIBLE=.T.
         .LEFT=INT_015*155
         .TOP=INT_015*43
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH 	             
    THIS.ADDOBJECT('LBLF07','LABEL')
    WITH THIS.LBLF07
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*68
	     .WIDTH=INT_015*50
	     .CAPTION='單據編號'
	ENDWITH
    THIS.ADDOBJECT('LBLF071','LABEL')
    WITH THIS.LBLF071
         .VISIBLE=.T.
	     .LEFT=INT_015*155
	     .TOP=INT_015*68
	     .AUTOSIZE=.T.
	     .CAPTION=''
	ENDWITH	
   THIS.ADDOBJECT('TXTF07','TEXTBOX')
	WITH THIS.TXTF07
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*64
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .NAME='TXTF07'	    
  ENDWITH 
    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='異動數量'         
    ENDWITH
    THIS.ADDOBJECT('TXTF04','TEXTBOX')
    WITH THIS.TXTF04
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*89
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .NAME='TXTF04'
    ENDWITH 
      THIS.ADDOBJECT('LBLF13','LABEL')
    WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*153
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='無價數量'         
    ENDWITH
    THIS.ADDOBJECT('TXTF13','TEXTBOX')
    WITH THIS.TXTF13
         .VISIBLE=.T.           
         .LEFT=INT_015*205
         .TOP=INT_015*89
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .NAME='TXTF13'
    ENDWITH   	
  THIS.ADDOBJECT('LBLF20','LABEL')
    WITH THIS.LBLF20
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*118
	     .WIDTH=INT_015*50
	     .CAPTION='發票號碼'
	ENDWITH         
  THIS.ADDOBJECT('TXTF20','TEXTBOX')
	WITH THIS.TXTF20      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*114
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .NAME='TXTF20'  
	ENDWITH 
    THIS.ADDOBJECT('LBLF11','LABEL')
    WITH THIS.LBLF11
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*143
	     .WIDTH=INT_015*50
	     .CAPTION='統一編號'
    ENDWITH
   THIS.ADDOBJECT('TXTF11','TEXTBOX')
	WITH THIS.TXTF11
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*139
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .NAME='TXTF11'	    
  ENDWITH 	
  THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*168
	     .WIDTH=INT_015*50
	     .CAPTION='用途備註'
	ENDWITH         
  THIS.ADDOBJECT('TXTF08','TEXTBOX')
	WITH THIS.TXTF08      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*164
	     .WIDTH=INT_015*305
	     .HEIGHT=INT_015*25
	     .NAME='TXTF08'  
	ENDWITH 	 
  THIS.ADDOBJECT('LBLF02','LABEL')
	WITH THIS.LBLF02  
	 .VISIBLE=.T.
         .LEFT=INT_015*380
         .TOP=INT_015*43
	 .WIDTH=INT_015*50
         .CAPTION='日        期'
    ENDWITH
   THIS.ADDOBJECT('TXTF02','TEXTBOX')
	WITH THIS.TXTF02      
	     .VISIBLE=.T.
	     .LEFT=INT_015*430
	     .TOP=INT_015*39
	     .WIDTH=INT_015*65
	     .HEIGHT=INT_015*25
	     .NAME='TXTF02'  
	ENDWITH 			
   THIS.ADDOBJECT('LBLF16','LABEL')
	WITH THIS.LBLF16  
	 .VISIBLE=.T.
         .LEFT=INT_015*380
         .TOP=INT_015*68
	 .WIDTH=INT_015*50
         .CAPTION='幣        別'
    ENDWITH
   THIS.ADDOBJECT('TXTF16','TEXTBOX')
	WITH THIS.TXTF16      
	     .VISIBLE=.T.
	     .LEFT=INT_015*430
	     .TOP=INT_015*64
	     .WIDTH=INT_015*50
	     .HEIGHT=INT_015*25
	     .NAME='TXTF16'  
	ENDWITH 		
  THIS.ADDOBJECT('LBLF18','LABEL')
	WITH THIS.LBLF18  
	 .VISIBLE=.T.
         .LEFT=INT_015*380
         .TOP=INT_015*93
	 .WIDTH=INT_015*50
         .CAPTION='匯        率'
    ENDWITH
   THIS.ADDOBJECT('TXTF18','TEXTBOX')
	WITH THIS.TXTF18      
	     .VISIBLE=.T.
	     .LEFT=INT_015*430
	     .TOP=INT_015*89
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .NAME='TXTF18'  
	ENDWITH 		    	     	
 THIS.ADDOBJECT('LBLF17','LABEL')
	WITH THIS.LBLF17  
	 .VISIBLE=.T.
         .LEFT=INT_015*380
         .TOP=INT_015*118
	 .WIDTH=INT_015*50
         .CAPTION='單        價'
    ENDWITH
   THIS.ADDOBJECT('TXTF17','TEXTBOX')
	WITH THIS.TXTF17      
	     .VISIBLE=.T.
	     .LEFT=INT_015*430
	     .TOP=INT_015*114
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .NAME='TXTF17'  
	ENDWITH 	     	
  THIS.ADDOBJECT('LBLF19','LABEL')
	WITH THIS.LBLF19  
	 .VISIBLE=.T.
         .LEFT=INT_015*380
         .TOP=INT_015*143
	 .WIDTH=INT_015*50
         .CAPTION='金額小計'
    ENDWITH
  THIS.ADDOBJECT('LBLF191','LABEL')
	WITH THIS.LBLF191 
	 .VISIBLE=.T.
         .LEFT=INT_015*430
         .TOP=INT_015*143
	 .AUTOSIZE=.T.
         .CAPTION=''
    ENDWIT	       
  ENDPROC
*******************         
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE B99_1
     THISFORM.GRID1.ENABLED=.T.   
     THISFORM.GRID1.SETFOCUS   
     THISFORM.KEY_LIST.ENABLED=.T.
    IF THISFORM.GRID1.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F. 
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.    
        THISFORM.EXCEL_BOTT.ENABLED=.F. 
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.)
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
  ENDPROC
  *****************
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
        SELE B99     
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS       
        THISFORM.EXCEL_BOTT.ENABLED=.F.
     IF THISFORM.GRID2.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC  
****************     
  PROC INIT      
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*9
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*9  
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.       
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.              
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.PAGEFRAME1.PAGE2.LBLF16.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.LBLF17.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.LBLF18.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.LBLF19.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.LBLF191.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.TXTF17.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE2.TXTF18.VISIBLE=IIF(A02.F08='*',.T.,.F.)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')        
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146) 
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B99_1.F03'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B99_1.F02'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='對象編號'
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='對象簡稱'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='部門簡稱'       
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='單據類別'	  
       THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='異動數量'
       THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='無價數量'
       THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='日        期'	
       THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='客戶品號'          
       THISFORM.GRID2.COLUMN9.HEADER1.CAPTION='用途備註'
       THISFORM.GRID2.COLUMN10.HEADER1.CAPTION='客戶PO'
       THISFORM.GRID2.COLUMN11.HEADER1.CAPTION='發票號碼'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B99.F06'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B99.F05'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='B99.F22'       
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='BILL(LEFT(B99.F01,2))'
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE="IIF(LEFT(ALLTRIM(B99.F01),2)='BC'  OR LEFT(ALLTRIM(B99.F01),2)='BE'  OR LEFT(ALLTRIM(B99.F01),2)='BB',-B99.F04,B99.F04)"
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE="IIF(LEFT(ALLTRIM(B99.F01),2)='BC',-B99.F13,B99.F13)"
       THISFORM.GRID2.COLUMN7.CONTROLSOURCE='B99.F02'       
       THISFORM.GRID2.COLUMN8.CONTROLSOURCE='B99.F15'
       THISFORM.GRID2.COLUMN9.CONTROLSOURCE="ALLTRIM(B99.F07)+IIF(!EMPTY(B99.F10),'   JW:'+ALLTRIM(B99.F10),'')"
       THISFORM.GRID2.COLUMN10.CONTROLSOURCE='B99.F14'
       THISFORM.GRID2.COLUMN11.CONTROLSOURCE='B99.F20'
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*55
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*55
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*55       
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*75
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*75
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*50
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*60       
       THISFORM.GRID2.COLUMN8.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN9.WIDTH=INT_015*300
       THISFORM.GRID2.COLUMN10.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN11.WIDTH=INT_015*75
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.EXCEL_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.       
          THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.)
       ENDIF    
       THISFORM.KEY_LIST.DISPLAYVALUE='依料品編號排列'           
       JK='料品編號'   
       SELECT B99_1  
       GO TOP   
  ENDPROC 
***************   
PROC KEY_LIST.INIT 
       WITH THIS
       	   .ADDITEM('依料品編號排列') 
           .ADDITEM('依對象編號排列')
       ENDWITH      
  ENDPROC 
 *************               
  PROC KEY_LIST.INTERACTIVECHANGE  
  GO TOP
   THISFORM.GRID1.RECORDSOURCE=''
  THISFORM.GRID2.LINKMASTER=''
  THISFORM.GRID2.RELATIONALEXPR=''
  THISFORM.GRID2.CHILDORDER=''
       DO CASE
       	     CASE THIS.DISPLAYVALUE='依料品編號排列'
       	     	CH=1
       	     		SELECT B99_1
       	     		SET ORDER TO B99_11
       	     		AREA1='B99_1'
       	     		THISFORM.GRID1.RECORDSOURCE='B99_1'
			THISFORM.GRID2.LINKMASTER='B99_1'
			THISFORM.GRID2.RELATIONALEXPR='F03'
			THISFORM.GRID2.CHILDORDER='B991'
       	     	       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料品編號'
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B99_1.F03'
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B99_1.F02'
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
		       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='對象編號'
		       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B99.F06'
		       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*55
		       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='對象簡稱'
                       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B99.F05'
		       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*55
		       THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='料品編號'
		       THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B99_1.F02 
		       THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*333
		       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B99_1.F03
		       THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*261
		       THISFORM.PAGEFRAME1.PAGE2.LBLF031.LEFT=INT_015*155
	    CASE THIS.DISPLAYVALUE='依對象編號排列'
	    		CH=2
	       	        SELECT B99_2
	       	        SET ORDER TO B99_21
	       	        AREA1='B99_2'
	       	       THISFORM.GRID1.RECORDSOURCE='B99_2'
		       THISFORM.GRID2.LINKMASTER='B99_2'
		       THISFORM.GRID2.RELATIONALEXPR='F03'
		       THISFORM.GRID2.CHILDORDER='B992'
       	               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='對象編號'
       	               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B99_2.F03'
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象簡稱'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B99_2.F02'
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55  
		       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'
		       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B99.F03'
		       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*140
		       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='品名規格'
		       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
		       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*120
       		       THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='對象編號'
       		       THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B99_2.F02
       		       THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*155
		       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B99_2.F03
		       THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*75
		       THISFORM.PAGEFRAME1.PAGE2.LBLF031.LEFT=INT_015*333
	  ENDCASE
       	THISFORM.GRID1.SETFOCUS  	            
  ENDPROC   
***********
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX   
       IF THISFORM.KEY_LIST.DISPLAYVALUE='依料品編號排列'   
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B99_1.F02   
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B99_1.F03
	       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=-B99_1.F04  
	       THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=B99_1.F05+B99_1.F07 
	       THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=-B99_1.F06 
	       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=B99_1.F08
	       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=-B99_1.F09
	ELSE  
	       THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B99_2.F02
	       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B99_2.F03
	       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=-B99_2.F04  
	       THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=B99_2.F05+B99_2.F07 
	       THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=-B99_2.F06 
	       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=B99_2.F08
	       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=-B99_2.F09         
	ENDIF       
       FCH=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.EXCEL_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.)
       ENDIF          
       CHK=''
*       THISFORM.REFRESH
  ENDPROC  
********************     
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       IF AREA1='B99_1'
	       THISFORM.PAGEFRAME1.PAGE2.LBLF03.CAPTION='對象編號'
       	       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B99.F05
       	       THISFORM.PAGEFRAME1.PAGE2.TXTF03.WIDTH=INT_015*85
	       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=B99.F06
	ELSE
	       THISFORM.PAGEFRAME1.PAGE2.LBLF03.CAPTION='料品編號'
       	       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       	       THISFORM.PAGEFRAME1.PAGE2.TXTF03.WIDTH=INT_015*261
	       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=B99.F03
	ENDIF       
	THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=B99.F02
	THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(LEFT(ALLTRIM(B99.F01),2)='BC' OR LEFT(ALLTRIM(B99.F01),2)='BE'  OR LEFT(ALLTRIM(B99.F01),2)='BB',-B99.F04,B99.F04)
	THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=IIF(LEFT(ALLTRIM(B99.F01),2)='BC',-B99.F13,B99.F13)
	THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=B99.F01
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=ALLTRIM(B99.F07)+IIF(!EMPTY(B99.F10),'   JW:'+ALLTRIM(B99.F10),'')
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=B99.F11
        THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=B99.F16
        THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=B99.F17
        THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=B99.F18
        THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=B99.F20
        THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=B99.F21        
        THISFORM.PAGEFRAME1.PAGE2.LBLF071.CAPTION=BILL(LEFT(ALLTRIM(B99.F01),2))
        THISFORM.PAGEFRAME1.PAGE2.LBLF22.CAPTION=B99.F22        
        THISFORM.PAGEFRAME1.PAGE2.LBLF191.CAPTION=TRANSFORM(B99.F19,'99999999999.99')
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THISFORM.GRID2.COLUMN1.HEADER1.CAPTION
      CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.EXCEL_BOTT.ENABLED=.F.
       ENDIF   
*       THISFORM.REFRESH
  ENDPROC
************************  
PROC EXCEL_BOTT.CLICK     &&轉出EXCEL
   FILE_NAME='B99 各項單據紀錄(資料範圍'+DATA_RANG+')'
   IF MESSAGEBOX('是否只轉此筆資料?',4+32+256,'請確認') = 6
        IF AREA1<>'B99_2'	&&依料品編號排列
             LK=B99_1.F03 
             IF MESSAGEBOX('是否要匯總數量?',4+32+256,'請確認') = 6
                  SELECT LEFT(B99.F01,2),B99.F03,B01.F02,B99.F04,B99.F13 FROM B99,B01 WHERE  B99.F03=LK .AND. B01.F01=LK  ORDER BY B99.F03 INTO CURSOR B99_TEMP
                  SELECT  B99_TEMP.F03 料號,;
	          B99_TEMP.F02 品名規格,;     
	          SUM(B99_TEMP.F04) 數量,;
	          SUM(B99_TEMP.F13) 無價量,;
	          BILL(LEFT(B99_TEMP.EXP_1,2)) 單據類別;
        	  FROM B99_TEMP ORDER BY B99_TEMP.F03,B99_TEMP.EXP_1 GROUP BY B99_TEMP.F03,B99_TEMP.EXP_1 NOWAIT
            ELSE 
                  IF A02.F08='*'	&&顯示單價權限
             	      SELECT  B99.F02 日期,; 
             	      B99.F01 單據編號,;
             	      B99.F03 料號,;
	              B01.F02 品名規格,;
	              B01.F99 總號,;
	              B99.F06 對象編號,;
	              B99.F05 對象簡稱,; 	
	              B99.F11 統一編號,;            
	              B99.F04 數量,;
	              B99.F17 單價,;
	              B99.F19 金額小計,;
	              B99.F16 幣別,;
	              B99.F18 匯率,;
	              B99.F20 發票號碼,;
	              B99.F10 備註,;
	              B99.F13 無價量,;
	              B99.F21 部門編號,;
	              B99.F22 部門簡稱,;
	              B99.F07 用途,;  
	              B99.F14 客戶PO,;
	              B99.F15 客戶品號,;
	              BILL(LEFT(B99.F01,2)) 單據類別;
        	      FROM B99,B01 WHERE  B99.F03=LK .AND. B01.F01=LK  NOWAIT  
                  ELSE     
        	      SELECT  B99.F03 料號,;
	              B01.F02 品名規格,; 
	              B99.F02 日期,; 
	              B99.F04 數量,;
	              B99.F13 無價量,;
	              B99.F06 對象編號,;
	              B99.F05 對象簡稱,; 
	              B99.F21 部門編號,;
	              B99.F22 部門簡稱,;	            
	              B99.F11 統一編號,;
	              B99.F20 發票號碼,;
	              B99.F07 用途,;
	              B99.F10 備註,;
	              B99.F14 客戶PO,;
	              B99.F15 客戶品號,;
	              B99.F01 單據編號,;
	              BILL(LEFT(B99.F01,2)) 單據類別;
        	      FROM B99,B01 WHERE  B99.F03=LK .AND. B01.F01=LK  NOWAIT    
                  ENDIF
            ENDIF    	      
        ELSE   &&依對象編號排列
             LK=B99_2.F03
             IF MESSAGEBOX('是否要匯總數量?',4+32+256,'請確認') = 6
                  SELECT LEFT(B99.F01,2),B99.F05,B99.F06,B99.F04,B99.F13 FROM B99 WHERE  B99.F06=LK  ORDER BY B99.F06 INTO CURSOR B99_TEMP
                  SELECT  B99_TEMP.F06 對象編號,;
	          B99_TEMP.F05 對象簡稱,;    
	          SUM(B99_TEMP.F04) 數量,;
	          SUM(B99_TEMP.F13) 無價量,;
	          BILL(LEFT(B99_TEMP.EXP_1,2)) 單據類別;
        	  FROM B99_TEMP  ORDER BY B99_TEMP.F06,B99_TEMP.EXP_1 GROUP BY B99_TEMP.F06,B99_TEMP.EXP_1 NOWAIT
            ELSE             
                  IF A02.F08='*'	&&顯示單價權限
             	       SELECT  B99.F06 對象編號,;
	               B99.F05 對象簡稱,; 
	               B99.F21 部門編號,;
	               B99.F22 部門簡稱,;	            
	               B99.F11 統一編號,;
	               B99.F02 日期,; 
             	       B99.F03 料號,;
	               B01.F02 品名規格,; 
	               B99.F04 數量,;
	               B99.F13 無價量,;
	               B99.F16 幣別,;
	               B99.F18 匯率,;
	               B99.F17 單價,;
	               B99.F19 金額小計,;
	               B99.F20 發票號碼,;
	               B01.F99 總號,;
	               B99.F07 用途,;
	               B99.F10 備註,;
	               B99.F14 客戶PO,;
	               B99.F15 客戶品號,;
	               B99.F01 單據編號,;
	               BILL(LEFT(B99.F01,2)) 單據類別;
        	       FROM B99,B01 WHERE  B99.F06=LK .AND. B01.F01=B99.F03  NOWAIT
                  ELSE
        	        SELECT B99.F06 對象編號,;
	                B99.F05 對象簡稱,; 
	                B99.F21 部門編號,;
	                B99.F22 部門簡稱,;	            
	                B99.F11 統一編號,;
	                B99.F02 日期,;
        	        B99.F03 料號,;
	                B01.F02 品名規格,; 
	                B99.F04 數量,;
	                B99.F13 無價量,;
	                B99.F20 發票號碼,;
	                B99.F07 用途,;
	                B99.F10 備註,;
	                B99.F14 客戶PO,;
	                B99.F15 客戶品號,;
	                B99.F01 單據編號,;
	                BILL(LEFT(B99.F01,2)) 單據類別;
        	        FROM B99,B01 WHERE  B99.F06=LK .AND. B01.F01=B99.F03  NOWAIT
                  ENDIF	
              ENDIF            
        ENDIF     	
     	GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
	 IF EMPTY(GCDELIMFILE)  && ESC PRESSED
             RETURN
         ELSE	
              ON ERROR DO FILE_IMPACT
              IF _TALLY >0
                   COPY TO (GCDELIMFILE) TYPE XL5   
		   =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗') 
	       ENDIF                             
          ENDIF	
   ELSE
      ******
      *****
      	 IF AREA1<>'B99_2' 	&&依料品編號排列
      	    IF MESSAGEBOX('是否要匯總數量?',4+32+256,'請確認') = 6
                  CH='Y'  
                  SELECT LEFT(B99.F01,2),B99.F03,B01.F02,B99.F04,B99.F13 FROM B99,B01 WHERE  B99.F03=B01.F01  ORDER BY B99.F03 INTO CURSOR B99TP
                  SELECT  B99TP.F03 料號,;
	          B99TP.F02 品名規格,;     
	          SUM(B99TP.F04) 數量,;
	          SUM(B99TP.F13) 無價量,;
	          BILL(LEFT(B99TP.EXP_1,2)) 單據類別;
        	  FROM B99TP ORDER BY B99TP.F02,B99TP.F03,B99TP.EXP_1 GROUP BY B99TP.F03,B99TP.EXP_1 NOWAIT
             ELSE  
             IF A02.F08='*'  &&顯示單價權限
                 CH='N'  
		 CREATE CURSOR B99_TEMP;
		 (日期 D(8),料號 C(43),品名規格 C(40),總號 C(8),對象簡稱 C(8),對象編號 C(5),統一編號 C(8),數量 N(13),單價 N(14,6),金額小計 N(15,3),幣別 C(4),匯率 N(11,6),;
		 發票號碼 C(10),備註 C(30),無價量 N(8),用途 C(50),部門編號 C(5),部門簡稱 C(8),客戶PO C(20),客戶品號 C(30),單據編號 C(10),單據類別 C(15))
		 **出貨單  
		  SELECT * FROM B99 WHERE LEFT(ALLTRIM(B99.F01),2)='BC' ORDER BY B99.F11,B99.F20 INTO CURSOR B99BC
		  SELECT B99BC
		  GO TOP
		  IF _TALLY >0
		      NOTE_LATE=B99BC.F06
		      SUM_F19=0		&&總計金額
	              SUM_ACC_F19=0	&&備註小計
	              DO WHILE !EOF()
		             IF  ALLTRIM(NOTE_LATE)=ALLTRIM(B99BC.F06)
	      		           SELECT B99_TEMP
		      		   APPEND BLANK 
		      		   REPLACE B99_TEMP.日期 WITH B99BC.F02
		      		   REPLACE B99_TEMP.料號 WITH B99BC.F03
		      		   REPLACE B99_TEMP.對象編號 WITH B99BC.F06
		      		   REPLACE B99_TEMP.對象簡稱 WITH B99BC.F05
		      		   REPLACE B99_TEMP.統一編號 WITH B99BC.F11
		      		   REPLACE B99_TEMP.數量 WITH B99BC.F04
		      		   REPLACE B99_TEMP.單價 WITH B99BC.F17
		      		   REPLACE B99_TEMP.金額小計 WITH B99BC.F19
		      		   REPLACE B99_TEMP.幣別 WITH B99BC.F16
		      		   REPLACE B99_TEMP.匯率 WITH B99BC.F18
		      		   REPLACE B99_TEMP.發票號碼 WITH B99BC.F20
		      		   REPLACE B99_TEMP.備註 WITH B99BC.F10
	      		           REPLACE B99_TEMP.無價量 WITH B99BC.F13
		      		   REPLACE B99_TEMP.用途 WITH B99BC.F07
		      		   REPLACE B99_TEMP.部門編號 WITH B99BC.F21
		      		   REPLACE B99_TEMP.部門簡稱 WITH B99BC.F22
		      		   REPLACE B99_TEMP.客戶PO WITH B99BC.F14
		      		   REPLACE B99_TEMP.客戶品號 WITH B99BC.F15
		      		   REPLACE B99_TEMP.單據編號 WITH B99BC.F01
		      		   REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99BC.F03,'B01'),B01.F02,'')
		      		   REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99BC.F03,'B01'),B01.F99,'')
		      		   REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99BC.F01,2))
		      		   SUM_ACC_F19=SUM_ACC_F19+B99BC.F19
		      		   SUM_F19=SUM_F19+B99BC.F19
		      		   NOTE_LATE=B99BC.F06
				   SELECT  B99BC
				   SKIP
		             ELSE
		      		   SELECT B99_TEMP
		      		   APPEND BLANK 
		      		   REPLACE B99_TEMP.統一編號 WITH '備註小計'
		      		   REPLACE B99_TEMP.金額小計 WITH SUM_ACC_F19
		      		   SUM_ACC_F19=0
		      		   SELECT B99_TEMP
		      		   APPEND BLANK 	      		     
		      		   REPLACE B99_TEMP.日期 WITH B99BC.F02
		      		   REPLACE B99_TEMP.料號 WITH B99BC.F03
		      		   REPLACE B99_TEMP.對象編號 WITH B99BC.F06
		      		   REPLACE B99_TEMP.對象簡稱 WITH B99BC.F05
		      		   REPLACE B99_TEMP.統一編號 WITH B99BC.F11
		      		   REPLACE B99_TEMP.數量 WITH B99BC.F04
		      		   REPLACE B99_TEMP.單價 WITH B99BC.F17
		      		   REPLACE B99_TEMP.金額小計 WITH B99BC.F19
		      		   REPLACE B99_TEMP.幣別 WITH B99BC.F16
		      		   REPLACE B99_TEMP.匯率 WITH B99BC.F18
		      		   REPLACE B99_TEMP.發票號碼 WITH B99BC.F20
		      		   REPLACE B99_TEMP.備註 WITH B99BC.F10
		      		   REPLACE B99_TEMP.無價量 WITH B99BC.F13
		      		   REPLACE B99_TEMP.用途 WITH B99BC.F07
		      		   REPLACE B99_TEMP.部門編號 WITH B99BC.F21
		      		   REPLACE B99_TEMP.部門簡稱 WITH B99BC.F22
		      		   REPLACE B99_TEMP.客戶PO WITH B99BC.F14
		      		   REPLACE B99_TEMP.客戶品號 WITH B99BC.F15
		      		   REPLACE B99_TEMP.單據編號 WITH B99BC.F01
		      		   REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99BC.F03,'B01'),B01.F02,'')
		      		   REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99BC.F03,'B01'),B01.F99,'')	 
		      		   REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99BC.F01,2))     		     
		      		   SUM_ACC_F19=SUM_ACC_F19+B99BC.F19
		      		   SUM_F19=SUM_F19+B99BC.F19
		      		   NOTE_LATE=B99BC.F06
				   SELECT  B99BC
				   SKIP		       	          		
	      	             ENDIF	
	      	      ENDDO	
	      	      SELECT B99_TEMP
	      	      APPEND BLANK 
	      	      REPLACE B99_TEMP.統一編號 WITH '備註小計'
	      	      REPLACE B99_TEMP.金額小計 WITH SUM_ACC_F19	      	
		      SELECT B99_TEMP
		      APPEND BLANK 	      	
		      APPEND BLANK 
		      REPLACE B99_TEMP.統一編號 WITH '總計金額'
		      REPLACE B99_TEMP.金額小計 WITH SUM_F19
		      SELECT B99BC
		      USE	
	      	  ENDIF
	      	  ****內購進貨單
		  SELECT * FROM B99 WHERE LEFT(ALLTRIM(B99.F01),2)='BA' ORDER BY B99.F11,B99.F20 INTO CURSOR B99BA
		  SELECT B99BA
		  GO TOP
		  IF _TALLY >0
		      NOTE_LATE=B99BA.F06
		      SUM_F19=0		&&總計金額
	              SUM_ACC_F19=0	&&備註小計
	              DO WHILE !EOF()
		             IF ALLTRIM(NOTE_LATE)=ALLTRIM(B99BA.F06)
	      		         SELECT B99_TEMP
	      		         APPEND BLANK 
		      		 REPLACE B99_TEMP.日期 WITH B99BA.F02
		      		 REPLACE B99_TEMP.料號 WITH B99BA.F03
		      		 REPLACE B99_TEMP.對象編號 WITH B99BA.F06
		      		 REPLACE B99_TEMP.對象簡稱 WITH B99BA.F05
		      		 REPLACE B99_TEMP.統一編號 WITH B99BA.F11
		      		 REPLACE B99_TEMP.數量 WITH B99BA.F04
		      		 REPLACE B99_TEMP.單價 WITH B99BA.F17
		      		 REPLACE B99_TEMP.金額小計 WITH B99BA.F19
		      		 REPLACE B99_TEMP.幣別 WITH B99BA.F16
		      		 REPLACE B99_TEMP.匯率 WITH B99BA.F18
		      		 REPLACE B99_TEMP.發票號碼 WITH B99BA.F20
		      		 REPLACE B99_TEMP.備註 WITH B99BA.F10
		      		 REPLACE B99_TEMP.無價量 WITH B99BA.F13
		      		 REPLACE B99_TEMP.用途 WITH B99BA.F07
		      		 REPLACE B99_TEMP.部門編號 WITH B99BA.F21
		      		 REPLACE B99_TEMP.部門簡稱 WITH B99BA.F22
		      		 REPLACE B99_TEMP.客戶PO WITH B99BA.F14
		      		 REPLACE B99_TEMP.客戶品號 WITH B99BA.F15
		      		 REPLACE B99_TEMP.單據編號 WITH B99BA.F01
		      		 REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99BA.F03,'B01'),B01.F02,'')
		      		 REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99BA.F03,'B01'),B01.F99,'')	  
		      		 REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99BA.F01,2))   		     
		      		 SUM_ACC_F19=SUM_ACC_F19+B99BA.F19
		      		 SUM_F19=SUM_F19+B99BA.F19
		      		 NOTE_LATE=B99BA.F06
				 SELECT  B99BA
				 SKIP
		            ELSE
	      		         SELECT B99_TEMP
	      		         APPEND BLANK 
	      		         REPLACE B99_TEMP.統一編號 WITH '備註小計'
	      		         REPLACE B99_TEMP.金額小計 WITH SUM_ACC_F19
	      		         SUM_ACC_F19=0
	      		         SELECT B99_TEMP
	      		         APPEND BLANK 	      		     
	      		         REPLACE B99_TEMP.日期 WITH B99BA.F02
	      		         REPLACE B99_TEMP.料號 WITH B99BA.F03
	      		         REPLACE B99_TEMP.對象編號 WITH B99BA.F06
	      		         REPLACE B99_TEMP.對象簡稱 WITH B99BA.F05
	      		         REPLACE B99_TEMP.統一編號 WITH B99BA.F11
	      		         REPLACE B99_TEMP.數量 WITH B99BA.F04
	      		         REPLACE B99_TEMP.單價 WITH B99BA.F17
	      		         REPLACE B99_TEMP.金額小計 WITH B99BA.F19
	      		         REPLACE B99_TEMP.幣別 WITH B99BA.F16
	      		         REPLACE B99_TEMP.匯率 WITH B99BA.F18
	      		         REPLACE B99_TEMP.發票號碼 WITH B99BA.F20
	      		         REPLACE B99_TEMP.備註 WITH B99BA.F10
	      		         REPLACE B99_TEMP.無價量 WITH B99BA.F13
	      		         REPLACE B99_TEMP.用途 WITH B99BA.F07
	      		         REPLACE B99_TEMP.部門編號 WITH B99BA.F21
	      		         REPLACE B99_TEMP.部門簡稱 WITH B99BA.F22
	      		         REPLACE B99_TEMP.客戶PO WITH B99BA.F14
	      		         REPLACE B99_TEMP.客戶品號 WITH B99BA.F15
	      		         REPLACE B99_TEMP.單據編號 WITH B99BA.F01
	      		         REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99BA.F03,'B01'),B01.F02,'')
	      		         REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99BA.F03,'B01'),B01.F99,'')	 
	      		         REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99BA.F01,2))	      		     
	      		         SUM_ACC_F19=SUM_ACC_F19+B99BA.F19
	      		         SUM_F19=SUM_F19+B99BA.F19
	      		         NOTE_LATE=B99BA.F06
			         SELECT  B99BA
			         SKIP		       	          		
	      	            ENDIF	
	      	      ENDDO	
	      	      SELECT B99_TEMP
	      	      APPEND BLANK 
	      	      REPLACE B99_TEMP.統一編號 WITH '備註小計'
	      	      REPLACE B99_TEMP.金額小計 WITH SUM_ACC_F19	      	
	      	      SELECT B99_TEMP
	      	      APPEND BLANK 	      	
	      	      APPEND BLANK 
	              REPLACE B99_TEMP.統一編號 WITH '總計金額'
	      	      REPLACE B99_TEMP.金額小計 WITH SUM_F19
	      	      SELECT B99BA
	      	      USE	     
	      	  ENDIF 	
	      	  ****外購進貨單
		  SELECT * FROM B99 WHERE LEFT(ALLTRIM(B99.F01),2)='PB' ORDER BY B99.F06,B99.F10 INTO CURSOR B99PB
		  SELECT B99PB
		  GO TOP
		  IF _TALLY >0
		      NOTE_LATE=LEFT(ALLTRIM(B99PB.F10),6)
	   	      SUM_F19=0		&&總計金額
	              SUM_ACC_F19=0	&&備註小計
	              DO WHILE !EOF()
		             IF  ALLTRIM(NOTE_LATE)=LEFT(ALLTRIM(B99PB.F10),6)
	      		          SELECT B99_TEMP
	      		          APPEND BLANK 
	      		          REPLACE B99_TEMP.日期 WITH B99PB.F02
	      		          REPLACE B99_TEMP.料號 WITH B99PB.F03
	      		          REPLACE B99_TEMP.對象編號 WITH B99PB.F06
	      		          REPLACE B99_TEMP.對象簡稱 WITH B99PB.F05
		      		  REPLACE B99_TEMP.統一編號 WITH B99PB.F11
		      		  REPLACE B99_TEMP.數量 WITH B99PB.F04
		      		  REPLACE B99_TEMP.單價 WITH B99PB.F17
		      		  REPLACE B99_TEMP.金額小計 WITH B99PB.F19
		      		  REPLACE B99_TEMP.幣別 WITH B99PB.F16
		      		  REPLACE B99_TEMP.匯率 WITH B99PB.F18
		      		  REPLACE B99_TEMP.發票號碼 WITH B99PB.F20
		      		  REPLACE B99_TEMP.備註 WITH B99PB.F10
		      		  REPLACE B99_TEMP.無價量 WITH B99PB.F13
		      		  REPLACE B99_TEMP.用途 WITH B99PB.F07
		      		  REPLACE B99_TEMP.部門編號 WITH B99PB.F21
		      		  REPLACE B99_TEMP.部門簡稱 WITH B99PB.F22
		      		  REPLACE B99_TEMP.客戶PO WITH B99PB.F14
		      		  REPLACE B99_TEMP.客戶品號 WITH B99PB.F15
		      		  REPLACE B99_TEMP.單據編號 WITH B99PB.F01
		      		  REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99PB.F03,'B01'),B01.F02,'')
		      		  REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99PB.F03,'B01'),B01.F99,'')	 
		      		  REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99PB.F01,2))	      		     
		      		  SUM_ACC_F19=SUM_ACC_F19+B99PB.F19
		      		  SUM_F19=SUM_F19+B99PB.F19
		      		  NOTE_LATE=LEFT(ALLTRIM(B99PB.F10),6)
				  SELECT  B99PB
			          SKIP
		             ELSE
	      		          SELECT B99_TEMP
	      		          APPEND BLANK 
	      		          REPLACE B99_TEMP.統一編號 WITH '備註小計'
	      		          REPLACE B99_TEMP.金額小計 WITH SUM_ACC_F19
	      		          SUM_ACC_F19=0
	      		          SELECT B99_TEMP
	      		          APPEND BLANK 	      		     
	      		          REPLACE B99_TEMP.日期 WITH B99PB.F02
		      		  REPLACE B99_TEMP.料號 WITH B99PB.F03
		      		  REPLACE B99_TEMP.對象編號 WITH B99PB.F06
		      		  REPLACE B99_TEMP.對象簡稱 WITH B99PB.F05
		      		  REPLACE B99_TEMP.統一編號 WITH B99PB.F11
		      		  REPLACE B99_TEMP.數量 WITH B99PB.F04
		      		  REPLACE B99_TEMP.單價 WITH B99PB.F17
		      		  REPLACE B99_TEMP.金額小計 WITH B99PB.F19
		      		  REPLACE B99_TEMP.幣別 WITH B99PB.F16
		      		  REPLACE B99_TEMP.匯率 WITH B99PB.F18
		      		  REPLACE B99_TEMP.發票號碼 WITH B99PB.F20
		      		  REPLACE B99_TEMP.備註 WITH B99PB.F10
		      		  REPLACE B99_TEMP.無價量 WITH B99PB.F13
		      		  REPLACE B99_TEMP.用途 WITH B99PB.F07
		      		  REPLACE B99_TEMP.部門編號 WITH B99PB.F21
		      		  REPLACE B99_TEMP.部門簡稱 WITH B99PB.F22
		      		  REPLACE B99_TEMP.客戶PO WITH B99PB.F14
		      		  REPLACE B99_TEMP.客戶品號 WITH B99PB.F15
		      		  REPLACE B99_TEMP.單據編號 WITH B99PB.F01
		      		  REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99PB.F03,'B01'),B01.F02,'')
		      		  REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99PB.F03,'B01'),B01.F99,'')	
		      		  REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99PB.F01,2))	      		     
		      		  SUM_ACC_F19=SUM_ACC_F19+B99PB.F19
	      		          SUM_F19=SUM_F19+B99PB.F19
	      		          NOTE_LATE=LEFT(ALLTRIM(B99PB.F10),6)
			          SELECT  B99PB
			          SKIP		       	          		
	      	            ENDIF	
	      	      ENDDO	
	      	      SELECT B99_TEMP
	      	      APPEND BLANK 
	      	      REPLACE B99_TEMP.統一編號 WITH '備註小計'
	      	      REPLACE B99_TEMP.金額小計 WITH SUM_ACC_F19	      	
	      	      SELECT B99_TEMP
	      	      APPEND BLANK 	      	
	      	      APPEND BLANK 
	      	      REPLACE B99_TEMP.統一編號 WITH '總計金額'
	      	      REPLACE B99_TEMP.金額小計 WITH SUM_F19
	      	      SELECT B99PB
	      	      USE	  
	      	  ENDIF 	      	
	          ****其他單據
		  SELECT * FROM B99 WHERE LEFT(ALLTRIM(B99.F01),2)<>'BA'  .AND. LEFT(ALLTRIM(B99.F01),2)<>'BC' .AND.;
		                LEFT(ALLTRIM(B99.F01),2)<>'PB' ORDER BY B99.F06 INTO CURSOR B99OT
		  SELECT B99OT
		  GO TOP
		  IF _TALLY >0
		      DO WHILE !EOF()
	  	             SELECT B99_TEMP
		  	     APPEND BLANK 
		  	     REPLACE B99_TEMP.日期 WITH B99OT.F02
	  		     REPLACE B99_TEMP.料號 WITH B99OT.F03
	  		     REPLACE B99_TEMP.對象編號 WITH B99OT.F06
	  		     REPLACE B99_TEMP.對象簡稱 WITH B99OT.F05
	  		     REPLACE B99_TEMP.統一編號 WITH B99OT.F11
	  		     REPLACE B99_TEMP.數量 WITH B99OT.F04
	  		     REPLACE B99_TEMP.單價 WITH B99OT.F17
	  		     REPLACE B99_TEMP.金額小計 WITH B99OT.F19
	  		     REPLACE B99_TEMP.幣別 WITH B99OT.F16
	  		     REPLACE B99_TEMP.匯率 WITH B99OT.F18
	  		     REPLACE B99_TEMP.發票號碼 WITH B99OT.F20
	  		     REPLACE B99_TEMP.備註 WITH B99OT.F10
	  		     REPLACE B99_TEMP.無價量 WITH B99OT.F13
	  		     REPLACE B99_TEMP.用途 WITH B99OT.F07
	  		     REPLACE B99_TEMP.部門編號 WITH B99OT.F21
	  		     REPLACE B99_TEMP.部門簡稱 WITH B99OT.F22
	  		     REPLACE B99_TEMP.客戶PO WITH B99OT.F14
	  		     REPLACE B99_TEMP.客戶品號 WITH B99OT.F15
	  		     REPLACE B99_TEMP.單據編號 WITH B99OT.F01 
		      	     REPLACE B99_TEMP.品名規格 WITH IIF(SEEK(B99OT.F03,'B01'),B01.F02,'')
		      	     REPLACE B99_TEMP.總號 WITH IIF(SEEK(B99OT.F03,'B01'),B01.F99,'')
		      	     REPLACE B99_TEMP.單據類別 WITH BILL(LEFT(B99OT.F01,2))	  		       
	  		     SELECT B99OT
	  		     SKIP      	          			
	             ENDDO	
	      	     SELECT B99OT
	      	     USE 
	      	  ENDIF   
	     	  GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
		  IF EMPTY(GCDELIMFILE)  && ESC PRESSED
	              RETURN
	          ELSE
                     ON ERROR DO FILE_IMPACT 
                     SELECT B99_TEMP
                     GO TOP
	             COPY TO (GCDELIMFILE) TYPE XL5   
	             =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗')    
	             SELECT B99_TEMP
	             USE             
	          ENDIF		      	  	
             ELSE	&&不顯示單價
        	    CH='Y'  
        	    SELECT  B99.F03 料號,;
	            B01.F02 品名規格,; 
	            B99.F02 日期,;
	            B99.F04 數量,;
	            B99.F13 無價量,;
	            B99.F06 對象編號,;
	            B99.F05 對象簡稱,; 
	            B99.F21 部門編號,;
	            B99.F22 部門簡稱,;	            
	            B99.F11 統一編號,;
	            B99.F20 發票號碼,;
	            B99.F07 用途,;
	            B99.F10 備註,;
	            B99.F14 客戶PO,;
	            B99.F15 客戶品號,;
	            B99.F01 單據編號,;
	            BILL(LEFT(B99.F01,2)) 單據類別;
        	    FROM B99,B01 WHERE  B01.F01=B99.F03  ORDER BY 料號 NOWAIT
             ENDIF
           ENDIF  	      
        ELSE	&&依對象編號排列
             LK=B99_2.F08
             IF MESSAGEBOX('是否要匯總數量?',4+32+256,'請確認') = 6
                  CH='Y'  
                  SELECT LEFT(B99.F01,2),B99.F05,B99.F06,B99.F04,B99.F13 FROM B99  ORDER BY B99.F06 INTO CURSOR B99TP
                  SELECT  B99TP.F06 對象編號,;
	          B99TP.F05 對象簡稱,;    
	          SUM(B99TP.F04) 數量,;
	          SUM(B99TP.F13) 無價量,;
	          BILL(LEFT(B99TP.EXP_1,2)) 單據類別;
        	  FROM B99TP ORDER BY B99TP.F06,B99TP.EXP_1 GROUP BY B99TP.F06,B99TP.EXP_1 NOWAIT    
              ELSE	           
                  IF A02.F08='*'
                      CH='Y'  
             	      SELECT  B99.F06 對象編號,;
	              B99.F05 對象簡稱,; 
	              B99.F21 部門編號,;
	              B99.F22 部門簡稱,;	            
	              B99.F11 統一編號,;
	              B99.F02 日期,;
             	      B99.F03 料號,;
	              B01.F02 品名規格,; 
	              B99.F04 數量,;
	              B99.F13 無價量,;
	              B99.F16 幣別,;
	              B99.F18 匯率,;
	              B99.F17 單價,;
	              B99.F19 金額小計,;
	              B99.F20 發票號碼,;
	              B01.F99 總號,;
	              B99.F07 用途,;
	              B99.F10 備註,;
	              B99.F14 客戶PO,;
	              B99.F15 客戶品號,;
	              B99.F01 單據編號,;
	              BILL(LEFT(B99.F01,2)) 單據類別;
        	      FROM B99,B01 WHERE   B01.F01=B99.F03  ORDER BY 對象編號 NOWAIT
                 ELSE
        	      CH='Y'  
        	      SELECT  B99.F06 對象編號,;
	              B99.F05 對象簡稱,; 
	              B99.F21 部門編號,;
	              B99.F22 部門簡稱,;	            
	              B99.F11 統一編號,;
	              B99.F02 日期,;
        	      B99.F03 料號,;
	              B01.F02 品名規格,; 
	              B99.F04 數量,;
	              B99.F13 無價量,;
	              B99.F20 發票號碼,;
	              B99.F07 用途,;
	              B99.F10 備註,;
	              B99.F14 客戶PO,;
	              B99.F15 客戶品號,;
	              B99.F01 單據編號,;
	              BILL(LEFT(B99.F01,2)) 單據類別;
        	      FROM B99,B01 WHERE  B01.F01=B99.F03  ORDER BY 對象編號 NOWAIT
                 ENDIF	        
             ENDIF    
        ENDIF  
        IF CH='Y'   	
     	     GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
	     IF EMPTY(GCDELIMFILE)  && ESC PRESSED
                 RETURN
             ELSE
                 ON ERROR DO FILE_IMPACT
                 IF _TALLY >0
                     COPY TO (GCDELIMFILE) TYPE XL5   
		    =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗') 
	          ENDIF                             
              ENDIF
         ENDIF	
     ENDIF     
 ENDPROC
ENDDEFINE    
***********************************************列印程序BILL(LEFT(B99.F01,2)) REP_NAME
PROCEDURE PNT_PRC  
STRA=B99.F03
CURA=B99.F06
 IF CH=1
     IF A02.F08<>'*'  &&是否顯示單價
		SELECT B99.F01,B99.F03,B99.F04,B99.F13,B99.F07,B99.F10,B99.F05,;
	    	    B99_1.F04,B99_1.F05,B99_1.F06,B99_1.F07,B99_1.F08,B99_1.F09 FROM B99,B99_1;
	     	    ORDER BY B99.F05,B99.F01 WHERE B99.F03=STRA AND B99_1.F03=STRA NOWAIT
	     IF _TALLY >0
	        REPORT FORM ALLTRIM(INT_116)+'B99A' TO PRINT PROMPT PREVIEW
	     ENDIF  
     ELSE
     	SELECT B99.F01,B99.F03,B99.F04,B99.F13,B99.F07,B99.F10,B99.F05,;
   	  		B99.F16,B99.F17,B99.F18,B99.F19,B99.F20,B99_1.F04,B99_1.F05,B99_1.F06,B99_1.F07,;
   	  		B99_1.F08,B99_1.F09 FROM B99,B99_1  ORDER BY B99.F05,B99.F01 WHERE B99.F03=STRA AND B99_1.F03=STRA NOWAIT
	   IF _TALLY >0
	        REPORT FORM ALLTRIM(INT_116)+'B99B' TO PRINT PROMPT PREVIEW
	   ENDIF  
     ENDIF  
 ELSE
     IF A02.F08<>'*'
         SELECT B99.F01,B99.F03,B99.F04,B99.F13,B99.F07,B99.F10,B99.F05,;
	      		 B99_2.F04,B99_2.F05,B99_2.F06,B99_2.F07,B99_2.F08,B99_2.F09 FROM B99,B99_2;
	      		 ORDER BY B99.F03,B99.F01 WHERE B99.F06=CURA AND B99_2.F03=CURA NOWAIT
	     IF _TALLY >0
	        REPORT FORM ALLTRIM(INT_116)+'B99C' TO PRINT PROMPT PREVIEW
	     ENDIF 
     ELSE
         SELECT B99.F01,B99.F03,B99.F04,B99.F13,B99.F07,B99.F10,B99.F05,;
          		 B99.F16,B99.F17,B99.F18,B99.F19,B99.F20,B99_2.F04,B99_2.F05,B99_2.F06,B99_2.F07,;
          		 B99_2.F08,B99_2.F09 FROM B99,B99_2 ORDER BY B99.F03,B99.F01 WHERE B99.F06=CURA AND B99_2.F03=CURA NOWAIT
	     IF _TALLY >0
	        REPORT FORM ALLTRIM(INT_116)+'B99D' TO PRINT PROMPT PREVIEW
	     ENDIF 
     ENDIF	      
 ENDIF     
ENDPROC
************************************************單據類別     
FUNC BILL
     PARA JUK
     JO=''
     DO CASE
        CASE JUK='PB'
             JO='外購進貨單'
        CASE JUK='BA'
             JO='內購進貨單'
        CASE JUK='BC'
             JO='出貨單        '
        CASE JUK='BB'
             JO='進貨退回單'
        CASE JUK='BD'
             JO='出貨退回單'     
        CASE JUK='BE'
             JO='移轉單        '   
        CASE JUK='BP'
             JO='製令領料單        '       
        CASE JUK='BM'
             JO='委外入庫單         '                    
     ENDCASE
     RETURN JO                 
 ***************計算出貨總數量
 FUNC TOTAL1
     PARA BC_NO
     BC_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BC_NO
     IF FOUND()
        DO WHILE B99.F03=BC_NO            
           IF LEFT(B99.F01,2)='BC'
              BC_OD=BC_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BC_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BC_OD,0) 
  *****
  FUNC TOTAL4
     PARA BC_NO
     BC_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BC_NO
     IF FOUND()
        DO WHILE B99.F06=BC_NO            
           IF LEFT(B99.F01,2)='BC'
              BC_OD=BC_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BC_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BC_OD,0)  
  ***************計算出貨無價數量
 FUNC TOTAL13
     PARA BC_NO
     BC_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BC_NO
     IF FOUND()
        DO WHILE B99.F03=BC_NO            
           IF LEFT(B99.F01,2)='BC'
              BC_OD=BC_OD+F13
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BC_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BC_OD,0) 
  *****
  FUNC TOTAL14
     PARA BC_NO
     BC_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BC_NO
     IF FOUND()
        DO WHILE B99.F06=BC_NO            
           IF LEFT(B99.F01,2)='BC'
              BC_OD=BC_OD+F13
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BC_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BC_OD,0)        
 ***************計算外購進貨總數量
 FUNC TOTAL2
     PARA PB_NO
     PB_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK PB_NO
     IF FOUND()
        DO WHILE B99.F03=PB_NO            
           IF LEFT(B99.F01,2)='PB'
              PB_OD=PB_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       PB_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(PB_OD,0) 
****
  FUNC TOTAL5
     PARA PB_NO
     PB_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK PB_NO
     IF FOUND()
        DO WHILE B99.F06=PB_NO            
           IF LEFT(B99.F01,2)='PB'
              PB_OD=PB_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       PB_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(PB_OD,0)       
     ***************計算移轉總數量
 FUNC TOTAL3
     PARA BE_NO
     BE_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BE_NO
     IF FOUND()
        DO WHILE B99.F03=BE_NO            
           IF LEFT(B99.F01,2)='BE' OR LEFT(B99.F01,2)='BP'
              BE_OD=BE_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BE_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BE_OD,0) 
 ****************
  FUNC TOTAL6
     PARA BE_NO
     BE_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BE_NO
     IF FOUND()
        DO WHILE B99.F06=BE_NO            
           IF LEFT(B99.F01,2)='BE'
              BE_OD=BE_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BE_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BE_OD,0)
  ***************計算內購進貨總數量
 FUNC TOTAL7
     PARA BA_NO
     BA_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BA_NO
     IF FOUND()
        DO WHILE B99.F03=BA_NO            
           IF LEFT(B99.F01,2)$'BABM'
              BA_OD=BA_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BA_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BA_OD,0) 
 *****
  FUNC TOTAL8
     PARA BA_NO
     BA_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BA_NO
     IF FOUND()
        DO WHILE B99.F06=BA_NO            
           IF LEFT(B99.F01,2)$'BABM'
              BA_OD=BA_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BA_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BA_OD,0)
  ***************計算出貨退回總數量
 FUNC TOTAL9
     PARA BD_NO
     BD_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BD_NO
     IF FOUND()
        DO WHILE B99.F03=BD_NO            
           IF LEFT(B99.F01,2)='BD'
              BD_OD=BD_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BD_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BD_OD,0) 
 *****
  FUNC TOTAL10
     PARA BD_NO
     BD_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BD_NO
     IF FOUND()
        DO WHILE B99.F06=BD_NO            
           IF LEFT(B99.F01,2)='BD'
              BD_OD=BD_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BD_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BD_OD,0)  
  ***************計算進貨退回總數量
 FUNC TOTAL11
     PARA BB_NO
     BB_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BB_NO
     IF FOUND()
        DO WHILE B99.F03=BB_NO            
           IF LEFT(B99.F01,2)='BB'
              BB_OD=BB_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BB_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BB_OD,0) 
 *****
  FUNC TOTAL12
     PARA BB_NO
     BB_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BB_NO
     IF FOUND()
        DO WHILE B99.F06=BB_NO            
           IF LEFT(B99.F01,2)='BB'
              BB_OD=BB_OD+F04
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BB_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BB_OD,0) 
  ***************計算進貨退回無價數量
 FUNC TOTAL15
     PARA BB_NO
     BB_OD=0
     SELE B99
     SET ORDER TO 1   && F03 
     SEEK BB_NO
     IF FOUND()
        DO WHILE B99.F03=BB_NO            
           IF LEFT(B99.F01,2)='BB'
              BB_OD=BB_OD+F13
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BB_OD=0
     ENDIF
     SELE B99_1
     RETURN ROUND(BB_OD,0) 
 *****
  FUNC TOTAL16
     PARA BB_NO
     BB_OD=0
     SELE B99
     SET ORDER TO 2   && F06 
     SEEK BB_NO
     IF FOUND()
        DO WHILE B99.F06=BB_NO            
           IF LEFT(B99.F01,2)='BB'
              BB_OD=BB_OD+F13
           ENDIF   
           SKIP
        ENDDO
     ELSE
       BB_OD=0
     ENDIF
     SELE B99_2
     RETURN ROUND(BB_OD,0)                  