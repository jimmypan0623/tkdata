******E09.製令缺料表
close all
clear 
FLG='0'
FCH=''
CHK=''
R=0
AREA1='A14'
AREA2='E16_1'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'B11'
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1   
IF !USED('A14')
   SELE 0
   USE A14 INDE A14
ELSE
   SELE A14
ENDIF
SET FILTER TO F05='*'
SET ORDER TO A141
if !used('B11')
   SELE 0
   USE B11
ELSE
   SELE B11
ENDIF
SET ORDER TO B111     
IF !USED('E16')
   SELECT 0
   USE E16
ELSE
   SELECT E16
ENDIF
SET ORDER TO E166
SELECT F06,F02,SUM(F04),F13 FROM E16 GROUP BY F06,F02 INTO CURSOR E16_2 ORDER BY F06,F02
IF _TALLY>0
    CREATE CURSOR E16_1 (F01 C(5),F03 C(35),F04 N(16,4),TP C(1))
    INDEX ON F01+F03 TAG E16_11
    INDEX ON F03+F01 TAG E16_12
    SET RELATION TO F01+F03 INTO B11 
    SET RELATION TO F03 INTO B01 ADDI
    SET RELATION TO F01 INTO A14 ADDI
    SELECT E16_2
    GO TOP
    DO WHILE !EOF()
       SELECT E16_1
       APPEND BLANK
       REPLACE F01 WITH E16_1.F06
       REPLACE F03 WITH E16_1.F02
       REPLACE F04 WITH SUM_F04
       REPLACE TP WITH E16_1.F13
       SELECT E16_2
       SKIP
    ENDDO
ELSE
   =MESSAGEBOX('無製令領料計劃!',0+48,'提示訊息視窗')
   RETURN    
ENDIF    
E09form=createobject("tkE09")
E09form.show  
define class tkE09 as form
  caption='E09.製令缺料表'
*!*	  autocenter=.t.
  controlbox=.F.
  BORDERSTYLE=1 
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  width=INT_015*789
  windowtype=1
  NAME='TKE09'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='依照部門搜尋紀錄',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT grid1 AS grid1 WITH;
      columncount=2,;            
      RECORDSOURCE='A14',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT grid2 AS grid2 WITH;
      columncount=6,;            
      RECORDSOURCE='E16_1',;
      LINKMASTER='A14',;
      RELATIONALEXPR='F01',;
      CHILDORDER='E16_11',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*415,;
      LEFT=INT_015*10,;
      ENABLED=.T.,;
      VISIBLE=.T.  
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;
      TOP=INT_015*455,;
      LEFT=INT_015*10                            
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*27
          .WIDTH=INT_015*50
          .CAPTION='部門編號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF011','LABEL')     
     WITH THIS.LBLF011
          .VISIBLE=.T.
          .LEFT=INT_015*140
          .TOP=INT_015*27
          .AUTOSIZE=.T.  
     ENDWITH            
     THIS.ADDOBJECT('TXTF01','TEXTBOX')     
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*23
          .WIDTH=INT_015*74
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF01','LABEL')
	WITH THIS.LBLF01  
         .LEFT=INT_015*14
         .TOP=INT_015*13
	     .WIDTH=INT_015*50
         .CAPTION='部門編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF011','LABEL')
    WITH THIS.LBLF011
         .LEFT=INT_015*126
	     .TOP=INT_015*14
	     .autosize=.t.
	ENDWITH     
    THIS.ADDOBJECT('LBLF03','LABEL')
    WITH THIS.LBLF03
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*14
	     .WIDTH=INT_015*50
	     .CAPTION='品        號'
	ENDWITH     
    THIS.ADDOBJECT('LBLF031','Label')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*337
         .TOP=INT_015*14
         .WIDTH=INT_015*144         
    ENDWITH     
    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*39
         .WIDTH=INT_015*50
         .CAPTION='庫存數量'       
    ENDWITH     
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*64
         .WIDTH=INT_015*50
         .CAPTION='已領數量'
    ENDWITH     
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*89
         .WIDTH=INT_015*50
         .CAPTION='未領數量'
    ENDWITH     
    THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*89
        .WIDTH=INT_015*50
        .CAPTION='領用類別'         
    ENDWITH    

	THIS.ADDOBJECT('TXTF01','TEXTBOX')
	WITH THIS.TXTF01      
	     .LEFT=INT_015*65
	     .TOP=INT_015*10
	     .WIDTH=INT_015*60
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=5
	     .NAME='TXTF01'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF03','TEXTBOX')
	WITH THIS.TXTF03
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*10
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=35
	     .NAME='TXTF03'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF04','TEXTBOX')
    WITH THIS.TXTF04
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*35
         .WIDTH=INT_015*120
         .INPUTMASK='99999999999.9999'
         .NAME='TXTF04'
    ENDWITH     
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05     
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*60
         .WIDTH=INT_015*80
         .NAME='TXTF05'
    ENDWITH     
    THIS.ADDOBJECT('TXTF06','TEXTBOX')
    WITH THIS.TXTF06
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*85
         .WIDTH=INT_015*149
         .NAME='TXTF06'                 
    ENDWITH          
    THIS.ADDOBJECT('TXTF08','TEXTBOX')
    WITH THIS.TXTF08
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*85
         .WIDTH=INT_015*80
         .NAME='TXTF08'
    ENDWITH     
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     IF THISFORM.KEY_LIST.DISPLAYVALUE='依部門編號排列'
        SELE A14
     ELSE
        SELE B01
     ENDIF      
     SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE 
        THISFORM.GRID1.ENABLED=.T.           
        THISFORM.GRID1.SETFOCUS                       
     IF THISFORM.GRID1.ACTIVEROW=0
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
     ENDIF   
     THISFORM.KEY_LIST.ENABLED=.T.
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE B11
     THISFORM.GRID2.READONLY=.T.  
     THISFORM.GRID2.SETFOCUS 
     IF THISFORM.GRID2.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF011.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.  
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC   
  PROC INIT              
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.         
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限             
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')             
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146) 
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='部門編號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門名稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='A14.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
*       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(B11.F05>=DATE()-120 .AND. B11.F05<DATE()-90,RGB(255,255,0),IIF(B11.F05<DATE()-120,RGB(255,0,0),''))","COLUMN")                          
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
	   THISFORM.grid2.COLUMN3.HEADER1.CAPTION='庫存數量'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='已領數量'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='預期結餘'
	   THISFORM.grid2.COLUMN6.HEADER1.CAPTION='發料類別'  	      	   
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='E16_1.F03'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='E16_.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B11.F04'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE='B11.F06'
	   THISFORM.grid2.COLUMN6.CONTROLSOURCE='E16_1.F13'
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*63
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*149
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
       THISFORM.grid1.READONLY=.T.    
       THISFORM.grid2.READONLY=.T.       
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.      
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依部門編號排列'       
       JK='部門編號'
       SELE A14
       GO TOP
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A14.F01
       THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=A14.F02
  ENDPROC           
  PROC KEY_LIST.INIT 
       with this 
           .additem('依部門編號排列')
           .additem('依料品編號排列')
       endwith      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE A14
       SET RELA OFF INTO B11
       SELE B01
       SET RELA OFF INTO B11
       SELE B11
       SET RELA OFF INTO A14
       SET RELA OFF INTO B01       
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID1.CHILDORDER=''
       DO CASE
          CASE THIS.DISPLAYVALUE='依部門編號排列'
               THISFORM.PAGEFRAME1.PAGE1.CAPTION='依照部門搜尋紀錄'
               SELE A14
               GO TOP
               AREA1='A14'
               SELE B11
               SET ORDER TO B111     
               SET RELA TO F03 INTO B01       
               THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='部門編號'
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*74
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.MAXLENGTH=5
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A14.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*140
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=A14.F02
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.ENABLED=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF03.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF031.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.ENABLED=.T.
               THISFORM.GRID1.RECORDSOURCE='A14'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='部門編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='A14.F01'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'   
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*50
               THISFORM.GRID2.LINKMASTER='A14'
               THISFORM.GRID2.RELATIONALEXPR='F01'
               THISFORM.GRID2.CHILDORDER='E16_11'            
               THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
               THISFORM.grid2.COLUMN1.CONTROLSOURCE='E16_1.F03'
               THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
               THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
               THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'   
               THISFORM.grid2.COLUMN2.WIDTH=INT_015*100                     
          CASE THIS.DISPLAYVALUE='依料品編號排列'
               THISFORM.PAGEFRAME1.PAGE1.CAPTION='依照料號搜尋紀錄'          
               SELE B01
               GO TOP
               AREA1='E16_1'
               SELE E16_1
               SET ORDER TO E16_12
               SET RELA TO F01 INTO A14
               THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='料品編號'
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*261
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.MAXLENGTH=35
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B01.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*337
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B01.F02
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.ENABLED=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF03.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF031.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.ENABLED=.F.                
               THISFORM.GRID1.RECORDSOURCE='E16_1'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料品編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='E16_1.F03'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01.F02'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149   
               THISFORM.GRID2.LINKMASTER='B01'
               THISFORM.GRID2.RELATIONALEXPR='F01'
               THISFORM.GRID2.CHILDORDER='B112'  
               THISFORM.grid2.COLUMN1.HEADER1.CAPTION='部門編號'
               THISFORM.grid2.COLUMN1.CONTROLSOURCE='E16_1.F06'
               THISFORM.grid2.COLUMN1.WIDTH=INT_015*50               
               THISFORM.grid2.COLUMN2.HEADER1.CAPTION='部門名稱'
               THISFORM.grid2.COLUMN2.CONTROLSOURCE='A14.F02'       
               THISFORM.grid2.COLUMN2.WIDTH=INT_015*50                                        
       ENDCASE 
        THISFORM.PAGEFRAME1.ACTIVEPAGE=2
        THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE &AREA1
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       IF THISFORM.KEY_list.DISPLAYVALUE='依部門編號排列'
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A14.F01
          THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=A14.F02
       ELSE          
          THISFORM.PAGEFRAME1.page1.TXTF01.VALUE=E16_1.F02
          THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B01.F02
       ENDif

       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF01.VALUE=E16_1.F06
       THISFORM.PAGEFRAME1.PAGE2.LBLF011.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=E16_1.F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=E16_1.F04
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=B11.F04
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=B11.F06
       THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=E16_1.F13
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       if thisform.pageframe1.activepage=1
          thisform. CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
  ENDPROC 
ENDDEFINE    


************************************************************
PROCEDURE PNT_PRC  
   CREATE CURSOR INVRT;
   (F01 C(5),F02 C(35),FIN N(16,4),FQY N(16,4),FND N(16,4),RTE N(11,6))
   INDEX ON F01+F02 TAG INVRT
   B25='B25'+LEFT(DTOS(DATE()),6)   &&本月庫存月報表檔
   IF !USED('&B25')
       SELE 0
       USE (B25) ALIA B25 INDE (B25) 
   ELSE
       SELE B25
   ENDIF
   SET ORDER TO 1     
  GO TOP
  DO WHILE !EOF()
         SELECT INVRT
         APPEND BLANK
         REPLACE FIN  WITH B25.F03
         REPLACE F01 WITH B25.F01
         REPLACE F02 WITH B25.F02
         REPLACE FQY WITH B25.F05+B25.F06+B25.F09+B25.F11+B25.F14+B25.F17+B25.F19+B25.F20
         REPLACE FND WITH B25.F15
         SELECT B25
         SKIP
  ENDDO
  SELECT B25
  USE
  USE A23
  SET ORDER TO 1
  SEEK LEFT(DTOS(DATE()),6)+'01'
  SKIP -1 
  IF !BOF()  
      B25='B25'+LEFT(DTOS(F01),6)
      IF !USED('&B25')
           SELE 0
          USE (B25) ALIA B25 INDE (B25) 
      ELSE
          SELE B25
      ENDIF
      SET ORDER TO 1      
      SELECT INVRT
      GO TOP
      DO WHILE !EOF()
             SELECT B25
             SEEK INVRT.F01+INVRT.F02
             IF FOUND()
                 SELECT INVRT
                 REPLACE FIN  WITH B25.F03
                 REPLACE FQY WITH FQY+(B25.F05+B25.F06+B25.F09+B25.F11+B25.F14+B25.F17+B25.F19+B25.F20)
                 REPLACE FND WITH FND+B25.F15        
             ELSE
                SELECT INVRT
                REPLACE FIN WITH 0             
             ENDIF     
             SELECT INVRT
             SKIP
      ENDDO
      SELECT B25
      USE
      SELECT A23
      SKIP -1
      IF BOF()
          USE
      ELSE
          B25='B25'+LEFT(DTOS(F01),6)
          IF !USED('&B25')
               SELE 0
              USE (B25) ALIA B25 INDE (B25) 
          ELSE
              SELE B25
          ENDIF
          SET ORDER TO 1      
          SELECT INVRT
          GO TOP
          DO WHILE !EOF()
                 SELECT B25
                 SEEK INVRT.F01+INVRT.F02
                 IF FOUND()
                     SELECT INVRT
                     REPLACE FIN  WITH B25.F03
                     REPLACE FQY WITH FQY+(B25.F05+B25.F06+B25.F09+B25.F11+B25.F14+B25.F17+B25.F19+B25.F20)
                     REPLACE FND WITH FND+B25.F15    
                 ELSE
                     SELECT INVRT
                     REPLACE FIN WITH 0                                      
                 ENDIF     
                 SELECT INVRT
                 SKIP
          ENDDO
          SELECT B25
          USE      
          SELECT A23
          USE      
      ENDIF    
  ELSE
       SELECT A23
       USE
  ENDIF
  SELECT INVRT
  REPLACE RTE WITH FQY/IIF(FIN+FND<>0,(FIN+FND)/4,1)  ALL
  LK=A14.F01
  if messagebox('是否只印呆滯料?',4+32+256,'請確認')=6	        
              FLG='0'

            ANS_RANGE=CREATEOBJECT("ANS_RANGE")  
            ANS_RANGE.SHOW    
            IF FLG<>'1'
               =MESSAGEBOX('無此範圍資料',0+48,'警示')
            ENDIF   
            FLG='0'     
*!*	     SELE B11.F01,;
*!*	          B11.F03,;
*!*	          B11.F04,;
*!*	          B11.F05,;
*!*	          A14.F02,;
*!*	          B01.F02,;
*!*	          B01.F37;
*!*	     FROM B11,A14,B01 WHERE B11.F01=LK AND B11.F04<>0 AND A14.F01=B11.F01 AND B01.F01=B11.F03 AND DATE()-B11.F05>90 ORDER BY B11.F03 NOWAIT
  ELSE
     SELE B11.F01,;
          B11.F03,;
          B11.F04,;
          B11.F05,;
          A14.F02,;
          B01.F02,;
          B01.F37;
        FROM B11,A14,B01 WHERE B11.F01=LK AND B11.F04<>0 AND A14.F01=B11.F01 AND B01.F01=B11.F03  ORDER BY B11.F03 NOWAIT 
     IF _TALLY>0
        FILE_NAME='B11庫存明細'
        CALC SUM(F04*F37) TO TMP1
        REPORT FORM ALLTRIM(INT_116)+'B11' TO PRINT PROMPT PREVIEW       
              IF  ALLTRIM(A02.F08)='*'    &&如果可以看成本的話
                   SELECT B11.F01 部門編號,A14.F02 部門名稱,B11.F03 料號,B01.F02 品名規格,B11.F04 庫存數量,B01.F37 成本單價,B11.F05 最後異動日,LEFT(B11.F06,10) 請購單,B11.F06 用途,DATE()-B11.F05 呆滯天數,INVRT.RTE 存貨週轉率 FROM B11,B01,A14,INVRT;
                   WHERE B11.F01=LK AND B01.F01=B11.F03 AND A14.F01=B11.F01 AND INVRT.F01+INVRT.F02=B11.F01+B11.F03 INTO CURSOR B11A ORDER BY B11.F01,B11.F03 NOWAIT
                    SELECT B11A
                    COPY TO  &FILE_NAME TYPE XL5
                    SELECT B11A 
                    USE 
               ELSE
                   SELECT B11.F01 部門編號,A14.F02 部門名稱,B11.F03 料號,B01.F02 品名規格,B11.F04 庫存數量,B11.F05 最後異動日,LEFT(B11.F06,10) 請購單,B11.F06 用途,DATE()-B11.F05 呆滯天數,INVRT.RTE 存貨週轉率 FROM B11,B01,A14,INVRT ;
                   WHERE B11.F01=LK AND B01.F01=B11.F03 AND A14.F01=B11.F01 AND INVRT.F01+INVRT.F02=B11.F01+B11.F03 INTO CURSOR B11A ORDER BY B11.F01,B11.F03 NOWAIT
                    SELECT B11A
                    COPY TO  &FILE_NAME TYPE XL5
                    SELECT B11A 
                    USE                             
              ENDIF                      
     ENDIF                   
  ENDIF    

ENDPROC
***********************************************呆滯天數範圍選定
DEFINE CLASS ANS_RANGE AS FORM
  AUTOCENTER=.T.
  CAPTION='請庫存呆滯條件定義'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*190
  WIDTH=INT_015*250
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_RANGE'
  ADD OBJECT LABELA AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*10,;
      TOP=INT_015*25,;
      NAME='LABELA',;
      CAPTION='輸入呆滯天數'  
  ADD OBJECT LABELB AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*80,;
      TOP=INT_015*65,;
      NAME='LABELB',;
      CAPTION='而且'            
  ADD OBJECT LABELC AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*10,;
      TOP=INT_015*105,;
      NAME='LABELC',;
      CAPTION='三個月存貨週轉率低於'        
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*132,;
      TOP=INT_015*25,;
      NAME='LABEL1',;
      CAPTION='天'
  ADD OBJECT LABEL2 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*222,;
      TOP=INT_015*25,;
      NAME='LABEL2',;
      CAPTION='天'
  ADD OBJECT LABEL3 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*150,;
      TOP=INT_015*25,;
      NAME='LABEL3',;
      CAPTION='∼'      
  ADD OBJECT TEXT1 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*20,;
      LEFT=INT_015*90,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*40,;
      INPUTMASK='9999',;
      ALIGNMENT=3,;
      NAME='TEXT1'
  ADD OBJECT TEXT2 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*20,;
      LEFT=INT_015*180,;
      HEIGHT=INT_015*25,;        
      WIDTH=INT_015*40,;      
      INPUTMASK='9999',;
      ALIGNMENT=3,;            
      NAME='TEXT2'          
  ADD OBJECT TEXT3 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*100,;
      LEFT=INT_015*140,;
      HEIGHT=INT_015*25,;        
      WIDTH=INT_015*80,;      
      INPUTMASK='9999.999999',;
      ALIGNMENT=3,;            
      NAME='TEXT3'                
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*40,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*144,;  
      WIDTH=INT_015*80,;
      CAPTION='\<Y.執行',;
      TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*120,;
      TOP=INT_015*144,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'
    PROCEDURE INIT 
          THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
           THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')      
           THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')
           THISFORM.TEXT1.VALUE=1
           THISFORM.TEXT2.VALUE=1
           THISFORM.TEXT3.VALUE=1           

    ENDPROC
*!*	       PROCEDURE TEXT1.VALID
*!*	            LPARAMETERS  NINDEX
*!*	           IF THIS.VALUE>59
*!*	                NINDEX=.T.
*!*	           ELSE
*!*	             =MESSAGEBOX("低於60天不算呆滯料",0+64,"提示視窗")    
*!*	             NINDEX=.F.
*!*	          ENDIF
*!*	         RETURN NINDEX
*!*	       ENDPROC        
       PROCEDURE TEXT2.VALID
            LPARAMETERS  NINDEX
           IF THIS.VALUE>=THISFORM.TEXT1.VALUE
                NINDEX=.T.
           ELSE
             =MESSAGEBOX("不得小於起始天數",0+64,"提示視窗")    
             NINDEX=.F.
          ENDIF
         RETURN NINDEX
       ENDPROC               
       PROCEDURE CMND1.CLICK
           SELE B11.F01,;
          B11.F03,;
          B11.F04,;
          B11.F05,;
          A14.F02,;
          B01.F02,;
          B01.F37,;
          INVRT.RTE;
          FROM B11,A14,B01,INVRT WHERE B11.F01=LK AND B11.F04<>0 AND A14.F01=B11.F01 AND B01.F01=B11.F03 AND DATE()-B11.F05>=THISFORM.TEXT1.VALUE;
          AND DATE()-B11.F05<=THISFORM.TEXT2.VALUE  AND INVRT.RTE<THISFORM.TEXT3.VALUE AND INVRT.F01+INVRT.F02=B11.F01+B11.F03 ORDER BY B11.F03 NOWAIT
          IF _TALLY>0
              FLG='1'
              CALC SUM(F04*F37) TO TMP1
              REPORT FORM ALLTRIM(INT_116)+'B11' TO PRINT PROMPT PREVIEW                
              FILE_NAME='B11庫存明細'
              IF  ALLTRIM(A02.F08)='*'    &&如果有權限看成本的話
                   SELECT B11.F01 部門編號,A14.F02 部門名稱,B11.F03 料號,B01.F02 品名規格,B11.F04 庫存數量,B01.F37 成本單價,B11.F05 最後異動日,LEFT(B11.F06,10) 請購單,B11.F06 用途,DATE()-B11.F05 呆滯天數,INVRT.RTE 存貨週轉率 FROM B11,B01,A14,INVRT ;
                   WHERE B11.F01=LK AND  DATE()-B11.F05>=THISFORM.TEXT1.VALUE AND DATE()-B11.F05<=THISFORM.TEXT2.VALUE AND B01.F01=B11.F03 AND A14.F01=B11.F01  AND INVRT.RTE<THISFORM.TEXT3.VALUE AND INVRT.F01+INVRT.F02=B11.F01+B11.F03 INTO CURSOR B11A ORDER BY B11.F01,B11.F03 NOWAIT
                    SELECT B11A
                    COPY TO  &FILE_NAME TYPE XL5
                    SELECT B11A 
                    USE 
               ELSE
                   SELECT B11.F01 部門編號,A14.F02 部門名稱,B11.F03 料號,B01.F02 品名規格,B11.F04 庫存數量,B11.F05 最後異動日,LEFT(B11.F06,10) 請購單,B11.F06 用途,DATE()-B11.F05 呆滯天數,INVRT.RTE 存貨週轉率 FROM B11,B01,A14,INVRT ;
                   WHERE B11.F01=LK AND DATE()-B11.F05>=THISFORM.TEXT1.VALUE AND DATE()-B11.F05<=THISFORM.TEXT2.VALUE AND B01.F01=B11.F03 AND A14.F01=B11.F01  AND INVRT.RTE<THISFORM.TEXT3.VALUE AND INVRT.F01+INVRT.F02=B11.F01+B11.F03 INTO CURSOR B11A ORDER BY B11.F01,B11.F03 NOWAIT
                    SELECT B11A
                    COPY TO  &FILE_NAME TYPE XL5
                    SELECT B11A 
                    USE                             
              ENDIF              
          ENDIF
          THISFORM.CMND2.CLICK
       ENDPROC
       PROCEDURE CMND2.CLICK
                 FLG='1'   
                THISFORM.RELEASE                   
       ENDPROC                 
ENDDEFINE  
