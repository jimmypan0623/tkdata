***程式名稱:B04.出貨單
CLOSE ALL
CLEAR 
PO_NO=''
FLG='0'
FCH=''
CHK=''
CHK_STR=''
UKEF=''
FILTER_KEY=''
R=0
QTY=0
TQTY=0
FTTL=0
MTH_TTL=0
AREA1='B04_1'
AREA2='B04'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1      
B25='B25'+LEFT(DTOS(DATE()),6)    &&部門別月報表
IF !USED('&B25')
   SELE 0
   USE (B25) ALIA B25
ELSE
   SELE B25
ENDIF
SET ORDER TO 1      
B26='B26'+LEFT(DTOS(DATE()),6)   &&庫存異動記錄
IF !USED('&B26')
   SELE 0
   USE (B26) ALIA B26
ELSE
   SELE B26
ENDIF
SET ORDER TO 1      
B39='B39'+LEFT(DTOS(DATE()),6)   &&未過帳單據查詢檔
IF !USED('&B39')
   SELE 0
   USE (B39) ALIA B39
ELSE
   SELE B39
ENDIF
SET ORDER TO 1      
C10='C10'+LEFT(DTOS(DATE()),6)   &&出貨日報表檔
C105='C105'+LEFT(DTOS(DATE()),6)   &&出貨日報表檔
IF !USED('&C10')
   SELE 0
   USE (C10) ALIA C10
ELSE
   SELE C10
ENDIF
SET ORDER TO C105                
IF !USED('C06')                  &&出貨紀錄檔   
   SELE 0
   USE C06
ELSE
   SELE C06
ENDIF
SET ORDER TO 1      
C13='C13'+LEFT(DTOS(DATE()),6)   &&應收帳款對帳單檔
IF !USED('&C13')
   SELE 0
   USE (C13) ALIA C13
ELSE
   SELE C13
ENDIF
SET ORDER TO 1
IF !USED('C39')
    SELE 0
    USE C39
ELSE 
   SELE C39
ENDIF
SET ORDER TO C391  
IF !USED('K51')
   SELE 0
   USE K51 
ELSE 
   SELE K51 
ENDIF
SET ORDER TO K511
K24='K24'+LEFT(DTOS(DATE()),6)     &&發票明細檔表頭
K241='K241'+LEFT(DTOS(DATE()),6)
K242='K242'+LEFT(DTOS(DATE()),6)
IF !USED('&K24')
    SELE 0
    USE (K24) ALIA K24
ELSE
    SELE K24
ENDIF
SET ORDER TO K241   
K25='K25'+LEFT(DTOS(DATE()),6)   &&發票明細檔
K254='K254'+LEFT(DTOS(DATE()),6)
IF !USED('&K25')
   SELE 0
   USE (K25) ALIA K25
ELSE
   SELE K25
ENDIF
SET ORDER TO K254
****         
SELE A23
SET ORDER TO 1
SEEK LEFT(DTOS(DATE()),6)+'01'
SKIP
IF !EOF()
   C1C='C13'+LEFT(DTOS(A23.F01),6)     &&下個月的應收帳款明細檔
   IF !USED('&C1C')
      SELE 0
      USE (C1C) ALIA C1C
   ELSE
      SELE C1C
   ENDIF
   SET ORDER TO 1
   K2D='K24'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔表頭
   IF !USED('&K2D')
      SELE 0
      USE (K2D) ALIA K2D
   ELSE
      SELE K2D
   ENDIF
   SET ORDER TO 1    
   K2E='K25'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔表身
   IF !USED('&K2E')
      SELE 0
      USE (K2E) ALIA K2E
   ELSE
      SELE K2E
   ENDIF
   SET ORDER TO 4   
ELSE
   IF !USED('C1C')                    &&應收帳款明細月結暫存檔
      SELE 0
      USE C1C ALIA C1C
   ELSE
      SELE C1C
   ENDIF
   SET ORDER TO 1
   IF !USED('K2D')                    &&發票明細月結暫存檔表頭
      SELE 0
      USE K2D ALIA K2D
   ELSE
      SELE K2D
   ENDIF
   SET ORDER TO 1     
   IF !USED('K2E')                    &&發票明細月結暫存檔表身
      SELE 0
      USE K2E ALIA K2E
   ELSE
      SELE K2E
   ENDIF
   SET ORDER TO 1   
ENDIF    
****              
IF !USED('C0Z')                  &&幣別日期檔
   SELE 0
   USE C0Z
ELSE
   SELE C0Z
ENDIF
SET ORDER TO 1
IF !USED('C00')                  &&幣別檔
   SELE 0
   USE C00
ELSE
   SELE C00
ENDIF
SET ORDER TO 1
*!*	SET ORDER TO 1
*!*	IF !USED('K76')                  &&營運傳票設定檔
*!*	   SELE 0
*!*	   USE K76
*!*	ELSE
*!*	   SELE K76
*!*	ENDIF
*!*	SET ORDER TO 1      
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'B04'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET FILTER TO F04='*' AND F13='*'
SET ORDER TO 1     
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1     

IF !USED('B11')
   SELE 0
   USE B11 INDE B11
ELSE
   SELE B11
ENDIF
SET ORDER TO B111  
IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011
IF !USED('C05')
   SELE 0   
   USE C05
ELSE
   SELE C05
ENDIF
SET ORDER TO C054
SET FILTER TO !EMPTY(ALLTRIM(F15))
IF !USED('C03')
   SELE 0
   USE C03 INDE C03
ELSE
   SELE C03
ENDIF
SET ORDER TO C031
IF !USED('C04')
   SELE 0
   USE C04 INDE C04
ELSE
   SELE C04
ENDIF
SET ORDER TO C041
IF !USED('C22')
    SELE 0
    USE C22
ELSE
    SELE C22
ENDIF
SET ORDER TO C223       
B04='B04'+LEFT(DTOS(DATE()),6)
B041='B041'+LEFT(DTOS(DATE()),6)
IF !USED('&B04')
   SELE 0
   USE (B04) ALIA B04
ELSE
   SELE B04
ENDIF
SET ORDER TO 1      
CALCULATE SUM(F17) TO MTH_TTL
SET RELA TO F03 INTO B01
SET RELATION TO F05 INTO A14 ADDITIVE
SET RELATION TO F05+F79+SPACE(5) INTO B11 ADDITIVE 
CREATE CURSOR B04_1;
(F01 C(10),F02 C(2),F05 C(5),F06 C(5),F08 C(1),F09 C(5),F10 C(1),F11 C(17),F20 C(10),F21 C(60),F22 C(2),F23 C(1),F24 C(80),F90 C(17))
INDE ON F01 TAG B04_11
INDE ON F06+F01 TAG B04_12
INDEX ON F20 TAG B04_13
SELE F01,F02,F05,F06,F08,F09,F10,F11,F20,F21,F22,F23,F24,F90 FROM B04 GROUP BY F01 ORDER BY F01 INTO CURSOR B04_2
SELE B04_2
GO TOP
DO WHILE !EOF()
   SELE B04_1
   APPEND BLANK
   REPL F01 WITH B04_2.F01
   REPL F02 WITH B04_2.F02
   REPL F05 WITH B04_2.F05
   REPL F06 WITH B04_2.F06
   REPL F08 WITH B04_2.F08
   REPL F09 WITH B04_2.F09
   REPL F10 WITH B04_2.F10
   REPL F11 WITH B04_2.F11
   REPL F20 WITH B04_2.F20
   REPL F21 WITH B04_2.F21
   REPL F22 WITH B04_2.F22
   REPL F23 WITH B04_2.F23
   REPL F24 WITH B04_2.F24
   REPL F90 WITH B04_2.F90
   SELE B04_2
   SKIP   
ENDDO
SELE B04_2
USE   
SELE B04_1
SET ORDER TO 1
SET RELA TO F06 INTO C01
B04FORM=CREATEOBJECT("TKB04")
B04FORM.SHOW  
DEFINE CLASS TKB04 AS FORM
  CAPTION='B04.出貨單'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*791
  WINDOWTYPE=1
  NAME='TKB04'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
*  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
*  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
*!*	  ADD OBJECT PASS_CND AS LABEL WITH;
*!*	      LEFT=INT_015*60,;
*!*	      TOP=INT_015*520,;
*!*	      AUTOSIZE=.T.      
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*(200+IIF(INT_029,25,0)),;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;   
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=3,;            
      RECORDSOURCE='B04_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3'     
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=9,;            
      RECORDSOURCE='B04',; 
      LINKMASTER='B04_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER=B041,;  
      TOP=INT_015*(202+IIF(INT_029,25,0)) ,; &&如果出貨料與實際料有異
      HEIGHT=INT_015*(318-IIF(INT_029,25,0)),;   &&如果出貨料與實際料有異
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7',;
      COLUMN8.NAME='COLUMN8',;
      COLUMN9.NAME='COLUMN9'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*165,;
      LEFT=INT_015*570          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*11,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;         
      TOOLTIPTEXT='將資料過入庫存及帳款中!快速鍵->ALT+A',;
      CAPTION='\<A.過帳',;
      NAME='ANS_BOTT' 
  ADD OBJECT VRT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*53,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;   
      TOOLTIPTEXT='將已過入庫存及帳款之資料轉回未過帳狀態!快速鍵->ALT+V',;      
      CAPTION='\<V.反過帳',;
      NAME='VRT_BOTT'       
  ADD OBJECT TRN_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*110,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*75,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;         
      CAPTION='\<T.轉INVOICE',;
      TOOLTIPTEXT='將此張出貨單轉入C22 INVOICE!快速鍵->ALT+T',;
      NAME='TRN_BOTT'                                                 
  ADD OBJECT XLS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*188,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*40,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;         
      CAPTION='XLS',;
      TOOLTIPTEXT='將此張出貨單轉入EXCEL檔',;
      NAME='XLS_BOTT'                             

  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*8
          .WIDTH=INT_015*50
          .CAPTION='出貨單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*33
         .WIDTH=INT_015*50
         .CAPTION='客戶編號'
     ENDWITH
     THIS.ADDOBJECT('LBLF061','LABEL')
     WITH THIS.LBLF061
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*33
         .AUTOSIZE=.T.
     ENDWITH   
     THIS.ADDOBJECT('LBLF05','LABEL')
     WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*58
         .WIDTH=INT_015*50
         .CAPTION='預設部門'
     ENDWITH    
     THIS.ADDOBJECT('LBLF051','LABEL')
     WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*58
         .AUTOSIZE=.T. 
     ENDWITH 
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*184
         .TOP=INT_015*58
         .WIDTH=INT_015*50
         .CAPTION='業務擔當'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*285
         .TOP=INT_015*58
         .AUTOSIZE=.T. 
     ENDWITH    
     THIS.ADDOBJECT('LBLF20','LABEL')
     WITH THIS.LBLF20
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*83
         .WIDTH=INT_015*50
         .CAPTION='發票號碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF221','LABEL')
     WITH THIS.LBLF221
         .VISIBLE=.T.
         .LEFT=INT_015*151
         .TOP=INT_015*83
         .AUTOSIZE=.T.
         .CAPTION='三聯式'
     ENDWITH          
     THIS.ADDOBJECT('LBLF231','LABEL')
     WITH THIS.LBLF231
         .VISIBLE=.T.
         .LEFT=INT_015*234
         .TOP=INT_015*83
         .AUTOSIZE=.T.
         .CAPTION='應稅'
     ENDWITH                        
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*286
         .TOP=INT_015*83
         .AUTOSIZE=.T.
     ENDWITH   
    THIS.ADDOBJECT('LBLF24','LABEL')
     WITH THIS.LBLF24
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*108
         .WIDTH=INT_015*50
         .CAPTION='出貨指示'
     ENDWITH                           
     THIS.ADDOBJECT('LBLF21','LABEL')
     WITH THIS.LBLF21
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*133
         .WIDTH=INT_015*50
         .CAPTION='備        註'
     ENDWITH    
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*8
         .WIDTH=INT_015*50
         .CAPTION='出貨日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLTTL3','LABEL')
     WITH THIS.LBLTTL3
         .VISIBLE=(A02.F10='*')
         .LEFT=INT_015*365
         .TOP=INT_015*33
         .WIDTH=INT_015*63
         .CAPTION='原幣別總計'
     ENDWITH              
     THIS.ADDOBJECT('LBLTTL31','LABEL')
     WITH THIS.LBLTTL31
         .VISIBLE=(A02.F10='*')
         .LEFT=INT_015*429
         .TOP=INT_015*33
         .AUTOSIZE=.T.
     ENDWITH                        
     THIS.ADDOBJECT('LBLTTL1','LABEL')
     WITH THIS.LBLTTL1
         .VISIBLE=(A02.F10='*')
         .LEFT=INT_015*365
         .TOP=INT_015*58
         .WIDTH=INT_015*63
         .CAPTION='本幣別總計'
     ENDWITH              
     THIS.ADDOBJECT('LBLTTL11','LABEL')
     WITH THIS.LBLTTL11
         .VISIBLE=(A02.F10='*')
         .LEFT=INT_015*429
         .TOP=INT_015*58
         .AUTOSIZE=.T.
     ENDWITH                        
     THIS.ADDOBJECT('LBLTTL2','LABEL')
     WITH THIS.LBLTTL2
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*83
         .WIDTH=INT_015*50
         .CAPTION='數量總計'
     ENDWITH              
     THIS.ADDOBJECT('LBLTTL21','LABEL')
     WITH THIS.LBLTTL21
         .VISIBLE=.T.
         .LEFT=INT_015*429
         .TOP=INT_015*83
         .AUTOSIZE=.T.
     ENDWITH                             
     THIS.ADDOBJECT('LBLF11','LABEL')
     WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*135
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF111','LABEL')
     WITH THIS.LBLF111
         .VISIBLE=.T.
         .LEFT=INT_015*429
         .TOP=INT_015*135
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*378
         .TOP=INT_015*160
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*429
         .TOP=INT_015*160
         .AUTOSIZE=.T.
     ENDWITH         
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*160
         .WIDTH=INT_015*50
         .CAPTION='過  帳  碼'
     ENDWITH    
     THIS.ADDOBJECT('PASS_CND','LABEL')
     WITH THIS.PASS_CND
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*160
         .AUTOSIZE=.T.
     ENDWITH         
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*4
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*428
          .TOP=INT_015*4
          .WIDTH=INT_015*40
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH        

     THIS.ADDOBJECT('TXTF06','TXTF06')          
     WITH THIS.TXTF06
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*29
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25        
          .MAXLENGTH=5
     ENDWITH 
     THIS.ADDOBJECT('TXTF05','TXTF05')          
     WITH THIS.TXTF05
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*54
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25        
          .MAXLENGTH=5
     ENDWITH               
     THIS.ADDOBJECT('TXTF09','TXTF09')          
     WITH THIS.TXTF09
          .VISIBLE=.T.
          .LEFT=INT_015*234
          .TOP=INT_015*54
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25        
          .MAXLENGTH=5
     ENDWITH     
     THIS.ADDOBJECT('TXTF20','TXTF20')          
     WITH THIS.TXTF20
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*79
          .WIDTH=INT_015*85
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH     
     THIS.ADDOBJECT('INV_TYPE','INV_TYPE')     
     THIS.ADDOBJECT('TAX_TYPE','TAX_TYPE')           
     THIS.ADDOBJECT('CUS_TYPE','CUS_TYPE')                     
     THIS.ADDOBJECT('TXTF24','TEXTBOX')
     WITH THIS.TXTF24     
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*104
          .WIDTH=INT_015*454
          .HEIGHT=INT_015*25
          .MAXLENGTH=80 
     ENDWITH           
     THIS.ADDOBJECT('TXTF21','TEXTBOX')     
     WITH THIS.TXTF21
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*129
          .WIDTH=INT_015*250
          .HEIGHT=INT_015*25
          .MAXLENGTH=60
     ENDWITH      
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF03','LABEL')
	WITH THIS.LBLF03  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF031','LABEL')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*18
	     .AUTOSIZE=.T.
	ENDWITH   
    THIS.ADDOBJECT('LBLF07','LABEL')
    WITH THIS.LBLF07
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*43
	     .WIDTH=INT_015*50
	     .CAPTION='訂單編號'
	ENDWITH  
     THIS.ADDOBJECT('LBLF05','LABEL')     
     WITH THIS.LBLF05
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*68
          .WIDTH=INT_015*50  
          .CAPTION='出貨部門'
     ENDWITH            
     THIS.ADDOBJECT('LBLF051','LABEL')     
     WITH THIS.LBLF051
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*68
          .AUTOSIZE=.T.
     ENDWITH   
    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='計價數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF13','LABEL')
    WITH THIS.LBLF13
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='無價數量'       
    ENDWITH    
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*143
         .WIDTH=INT_015*50
         .CAPTION='備註資料'
    ENDWITH             
    THIS.ADDOBJECT('LBLF79','LABEL')
    WITH THIS.LBLF79
         .VISIBLE=INT_029       
         .LEFT=INT_015*14
         .TOP=INT_015*168
         .WIDTH=INT_015*50
         .CAPTION='實際料號'
    ENDWITH                 
    THIS.ADDOBJECT('LBLF7911','LABEL')
    WITH THIS.LBLF7911
         .VISIBLE=INT_029       
         .LEFT=INT_015*394
         .TOP=INT_015*168
         .AUTOSIZE=.T.
         .CAPTION='在庫數量'
    ENDWITH                 
    THIS.ADDOBJECT('LBLF14','LABEL')    
    WITH THIS.LBLF14
         .VISIBLE=.F.           
         .LEFT=INT_015*328
         .TOP=INT_015*43
         .WIDTH=INT_015*50
         .CAPTION='幣        別'
    ENDWITH     
    THIS.ADDOBJECT('LBLF16','LABEL')    
    WITH THIS.LBLF16
         .VISIBLE=.F.           
         .LEFT=INT_015*328
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='匯        率'
    ENDWITH         
    THIS.ADDOBJECT('LBLF15','LABEL')      
    WITH THIS.LBLF15
         .VISIBLE=.F.       
         .LEFT=INT_015*328
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='單        價'
    ENDWITH     
    THIS.ADDOBJECT('LBLF17','LABEL')
    WITH THIS.LBLF17
         .VISIBLE=.F.           
         .LEFT=INT_015*328
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='金額小計'
    ENDWITH  
    THIS.ADDOBJECT('LBLF171','LABEL')    
    WITH THIS.LBLF171
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*118
         .AUTOSIZE=.T.
    ENDWITH         
    THIS.ADDOBJECT('LBLF11','LABEL')
    WITH THIS.LBLF11
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*148
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF111','LABEL')
    WITH THIS.LBLF111
        .VISIBLE=.T.           
        .LEFT=INT_015*379
        .TOP=INT_015*148
        .AUTOSIZE=.T.
    ENDWITH    
	THIS.ADDOBJECT('TXTF03','TXTF03')
	WITH THIS.TXTF03      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF03'  
             .BACKCOLOR=RGB(255,255,100)
             .MOUSEPOINTER=99
             .MOUSEICON='BMPS\harrow.cur'                  
	ENDWITH     
	THIS.ADDOBJECT('TXTF07','TXTF07')
	WITH THIS.TXTF07      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*119
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=10
	     .NAME='TXTF07'         
         .BACKCOLOR=RGB(255,255,100)
         .MOUSEPOINTER=99
         .MOUSEICON='BMPS\harrow.cur'   	           
	ENDWITH   
     THIS.ADDOBJECT('TXTF05','TXTF05')          
     WITH THIS.TXTF05          
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*64
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25       
          .MAXLENGTH=5
     ENDWITH
     THIS.AddObject('BTNF05','BTNF05')
     WITH THIS.BTNF05           
          .LEFT=INT_015*185
          .TOP=INT_015*64
          .HEIGHT=INT_015*25
          .WIDTH=INT_015*55
          .CAPTION='更正部門'
          .FONTSIZE=INT_015*9
          .FORECOLOR=RGB(136,0,255)
     ENDWITH
	THIS.ADDOBJECT('TXTF04','TEXTBOX')
	WITH THIS.TXTF04
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*89
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999999999'
	     .NAME='TXTF04'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF13','TEXTBOX')
    WITH THIS.TXTF13
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*114
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='999999999999'
         .NAME='TXTF13'
    ENDWITH     
    THIS.ADDOBJECT('TXTF12','TEXTBOX')
    WITH THIS.TXTF12
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*139
         .WIDTH=INT_015*250
         .HEIGHT=INT_015*25
         .MAXLENGTH=100
         .NAME='TXTF12'
    ENDWITH         
    THIS.ADDOBJECT('TXTF14','TEXTBOX')
    WITH THIS.TXTF14
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*39
         .WIDTH=INT_015*49         
         .HEIGHT=INT_015*25
         .MAXLENGTH=4
         .NAME='TXTF14'                            
    ENDWITH         
    THIS.ADDOBJECT('CRCY','CRCY')
    THIS.ADDOBJECT('TXTF16','TEXTBOX')
    WITH THIS.TXTF16
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*64
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='9999.999999'
         .NAME='TXTF16'                            
    ENDWITH     
    
    THIS.ADDOBJECT('TXTF15','TEXTBOX')
    WITH THIS.TXTF15
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*89
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='9999999.999999'
         .NAME='TXTF15'                            
    ENDWITH     
    THIS.ADDOBJECT('TXTF79','TXTF79')
    WITH THIS.TXTF79
         .VISIBLE=INT_029        
         .LEFT=INT_015*65
         .TOP=INT_015*164
         .WIDTH=INT_015*261
         .HEIGHT=INT_015*25
         .MAXLENGTH=43
         .NAME='TXTF79'
    ENDWITH         
     THIS.AddObject('BTNF79','BTNF79')
     WITH THIS.BTNF79          
          .LEFT=INT_015*330
          .TOP=INT_015*164
          .HEIGHT=INT_015*25
          .WIDTH=INT_015*40
          .CAPTION='拆批'
          .FONTSIZE=INT_015*9
          .FORECOLOR=RGB(136,0,255)
     ENDWITH
  ENDPROC       
 PROC INIT       
       THISFORM.Caption='B04.出貨單'++SPACE(100)+'本月已開單金額'+TRANSFORM(MTH_TTL,'@R 999,999,999,999')
       THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
       THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)      
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10  
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION=''
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.       
       
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')    
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='出貨單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='客戶簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B04_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B04_1.F06'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE="C01.F05"
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B04_1.F10<>'2',RGB(255,0,0),'')","COLUMN")         
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')   
           
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION=IIF(INT_029,'實際料號','品名規格')
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='出貨倉別'
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='訂單編號'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='計價數量'
	   THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='無價數量'
	   THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='備註說明'
	   THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='安全資料'
	   THISFORM.GRID2.COLUMN9.HEADER1.CAPTION='在庫數量'
*!*		   THISFORM.GRID2.LINKMASTER='B04_1'
*!*	       THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B04.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B04.F79,B01.F02)"
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE="A14.F02"
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B04.F07'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='B04.F04'
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='B04.F13'
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='B04.F12'
	   THISFORM.GRID2.COLUMN8.CONTROLSOURCE='B04.F11'
	   THISFORM.GRID2.COLUMN9.CONTROLSOURCE='B11.F04'
	   THISFORM.GRID2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN3.WIDTH=INT_015*55
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*75
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN8.WIDTH=INT_015*135
       THISFORM.GRID2.COLUMN9.WIDTH=INT_015*80
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(B04.F03!=B04.F79,RGB(107,79,175),IIF(B11.F04-B04.F04<0 AND EMPTY(B04_1.F10),RGB(255,255,0),''))","COLUMN")          
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
          THISFORM.TRN_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B04_1.F10<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B04_1.F10<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(B04_1.F10='2',.F.,.T.)  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
          THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B04_1.F10),.F.,.T.)  .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED 
          THISFORM.TRN_BOTT.ENABLED=IIF(SEEK(B04.F01,'C22'),.F.,.T.)&&判斷是否有轉出INVOICE的權限
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依出貨單號排列'      
       JK='出貨單號'
       SELE B04_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B04_1.F01
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE B04_1   
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B04_1.F10<>'2',RGB(255,0,0),'')","COLUMN")         
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS   
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF                  
        THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
        THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)
        THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.F.
        THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,0)          
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.TRN_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE=''   
        THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''     
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION=''           
        THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''         
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=''         
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B04_1.F10<>'2' &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B04_1.F10<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B04_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B04_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
        THISFORM.TRN_BOTT.ENABLED=IIF(SEEK(B04.F01,'C22'),.F.,.T.)&&判斷是否有轉出INVOICE的權限
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.) AND !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F14,.F.)
  ENDPROC
 
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
       SELE B04 
    IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.     
        THISFORM.GRID2.SETFOCUS   
     ENDIF  
        THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.F.
        THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,0)
        THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.T.
        THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,255)          
     IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.TRN_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF171.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.BTNF05.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.BTNF05.VISIBLE=.F.
        THISFORM.PAGEFRAME1.PAGE2.BTNF79.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.BTNF79.VISIBLE=.F.
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B04.F10<>'2'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B04.F10<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
        IF A02.F10='*' &&判斷有無查看單價的權限
	        THISFORM.PAGEFRAME1.PAGE2.LBLF14.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.TXTF14.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLF15.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLF16.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.TXTF16.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLF17.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLF171.VISIBLE=.T.
	    ENDIF       
        THISFORM.ANS_BOTT.ENABLED=IIF(B04.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B04.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
        THISFORM.PAGEFRAME1.PAGE2.BTNF05.ENABLED=IIF(EMPTY(B04.F10),.F.,.T.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
        THISFORM.PAGEFRAME1.PAGE2.BTNF05.VISIBLE=IIF(EMPTY(B04.F10),.F.,.T.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
        THISFORM.PAGEFRAME1.PAGE2.BTNF79.ENABLED=IIF(EMPTY(B04.F10),.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.) AND INT_029
        THISFORM.PAGEFRAME1.PAGE2.BTNF79.VISIBLE=IIF(EMPTY(B04.F10),.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.) AND INT_029
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. B04_1.F10<>'2' &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
     THISFORM.TRN_BOTT.ENABLED=.F.
  ENDPROC             
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依出貨單號排列')
           .ADDITEM('依客戶編號排列')
           .ADDITEM('依發票號碼排列')
       ENDWITH      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE B04_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依出貨單號排列'
               SET ORDER TO 1 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='出貨單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B04_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B04_1.F06'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='客戶簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE="C01.F05"
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60                                
          CASE THIS.DISPLAYVALUE='依客戶編號排列'
               SET ORDER TO 2
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='客戶編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B04_1.F06'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE="C01.F05"
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='出貨單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B04_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81             
          CASE THIS.DISPLAYVALUE='依發票號碼排列'
               SET ORDER TO 3
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='發票號碼'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B04_1.F20'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B04_1.F06'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='客戶簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE="C01.F05"
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60                                                                                                                                              
       ENDCASE 
       THISFORM.GRID1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.CHILDORDER=''
       
       SELE A24
       USE
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1             
       SELE B25
       USE
       B25='B25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B25')
          SELE 0
          USE (B25) ALIA B25
       ELSE
          SELE B25
       ENDIF
       SET ORDER TO 1                    
       SELE B26
       USE
       B26='B26'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B26')
          SELE 0
          USE (B26) ALIA B26
       ELSE
          SELE B26
       ENDIF
       SET ORDER TO 1                           
       SELE B39
       USE
       B39='B39'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B39')
          SELE 0
          USE (B39) ALIA B39
       ELSE
          SELE B39
       ENDIF
       SET ORDER TO 1           
       SELE C10
       USE
       C10='C10'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       C105='C105'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&C10')
          SELE 0
          USE (C10) ALIA C10
       ELSE
          SELE C10
       ENDIF
       SET ORDER TO C105        
       SELE C1C
       USE
       SELE K2D
       USE          
       SELE K2E
       USE                          
       SELE C13
       USE
       C13='C13'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&C13')
          SELE 0
          USE (C13) ALIA C13
       ELSE
          SELE C13
       ENDIF
       SET ORDER TO 1    
       SELECT K24
       USE
      K24='K24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)     &&發票明細檔表頭
      K241='K241'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6) 
      K242='K242'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
      IF !USED('&K24')
          SELE 0
          USE (K24) ALIA K24
      ELSE
          SELE K24
      ENDIF
      SET ORDER TO K241       
       SELE K25
       USE
       K25='K25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       K254='K254'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&K25')
          SELE 0
          USE (K25) ALIA K25
       ELSE
          SELE K25
       ENDIF
       SET ORDER TO K254
       ***
       SELE A23
       SET ORDER TO 1
       SEEK DTOS(CTOD(THIS.DISPLAYVALUE+'/01'))
       SKIP
       IF !EOF()
          C1C='C13'+LEFT(DTOS(A23.F01),6)     &&下個月的應收帳款明細檔
          IF !USED('&C1C')
             SELE 0
             USE (C1C) ALIA C1C
          ELSE
             SELE C1C
          ENDIF
          SET ORDER TO 1
          K2D='K24'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔表頭
          IF !USED('&K2D')
             SELE 0
             USE (K2D) ALIA K2D
          ELSE
             SELE K2D
          ENDIF
          SET ORDER TO 1
          K2E='K25'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔表身
          IF !USED('&K2E')
             SELE 0
             USE (K2E) ALIA K2E
          ELSE
             SELE K2E
          ENDIF
          SET ORDER TO 4   
       ELSE
          IF !USED('C1C')                    &&應收帳款明細月結暫存檔
             SELE 0
             USE C1C ALIA C1C
          ELSE
             SELE C1C
          ENDIF
          SET ORDER TO 1
          IF !USED('K2D')                    &&發票明細月結暫存檔表頭
             SELE 0
             USE K2D ALIA K2D
          ELSE
             SELE K2D
          ENDIF
          SET ORDER TO 1           
          IF !USED('K2E')                    &&發票明細月結暫存檔表身
             SELE 0
             USE K2E ALIA K2E
          ELSE
             SELE K2E
          ENDIF
          SET ORDER TO 1   
       ENDIF                          

       SELE B04
       SET RELATION OFF INTO A14
       SET RELA OFF INTO B01
       SET RELA OFF INTO B04_1
       SET RELATION OFF INTO B11
       USE
       SELE B04_1
       SET RELA OFF INTO C01
       USE
       B04='B04'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       B041='B041'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B04')
          SELE 0
          USE (B04) ALIA B04
       ELSE
          SELE B04
       ENDIF
       SET ORDER TO 1      
       CALCULATE SUM(F17) TO MTH_TTL
     
       SET RELA TO F03 INTO B01
       SET RELATION TO F05 INTO A14 ADDI
       SET RELATION TO F05+F79+SPACE(5) INTO B11 ADDITIVE 
       CREATE CURSOR B04_1;
       (F01 C(10),F02 C(2),F05 C(5),F06 C(5),F08 C(1),F09 C(5),F10 C(1),F11 C(17),F20 C(10),F21 C(60),F22 C(2),F23 C(1),F24 C(80),F90 C(17))
       INDE ON F01 TAG B04_11
       INDE ON F06+F01 TAG B04_12
       INDEX ON F20 TAG B04_13
       SELE F01,F02,F05,F06,F08,F09,F10,F11,F20,F21,F22,F23,F24,F90 FROM B04 GROUP BY F01 ORDER BY F01 INTO CURSOR B04_2
       SELE B04_2
       GO TOP
       DO WHILE !EOF()
          SELE B04_1
          APPEND BLANK
          REPL F01 WITH B04_2.F01
          REPL F02 WITH B04_2.F02
          REPL F05 WITH B04_2.F05
          REPL F06 WITH B04_2.F06   
          REPL F08 WITH B04_2.F08
          REPL F09 WITH B04_2.F09
          REPL F10 WITH B04_2.F10
          REPL F11 WITH B04_2.F11
          REPL F20 WITH B04_2.F20
          REPL F21 WITH B04_2.F21
          REPL F22 WITH B04_2.F22
          REPL F23 WITH B04_2.F23
          REPL F24 WITH B04_2.F24
          REPL F90 WITH B04_2.F90
          SELE B04_2
          SKIP
       ENDDO
       SELE B04_2
       USE   
       SELE B04_1
       SET ORDER TO 1
       SET RELA TO F06 INTO C01     
       THISFORM.GRID1.RECORDSOURCE='B04_1'
       THISFORM.GRID2.RECORDSOURCE='B04'
       THISFORM.GRID2.LINKMASTER='B04_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=B041  
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B04.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B04.F79,B01.F02)"
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE="A14.F02"
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B04.F07'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='B04.F04'
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='B04.F13'
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='B04.F12'
	   THISFORM.GRID2.COLUMN8.CONTROLSOURCE='B04.F11'       
	   THISFORM.GRID2.COLUMN9.CONTROLSOURCE='B11.F04'     
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   THISFORM.GRID1.SETFOCUS        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
          THISFORM.TRN_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B04_1.F10<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B04_1.F10<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.ANS_BOTT.ENABLED=IIF(B04_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED 
          THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B04_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)

       ENDIF          
       THISFORM.Caption='B04.出貨單'++SPACE(100)+'本月已開單金額'+TRANSFORM(MTH_TTL,'@R 999,999,999,999')
*!*	       THISFORM.KEY_LIST.DISPLAYVALUE='依出貨單號排列'      
*!*	       JK='訂單編號'
*!*	       SELE B04_1
*!*	       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B04_1.F01	   
*       THISFORM.REFRESH       
  ENDPROC
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       SELECT B04_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B04_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=B04_1.F05
       THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=B04_1.F06
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(B04_1.F05,'A14'),A14.F02,'')
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=IIF(SEEK(B04_1.F06,'C01'),C01.F04,'')
       THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE=B04_1.F09
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=IIF(SEEK(B04_1.F09,'A01'),A01.F03,'')
       THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=B04_1.F20
       THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE=B04_1.F21    
       THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE=B04_1.F24   
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=B04_1.F02
       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.BACKCOLOR=IIF(B04_1.F10='2',RGB(0,255,0),RGB(255,0,0))
       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION=IIF(B04_1.F10='2','    已過帳    ','    未過帳    ')
       THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION=B04_1.F11
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=B04_1.F90
       THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(B04_1.F22='31','三聯式',IIF(B04_1.F22='32','二聯式',''))
       THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=IIF(B04_1.F23='1','應稅',IIF(B04_1.F23='2','零稅',IIF(B04_1.F23='3','免稅','')))
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(LEFT(B04_1.F08,1)='2','經海關',IIF(LEFT(B04_1.F08,1)='1','不經海關',''))
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B04_1.F10<>'2'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B04_1.F10<>'2' &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED=IIF(B04_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED 
       THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B04_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
       THISFORM.TRN_BOTT.ENABLED=IIF(SEEK(B04.F01,'C22'),.F.,.T.)&&判斷是否有轉出INVOICE的權限
       THISFORM.GRID1.HIGHLIGHTBACKCOLOR=IIF(B04_1.F10<>'2',RGB(255,0,0),RGB(58,186,152))
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION=TRANSFORM(TTL1(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE),'@R 9999999999.99')
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION=TRANSFORM(TTL3(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE),'@R 9999999999.99')
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=TRANSFORM(TTL2(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE),'@R 999999999999')       
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.TRN_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.TRN_BOTT.ENABLED=IIF(SEEK(B04.F01,'C22'),.F.,.T.)&&判斷是否有轉出INVOICE的權限
           
       ENDIF   
       CHK=''     
*       THISFORM.REFRESH
  ENDPROC     
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       SELECT B04
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=B04.F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=B04.F07       
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=B04.F04
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=B04.F05
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=B04.F13
       THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=B04.F12
       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=B04.F14
       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=B04.F16       
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=B04.F15
       THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=B04.F79
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE2.LBLF171.CAPTION=TRANSFORM(F17,'@R 99999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=F11       
       THISFORM.PAGEFRAME1.PAGE2.LBLF7911.CAPTION='在庫數量:'+TRANSFORM(B11.F04,'@R 99999999999.99')
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM. CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.TRN_BOTT.ENABLED=.F.
       ENDIF   
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE       
*       THISFORM.REFRESH
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.TRN_BOTT.ENABLED=.F. 
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   

          HD='B003 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          HD1='B003 '
          HD2='BC'
          HD3='出貨單'
          DO ODR_CRT    &&執行主程式單據自動流水編號程序   
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
          THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.F.        
          THISFORM.PAGEFRAME1.PAGE1.TXTF09.READONLY=.F.    
          THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.F.  
          THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=INT_193    
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=''
         IF INT_060=.F.      &&如果不帶入發票管理
             THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
             THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.             
             THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1
             THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1             
         ENDIF
         THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE=''      
         THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE=''             
         THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)
         THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(INT_193,'A14'),A14.F02,'')
         THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
         THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''
         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION=''
         THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION=''        
         THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''        
         THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''  
         THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION='' 
         THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION='' 
         THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION=''         
         THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION=''   
         THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=''         
     ELSE                             &&處理表身新增
        IF LEN(ALLTRIM(B04_1.F20))=10 AND LEFT(B04_1.F20,2)<>'67' AND B04_1.F20<>B04_1.F01  &&檢查是否有印過國內發票
           HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3)) 
           ODM=VAL(LEFT(DTOS(CTOD(HK+'/01')),6))%2
           MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(HK+'/01')),6))+ODM-1))          
           K39='K39'+MMT
           IF !USED('&K39')
               SELECT 0
               USE (K39) ALIAS K39
           ELSE
               SELECT K39
           ENDIF
           SET ORDER TO 2                      
           IF SEEK(B04_1.F20,'K39') AND !EMPTY(K39.F05)
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
              =MESSAGEBOX('此單據已列印發票，不得再新增內容!',0+64,'提示訊息視窗')
              SELECT K39
              USE                            
              RETURN
           ELSE
              SELECT K39
              USE   
           ENDIF        
        ENDIF
           THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.             
           THISFORM.GRID2.ENABLED=.F.   
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
           THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)
           THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=INT_011
           THISFORM.PAGEFRAME1.PAGE2.CRCY.ENABLED=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)
           THISFORM.PAGEFRAME1.PAGE2.TXTF14.READONLY=IIF(A02.F08='*',.F.,.T.)
           THISFORM.PAGEFRAME1.PAGE2.TXTF15.READONLY=IIF(A02.F08='*',.F.,.T.)   
           THISFORM.PAGEFRAME1.PAGE2.TXTF16.READONLY=IIF(A02.F08='*',.F.,.T.)
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.F.        
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''          
           THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''   
           THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14'),A14.F02,INT_193)              
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=0
           THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=''
           THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=''
           THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
           THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0
           THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=1
           THISFORM.PAGEFRAME1.PAGE2.LBLF171.CAPTION=TRANSFORM(0,'999999999999')
           THISFORM.PAGEFRAME1.PAGE2.LBLF111.CAPTION=''               
           THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
  
     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
       IF LEN(ALLTRIM(B04_1.F20))=10 AND LEFT(B04_1.F20,2)<>'67' AND B04_1.F20<>B04_1.F01  &&檢查是否有印過國內發票
           HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3)) 
           ODM=VAL(LEFT(DTOS(CTOD(HK+'/01')),6))%2
           MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(HK+'/01')),6))+ODM-1))          
           K39='K39'+MMT
           IF !USED('&K39')
               SELECT 0
               USE (K39) ALIAS K39
           ELSE
               SELECT K39
           ENDIF
           SET ORDER TO 2                      
           IF SEEK(B04_1.F20,'K39') AND !EMPTY(K39.F05)
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
              =MESSAGEBOX('此單據已列印發票，不得再修改內容!',0+64,'提示訊息視窗')               
              SELECT K39
              USE                            
              RETURN
           ELSE
              SELECT K39
              USE   
           ENDIF        
        ENDIF
  
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.TRN_BOTT.ENABLED=.F. 
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
  
        SELE B04_1
        PO_NO=B04_1.F01
        SELE RECNO() FROM B04 WHERE B04.F01=PO_NO AND F10<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'B04')
           LL1=RLOCK(KK1,'B04')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE B04_1           
           UNLOCK ALL
           REPL F10 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF09.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.F.
           IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10  AND B04_1.F22='31'
              THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
           ENDIF   
           IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_060=.F.     &&如果有發票號碼或是預設不帶入發票管理
              THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
              THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(F22='31',1,2)
              THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.  
              THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=VAL(F23)
              IF F22='32' .AND. F23<>'1'
                 THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=IIF(F08='2',2,1)
                 THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
              ELSE
                  IF F22='31' AND F23='2'
                     THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=1
                  ENDIF
                  THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.  
              ENDIF
           ENDIF   
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF09.SETFOCUS
        ELSE 
           DO FILE_IMPACT
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ENDIF   
     ELSE           
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              
        SELE B04                                                      &&處理表身修改
        SELE RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F01=B04.F07 AND F02=B04.F03 INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'C05')
           LL1=RLOCK(KK1,'C05')
        ELSE
           LL1=.T.   
        ENDIF 
           SELE C04
           SEEK B04.F07+B04.F03
           IF FOUND()
              RLOCK()
              LL2=RLOCK()
           ELSE
              LL2=.T.   
           ENDIF  
        IF RLOCK('B04') .AND. LL1=.T. .AND. LL2=.T.                                               
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF79.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)          
           THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
           THISFORM.PAGEFRAME1.PAGE2.CRCY.ENABLED=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)           
	       THISFORM.PAGEFRAME1.PAGE2.TXTF14.READONLY=IIF(A02.F08='*',.F.,.T.)
           THISFORM.PAGEFRAME1.PAGE2.TXTF15.READONLY=IIF(A02.F08='*',.F.,.T.)   
           THISFORM.PAGEFRAME1.PAGE2.TXTF16.READONLY=IIF(A02.F08='*',.F.,.T.)           
*           THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=EMPTY(A02.F09)            
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
        ELSE  
           DO FILE_IMPACT 
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       ENDIF        
     ENDIF   
     RELEASE ALL LIKE BK*
  ENDPROC    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF LEN(ALLTRIM(B04_1.F20))=10 AND LEFT(B04_1.F20,2)<>'67' AND B04_1.F20<>B04_1.F01  &&檢查是否有印過國內發票
           HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3)) 
           ODM=VAL(LEFT(DTOS(CTOD(HK+'/01')),6))%2
           MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(HK+'/01')),6))+ODM-1))          
           K39='K39'+MMT
           IF !USED('&K39')
               SELECT 0
               USE (K39) ALIAS K39
           ELSE
               SELECT K39
           ENDIF
           SET ORDER TO 2                      
           IF SEEK(B04_1.F20,'K39') AND !EMPTY(K39.F05)
             ** THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
              =MESSAGEBOX('此單據已列印發票，不得刪除!',0+64,'提示訊息視窗')
              SELECT K39
              USE                            
              RETURN
           ELSE
              SELECT K39
              USE   
           ENDIF        
        ENDIF
  
       IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          IF ALIA()='B04_1'           &&刪除整張訂單
             SELE B04_1             
                PO_NO=B04_1.F01
                SELE RECNO() FROM B04 WHERE B04.F01=PO_NO  AND B04.F10<>'2' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'B04')
                   LL1=RLOCK(KK1,'B04')
                ELSE
                   LL1=.T.   
                ENDIF                   
                SELE RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F01= ANY (SELE F07 FROM B04 WHERE F01=PO_NO) INTO ARRAY BK2
                JJ2=''                
                IF _TALLY>0                   
                    FOR I= 1 TO ALEN(BK2)
                        JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                    ENDFOR  
                    KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
                    RLOCK(KK2,'C05')
                    LL2=RLOCK(KK2,'C05')
                ELSE
                   LL2=.T.   
                ENDIF   
                SELE RECNO() FROM C04 WHERE F03+F04=ANY (SELE F07+F03 FROM B04 WHERE F01=PO_NO) INTO ARRAY BK3              
                JJ3=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK3)
                       JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
                   ENDFOR    
                   KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
                   RLOCK(KK3,'C04')
                   LL3=RLOCK(KK3,'C04')
                ELSE
                   LL3=.T.   
                ENDIF                   
                IF LL1 .AND. LL2 .AND. LL3=.T.
                   IF LEN(ALLTRIM(JJ1))>0 
                      SELE B04
                      FOR I= 1 TO ALEN(BK1)
                          GO BK1(I) 
                          SELE C05
                          SET ORDER TO C056                   
                          SEEK B04.F07+B04.F03
                          IF FOUND()
                             QTY=B04.F04+B04.F13
                             DO WHILE F01+F02=B04.F07+B04.F03 
                                IF F05=0
                                   SKIP
                                ELSE
                                   IF QTY>F05
                                      QTY=QTY+F05*(-1)   
                                      REPL F05 WITH 0     
                                      SKIP
                                   ELSE
                                      REPL F05 WITH F05+QTY*(-1)
                                      EXIT
                                  ENDIF  
                               ENDIF                    
                             ENDDO                                  
                          ENDIF                                 
                            SELE C04
                            SEEK B04.F07+B04.F03
                            IF FOUND()
                                REPL F23 WITH F23+(B04.F04+B04.F13)*(-1)
*                                REPL F19 WITH F19+(B04.F13)*(-1)
                            ENDIF    
                            SELE B04
                            MTH_TTL=MTH_TTL-F17
                       ENDFOR                      
                   ELSE
                      =MESSAGEBOX('此張單據已由別的工作站過帳中,無法刪除!',0+64,'提示訊息視窗')
                      SELE B04_1
                      REPL F10 WITH '2'
                      UNLOCK ALL
                      RETURN   
                   ENDIF    
                   DELE FROM B04 WHERE B04.F01=PO_NO
                   SELE B39                     &&刪除未過帳單據紀錄
                   SEEK A02.F03+B04_1.F01                   
                   IF FOUND()
                      DELE
                   ENDIF   
                   SELE B04_1
                   DELE
                   UNLOCK ALL
                   IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)                      
                      HD='B003 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      HD2='BC'
                      HD3='出貨單'
                      DO ODR_RJT 
                  ENDIF  
                ELSE
                   DO FILE_IMPACT                  
                ENDIF
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B04_1.F10<>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B04_1.F10<>'2' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(B04_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED           
             ENDIF     
          ELSE        
              SELE B04                                                      &&刪除單筆資料及其出貨計劃        
              SELE RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F01=B04.F07 AND F02=B04.F03 INTO ARRAY BK1
              JJ1=''                
                IF _TALLY>0                   
                    FOR I= 1 TO ALEN(BK1)
                        JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                    ENDFOR  
                    KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
                    RLOCK(KK1,'C05')
                    LL1=RLOCK(KK1,'C05')
                ELSE
                   LL1=.T.   
                ENDIF 
                SELE C04
                SET ORDER TO C041
                SEEK B04.F07+B04.F03
                IF FOUND()
                   RLOCK()
                   LL2=RLOCK()
                ELSE
                   LL2=.T.   
                ENDIF  
                 IF RLOCK('B04') .AND. LL1=.T. .AND. LL2=.T.
                    IF LEN(ALLTRIM(JJ1))>0
                       SELE C05
                       SET ORDER TO C056
                       SEEK B04.F07+B04.F03
                       IF FOUND()
                          QTY=B04.F04+B04.F13
                          DO WHILE C05.F01+C05.F02=B04.F07+B04.F03 
                             IF C05.F05=0
                                SKIP
                             ELSE
                                IF QTY>C05.F05
                                   QTY=QTY+C05.F05*(-1)   
                                   REPL C05.F05 WITH 0     
                                   SKIP
                                ELSE
                                   REPL C05.F05 WITH C05.F05+QTY*(-1)
                                   EXIT
                                ENDIF  
                             ENDIF                    
                           ENDDO                                  
                        ENDIF                                 
                     ENDIF                        
                     SELE C04
                     SEEK B04.F07+B04.F03
                     IF FOUND()
                        REPL C04.F23 WITH C04.F23+(B04.F04+B04.F13)*(-1)
*                        REPL F19 WITH F19+(B04.F13)*(-1)
                     ENDIF                       
                     SELE B04
                     MTH_TTL=MTH_TTL-F17
                     DELE
                     SKIP -1
                     IF BOF()
                        GO TOP
                     ENDIF   
                  ELSE
                    DO FILE_IMPACT                  
                  ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                 SELE B39                           &&刪除未過帳單據紀錄       
                 SEEK A02.F03+B04_1.F01
                 IF FOUND()
                    DELE
                 ENDIF                    
                 SELE B04_1                        
                 PO_NO=B04_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)              
                    HD='B003 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                    HD2='BC'
                    HD3='出貨單'
                    DO ODR_RJT
                 ENDIF
                 SELE B04_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF
       THISFORM.Caption='B04.出貨單'++SPACE(100)+'本月已開單金額'+TRANSFORM(MTH_TTL,'@R 999,999,999,999')
       RELEASE ALL LIKE BK*   
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        THISFORM.GRID2.RECORDSOURCE='B04'
        THISFORM.GRID2.CHILDORDER=B041
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B04.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B04.F79,B01.F02)"
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE="A14.F02"
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B04.F07'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='B04.F04'
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='B04.F13'
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='B04.F12'
	   THISFORM.GRID2.COLUMN8.CONTROLSOURCE='B04.F11'      
	   THISFORM.GRID2.COLUMN9.CONTROLSOURCE='B11.F04' 
       SELE B04_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'B04')=.T.    &&如果單號重覆
          SELECT MAX(F01) FROM B04 INTO ARRAY GB NOWAIT
          HD='B003 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          HD1='B003 '
          HD2='BC'
          HD3='出貨單'
          DO ODR_RPT   &&執行主程式單據編號重複程序
		      THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
		      THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH               
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
          =MESSAGEBOX('客戶基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ELSE
          IF THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>C01.F17
             =MESSAGEBOX('出貨日已超過入帳日期,過帳後帳款將轉至下個月對帳單!',0+48,'提示訊息視窗')
          ENDIF   
       ENDIF
       IF EMPTY(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),C01.F10,'')) AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE) AND THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1
          =MESSAGEBOX('此客戶無統編，發票類別不得選三聯式！',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2          
            IF THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=2
               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2
            ENDIF
        ENDIF
       SELE RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND F04>F05 INTO ARRAY RC1
       IF _TALLY=0       
          IF ALLTRIM(A02.F09)='*'
             IF MESSAGEBOX('此客戶已無訂單可出,是否要以無訂單出貨?',4+16+0,'請確定')<>6
                THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS                          
                SET ORDER TO &COD
                RETURN    
             ELSE
                IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE)
                   THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=B04_1.F01
                ENDIF                        
             ENDIF             
          ELSE
             =MESSAGEBOX('此客戶已無訂單可出貨且你沒有無訂單出貨的權限!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS             
             SET ORDER TO &COD
             RETURN                        
          ENDIF                
       ENDIF       
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('出貨日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF  
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
          =MESSAGEBOX('預設部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
          SET ORDER TO &COD 
          RETURN            
       ENDIF
       SELE B04_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
          REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE
          REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE    
          IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_060=.F.     &&如果有發票號碼或預設不帶入發票管理
              REPLACE  F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'31','32')
              REPLACE  F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))
              REPLACE  F08 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.,IIF(F22='31' AND F23='2','1',''),IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2,'2','1'))
              
          ELSE 
             REPLACE  F22 WITH ''
             REPLACE  F23 WITH ''   
             REPLACE  F08 WITH ''
          ENDIF     
          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE    
          REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE                           
       ENDIF
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       SELE B39
       APPEND BLANK
       REPL F01 WITH A02.F03
       REPL F02 WITH B04_1.F01
       REPL F03 WITH B04_1.F02
       REPL F04 WITH B04_1.F06
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.                      &&表身新增確認
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       IF ALLTRIM(A02.F09)<>'*' .AND. EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE)
          =MESSAGEBOX('您沒有無訂單出貨的權限!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE;
          +THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE,'B04')=.T. 
          =MESSAGEBOX('此訂單號碼及料號在此張出貨單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF07.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN            
       ENDIF           
       IF ALLTRIM(A02.F09)<>'*' .OR. !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE)    &&如果沒有無訂單出貨的權限或訂單號碼欄不為空白才做以下判斷
          SELECT RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F01+F02=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE AND ;
          F04-F05>0 INTO ARRAY RC2
          IF _TALLY>0
             RR1=''
             FOR I= 1 TO ALEN(RC2)
                 RR1=RR1+ALLTRIM(STR(RC2(I)))+','
             ENDFOR    
             SS1=STUFF(RR1,RAT(',',RR1,1),1,'')                           
             IF RLOCK(SS1,'C05')<>.T.
                DO file_impact
                THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
                RETURN
             ENDIF
          ELSE
             =MESSAGEBOX('出貨計劃無此筆資料!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
             RETURN          
          ENDIF      
	       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
	          =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
	          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
	          RETURN            
	       ENDIF  
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),;
             C04.F10-(C04.F16-C04.F19)-C04.F23,0)
             =MESSAGEBOX('計價量不得大於未出貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),;
             C04.F10-(C04.F16-C04.F19)-C04.F23,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF          
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F16-C04.F19,0)
             =MESSAGEBOX('無價量不得大於未出貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F16-C04.F19,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF13.SETFOCUS
             RETURN
          ENDIF                 
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE<=0;
             .OR. THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F10-C04.F23,0)
             =MESSAGEBOX('計價量與無價量總合不得小於等於 0 或大於未出貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F10-C04.F23,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF             
      ENDIF    
      IF B04_1.F23='1' OR B04_1.F22='31'
         IF THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0
            =MESSAGEBOX('出貨單價不得為 0',0+64,'提示訊息視窗')
	          THISFORM.PAGEFRAME1.PAGE2.TXTF15.SETFOCUS
	          RETURN            
         ENDIF
      ENDIF
      SELE C04
      SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
      IF FOUND()
         IF RLOCK()
            REPLACE F23 WITH F23+(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE)
         ELSE
            DO FILE_IMPACT
            RETURN  
         ENDIF   
      ENDIF         
       SELE B04
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE
          REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE                    
          REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
          REPLACE F79 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE  
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE          
          REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
          REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE          
          REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE  
                                      
          REPLACE F17 WITH ROUND(IIF(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=1,THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE,;
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE),INT_069)
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE   
          REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE                    
          REPLACE F22 WITH B04_1.F22
          REPLACE F23 WITH B04_1.F23
          REPLACE F08 WITH B04_1.F08
          
      ENDIF
      MTH_TTL=MTH_TTL+F17  
      THISFORM.Caption='B04.出貨單'++SPACE(100)+'本月已開單金額'+TRANSFORM(MTH_TTL,'@R 999,999,999,999')
      UNLOCK ALL       
     
      SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE                                    
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID2.SETFOCUS  
      SELE C05                 
      SET ORDER TO C054                                                          &&寫入出貨計劃
      SEEK B04.F07+B04.F03
      IF FOUND()
         QTY=B04.F04+B04.F13
         DO WHILE F01+F02=B04.F07+B04.F03 
            IF F04-F05=0
               SKIP
            ELSE
               IF QTY>F04-F05
                  QTY=QTY+(F04-F05)*(-1)   
                  REPL F05 WITH F04     
                  SKIP
               ELSE
                  REPL F05 WITH F05+QTY
                  EXIT
               ENDIF  
            ENDIF                    
         ENDDO   
      ENDIF               
      THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
    RELEASE ALL LIKE RC*
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1        
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('出貨日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
        IF EMPTY(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),C01.F10,'')) AND !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE) AND THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1
          =MESSAGEBOX('此客戶無統編，發票類別不得選三聯式！',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2          
          IF THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=2
             THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
             THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2
          ENDIF    
        ENDIF
           SELE B04
           SEEK B04_1.F01
           IF FOUND()
              DO WHILE F01=B04_1.F01
                 IF F02<>THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                    IF NOUME(F02)<>NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE) AND F14<>INT_011
                       REPLACE F16 WITH IIF(SEEK(F14+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(F14,'C00'),C00.F02,1))
                       REPLACE F17 WITH ROUND(F04*F15*F16,INT_069)
                    ENDIF
                    IF THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>C01.F17
                       =MESSAGEBOX('出貨日已超過入帳日期,過帳後帳款將轉至下個月對帳單!',0+48,'提示訊息視窗')
                    ENDIF   
                    REPLACE  F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
                 ENDIF   
                 IF F09<>THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE
                    REPLACE  F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE
                 ENDIF   
                 REPLACE  F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 IF F20<>THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                 
                    REPLACE  F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE
                 ENDIF

                 IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_060=.F.   &&如果有發票號碼或預設不帶入發票管理
                    REPLACE  F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'31','32')
                    REPLACE  F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))  
                    REPLACE  F08 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.,IIF(F22='31' AND F23='2','1',''),IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2,'2','1'))
                    
                 ELSE
                    REPLACE  F22 WITH ''
                    REPLACE  F23 WITH ''    
                    REPLACE  F08 WITH ''
                ENDIF
                IF F21<>THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE   
                    REPLACE  F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE
                ENDIF   
                IF F24<>THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE
		           REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE   
		        ENDIF                    
                SKIP
              ENDDO    
           ENDIF        
        SELE B04_1
*        IF RLOCK() 
           REPLACE  F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
           REPLACE  F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE
           IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10   OR INT_060=.F.   &&如果有發票號碼或預設不帶入發票管理
              REPLACE  F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'31','32')
              REPLACE  F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))
              REPLACE  F08 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.,IIF(F22='31' AND F23='2','1',''),IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2,'2','1'))
           ELSE
              REPLACE  F22 WITH ''
              REPLACE  F23 WITH ''   
              REPLACE  F08 WITH ''
           ENDIF           
           REPLACE  F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE
           REPLACE  F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE     
           REPLACE  F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE                  
           REPLACE  F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           UNLOCK ALL
*        ELSE
*           DO FILE_IMPACT
*          RETURN   
*       ENDIF    
     ELSE                                                        &&表身修改確認     
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE<>B04.F03+B04.F07
             IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE;
                +THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE,'B04')=.T.            
                =MESSAGEBOX('此訂單號碼及料號在此張出貨單重複!',0+48,'提示訊息視窗')
                THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
                RETURN            
             ENDIF    
          ENDIF           
       IF ALLTRIM(A02.F09)<>'*'  .OR. !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE)  &&如果沒有無訂單出貨的權限才做以下判斷
          IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C05')=.F.             
             =MESSAGEBOX('出貨計劃無此筆資料!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
             RETURN
          ENDIF   
          IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
             =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
             RETURN            
          ENDIF   
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),;
             C04.F10-C04.F23+B04.F04,0)
             =MESSAGEBOX('計價量不得大於未出貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),;
             C04.F10-C04.F23+B04.F04,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF          
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F16-C04.F19,0) 
             =MESSAGEBOX('無價量不得大於未出貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F16-C04.F19,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF13.SETFOCUS
             RETURN
          ENDIF                 
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE<=0;
             .OR. THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F10-C04.F23+(B04.F04+B04.F13),0) 
             =MESSAGEBOX('計價量與無價量總合不得小於等於 0 或大於未出貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F10-C04.F23+(B04.F04+B04.F13),0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF   
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE<>THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE   &&如果單上料號與實際料號不同再做料號正確與否判斷
          IF !SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE,'B01') 
              =MESSAGEBOX('物料主檔中無此編號請重新輸入或維持原料號!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF79.SETFOCUS
             RETURN            
          ENDIF
       ENDIF
       IF B04_1.F23='1' OR B04_1.F22='31'
         IF THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0
            =MESSAGEBOX('出貨單價不得為 0',0+64,'提示訊息視窗')
	          THISFORM.PAGEFRAME1.PAGE2.TXTF15.SETFOCUS
	          RETURN            
         ENDIF
      ENDIF
       SELE C04
       SEEK B04.F07+B04.F03
*       IF RLOCK('04') .AND. RLOCK('C04')      
*       IF RLOCK()
          SELE C05                 
          SET ORDER TO C056                                                          &&寫入出貨計劃
          SEEK B04.F07+B04.F03
          IF FOUND()
             QTY=B04.F04+B04.F13
             DO WHILE F01+F02=B04.F07+B04.F03 
                IF F05=0
                   SKIP
                ELSE
                   IF QTY>F05
                      QTY=QTY+F05*(-1)   
                      REPL F05 WITH 0     
                      SKIP
                   ELSE
                      REPL F05 WITH F05+QTY*(-1)
                      EXIT
                   ENDIF  
                ENDIF                    
             ENDDO   
          ENDIF                          
          SELE C04                                                              &&將訂單檔回復成為輸入前之狀態
          SEEK B04.F07+B04.F03
          IF FOUND()
             REPLACE F23 WITH F23+(B04.F04+B04.F13)*(-1)
          ENDIF   
           
           SELE B04              
           MTH_TTL=MTH_TTL-F17      
           REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
           REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
           REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
           REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE
           REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                      
           REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
           IF F79<>THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE    &&如果有修改實際用料                          
              REPLACE F79 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE                
           ENDIF   
           REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
           REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
           REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE
           REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE
           REPLACE F17 WITH ROUND(IIF(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=1,THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE,;
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE),INT_069)
 
           MTH_TTL=MTH_TTL+F17

           THISFORM.Caption='B04.出貨單'++SPACE(100)+'本月已開單金額'+TRANSFORM(MTH_TTL,'@R 999,999,999,999')
           
           SELE C04                                                                 &&寫回訂單檔    
           SEEK B04.F07+B04.F03
           IF FOUND()
              REPLACE F23 WITH F23+(B04.F04+B04.F13)
           ENDIF    
          SELE C05                 
          SET ORDER TO C054                                                          &&寫入出貨計劃
          SEEK B04.F07+B04.F03
          IF FOUND()
             QTY=B04.F04+B04.F13
             DO WHILE F01+F02=B04.F07+B04.F03 
                IF F04-F05=0
                  SKIP
                ELSE
                   IF QTY>F04-F05
                      QTY=QTY+(F04-F05)*(-1)   
                      REPL F05 WITH F04     
                      SKIP
                   ELSE
                      REPL F05 WITH F05+QTY
                      EXIT
                   ENDIF  
                ENDIF                    
             ENDDO   
          ENDIF                                    
          UNLOCK ALL
 *      ELSE
*         DO FILE_IMPACT
*          RETURN   
*       ENDIF   
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF79.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF09.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=.T.    
      THISFORM.PAGEFRAME1.PAGE2.TXTF04.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      THISFORM.TRN_BOTT.ENABLED=IIF(A02.F12='*',IIF(SEEK(B04.F01,'C22'),.F.,.T.),.F.)&&判斷是否有轉出INVOICE的權限
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1    
          THISFORM.GRID1.ENABLED=.T.
          THISFORM.GRID2.ENABLED=.T.        
          THISFORM.GRID1.SETFOCUS   
          
          THISFORM.KEY_LIST.ENABLED=.T.
          THISFORM.MTH_LIST.ENABLED=.T.                
      ELSE
         THISFORM.GRID1.ENABLED=.F.
         THISFORM.GRID2.ENABLED=.T.
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0         
            HD='B003 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
            HD2='BC'
            HD3='出貨單'
            DO ODR_RJT
            SELE B39
            SEEK A02.F03+B04_1.F01
            SET ORDER TO 1
            IF FOUND()
               DELE            
            ENDIF   
            SELE B04_1
            DELE
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH  
*!*	         ELSE
*!*	            SELE B39
*!*	            SET ORDER TO 1
*!*	            SEEK A02.F03+B04_1.F01 
*!*	            IF FOUND()
*!*	               REPL F08 WITH B04.F07 
*!*	               REPL F05 WITH B04.F05
*!*	               REPL F06 WITH IIF(SEEK(B04.F05,'A14'),A14.F02,'')       
*!*	            ENDIF   
         ENDIF   
      ENDIF       
      UNLOCK ALL
      THISFORM.ANS_BOTT.ENABLED=IIF(B04_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED             
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'B04'
            THISFORM.GRID2.RECORDSOURCE='B04'
            THISFORM.GRID2.CHILDORDER=B041
  	        THISFORM.GRID2.COLUMN1.CONTROLSOURCE='B04.F03'
	        THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B04.F79,B01.F02)"
			THISFORM.GRID2.COLUMN3.CONTROLSOURCE="A14.F02"
			THISFORM.GRID2.COLUMN4.CONTROLSOURCE='B04.F07'
			THISFORM.GRID2.COLUMN5.CONTROLSOURCE='B04.F04'
			THISFORM.GRID2.COLUMN6.CONTROLSOURCE='B04.F13'
			THISFORM.GRID2.COLUMN7.CONTROLSOURCE='B04.F12'
			THISFORM.GRID2.COLUMN8.CONTROLSOURCE='B04.F11' 
			THISFORM.GRID2.COLUMN9.CONTROLSOURCE='B11.F04'           
	     ENDIF   
	     IF INT_099=.T.    
                 HD='B003 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO     
                 HD2='BC'
                 HD3='出貨單'            
                 DO ODR_RJT
         ENDIF   
         SELE B04_1
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依出貨單號排列'
                 SET ORDER TO 1
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依客戶邊號排列'
                 SET ORDER TO 2
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依發票號碼排列'
                 SET ORDER TO 3                 
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK     &&過帳程序  
       &&C05(出貨計劃)->F04,F05
       &&C04(客戶訂單表身)->開單未出帳量(F23),已出貨量(F09),未出貨累積量(F10),計價已出量(F18),無價已出量(F19)
       &&C03(客戶訂單表頭)->是否已有出貨行為(F08)
       &&C01(客戶資料檔)->最後交易日(F16)
       &&C06(出貨紀錄)
       &&C10(出貨日報表)
       &&C13(應收帳款對帳單)->出貨日期(F01),出貨單號(F02),客戶編號(F03),訂單編號(F04),品號(F05),出貨數量(F06),單價(F07),小計(F08),結帳方式(F09),安全資料(F12),幣別(F13),匯率(F14),業務員編號(F19)
***       &&C14(月結暫存檔)->客戶編號(F01),科目(F02),借/貸(F03),金額(F06)
       &&B01(物料基本資料檔)->總庫存數量(F12),可分配量(F13)
       &&B11(庫存明細檔)->庫存數量(F04),最後使用日期(F08)
       &&B25(部門別庫存月報表檔)->庫存部門(F01),出貨數量(F06),結存數量(F12),期末數量(F15)
       &&B39(未過帳單據)->整筆刪除
       &&K25(發票明細檔)->發票種類代號(F01),發票日期(F02),對象別(F03),統一編號(F04),發票號碼(F07),銷售金額(F08),課稅別(F09),營業稅額(F10),發票總額(F12),傳票類別(F13),收發單位(F18),月份(F19)
       IF TTL1(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)>0 AND LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))<10
          =MESSAGEBOX('請補發票號碼再過帳!',0+48,'提示訊息視窗')
          RETURN
       ENDIF
       IF DATE()-CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)>=7   &&如果出貨日期超過七天
          IF B04_1.F22='31'  
             ODM=VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))%2
             MMM=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))+ODM-1))          
             K39='K39'+MMM
             IF FILE(K39+'.DBF')  &&如果有找到計算機發票              
                K39='K39'+MMM
                IF !USED('&K39')
                   SELECT 0
                   USE (K39) ALIAS K39
                ELSE
                   SELECT K39
                ENDIF
                SET ORDER TO 2
                SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE
                IF FOUND()
                   SELECT K39
                   USE 
                   =MESSAGEBOX("此出貨單已超過發票上傳時間，請更改發票號碼與日期再過帳!",0+48,"提示訊息視窗")
                   RETURN
                ELSE
                   SELECT K39
                   USE
                ENDIF
             ENDIF 
          ENDIF
       ENDIF
       IF MESSAGEBOX('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	        
          SELECT B04 
          SET RELATION OFF INTO B01
          SET RELATION OFF INTO A14
          SET RELATION OFF INTO B11
          THISFORM.PAGEFRAME1.PAGE1.PASS_CND.BACKCOLOR=RGB(255,255,0)    
          SELE RECNO() FROM B04 WHERE B04.F01=B04_1.F01  AND F10<>'2' INTO ARRAY BK1              
               JJ1=''                
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK1)
                      JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                  ENDFOR    
                  KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                  RLOCK(KK1,'B04')
                  LL1=RLOCK(KK1,'B04')
               ELSE
                  LL1=.T.   
               ENDIF                   
               SELE RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F01= ANY (SELE F07 FROM B04 WHERE F01=B04_1.F01) INTO ARRAY BK2
               JJ2=''                
               IF _TALLY>0                   
                  FOR I= 1 TO ALEN(BK2)
                      JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                   ENDFOR  
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
                   RLOCK(KK2,'C05')
                   LL2=RLOCK(KK2,'C05')
               ELSE
                  LL2=.T.   
               ENDIF   
               SELE RECNO() FROM C01 WHERE F01=B04_1.F06 INTO ARRAY BK5
               JJ5=''
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK5)
                      JJ5=JJ5+ALLTRIM(STR(BK5(I)))+','
                  ENDFOR    
                  KK5=STUFF(JJ5,RAT(',',JJ5,1),1,'')              
                  RLOCK(KK5,'C01')
                  LL5=RLOCK(KK5,'C01')
               ELSE
                  LL5=.T.   
               ENDIF                   
               IF LL1 .AND. LL1 .AND. LL2 .AND. LL5=.T. 
                  IF LEN(ALLTRIM(JJ1))>0 
                     IF !USED('E08')    &&開啟預期結餘檔
                        SELECT 0
                        USE E08
                     ELSE
                        SELECT E08
                     ENDIF
                     SET ORDER TO E083       
                     SELE B04
                     TQTY=0
                     FTTL=0
                     FOR I= 1 TO ALEN(BK1)                      
                         GO BK1(I) 
                         TQTY=TQTY+F17				&&小計
                         FTTL=FTTL+ROUND(F04*F15,2)	&&外幣金額小計
                         SELE B01                                            &&物料基本主檔
                         SEEK B04.F79                     
                         IF FOUND()                                          &&物料基本主檔存在才做運算    
                            IF !EMPTY(F98)                                   &&如果不是虛擬料號才做庫存運算                            
                               SELE B11                                            &&部門庫存明細檔 
                               SEEK B04.F05+B04.F79+IIF(INT_028 AND B01.F98<>'A  ',B04.F06,SPACE(5))
                               IF FOUND()
                                  REPL F04 WITH F04+(B04.F04+B04.F13)*(-1)
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='扣除庫存明細(A)'
                                  IF F04=0
                                     DELE
                                  ELSE   
                                     IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02))
                                        REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02))
                                     ENDIF
                                  ENDIF   
                               ELSE
                                  APPEND BLANK
                                  REPL F01 WITH B04.F05
                                  REPL F03 WITH B04.F79
                                  REPL F04 WITH (B04.F04+B04.F13)*(-1)
                                  REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02))
                                  IF INT_028 AND B01.F98<>'A  '
                                      REPLACE F08 WITH B04.F06
                                   ENDIF   
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='扣除庫存明細(B)'                                  
                               ENDIF   
                               SELE B25                                             &&分部門庫存月報表 
                               SEEK B04.F05+B04.F79
                               IF FOUND()
                                  REPL F06 WITH F06+B04.F04+B04.F13
                                  REPL F15 WITH F15+(B04.F04+B04.F13)*(-1)
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='庫存月報表(A)'                                                                                                
                               ELSE
                                  APPEND BLANK
                                  REPL F01 WITH B04.F05
                                  REPL F02 WITH B04.F79
                                  REPL F06 WITH B04.F04+B04.F13
                                  REPL F15 WITH (B04.F04+B04.F13)*(-1)   
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='庫存月報表(B)'                                                                                                                                               
                               ENDIF   
                               SELE B26                                            &&庫存異動紀錄
                               APPEND BLANK
                               REPL F01 WITH B04.F79
                               REPL F02 WITH B04.F05
                               REPL F03 WITH B04.F02
                               REPL F04 WITH (B04.F04+B04.F13)*(-1)
                               REPL F06 WITH 'C'
                               REPL F07 WITH B04.F01
                               REPL F08 WITH '訂'+B04.F07+' '+IIF(SEEK(B04.F06,'C01'),C01.F05,'')
                               THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='異動紀錄'                                                                                                          
                            ENDIF
                         ENDIF 
                         SELE C05                                            &&出貨計劃
                         SET ORDER TO C054                 
                         SEEK B04.F07+B04.F03
                         IF FOUND()
                            QTY=B04.F04+B04.F13
                            DO WHILE F01+F02=B04.F07+B04.F03 
                               DO CASE 
                                  CASE QTY=F05 
                                       SELE C05
                                       REPL F04 WITH F04+F05*(-1)
                                       REPL F05 WITH F05+QTY*(-1)
                                       IF F04=0
                                          DELETE
                                       ELSE
                                          IF F04<F14
                                             REPLACE F14 WITH F04
                                          ENDIF   
                                       ENDIF   
                                       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='扣除出貨計劃(C)'
                                       EXIT
                                  CASE QTY>F05  
                                       SELE C05                              
                                       QTY=QTY+F05*(-1)  
                                       DELE     
                                       SKIP
                                  CASE QTY<F05
                                       SELE C05                               
                                       REPL F04 WITH F04+QTY*(-1)
                                       REPL F05 WITH F05+QTY*(-1)
                                       IF F04<F14
                                          REPLACE F14 WITH F04
                                       ENDIF
                                       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='扣除出貨計劃(C)'
                                       EXIT
                               ENDCASE
                            ENDDO                   
                            SELECT E08   &&預期結餘量也要加回去
                            SEEK B04.F03
                            IF FOUND()
                               REPLACE F20 WITH F20+(B04.F04+B04.F13)
                            ELSE
                               APPEND BLANK
                               REPLACE F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02)
                               REPLACE F02 WITH B04.F03
                               REPLACE F20 WITH B04.F04+B04.F13
                            ENDIF               
                         ENDIF                   
                                       
                         SELE C04           &&訂單表身
                         SEEK B04.F07+B04.F03
                         IF FOUND()
                             REPL F09 WITH F09+(B04.F04+B04.F13)
                             REPL F10 WITH F10+(B04.F04+B04.F13)*(-1)
                             REPL F23 WITH F23+(B04.F04+B04.F13)*(-1)
                             REPL F18 WITH F18+B04.F04
                             REPL F19 WITH F19+B04.F13
                             THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='訂單表身狀態'                             
                         ENDIF    
                         SELE C03          &&訂單表頭
                         SEEK B04.F07
                         IF FOUND()
                            IF F08<>.T. 
                               REPL F08 WITH .T.
                               THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='訂單表頭狀態'                               
                            ENDIF   
                         ENDIF 
                         SELE C06         &&出貨紀錄
                         APPEND BLANK
                         REPL F01 WITH B04.F07
                         REPL F02 WITH B04.F03
                         REPL F03 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02)
                         REPL F04 WITH B04.F01
                         REPL F05 WITH B04.F04+B04.F13
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='出貨紀錄'                         
                         SELE C10         &&出貨日報表
                         APPEND BLANK
                         REPL F01 WITH B04.F02
                         REPL F02 WITH B04.F06
                         REPL F03 WITH B04.F03
                         REPL F04 WITH B04.F01
                         REPL F05 WITH B04.F07
                         REPL F06 WITH INT_011
                         REPL F07 WITH B04.F17/(B04.F04+B04.F13)/IIF(B04.F22>'31' .AND. B04.F23='1',1+INT_002/100,1)
                         REPL F08 WITH B04.F04+B04.F13
                         REPL F09 WITH IIF(SEEK(C10.F02,'C01'),C01.F05,'')
                         REPL F10 WITH  IIF(SEEK(C10.F02,'C01'),C01.F18,'')
                         REPL F11 WITH  IIF(SEEK(C10.F10,'A01'),A01.F03,'')
                         REPL F12 WITH  IIF(SEEK(C10.F02,'C01'),IIF(EMPTY(C01.F33),C10.F10,C01.F33),"")
                         REPL F13 WITH  IIF(SEEK(C10.F12,'A01'),A01.F03,'')
                         REPL F14 WITH  IIF(SEEK(C10.F02,'C01'),C01.F23,'')
                         REPL F15 WITH  IIF(SEEK(C10.F14,'A01'),A01.F03,'')
                         REPLACE F16 WITH IIF(SEEK(B04.F07,'C03'),C03.F14,'')
                         REPLACE F17 WITH IIF(SEEK(B04.F07+B04.F03,'C04','C041'),C04.F13+C04.F17,'')
                         REPLACE F79 WITH B04.F79
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='出貨日報表'                                                  
                         IF B04.F02<=IIF(SEEK(B04.F06,'C01'),C01.F17,'')
                            SELE C13         &&應收帳款明細
                         ELSE
                            SELE C1C       &&應收帳款到下個月或暫存檔
                         ENDIF      
                         APPEND BLANK
                         REPL F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02)
                         REPL F02 WITH B04.F01
                         REPL F03 WITH B04.F06
                         REPL F04 WITH B04.F07
                         REPL F05 WITH B04.F03
                         REPL F06 WITH B04.F04+B04.F13
                         REPL F07 WITH (B04.F04*B04.F15)/(B04.F04+B04.F13)
                         REPL F08 WITH B04.F17
                         REPL F09 WITH IIF(SEEK(B04.F06,'C01'),C01.F15,'1')
                         REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                         REPL F13 WITH B04.F14
                         REPL F14 WITH B04.F16
                         REPL F15 WITH IIF(SEEK(B04.F07,'C03'),'訂單:'+C03.F14,'')+IIF(SEEK(B04.F07+B04.F03,'C04'),'品號:'+C04.F17,'')
                         REPLACE F16 WITH ICASE(B04.F23='2','00',B04.F23='3','09',B04.F23='1' AND B04.F22='31','03',B04.F23='1' AND B04.F22='32','02','06')
                         REPL F17 WITH B04.F20
                         REPL F19 WITH  IIF(SEEK(B04.F07,'C03'),C03.F07,'')
                         REPLACE F79 WITH B04.F79
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='應收帳款對帳單(未稅)'  
                         IF IIF(SEEK(B04.F03,'B01'),B01.F97,'N') = 'Y' AND B04.F13 <> 0 AND B04.F04 = 0 &&紀錄樣品線材
                            SELECT C39	
                            APPEND BLANK
                            REPLACE C39.F01 WITH B04.F06	
                            REPLACE C39.F02 WITH B04.F03
                            REPLACE C39.F03 WITH CTOD(ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE) + '/' + B04.F02)
                            REPLACE C39.F04 WITH B04.F01
                            REPLACE C39.F05 WITH B04.F13
                            REPLACE C39.F06 WITH IIF(INT_209 = 'A',C10.F10,C10.F12)
                            REPLACE C39.F07 WITH B04.F12
		                    REPLACE C39.F09 WITH B04.F05
		                    REPLACE C39.F10 WITH C10.F14
                            REPLACE C39.F99 WITH B04.F11
                         ENDIF                        
                         SELE B04
                         CHK_NAME=B04.F11
                         REPL F10 WITH '2'
                         REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='出貨單表身' 
                                                                          
                    ENDFOR   
                    SELECT E08   &&將預其結餘檔關閉
                    USE
                    IF LEN(ALLTRIM(B04_1.F20))=10  AND  INT_060=.T. &&如果有發票號碼且要帶入發票管理
                       IF B04_1.F23='1' .AND. B04_1.F22='31'                 &&且應稅且為三聯式發票再加入應收帳款中 
                          IF B04.F02<=IIF(SEEK(B04.F06,'C01'),C01.F17,'')
                             SELE C13         &&應收帳款明細
                          ELSE
                             SELE C1C       &&應收帳款到下個月或暫存檔
                          ENDIF                          
                          APPEND BLANK
                          REPL F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04_1.F02)
                          REPL F02 WITH B04_1.F01
                          REPL F03 WITH B04_1.F06
                          REPL F04 WITH '稅額'
                          REPL F05 WITH '發票:'+B04_1.F20
                          REPL F06 WITH 1
                          REPL F07 WITH ROUND(TQTY*INT_002/100/B04.F16,IIF(B04.F14=INT_011,INT_069,2)) 
                          REPL F08 WITH ROUND(TQTY*INT_002/100,INT_069)
                          REPL F09 WITH IIF(SEEK(B04_1.F06,'C01'),C01.F15,'1')
                          REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                          REPL F13 WITH B04.F14
                          REPL F14 WITH B04.F16                     
                          REPL F17 WITH B04_1.F20
                          REPL F19 WITH  IIF(SEEK(B04.F07,'C03'),C03.F07,'')
                          THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='應收帳款對帳單(稅額)'                                                   
                       ENDIF
                       IF B04_1.F02<=IIF(SEEK(B04_1.F06,'C01'),C01.F17,'')
                          SELE K25         &&發票明細檔表身
                       ELSE
                          SELE K2E        &&發票明細到下個月或暫存檔表身
                       ENDIF                          
                       SEEK B04_1.F22+B04_1.F20  &&先看有無重覆的發票號碼
                       IF !FOUND()
                           FLG='0'
                           APPEND BLANK
                           REPLACE  F01 WITH B04_1.F22
                           REPLACE  F07 WITH B04_1.F20                                &&發票號碼
                           IF B04_1.F02<=IIF(SEEK(B04_1.F06,'C01'),C01.F17,'')
                              REPLACE  F02 WITH B04.F02
                              REPLACE  F19 WITH THISFORM.MTH_LIST.DISPLAYVALUE 
                           ELSE
                              REPLACE  F02 WITH '01'
                              LON1=PADL(ALLTRIM(STR(VAL(RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2))+1)),2,'0')
                              LON2=IIF(LON1>'12',PADL(ALLTRIM(STR(VAL(RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,4))+1)),4,'0')+'/01',LEFT(THISFORM.MTH_LIST.DISPLAYVALUE,5)+LON1)
                              REPLACE F19 WITH LON2                          
                           ENDIF                                                                  
                           REPLACE  F03 WITH B04_1.F06                                &&客戶編號
                           IF F01='31'
                              REPLACE  F04 WITH IIF(SEEK(B04.F06,'C01'),C01.F10,'')      &&統一編號
                           ENDIF
                           REPLACE  F05 WITH B04_1.F08                                &&是否經海關->' ' 不出口 '1'不經海關  '2'經海關 
                           REPLACE  F09 WITH B04_1.F23                                &&課稅別(1-應 2-零  3-免)      
                           REPLACE  F13 WITH '00'
                           REPLACE  F15 WITH B04_1.F01+IIF(B01.F97='Y','製品','商品')
                           REPLACE  F16 WITH '1'
                           REPLACE  F18 WITH '01'
                           REPLACE  F20 WITH ALLTRIM(B04_1.F24)
                           REPLACE  F21 WITH B04.F14
                           REPLACE  F22 WITH B04.F16
                       ELSE
                          FLG='1'   &&紀錄是否重覆發票
                       ENDIF    
    
*!*	                       IF F05='2' 
*!*	                          REPL F06 WITH B04_1.F21                             &&報單號碼
*!*	                       ENDIF   
                       
                                           
                       IF F01='31'                                            		     &&若為銷項三聯式. 電子計算機
                          REPLACE  F08 WITH F08+TQTY         			     &&銷售金額 >> 小計
                          REPLACE  F10 WITH ROUND(F08*INT_002/100,INT_069)*IIF(F09='1',1,0) &&營業稅額=ROUND(小計*採購訂單稅率,應收對帳單四捨五入)
                          REPLACE  F12 WITH F08+F10				     &&發票總額
                       ELSE
                          REPLACE  F12 WITH F12+TQTY
                          REPL F08 WITH ROUND(F12/IIF(F09='1',1+(INT_002/100),1),INT_069)
                          REPL F10 WITH F12-F08
                       ENDIF                                                                                               
                       REPLACE  F23 WITH F23+FTTL
                       REPLACE  F24 WITH ALLTRIM(CHK_NAME)
                       *******以類別分類
                       IF B04_1.F02<=IIF(SEEK(B04_1.F06,'C01'),C01.F17,'')
                          SELE K24         &&發票明細檔表頭
                       ELSE
                          SELE K2D        &&發票明細到下個月或暫存檔表頭
                       ENDIF                          
                       SET ORDER TO 1	 && F01
                       SEEK B04_1.F22
                       IF FOUND()      
                           IF B04_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH F03+TQTY         												  &&銷售金額
                               REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0))      &&營業稅總額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0)))	&&發票總額	
                           ELSE
                               REPLACE F05 WITH F05+TQTY				 							               &&發票總額
                               REPLACE F03 WITH F03+ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069)       &&銷售金額
                               REPLACE F04 WITH F04+(TQTY-ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069))       &&營業總額
                           ENDIF               
                           IF FLG<>'1'  &&如果發票號碼未重覆
                              DO CASE
                                 CASE  B04_1.F23='1'
                          		       REPLACE F06 WITH F06+1    &&應稅張數
                          	     CASE  B04_1.F23='2'
                          	 	       REPLACE F07 WITH F07+1    &&零稅張數
                          	     CASE  B04_1.F23='3'	      
                          	  	       REPLACE F08 WITH F08+1   &&免稅張數
                              ENDCASE
                           ENDIF   		     
                       ELSE
                           APPEND BLANK 
                           REPLACE F01 WITH B04_1.F22
                           IF B04_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH TQTY         												&&銷售金額
                               REPLACE F04 WITH ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0)      &&營業總額
                               REPLACE F05 WITH F03+F04										&&發票總額
                           ELSE
                               REPLACE F05 WITH TQTY				 							               &&發票總額
                               REPLACE F03 WITH ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069)    &&銷售金額
                               REPLACE F04 WITH F05-F03                          							&&營業總額
                           ENDIF   
                           DO CASE
                                  CASE  B04_1.F23='1'
                          		      REPLACE F06 WITH 1   &&應稅張數
                          	  CASE  B04_1.F23='2'
                          	 	      REPLACE F07 WITH 1    &&零稅張數
                          	  CASE  B04_1.F23='3'	      
                          	  	      REPLACE F08 WITH 1   &&免稅張數
                           ENDCASE
                       ENDIF  
                        *********以對象編號分類
                        SET ORDER TO 2	&& F02
                        SEEK B04_1.F06
                        IF FOUND()      
                           IF B04_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH F03+TQTY         												&&銷售金額
                               REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0))      &&營業總額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0)))	&&發票總額	
                           ELSE
                               REPLACE F05 WITH F05+TQTY				 							               &&發票總額
                               REPLACE F03 WITH F03+ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069)    &&銷售金額
                               REPLACE F04 WITH F04+(TQTY-ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069))          &&營業總額
                           ENDIF                            
                           IF FLG<>'1'
                              DO CASE
                                 CASE  B04_1.F23='1'
                          		       REPLACE F06 WITH F06+1    &&應稅張數
                          	     CASE  B04_1.F23='2'
                          	 	       REPLACE F07 WITH F07+1    &&零稅張數
                          	     CASE  B04_1.F23='3'	      
                          	  	       REPLACE F08 WITH F08+1   &&免稅張數
                              ENDCASE
                           ENDIF   	
                        ELSE
                            APPEND BLANK 
                            REPLACE F02 WITH B04_1.F06
                            IF B04_1.F22='31'                                            &&若為三聯式發票
                                REPLACE F03 WITH TQTY         												&&銷售金額
                                REPLACE F04 WITH ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0)      &&營業總額
                                REPLACE F05 WITH F03+F04										&&發票總額
                            ELSE
                                REPLACE F05 WITH TQTY				 							               &&發票總額
                                REPLACE F03 WITH ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069)    &&銷售金額
                                REPLACE F04 WITH F05-F03                          							&&營業總額
                            ENDIF   
                           DO CASE
                                  CASE  B04_1.F23='1'
                          		      REPLACE F06 WITH 1   &&應稅張數
                          	  CASE  B04_1.F23='2'
                          	 	      REPLACE F07 WITH 1    &&零稅張數
                          	  CASE  B04_1.F23='3'	      
                          	  	      REPLACE F08 WITH 1   &&免稅張數
                           ENDCASE
                        ENDIF                      
                       *****                
                       IF FLG='1'   &&若發票單號重覆
                          IF !USED('K2F')
                             SELECT 0
                             USE K2F
                          ELSE
                             SELECT K2F
                          ENDIF
                          SET ORDER TO 1
                          APPEND BLANK
                          REPLACE F01 WITH B04_1.F20
                          REPLACE F02 WITH B04_1.F01
                          REPLACE F03 WITH IIF(B01.F97='Y','B','A')
                          REPLACE F04 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+'01')
                          REPLACE F99 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                          SELECT K2F
                          USE                          
                       ENDIF
                       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='發票明細檔'     
                       FLG='0'                                                                                           
                    ENDIF                                                   
                    SELE C01                     &&客戶基本主檔
                    SEEK B04_1.F06
                    IF FOUND()
                       IF F16<CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04_1.F02)
                          REPL F16 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04_1.F02)
                          THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='客戶最後交易日'                                                                                                   
                      ENDIF   
                    ENDIF                    
                    SELE B39                    &&未過帳庫存單據查詢檔
                    SEEK 'B04'+B04_1.F01
                    IF FOUND()
                       DELE
                       THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='清除未過帳單據'                                                                         
                    ENDIF                                             
                    SELE B04_1
                    REPL F10 WITH '2'
                    REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='完成過帳程序'                                                                                             
                  ELSE
                     =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                     SELE B04_1
                     REPL F10 WITH '2'
                  ENDIF           
                  THIS.ENABLED=.F.
                  THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                  THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
                  UNLOCK ALL
                  SELECT B04
                  SET RELATION TO F03 INTO B01
                  SET RELATION TO F05 INTO A14 ADDITIVE 
                  SET RELATION TO F05+F79 INTO B11 ADDITIVE 
                  IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                     SELECT B04_1
                     THISFORM.GRID1.SETFOCUS
                  ELSE
                     SELECT B04
                      THISFORM.GRID2.SETFOCUS
                      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
                  ENDIF
                  THISFORM.REFRESH
               ELSE
                  DO FILE_IMPACT
                  UNLOCK ALL
                 RETURN
              ENDIF   
              
       ENDIF    
       UNLOCK ALL
       RELEASE ALL LIKE BK*       
       
  ENDPROC
********************
  PROC VRT_BOTT.CLICK     &&反過帳程序  
       IF MESSAGEBOX('是否確認必須反過帳以修正單據內容?',4+32+256,'請確認') = 6	     
          IF B04_1.F01<>B04_1.F20 AND 'B'+CHR(VAL((LEFT(B04_1.F20,2))))+SUBSTR(B04_1.F20,3,4)<>LEFT(B04_1.F01,6) &&如果是正式發票
             SELECT K25
             SEEK B04.F22+B04.F20
             IF FOUND()
                IF !EMPTY(K25.F14) AND K25.F16<>'2'
                   =MESSAGEBOX('此張出貨單電子發票已上傳，請先至K17作廢該張發票再反過帳!',0+48,'提示訊息視窗')
                   IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                      SELECT B04_1               
                      THISFORM.GRID1.SETFOCUS
                   ELSE 
                      SELECT B04
                      THISFORM.GRID2.SETFOCUS
                   ENDIF        
                   RETURN
                ENDIF
             ENDIF
          ENDIF
           SELECT B04.F07,B04.F03,B04.F04+B04.F13, C04.F05-C04.F10-C04.F21-C04.F24 FROM B04,C04 WHERE B04.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE AND C04.F03+C04.F04=B04.F07+B04.F03 AND B04.F04+B04.F13>C04.F05-C04.F10-C04.F21-C04.F24 NOWAIT
           IF _TALLY>0
               =MESSAGEBOX(F07+SPACE(5)+F03+'退貨數量已大於可以反過帳之數量!此項作業不得執行!',0+48,'提示訊息視窗')
               IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                  SELECT B04_1
                    THISFORM.GRID1.SETFOCUS
                ELSE
                   SELECT B04
                    THISFORM.GRID2.SETFOCUS
                ENDIF        
               RETURN
           ENDIF    
           IF !EMPTY(B04.F20)
              IF !USED('K51')
                 SELECT 0
                 USE K51
              ELSE
                 SELECT K51
              ENDIF
              SET ORDER TO 1      
              SEEK B04.F20                
              IF FOUND()
                 =MESSAGEBOX('K08已有應收帳款請先去反帳款後再做反過帳',0+48,'提示訊息視窗')
                 RETURN
              ENDIF
              SELECT K51
              USE
          ENDIF    
          THISFORM.PAGEFRAME1.PAGE1.PASS_CND.BACKCOLOR=RGB(255,255,0)    
          SELE RECNO() FROM B04 WHERE B04.F01=B04_1.F01  AND F10='2' INTO ARRAY BK1              
               JJ1=''                
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK1)
                      JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                  ENDFOR    
                  KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                  RLOCK(KK1,'B04')
                  LL1=RLOCK(KK1,'B04')
               ELSE
                  LL1=.T.   
               ENDIF                   
               SELE RECNO() FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F01= ANY (SELE F07 FROM B04 WHERE F01=B04_1.F01) INTO ARRAY BK2
               JJ2=''                
               IF _TALLY>0                   
                  FOR I= 1 TO ALEN(BK2)
                      JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                   ENDFOR  
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
                   RLOCK(KK2,'C05')
                   LL2=RLOCK(KK2,'C05')
               ELSE
                  LL2=.T.   
               ENDIF   
*!*	               SELE RECNO() FROM C04 WHERE F03+F04=ANY (SELE F07+F03 FROM B04 WHERE F01=B04_1.F01) INTO ARRAY BK3              
*!*	               JJ3=''                
*!*	               IF _TALLY>0   
*!*	                  FOR I= 1 TO ALEN(BK3)
*!*	                      JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
*!*	                  ENDFOR    
*!*	                  KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
*!*	                  RLOCK(KK3,'C04')
*!*	                  LL3=RLOCK(KK3,'C04')
*!*	               ELSE
                   LL3=.T.   
*!*	               ENDIF                   
               SELE RECNO() FROM C13 WHERE F02=B04_1.F01 INTO ARRAY BK4
               JJ4=''
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK4)
                      JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
                  ENDFOR    
                  KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')              
                  RLOCK(KK4,'C13')
                  LL4=RLOCK(KK4,'C13')
               ELSE
                  LL4=.T.   
               ENDIF     
               SELE RECNO() FROM K25 WHERE LEFT(F15,10)=B04_1.F01 INTO ARRAY BK5
               JJ5=''
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK5)
                      JJ5=JJ5+ALLTRIM(STR(BK5(I)))+','
                  ENDFOR    
                  KK5=STUFF(JJ5,RAT(',',JJ5,1),1,'')              
                  RLOCK(KK5,'K25')
                  LL5=RLOCK(KK5,'K25')
               ELSE
                  LL5=.T.   
               ENDIF                   
               IF LL1 .AND. LL1 .AND. LL2 .AND. LL3 .AND. LL4 .AND. LL5=.T. 
                  IF LEN(ALLTRIM(JJ1))>0 
                     IF !USED('E08')   &&開啟預期結餘檔
                        SELECT 0
                        USE E08
                     ELSE
                       SELECT E08
                     ENDIF
                     SET ORDER TO E083      
                     SELE B04
                     TQTY=0
                     FOR I= 1 TO ALEN(BK1)                      
                         GO BK1(I) 
                         TQTY=TQTY+F17
                         SELE B01                                            &&物料基本主檔
                         SEEK B04.F79                        
                         IF FOUND()                                          &&物料基本主檔存在才做運算    
                            IF !EMPTY(F98)                                   &&如果不是虛擬料號才做庫存運算                            
                               SELE B11                                            &&部門庫存明細檔 
                               SEEK B04.F05+B04.F79+IIF(INT_028 AND B01.F98<>'A  ',B04.F06,SPACE(5))
                               IF FOUND()
                                  REPL F04 WITH F04+(B04.F04+B04.F13)
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='加入庫存明細(A)'
                                  IF F04=0
                                     DELE
                                  ELSE   
                                     IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02))
                                        REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02))
                                     ENDIF
                                  ENDIF   
                               ELSE
                                  APPEND BLANK
                                  REPL F01 WITH B04.F05
                                  REPL F03 WITH B04.F79
                                  REPL F04 WITH (B04.F04+B04.F13)
                                  REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02))
                                  REPLACE F06 WITH B04.F07
                                  IF INT_028 AND B01.F98<>'A  '
                                      REPLACE F08 WITH B04.F06
                                  ENDIF
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='加入庫存明細(B)'                                  
                               ENDIF   
                               SELE B25                                             &&分部門庫存月報表 
                               SEEK B04.F05+B04.F79
                               IF FOUND()
                                  REPL F06 WITH F06+(B04.F04+B04.F13)*(-1)
                                  REPL F15 WITH F15+(B04.F04+B04.F13)
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='庫存月報表(A)'                                                                                                
                               ELSE
                                  APPEND BLANK
                                  REPL F01 WITH B04.F05
                                  REPL F02 WITH B04.F79
                                  REPL F06 WITH (B04.F04+B04.F13)*(-1)
                                  REPL F15 WITH (B04.F04+B04.F13) 
                                  THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='庫存月報表(B)'                                                                                                                                               
                               ENDIF   

                               IF B01.F97='Y'
                                  SELECT C39 &&紀錄樣品線材
                                  SEEK B04.F01 + B04.F06 + B04.F03 + DTOS(CTOD(ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE) + '/' + B04.F02))
                                  IF FOUND()
                                    DELETE 
                                  ENDIF                                  
                               ENDIF   
                               
                            ENDIF
                         ENDIF  
                         SELE C05                                            &&出貨計劃
                         SET ORDER TO C054                 
                         SEEK B04.F07+B04.F03
                         IF FOUND()
                            REPLACE F04 WITH F04+(B04.F04+B04.F13)
                            REPLACE F05 WITH F05+(B04.F04+B04.F13)
                         ELSE
                            APPEND BLANK
                            REPLACE F01 WITH B04.F07
                            REPLACE F02 WITH B04.F03
                            REPLACE F03 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+ B04.F02)
                            REPLACE F04 WITH B04.F04+B04.F13
                            REPLACE F05 WITH B04.F04+B04.F13
                            REPLACE F06 WITH B04.F06
                            REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                            REPLACE F08 WITH B04.F09
                            REPLACE F09 WITH IIF(SEEK(B04.F07,'C03'),C03.F14,'')
                            REPLACE F15 WITH '1'
                         ENDIF   
                         SELE C04           &&訂單表身
                         SET ORDER TO 1
                         SEEK B04.F07+B04.F03
                         IF FOUND()
                             REPL F09 WITH F09+(B04.F04+B04.F13)*(-1)
                             REPL F10 WITH F10+(B04.F04+B04.F13)
                             REPL F23 WITH F23+(B04.F04+B04.F13)
                             REPL F18 WITH F18+B04.F04*(-1)
                             REPL F19 WITH F19+B04.F13*(-1)
                             THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='訂單表身狀態'                             
                         ENDIF    
                         SELECT E08   &&預期結餘量扣除
                         SEEK B04.F03
                         IF FOUND()
                            REPLACE F20 WITH F20+(B04.F04+B04.F13)*(-1)
                         ELSE
                            APPEND BLANK
                            REPLACE F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B04.F02)
                            REPLACE F02 WITH B04.F03
                            REPLACE F20 WITH (B04.F04+B04.F13)*(-1)
                         ENDIF                                                
                         SELE B04
                         REPL F10 WITH SPACE(1)
                         REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='出貨單表身'                                                  
                      ENDFOR   
                      SELECT B26   &&同單據異動紀錄刪除
                      DELETE FROM B26 WHERE F07=B04_1.F01
                      THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='異動紀錄'                                                                                                          
                      SELECT E08   &&預期結餘檔關閉
                      USE
                     **** 
                         SELE C10         &&出貨日報表
                         DELETE FOR F04=B04_1.F01
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='出貨日報表'                                                  
                         IF B04.F02<=IIF(SEEK(B04.F06,'C01'),C01.F17,'')
                            SELE C13         &&應收帳款明細
                         ELSE
                            SELE C1C       &&應收帳款到下個月或暫存檔
                         ENDIF      
                         DELE FOR F02 = B04_1.F01
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='應收帳款對帳單(未稅)'                    
                         SELE C06         &&出貨紀錄
                         DELETE FOR F04=B04_1.F01
                         THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='出貨紀錄'                     
                      SELE B39                    &&未過帳庫存單據查詢檔
                      APPEND BLANK
                      REPLACE F01 WITH 'B04'
                      REPLACE F02 WITH B04_1.F01
                      REPLACE F03 WITH B04.F02
                      REPLACE F04 WITH B04.F06
                      REPLACE F05 WITH B04.F05
                      REPLACE F06 WITH IIF(SEEK(B04.F05,'A14'),A14.F02,'')
*!*	                      REPLACE F08 WITH B04.F07
                      REPLACE F10 WITH '反過帳修正'                         
                      SELE B04_1
                      REPL F10 WITH ''               
                      REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                      *******如果隨貨附發票
                      IF LEN(ALLTRIM(B04_1.F20))=10  
                          IF B04_1.F02<=IIF(SEEK(B04_1.F06,'C01'),C01.F17,'')
                               K25Rec='K25'
                               SELE K25         &&發票明細檔 
                          ELSE
                               K25Rec='K2E'
                               SELE K2E       &&發票明細到下個月或暫存檔
                          ENDIF         
                          SET ORDER TO 4                 
                          SEEK B04_1.F22+B04_1.F20
                          IF FOUND() 
                              IF  &K25Rec..F16='3' .OR.  &K25Rec..F16='5'  
                                    =MESSAGEBOX('此發票已作帳款沖銷(應收),故發票部份無法作反過帳!',0+64,'提示訊息視窗')
                              ELSE
		                          IF B04_1.F02<=IIF(SEEK(B04_1.F06,'C01'),C01.F17,'')
		                             K24Rec='K24'
		                             SELECT  K24         &&發票明細檔表頭
		                          ELSE
		                             K24Rec='K2D'
		                             SELECT  K2D        &&發票明細到下個月或暫存檔表頭
		                          ENDIF      
		                          SELECT &K24Rec                   
		                          SET ORDER TO 1	 && F01                              
                                  SEEK &K25Rec..F01
                                  IF FOUND()    &&找類別    
                                     IF &K25Rec..F01='31'
                                        IF &K25Rec..F16<>'2'
                                           REPLACE &K24Rec..F03 WITH &K24Rec..F03+TQTY*(-1)    &&銷售金額
                                           REPLACE &K24Rec..F04 WITH &K24Rec..F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0))*(-1)     &&營業稅總額
                                           REPLACE &K24Rec..F05 WITH &K24Rec..F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0)))*(-1)	&&發票總額	
                                        ENDIF   
                                     ELSE
                                        IF &K25Rec..F16<>'2'
                                           REPLACE &K24Rec..F05 WITH &K24Rec..F05+TQTY*(-1)    &&發票總額 
                                           REPLACE &K24Rec..F03 WITH &K24Rec..F03+ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069)*(-1)       &&銷售金額
                                           REPLACE &K24Rec..F04 WITH &K24Rec..F04+(TQTY-ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069))*(-1)       &&營業稅額
                                        ENDIF                                               
                                     ENDIF    	                                 
                                     IF TQTY=&K25Rec..F08 OR TQTY=&K25Rec..F12  &&判斷是否是多張出貨單開一張發票
                           	            DO CASE
                                  	       CASE  &K25Rec..F09='1' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4' 
                          		                 REPLACE &K24Rec..F06 WITH &K24Rec..F06-1    &&應稅張數
                          	  	           CASE  &K25Rec..F09='2' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
                          	 	                 REPLACE &K24Rec..F07 WITH &K24Rec..F07-1    &&零稅張數
                          	  	           CASE  &K25Rec..F09='3' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'	      
                          	  	   	             REPLACE &K24Rec..F08 WITH &K24Rec..F08-1   &&免稅張數
                          	               CASE  &K25Rec..F16='2'	      
                          	       	             REPLACE &K24Rec..F09 WITH &K24Rec..F09-1   &&作廢張數
                          	               CASE  &K25Rec..F16='4'	      
                          	       	             REPLACE &K24Rec..F10 WITH &K24Rec..F10-1   &&空白張數                            	  	   	     
                           	            ENDCASE
                           	         ENDIF   		                             
	                                 IF (&K24Rec..F03+&K24Rec..F04+&K24Rec..F05+&K24Rec..F06+&K24Rec..F07+&K24Rec..F08+&K24Rec..F09+&K24Rec..F10)=0
	                                     SELECT &K24Rec
	                                     DELETE 
	                                 ENDIF       
                                  ENDIF
                                  SELECT &K24Rec       
                                  SET ORDER TO 2
                                  SEEK &K25Rec..F03
                                  IF FOUND()        &&找對象編號
                                     IF &K25Rec..F01='31'
                                        REPLACE &K24Rec..F03 WITH &K24Rec..F03+TQTY*(-1)    &&銷售金額
                                        REPLACE &K24Rec..F04 WITH &K24Rec..F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0))*(-1)     &&營業稅總額
                                        REPLACE &K24Rec..F05 WITH &K24Rec..F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B04_1.F23='1',1,0)))*(-1)	&&發票總額	
                                     ELSE
                                        REPLACE &K24Rec..F05 WITH &K24Rec..F05+TQTY*(-1)    &&發票總額 
                                        REPLACE &K24Rec..F03 WITH &K24Rec..F03+ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069)*(-1)       &&銷售金額
                                        REPLACE &K24Rec..F04 WITH &K24Rec..F04+(TQTY-ROUND(TQTY/IIF(B04_1.F23='1',1+(INT_002/100),1),INT_069))*(-1)       &&營業稅額                                            
                                     ENDIF    	             
                                     IF TQTY=&K25Rec..F08 OR TQTY=&K25Rec..F12  &&判斷是否是多張出貨單開一張發票                  
                           	            DO CASE
                                  	       CASE  &K25Rec..F09='1' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
                          		                 REPLACE &K24Rec..F06 WITH &K24Rec..F06-1    &&應稅張數
                          	  	           CASE  &K25Rec..F09='2' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
                          	 	                 REPLACE &K24Rec..F07 WITH &K24Rec..F07-1    &&零稅張數
                          	  	           CASE  &K25Rec..F09='3' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'	      
                          	  	   	             REPLACE &K24Rec..F08 WITH &K24Rec..F08-1   &&免稅張數
                          	               CASE  &K25Rec..F16='2'	      
                          	       	             REPLACE &K24Rec..F09 WITH &K24Rec..F09-1   &&作廢張數
                          	               CASE  &K25Rec..F16='4'	      
                          	       	             REPLACE &K24Rec..F10 WITH &K24Rec..F10-1   &&空白張數                               	  	   	     
                           	            ENDCASE	    
                           	         ENDIF   
                                     IF  (&K24Rec..F03+&K24Rec..F04+&K24Rec..F05+&K24Rec..F06+&K24Rec..F07+&K24Rec..F08+&K24Rec..F09+&K24Rec..F10)=0
                                         SELECT &K24Rec
                                         DELETE 
                                     ENDIF
*!*	                                         IF &K25Rec..F16='2'	
*!*	                                              SELECT &K24Rec
*!*	                                              SEEK '作廢 '
*!*	                                              IF FOUND()
*!*	                                                 REPLACE &K24Rec..F09 WITH &K24Rec..F09-1 
*!*			                                         IF  (&K24Rec..F03+&K24Rec..F04+&K24Rec..F05+&K24Rec..F06+&K24Rec..F07+&K24Rec..F08+&K24Rec..F09+&K24Rec..F10)=0
*!*			                                            SELECT &K24Rec
*!*			                                            DELETE 
*!*			                                         ENDIF                                                    
*!*	                                              ENDIF
*!*	                                         ENDIF
                                  ENDIF                 
                                    SELECT  &K25Rec     
                                    SEEK B04_1.F22+B04_1.F20
                                    IF FOUND()
                                       IF F01='31'                                            		     &&若為銷項三聯式. 電子計算機
                                          IF &K25Rec..F16<>'2'
                                             REPLACE  &K25Rec..F08 WITH &K25Rec..F08+TQTY*(-1)         			     &&銷售金額 >> 小計
                                             REPLACE  &K25Rec..F10 WITH ROUND(&K25Rec..F08*INT_002/100,INT_069)*IIF(&K25Rec..F09='1',1,0) &&營業稅額=ROUND(小計*採購訂單稅率,應收對帳單四捨五入)
                                             REPLACE  &K25Rec..F12 WITH &K25Rec..F08+&K25Rec..F10				     &&發票總額
                                          ENDIF   
                                       ELSE
                                          IF &K25Rec..F16<>'2'
                                             REPLACE  &K25Rec..F12 WITH &K25Rec..F12+TQTY*(-1)
                                             REPLACE  &K25Rec..F08 WITH ROUND(F12/IIF(&K25Rec..F09='1',1+(INT_002/100),1),INT_069)
                                             REPLACE  &K25Rec..F10 WITH &K25Rec..F12-&K25Rec..F08
                                          ENDIF   
                                       ENDIF                  
                                       IF &K25Rec..F08<=0 AND &K25Rec..F16<>'2'
                                          DELETE 
                                       ENDIF                          
                                    ENDIF
                                    DELETE FROM K2F WHERE F01=B04_1.F20
                                    THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='發票明細檔'       
                                  ENDIF     
                              ENDIF                                                                                          
                          ENDIF   
                          THISFORM.PAGEFRAME1.PAGE1.PASS_CND.CAPTION='完成過帳程序'     
                      ELSE
                         =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                         SELE B04_1
                         REPL F10 WITH ' '
                      ENDIF                                                                                                                       
                      THIS.ENABLED=.F.
                      UNLOCK ALL
                  IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                         THISFORM.GRID1.SETFOCUS
                  ELSE
                      THISFORM.GRID2.SETFOCUS
                      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
                  ENDIF
                  THISFORM.REFRESH
               ELSE
                  DO FILE_IMPACT
                  UNLOCK ALL
                 RETURN
                ENDIF   
            ENDIF    
       UNLOCK ALL
       RELEASE ALL LIKE BK*       
  ENDPROC  
***********************  
PROC TRN_BOTT.CLICK          &&轉入C22.INVOICE
   IF MESSAGEBOX('是否確認資料無誤可以轉入INVOICE?',4+32+256,'請確認') = 6
       IF SEEK(B04.F01,'C22')=.F.	             
          IF!USED('C20')
              SELECT 0
              USE C20
           ELSE
              SELECT C20
           ENDIF     
           SET ORDER TO 1  
          IF RLOCK('B04') 
             IF !USED('C22')
                SELE 0
                USE C22
             ELSE
                SELE C22
             ENDIF
             SET ORDER TO C221
             IF !USED('C23')
                SELE 0
                USE C23
             ELSE
                SELE C23
             ENDIF   
             SET ORDER TO C231
             SELE B04
             SEEK B04_1.F01
             IF FOUND()
                HD='C022 '+SUBSTR(DTOS(DATE()),3,4)
                HD1='C022 '
                HD2='CD'
                HD3='INVOICE'
                DO ODR_CRT   &&執行主程式單據編號流程
                IF SEEK(PO_NO,'C22')=.T.      &&如果編號重複
                   SELECT MAX(F01) FROM C22 INTO ARRAY GB NOWAIT
                   HD='C022 '+SUBSTR(DTOS(DATE()),3,4)+PO_NO
                   DO ODR_RPT
                ENDIF 
                SELE C22
                APPEND BLANK
                REPL F01 WITH PO_NO
                REPL F02 WITH DATE()
                REPL F03 WITH B04.F06
                REPL F04 WITH B04.F01
                REPL F05 WITH IIF(SEEK(B04.F06,'C01'),IIF(EMPTY(C01.F09),C01.F04,C01.F09),'')
                REPL F06 WITH IIF(SEEK(B04.F06,'C01'),IIF(EMPTY(C01.F08),C01.F07,C01.F08),'')
                REPL F07 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE +'/'+B04.F02)
                REPL F08 WITH IIF(SEEK(B04.F06,'C01'),C01.F24,'')
                REPL F09 WITH ''
                REPL F10 WITH 'TOK'
                REPL F11 WITH 'TAIWAN'
                REPL F12 WITH ''
                REPL F13 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                SELECT  B04
                SELECT F01,F03,F04,F06,F07,F14,F15,F79 FROM B04 WHERE F01=ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)  INTO CURSOR B04A              
                SELECT B04A
	            GO TOP
	            DO WHILE !EOF()
	               SELECT C23	
	               APPEND BLANK 
	               REPLACE F01 WITH PO_NO
	               REPLACE F02 WITH B04A.F03
		           REPLACE F03 WITH B04A.F04
		           REPLACE F04 WITH B04A.F15
		           REPLACE F05 WITH IIF(SEEK(B04A.F07+B04A.F03,'C04'),C04.F17,'')  &&客戶品號
		           REPLACE F06 WITH IIF(SEEK(B04A.F07,'C03'),C03.F14,'') &&PO/NO
		           REPLACE F07 WITH B04A.F14
	               REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	               REPLACE F09 WITH IIF(SEEK(B04A.F07+B04A.F03,'C04'),C04.F25,IIF(SEEK(B04A.F03,'B01'),B01.F02,''))
	               REPLACE F13 WITH IIF(SEEK(B04A.F03,'C20'),C20.F04,'')
	               REPLACE F79 WITH B04A.F79
	               SELECT B04A
	               SKIP
                ENDDO   
             ENDIF   
             UNLOCK ALL
             SELE C23
             USE
             =MESSAGEBOX('轉入成功,INVOICE單號'+PO_NO,0+48,'請至C22 INVOICE再次確認')         
                THISFORM.GRID1.SETFOCUS
                THISFORM.TRN_BOTT.ENABLED=.F. 
          ELSE 
             DO FILE_IMPACT
             UNLOCK ALL
             RETURN
          ENDIF
        ELSE
           =MESSAGEBOX('此出貨單號'+B04.F01+'已轉入INVOICE請勿重複轉入',0+48,',請至C22 INVOICE查詢')
        ENDIF
        SELECT C20
        USE     
     ENDIF
       SELECT C22
       SET ORDER TO C223   
       THISFORM.GRID1.SETFOCUS
  ENDPROC  
  PROCEDURE XLS_BOTT.CLICK
          
     IF MESSAGEBOX('是否依包裝基量轉出資料?',4+32+256,'請確認')=6
        LK=B04_1.F01  
        CREATE CURSOR B04_4(F01 C(10))        
        SELECT  B04_4
        APPEND BLANK 
        REPLACE F01 WITH LK        
        SELECT F01 FROM B04_1 WHERE B04_1.F02=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE AND B04_1.F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND B04_1.F01<>LK INTO CURSOR B04_3 ORDER BY F01 NOWAIT
        IF _TALLY>0           
           PBKB04_SEEK=createobject("PBKB04_SEEK")  
           PBKB04_SEEK.SHOW                
        ENDIF
        PCKORD=CREATEOBJECT("PCKORD")  
        PCKORD.SHOW         
     ELSE
        IF THISFORM.KEY_LIST.VALUE=1 
            IF MESSAGEBOX('是否只轉本張出貨單資料',4+32+256,'請確認') = 6	                       
               LK=B04_1.F01               
            ELSE
               LK=''
            ENDIF
            SELECT B04.F01 單據編號,;
            B04.F03 料品編號,;
            C04.F17 客戶品號,;  
            B04.F04 計價數量,;           
            C03.F14 客戶單號,;   
            B04.F02 出貨日期,; 
            IIF(SEEK(B04.F07+B04.F03,'C04'),C04.F25,B01.F02) 品名規格,;                       
            B04.F13 無價數量,;                                        
            B04.F05 出貨部門,;
            B04.F06 客戶編號,;
            B04.F07 訂單編號,; 
            B04.F09 業務編號,;
            B04.F12 表頭備註,;  
            B04.F14 幣別,;
            B04.F15 單價,;
            B04.F16 匯率,;
            B04.F17 本幣別小計,;
            B04.F20 發票號碼,;
            B04.F21 表身備註,;
            ICASE(B04.F23='1','應',B04.F23='2','零','免') 稅別,;
            B04.F24 出貨指示 ,;
            C01.F04 客戶名稱,;
            C01.F07 送貨地址,;
            C01.F08 英文地址,;
            C01.F10 統一編號,;
            C01.F12 聯絡人,;
            C01.F13 聯絡電話,;
            C01.F24 付款方式,;
            BILL(B01.F49) 產地別,;
            B01.F04 單位;            
           FROM B04,C01,C03,C04,B01 WHERE B04.F01=LK AND C01.F01=B04.F06 AND C03.F02=B04.F07 AND C04.F03=B04.F07 AND C04.F04=B04.F03;
           AND B01.F01=B04.F03 ORDER BY B04.F03 NOWAIT
         ELSE
            LK=B04_1.F06
            SELECT LK 客戶編號,;
            C01.F04 客戶名稱,;
            B04.F01 單據編號,;
            B04.F02 出貨日期,;
            B04.F03 料品編號,;
            IIF(SEEK(B04.F07+B04.F03,'C04'),C04.F25,B01.F02) 品名規格,;            
            B04.F04 計價數量,;
            B04.F13 無價數量,;     
            C03.F14 客戶單號,;
            C04.F17 客戶品號,;                   
            B04.F05 出貨部門,;            
            B04.F07 訂單編號,; 
            B04.F09 業務編號,;
            B04.F12 表頭備註,;  
            B04.F14 幣別,;
            B04.F15 單價,;
            ROUND(B04.F04*B04.F15,2) 原幣別小計,;
            B04.F16 匯率,;
            B04.F17 本幣別小計,;
            B04.F20 發票號碼,;
            B04.F21 表身備註,;
            ICASE(B04.F23='1','應',B04.F23='2','零','免') 稅別,;
            B04.F24 出貨指示 ,;                        
            C01.F07 送貨地址,;
            C01.F08 英文地址,;
            C01.F10 統一編號,;
            C01.F12 聯絡人,;
            C01.F13 聯絡電話,;
            C01.F24 付款方式,;
            BILL(B01.F49) 產地別,;
            B01.F04 單位;            
            FROM B04,C01,C03,C04,B01 WHERE B04.F06=LK AND C01.F01=LK AND C03.F02=B04.F07 AND C04.F03=B04.F07 AND C04.F04=B04.F03;
            AND B01.F01=B04.F03 ORDER BY B04.F01,B04.F03 NOWAIT
         ENDIF  
     ENDIF      
           IF _TALLY>0
	          GCDELIMFILE=PUTFILE('儲存路徑',IIF(!EMPTY(LK),LK,LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)+'出貨單'),'XLS')
	          IF EMPTY(GCDELIMFILE)  && ESC PRESSED
	             RETURN
	          ELSE
	            ON ERROR DO FILE_IMPACT	           
	             COPY TO (GCDELIMFILE) TYPE XL5   
	             =MESSAGEBOX('儲存成功',0+48,'提示訊息視窗')       
	          ENDIF             
          ENDIF
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        THISFORM.GRID1.SETFOCUS
     ELSE
        THISFORM.GRID2.SETFOCUS
     ENDIF
  ENDPROC
 
ENDDEFINE
************************************************依包裝方式轉EXCEL選擇類別
DEFINE CLASS PCKORD AS FORM
  AUTOCENTER=.T.
  CAPTION='請選擇轉出內容'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*210
  WIDTH=INT_015*245
  FONTSIZE=INT_015*9
  CLOSABLE=.F.
  CONTROLBOX=.F.
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='PCKORD'
ADD OBJECT DATA_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*17,;
      TOP=INT_015*20,;
      AUTOSIZE=.T.,;
      FONTSIZE=INT_015*12,;
      BUTTONCOUNT=6,;
      OPTION1.CAPTION='只轉內包裝資料',;
      OPTION1.TOP=INT_015*0,;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='只轉外包裝資料',;
      OPTION2.TOP=INT_015*30,;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.AUTOSIZE=.T.,;
      OPTION3.CAPTION='全部內外包資料',;
      OPTION3.TOP=INT_015*60,;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.AUTOSIZE=.T.,;        
      OPTION4.CAPTION='依訂單料號彙總',;
      OPTION4.TOP=INT_015*90,;
      OPTION4.FONTSIZE=INT_015*9,;
      OPTION4.AUTOSIZE=.T.,;              
      OPTION5.CAPTION='依料號包裝彙總',;
      OPTION5.TOP=INT_015*120,;
      OPTION5.FONTSIZE=INT_015*9,;
      OPTION5.AUTOSIZE=.T.,;
      OPTION6.CAPTION='依客戶料號包裝彙總',;
      OPTION6.TOP=INT_015*150,;
      OPTION6.FONTSIZE=INT_015*9,;
      OPTION6.AUTOSIZE=.T.,;
      NAME='DATA_OPTION'   
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*175,;     
      TOP=INT_015*23,;  
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*10,;
      CAPTION='\<Y.確定',;
      TOOLTIPTEXT='確認所選擇的鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*175,;
      TOP=INT_015*61,;
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*10,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'     
  *****      
 PROC INIT  
      
 ENDPROC  
 PROCEDURE CMND1.CLICK     
           IF!USED('C20')
              SELECT 0
              USE C20
           ELSE
              SELECT C20
           ENDIF     
           SET ORDER TO 1
           CREATE CURSOR TMP1 (出貨單號 C(10),料品編號 C(43),客戶料號 C(30),數量 N(7),出貨日期 C(2),訂單號碼 C(10),客戶單號 C(20),備註說明 C(30),產地 C(30),毛重 N(14,9),淨重 N(14,9),包裝方式 C(30))        
  	       IF THISFORM.DATA_OPTION.VALUE=1 OR THISFORM.DATA_OPTION.VALUE=3    
  	          SELECT B04_4
  	          GO TOP
  	          LK=B04_4.F01
  	          DO WHILE !EOF()
                 SELECT B04
                 SEEK B04_4.F01
                 IF FOUND()
                    DO WHILE B04.F01=B04_4.F01
                       QTY=B04.F04+B04.F13                
                       SELECT C20
                       SEEK B04.F03
                       IF FOUND()
                          X=VAL(C20.F03)
                          IF X<>0
                             DO WHILE .T.
                                SELECT TMP1                 
                                APPEND BLANK
                                REPLACE 出貨單號 WITH B04.F01
                                REPLACE 料品編號 WITH B04.F03
                                REPLACE 客戶料號 WITH IIF(SEEK(B04.F07+B04.F03,'C04'),C04.F17,'')
                                REPLACE 訂單號碼 WITH B04.F07
                                REPLACE 客戶單號 WITH IIF(SEEK(B04.F07,'C03'),C03.F14,'')                              
                                REPLACE 出貨日期 WITH B04.F02                    
                                REPLACE 備註說明 WITH ALLTRIM(B04.F21)        
                                REPLACE 產地     WITH IIF(SEEK(B04.F03,'C20'),C20.F04,'')       
                                REPLACE 包裝方式 WITH IIF(SEEK(B04.F03,'C20'),C20.F02,'')
                                QTY=QTY+X*(-1)
                                IF QTY>0
                                   REPLACE 數量 WITH X
                                   REPLACE 毛重     WITH IIF(SEEK(B04.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                   REPLACE 淨重     WITH IIF(SEEK(B04.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                                ELSE
                                   REPLACE 數量 WITH QTY+X
                                   REPLACE 毛重     WITH IIF(SEEK(B04.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                   REPLACE 淨重     WITH IIF(SEEK(B04.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                                   EXIT
                                ENDIF                             
                            ENDDO
                          ELSE
                             =MESSAGEBOX('料號'+B04.F03+'包裝基量為0',0+48,'提示訊息視窗')  
                          ENDIF
                       ELSE
                           =MESSAGEBOX('料號'+B04.F03+'未建C20資料',0+48,'提示訊息視窗')  
                       ENDIF
                       SELECT B04
                       SKIP                       
                    ENDDO
                 ENDIF 
                 SELECT B04_4                 
                 SKIP
                 
              ENDDO                 
           ENDIF     
           IF THISFORM.DATA_OPTION.VALUE=2 OR THISFORM.DATA_OPTION.VALUE=3 OR THISFORM.DATA_OPTION.VALUE=5  
                IF THISFORM.DATA_OPTION.VALUE=5                    
                   SELECT F01,F02,F03,F07,F21,SUM(F04+F13) FROM B04 GROUP BY F03 WHERE F01=ANY(SELE F01 FROM B04_4) INTO CURSOR TMP2 ORDER BY F03,F01 NOWAIT                                          
                ELSE
                   SELECT F01,F02,F03,F07,F21,SUM(F04+F13) FROM B04 GROUP BY F01,F03,F07 WHERE F01=ANY(SELE F01 FROM B04_4) INTO CURSOR TMP2 ORDER BY F01,F03,F07 NOWAIT
                ENDIF   
                IF _TALLY>0
                   SELECT TMP2
                   GO TOP       
                   DO WHILE !EOF()
                      SELECT C20
                      SEEK TMP2.F03
                      IF FOUND()
                         X=C20.F11
                         IF X<>0
                            SELECT TMP2
                            QTY=SUM_EXP_6
                            P1=CEILING(QTY/X)   
                            FOR I= 1 TO P1     
                                SELECT TMP1                     
                                APPEND BLANK    
                                IF QTY<X         
                                   REPLACE 數量 WITH QTY           
                                ELSE
                                   REPLACE 數量 WITH X
                                   QTY=QTY-X
                                ENDIF                             
                                REPLACE 客戶料號 WITH IIF(SEEK(TMP2.F07+TMP2.F03,'C04'),C04.F17,'')
                                REPLACE 出貨日期 WITH TMP2.F02    
                                REPLACE 訂單號碼 WITH TMP2.F07
                                REPLACE 客戶單號 WITH IIF(SEEK(TMP2.F07,'C03'),C03.F14,'')                     
                                REPLACE 出貨單號 WITH TMP2.F01       
                                REPLACE 料品編號 WITH TMP2.F03
                                REPLACE 備註說明 WITH TMP2.F21
                                REPLACE 產地     WITH IIF(SEEK(TMP2.F03,'C20'),C20.F04,'')
                                REPLACE 毛重     WITH IIF(SEEK(TMP2.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                REPLACE 淨重     WITH IIF(SEEK(TMP2.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                                REPLACE 包裝方式 WITH IIF(SEEK(TMP2.F03,'C20'),C20.F02,'')
                            ENDFOR               
                         ELSE
                            =MESSAGEBOX('料號:'+TMP2.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')
                                                                    
                         ENDIF
                      ELSE
                         =MESSAGEBOX('料號:'+TMP2.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')
                                                                                                   
                     ENDIF              
                    
                     SELECT TMP2
                     SKIP
                  ENDDO
                ENDIF                                                             
           ENDIF                 
           IF THISFORM.DATA_OPTION.VALUE=4 
               ALTER TABLE TMP1 ADD 幣別 C(4)
               ALTER TABLE TMP1 ADD 單價 N(14,6)
               ALTER TABLE TMP1 ADD 匯率 N(11,6)
               ALTER TABLE TMP1 ADD 小計 N(15,3)
               
               SELECT F01,F02,F03,F07,F21,F04,F13,F14,F15,F16,F17 FROM B04 GROUP BY F07,F03 WHERE F01=ANY(SELE F01 FROM B04_4) INTO CURSOR TMP3 ORDER BY F07,F03 NOWAIT
                IF _TALLY>0
                   SELECT TMP3
                   GO TOP       
                   DO WHILE !EOF()
                      SELECT C20
                      SEEK TMP3.F03
                      IF FOUND()
                         X=C20.F11
                         IF X<>0
                            SELECT TMP1                     
                            APPEND BLANK    
                            REPLACE 數量 WITH TMP3.F04+TMP3.F13          
                            REPLACE 客戶料號 WITH IIF(SEEK(TMP3.F07+TMP3.F03,'C04'),C04.F17,'')
                            REPLACE 出貨日期 WITH TMP3.F02    
                            REPLACE 訂單號碼 WITH TMP3.F07
                            REPLACE 客戶單號 WITH IIF(SEEK(TMP3.F07,'C03'),C03.F14,'')                     
                            REPLACE 出貨單號 WITH TMP3.F01       
                            REPLACE 料品編號 WITH TMP3.F03
                            REPLACE 備註說明 WITH TMP3.F21
                            REPLACE 產地     WITH IIF(SEEK(TMP3.F03,'C20'),C20.F04,'')
                            REPLACE 毛重     WITH IIF(SEEK(TMP3.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                            REPLACE 淨重     WITH IIF(SEEK(TMP3.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                            REPLACE 包裝方式 WITH IIF(SEEK(TMP3.F03,'C20'),C20.F02,'')
                            REPLACE 幣別 WITH TMP3.F14
                            REPLACE 單價 WITH TMP3.F15
                            REPLACE 匯率 WITH TMP3.F16
                            REPLACE 小計 WITH TMP3.F17
                         ELSE
                            =MESSAGEBOX('料號:'+TMP3.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')                                                                
                         ENDIF
                      ELSE
                         =MESSAGEBOX('料號:'+TMP3.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')                                                                                                   
                     ENDIF                                                                                                                 
                     SELECT TMP3
                     SKIP
                  ENDDO
                ENDIF                      
           ENDIF
           IF THISFORM.DATA_OPTION.VALUE=6
              SELECT F01,F02,F03,F07,F21,(F04+F13),IIF(SEEK(F07+F03,'C04'),C04.F17,"")  FROM B04  WHERE F01=ANY(SELE F01 FROM B04_4) INTO CURSOR TMP9 ORDER BY F03,F01 NOWAIT  
              IF _TALLY>0                  
                 SELECT F01,F02,F03,F07,F21,SUM(EXP_6),EXP_7 FROM TMP9 ORDER BY F03,EXP_7 GROUP BY F03,EXP_7 INTO CURSOR TMP10 NOWAIT
                 SELECT TMP10
                   GO TOP       
                   DO WHILE !EOF()
                      SELECT C20
                      SEEK TMP10.F03
                      IF FOUND()
                         X=C20.F11
                         IF X<>0
                            SELECT TMP10
                            QTY=SUM_EXP_6
                            P1=CEILING(QTY/X)   
                            FOR I= 1 TO P1     
                                SELECT TMP1                     
                                APPEND BLANK    
                                IF QTY<X         
                                   REPLACE 數量 WITH QTY           
                                ELSE
                                   REPLACE 數量 WITH X
                                   QTY=QTY-X
                                ENDIF                             
                                REPLACE 客戶料號 WITH TMP10.EXP_7
                                REPLACE 出貨日期 WITH TMP10.F02    
                                REPLACE 訂單號碼 WITH TMP10.F07
                                REPLACE 客戶單號 WITH IIF(SEEK(TMP10.F07,'C03'),C03.F14,'')                     
                                REPLACE 出貨單號 WITH TMP10.F01       
                                REPLACE 料品編號 WITH TMP10.F03
                                REPLACE 備註說明 WITH TMP10.F21
                                REPLACE 產地     WITH IIF(SEEK(TMP10.F03,'C20'),C20.F04,'')
                                REPLACE 毛重     WITH IIF(SEEK(TMP10.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                REPLACE 淨重     WITH IIF(SEEK(TMP10.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                                REPLACE 包裝方式 WITH IIF(SEEK(TMP10.F03,'C20'),C20.F02,'')
                            ENDFOR               
                         ELSE
                            =MESSAGEBOX('料號:'+TMP10.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')
                                                                    
                         ENDIF
                      ELSE
                         =MESSAGEBOX('料號:'+TMP10.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')
                                                                                                   
                     ENDIF              
                    
                     SELECT TMP10
                     SKIP
                  ENDDO
              ENDIF
              
           ENDIF
           SELECT C20
           USE
           SELECT B04_4
           USE
           LK=LK+'(包裝量)'
           SELECT TMP1
           
         THISFORM.RELEASE 
 ENDPROC   
 ***** 
  PROCEDURE CMND2.CLICK
     
      _TALLY=0
      
      THISFORM.RELEASE
  ENDPROC      
ENDDEFINE         
***********************************************列印程序
PROCEDURE PNT_PRC       
     LK=B04_1.F01                  
     FLG='0'
     SELE B04
     CALC SUM(F17) FOR F01=LK TO TMP1
     HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3))
            SELECT B04.F01,;
                   B04.F02,;
                   B04.F03,;
                   B04.F04,;
                   B04.F05,;
                   B04.F06,;
                   B04.F07,; 
                   B04.F09,;
                   B04.F12,;  
                   B04.F13,;
                   B04.F14,;
                   B04.F15,;
                   B04.F16,;
                   B04.F17,;
                   B04.F20,;
                   B04.F21,;
                   B04.F23,;
                   B04.F24,;
                   B04.F79,;
                   C04.F25,;
                   C01.F04,;
                   C01.F08,;
                   C01.F10,;
                   C01.F12,;
                   C01.F13,;
                   C01.F24,;
                   C01.F41,;
                   C01.F42,;
                   C03.F06,;
                   C03.F14,;
                   C04.F17,;
                   B01.F02,;
                   B01.F04,;            
                   B01.F99;
                   FROM B04,C01,C03,C04,B01 WHERE B04.F01=LK AND C01.F01=B04.F06 AND C03.F02=B04.F07 AND C04.F03=B04.F07 AND C04.F04=B04.F03;
                   AND B01.F01=B04.F79 ORDER BY B04.F03 INTO CURSOR INV_DB NOWAIT     
     IF INT_INV AND !INT_IVY   &&如果使用電子計算機發票
        PNT_CHOOSE=CREATEOBJECT("PNT_CHOOSE")  
        PNT_CHOOSE.SHOW    
     ELSE
            IF _TALLY >0
*                 REPORT FORM ALLTRIM(INT_116)+'B04' PREVIEW         
	                 REPORT FORM ALLTRIM(INT_116)+'B04' TO PRINT PROMPT 
                     SELECT INV_DB
                     USE                 
            ELSE                          &&無訂單出貨
                 SELECT B04.F01,;
                   B04.F02,;
                   B04.F03,;
                   B04.F04,;
                   B04.F05,;
                   B04.F06,;
                   B04.F07,; 
                   B04.F09,;
                   B04.F12,;  
                   B04.F13,;
                   B04.F14,;
                   B04.F15,;
                   B04.F16,;
                   B04.F17,;
                   B04.F20,;
                   B04.F21,;
                   B04.F23,;
                   B04.F24,;
                   B04.F79,;                   
                   C01.F04,;
                   C01.F07,;
                   C01.F08,;
                   C01.F10,;
                   C01.F12,;
                   C01.F13,;
                   C01.F24,;
                   C01.F41,;
                   C01.F42,; 
                   B01.F02,;
                   B01.F04,;            
                   B01.F99;
                   FROM B04,C01,B01 WHERE B04.F01=LK AND C01.F01=B04.F06 ;
                   AND B01.F01=B04.F79 ORDER BY B04.F03  NOWAIT      
                   IF _TALLY>0
                      *REPORT FORM ALLTRIM(INT_116)+'B04K' PREVIEW         
	                 REPORT FORM ALLTRIM(INT_116)+'B04K' TO PRINT PROMPT 
                   ENDIF            
            ENDIF
     ENDIF   
     IF AT('檢驗',B04_1.F24)>0
        IF MESSAGEBOX('是否一併列印制式檢驗表?',4+32+256,'請確認') = 6	
           HK=LEFT(DTOS(A23.F01),4)+'/'+SUBSTR(DTOS(A23.F01),5,2)+'/'
           SELECT B04.F01,B04.F02,B04.F03,B04.F07,SUM(B04.F04) FROM B04 WHERE B04.F01=LK GROUP BY B04.F03 ORDER BY B04.F03 INTO CURSOR CHKLST NOWAIT
           IF _TALLY>0
             *REPORT FORM ALLTRIM(INT_116)+'CHKLST' PREVIEW         
	                     REPORT FORM ALLTRIM(INT_116)+'CHKLST' TO PRINT PROMPT 
	                     SELECT CHKLST
	                     USE
	       ELSE
	         =MESSAGEBOX("無資料可印",0+48,"提示訊息視窗")
	       
	       ENDIF              
        ENDIF     
     ENDIF
ENDPROC
***********************************************列印選項
DEFINE CLASS PNT_CHOOSE AS FORM
       AUTOCENTER=.T.
   CAPTION='請選擇欲列印之報表'
   TOP=INT_015*180
   LEFT=INT_015*220          
   FONTSIZE=INT_015*9
   HEIGHT=INT_015*170
   WIDTH=INT_015*250
   FONTSIZE=INT_015*9
   MOVABLE=.F.
   MAXBUTTON=.F.
   MINBUTTON=.F.      
   CONTROLBOX=.F.
   BORDERSTYLE=2
   SHOWTIPS=.T.
   SHOWWINDOW=1
   WINDOWTYPE=1
   NAME='PNT_CHOOSE'
  ADD OBJECT PNT_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*60,;
      TOP=INT_015*10,;
      HEIGHT=INT_015*100,;    
      WIDTH=INT_015*150,;      
      BUTTONCOUNT=4,;
      OPTION1.CAPTION='只印出貨單',;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.LEFT=INT_015*4,;
      OPTION1.TOP=INT_015*3,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='只印電子發票證明聯',;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.LEFT=INT_015*4,;
      OPTION2.TOP=INT_015*28,;
      OPTION2.AUTOSIZE=.T.,;      
      OPTION3.CAPTION='出貨單及電子發票證明聯',;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.LEFT=INT_015*4,;
      OPTION3.TOP=INT_015*53,;
      OPTION3.AUTOSIZE=.T.,;            
      OPTION4.CAPTION='只印備料單',;
      OPTION4.FONTSIZE=INT_015*9,;
      OPTION4.LEFT=INT_015*4,;
      OPTION4.TOP=INT_015*78,;
      OPTION4.AUTOSIZE=.T.,;   
      NAME='PNT_OPTION'
   ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
       LEFT=INT_015*60,;    
       HEIGHT=INT_015*25,;   
       TOP=INT_015*140,;  
       WIDTH=INT_015*50,;
       CAPTION='\<Y.執  行',;
       TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
       NAME='CMND1'
   ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
       LEFT=INT_015*130,;
       TOP=INT_015*140,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*50,;
       CAPTION='\<C.取  消',;
       TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
       NAME='CMND2'   
   PROCEDURE INIT 
      
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON') 
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.CUR','COMMANDBUTTON')          
                     
      THISFORM.PNT_OPTION.VALUE=1                
      IF !EMPTY(B04_1.F20) AND B04_1.F01<>B04_1.F20 AND B04_1.F22='31'
         THISFORM.PNT_OPTION.OPTION2.FONTSTRIKETHRU=.F.
         THISFORM.PNT_OPTION.OPTION3.FONTSTRIKETHRU=.F.
         THISFORM.PNT_OPTION.OPTION2.ENABLED=.T.  
         THISFORM.PNT_OPTION.OPTION3.ENABLED=.T.               
      ELSE
         THISFORM.PNT_OPTION.OPTION2.FONTSTRIKETHRU=.T.
         THISFORM.PNT_OPTION.OPTION3.FONTSTRIKETHRU=.T.
         THISFORM.PNT_OPTION.OPTION2.ENABLED=.F.
         THISFORM.PNT_OPTION.OPTION3.ENABLED=.F.
      ENDIF          
   ENDPROC             
   PROCEDURE CMND1.CLICK
            IF _TALLY >0
               IF THISFORM.PNT_OPTION.VALUE=4  &&只印備料單
                  IF!USED('C20')
                     SELECT 0
                     USE C20
                   ELSE
                     SELECT C20
                   ENDIF     
                   SET ORDER TO 1
                   SELECT INV_DB
                   REPORT FORM ALLTRIM(INT_116)+'B04B' TO PRINT PROMPT
                   SELECT C20
                   USE 
               ELSE   
                  IF THISFORM.PNT_OPTION.VALUE<>2 &&只印出貨單或兩者皆印
*                 REPORT FORM ALLTRIM(INT_116)+'B04' PREVIEW         
	                     REPORT FORM ALLTRIM(INT_116)+'B04' TO PRINT PROMPT 
                  ENDIF
                   IF THISFORM.PNT_OPTION.VALUE<>1   &&列印發票或全部列印
                      ODM=VAL(LEFT(DTOS(CTOD(HK+'/01')),6))%2
                      MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(HK+'/01')),6))+ODM-1))          
                      K39='K39'+MMT
                      IF !USED('&K39')
                          SELECT 0
                          USE (K39) ALIAS K39
                      ELSE
                          SELECT K39
                      ENDIF
                      SET ORDER TO 2
                      SELECT INV_DB 
                      GO TOP
                      IF SEEK(INV_DB.F20,'K39') AND EMPTY(K39.F05)
                         IF INV_DB.F14_A=INT_011 OR SEEK(INV_DB.F14_A+DTOS(CTOD(HK+'/'+NOUME(INV_DB.F02_A))),'C0Z')
*!*	                            IF _tally<6
*!*	                               FLG='0'
*!*	                            ELSE
*!*	                               FLG='1'
*!*	                               SELECT * FROM INV_DB GROUP BY F01 NOWAIT
*!*	                            ENDIF   
	                        REPORT FORM ALLTRIM(INT_116)+'INV_AINV' TO PRINT PROMPT PREVIEW            
*!*	                            REPORT FORM ALLTRIM(INT_116)+'INV_A' TO PRINT         
                            SELECT K39
                            REPLACE F05 WITH DATE()           
                         ELSE
                            =MESSAGEBOX('出貨日期所屬的匯率尚未設定!也就是說本張出貨單的匯率可能不正確,請通知財務部門設定本旬匯率後再列印發票',0+48,'提示訊息視窗') 
                            FLG='0'                                     
                         ENDIF                                                      
                      ELSE
                          =MESSAGEBOX('發票號碼已列印或無此發票號碼可列印!',0+48,'提示訊息視窗')
                          FLG='0'       
                      ENDIF     
                      SELECT K39
                      USE   
                   ENDIF   
               ENDIF          
            ELSE      &&無訂單出貨                
                 SELECT B04.F01,;
                   B04.F02,;
                   B04.F03,;
                   B04.F04,;
                   B04.F05,;
                   B04.F06,;
                   B04.F07,; 
                   B04.F09,;
                   B04.F12,;  
                   B04.F13,;
                   B04.F14,;
                   B04.F15,;
                   B04.F16,;
                   B04.F17,;
                   B04.F20,;
                   B04.F21,;
                   B04.F23,;
                   B04.F24,;
                   B04.F79,;                   
                   C01.F04,;
                   C01.F07,;
                   C01.F08,;
                   C01.F10,;
                   C01.F12,;
                   C01.F13,;
                   C01.F24,;
                   C01.F41,;
                   C01.F42,; 
                   B01.F02,;
                   B01.F04,;            
                   B01.F99;
                   FROM B04,C01,B01 WHERE B04.F01=LK AND C01.F01=B04.F06 ;
                   AND B01.F01=B04.F79 ORDER BY B04.F03  NOWAIT      
                   IF _TALLY>0
                     *REPORT FORM ALLTRIM(INT_116)+'B04K' PREVIEW         
	                 REPORT FORM ALLTRIM(INT_116)+'B04K' TO PRINT PROMPT 
                   ENDIF     
            
                
            ENDIF  
            SELECT INV_DB
            USE            
            THISFORM.CMND2.CLICK
   ENDPROC
   PROCEDURE CMND2.CLICK               
       THISFORM.RELEASE        
   ENDPROC         
ENDDEFINE

************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
         CHK_IN='0'
         PR_NO='1'
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
              IF USED('OQT')=.T.
                  SELECT OQT 
                  USE
              ENDIF
              SELECT F03,F07 FROM B04 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F07,F03 INTO CURSOR B04_TEMP
              SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05  WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE;
                            AND (C05.F04-C05.F05)>0  ORDER BY F01,F03 INTO CURSOR OQT READWRITE
              ALTER TABLE OQT ADD C04_F15  N(11)
              ALTER TABLE OQT ADD C04_F16  N(8)
              INDE ON F02+DTOS(F03)+F01 TAG OQT_1
              INDE ON F01+F02 TAG OQT_2
             
	      SELECT OQT 
	      SET ORDER TO OQT_1  
	      SELECT B04_TEMP
	      GO TOP
	      DO WHILE !EOF()
	             SELECT OQT 
	             SEEK B04_TEMP.F07+B04_TEMP.F03
	             IF FOUND()
	                  DELETE 
	             ENDIF
	             SELECT B04_TEMP
	             SKIP
	      ENDDO
	      SELECT B04_TEMP
	      USE
	      SELECT OQT 	      
	     
               IF _TALLY>0
                  
                    OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                    OQT_SEEK.SHOW  
                    THIS.REFRESH
                    SELECT OQT 
                    CALC SUM(EXP_1) TO NO
                    DO CASE
	                   CASE NO=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
			              THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
			              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.C04_F15  
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(OQT_TEMP.F02,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193)) 
			              THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=OQT_TEMP.F01
			              THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=OQT_TEMP.C04_F16                                      
			              THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
			              THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)               
			              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1) )                   
			              THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
			              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F02,'')
			              SELECT OQT_TEMP
			              USE	                   
	                   CASE NO>=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              GO TOP
			              DO WHILE !EOF()
			                 IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B04')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.) AND ((B04_1.F22<>'31' AND B04_1.F23<>'1') OR IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)>0) 
			                     SELECT  B04
				                 APPEND BLANK
				                 REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				                 REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				                 REPLACE F03 WITH OQT_TEMP.F02
				                 REPLACE F04 WITH OQT_TEMP.C04_F15  
				                 REPLACE F05 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(B04.F03,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193))
				                 REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
				                 REPLACE F07 WITH OQT_TEMP.F01
				                 REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE                    
				                 REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				                 REPLACE F12 WITH ''
				                 REPLACE F13 WITH OQT_TEMP.C04_F16      
				                 REPLACE F14 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
				                 REPLACE F15 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)         
				                 REPLACE F16 WITH IIF(SEEK(B04.F14+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(B04.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(B04.F14,'C00'),C00.F02,1))  
				                 REPLACE F17 WITH ROUND(IIF(B04.F16=1,B04.F04*B04.F15,B04.F04*B04.F15*B04.F16),INT_069)
				                 REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
				                 REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE   
				                 REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE       
				                 REPLACE F79 WITH F03            
				                 REPLACE F22 WITH B04_1.F22
				                 REPLACE F23 WITH B04_1.F23
				                 REPLACE F08 WITH B04_1.F08
				                 *寫入C04
					             SELE C04
					             SEEK B04.F07+B04.F03
					             IF FOUND()
					                REPLACE C04.F23 WITH C04.F23+(B04.F04+B04.F13)  
					             ENDIF   				                 
				                 **寫入出貨計畫
					             SELE C05                 
					             SET ORDER TO C054                                                       
					             SEEK B04.F07+B04.F03
					             IF FOUND()
					                QTY=B04.F04+B04.F13
					                DO WHILE C05.F01+C05.F02=B04.F07+B04.F03 
					                   IF C05.F04-C05.F05=0
					                      SKIP
					                   ELSE
					                      IF QTY>C05.F04-C05.F05
					                            QTY=QTY+(C05.F04-C05.F05)*(-1)   
					                            REPLACE  C05.F05 WITH C05.F04     
					                            SKIP
					                      ELSE
					                            REPLACE  C05.F05 WITH C05.F05+QTY
					                            EXIT
					                      ENDIF  
					                   ENDIF                    
					                ENDDO   
					             ENDIF 
					          ENDIF       				            
			                  SELECT OQT_TEMP
			                  SKIP 
		                  ENDDO  
		                  SELECT OQT_TEMP
		                  USE
			              THISFORM.GRID2.ENABLED=.T.
			              THISFORM.GRID2.SETFOCUS  
			              THISFORM.GRID2.ENABLED=.F.                 
			              THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1
			              THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0   
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE='' 
			              THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=0                                    
			              THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
			              THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0               
			              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))) ,'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))             			              
	                      THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
	            ENDCASE       
		        THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS 
               ELSE    	
                    IF ALLTRIM(A02.F09)='*'   &&判斷有無無訂單作業的權限
                         IF AT('?',ALLTRIM(THIS.VALUE))>1             
                             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
                         ELSE
                             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 
                         ENDIF        
                         IF _TALLY>0
                             MTR_SEEK=CREATEOBJECT("MTR_SEEK")  
                             MTR_SEEK.SHOW    
                            THIS.VALUE=FLG
                            THIS.REFRESH
                            THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=FLG
                            FLG='0'     
                        ENDIF    
                    ELSE
                        =MESSAGEBOX('此客戶無此料號類別的訂單或根本未下訂單!請先輸入訂單',0+64,'提示訊息視窗')
*!*	                       THIS.VALUE=''
*!*	                       THIS.REFRESH
                        THIS.SETFOCUS
                         RETURN   
                         THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
                    ENDIF 
              ENDIF            
         ENDIF      
  ENDPROC     
  ****
  PROCEDURE INTERACTIVECHANGE
      CHK_IN='0'
      PR_NO='1'
      IF AT('?',ALLTRIM(THIS.VALUE))<>0
          IF USED('OQT')=.T.
               SELECT OQT 
               USE
          ENDIF
          SELECT F03,F07 FROM B04 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F07,F03 INTO CURSOR B04_TEMP
          DO CASE
                CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE))                   
                          SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE; 
                          AND LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                          AND (C05.F04-C05.F05)>0 ORDER BY F01,F03 INTO CURSOR OQT READWRITE 
                CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE))                   
                           SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE; 
                           AND LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND (C05.F04-C05.F05)>0;    
                           AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE ORDER BY F01,F03 INTO CURSOR OQT  READWRITE            
                CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE))                   
                           SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05  WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE;
                           AND (C05.F04-C05.F05)>0 ORDER BY F01,F03 INTO CURSOR OQT  READWRITE
                CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE))                   
                           SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05  WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE;
                           AND (C05.F04-C05.F05)>0 AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE ORDER BY F01,F03 INTO CURSOR OQT  READWRITE              
          ENDCASE 
          SELECT OQT 
          ALTER TABLE OQT ADD C04_F15  N(11)
          ALTER TABLE OQT ADD C04_F16  N(8)
          INDE ON F02+DTOS(F03)+F01 TAG OQT_1   
          INDE ON F01+F02 TAG OQT_2  
          
          SET ORDER TO OQT_2 
	  SELECT B04_TEMP
	  GO TOP
	  DO WHILE !EOF()
	         SELECT OQT 
	         SEEK B04_TEMP.F07+B04_TEMP.F03
	         IF FOUND()
	              DELETE 
	         ENDIF
	         SELECT B04_TEMP
	         SKIP
	  ENDDO
	  SELECT B04_TEMP
	  USE
	  SELECT OQT 	                  
          IF _TALLY>0  
              SELECT OQT 
	      SET ORDER TO OQT_2 
              OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
              OQT_SEEK.SHOW   
              THIS.REFRESH
              SELECT OQT 
              CALC SUM(EXP_1) TO NO   
              DO CASE
                    CASE NO=1 AND CHK_IN='1'
	        	       SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
		               SELECT OQT_TEMP
		               THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
		               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
		               THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.C04_F15 
		               THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(OQT_TEMP.F02,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193))
		               THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=OQT_TEMP.F01
		               THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=OQT_TEMP.C04_F16                                   
		               THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
		               THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)               		               
		               THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))   
		               THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
			           THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F02,'')
		               SELECT OQT_TEMP
		               USE	                   
                    CASE NO>=1 AND CHK_IN='1'
	        	       SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
		               SELECT OQT_TEMP
		               GO TOP
		               DO WHILE !EOF()
			              IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B04')=.F. AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.) AND ((B04_1.F22<>'31' AND B04_1.F23<>'1') OR IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)>0 )
			                  SELECT  B04
				              APPEND BLANK
				              REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				              REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				              REPLACE F03 WITH OQT_TEMP.F02
				              REPLACE F04 WITH OQT_TEMP.C04_F15  
				              REPLACE F05 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(B04.F03,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193))
				              REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
				              REPLACE F07 WITH OQT_TEMP.F01
				              REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE                    
				              REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				              REPLACE F12 WITH ''
				              REPLACE F13 WITH OQT_TEMP.C04_F16      
				              REPLACE F14 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
				              REPLACE F15 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)         
				              REPLACE F16 WITH IIF(SEEK(B04.F14+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(B04.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(B04.F14,'C00'),C00.F02,1))                  				           
				              REPLACE F17 WITH ROUND(IIF(B04.F16=1,B04.F04*B04.F15,B04.F04*B04.F15*B04.F16),INT_069)
				              REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
				              REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE   
				              REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE 
				              REPLACE F79 WITH F03                   
				              REPLACE F22 WITH B04_1.F22
				              REPLACE F23 WITH B04_1.F23
				              REPLACE F08 WITH B04_1.F08
				           *寫入C04
					          SELE C04
					          SEEK B04.F07+B04.F03
					          IF FOUND()
					             REPLACE C04.F23 WITH C04.F23+(B04.F04+B04.F13)  
					          ENDIF  				                 
				              **寫入出貨計畫
					          SELE C05                 
					          SET ORDER TO C054                                                       
					          SEEK B04.F07+B04.F03
					          IF FOUND()
					             QTY=B04.F04+B04.F13
					             DO WHILE C05.F01+C05.F02=B04.F07+B04.F03 
					                IF C05.F04-C05.F05=0
					                   SKIP
					                ELSE
					                   IF QTY>C05.F04-C05.F05
					                       QTY=QTY+(C05.F04-C05.F05)*(-1)   
					                       REPLACE  C05.F05 WITH C05.F04     
					                       SKIP
					                   ELSE
					                       REPLACE  C05.F05 WITH C05.F05+QTY
					                       EXIT
					                   ENDIF  
					                ENDIF                    
					             ENDDO   
					          ENDIF 
			             ENDIF    				            
			             SELECT OQT_TEMP
			             SKIP  
		               ENDDO  
		               SELECT OQT_TEMP
	                   USE
		               THISFORM.GRID2.ENABLED=.T.
		               THISFORM.GRID2.SETFOCUS  
		               THISFORM.GRID2.ENABLED=.F.                 
		               THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1
		               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
		               THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0  
		               THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
		               THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE='' 
		               THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=0                                    
		               THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
		               THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0               
			           THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1) )                    			              
	                   THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
	      ENDCASE       
	      THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS 
	  ELSE     	
              IF ALLTRIM(A02.F09)='*'   &&判斷有無無訂單作業的權限
                   IF AT('?',ALLTRIM(THIS.VALUE))>1             
                       SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
                   ELSE
                       SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 
                   ENDIF        
                   IF _TALLY>0
                        MTR_SEEK=CREATEOBJECT("MTR_SEEK")  
                        MTR_SEEK.SHOW    
                        THIS.VALUE=FLG
                        THIS.REFRESH
                        THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=FLG
                        FLG='0'      
                   ENDIF
              ELSE   
                    =MESSAGEBOX('此客戶無此料號類別的訂單或根本未下訂單!請先輸入訂單',0+64,'提示訊息視窗')
*!*	                   THIS.VALUE=''
*!*	                   THIS.REFRESH
                    THIS.SETFOCUS
                    RETURN   
                    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 
              ENDIF  
          ENDIF      
      ELSE            
          IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE)
              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THIS.VALUE,'C04'),C04.F10-C04.F16+C04.F19-C04.F23,0)       
              THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THIS.VALUE,'C04'),C04.F16-C04.F19,0)                           
              THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THIS.VALUE,'C04'),C04.F06,INT_011)          
              THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE        
              THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE+THIS.VALUE,'C04'),C04.F07,0)                      
              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))      
          ELSE 
               IF ALLTRIM(A02.F09)='*'    &&如果有無訂單出貨的權限才去搜尋最新報價紀錄
                   IF !USED('C02')
                        SELECT 0
                        USE C02
                   ELSE
                        SELECT C02
                   ENDIF
                   SET ORDER TO C023        
                  THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+THIS.Value,'C02','C023'),C02.F07,0)   
                  THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+THIS.VALUE,'C02','C023'),C02.F06,INT_011) 
                  THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE                                 
                  THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))  
                  SELECT C02
                  USE                 
               ENDIF                
          ENDIF          
     ENDIF  
    THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')
    THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,'A14'),A14.F02,'')    
    THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THIS.VALUE
  ENDPROC

ENDDEFINE
***************************************************特殊欄位-----------------訂單號碼
DEFINE CLASS TXTF07 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=10
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
        CHK_IN='0'
        PR_NO='2'
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
              IF USED('OQT')=.T.
                  SELECT OQT 
                  USE
              ENDIF           
              SELECT F03,F07 FROM B04 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F07,F03 INTO CURSOR B04_TEMP  
              SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05 WHERE !EMPTY(ALLTRIM(F15)) AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE;
              AND (C05.F04-C05.F05)>0  ORDER BY F01,F03 INTO CURSOR OQT READWRITE
              ALTER TABLE OQT ADD C04_F15  N(11)
              ALTER TABLE OQT ADD C04_F16  N(8)
              INDE ON F01+DTOS(F03)+F02 TAG OQT_1
              INDE ON F01+F02 TAG OQT_2
             
	      SET ORDER TO OQT_2    
	      SELECT B04_TEMP
	      GO TOP
	      DO WHILE !EOF()
	             SELECT OQT 
	             SEEK B04_TEMP.F07+B04_TEMP.F03
	             IF FOUND()
	                 DELETE 
	            ENDIF
	            SELECT B04_TEMP
	            SKIP
	       ENDDO
	       SELECT B04_TEMP
	       USE	
	       SELECT  OQT       
	      
               IF _TALLY>0
                    OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                    OQT_SEEK.SHOW  
                    THIS.REFRESH
                    SELECT OQT 
                    CALC SUM(EXP_1) TO NO
                    DO CASE
	                   CASE NO=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
			              THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
			              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.C04_F15  
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(OQT_TEMP.F02,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193))
			              THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=OQT_TEMP.F01
			              THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=OQT_TEMP.C04_F16                                      
			              THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
			              THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)               
			              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))  
			              THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
			              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F02,'')
			              SELECT OQT_TEMP
			              USE	                   
	                   CASE NO>=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              GO TOP
			              DO WHILE !EOF()
			                    IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B04')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.) AND ((B04_1.F22<>'31' AND B04_1.F23<>'1') OR IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)>0)
			                        SELECT  B04
				                    APPEND BLANK
				                    REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				                    REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				                    REPLACE F03 WITH OQT_TEMP.F02
				                    REPLACE F04 WITH OQT_TEMP.C04_F15  
				                    REPLACE F05 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(B04.F03,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193))
				                    REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
				                    REPLACE F07 WITH OQT_TEMP.F01
				                    REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE                    
				                    REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				                    REPLACE F12 WITH ''
				                    REPLACE F13 WITH OQT_TEMP.C04_F16      
				                    REPLACE F14 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
				                    REPLACE F15 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)         
				                    REPLACE F16 WITH IIF(SEEK(B04.F14+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(B04.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(B04.F14,'C00'),C00.F02,1))                  
				                    REPLACE F17 WITH ROUND(IIF(B04.F16=1,B04.F04*B04.F15,B04.F04*B04.F15*B04.F16),INT_069)
				                    REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
				                    REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE   
				                    REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE  
				                    REPLACE F79 WITH F03                  
				                    REPLACE F22 WITH B04_1.F22
				                    REPLACE F23 WITH B04_1.F23
				                    REPLACE F08 WITH B04_1.F08
				                 *寫入C04
					                SELE C04
					                SEEK B04.F07+B04.F03
					                IF FOUND()
					                   REPLACE C04.F23 WITH C04.F23+(B04.F04+B04.F13)  
					                ENDIF  				                 
				                 **寫入出貨計畫
					                SELE C05                 
					                SET ORDER TO C054                                                       
					                SEEK B04.F07+B04.F03
					                IF FOUND()
					                   QTY=B04.F04+B04.F13
					                   DO WHILE C05.F01+C05.F02=B04.F07+B04.F03 
					                      IF C05.F04-C05.F05=0
					                         SKIP
					                      ELSE
					                         IF QTY>C05.F04-C05.F05
					                            QTY=QTY+(C05.F04-C05.F05)*(-1)   
					                            REPL C05.F05 WITH C05.F04     
					                            SKIP
					                        ELSE
					                            REPL C05.F05 WITH C05.F05+QTY
					                            EXIT
					                        ENDIF  
					                      ENDIF                    
					                   ENDDO   
					                ENDIF 
					            ENDIF     				            
			                    SELECT OQT_TEMP
			                    SKIP  
		                      ENDDO  
		                      SELECT OQT_TEMP
		                      USE
			              THISFORM.GRID2.ENABLED=.T.
			              THISFORM.GRID2.SETFOCUS  
			              THISFORM.GRID2.ENABLED=.F.                 
			              THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1
			              THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0   
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE='' 
			              THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=0                                    
			              THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
			              THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0               
			              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))                      			              
	                      THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
	            ENDCASE       
		    THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS 
	       ELSE    	
		    =MESSAGEBOX('此客戶已無出貨計畫可出貨,請查明後再輸入!',0+64,'提示訊息視窗')
		    THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS 
	            RETURN
               ENDIF
         ENDIF
   ENDPROC
   **********        
  PROCEDURE INTERACTIVECHANGE
    CHK_IN='0'
    PR_NO='2'
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
        IF USED('OQT')=.T.
            SELECT OQT 
            USE
       ENDIF      
       SELECT F03,F07 FROM B04 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F07,F03 INTO CURSOR B04_TEMP
       DO CASE
              CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F01,F02,F03,F04,F05,F09,F10 FROM C05 INTO CURSOR OQT; 
                        ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND !EMPTY(ALLTRIM(F15)); 
                        AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                        AND (C05.F04-C05.F05)>0 READWRITE 
             CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F01,F02,F03,F04,F05,F09,F10 FROM C05 INTO CURSOR OQT; 
                        ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND !EMPTY(ALLTRIM(F15)); 
                        AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                        AND (C05.F04-C05.F05)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE  READWRITE             
              CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05 INTO CURSOR OQT ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE;
                        AND !EMPTY(ALLTRIM(F15)) AND (C05.F04-C05.F05)>0 READWRITE 
              CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F02,F01,F03,F04,F05,F09,F10 FROM C05 INTO CURSOR OQT ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE;
                        AND !EMPTY(ALLTRIM(F15)) AND (C05.F04-C05.F05)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE READWRITE          
        ENDCASE 
        SELECT OQT 
        ALTER TABLE OQT ADD C04_F15  N(11)
        ALTER TABLE OQT ADD C04_F16  N(8)
        INDE ON F01+DTOS(F03)+F02 TAG OQT_1
        INDE ON F01+F02 TAG OQT_2
       
        SET ORDER TO OQT_2
	SELECT B04_TEMP
	GO TOP
	DO WHILE !EOF()
	       SELECT OQT 
	       SEEK B04_TEMP.F07+B04_TEMP.F03
	       IF FOUND()
	            DELETE 
	       ENDIF
	       SELECT B04_TEMP
	       SKIP
	ENDDO
	SELECT B04_TEMP
	USE      
	SELECT OQT  
	
        IF _TALLY>0  
          OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
          OQT_SEEK.SHOW    
          THIS.REFRESH
          SELECT OQT 
          CALC SUM(EXP_1) TO NO   
          DO CASE
                CASE NO=1 AND CHK_IN='1'
	        	   SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
		           SELECT OQT_TEMP
		           THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
		           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
		           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.C04_F15 
		           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(OQT_TEMP.F02,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193)) 
		           THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=OQT_TEMP.F01
		           THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=OQT_TEMP.C04_F16                                       
		           THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
		           THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)               		           
		           THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))                 
		           THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
		           THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F02,'')
		           SELECT OQT_TEMP
		           USE	                   
                CASE NO>=1 AND CHK_IN='1'
	        	   SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
		           SELECT OQT_TEMP
		           GO TOP
		           DO WHILE !EOF()
			          IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B04')=.F. AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.) AND ((B04_1.F22<>'31' AND B04_1.F23<>'1') OR IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)>0)
			               SELECT  B04
				           APPEND BLANK
			               REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
			               REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
			               REPLACE F03 WITH OQT_TEMP.F02
			               REPLACE F04 WITH OQT_TEMP.C04_F15  
			               REPLACE F05 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_193 OR THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE <> INT_194,THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,IIF(SEEK(B04.F03,'B01'),IIF(B01.F97 = 'Y',INT_194,INT_193),INT_193))
			               REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
			               REPLACE F07 WITH OQT_TEMP.F01
			               REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE                    
			               REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
			               REPLACE F12 WITH ''
			               REPLACE F13 WITH OQT_TEMP.C04_F16      
			               REPLACE F14 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F06,INT_011)
			               REPLACE F15 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'C04'),C04.F07,0)         
			               REPLACE F16 WITH IIF(SEEK(B04.F14+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(B04.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(B04.F14,'C00'),C00.F02,1))                  
			               REPLACE F17 WITH ROUND(IIF(B04.F16=1,B04.F04*B04.F15,B04.F04*B04.F15*B04.F16),INT_069)
			               REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
			               REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE   
			               REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE     
			               REPLACE F79 WITH F03               
			               REPLACE F22 WITH B04_1.F22
			               REPLACE F23 WITH B04_1.F23
			               REPLACE F08 WITH B04_1.F08
			               *寫入C04
				           SELE C04
				           SEEK B04.F07+B04.F03
				           IF FOUND()
				              REPLACE C04.F23 WITH C04.F23+(B04.F04+B04.F13)  
				           ENDIF  				                 
			               **寫入出貨計畫
				           SELE C05                 
				           SET ORDER TO C054                                                       
				           SEEK B04.F07+B04.F03
				           IF FOUND()
					          QTY=B04.F04+B04.F13
					          DO WHILE C05.F01+C05.F02=B04.F07+B04.F03 
					             IF C05.F04-C05.F05=0
					                SKIP
					             ELSE
					                IF QTY>C05.F04-C05.F05
					                   QTY=QTY+(C05.F04-C05.F05)*(-1)   
					                   REPLACE  C05.F05 WITH C05.F04     
					                   SKIP
					                ELSE
					                   REPLACE  C05.F05 WITH C05.F05+QTY
					                   EXIT
					                ENDIF  
					             ENDIF                    
					          ENDDO   
					      ENDIF 
			          ENDIF    				            
			          SELECT OQT_TEMP
			          SKIP  
		           ENDDO  
		           SELECT OQT_TEMP
	                   USE
		           THISFORM.GRID2.ENABLED=.T.
		           THISFORM.GRID2.SETFOCUS  
		           THISFORM.GRID2.ENABLED=.F.                 
		           THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1
		           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
		           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0  
		           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE='' 
		           THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE='' 
		           THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=0                                    
		           THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
		           THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0               
			       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))                       			              
	               THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
	  ENDCASE       
	  THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS 
        ELSE    	
	   =MESSAGEBOX('此客戶已無出貨計畫可出貨,請查明後再輸入!',0+64,'提示訊息視窗')
	   THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS 
           RETURN
        ENDIF            
    ELSE 
        IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE)
            THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F10-C04.F16+C04.F19-C04.F23,0)       
            THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F16-C04.F19,0)                           
            THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F06,INT_011)          
            THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE        
            THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04'),C04.F07,0)                                  
            THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE,'C00'),C00.F02,1))           
            THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE= THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE  
        ENDIF   
    ENDIF  
    THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F02,'')
    THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,'A14'),A14.F02,'')   
    
  ENDPROC     
ENDDEFINE 
****************************************************  &&實際料號
DEFINE CLASS TXTF79 AS TEXTBOX
      READONLY=.T.
      MAXLENGTH=43
  FONTSIZE=INT_015*9
       PROCEDURE INTERACTIVECHANGE     
       IF AT('?',ALLTRIM(THIS.VALUE))<>0
          IF AT('?',ALLTRIM(THIS.VALUE))>1             
             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
          ELSE
             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
          ENDIF        
          IF _TALLY>0
             MTR_SEEK=createobject("MTR_SEEK")  
             MTR_SEEK.SHOW    
             
                THIS.VALUE=FLG
                THIS.REFRESH  
                FLG='0'
                          
          ENDIF                                     
       ENDIF       
   ENDPROC  
ENDDEFINE   
***************************************************特殊欄位------------------出貨部門
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND LEN(ALLTRIM(F01))<=5 AND F04='*' AND F13='*'
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEN(ALLTRIM(F01))<=5 AND F04='*' AND F13='*'
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=CREATEOBJECT("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
*!*		          THIS.VALUE=FLG
          IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
             THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE = FLG
          ELSE
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE = FLG
          ENDIF
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF   
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')
       ELSE
          THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')  
       ENDIF
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------客戶
DEFINE CLASS TXTF06 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9       
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F04,'')  
       THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(INT_209 = 'A',C01.F18,C01.F33),'')
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE,'A01'),A01.F03,'')
       THISFORM.PAGEFRAME1.PAGE1.TXTF24.VALUE=IIF(SEEK(THIS.VALUE,'C01'),C01.F32,'')
       IF INT_060=.F.   &&如果預設不帶入發票管理
           THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)
           THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)  
           
       ELSE 
         IF INT_150   &&如果預設出口不開發票
            IF IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)=2 AND IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)=2
               THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE='67'+RIGHT(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,8)
               THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)
               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1) 
               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2
               THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
            ENDIF
         ENDIF   
       ENDIF
       IF INT_212='N'
          SELECT RECNO() FROM K51 WHERE THIS.VALUE = K51.F06 AND DATE()-K51.F15 > 0 INTO ARRAY RC1
          IF _TALLY > 0                   
            =MESSAGEBOX('此客戶尚有逾期貨款未收!',0+64,'提示訊息視窗')
            THIS.VALUE = ''
            THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION = ''
            THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE = ''
            THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION = ''                     
         ENDIF
         THIS.SETFOCUS
       ENDIF   
       IF INT_214='N'
	      SELECT SUM(C03.f04) FROM C03 WHERE C03.f03 = THIS.VALUE AND C03.f02 = ANY(SELECT C05.f01 FROM C05 WHERE C05.f06 = THIS.VALUE AND !EMPTY(ALLTRIM(C05.f15)) GROUP BY C05.f01) INTO CURSOR C03_TEMP
	      IF SEEK(THIS.VALUE,'C01') = .T. AND C03_TEMP.SUM_F04 >= C01.F27 
	         =MESSAGEBOX('此客戶未出貨金額已超過該客戶之信用額度 ' + ALLTRIM(TRANSFORM(C01.F27,"@R 9,999,999,999,999,999")) + ' 請修改C01.客戶基本資料之信用額度!',0+64,'提示訊息視窗')   
             THIS.VALUE = ''
             THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION = ''
             THISFORM.PAGEFRAME1.PAGE1.TXTF09.VALUE = ''
             THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION = ''                   
         ENDIF
         THIS.SETFOCUS
       ENDIF
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------載運人員
DEFINE CLASS TXTF09 AS TEXTBOX
   READONLY=.T.
   MAXLENGTH=5
   FONTSIZE=INT_015*9      
   PROCEDURE INTERACTIVECHANGE
     IF AT('?',ALLTRIM(THIS.VALUE))<>0
        IF AT('?',ALLTRIM(THIS.VALUE))>1             
           SELECT F01,F03 FROM A01 INTO CURSOR MAN ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
        ELSE
           SELECT F01,F03 FROM A01 INTO CURSOR MAN ORDER BY F01    
        ENDIF   
        IF _TALLY>0
           MAN_SEEK=CREATEOBJECT("MAN_SEEK")  
           MAN_SEEK.SHOW    
           THIS.VALUE=FLG
           THIS.REFRESH
           FLG='0'        
        ENDIF   
     ENDIF  
      THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=IIF(SEEK(THIS.VALUE,'A01'),A01.F03,'')  
  ENDPROC
ENDDEFINE
******************************************************************特殊欄位設定--發票號碼
DEFINE CLASS TXTF20 AS TEXTBOX
       READONLY=.T.
       MAXLENGTH=10
       FONTSIZE=INT_015*9
       PROCEDURE DBLCLICK
          IF ABS(DATE()-CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))>6
             =MESSAGEBOX(IIF(DATE()-CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)>6,"出貨日已超過發票上傳時間，請修改出貨日再產生發票號碼","請於離出貨日七日內再產生發票號碼"),0+48,"提示訊息視窗")
             
          ELSE
             ODM=VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))%2
             MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))+ODM-1))          
             K37='K37'+MMT
             IF FILE(K37+'.DBF')  &&如果有找到計算機發票檔才開窗選取發票
                K38='K38'+MMT
                K39='K39'+MMT
                IF !USED('&K37')
                   SELECT 0
                   USE (K37) ALIAS K37
                ELSE
                   SELECT K37
                ENDIF
                SET ORDER TO 1
                IF !USED('&K38')
                   SELECT 0
                   USE (K38) ALIAS K38
                ELSE
                   SELECT K38
                ENDIF
                SET ORDER TO 2
                IF !USED('&K39')
                   SELECT 0
                   USE (K39) ALIAS K39
                ELSE
                   SELECT K39
                ENDIF
                SET ORDER TO 2
                CREATE CURSOR ELCINV (F01 C(2),F02 C(4),F03 D(8),F04 C(10),F05 N(2,0))
                INDEX ON F01+F02 TAG ELCINV 
                SET ORDER TO 1
                IF INT_IVY
                   SELECT K38.F03,K38.F01,K37.F05,K37.F06,K37.F07 FROM K38,K37 WHERE K38.F02=sys_oper AND K37.F07>0 AND K37.F01=K38.F01 AND K37.F05<=CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE) ORDER BY K38.F03,K38.F01 INTO CURSOR ELCTMP NOWAIT
                ELSE
                   SELECT K38.F03,K38.F01,K37.F05,K37.F06,K37.F07 FROM K38,K37 WHERE K38.F02=sys_oper AND K37.F07>0 AND K37.F01=K38.F01 AND K37.F05<=CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE) AND K37.F08=RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2) ORDER BY K38.F03,K38.F01 INTO CURSOR ELCTMP NOWAIT
                ENDIF
                IF _TALLY>0
                   SELECT ELCTMP
                   GO TOP
                   DO WHILE !EOF()
                      SELECT ELCINV
                      APPEND BLANK
                      REPLACE F01 WITH ELCTMP.F03
                      REPLACE F02 WITH ELCTMP.F01
                      REPLACE F03 WITH ELCTMP.F05
                      REPLACE F04 WITH ELCTMP.F06
                      REPLACE F05 WITH ELCTMP.F07
                      SELECT ELCTMP
                      SKIP
                   ENDDO   
                   SELECT ELCTMP
                   USE
                   SELECT ELCINV
                   GO TOP
                   *SEEK IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),C01.F29,'')   &&原本預設的發票類別聯式
                   ELC_SEEK=CREATEOBJECT("ELC_SEEK")                  
                   ELC_SEEK.SHOW    
                   IF SEEK(FLG,'K39') AND !EMPTY(FLG) &&如果有選取發票號碼
                      THIS.VALUE=FLG
                      THIS.ReadOnly=.T.
                      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
                      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)  &&IIF(CHK_STR='32',2,1)
                      THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
       	              THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)  
       	              THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2 AND THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE>1)
       	              SELECT K39
       	              SEEK FLG
       	              IF FOUND()
       	                 REPLACE F03 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
       	              ENDIF
       	              SELECT K37
       	              SEEK UKEF
       	              IF FOUND()
       	                 REPLACE F07 WITH VAL(RIGHT(F04,8))-VAL(RIGHT(FLG,8))       	              
       	                 REPLACE F05 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)     	                 
       	                 REPLACE F06 WITH IIF(F07=0,'',LEFT(FLG,2)+PADL(ALLTRIM(STR(VAL(RIGHT(FLG,8))+1)),8,'0'))
       	              ENDIF
       	           ENDIF   
                   SELECT ELCINV
                   USE
                ELSE
                  =MESSAGEBOX('您無可開立發票號碼',0+48,'提示')
                ENDIF
                SELECT K37
       	        USE
       	        SELECT K38
       	        USE
       	        SELECT K39 
       	        USE
                SELECT &AREA1                   
             ENDIF               &&如果有找到計算機發票檔終
          ENDIF                  &&判斷是否超過上傳期限或提前太早開發票判斷終
       ENDPROC
       PROCEDURE INTERACTIVECHANGE
               IF INT_060=.T.
                   IF LEN(ALLTRIM(THIS.VALUE))=10
                       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
*!*	                 THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1
                       THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
*!*	               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1
	                   THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)
       	               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)  
       	               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2 AND THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE>1)
                   ELSE   
                       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
                       THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.F.
                       THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''
                       THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''              
                  ENDIF
               ENDIF       
       ENDPROC
       
ENDDEFINE     
*********************************************************************發票種類
DEFINE CLASS INV_TYPE AS OPTIONGROUP
  HEIGHT=INT_015*25
  TOP=INT_015*79
  LEFT=INT_015*149
  HEIGHT=INT_015*25
  WIDTH=INT_015*120
  FONTSIZE=INT_015*9
  BUTTONCOUNT=2
  VALUE=1
  NAME='INV_TYPE'
  OPTION1.CAPTION='三聯式'
  OPTION1.TOP=INT_015*5
  OPTION1.WIDTH=INT_015*52
  OPTION1.LEFT=INT_015*5
  OPTION1.NAME='OPTION1'
  OPTION2.CAPTION='二聯式'
  OPTION2.TOP=INT_015*5
  OPTION2.WIDTH=INT_015*52
  OPTION2.LEFT=INT_015*59
  OPTION2.NAME='OPTION2'
  PROC INTERACTIVECHANGE
       IF THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2  AND THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE<>1
          THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
        ELSE  
          THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.
          THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=1          
          THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''
       ENDIF   
  ENDPROC     
*!*	  PROCEDURE INTERACTIVECHANGE
*!*	     THISFORM.PAGEFRAME1.PAGE1.TXTF22.VALUE=LEFT(THIS.DISPLAYVALUE,2)
*!*	*     THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(THIS.VALUE=1,'三聯式','二聯式')
*!*	     THISFORM.PAGEFRAME1.PAGE1.TXTF22.REFRESH
*!*	     IF THIS.VALUE=1
*!*	        THISFORM.TAX_TYPE.VISIBLE=.T. 
*!*	     ENDIF
*!*	  ENDPROC
ENDDEFINE  
*********************************************************************課稅別
DEFINE CLASS TAX_TYPE AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*79
  LEFT=INT_015*269
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*50
  ROWSOURCETYPE=1
  VALUE=1
  STYLE=2
  NAME='TAX_TYPE'
  PROCEDURE INIT
     WITH THIS 
          .ADDITEM('應稅')
          .ADDITEM('零稅')          
          .ADDITEM('免稅')          
     ENDWITH   
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
     IF THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE<>1 AND THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=1
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''
     ENDIF
  ENDPROC
ENDDEFINE  
*********************************************************************是否經海關
DEFINE CLASS CUS_TYPE AS OPTIONGROUP
  HEIGHT=INT_015*25
  TOP=INT_015*79
  LEFT=INT_015*320
  HEIGHT=INT_015*25
  WIDTH=INT_015*160
  FONTSIZE=INT_015*9
  BUTTONCOUNT=2
  VALUE=2
  NAME='CUS_TYPE'
  OPTION1.CAPTION='不經海關'
  OPTION1.TOP=INT_015*5
  OPTION1.WIDTH=INT_015*72
  OPTION1.LEFT=INT_015*5
  OPTION1.NAME='OPTION1'
  OPTION2.CAPTION='須經海關'
  OPTION2.TOP=INT_015*5
  OPTION2.WIDTH=INT_015*72
  OPTION2.LEFT=INT_015*79
  OPTION2.NAME='OPTION2'    
ENDDEFINE  
***************************************************幣別設定
DEFINE CLASS CRCY AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*39
  LEFT=INT_015*379
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*84
  FONTSIZE=INT_015*9
  ROWSOURCETYPE=1
  STYLE=2
  NAME='CRCY'
  PROCEDURE INIT
    SELECT C00
    GO TOP 
    DO WHILE .NOT. EOF()
       L=4-LEN(ALLTRIM(F01))
       THIS.ADDITEM(F01)
       SKIP
    ENDDO
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=THIS.DISPLAYVALUE
    THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THIS.DISPLAYVALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z','C0Z1'),C0Z.F03,IIF(SEEK(THIS.DISPLAYVALUE,'C00'),C00.F02,1))   
    *THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THIS.DISPLAYVALUE,'C00'),C00.F02,1)
    THISFORM.PAGEFRAME1.PAGE2.TXTF14.REFRESH
    THISFORM.PAGEFRAME1.PAGE2.TXTF16.REFRESH
  ENDPROC
ENDDEFINE         
***************************************出貨計劃
DEFINE CLASS OQT_SEEK AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION=ALLTRIM(C01.F04)+'         C05.出貨計劃'
  TOP=INT_015*110
  LEFT=INT_015*5    
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*325
  WIDTH=INT_015*840
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OQT_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      WIDTH=INT_015*840,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=10,;       
      RECORDSOURCE='OQT',;     
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;            
      COLUMN5.NAME='COLUMN5',;  
      COLUMN6.NAME='COLUMN6',; 
      COLUMN7.NAME='COLUMN7',;     
      COLUMN8.NAME='COLUMN8',; 
      COLUMN9.NAME='COLUMN9',;        
      COLUMN10.NAME='COLUMN10'           
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*230,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.確定',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*320,;
      TOP=INT_015*297,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*50,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;  
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.全選',;
      TOOLTIPTEXT='全選所有資料!快速鍵->ALT+A'
      NAME='CMND3'
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*130,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.清除',;
      TOOLTIPTEXT='清除已全選之資料!快速鍵->ALT+C'
      NAME='CMND4'               
   PROCEDURE INIT 
         SELECT C04
         SET ORDER TO C041
         SELE OQT
         SET ORDER TO OQT_2
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')   
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN') 
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')                           
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION=''
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*20
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OQT.EXP_1'       
         IF PR_NO='1'  
             THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料        號'
             THISFORM.GRID1.COLUMN2.WIDTH=INT_015*180
             THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F02'               
             THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='訂單號碼'
             THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F01'
             THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80      
         ELSE
             THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='訂單號碼'
             THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F01'
             THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
             THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='料        號'
             THISFORM.GRID1.COLUMN3.WIDTH=INT_015*180
             THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F02'        
         ENDIF
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='希望交期'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='OQT.F03'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='出貨數量'         
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='OQT.F04-OQT.F05'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80     
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='計價數量'         
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='OQT.C04_F15'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*80     
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='無價數量'         
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='OQT.C04_F16'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*50                     
         THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='客戶單號'         
         THISFORM.GRID1.COLUMN8.CONTROLSOURCE='OQT.F09'
         THISFORM.GRID1.COLUMN8.WIDTH=INT_015*100                 
         THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='客戶料號'         
         THISFORM.GRID1.COLUMN9.CONTROLSOURCE="IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F17,SPACE(25))"
         THISFORM.GRID1.COLUMN9.WIDTH=INT_015*110     
         THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='出貨日期'         
         THISFORM.GRID1.COLUMN10.CONTROLSOURCE='OQT.F10'
         THISFORM.GRID1.COLUMN10.WIDTH=INT_015*65                    
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      ***
      PROC GRID1.INIT      
	 THISFORM.GRID1.COLUMN1.READONLY=.F.
	 THISFORM.GRID1.COLUMN2.READONLY=.T.
	 THISFORM.GRID1.COLUMN3.READONLY=.T.
	 THISFORM.GRID1.COLUMN4.READONLY=.T.
	 THISFORM.GRID1.COLUMN5.READONLY=.T.
	 THISFORM.GRID1.COLUMN6.READONLY=.F.
	 THISFORM.GRID1.COLUMN7.READONLY=.F.
	 THISFORM.GRID1.COLUMN8.READONLY=.T.
	 THISFORM.GRID1.COLUMN6.HEADER1.BACKCOLOR=RGB(128,255,0)
	 THISFORM.GRID1.COLUMN7.HEADER1.BACKCOLOR=RGB(128,255,0)
	 THISFORM.GRID1.COLUMN1.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN1.AddObject("CheckBox1","CheckBox1") 
	 THISFORM.GRID1.COLUMN1.CurrentControl="CheckBox1" 
	 THISFORM.GRID1.COLUMN1.Sparse=.F.
	 THISFORM.GRID1.COLUMN1.CheckBox1.Visible=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CAPTION=''
	 THISFORM.GRID1.COLUMN1.CheckBox1.AUTOSIZE=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CENTERED=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.BACKSTYLE=0
	 THISFORM.GRID1.COLUMN1.CheckBox1.LEFT=5
	 THISFORM.GRID1.COLUMN6.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN6.AddObject("TEXTBOX1","TEXTBOX1") 
	 THISFORM.GRID1.COLUMN6.CurrentControl="TEXTBOX1" 
	 THISFORM.GRID1.COLUMN6.Sparse=.F.	
	 THISFORM.GRID1.COLUMN6.TEXTBOX1.Visible=.T.      
	 THISFORM.GRID1.COLUMN7.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN7.AddObject("TEXTBOX2","TEXTBOX2") 
	 THISFORM.GRID1.COLUMN7.CurrentControl="TEXTBOX2" 
	 THISFORM.GRID1.COLUMN7.Sparse=.F.	
	 THISFORM.GRID1.COLUMN7.TEXTBOX2.Visible=.T. 	 
      ENDPROC
      ***
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
*!*	           FCH='GRID1'
      ENDPROC 
 PROCEDURE CMND1.CLICK
      SELECT OQT
      CHK_IN='1'
      THISFORM.RELEASE     
 ENDPROC
 PROCEDURE CMND2.CLICK
      CHK_IN='0' 
      THISFORM.RELEASE
 ENDPROC  
 **
 PROCEDURE CMND3.CLICK     
      SELECT OQT
      RE=RECNO('OQT')
      GO TOP
      DO WHILE !EOF()
	     REPLACE OQT.EXP_1 WITH 1 
             REPLACE OQT.C04_F15 WITH (OQT.F04-OQT.F05)-IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)  
             REPLACE OQT.C04_F16 WITH IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)               
	     SELECT OQT
	     SKIP
      ENDDO
      SELECT OQT
      GO RE  
      THISFORM.GRID1.SETFOCUS 
 ENDPROC      
  PROCEDURE CMND4.CLICK
      SELECT OQT
      RE=RECNO('OQT')
      GO TOP
      DO WHILE !EOF()
             REPLACE OQT.EXP_1 WITH 0 
             REPLACE OQT.C04_F15 WITH 0
             REPLACE OQT.C04_F16 WITH 0  
             SELECT OQT
             SKIP
      ENDDO
      SELECT OQT
      GO RE
      THISFORM.GRID1.SETFOCUS 
 ENDPROC     
ENDDEFINE  
*********     
DEFINE CLASS CheckBox1 AS CheckBox
      PROCEDURE CLICK
         SELECT OQT
         IF THIS.VALUE=1
              REPLACE OQT.EXP_1 WITH 1
              REPLACE OQT.C04_F15 WITH (OQT.F04-OQT.F05)-IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)  
              REPLACE OQT.C04_F16 WITH IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)               
         ELSE
              REPLACE OQT.EXP_1 WITH 0
              REPLACE OQT.C04_F15 WITH 0
              REPLACE OQT.C04_F16 WITH 0             
         ENDIF
         THISFORM.GRID1.SETFOCUS     
   ENDPROC 
ENDDEFINE 
*********     
DEFINE CLASS TEXTBOX1 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT OQT
         IF OQT.EXP_1=1
             DO CASE 
                   CASE THIS.VALUE<=0
                    	      THIS.VALUE=(OQT.F04-OQT.F05)-IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)
                    	      =MESSAGEBOX('計價數量不得小於等於零,請重新輸入!!',0+64,'提示訊息視窗')        
                  CASE THIS.VALUE>IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F10-(C04.F16-C04.F19)-C04.F23,0)
			     =MESSAGEBOX('計價數量不得大於未出貨數量'+ALLTRIM(STR(C04.F10-(C04.F16-C04.F19)-C04.F23)),0+48,'提示訊息視窗') 
                    	      THIS.VALUE=(OQT.F04-OQT.F05)-IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)			                        	      
                  CASE THIS.VALUE+OQT.C04_F16<=0 OR THIS.VALUE+OQT.C04_F16>IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F10-C04.F23,0) 	        
                             =MESSAGEBOX('計價數量與無價數量總合不得小於等於 0 或大於未出貨數量'+ALLTRIM(STR(C04.F10-C04.F23)),0+48,'提示訊息視窗')                  
                    	      THIS.VALUE=(OQT.F04-OQT.F05)-IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)                         
             ENDCASE   
             REPLACE OQT.C04_F15 WITH THIS.VALUE        
         ENDIF  
         THISFORM.GRID1.SETFOCUS  
   ENDPROC 
ENDDEFINE   
*********     
DEFINE CLASS TEXTBOX2 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT OQT
         IF OQT.EXP_1=1
             DO CASE 
                   CASE THIS.VALUE<=0
                    	      THIS.VALUE=IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)   
                    	      =MESSAGEBOX('無價數量不得小於等於零,請重新輸入!!',0+64,'提示訊息視窗')        
                  CASE THIS.VALUE>IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)
			     =MESSAGEBOX('無價數量不得大於未出貨數量'+ALLTRIM(STR(C04.F16-C04.F19)),0+48,'提示訊息視窗') 
                    	      THIS.VALUE=IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)   		                        	      
                  CASE THIS.VALUE+OQT.C04_F15<=0 OR THIS.VALUE+OQT.C04_F15>IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F10-C04.F23,0) 	        
                             =MESSAGEBOX('計價數量與無價數量總合不得小於等於 0 或大於未出貨數量'+ALLTRIM(STR(C04.F10-C04.F23)),0+48,'提示訊息視窗')                  
                    	      THIS.VALUE=IIF(SEEK(OQT.F01+OQT.F02,'C04'),C04.F16-C04.F19,0)                      
             ENDCASE    
             REPLACE OQT.C04_F16 WITH THIS.VALUE       
         ENDIF  
         THISFORM.GRID1.SETFOCUS  
   ENDPROC 
ENDDEFINE           
**********************************************************       編輯出貨單號
DEFINE CLASS PBKB04_SEEK AS FORM
  autocenter=.t.
  FONTSIZE=INT_015*9
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='route_SEEK'
       TOP=INT_015*17
       LEFT=INT_015*34
       HEIGHT=INT_015*282
       WIDTH=INT_015*430
       CAPTION='匯集出貨單號'
       DRAGIT=.F.                                &&---紀錄可拖曳的項目       
       NODRAGIT=.F.                              &&---紀錄不可拖曳的項目
       ADD OBJECT LABEL1 AS LABEL WITH;
           LEFT=INT_015*20,;
           HEIGHT=INT_015*25,;
           AUTOSIZE=.T.,;
           CAPTION='未加入之單號' 
       ADD OBJECT LABEL2 AS LABEL WITH;
           LEFT=INT_015*270,;
           HEIGHT=INT_015*25,;
           AUTOSIZE=.T.,;
           CAPTION='已加入之單號'        
       ADD OBJECT LIST1 AS LISTBOX WITH;                &&來源表列
           ROWSOURCETYPE=1,;
           VALUE=0,;
           DRAGICON='BMPS\DRAGMOVE.CUR',;
           HEIGHT=INT_015*188,;
           LEFT=INT_015*11,;
           TOP=INT_015*28,;
           WIDTH=INT_015*156,;
           ROWHEIGHT=INT_015*18,;  
           FONTSIZE=INT_015*9,;      
           TOOLTIPTEXT='未加入單號列表',;
           NAME='LIST1'
        ADD OBJECT LIST2 AS LISTBOX WITH;               &&目的表列
            ROWSOURCETYPE=1,;
            VALUE=0,;
            DRAGICON='DRAGMOVE.CUR',;
            HEIGHT=INT_015*185,;
            LEFT=INT_015*263,;
            TOP=INT_015*26,;
            WIDTH=INT_015*162,;
            ROWHEIGHT=INT_015*18,;  
            FONTSIZE=INT_015*9,;        
            TOOLTIPTEXT='已加入單號列表',;             
            NAME='LIST2'
         ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
             TOP=INT_015*39,;
             LEFT=INT_015*195,;
             HEIGHT=INT_015*34,;
             WIDTH=INT_015*38,;
             CAPTION='',;
             TOOLTIPTEXT='單筆資料匯入',;
             PICTURE='BMPS\FORWARDONE.BMP',;
             NAME='CMND1'
         ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
             TOP=INT_015*74,;
             LEFT=INT_015*195,;
             HEIGHT=INT_015*34,;
             WIDTH=INT_015*38,;
             CAPTION='',;
             TOOLTIPTEXT='全部資料匯入',;             
             PICTURE='BMPS\FORWARDALL.BMP',;             
             NAME='CMND2'
         ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
             TOP=INT_015*135,;
             LEFT=INT_015*195,;
             HEIGHT=INT_015*34,;
             WIDTH=INT_015*38,;
             CAPTION='',;
             TOOLTIPTEXT='單筆資料匯出',;             
             PICTURE='BMPS\BACKONE.BMP',;             
             NAME='CMND3'
         ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
             TOP=INT_015*170,;
             LEFT=INT_015*195,;
             HEIGHT=INT_015*34,;
             WIDTH=INT_015*38,;
             CAPTION='',;
             TOOLTIPTEXT='全部資料匯出',;                          
             PICTURE='BMPS\BACKALL.BMP',;                          
             NAME='CMND4'             
         ADD OBJECT CMND5 AS COMMANDBUTTON WITH;
             TOP=INT_015*238,;
             LEFT=INT_015*284,;
             HEIGHT=INT_015*30,;
             WIDTH=INT_015*99,;
             CAPTION='\<X.離開',;
             NAME='CMND5'    
         ADD OBJECT CMND6 AS COMMANDBUTTON WITH;
             TOP=INT_015*238,;
             LEFT=INT_015*138,;
             HEIGHT=INT_015*30,;
             WIDTH=INT_015*99,;
             CAPTION='\<S.確認',;
             NAME='CMND6'                 
          PROCEDURE INIT
             THISFORM.Caption='多張出貨單匯集'
             THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')
             THISFORM.SETALL('FONTSIZE',INT_015*9,'LISTBOX')
             THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')
          ENDPROC   
          PROCEDURE LIST1.INIT        
                    with this
                         SELE B04_3
                         GO TOP
                         DO WHILE !EOF()                           
                            .ADDITEM(B04_3.F01)              
                             SKIP
                         ENDDO   
                         SELE B04_3
                         USE
                         .VALUE=1
                     endwith   
          ENDPROC                
          PROCEDURE LIST2.INIT
                    WITH THIS
                         SELE B04_4
                         GO TOP
                         DO WHILE !EOF()
                           .ADDITEM(B04_4.F01)
                           SKIP
                         ENDDO    
                         
                         .VALUE=1
                    ENDWITH
          ENDPROC
          PROCEDURE NODRAG                             &&當拖曳物件進入按鈕物件時出現禁止圖示
             PARAMETER nState
             DO CASE
                CASE nState=0                &&Enter
                     THISFORM.LIST1.DRAGICON=THIS.NODRAGIT
                     THISFORM.LIST2.DRAGICON=THIS.NODRAGIT
                CASE nState=1
                     THISFORM.LIST1.DRAGICON=THIS.DRAGIT
                     THISFORM.LIST2.DRAGICON=THIS.DRAGIT
              ENDCASE
           ENDPROC
           PROCEDURE DRAGOVER                          &&拖曳的物件進入表格
              LPARAMETERS oSource,nXCoord,nYCoord,nState
              THIS.NODRAG(nState)
           ENDPROC

           PROCEDURE Load                              &&指定拖曳時的游標圖案
              THIS.DRAGIT='BMPS\DRAGMOVE.CUR'
              THIS.NODRAGIT='BMPS\NO.CUR'
           ENDPROC
           PROCEDURE LIST1.DblClick                    &&在來源表列按兩次滑鼠左鍵
              THISFORM.LIST2.ADDITEM(THIS.LIST(THIS.Listindex))
              THIS.RemoveItem(THIS.ListIndex)
           ENDPROC
           PROCEDURE LIST1.MouseMove                   &&在來源表列中拖曳
              LPARAMETER nButton,nShift,nXCoord,nYCoord
              ITEM=THIS.VALUE   
              IF THIS.ListCount>0 AND nButton=1              &&尚有選項&MouseLeft
                 IF THIS.Selected(ITEM)                      &&已選取
                    THIS.DRAGICON=THISFORM.DRAGIT
                    THIS.DRAG(1)
                 ENDIF
              ENDIF      
           ENDPROC   
           PROCEDURE LIST1.DRAGOVER                    &&當有拖曳中的物件經過LIST1的上方
              LPARAMETER oSource,nXCoord,nYCoord,nState
              IF oSource.NAME='LIST2'
                 DO CASE
                    CASE nState=0                      &&Enter
                         THISFORM.LIST2.DRAGICON=THISFORM.DRAGIT
                    CASE nState=1                      &&Leave
                         THISFORM.LIST2.DRAGICON=THISFORM.NODRAGIT
                  ENDCASE
               ENDIF                                          
            ENDPROC
            PROCEDURE LIST1.DragDrop                   &&當有拖曳的物件放在LIST1物件中
               LPARAMETER oSource,nXCoord,nYCoord,nState                              
               IF UPPER(oSource.NAME)='LIST2'
                  THISFORM.LIST2.DblClick
               ENDIF
            ENDPROC
            PROCEDURE LIST2.DblClick                   &&在目的表列連按兩次滑鼠左鍵
               THISFORM.LIST1.Additem(THIS.List(This.ListIndex))
               THIS.RemoveItem(THIS.ListIndex)
            ENDPROC
            PROCEDURE LIST2.DragDrop                   &&當有拖曳的物件放在LIST2物件中
               LPARAMETERS oSource,nXCoord,nYCoord
               IF UPPER(oSource.NAME)='LIST1'
                  THISFORM.LIST1.DblClick
               ENDIF
            ENDPROC
            PROCEDURE LIST2.DragOver                   &&當有拖曳中的物件經過LIST2的上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               IF oSource.NAME='LIST1'
                  DO CASE 
                     CASE nState=0             &&Enter
                          THISFORM.LIST1.DragIcon=THISFORM.DRAGIT
                     CASE nState=1             &&Leave
                          THISFORM.LIST2.Dragicon=THISFORM.NODRAGIT
                  ENDCASE
               ENDIF                
            ENDPROC
            PROCEDURE LIST2.MouseMove                  &&在目的表列中拖曳
               LPARAMETERS nButton,nShift,nXCoord,nYCoord
               ITEM=THIS.VALUE
               IF THIS.ListCount>0 AND nButton=1      &&尚有選項&MouseLeft
                  IF THIS.Selected(ITEM)              &&已選取   
                     THIS.DragIcon=THISFORM.DRAGIT
                     THIS.Drag(1)
                  ENDIF
               ENDIF
            ENDPROC
            PROCEDURE CMND1.CLICK                     &&>單筆匯入按鈕
               ITEM=THISFORM.LIST1.VALUE
               IF THISFORM.LIST1.SELECTED(ITEM)
                  THISFORM.LIST2.AddItem(THISFORM.LIST1.List(ITEM))
                  THISFORM.LIST1.RemoveItem(THISFORM.LIST1.ListIndex)
               ENDIF            
            ENDPROC
            PROCEDURE CMND1.Dragover                  &&當有拖曳中的物件經過CMND1上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC
            PROCEDURE CMND2.CLICK                     &&>>全部筆數匯入按鈕
               FOR I=1 TO THISFORM.LIST1.ListCount
                   THISFORM.LIST2.AddItem(THISFORM.LIST1.List(1))
                   THISFORM.LIST1.RemoveItem(1)
               ENDFOR
            ENDPROC
            PROCEDURE CMND2.Dragover                  &&當有拖曳中的物件經過CMND2上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC
            PROCEDURE CMND3.CLICK                     &&<單筆匯出按扭
               ITEM=THISFORM.LIST2.VALUE
               IF THISFORM.LIST2.Selected(ITEM)
                  THISFORM.LIST1.AddItem(THISFORM.LIST2.List(ITEM))
                  THISFORM.LIST2.RemoveItem(THISFORM.LIST2.ListIndex)
               ENDIF
            ENDPROC
            PROCEDURE CMND3.Dragover                  &&當有拖曳中的物件經過CMND3上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC           
            PROCEDURE CMND4.CLICK                     &&<<全部筆數匯出按鈕
               FOR I=1 TO THISFORM.LIST2.ListCount
                   THISFORM.LIST1.AddItem(THISFORM.LIST2.List(1))
                   THISFORM.LIST2.RemoveItem(1)
               ENDFOR
            ENDPROC
            PROCEDURE CMND4.DragOver                  &&有拖曳中的物件經過CMND4的上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC
            PROCEDURE CMND5.CLICK                     &&離開按鈕
               _TALLY=0
               RELEASE THISFORM
               CLEAR EVENT
            ENDPROC
            PROCEDURE CMND5.Dragover                  &&當有拖曳中的物件經過CMND5的上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC        
            PROCEDURE CMND6.CLICK                    &&確認按鈕
               DELE FROM B04_4 
               SELE B04_4
               FOR I=1 TO THISFORM.LIST2.ListCount
                   APPEND BLANK                                 
                   REPLACE  F01 WITH THISFORM.LIST2.List(I)                 
               ENDFOR                              
             
               RELEASE THISFORM
               CLEAR EVENT
            ENDPROC
            PROCEDURE CMND6.Dragover                &&當有拖曳中的物件經過CMND6的上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC              
            PROCEDURE LABEL1.Dragover                &&當有拖曳中的物件經過LABEL1的上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC                          
            PROCEDURE LABEL2.Dragover                &&當有拖曳中的物件經過LABEL2的上方
               LPARAMETERS oSource,nXCoord,nYCoord,nState
               THISFORM.NoDrag(nState)
            ENDPROC                                      
ENDDEFINE
*********************************
DEFINE CLASS BTNF05 AS CommandButton         
       
       PROCEDURE CLICK
          CHG_DEPT=CREATEOBJECT("CHG_DEPT")  
          CHG_DEPT.SHOW    
       ENDPROC      
ENDDEFINE
***********************************************過帳後更換出貨更換部門
DEFINE CLASS CHG_DEPT AS FORM
      AUTOCENTER=.T.
   CAPTION='請輸入正確出貨部門編號'
   TOP=INT_015*180
   LEFT=INT_015*220          
   FONTSIZE=INT_015*9
   HEIGHT=INT_015*170
   WIDTH=INT_015*350
   FONTSIZE=INT_015*9
   MOVABLE=.F.
   MAXBUTTON=.F.
   MINBUTTON=.F.      
   CONTROLBOX=.F.
   BORDERSTYLE=2
   SHOWTIPS=.T.
   SHOWWINDOW=1
   WINDOWTYPE=1
   NAME='CHG_DEPT'
   ADD OBJECT LABEL1 AS LABEL WITH;
       LEFT=INT_015*20,;
       TOP=INT_015*25,;
       HEIGHT=INT_015*25,;
       AUTOSIZE=.T.,;
       CAPTION='請輸入正確出貨部門' 
   ADD OBJECT LABEL2 AS LABEL WITH;
       LEFT=INT_015*72,;
       TOP=INT_015*50,;
       HEIGHT=INT_015*25,;
       AUTOSIZE=.T.,;
       CAPTION=' '    
   ADD OBJECT TEXT1 AS TEXTBOX WITH;
       LEFT=INT_015*20,;
       TOP=INT_015*50,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*50,;
       MAXLENGTH=5
   ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
       LEFT=INT_015*60,;    
       HEIGHT=INT_015*25,;   
       TOP=INT_015*140,;  
       WIDTH=INT_015*50,;
       CAPTION='\<Y.執  行',;
       TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
       NAME='CMND1'
   ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
       LEFT=INT_015*130,;
       TOP=INT_015*140,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*50,;
       CAPTION='\<C.取  消',;
       TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
       NAME='CMND2'   
   PROCEDURE INIT 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL') 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX') 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON') 
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.CUR','COMMANDBUTTON')          
      THISFORM.LABEL1.CAPTION='請輸入'+ALLTRIM(B04.F79)+ '正確出貨部門'             
      THISFORM.TEXT1.READONLY=.F.
   ENDPROC             
   PROCEDURE TEXT1.INTERACTIVECHANGE
      IF AT('?',ALLTRIM(THIS.VALUE))<>0
         IF AT('?',ALLTRIM(THIS.VALUE))>1             
            SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND LEN(ALLTRIM(F01))<=5 AND F04='*' AND F13='*'
         ELSE
            SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEN(ALLTRIM(F01))<=5 AND F04='*' AND F13='*'
         ENDIF   
         IF _TALLY>0
            DEPART_SEEK=CREATEOBJECT("DEPART_SEEK")  
            DEPART_SEEK.SHOW    
	        THIS.VALUE=FLG              
          THIS.REFRESH
          FLG='0'
       ENDIF          
      ENDIF   
      THISFORM.LABEL2.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')
   ENDPROC   
   PROCEDURE CMND1.CLICK
       IF SEEK(THISFORM.TEXT1.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.TEXT1.VALUE)
          =MESSAGEBOX('預設部門主檔中無此編號請先建立!',0+48,'提示訊息視窗')
          THISFORM.LABEL2.CAPTION=''
          THISFORM.TEXT1.SETFOCUS          
          RETURN            
       ENDIF
       HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3)) 
       SELECT B04
       IF THISFORM.TEXT1.VALUE<>B04.F05
          SELECT B11
          SEEK B04.F05+B04.F79
          IF FOUND()
             REPLACE F04 WITH F04+(B04.F04+B04.F13)
             IF F04=0
                DELE
             ELSE   
                IF F05<CTOD((HK+'/'+B04.F02))
                   REPLACE F05 WITH CTOD((HK+'/'+B04.F02))
                ENDIF
             ENDIF   
          ELSE
             APPEND BLANK
             REPLACE F01 WITH B04.F05
             REPLACE F03 WITH B04.F79
             REPLACE F04 WITH (B04.F04+B04.F13)
             REPLACE F05 WITH CTOD((HK+'/'+B04.F02))
             REPLACE F06 WITH B04.F07
             IF INT_028 AND B01.F98<>'A  '
                REPLACE F08 WITH B04.F06
             ENDIF                                            
          ENDIF   
          SELECT B11
          SEEK THISFORM.TEXT1.VALUE+B04.F79
          IF FOUND()
             REPLACE F04 WITH F04+(B04.F04+B04.F13)*(-1)
             IF F04=0
                DELE
             ELSE   
                IF F05<CTOD((HK+'/'+B04.F02))
                   REPLACE F05 WITH CTOD((HK+'/'+B04.F02))
                ENDIF
             ENDIF   
          ELSE
             APPEND BLANK
             REPLACE F01 WITH THISFORM.TEXT1.VALUE
             REPLACE F03 WITH B04.F79
             REPLACE F04 WITH (B04.F04+B04.F13)*(-1)
             REPLACE F05 WITH CTOD((HK+'/'+B04.F02))
             REPLACE F06 WITH B04.F07
             IF INT_028 AND B01.F98<>'A  '
                REPLACE F08 WITH B04.F06
             ENDIF                                            
          ENDIF   
          SELECT B25
          SEEK B04.F05+B04.F79
          IF FOUND()
             REPLACE F06 WITH F06+(B04.F04+B04.F13)*(-1)
             REPLACE F15 WITH F15+(B04.F04+B04.F13)
          ELSE
               APPEND BLANK
               REPL F01 WITH B04.F05
               REPL F02 WITH B04.F79
               REPL F06 WITH (B04.F04+B04.F13)*(-1)
               REPL F15 WITH (B04.F04+B04.F13) 
          ENDIF
          SELECT B25
          SEEK THISFORM.TEXT1.VALUE+B04.F79
          IF FOUND()
             REPLACE F06 WITH F06+(B04.F04+B04.F13)
             REPLACE F15 WITH F15+(B04.F04+B04.F13)*(-1)
          ELSE
              APPEND BLANK
               REPL F01 WITH THISFORM.TEXT1.VALUE
               REPL F02 WITH B04.F79
               REPL F06 WITH (B04.F04+B04.F13)
               REPL F15 WITH (B04.F04+B04.F13)*(-1) 
          ENDIF
          SELECT B26
          SEEK B04.F05+B04.F79+B04.F02+'C'+B04.F01+'訂'+B04.F07+' '+IIF(SEEK(B04.F06,'C01'),C01.F05,'')
          IF FOUND()
             REPLACE F02 WITH THISFORM.TEXT1.VALUE
          ELSE
             APPEND BLANK
             REPLACE F01 WITH B04.F79
             REPLACE F02 WITH THISFORM.TEXT1.VALUE
             REPLACE F03 WITH B04.F02
             REPLACE F04 WITH (B04.F04+B04.F13)*(-1)
             REPLACE F06 WITH 'C'
             REPLACE F07 WITH B04.F01
             REPLACE F08 WITH '訂'+B04.F07+' '+IIF(SEEK(B04.F06,'C01'),C01.F05,'')                
          ENDIF
          SELECT B04
          REPLACE F05 WITH THISFORM.TEXT1.VALUE
          REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
       THISFORM.CMND2.CLICK
   ENDPROC
   PROCEDURE CMND2.CLICK               
       THISFORM.RELEASE        
   ENDPROC         
ENDDEFINE


*********************************
DEFINE CLASS BTNF79 AS CommandButton                
       PROCEDURE CLICK
          CREATE CURSOR FGI (F79 C(43),F04 N(11))
          INDEX ON F79 TAG FGI
          SET ORDER TO 1
          SELECT FGI
          APPEND BLANK          
          REPLACE F79 WITH B04.F79
          REPLACE F04 WITH B04.F04
           TQTY=B04.F04
          SPT_PTNB=CREATEOBJECT("SPT_PTNB")  
          SPT_PTNB.SHOW    
       ENDPROC      
ENDDEFINE
***********************************************實際出貨料號拆批
define class SPT_PTNB as form
  autocenter=.t.
  caption='實際出貨料號拆批    原訂單出貨料號:'+B04.F03
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*370
  WIDTH=INT_015*360
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='SPT_PTNB'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      LEFT=INT_015*3,;
      WIDTH=INT_015*353,;
      HEIGHT=INT_015*65
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;    
      LEFT=INT_015*3,;
      TOP=INT_015*67,;
      WIDTH=INT_015*353,;
      HEIGHT=INT_015*265
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      LEFT=INT_015*3,;
      TOP=INT_015*334,;
      WIDTH=INT_015*353,;
      HEIGHT=INT_015*35    
  add object cmdgroup as cmdgroup with;      
      TOP=INT_015*299,;
      LEFT=INT_015*10
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      TOP=INT_015*335,;
      LEFT=INT_015*10
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      VISIBLE=.F.    
  ADD OBJECT LBLF79 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*5,;
      HEIGHT=INT_015*17,;
      WIDTH=INT_015*50,;
      CAPTION='實際料號'
  ADD OBJECT LBLF04 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*5,;
      WIDTH=INT_015*50,;
      HEIGHT=INT_015*17,;
      CAPTION='出貨數量'
 
  ADD OBJECT LBLQTY AS LABEL WITH;
      TOP=INT_015*315,;
      LEFT=INT_015*200,;
      AUTOSIZE=.T.,;
      CAPTION='未加入量：'    
  ADD OBJECT LBLTQTY AS LABEL WITH;
      TOP=INT_015*345,;
      LEFT=INT_015*200,;
      AUTOSIZE=.T.
  ADD OBJECT TXTF79 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*231,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=43,;
      NAME='TXTF79'
  ADD OBJECT TXTF04 AS TEXTBOX WITH;
      TOP=INT_015*29,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*73,;
      HEIGHT=INT_015*25,;
      INPUTMASK='99999999999',;
      NAME='TXTF04'      
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*30,;
      LEFT=INT_015*180                
  ADD OBJECT GRID1 AS GRID WITH;        
      AUTOCENTER=.T.,;
      LEFT=INT_015*10,;
      TOP=INT_015*71,;
      WIDTH=INT_015*340,;      
      HEIGHT=INT_015*230,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=2,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;       
      COLUMN2.NAME='COLUMN2'      
  add object cmnd2 as commandbutton with;
      LEFT=INT_015*141,;
      TOP=INT_015*339,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<X.離開',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+X'
      name='cmnd2'
      PROCEDURE ACTIVATE
          THISFORM.Caption='實際出貨料號拆批    原訂單出貨料號:'+B04.F03
      ENDPROC
      procedure init 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX') 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')          
         AREA1='FGI' 
         
        SELE FGI
         
       
        
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='FGI'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.PNT_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.ESC_BOTT.VISIBLE=.F.
         THISFORM.SHRGROUP.VISIBLE=.F.
         THISFORM.SHRGROUP.ENABLED=.F.         
         thisform.setall('readonly',.t.,'textbox')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='實際料號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*231
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='FGI.F79'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='出貨數量'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='FGI.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*83
      
         THISFORM.GRID1.SETALL("DYNAMICFORECOLOR","IIF(EMPTY(C05.F15),RGB(205,102,29),'')",'COLUMN')
         THISFORM.GRID1.SETFOCUS       
         FCH='GRID1'
         IF THISFORM.GRID1.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
            THISFORM.LBLF071.CAPTION=''
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.         
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=(IIF(B04.F04-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1)                          
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.  
         ENDIF                     
         THISFORM.LBLTQTY.CAPTION=ALLTRIM(STR(B04.F04-TQTY)) 
         THISFORM.CMND2.ENABLED=.T.                               
         THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(B04.F04-TQTY<>0,.T.,.F.)               
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XColIndex     
         THISFORM.TXTF79.VALUE=FGI.F79
         THISFORM.TXTF04.VALUE=FGI.F04
          
         FCH=THISFORM.ACTIVECONTROL.NAME 
         IF THIS.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.         
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=(IIF(B04.F04-TQTY>=0,.T.,.F.)  .OR. THISFORM.GRID1.ACTIVEROW=1)                             
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.      
         ENDIF            
         IF B04.F04-TQTY>0
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
         ELSE
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.                     
         ENDIF
      ENDPROC  
      procedure cmnd2.click
         IF FGI.F79<>B04.F79 OR FGI.F04<>B04.F04  &&如果真有修改
            IF B04.F04-TQTY>0
                =MESSAGEBOX('還有未加入數量'+ALLTRIM(STR(B04.F04-TQTY)),0+48,'提示訊息視窗')                           
               THISFORM.GRID1.SETFOCUS
               THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.
               RETURN                             
            ENDIF 
            VF01=B04.F01
            VF02=B04.F02
            VF03=B04.F03
            VF05=B04.F05
            VF06=B04.F06
            VF07=B04.F07
            VF08=B04.F08
            VF09=B04.F09
            VF12=B04.F12
            VF14=B04.F14
            VF15=B04.F15
            VF16=B04.F16
            VF20=B04.F20
            VF21=B04.F21
            VF22=B04.F22
            VF23=B04.F23
            VF24=B04.F24
            SELECT B04
            DELETE 
            SELECT FGI
            GO TOP
            DO WHILE !EOF()
               SELECT B04
               APPEND BLANK 
               REPLACE F01 WITH VF01
               REPLACE F02 WITH VF02
               REPLACE F03 WITH VF03
               REPLACE F04 WITH FGI.F04
               REPLACE F05 WITH VF05
               REPLACE F06 WITH VF06
               REPLACE F07 WITH VF07
               REPLACE F08 WITH VF08
               REPLACE F09 WITH VF09
               REPLACE F11 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
               REPLACE F12 WITH VF12
               REPLACE F14 WITH VF14
               REPLACE F15 WITH VF15
               REPLACE F16 WITH VF16
               REPLACE F17 WITH ROUND(IIF(F16=1,F04*F15,F04*F15*F16),INT_069)
               REPLACE F20 WITH VF20
               REPLACE F21 WITH VF21
               REPLACE F22 WITH VF22
               REPLACE F23 WITH VF23
               REPLACE F24 WITH VF24
               REPLACE F79 WITH FGI.F79
               SELECT FGI
               SKIP
            ENDDO
         ENDIF
         SELECT FGI
         USE
         AREA1='B04_1'
         SELECT B04
         thisform.release         
      endproc    
      PROC ORPGROUP.NEW_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.
            
          
           THISFORM.TXTF79.READONLY=.F.
           THISFORM.TXTF04.READONLY=.F.
          
           THISFORM.TXTF04.VALUE=B04.F04-TQTY
           THISFORM.TXTF79.VALUE=B04.F03
           THISFORM.TXTF79.SETFOCUS
           QTY=B04.F04-TQTY
           THISFORM.LBLTQTY.CAPTION=ALLTRIM(STR(QTY))
      ENDPROC
      PROC ORPGROUP.EDIT_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.      
           SELE FGI
           
           
              THISFORM.TXTF79.READONLY=.T.
              THISFORM.TXTF04.READONLY=.F.
              THISFORM.TXTF04.SETFOCUS
            
                         
      ENDPROC        
      PROC ORPGROUP.DEL_BOTT.CLICK
           IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	            
                        
              
             TQTY=TQTY-FGI.F04
                SELE FGI                
                      
             
                 DELE
                      
                 IF BOF()
                    GO TOP
                 ELSE
                   SKIP -1   
                 ENDIF
                  
                    
              THISFORM.GRID1.SETFOCUS
              IF THISFORM.GRID1.ACTIVEROW=0
                 THISFORM.CMDGROUP.ENABLED=.F.
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.   
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
                 THISFORM.SETALL('VALUE','','TEXTBOX')
                 
              ELSE      
                 THISFORM.CMDGROUP.ENABLED=.T.
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=iif(B04.F04-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
              ENDIF           
           ENDIF   
           THISFORM.LBLTQTY.CAPTION=ALLTRIM(STR(B04.F04-TQTY))
           thisform.CMND2.enabled=iif(B04.F04-TQTY>=0,.T.,.F.)
      ENDPROC
      PROC SHRGROUP.SHURE1_BOTT.CLICK
           IF EMPTY(THISFORM.TXTF79.VALUE) OR !SEEK(THISFORM.TXTF79.VALUE,'B01')
              =MESSAGEBOX('無此料品編號',0+48,'提視訊息視窗')
              THISFORM.TXTF79.SETFOCUS
              RETURN
           ENDIF
           IF SEEK(THISFORM.TXTF79.VALUE,'FGI')
              =MESSAGEBOX('料號重覆',0+48,'提視訊息視窗')
              THISFORM.TXTF79.SETFOCUS
              RETURN
           ENDIF
           IF THISFORM.TXTF04.VALUE<=0
              =MESSAGEBOX('出貨數量不得小於等於 0',0+48,'提視訊息視窗')
              THISFORM.TXTF04.SETFOCUS
              RETURN
           ENDIF
           SELE FGI
           APPEND BLANK
           
          
           
           REPLACE  F79 WITH THISFORM.TXTF79.VALUE
           REPLACE  F04 WITH THISFORM.TXTF04.VALUE
          
           TQTY = TQTY+F04     
            
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC         
      PROC SHRGROUP.SHURE2_BOTT.CLICK
          
            
           IF THISFORM.TXTF04.VALUE<=0
              =MESSAGEBOX('出貨數量不得小於等於 0',0+48,'提視訊息視窗')
              THISFORM.TXTF04.SETFOCUS
              RETURN
           ENDIF
           SELE FGI
           TQTY=TQTY-F04
           REPL F79 WITH THISFORM.TXTF79.VALUE
           REPL F04 WITH THISFORM.TXTF04.VALUE           
           TQTY=TQTY+F04
          
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC
      PROC SHRGROUP.ABANDON_BOTT.CLICK
           THISFORM.SHRGROUP.ENABLED=.F.
           THISFORM.SHRGROUP.VISIBLE=.F.      
           THISFORM.ORPGROUP.ENABLED=.T.
           THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.CMDGROUP.ENABLED=.T.
           THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
           THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
           THISFORM.LBLTQTY.CAPTION=ALLTRIM(STR(B04.F04-TQTY)) 
           THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(B04.F04-TQTY<>0,.T.,.F.)                          
           THISFORM.CMND2.ENABLED=IIF(B04.F04-TQTY>=0,.T.,.F.)   
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(B04.F04-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1                                                                          
           THISFORM.GRID1.ENABLED=.T.
           THISFORM.GRID1.SETFOCUS     
           UNLOCK ALL      
      ENDPROC
      PROC SHRGROUP.FINISH_BOTT.CLICK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
      ENDPROC
 
   
enddefine            


*******************************************   計算該單出貨總金額
FUNC TTL1
     PARA BKK_NO
     qt_od=0
     sele B04
     SEEK BKK_NO
     IF FOUND()
         DO WHILE F01=BKK_NO            
                          
                  qt_od=qt_od+f17
                                                    
                SKIP
          ENDDO
     ELSE
       qt_od=0
     ENDIF     
     SELE B04_1
     RETURN ROUND(qt_od,INT_069)
*******************************************   計算該單出貨外幣金額
FUNC TTL3
     PARA BKK_NO
     qt_od=0
     sele B04
     SEEK BKK_NO
     IF FOUND()
         DO WHILE F01=BKK_NO            
                          
                  qt_od=qt_od+ROUND(F04*F15,2)
                                                    
                SKIP
          ENDDO
     ELSE
       qt_od=0
     ENDIF     
     SELE B04_1
     RETURN ROUND(qt_od,2)     
*******************************************   計算該單出貨總數量
FUNC TTL2
     PARA BKK_NO
     qt_od=0
     sele B04
     SEEK BKK_NO
     IF FOUND()
         DO WHILE F01=BKK_NO            
                          
                  qt_od=qt_od+(f04+F13)
                                                    
                SKIP
          ENDDO
     ELSE
       qt_od=0
     ENDIF
     SELE B04_1
     RETURN qt_od
********產地別
     FUNC BILL
     PARA JUK
     JO=''
        DECLARE B01A(20)
	Y=0
	X=1
	STRF='' &&欄位內容
*	IF SEEK('INT_161','A26')
*	       PR=A26.F06
*	ENDIF
	FOR I=1 TO LEN(ALLTRIM(INT_161))
		IF RIGHT(LEFT(ALLTRIM(INT_161),I),1)=','
		     Y=Y+1
		ENDIF  
	ENDFOR	  
	 FOR J=1 TO Y
	         DO WHILE    RIGHT(LEFT(ALLTRIM(INT_161),X),1)!=','
	                 STRF=STRF+RIGHT(LEFT(ALLTRIM(INT_161),X),1)
	                 X=X+1
	         ENDDO
	         STORE STRF TO B01A(J)
	         X=X+1
	         STRF=''
	  ENDFOR 
    JO=IIF(ASCAN(B01A,JUK)=0,'',RIGHT(B01A(ASCAN(B01A,JUK)),LEN(B01A(ASCAN(B01A,JUK)))-2))
    RETURN JO
