
CLEAR 
CLOSE ALL
SET DELETED ON
SET EXCLUSIVE OFF
MTH='2018'
SELECT 0
USE \\192.168.10.160\MISD2\D10
SET ORDER TO 4
SELECT 0
USE \\192.168.10.160\MISD2\P04  
SET ORDER TO 1
SELECT 0
USE \\192.168.10.160\MISD2\C03 ALIAS C03
SET ORDER TO 1
SELECT 0
USE \\192.168.10.160\MISD2\C04 ALIAS C04
SET ORDER TO 1
SELECT 0
USE \\192.168.10.160\MISD2\C02 ALIAS C02
SET ORDER TO 3
CREATE CURSOR DNTS(F01 C(10),F02 D(8),F03 C(43),F04 N(11,0),F06 C(5),F07 C(10),F14 C(4),F15 N(14,6),F16 N(11,6),F17 N(15,3),F20 C(10),F79 C(43),RC_DTE D(8),PO_NO C(10),STCK_NO C(30),Q_DTE D(8),UNIT_PRICE N(11,6),PLS N(11,6),IN_DTE D(8),IN_PRICE N(14,6),PR_NO C(10),IN_NO C(10))
FOR I=1 TO 8
    B04MTH='B042018'+PADL(ALLTRIM(STR(I)),2,'0')
    *B04MTH='B04201808'
    SELECT 0
    USE \\192.168.10.213\TKDATA\&B04MTH ALIAS B04
    SET ORDER TO 1


    SELECT * FROM B04 WHERE F06$'C8152C4032C4017' INTO CURSOR B04DN NOWAIT ORDER BY F01,F03
    SELECT B04DN.*,C03.F01,LEFT(C03.F14,10) FROM B04DN,C03 WHERE  C03.F02=B04DN.f07 INTO CURSOR B04DN1 NOWAIT  
    SELECT B04DN1.*,C04.F17 FROM B04DN1,C04 WHERE C04.f03+C04.f04=B04DN1.f07+B04DN1.f03 INTO CURSOR B04DN2 NOWAIT

    
    SELECT B04DN2
    GO TOP
    DO WHILE !EOF()
       SELECT DNTS
       APPEND BLANK
       REPLACE F01 WITH B04DN2.F01_A
       REPLACE F02 WITH CTOD('2018/'+PADL(ALLTRIM(STR(I)),2,'0')+'/'+B04DN2.F02)
       *REPLACE F02 WITH CTOD('2018/08/'+B04DN2.F02)
       REPLACE F03 WITH B04DN2.F03
       REPLACE F04 WITH B04DN2.F04
       REPLACE F06 WITH B04DN2.F06
       REPLACE F07 WITH B04DN2.F07
       REPLACE F14 WITH B04DN2.F14
       REPLACE F15 WITH B04DN2.F15
       REPLACE F16 WITH B04DN2.F16
       REPLACE F17 WITH B04DN2.F17_A
       REPLACE F20 WITH B04DN2.F20
       REPLACE F79 WITH B04DN2.F79
       REPLACE RC_DTE WITH B04DN2.F01_B
       REPLACE PO_NO WITH B04DN2.EXP_26
       REPLACE STCK_NO WITH B04DN2.F17_B
       PRICE=0
       SELECT C02
       SEEK 'C8152'+DNTS.F03 
       IF FOUND()
          DO WHILE F01+F03='C8152'+DNTS.F03 
             IF DNTS.RC_DTE>=C02.F02 &&AND DNTS.RC_DTE<=C02.F15
                SELECT DNTS
                REPLACE Q_DTE WITH C02.F02
                REPLACE UNIT_PRICE WITH C02.F07
                REPLACE PLS WITH UNIT_PRICE-DNTS.F15
                EXIT
             ENDIF
             SELECT C02
             SKIP
          ENDDO
       ELSE
      
       ENDIF
       SELECT D10
       SEEK DNTS.F79
       IF FOUND()
          DO WHILE F02=DNTS.F79
             IF DNTS.F02>D10.F03
                SELECT DNTS
                REPLACE PR_NO WITH D10.F01
                REPLACE IN_DTE WITH D10.F03
                REPLACE IN_NO WITH D10.F04
                SELECT P04
                SEEK DNTS.PR_NO+DNTS.F79
                IF FOUND()
                   SELECT DNTS
                   REPLACE IN_PRICE WITH P04.F05
                ENDIF
                EXIT
             ENDIF
             SELECT D10
             SKIP
          ENDDO
       ENDIF       
       SELECT B04DN2
       SKIP
    ENDDO

   SELECT B04
   USE
ENDFOR
SELECT DNTS
SELECT * FROM DNTS  NOWAIT  ORDER BY F01,F02 &&WHERE PLS<0
FILENAME='GUANBAU2018'
COPY TO D:\TOKUTSU-MIS\&FILENAME TYPE XL5
CLOSE ALL
