***程式名稱:移轉單
close all
clear 
PO_NO=''
TNRQTY=0
FLG=''
FCH=''
CHK=''
CHK_STR=''
FILTER_KEY=''
R=0
QTY=0
TQTY=0
AREA1='B06_1'
AREA2='B06'
HD1='B005 '
HD2='BE'
HD3='移轉單'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1      
B25='B25'+LEFT(DTOS(DATE()),6)    &&部門別月報表
IF !USED('&B25')
   SELE 0
   USE (B25) ALIA B25
ELSE
   SELE B25
ENDIF
SET ORDER TO 1      
B26='B26'+LEFT(DTOS(DATE()),6)   &&庫存異動記錄
IF !USED('&B26')
   SELE 0
   USE (B26) ALIA B26
ELSE
   SELE B26
ENDIF
SET ORDER TO 1      
B39='B39'+LEFT(DTOS(DATE()),6)   &&未過帳單據查詢檔
IF !USED('&B39')
   SELE 0
   USE (B39) ALIA B39
ELSE
   SELE B39
ENDIF
SET ORDER TO 1      
SELE A23
SET ORDER TO 1
SEEK LEFT(DTOS(DATE()),6)+'01'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'B06'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET FILTER TO F04='*' AND F01<>INT_190
SET ORDER TO 1     
CREATE CURSOR A14_1 (F01 C(5),F02 C(8),F13 C(1))
INDE ON F01 TAG A14_11
IF A02.F08='*'
   SELE F01,F02,F13 FROM A14 INTO CURSOR A14_2 ORDER BY F01 WHERE F04='*' AND F01<>INT_190
ELSE
   SELE F01,F02,F13 FROM A14 INTO CURSOR A14_2 ORDER BY F01 WHERE F04='*' AND F13='*' AND F01<>INT_190
ENDIF   
GO TOP
DO WHILE !EOF()
   SELE A14_1
   APPEND BLANK
   REPL F01 WITH A14_2.F01
   REPL F02 WITH A14_2.F02
   REPLACE F13 WITH A14_2.F13
   SELE A14_2
   SKIP
ENDDO   
SELE A14_2
USE 
SELE A14_1
SET ORDER TO 1     
IF !USED('C0Z')
   SELE 0
   USE C0Z 
ELSE
   SELE C0Z
ENDIF
SET ORDER TO 1
IF !USED('C00')
   SELE 0
   USE C00 INDE C00
ELSE
   SELE C00
ENDIF
SET ORDER TO C001
IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011   
IF !USED('C03')
   SELECT 0
   USE C03
ELSE
   SELECT C03
ENDIF
SET ORDER TO 1     
IF !USED('C04')
   SELECT 0
   USE C04
ELSE
   SELECT C04
ENDIF
SET ORDER TO C041         
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1
set filter to !EMPTY(F98) 

IF !USED('C05')
   SELE 0
   USE C05 INDE C05
ELSE
   SELE C05
ENDIF
SET ORDER TO C057  
SET FILTER TO !EMPTY(F15)  
IF !USED('B11')
   SELE 0
   USE B11 INDE B11
ELSE
   SELE B11
ENDIF
SET ORDER TO B111  
B06='B06'+LEFT(DTOS(DATE()),6)
B061='B061'+LEFT(DTOS(DATE()),6)
IF !USED('&B06')
   SELE 0
   USE (B06) ALIA B06
ELSE
   SELE B06
ENDIF
SET ORDER TO 1      
SET RELA TO F03 INTO B01
CREATE CURSOR B06_1;
(F01 C(10),F02 C(2),F05 C(5),F06 C(5),F07 C(1),F08 C(100),F10 C(5),F20 C(10),F22 C(2),F23 C(1),F24 C(1),F15 C(17),F90 C(17))
INDE ON F01 TAG B06_11
INDE ON F05 TAG B06_12
INDE ON F10 TAG B06_13
SELE F01,F02,F05,F06,F07,F08,F10,F20,F22,F23,F24,F15,F90 FROM B06 GROUP BY F01 ORDER BY F01 INTO CURSOR B06_2
SELE B06_2
GO TOP
DO WHILE !EOF()
   SELE B06_1
   APPEND BLANK
   REPL F01 WITH B06_2.F01
   REPL F02 WITH B06_2.F02
   REPL F05 WITH B06_2.F05
   REPL F06 WITH B06_2.F06
   REPL F07 WITH B06_2.F07
   REPL F08 WITH B06_2.F08
   REPL F10 WITH B06_2.F10
   REPL F20 WITH B06_2.F20
   REPL F22 WITH B06_2.F22
   REPL F23 WITH B06_2.F23
   REPL F24 WITH B06_2.F24
   REPL F15 WITH B06_2.F15
   REPL F90 WITH B06_2.F90
   SELE B06_2
   SKIP   
ENDDO
SELE B06_2
USE   
SELE B06_1
SET ORDER TO 1
SET RELA TO F05 INTO A14
SET RELATION TO F06 INTO C01 ADDI
SET RELA TO F10 INTO A14_1 ADDI
B06FORM=CREATEOBJECT("TKB06")
B06FORM.SHOW  
DEFINE CLASS TKB06 AS FORM
  CAPTION='B06.移轉單'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKB06'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=5,;            
      RECORDSOURCE='B06_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=4,;            
      RECORDSOURCE='B06',; 
      LINKMASTER='B06_1',;
      RELATIONALEXPR='F01',;
      childorder=B061,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*650          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.過帳',;
      NAME='ANS_BOTT'    
  ADD OBJECT VRT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;   
      TOOLTIPTEXT='將已過入庫存及帳款之資料轉回未過帳狀態!快速鍵->ALT+V',;      
      CAPTION='\<V.反過帳',;
      NAME='VRT_BOTT'             
  ADD OBJECT EXCEL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*73,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*65,;
      CAPTION='\<T.轉EXCEL',;
      NAME='EXCEL_BOTT'    
  ADD OBJECT INVOICE_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*140,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*70,;
      CAPTION='\<I.轉INVOICE',;
      NAME='INVOICE_BOTT'                          
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='移轉單號'          
     ENDWITH
	THIS.ADDOBJECT('LBLF06','LABEL')
	WITH THIS.LBLF06  
	     .VISIBLE=.T. &&INT_028
         .LEFT=INT_015*14
         .TOP=INT_015*38
	     .WIDTH=INT_015*50
         .CAPTION='使用對象'
    ENDWITH           
	THIS.ADDOBJECT('LBLF061','LABEL')
	WITH THIS.LBLF061  
	     .VISIBLE=.T. &&INT_028
         .LEFT=INT_015*115
         .TOP=INT_015*38
	     .AUTOSIZE=.T.
         .CAPTION=''
    ENDWITH               
     THIS.ADDOBJECT('LBLF05','LABEL')     
     WITH THIS.LBLF05
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*63
          .WIDTH=INT_015*50  
          .CAPTION='轉出部門'
     ENDWITH            
     THIS.ADDOBJECT('LBLF051','LABEL')     
     WITH THIS.LBLF051
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*63
          .AUTOSIZE=.T.
     ENDWITH                 
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='轉入部門'
     ENDWITH    
     THIS.ADDOBJECT('LBLF101','LABEL')
     WITH THIS.LBLF101
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*88
         .AUTOSIZE=.T. 
     ENDWITH    
     THIS.ADDOBJECT('LBLF20','LABEL')
     WITH THIS.LBLF20
         .VISIBLE=.F.
         .LEFT=INT_015*14
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .VISIBLE=.F.
         .CAPTION='發票號碼'
     ENDWITH         
      THIS.ADDOBJECT('LBLF221','LABEL')
     WITH THIS.LBLF221
         .VISIBLE=.T.
         .LEFT=INT_015*151
         .TOP=INT_015*113
         .AUTOSIZE=.T.
         .CAPTION='三聯式'
     ENDWITH          
     THIS.ADDOBJECT('LBLF231','LABEL')
     WITH THIS.LBLF231
         .VISIBLE=.T.
         .LEFT=INT_015*234
         .TOP=INT_015*113
         .AUTOSIZE=.T.
         .CAPTION='應稅'
     ENDWITH                        
     THIS.ADDOBJECT('LBLF241','LABEL')
     WITH THIS.LBLF241
         .VISIBLE=.T.
         .LEFT=INT_015*286
         .TOP=INT_015*113
         .AUTOSIZE=.T.
     ENDWITH       
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH    
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*13
         .WIDTH=INT_015*50
         .CAPTION='移轉日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='過  帳  碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF071','LABEL')
     WITH THIS.LBLF071
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF15','LABEL')
     WITH THIS.LBLF15
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF151','LABEL')
     WITH THIS.LBLF151
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*88
         .AUTOSIZE=.T.
     ENDWITH        

     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*9
          .WIDTH=INT_015*40
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH        
     THIS.ADDOBJECT('TXTF06','TXTF06')          
     WITH THIS.TXTF06
          .VISIBLE=.T. &&INT_028
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH             
     THIS.ADDOBJECT('TXTF05','TXTF05')          
     WITH THIS.TXTF05
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
     THIS.ADDOBJECT('TXTF10','TXTF10')          
     WITH THIS.TXTF10
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH                 
     THIS.ADDOBJECT('TXTF20','TXTF20')          
     WITH THIS.TXTF20
          .VISIBLE=.F.
          .LEFT=INT_015*64
          .TOP=INT_015*109
          .WIDTH=INT_015*85
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH     
     THIS.ADDOBJECT('INV_TYPE','INV_TYPE')     
     THIS.ADDOBJECT('TAX_TYPE','TAX_TYPE')           
     THIS.ADDOBJECT('CUS_TYPE','CUS_TYPE')                         
     THIS.ADDOBJECT('TXTF08','TEXTBOX')          
     WITH THIS.TXTF08
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*134
          .WIDTH=INT_015*300
          .HEIGHT=INT_015*25
          .MAXLENGTH=100
     ENDWITH      
              
  
     

  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF03','LABEL')
	WITH THIS.LBLF03  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*10
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF031','LABEL')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*320
	     .TOP=INT_015*10
	     .AUTOSIZE=.T.
	ENDWITH     
	THIS.ADDOBJECT('LBLF09','LABEL')
	WITH THIS.LBLF09  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*35
	     .WIDTH=INT_015*50
         .CAPTION='訂單號碼'
    ENDWITH  	
    THIS.ADDOBJECT('LBLF04','Label')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*60
         .WIDTH=INT_015*50
         .CAPTION='轉出數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF11','LABEL')    
    WITH THIS.LBLF11
         .VISIBLE=.T.           
         .LEFT=INT_015*328
         .TOP=INT_015*35
         .WIDTH=INT_015*50
         .CAPTION='幣        別'
    ENDWITH     
    THIS.ADDOBJECT('LBLF17','LABEL')    
    WITH THIS.LBLF17
         .VISIBLE=.T.           
         .LEFT=INT_015*328
         .TOP=INT_015*60
         .WIDTH=INT_015*50
         .CAPTION='匯        率'
    ENDWITH         
    THIS.ADDOBJECT('LBLF14','LABEL')      
    WITH THIS.LBLF14
         .VISIBLE=.T.       
         .LEFT=INT_015*328
         .TOP=INT_015*85
         .WIDTH=INT_015*50
         .CAPTION='單        價'
    ENDWITH     
    THIS.ADDOBJECT('LBLF141','LABEL')
    WITH THIS.LBLF141
         .VISIBLE=.T.           
         .LEFT=INT_015*328
         .TOP=INT_015*110
         .WIDTH=INT_015*50
         .CAPTION='金額小計'
    ENDWITH  
    THIS.ADDOBJECT('LBLF142','LABEL')    
    WITH THIS.LBLF142
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*110
         .AUTOSIZE=.T.
    ENDWITH             
    THIS.ADDOBJECT('LBLF79','LABEL')
    WITH THIS.LBLF79
         .VISIBLE=INT_029       
         .LEFT=INT_015*14
         .TOP=INT_015*110
         .WIDTH=INT_015*50
         .CAPTION='實際料號'
    ENDWITH             
    THIS.ADDOBJECT('LBLF13','Label')
    WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*135
         .WIDTH=INT_015*50
         .CAPTION='用        途'         
    ENDWITH         
    THIS.ADDOBJECT('LBLF15','LABEL')
    WITH THIS.LBLF15
        .VISIBLE=.T.           
        .LEFT=INT_015*14
        .TOP=INT_015*160
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF151','LABEL')
    WITH THIS.LBLF151
        .VISIBLE=.T.           
        .LEFT=INT_015*68
        .TOP=INT_015*160
        .AUTOSIZE=.T.
    ENDWITH    
	THIS.ADDOBJECT('TXTF03','TXTF03')
	WITH THIS.TXTF03      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*6
	     .WIDTH=INT_015*250
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF03'  
         .BACKCOLOR=RGB(255,255,100)
         .MOUSEPOINTER=99
         .MOUSEICON='BMPS\harrow.cur'   
	ENDWITH     
	THIS.ADDOBJECT('TXTF09','TXTF09')
	WITH THIS.TXTF09      
	     .LEFT=INT_015*65
	     .TOP=INT_015*31
	     .WIDTH=INT_015*80
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=10
	     .NAME='TXTF09'  
         .BACKCOLOR=RGB(255,255,100)
         .MOUSEPOINTER=99
         .MOUSEICON='BMPS\harrow.cur'   
	ENDWITH     	
	THIS.ADDOBJECT('TXTF04','TEXTBOX')
	WITH THIS.TXTF04
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*56
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999999.9999'
	     .NAME='TXTF04'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF11','TEXTBOX')
    WITH THIS.TXTF11
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*31
         .WIDTH=INT_015*49         
         .HEIGHT=INT_015*25
         .MAXLENGTH=4
         .NAME='TXTF11'                            
    ENDWITH         	
	THIS.ADDOBJECT('CRCY','CRCY')
    THIS.ADDOBJECT('TXTF17','TEXTBOX')
    WITH THIS.TXTF17
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*56
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='9999.999999'
         .NAME='TXTF17'                            
    ENDWITH     
    THIS.ADDOBJECT('TXTF14','TEXTBOX')
    WITH THIS.TXTF14
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*81
         .WIDTH=INT_015*120
         .HEIGHT=INT_015*25
         .INPUTMASK='999999999.999999'
         .NAME='TXTF14'                            
    ENDWITH         
    THIS.ADDOBJECT('TXTF79','TXTF79')
    WITH THIS.TXTF79
         .VISIBLE=INT_029        
         .LEFT=INT_015*65
         .TOP=INT_015*106
         .WIDTH=INT_015*261
         .HEIGHT=INT_015*25
         .MAXLENGTH=43
         .NAME='TXTF79'
    ENDWITH         
	THIS.ADDOBJECT('TXTF13','TEXTBOX')
	WITH THIS.TXTF13
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*131
	     .WIDTH=INT_015*300
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=100
	     .NAME='TXTF13'	    
	ENDWITH     	
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     SELE B06_1         
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B06_1.F07<>'2',RGB(255,0,0),'')","COLUMN")         
        THISFORM.GRID1.ENABLED=.T.      
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF                 
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.EXCEL_BOTT.ENABLED=.F.        
        THISFORM.INVOICE_BOTT.ENABLED=.F.                
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF151.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''            
        THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''         
        THISFORM.PAGEFRAME1.PAGE1.LBLF241.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.EXCEL_BOTT.ENABLED= IIF(A02.F10='*',.T.,.F.)      
        THISFORM.INVOICE_BOTT.ENABLED=IIF(A02.F12='*',.T.,.F.)          
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B06_1.F07<>'2' &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B06_1.F07<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B06_1.F07='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.) 
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE B06  
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF     
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B06.F07<>'2'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B06.F07<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B06.F07='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.) 
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. B06_1.F07<>'2' &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.
     THISFORM.EXCEL_BOTT.ENABLED=.F.       
     THISFORM.INVOICE_BOTT.ENABLED=.F.            
  ENDPROC     
  PROC INIT       
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')     
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')         
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER') 
       THISFORM.EXCEL_BOTT.ENABLED= IIF(A02.F10='*',.T.,.F.)      
       THISFORM.INVOICE_BOTT.ENABLED=IIF(A02.F12='*',.T.,.F.)      
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='移轉單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='轉出部門編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='轉出部門簡稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='轉入部門編號'
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='轉入部門簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B06_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B06_1.F05'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B06_1.F10'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B06_1.F07<>'2',RGB(255,0,0),'')","COLUMN")         
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'       
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION=IIF(INT_029,'實際料號','品名規格')
       THISFORM.grid2.COLUMN3.HEADER1.CAPTION='轉出數量'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='安全資料'
	   THISFORM.GRID2.LINKMASTER='B06_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B06.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B06.F79,B01.F02)"
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B06.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B06.F15'
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*135
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(B06.F03!=B06.F79,RGB(107,79,175),'')","COLUMN") 
       THISFORM.grid1.READONLY=.T.      
       THISFORM.grid2.READONLY=.T.            
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B06_1.F07<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B06_1.F07<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(B06_1.F07='2',.F.,.T.)  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
          THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.) 
       ENDIF          
*       THISFORM.KEY_LIST.DISPLAYVALUE='依移轉單號排列'      
       JK='移轉單號'
       SELE B06_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B06_1.F01
  ENDPROC               
  PROC KEY_LIST.INIT 
       with this 
           .additem('依移轉單號排列')
           .additem('依轉出部門排列')
           .additem('依轉入部門排列')
           .VALUE=1
       endwith             
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE B06_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依移轉單號排列'
               set order to 1 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='移轉單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B06_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='轉出部門編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B06_1.F05'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='轉出部門簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='轉入部門編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B06_1.F10'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49               
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='轉入部門簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80                                
          CASE THIS.DISPLAYVALUE='依轉出部門排列'
               set order to 2
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='轉出部門編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B06_1.F05'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='轉出部門簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='移轉單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B06_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81                                                   
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='轉入部門編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B06_1.F10'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='轉入部門簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58                 
          CASE THIS.DISPLAYVALUE='依轉入部門排列'
               set order to 3
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='轉入部門編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B06_1.F10'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='轉入部門簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14_1.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='移轉單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B06_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81               
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='轉出部門編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B06_1.F05'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49                  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='轉出部門簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80                                                            
       ENDCASE 
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.childorder=''
       SELECT A23
       SEEK DTOS(CTOD(THIS.DISPLAYVALUE+'/01'))

       SELE A24
       USE
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1             
       SELE B25
       USE
       B25='B25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B25')
          SELE 0
          USE (B25) ALIA B25
       ELSE
          SELE B25
       ENDIF
       SET ORDER TO 1                    
       SELE B26
       USE
       B26='B26'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B26')
          SELE 0
          USE (B26) ALIA B26
       ELSE
          SELE B26
       ENDIF
       SET ORDER TO 1                           
       SELE B39
       USE
       B39='B39'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B39')
          SELE 0
          USE (B39) ALIA B39
       ELSE
          SELE B39
       ENDIF
       SET ORDER TO 1                          
       SELE B06
       set rela off into b01
       SET RELA OFF INTO B06_1
       USE
       SELE B06_1
       SET RELATION OFF INTO C01
       SET RELA OFF INTO A14
       SET RELA OFF INTO A14_1
       USE
       B06='B06'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       B061='B061'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B06')
          SELE 0
          USE (B06) ALIA B06
       ELSE
          SELE B06
       ENDIF
       SET ORDER TO 1      
       SET RELA TO F03 INTO B01
       CREATE CURSOR B06_1;
       (F01 C(10),F02 C(2),F05 C(5),F06 C(5),F07 C(1),F08 C(100),F10 C(5),F20 C(10),F22 C(2),F23 C(1),F24 C(1),F15 C(17),F90 C(17))
       INDE ON F01 TAG B06_11
       INDE ON F05 TAG B06_12
       INDE ON F10 TAG B06_13
       SELE F01,F02,F05,F06,F07,F08,F10,F15,F20,F22,F23,F24,F90 FROM B06 GROUP BY F01 ORDER BY F01 INTO CURSOR B06_2
       SELE B06_2
       GO TOP
       DO WHILE !EOF()
          SELE B06_1
          APPEND BLANK
          REPL F01 WITH B06_2.F01
          REPL F02 WITH B06_2.F02
          REPL F05 WITH B06_2.F05
          REPL F06 WITH B06_2.F06
          REPL F08 WITH B06_2.F08
          REPL F07 WITH B06_2.F07
          REPL F10 WITH B06_2.F10
          REPL F20 WITH B06_2.F20
          REPL F22 WITH B06_2.F22
          REPL F23 WITH B06_2.F23
          REPL F24 WITH B06_2.F24
          REPL F15 WITH B06_2.F15
          REPL F90 WITH B06_2.F90
          SELE B06_2
          SKIP
       ENDDO
       SELE B06_2
       USE   
       SELE B06_1
       SET ORDER TO 1
       SET RELA TO F05 INTO A14
       SET RELATION TO F06 INTO C01 ADDI
       SET RELA TO F10 INTO A14_1 ADDI
       THISFORM.GRID1.RECORDSOURCE='B06_1'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B06_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B06_1.F05'       
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B06_1.F10'              
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
       THISFORM.GRID2.RECORDSOURCE='B06'
	   THISFORM.GRID2.LINKMASTER='B06_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=B061  
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B06.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B06.F79,B01.F02)"
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B06.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B06.F15'            
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   thisform.grid1.setfocus        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B06_1.F07<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B06_1.F07<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.ANS_BOTT.ENABLED=IIF(B06_1.F07='2',.F.,.T.)  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED     
          THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)           
       ENDIF          
*!*	       THISFORM.KEY_LIST.DISPLAYVALUE='依出貨單號排列'      
*!*	       JK='訂單編號'
*!*	       SELE B06_1
*!*	       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B06_1.F01	   
*       THISFORM.REFRESH       
  ENDPROC
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B06_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=B06_1.F08
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=B06_1.F05
       THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=B06_1.F06
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=C01.F04
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=B06_1.F10
       THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=B06_1.F20
       THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=A14_1.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=B06_1.F02
       THISFORM.PAGEFRAME1.PAGE1.lblf071.caption=B06_1.F07
       THISFORM.PAGEFRAME1.PAGE1.lblf151.caption=B06_1.F15
       THISFORM.PAGEFRAME1.PAGE1.lblf901.caption=B06_1.F90
       THISFORM.PAGEFRAME1.PAGE1.LBLF20.VISIBLE=!EMPTY(B06_1.F06)
       THISFORM.PAGEFRAME1.PAGE1.TXTF20.VISIBLE=!EMPTY(B06_1.F06)
       THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(B06_1.F22='31','三聯式',IIF(B06_1.F22='32','二聯式',''))
       THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=IIF(B06_1.F23='1','應稅',IIF(B06_1.F23='2','零稅',IIF(B06_1.F23='3','免稅','')))
       THISFORM.PAGEFRAME1.PAGE1.LBLF241.CAPTION=IIF(LEFT(B06_1.F24,1)='2','經海關',IIF(LEFT(B06_1.F24,1)='1','不經海關',''))
       THISFORM.PAGEFRAME1.PAGE2.LBLF09.VISIBLE=!EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
       THISFORM.PAGEFRAME1.PAGE2.TXTF09.VISIBLE=!EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B06_1.F07<>'2'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B06_1.F07<>'2' &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED=IIF(B06_1.F07='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED        
       THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)      
       THISFORM.VRT_BOTT.VISIBLE=IIF(B06_1.F07='2',.T.,.F.)
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=B06.F03
       THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=B06.F09
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=B06.F04     
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=B06.F13      
       THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=B06.F79
       thisform.paGeframe1.page2.LBLf11.visible=!EMPTY(b06.f20)
       thisform.paGeframe1.page2.LBLf14.visible=!EMPTY(b06.f20)
       thisform.paGeframe1.page2.LBLf17.visible=!EMPTY(b06.f20)       
       thisform.paGeframe1.page2.txtf11.visible=!EMPTY(b06.f20)
       thisform.paGeframe1.page2.txtf14.visible=!EMPTY(b06.f20)
       thisform.paGeframe1.page2.txtf17.visible=!EMPTY(b06.f20)
       thisform.paGeframe1.page2.LBLf141.visible=!EMPTY(b06.f20)       
       thisform.paGeframe1.page2.LBLf142.visible=!EMPTY(b06.f20)       
       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=B06.F11
       THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=B06.F17
       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=B06.F14    
       THISFORM.PAGEFRAME1.PAGE2.LBLF142.CAPTION=TRANSFORM(ROUND(B06.F04*B06.F14*B06.F17,INT_069),'@R 999999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=B06.F15
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=B06_1.F01
*       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       if thisform.pageframe1.activepage=1
          thisform.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       thisform.refresh
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.VRT_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
 
          HD='B005 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          DO ODR_CRT
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
 
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.F.        
        THISFORM.PAGEFRAME1.PAGE1.TXTF10.READONLY=.F.  
        THISFORM.PAGEFRAME1.PAGE1.LBLF20.VISIBLE=.F.   
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.VISIBLE=.F.   
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.T.  
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=''                
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=''
        IF INT_060=.F.      &&如果不帶入發票管理
             THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
             THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.             
             THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1
             THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1             
        ENDIF
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)
        THISFORM.PAGEFRAME1.PAGE1.LBLF151.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF241.CAPTION='' 
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''   
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.F.  
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''             
        THISFORM.PAGEFRAME1.PAGE2.lblF031.caption=''                  
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=INT_011
        THISFORM.PAGEFRAME1.PAGE2.CRCY.ENABLED=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.TXTF14.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.TXTF17.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.LBLF11.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.LBLF14.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.LBLF17.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.LBLF141.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.LBLF142.VISIBLE=!EMPTY(B06_1.F20)
        THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF142.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''             
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE  
     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.VRT_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE B06_1
        PO_NO=B06_1.F01
        SELE RECNO() FROM B06 WHERE B06.F01=PO_NO AND F07<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'B06')
           LL1=RLOCK(KK1,'B06')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE B06_1           
           UNLOCK ALL
           REPL F07 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF10.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.F.
           IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_060=.F.     &&如果有發票號碼或是預設不帶入發票管理
              THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
              THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(F22='31',1,2)
              THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.  
              THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=VAL(F23)
              IF F22='32' .AND. F23<>'1'
                 THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=IIF(F24='2',2,1)
                 THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
              ELSE
                  THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.  
              ENDIF
           ENDIF              
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
            
              THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
           
              THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
                        
        ELSE 
           DO file_impact
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        endif   
     ELSE                         
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
        SELE B06                                                      &&處理表身修改
        IF RLOCK('B06') 
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF79.READONLY=EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
           THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=!EMPTY(B06.F20)
           THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
           THISFORM.PAGEFRAME1.PAGE2.CRCY.ENABLED=!EMPTY(B06.F20)
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
        ELSE  
           DO file_impact 
           unlock all
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       endif        
     ENDIF   
     RELEASE ALL LIKE BK*
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          if ALIA()='B06_1'           &&刪除整張訂單
             SELE B06_1             
                PO_NO=B06_1.F01
                SELE RECNO() FROM B06 WHERE B06.F01=PO_NO  AND B06.F07<>'2' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'B06')
                   LL1=RLOCK(KK1,'B06')
                ELSE
                   LL1=.T.   
                ENDIF                   
                
                IF LL1=.T. AND RLOCK('B06_1')  
                   IF LEN(ALLTRIM(JJ1))>0 
                      SELECT B06
                      FOR I=1 TO ALEN(BK1)
                          IF LEN(ALLTRIM(B06.F09))=10  &&如果有訂單號碼
                             GO BK1(I) 
                             SELE C05
                             SET ORDER TO C056                   
                             SEEK B06.F09+B06.F03
                             IF FOUND()
                                QTY=B06.F04
                                DO WHILE F01+F02=B06.F09+B06.F03 
                                   IF F14=0
                                      SKIP
                                   ELSE
                                      IF QTY>F14
                                         QTY=QTY+F14*(-1)   
                                         REPL F14 WITH 0     
                                         SKIP
                                      ELSE
                                         REPL F14 WITH F14+QTY*(-1)
                                         EXIT
                                     ENDIF  
                                  ENDIF                    
                                ENDDO                                  
                             ENDIF                           
                          ENDIF    &&如果有訂單號碼判斷終      
                      ENDFOR                     
                   ENDIF
                   DELE FROM B06 WHERE B06.F01=PO_NO
                   SELE B39                     &&刪除未過帳單據紀錄
                   SEEK A02.F03+B06_1.F01                   
                   IF FOUND()
                      DELE
                   ENDIF   
                   SELE B06_1
                   DELE
                   UNLOCK ALL
                   IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      HD='B005 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      DO ODR_RJT
                   ENDIF  
                ELSE
                   DO file_impact                  
                ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
                THISFORM.VRT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B06_1.F07>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B06_1.F07<>'2' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(B06_1.F07='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED          
                THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)       
             ENDIF     
          ELSE        
              SELE B06                                                      &&刪除單筆資料  
              IF RLOCK('B06')       
                 IF LEN(ALLTRIM(B06.F09))=10
                    SELE C05
                    SET ORDER TO C056
                    SEEK B06.F09+B06.F03
                    IF FOUND()
                       QTY=B06.F04
                       DO WHILE C05.F01+C05.F02=B06.F09+B06.F03 
                          IF C05.F14=0
                             SKIP
                          ELSE
                             IF QTY>C05.F14
                                QTY=QTY+C05.F14*(-1)   
                                REPL C05.F14 WITH 0     
                                SKIP
                             ELSE
                                REPL C05.F14 WITH C05.F14+QTY*(-1)
                                EXIT
                             ENDIF  
                          ENDIF                    
                       ENDDO                                  
                    ENDIF                                 
                  ENDIF             
                  SELE B06
                  DELE
                  SKIP -1
                  IF BOF()
                     GO TOP
                  ENDIF   
              ELSE
                 DO file_impact                  
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                 SELE B39                           &&刪除未過帳單據紀錄       
                 SEEK A02.F03+B06_1.F01
                 IF FOUND()
                    DELE
                 ENDIF                    
                 SELE B06_1                        
                 PO_NO=B06_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      HD='B005 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      DO ODR_RJT    
                 ENDIF
                 SELE B06_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF
       RELEASE ALL LIKE BK*   
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='B06'
       THISFORM.GRID2.CHILDORDER=B061
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B06.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B06.F79,B01.F02)"
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B06.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B06.F15'       
       SELE B06_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'B06')=.T.   &&如果編號重複
             SELECT MAX(F01) FROM B06 INTO ARRAY GB NOWAIT
             HD='B005 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
             DO ODR_RPT
		      THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
		      THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH               
       ENDIF
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE) AND !SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01')
           =MESSAGEBOX('無此客戶編號,否則使用對象請保持空白!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
           SET ORDER TO &COD                      
           RETURN
       ENDIF           
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
          =MESSAGEBOX('轉出部門之部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE,'A14_1')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE)
          =MESSAGEBOX('轉入部門之部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF10.SETFOCUS
          SET ORDER TO &COD
          RETURN          
       ELSE
          IF A14_1.F13=' ' AND (!SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01') OR EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE))
             =MESSAGEBOX('轉入部門為不計成本倉別,必須有正確對象編號!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
             SET ORDER TO &COD
             RETURN                      
          ENDIF      
       ENDIF  
       
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE = THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
          =MESSAGEBOX('轉出部門不能與轉入部門相同,請重新輸入!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF10.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF  
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('移轉日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF   
       SELE B06_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE          
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE    
          IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_060=.F.     &&如果有發票號碼或預設不帶入發票管理
              REPLACE  F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'31','32')
              REPLACE  F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))
              REPLACE  F24 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.,'',IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2,'2','1'))
          ELSE 
             REPLACE  F22 WITH ''
             REPLACE  F23 WITH ''   
             REPLACE  F24 WITH ''
          ENDIF               
          REPLACE F15 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       SELE B39
       APPEND BLANK
       REPL F01 WITH A02.F03
       REPL F02 WITH B06_1.F01
       REPL F03 WITH B06_1.F02
       REPL F05 WITH B06_1.F05
       REPL F06 WITH IIF(SEEK(B06_1.F05,'A14'),A14.F02,'')
       REPL F07 WITH B06_1.F10
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01')
          THISFORM.PAGEFRAME1.PAGE2.LBLF09.VISIBLE=.T.
          THISFORM.PAGEFRAME1.PAGE2.TXTF09.VISIBLE=.T.
       ELSE
          THISFORM.PAGEFRAME1.PAGE2.LBLF09.VISIBLE=.F.
          THISFORM.PAGEFRAME1.PAGE2.TXTF09.VISIBLE=.F.          
       ENDIF
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE                       &&表身新增
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE,'B06')=.T.           
          =MESSAGEBOX('此筆資料在此張移轉單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN            
       ENDIF           
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)
          IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C05','C054')=.F.
             =MESSAGEBOX('出貨計劃無此筆紀錄!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
             RETURN
          ENDIF
          CALCULATE SUM(C05.F04-C05.F14) TO TRNQTY FOR C05.F01=THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE AND C05.F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE IN C05
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>TRNQTY
              =MESSAGEBOX('本訂單可移轉數量不得超過:'+ALLTRIM(STR(TRNQTY)),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=TRNQTY 
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN                
          ENDIF
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE<=0
          =MESSAGEBOX('數量不得小於等於0!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN          
       ENDIF              
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)
           SELE C05                 
           SET ORDER TO C054                                                          &&寫入出貨計劃
           SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
           IF FOUND()
              QTY=THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
              DO WHILE F01+F02=THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
                 IF F04-F14=0
                    SKIP
                 ELSE
                    IF QTY>F04-F14
                       QTY=QTY+(F04-F14)*(-1)   
                       REPL F14 WITH F04     
                       SKIP
                    ELSE
                       REPL F14 WITH F14+QTY
                       EXIT
                    ENDIF  
                 ENDIF                    
              ENDDO   
           ENDIF                
       ENDIF
       SELE B06       
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
          REPLACE F79 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
          REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
          REPLACE F17 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE          
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE          
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                                        
          REPLACE F22 WITH B06_1.F22
          REPLACE F23 WITH B06_1.F23
          REPLACE F24 WITH B06_1.F24
          REPLACE F15 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF
       UNLOCK ALL         
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
       THISFORM.GRID2.ENABLED=.T.
       THISFORM.GRID2.SETFOCUS  
       THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('移轉日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
        
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE) AND !SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01')
           =MESSAGEBOX('無此客戶編號,否則使用對象請保持空白!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
           RETURN
       ENDIF           
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
          =MESSAGEBOX('轉出部門之部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE,'A14_1')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE)
          =MESSAGEBOX('轉入部門之部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF10.SETFOCUS
          RETURN
       ELSE   
           IF A14_1.F13=' ' AND (!SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01') OR EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE))
             =MESSAGEBOX('無正確對象編號,轉入部門不得為不計成本倉別!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF10.SETFOCUS              
             RETURN                      
          ENDIF     
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE = THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
          =MESSAGEBOX('轉出部門不能與轉入部門相同,請重新輸入!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF10.SETFOCUS
          RETURN            
       ENDIF           
           SELE B06
           SEEK B06_1.F01
           IF FOUND()
              DO WHILE F01=B06_1.F01
                 IF F02<>PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
                    IF NOUME(F02)<>NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE) AND F11<>INT_011 AND !EMPTY(ALLTRIM(F11))
                       REPLACE F17 WITH IIF(SEEK(F11+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(F11,'C00'),C00.F02,1))                       
                    ENDIF
                    REPLACE  F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
                 ENDIF   
                 REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
                 REPL F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE                 
                 REPL F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
                 REPL F15 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                 
                 REPL F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
                 REPL F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                                  
                 IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_060=.F.   &&如果有發票號碼或預設不帶入發票管理
                    REPL F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'31','32')
                    REPL F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))  
                    REPL F24 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.,'',IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2,'2','1'))
                 ELSE
                    REPL F22 WITH ''
                    REPL F23 WITH ''    
                    REPL F24 WITH ''
                ENDIF
                 
                 SKIP
              ENDDO    
           ENDIF        
        SELE B06_1
           REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           REPL F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE           
           REPL F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
           REPL F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
           IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10   OR INT_060=.F.   &&如果有發票號碼或預設不帶入發票管理
              REPL F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'31','32')
              REPL F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))
              REPL F24 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.,'',IIF(THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2,'2','1'))
           ELSE
              REPL F22 WITH ''
              REPL F23 WITH ''   
              REPL F24 WITH ''
           ENDIF           
           REPL F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE           
           REPL F15 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           UNLOCK ALL
    
     ELSE                                                        &&表身修改確認     
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)
          CALCULATE SUM(C05.F04-C05.F14) TO TRNQTY FOR C05.F01=THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE AND C05.F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE IN C05
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>TRNQTY+B06.F04
              =MESSAGEBOX('本訂單可移轉數量不得超過:'+ALLTRIM(STR(TRNQTY+B06.F04)),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=TRNQTY+B06.F04 
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN                
          ENDIF
       ENDIF   

       IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE<=0
          =MESSAGEBOX('數量不得小於等於0!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN
       ENDIF                 
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE<>THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE   &&如果單上料號與實際料號不同再做料號正確與否判斷
          IF !SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE,'B01') 
              =MESSAGEBOX('物料主檔中無此編號請重新輸入或維持原料號!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF79.SETFOCUS
             RETURN      
*!*	          ELSE
*!*	             IF !USED('C22')
*!*	                SELECT 0
*!*	                USE C22
*!*	             ELSE
*!*	                SELECT C22
*!*	             ENDIF   
*!*	             SET ORDER TO C223
*!*	             IF SEEK(B06.F01,'C22')      
*!*	                =MESSAGEBOX('請先將此張移轉單轉入的INVOICE刪出後再修改料號!',0+48,'提示訊息視窗')
*!*	                THISFORM.PAGEFRAME1.PAGE2.TXTF79.SETFOCUS     
*!*	                RETURN
*!*	             ENDIF
          ENDIF
          
       ENDIF
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)  &&如果有訂單號碼
          SELE C05                 
          SET ORDER TO C056                                                          &&寫入出貨計劃
          SEEK B06.F09+B06.F03
          IF FOUND()
             QTY=B06.F04
             DO WHILE F01+F02=B06.F09+B06.F03 
                IF F14=0
                   SKIP
                ELSE
                   IF QTY>F14
                      QTY=QTY+F14*(-1)   
                      REPL F14 WITH 0     
                      SKIP
                   ELSE
                      REPL F14 WITH F14+QTY*(-1)
                      EXIT
                   ENDIF  
                ENDIF                    
             ENDDO   
          ENDIF                          
       ENDIF
       
           
       SELE B06                    
       REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE      
       REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE      
       REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
       REPLACE F17 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE
       REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE      
       REPLACE F79 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE  
       REPLACE F15 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')         
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)  &&如果有訂單號碼
          SELE C05                 
          SET ORDER TO C054                                                          &&寫入出貨計劃
          SEEK B06.F09+B06.F03
          IF FOUND()
             QTY=B06.F04
             DO WHILE F01+F02=B06.F09+B06.F03 
                IF F04-F14=0
                  SKIP
                ELSE
                   IF QTY>F04-F14
                      QTY=QTY+(F04-F14)*(-1)   
                      REPL F14 WITH F04     
                      SKIP
                   ELSE
                      REPL F14 WITH F14+QTY
                      EXIT
                   ENDIF  
                ENDIF                    
             ENDDO   
          ENDIF                        
       ENDIF
       SELECT B06             
       UNLOCK ALL
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX') 
      THISFORM.PAGEFRAME1.PAGE2.TXTF79.READONLY=.T. 
      THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.      
      THISFORM.PAGEFRAME1.PAGE1.TXTF10.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1  
          THISFORM.grid1.ENABLED=.T.
         THISFORM.grid2.ENABLED=.T. 
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
      ELSE

         THISFORM.grid1.ENABLED=.F.
         THISFORM.grid2.ENABLED=.T. 
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
              HD='B005 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
              DO ODR_RJT
               SELE B39
               SEEK A02.F03+B06_1.F01
               SET ORDER TO 1
               IF FOUND()
                   DELE            
               ENDIF   
               SELE B06_1
               DELE
               THISFORM.PAGEFRAME1.ACTIVEPAGE=1
               THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
      THISFORM.ANS_BOTT.ENABLED=IIF(B06_1.F07='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED         
      THISFORM.VRT_BOTT.ENABLED=IIF(B06_1.F07='2',.T.,.F.) .AND. IIF(A02.F09='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED  .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)      
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'B06'
            THISFORM.GRID2.RECORDSOURCE='B06'
            THISFORM.GRID2.CHILDORDER=B061
  	        THISFORM.grid2.COLUMN1.CONTROLSOURCE='B06.F03'
	        THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(INT_029,B06.F79,B01.F02)"
	        THISFORM.grid2.COLUMN3.CONTROLSOURCE='B06.F04'
	        THISFORM.grid2.COLUMN4.CONTROLSOURCE='B06.F15'         
	     ENDIF   
	     IF INT_099=.T.   
             HD='B005 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
             DO ODR_RJT
         ENDIF   
         SELE B06_1
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依移轉單號排列'
                 SET ORDER TO 1
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依轉出部門排列'
                 SET ORDER TO 2
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依轉入部門排列'
                 SET ORDER TO 3
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK     &&過帳程序
       if messagebox('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	 
          SELE RECNO() FROM B06 WHERE B06.F01=B06_1.F01  AND F07<>'2' INTO ARRAY BK1              
          JJ1=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK1)
                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
             ENDFOR    
             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
             RLOCK(KK1,'B06')
             LL1=RLOCK(KK1,'B06')
          ELSE
             LL1=.T.   
          ENDIF                   
          IF LL1=.T. 
             IF LEN(ALLTRIM(JJ1))>0 
                TQTY=0
                FTTL=0
                SELE B06
                FOR I= 1 TO ALEN(BK1)                      
                    GO BK1(I) 
                    TQTY=ROUND(TQTY+F04*F14*F17,INT_069)
                    FTTL=FTTL+ROUND(F04*F14,2)	&&外幣金額小計
                    SELE B11                                            &&部門庫存明細檔 
                    
                       SEEK B06.F05+B06.F79+SPACE(5)
                    
                    IF FOUND()
                       REPL F04 WITH F04+(B06.F04)*(-1)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                          ENDIF
                       ENDIF   
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F05
                       REPL F03 WITH B06.F79
                       REPL F04 WITH (B06.F04)*(-1)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                       
                    ENDIF   
                   
                       SEEK B06.F10+B06.F79+SPACE(5)
                     
                    IF FOUND()
                       REPL F04 WITH F04+B06.F04
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                          ENDIF   
                       ENDIF
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F10
                       REPL F03 WITH B06.F79
                       REPL F04 WITH B06.F04
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                                 
                    ENDIF                            
                    *******
                    SELE B25                                             &&分部門庫存月報表 
                    SEEK B06.F05+B06.F79
                    IF FOUND()                                                     &&轉出部門報表
                       REPL F09 WITH F09+B06.F04
                       REPL F15 WITH F15+(B06.F04)*(-1)
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F05
                       REPL F02 WITH B06.F79
                       REPL F09 WITH B06.F04
                       REPL F15 WITH (B06.F04)*(-1)                                                  
                    ENDIF   
                    SEEK B06.F10+B06.F79                &&轉入部門報表
                    IF FOUND()
                       REPL F08 WITH F08+B06.F04
                       REPL F15 WITH F15+B06.F04
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F10
                       REPL F02 WITH B06.F79
                       REPL F08 WITH B06.F04
                       REPL F15 WITH B06.F04                                                  
                    ENDIF                         
                    SELE B26                                            &&庫存異動紀錄
                    APPEND BLANK                                               &&轉出  
                    REPL F01 WITH B06.F79                
                    REPL F02 WITH B06.F05
                    REPL F03 WITH B06.F02
                    REPL F04 WITH B06.F04*(-1)
                    REPL F06 WITH 'E'
                    REPL F07 WITH B06.F01
                    REPL F08 WITH '移轉至'+B06.F10+IIF(SEEK(B06.F10,'A14_1'),A14_1.F02,'')
                    APPEND BLANK                                               &&轉入   
                    REPL F01 WITH B06.F79
                    REPL F02 WITH B06.F10
                    REPL F03 WITH B06.F02
                    REPL F04 WITH B06.F04
                    REPL F06 WITH 'E'
                    REPL F07 WITH B06.F01
                    REPL F08 WITH '從'+B06.F05+IIF(SEEK(B06.F05,'A14'),A14.F02,'')+'轉入'
                    SELE B06                         &&
                    REPL F07 WITH '2'
                    REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 ENDFOR   
                 CHK_NAME=B06.F15
*********************************************發票處理                 
                   IF LEN(ALLTRIM(B06_1.F20))=10  AND  INT_060=.T. &&如果有發票號碼且要帶入發票管理
                      K24='K24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                      IF !USED('&K24')
                         SELE 0
                         USE (K24) ALIA K24
                      ELSE
                         SELE K24
                      ENDIF
                      SET ORDER TO 1                                
                      K25='K25'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                      IF !USED('&K25')
                         SELE 0
                         USE (K25) ALIA K25
                      ELSE
                         SELE K25
                      ENDIF
                      SET ORDER TO 4                 
                       

                       SEEK B06_1.F22+B06_1.F20  &&先看有無重覆的發票號碼
                       IF !FOUND()
                           FLG=' '
                           APPEND BLANK
                           REPLACE  F01 WITH B06_1.F22
                           REPLACE  F07 WITH B06_1.F20                                &&發票號碼
                           IF B06_1.F02<=IIF(SEEK(B06_1.F06,'C01'),C01.F17,'')
                              REPLACE  F02 WITH B06.F02
                              REPLACE  F19 WITH THISFORM.MTH_LIST.DISPLAYVALUE 
                           ELSE
                              REPLACE  F02 WITH '01'
                              LON1=PADL(ALLTRIM(STR(VAL(RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2))+1)),2,'0')
                              LON2=IIF(LON1>'12',PADL(ALLTRIM(STR(VAL(RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,4))+1)),4,'0')+'/01',LEFT(THISFORM.MTH_LIST.DISPLAYVALUE,5)+LON1)
                              REPLACE F19 WITH LON2                          
                           ENDIF                                                                  
                           REPLACE  F03 WITH B06_1.F06                                &&客戶編號
*!*	                           REPLACE  F04 WITH IIF(SEEK(B06_1.F06,'C01'),C01.F10,'')      &&統一編號(二聯式不用印)
                           REPLACE  F05 WITH B06_1.F24                                &&是否經海關->' ' 不出口 '1'不經海關  '2'經海關 
                           REPLACE  F09 WITH B06_1.F23                                &&課稅別(1-應 2-零  3-免)      
                           REPLACE  F13 WITH '00'
                           REPLACE  F15 WITH B06_1.F01+IIF(B01.F97='Y','製品','商品')
                           REPLACE  F16 WITH '1'
                           REPLACE  F18 WITH '01'
                           REPLACE  F20 WITH ALLTRIM(B06_1.F08)
                           REPLACE  F21 WITH B06.F11
                           REPLACE  F22 WITH B06.F17
                       ELSE
                          FLG='1'   &&紀錄是否重覆發票
                       ENDIF    
    

                       
                                           
                       IF F01='31'                                            		     &&若為銷項三聯式. 電子計算機
                          REPLACE  F08 WITH F08+TQTY         			     &&銷售金額 >> 小計
                          REPLACE  F10 WITH ROUND(F08*INT_002/100,INT_069)*IIF(F09='1',1,0) &&營業稅額=ROUND(小計*採購訂單稅率,應收對帳單四捨五入)
                          REPLACE  F12 WITH F08+F10				     &&發票總額
                       ELSE
                          REPLACE  F12 WITH F12+TQTY
                          REPL F08 WITH ROUND(F12/IIF(F09='1',1+(INT_002/100),1),INT_069)
                          REPL F10 WITH F12-F08
                       ENDIF                                                                                               
                       REPLACE  F23 WITH F23+FTTL
                       REPLACE  F24 WITH ALLTRIM(CHK_NAME)
                       *******以類別分類
                       
                          SELE K24         &&發票明細檔表頭
                                       
                       SET ORDER TO 1	 && F01
                       SEEK B06_1.F22
                       IF FOUND()      
                           IF B06_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH F03+TQTY         												  &&銷售金額
                               REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0))      &&營業稅總額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0)))	&&發票總額	
                           ELSE
                               REPLACE F05 WITH F05+TQTY				 							               &&發票總額
                               REPLACE F03 WITH F03+ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069)       &&銷售金額
                               REPLACE F04 WITH F04+(TQTY-ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069))       &&營業總額
                           ENDIF               
                           IF FLG<>'1'  &&如果發票號碼未重覆
                              DO CASE
                                 CASE  B06_1.F23='1'
                          		       REPLACE F06 WITH F06+1    &&應稅張數
                          	     CASE  B06_1.F23='2'
                          	 	       REPLACE F07 WITH F07+1    &&零稅張數
                          	     CASE  B06_1.F23='3'	      
                          	  	       REPLACE F08 WITH F08+1   &&免稅張數
                              ENDCASE
                           ENDIF   		     
                       ELSE
                           APPEND BLANK 
                           REPLACE F01 WITH B06_1.F22
                           IF B06_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH TQTY         												&&銷售金額
                               REPLACE F04 WITH ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0)      &&營業總額
                               REPLACE F05 WITH F03+F04										&&發票總額
                           ELSE
                               REPLACE F05 WITH TQTY				 							               &&發票總額
                               REPLACE F03 WITH ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069)    &&銷售金額
                               REPLACE F04 WITH F05-F03                          							&&營業總額
                           ENDIF   
                           DO CASE
                                  CASE  B06_1.F23='1'
                          		      REPLACE F06 WITH 1   &&應稅張數
                          	  CASE  B06_1.F23='2'
                          	 	      REPLACE F07 WITH 1    &&零稅張數
                          	  CASE  B06_1.F23='3'	      
                          	  	      REPLACE F08 WITH 1   &&免稅張數
                           ENDCASE
                       ENDIF  
                        *********以對象編號分類
                        SET ORDER TO 2	&& F02
                        SEEK B06_1.F06
                        IF FOUND()      
                           IF B06_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH F03+TQTY         												&&銷售金額
                               REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0))      &&營業總額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0)))	&&發票總額	
                           ELSE
                               REPLACE F05 WITH F05+TQTY				 							               &&發票總額
                               REPLACE F03 WITH F03+ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069)    &&銷售金額
                               REPLACE F04 WITH F04+(TQTY-ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069))          &&營業總額
                           ENDIF                            
                           IF FLG<>'1'
                              DO CASE
                                 CASE  B06_1.F23='1'
                          		       REPLACE F06 WITH F06+1    &&應稅張數
                          	     CASE  B06_1.F23='2'
                          	 	       REPLACE F07 WITH F07+1    &&零稅張數
                          	     CASE  B06_1.F23='3'	      
                          	  	       REPLACE F08 WITH F08+1   &&免稅張數
                              ENDCASE
                           ENDIF   	
                        ELSE
                            APPEND BLANK 
                            REPLACE F02 WITH B06_1.F06
                            IF B06_1.F22='31'                                            &&若為三聯式發票
                                REPLACE F03 WITH TQTY         												&&銷售金額
                                REPLACE F04 WITH ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0)      &&營業總額
                                REPLACE F05 WITH F03+F04										&&發票總額
                            ELSE
                                REPLACE F05 WITH TQTY				 							               &&發票總額
                                REPLACE F03 WITH ROUND(TQTY/IIF(B06.F23='1',1+(INT_002/100),1),INT_069)    &&銷售金額
                                REPLACE F04 WITH F05-F03                          							&&營業總額
                            ENDIF   
                           DO CASE
                                  CASE  B06_1.F23='1'
                          		      REPLACE F06 WITH 1   &&應稅張數
                          	  CASE  B06_1.F23='2'
                          	 	      REPLACE F07 WITH 1    &&零稅張數
                          	  CASE  B06_1.F23='3'	      
                          	  	      REPLACE F08 WITH 1   &&免稅張數
                           ENDCASE
                        ENDIF                      
                       *****                
                       IF FLG='1'   &&若發票單號重覆
                          IF !USED('K2F')
                             SELECT 0
                             USE K2F
                          ELSE
                             SELECT K2F
                          ENDIF
                          SET ORDER TO 1
                          APPEND BLANK
                          REPLACE F01 WITH B06_1.F20
                          REPLACE F02 WITH B06_1.F01
                          REPLACE F03 WITH IIF(B01.F97='Y','B','A')
                          REPLACE F04 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+'01')
                          REPLACE F99 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                          SELECT K2F
                          USE                          
                       ENDIF
                       
                       FLG=' '             
                                        
                       SELECT K25
                       USE        
                       SELECT K24
                       USE                                                                      
                   ENDIF                    

***************************************                 
                 SELE B39                    &&未過帳庫存單據查詢檔
                 SEEK A02.F03+B06_1.F01
                  IF FOUND()
                     DELE
                  ENDIF                                             
                  SELE B06_1
                  REPL F07 WITH '2'
                  REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
             ELSE
                =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                SELE B06_1
                REPL F07 WITH '2'
             ENDIF           
             THIS.ENABLED=.F.
             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
             UNLOCK ALL
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
             ENDIF
             THISFORM.REFRESH
          ELSE
            DO file_impact
            unlock all
            return
          ENDIF   
          unlock all
         RELEASE ALL LIKE BK*
      ENDIF      
  ENDPROC
*****************************************  
************************************************反過帳
  PROC VRT_BOTT.CLICK     &&反過帳程序
       if messagebox('是否確定反過帳?',4+32+256,'請確認') = 6           
          SELE RECNO() FROM B06 WHERE B06.F01=B06_1.F01  AND F07='2' INTO ARRAY BK1              
          JJ1=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK1)
                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
             ENDFOR    
             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
             RLOCK(KK1,'B06')
             LL1=RLOCK(KK1,'B06')
          ELSE
             LL1=.T.   
          ENDIF                   
          IF LL1=.T. 
             IF LEN(ALLTRIM(JJ1))>0 
                TQTY=0
                FTTL=0
                SELE B06
                FOR I= 1 TO ALEN(BK1)                      
                    GO BK1(I) 
                    TQTY=ROUND(TQTY+F04*F14*F17,INT_069)
                    FTTL=FTTL+ROUND(F04*F14,2)	&&外幣金額小計
                    SELE B11                                            &&部門庫存明細檔 
                   
                    SEEK B06.F05+B06.F79+SPACE(5)
                   
                    IF FOUND()
                       REPL F04 WITH F04+(B06.F04)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                          ENDIF
                       ENDIF   
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F05
                       REPL F03 WITH B06.F79
                       REPL F04 WITH (B06.F04)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                       
                    ENDIF   
                   
                     SEEK B06.F10+B06.F79+SPACE(5)
                    
                    IF FOUND()
                       REPL F04 WITH F04+B06.F04*(-1)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))
                          ENDIF   
                       ENDIF
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F10
                       REPL F03 WITH B06.F79
                       REPL F04 WITH B06.F04*(-1)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06.F02))                                        
                    ENDIF                            
                    *******
                    SELE B25                                             &&分部門庫存月報表 
                    SEEK B06.F05+B06.F79
                    IF FOUND()                                                     &&轉出部門報表
                       REPL F09 WITH F09+B06.F04*(-1)
                       REPL F15 WITH F15+B06.F04
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F05
                       REPL F02 WITH B06.F79
                       REPL F09 WITH B06.F04*(-1)
                       REPL F15 WITH B06.F04                                             
                    ENDIF   
                    SEEK B06.F10+B06.F79                 &&轉入部門報表
                    IF FOUND()
                       REPL F08 WITH F08+B06.F04*(-1)
                       REPL F15 WITH F15+B06.F04*(-1)
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B06.F10
                       REPL F02 WITH B06.F79
                       REPL F08 WITH B06.F04*(-1)
                       REPL F15 WITH B06.F04*(-1)                                                  
                    ENDIF                         

                    SELE B06                         &&
                    REPL F07 WITH ''
                    REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 ENDFOR   
                 CHK_NAME=B06.F15
                 SELECT B26
                 DELETE FROM B26 WHERE F07=B06_1.F01
*********************************************發票處理                 
                   IF LEN(ALLTRIM(B06_1.F20))=10  AND  INT_060=.T. &&如果有發票號碼且要帶入發票管理
                      K24='K24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                      IF !USED('&K24')
                         SELE 0
                         USE (K24) ALIA K24
                      ELSE
                         SELE K24
                      ENDIF
                      SET ORDER TO 1                                
                      K25='K25'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                      IF !USED('&K25')
                         SELE 0
                         USE (K25) ALIA K25
                      ELSE
                         SELE K25
                      ENDIF
                      SELECT K25
                      SET ORDER TO 4                 
                       

                       SEEK B06_1.F22+B06_1.F20  &&先搜尋發票後刪除
                       IF FOUND()
                          IF K25.F16<>'2'  &&如果不是作廢才刪除
                             DELETE 
                          ENDIF    
                       ENDIF    
    

                       
                                           
     
                       *******以類別分類
                       
                          SELE K24         &&發票明細檔表頭
                                       
                       SET ORDER TO 1	 && F01
                       SEEK B06_1.F22
                       IF FOUND()      
                           IF B06_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH F03+TQTY*(-1)         												  &&銷售金額
                               REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0))*(-1)      &&營業稅總額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0)))*(-1)	&&發票總額	
                           ELSE
                               REPLACE F05 WITH F05+TQTY*(-1)				 							               &&發票總額
                               REPLACE F03 WITH F03+ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069)*(-1)       &&銷售金額
                               REPLACE F04 WITH F04+(TQTY-ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069))*(-1)       &&營業總額
                           ENDIF               
                          
                              DO CASE
                                 CASE  B06_1.F23='1'
                          		       REPLACE F06 WITH F06-1    &&應稅張數
                          	     CASE  B06_1.F23='2'
                          	 	       REPLACE F07 WITH F07-1    &&零稅張數
                          	     CASE  B06_1.F23='3'	      
                          	  	       REPLACE F08 WITH F08-1   &&免稅張數
                              ENDCASE
                                
                       ENDIF  
                        *********以對象編號分類
                        SET ORDER TO 2	&& F02
                        SEEK B06_1.F06
                        IF FOUND()      
                           IF B06_1.F22='31'                                            &&若為三聯式發票
                               REPLACE F03 WITH F03+TQTY*(-1)         												&&銷售金額
                               REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0))*(-1)      &&營業總額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_069)*IIF(B06_1.F23='1',1,0)))*(-1)	&&發票總額	
                           ELSE
                               REPLACE F05 WITH F05+TQTY*(-1)				 							               &&發票總額
                               REPLACE F03 WITH F03+ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069)*(-1)    &&銷售金額
                               REPLACE F04 WITH F04+(TQTY-ROUND(TQTY/IIF(B06_1.F23='1',1+(INT_002/100),1),INT_069))*(-1)          &&營業總額
                           ENDIF                            
                           
                              DO CASE
                                 CASE  B06_1.F23='1'
                          		       REPLACE F06 WITH F06-1    &&應稅張數
                          	     CASE  B06_1.F23='2'
                          	 	       REPLACE F07 WITH F07-1    &&零稅張數
                          	     CASE  B06_1.F23='3'	      
                          	  	       REPLACE F08 WITH F08-1   &&免稅張數
                              ENDCASE
                           
                        ENDIF                      
                       *****                
                      
                          IF !USED('K2F')
                             SELECT 0
                             USE K2F
                          ELSE
                             SELECT K2F
                          ENDIF
                          SET ORDER TO 1
                          SEEK B06_1.F20
                          IF FOUND()
                             DO WHILE F01=B06_1.F20
                               DELETE 
                               SKIP
                             ENDDO
                          ENDIF     
                          SELECT K2F
                          USE                                                                 
                       SELECT K25
                       USE        
                       SELECT K24
                       USE                                                                      
                   ENDIF                    

***************************************                 
                 SELE B39                    &&未過帳庫存單據查詢檔
                 SEEK A02.F03+B06_1.F01
                  IF !FOUND()
                     APPEND BLANK 
                     REPL F01 WITH A02.F03
                     REPL F02 WITH B06_1.F01
                     REPL F03 WITH B06_1.F02
                     REPL F05 WITH B06_1.F05
                     REPL F06 WITH IIF(SEEK(B06_1.F05,'A14'),A14.F02,'')
                     REPL F07 WITH B06_1.F10                     
                  ENDIF                                             
                  SELE B06_1
                  REPL F07 WITH ''
                  REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
             ELSE
                =MESSAGEBOX('此單據已由別的工作站反過帳完成',0+64,'提示訊息視窗')
                SELE B06_1
                REPL F07 WITH ''
             ENDIF           
             THIS.ENABLED=.F.
 
                      
             UNLOCK ALL
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
             ENDIF
             THISFORM.REFRESH
          ELSE
            DO file_impact
            unlock all
            return
          ENDIF   
          unlock all
         RELEASE ALL LIKE BK*
      ENDIF      
  ENDPROC

**************************************************  
PROC EXCEL_BOTT.CLICK
     LK=B06_1.F01       
     IF MESSAGEBOX('是否依包裝基量轉出資料?',4+32+256,'請確認')=6
        PCKORD=CREATEOBJECT("PCKORD")  
        PCKORD.SHOW         
        FILENAME=LK
     ELSE   
           SELECT B06.F01 移轉單號,B06.F02 日期,B06.F03 品號,B06.F04 數量,B06.F05 發料單位,B06.F10 領用單位,B06.F06 使用對象,B06.F08 備註說明,B06.F13 用途,B01.F37 成本單價 FROM B06,B01 WHERE B01.F01=B06.F03;
            INTO CURSOR B06_K ORDER BY B06.F01,B06.F02,B06.F03 NOWAIT
            FILENAME=LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)+'移轉單'
     ENDIF       
            IF _TALLY>0
	           
		       GCDELIMFILE=PUTFILE('儲存路徑',FILENAME,'XLS')
		       IF !EMPTY(GCDELIMFILE) 
		          ON ERROR DO FILE_IMPACT
		          COPY TO (GCDELIMFILE) TYPE XL5     
		          =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗') 
		       ENDIF     
            ELSE
                  =MESSAGEBOX('無已過帳單據資料!',0+48,'提示訊息視窗')
            ENDIF		  
     
        THISFORM.GRID1.SETFOCUS
 
  ENDPROC   
PROC INVOICE_BOTT.CLICK
     IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
        =MESSAGEBOX('對象不得空白!',0+48,'提示訊息視窗')
        RETURN
     ELSE
        IF !USED('C22')
           SELECT 0
           USE C22
        ELSE
           SELECT C22
        ENDIF
        SET ORDER TO C223
        IF SEEK(B06_1.F01,'C22')
           =MESSAGEBOX('此張移轉單已轉入INVOICE',0+48,'提示訊息視窗')
           SELECT C22
           USE
        ELSE        
           IF !USED('C20')
              SELECT 0
              USE C20
           ELSE
              SELECT C20
           ENDIF
           SET ORDER TO 1
           IF !USED('C02')
              SELECT 0
              USE C02
           ELSE
              SELECT C02
           ENDIF
           SET ORDER TO C023      

           IF !USED('C22')
              SELECT 0
              USE C22
           ELSE
              SELECT C22
           ENDIF
           SET ORDER TO 1 
           IF !USED('C23')
              SELECT 0
              USE C23
           ELSE
              SELECT C23
           ENDIF
           SET ORDER TO 1         
           HD='C022 '+SUBSTR(DTOS(DATE()),3,4)
           HD1='C022 '
           HD2='CD'
           HD3='INVOICE'
           DO ODR_CRT
           SELECT C22
           APPEND BLANK
           REPLACE F01 WITH PO_NO
           REPLACE F02 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B06_1.F02)
           REPLACE F03 WITH B06_1.F06
           REPLACE F04 WITH B06_1.F01
           REPLACE F05 WITH IIF(SEEK(B06_1.F06,'C01'),C01.F09,'')
           REPLACE F06 WITH IIF(SEEK(B06_1.F06,'C01'),C01.F08,'')
           REPLACE F07 WITH F02
           REPLACE F08 WITH IIF(SEEK(B06_1.F06,'C01'),C01.F24,'')
           REPLACE F09 WITH B06_1.F08
           REPLACE F13 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPLACE F17 WITH IIF(SEEK(B06_1.F06,'C01'),C01.F34,'')
           SELECT B06
           SEEK B06_1.F01
           IF FOUND()
              DO WHILE B06.F01=B06_1.F01
                 SELECT C23
                 APPEND BLANK
                 REPLACE F01 WITH PO_NO
                 REPLACE F02 WITH B06.F03
                 REPLACE F03 WITH B06.F04
                 REPLACE F04 WITH B06.F14 &&IIF(SEEK(B06.F09+B06.F03,'C04'),C04.F07,IIF(SEEK(B06_1.F06+B06.F03,'C02','C023'),C02.F07,0))
                 REPLACE F05 WITH IIF(SEEK(B06.F09+B06.F03,'C04'),C04.F17,IIF(SEEK(B06_1.F06+B06.F03,'C02','C023'),C02.F04,''))
                 REPLACE F06 WITH IIF(SEEK(B06.F06+B06.F09+B06.F03,'C05','C057'),C05.F09,'')
                 REPLACE F07 WITH B06.F11 &&IIF(SEEK(B06.F09+B06.F03,'C04'),C04.F06,IIF(SEEK(B06_1.F06+B06.F03,'C02'),C02.F06,INT_011))
                 REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 REPLACE F09 WITH IIF(SEEK(B06.F09+B06.F03,'C04'),C04.F25,IIF(SEEK(B06.F03,'B01'),B01.F02,''))
                 REPLACE F13 WITH IIF(SEEK(B06.F03,'C20'),C20.F04,'')
                 REPLACE F79 WITH B06.F79
                 SELECT B06
                 SKIP
              ENDDO
           ENDIF

           =MESSAGEBOX('已轉入INVOICE 號碼為:'+PO_NO,0+48,'提示訊息視窗')
           HD1='B005 '
           HD2='BE'
           HD3='移轉單'
           SELECT C20
           USE
           SELECT C02
           USE 
           SELECT C22
           USE 
           SELECT C23 
           USE        
        ENDIF   
     ENDIF          	
       THISFORM.GRID1.SETFOCUS
  ENDPROC     
enddefine    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=B06_1.F01     
     HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3))
     FRMDPT=IIF(SEEK(B06_1.F05,'A14'),A14.F02,'')
     TODDPT=IIF(SEEK(B06_1.F10,'A14'),A14_1.F02,'')
     IF EMPTY(B06_1.F20)
        SELECT B06.F01,;
               B06.F02,;
               B06.F03,;
               B06.F04,;                    
               B06.F05,;
               B06.F06,;
               B06.F08,;
               B06.F10,;
               B06.F13,;
               B01.F02;            
        FROM B06,B01 WHERE B06.F01=LK AND B01.F01=B06.F03 ORDER BY B06.F03 NOWAIT
        IF _tally >0
*           REPORT FORM ALLTRIM(INT_116)+'B06' PREVIEW
            REPORT FORM ALLTRIM(INT_116)+'B06' TO PRINT PROMPT 
        ENDIF
     ELSE
        SELE B06
        CALC SUM(ROUND(F04*F14*F17,INT_069)) FOR F01=LK TO TMP1
        SELECT B06.F01,;
               B06.F02,;
               B06.F03,;
               B06.F04,;
               B06.F05,;
               B06.F06,;
               B06.F08,;
               B06.F09,;
               B06.F10,;
               B06.F11,;
               B06.F14,;
               B06.F17,;
               B06.F20,;
               B06.F79,;
               C01.F04,;
               C01.F07,;
               C01.F12,;
               C01.F13,;
               C01.F32,;
               C01.F41,;
               C01.F42,;
               C03.F14,;
               C04.F17,;             
               B01.F02,;
               B01.F99;
         FROM B06,C01,C04,C03,B01 WHERE B06.F01=LK AND C01.F01=B06.F06 AND C04.F03+C04.F04=B06.F09+B06.F03 AND C03.F02=B06.F09 AND B01.F01=B06.F79 ORDER BY B06.F03 INTO CURSOR INV_DB NOWAIT
         IF INT_INV    &&如果使用電子計算機發票
            PNT_CHOOSE=CREATEOBJECT("PNT_CHOOSE")  
            PNT_CHOOSE.SHOW    
         ELSE
            IF _TALLY >0
*                 REPORT FORM ALLTRIM(INT_116)+'B06A' PREVIEW         
	                     REPORT FORM ALLTRIM(INT_116)+'B06A' TO PRINT PROMPT 
                     SELECT INV_DB
                     USE                           
            ENDIF     
         ENDIF            
     ENDIF     
     
ENDPROC
*************************************************列印選擇
DEFINE CLASS PNT_CHOOSE AS FORM
       AUTOCENTER=.T.
   CAPTION='請選擇欲列印之報表'
   TOP=INT_015*180
   LEFT=INT_015*220          
   FONTSIZE=INT_015*9
   HEIGHT=INT_015*170
   WIDTH=INT_015*250
   FONTSIZE=INT_015*9
   MOVABLE=.F.
   MAXBUTTON=.F.
   MINBUTTON=.F.      
   CONTROLBOX=.F.
   BORDERSTYLE=2
   SHOWTIPS=.T.
   SHOWWINDOW=1
   WINDOWTYPE=1
   NAME='PNT_CHOOSE'

  ADD OBJECT PNT_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*60,;
      TOP=INT_015*10,;
      HEIGHT=INT_015*80,;    
      WIDTH=INT_015*120,;      
      BUTTONCOUNT=3,;
      OPTION1.CAPTION='只印送貨單',;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.LEFT=INT_015*4,;
      OPTION1.TOP=INT_015*3,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='只印備料單',;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.LEFT=INT_015*4,;
      OPTION2.TOP=INT_015*28,;
      OPTION2.AUTOSIZE=.T.,;      
      OPTION3.CAPTION='全部',;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.LEFT=INT_015*4,;
      OPTION3.TOP=INT_015*53,;
      OPTION3.AUTOSIZE=.T.,;      
      NAME='PNT_OPTION'
   ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
       LEFT=INT_015*60,;    
       HEIGHT=INT_015*25,;   
       TOP=INT_015*140,;  
       WIDTH=INT_015*50,;
       CAPTION='\<Y.執  行',;
       TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
       NAME='CMND1'
   ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
       LEFT=INT_015*130,;
       TOP=INT_015*140,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*50,;
       CAPTION='\<C.取  消',;
       TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
       NAME='CMND2'   
   PROCEDURE INIT       
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON') 
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.CUR','COMMANDBUTTON')                               
      THISFORM.PNT_OPTION.VALUE=1                
      IF !EMPTY(B06_1.F20) AND B06_1.F01<>B06_1.F20
         THISFORM.PNT_OPTION.OPTION2.FONTSTRIKETHRU=.F.
         THISFORM.PNT_OPTION.OPTION3.FONTSTRIKETHRU=.F.
         THISFORM.PNT_OPTION.ENABLED=.T.               
      ELSE
         THISFORM.PNT_OPTION.OPTION2.FONTSTRIKETHRU=.T.
         THISFORM.PNT_OPTION.OPTION3.FONTSTRIKETHRU=.T.
         THISFORM.PNT_OPTION.ENABLED=.F.
      ENDIF
   ENDPROC             
   PROCEDURE CMND1.CLICK
            IF _TALLY >0
                  IF THISFORM.PNT_OPTION.VALUE<>2
*                 REPORT FORM ALLTRIM(INT_116)+'B06A' PREVIEW         
	                     REPORT FORM ALLTRIM(INT_116)+'B06A' TO PRINT PROMPT 
                   ENDIF
                   IF THISFORM.PNT_OPTION.VALUE<>1   &&員列印發票改為列印備料單
                      IF!USED('C20')
                         SELECT 0
                         USE C20
                      ELSE
                         SELECT C20
                      ENDIF     
                      SET ORDER TO 1
                      SELECT INV_DB
                      REPORT FORM ALLTRIM(INT_116)+'B06B' TO PRINT PROMPT
                      SELECT C20
                      USE  
*!*	                      SELECT INV_DB     &&此行開始列印發票
*!*	                      GO TOP                      
*!*	                      IF INV_DB.F11=INT_011 OR SEEK(INV_DB.F11+DTOS(CTOD(HK+'/'+NOUME(INV_DB.F02_A))),'C0Z')
*!*	                         IF _tally<6
*!*	                            FLG='0'
*!*	                         ELSE
*!*	                             FLG='1'
*!*	                             SELECT * FROM INV_DB GROUP BY F01 NOWAIT
*!*	                         ENDIF   
*!*	*                         REPORT FORM ALLTRIM(INT_116)+'INV_B' PREVIEW               
*!*	                               REPORT FORM ALLTRIM(INT_116)+'INV_B' TO PRINT 
*!*	                         FLG='0'                                       
*!*	                      ELSE         
*!*	                         =MESSAGEBOX('出貨日期所屬的匯率尚未設定!也就是說本張送貨單的匯率可能不正確,請通知財務部門設定本旬匯率後再列印發票',0+48,'提示訊息視窗')      
*!*	                      ENDIF                                           
                  ENDIF          
            ENDIF  
            SELECT INV_DB
            USE            
            THISFORM.CMND2.CLICK
   ENDPROC
   PROCEDURE CMND2.CLICK               
       THISFORM.RELEASE        
   ENDPROC         
ENDDEFINE

************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
    IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)=.T.

             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   

       IF _TALLY>0
          MTR_SEEK=createobject("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.VALUE=FLG
	      THIS.REFRESH
	      FLG='' 
          THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')      
       ENDIF
    ELSE   
        SELECT C05.F02,SUM(C05.F04) FROM C05 WHERE  C05.F06 = THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND !EMPTY(C05.F15) AND C05.F04>C05.F14 AND C05.F02 NOT IN(SELECT F03 FROM B06 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE) GROUP BY C05.F02 ORDER BY C05.F02 INTO CURSOR OQT 
        IF _TALLY > 0
           OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
           OQT_SEEK.SHOW  
           THIS.VALUE=FLG
	       THIS.REFRESH
	       FLG='' 
           THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')      
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=QTY        
           QTY=0
      	ELSE     

             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
        		            
		   IF _TALLY>0
		      MTR_SEEK=createobject("MTR_SEEK")  
		      MTR_SEEK.SHOW    
              THIS.VALUE=FLG
              THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THIS.VALUE
	          THIS.REFRESH
	          FLG='' 
              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')   
              
		   ENDIF             
        ENDIF 
     ENDIF

  ENDPROC        
  PROCEDURE INTERACTIVECHANGE         
        IF AT('?',ALLTRIM(THIS.VALUE))<>0  
           IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE)       
		      IF AT('?',ALLTRIM(THIS.VALUE))>1          
		         SELECT F02,SUM(F04) FROM C05 INTO CURSOR OQT ORDER BY F02  WHERE C05.F06 = THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND !EMPTY(C05.F15) AND C05.F04>C05.F14 AND C05.F02 NOT IN(SELECT F03 FROM B06 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)  AND LEFT(C05.F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)  GROUP BY C05.F02
		      ELSE
		         SELECT F02,SUM(F04) FROM C05 INTO CURSOR OQT ORDER BY F02  WHERE C05.F06 = THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND !EMPTY(C05.F15) AND C05.F04>C05.F14 AND C05.F02 NOT IN(SELECT F03 FROM B06 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE) GROUP BY C05.F02 
		      ENDIF        	     
		      IF _TALLY > 0
                 OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                 OQT_SEEK.SHOW              
                    THIS.VALUE=FLG
                    &&THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=FLG
		            THIS.REFRESH
		            FLG='' 
                    THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')    		            

                 THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=QTY               
                 QTY=0              
		      ELSE    
		         IF AT('?',ALLTRIM(THIS.VALUE))>1 
			        SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
		         ELSE
		            SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
		         ENDIF        
		         IF _TALLY>0
		            MTR_SEEK=createobject("MTR_SEEK")  
		            MTR_SEEK.SHOW    
		            THIS.VALUE=FLG
		            &&THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=FLG
		            THIS.REFRESH
		            FLG='' 
                    THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')    		            

		         ENDIF
      	      ENDIF      	     
      	   ELSE        
      	    
		         IF AT('?',ALLTRIM(THIS.VALUE))>1 AND AT('?',ALLTRIM(THIS.VALUE))>1    
			        SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
		         ELSE
		            SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
		         ENDIF        
		         IF _TALLY>0
		            MTR_SEEK=createobject("MTR_SEEK")  
		            MTR_SEEK.SHOW    
                    THIS.VALUE=FLG
                    &&THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=FLG
		            THIS.REFRESH
		            FLG='' 
                    THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')    		            
		         ENDIF             
           
           ENDIF           
        ENDIF        
        THISFORM.PAGEFRAME1.PAGE2.TXTF79.VALUE=THIS.VALUE
   ENDPROC  
   
 
ENDDEFINE
***************************************出貨計劃
DEFINE CLASS OQT_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='C05.出貨計劃'
  TOP=INT_015*110
  LEFT=INT_015*25    
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*325
  WIDTH=INT_015*370
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OQT_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      WIDTH=INT_015*370,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=2,;       
      RECORDSOURCE='OQT',;     
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'    
     
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*30,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*120,;
      TOP=INT_015*297,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
   PROCEDURE INIT 
         SELECT OQT
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')   
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN') 
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')

         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料        號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*260
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OQT.F02'               
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='訂單總數量'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.SUM_F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80      


         THISFORM.GRID1.SETFOCUS
      ENDPROC
       PROCEDURE  GRID1.AFTERROWCOLCHANGE
             LPARAMETERS NCOLINDEX
             FLG=OQT.F02
       ENDPROC 
       PROCEDURE CMND1.CLICK      
               FLG=OQT.F02                       
               QTY=OQT.SUM_F04
               THISFORM.RELEASE                
       ENDPROC
       PROCEDURE CMND2.CLICK
                FLG=''   
               THISFORM.RELEASE      
ENDDEFINE  
************************************訂單號碼
DEFINE CLASS TXTF09 AS TEXTBOX
       FONTSIZE=INT_015*9
       MAXLENGTH=10
       READONLY=.T.
       PROCEDURE DBLCLICK
         SELECT C05.F01,C05.F09,C04.F17 FROM C05,C04 INTO CURSOR ODR GROUP BY C05.F01;
         ORDER BY C05.F01 WHERE C05.F06=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND C05.F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE AND C04.F03+C04.F04=C05.F01+C05.F02 AND !EMPTY(C05.F15) AND C05.F04>C05.F14 NOWAIT
         IF _TALLY>0
             ODR_SEEK=CREATEOBJECT('ODR_SEEK')
             ODR_SEEK.SHOW
             THIS.Value=FLG
             THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04','C041'),C04.F06,INT_011)
             THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
             THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04','C041'),C04.F07,0)
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04','C041'),C04.F10,0)
             THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'C00'),C00.F02,1))
             FLG=''            
         ENDIF
       ENDPROC
       PROCEDURE INTERACTIVECHANGE
          IF AT('?',ALLTRIM(THIS.VALUE))<>0  AND !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE)                                        
                IF AT('?',ALLTRIM(THIS.VALUE))>1          
                     SELECT C05.F01,C05.F09,C04.F17 FROM C05,C04 INTO CURSOR ODR GROUP BY C05.F01;
                     ORDER BY C05.F01 WHERE C05.F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE; 
                     AND C04.F03+C04.F04=C05.F01+C05.F02 AND LEFT(C05.F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND !EMPTY(C05.F15) AND C05.F04>C05.F14 NOWAIT         
                ELSE 
                    SELECT C05.F01,C05.F09,C04.F17 FROM C05,C04 INTO CURSOR ODR GROUP BY C05.F01;
                     ORDER BY C05.F01 WHERE C05.F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE; 
                     AND !EMPTY(C05.F15) AND C05.F04>C05.F14 NOWAIT  
                ENDIF
             IF _TALLY>0
                ODR_SEEK=CREATEOBJECT('ODR_SEEK')
                ODR_SEEK.SHOW
                THIS.Value=FLG
                THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04','C041'),C04.F06,INT_011)
                THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
                THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04','C041'),C04.F07,0)
                THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C04','C041'),C04.F10,0)
                THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE,'C00'),C00.F02,1))
                FLG=''
             ENDIF
          ENDIF  
          
       ENDPROC
ENDDEFINE
*****************
********************************出貨計劃訂單搜尋畫面
DEFINE CLASS ODR_SEEK AS FORM
       AUTOCENTER=.T.
       CAPTION='訂單搜尋'
       TOP=INT_015*150
       LEFT=INT_015*300     
       FONTSIZE=INT_015*9
       HEIGHT=INT_015*250
       WIDTH=INT_015*320
       FONTSIZE=INT_015*9
       MAXBUTTON=.F.
       MINBUTTON=.F.    
       CLOSABLE=.F.
       CONTROLBOX=.F.
       BORDERSTYLE=2
       SHOWTIPS=.T.
       SHOWWINDOW=1
       WINDOWTYPE=1
       NAME='ODR_SEEK'
       ADD OBJECT GRDC05 AS GRID WITH;          
       AUTOCENTER=.T.,;
       TOP=0,;
       WIDTH=INT_015*320,;      
       HEIGHT=INT_015*220,;      
       ROWHEIGHT=INT_015*18,;
       HEADERHEIGHT=INT_015*19,;
       ALLOWCELLSELECTION=.F.,;
       DELETEMARK=.F.,;
       READONLY=.T.,;
       RECORDSOURCETYPE=1,;
       COLUMNCOUNT=3,;            
       RECORDSOURCE='ODR',;      
       NAME='GRDC05',;
       COLUMN1.NAME='COLUMN1',;
       COLUMN2.NAME='COLUMN2',;      
       COLUMN3.NAME='COLUMN3'        
       ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
           AUTOSIZE=.T.,;
           LEFT=INT_015*15,;    
           HEIGHT=INT_015*25,;   
           FONTSIZE=INT_015*9,;
           TOP=INT_015*223,;  
           WIDTH=INT_015*80,;
           MOUSEPOINTER=99,;
           MOUSEICON='BMPS\HARROW.CUR',;        
           CAPTION='\<S.選取',;
           TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
           NAME='CMND1'
       ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
           AUTOSIZE=.T.,;
           LEFT=INT_015*90,;
           TOP=INT_015*223,;
           HEIGHT=INT_015*25,;
           WIDTH=INT_015*80,;
           FONTSIZE=INT_015*9,;      
           MOUSEPOINTER=99,;
           MOUSEICON='BMPS\HARROW.CUR',;  
           CAPTION='\<C.取消',;
           TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
           NAME='CMND2'
       PROCEDURE INIT 
              THISFORM.SETALL('MOVABLE',.F.,'COLUMN')
              THISFORM.GRDC05.SETALL('FONTSIZE',INT_015*9,'COLUMN')
              THISFORM.GRDC05.SETALL('FONTSIZE',INT_015*9,'HEADER') 
              THISFORM.GRDC05.COLUMN1.HEADER1.CAPTION='訂單號碼'
              THISFORM.GRDC05.COLUMN1.WIDTH=INT_015*80
              THISFORM.GRDC05.COLUMN1.CONTROLSOURCE='ODR.F01'
              THISFORM.GRDC05.COLUMN2.HEADER1.CAPTION='客戶單號'
              THISFORM.GRDC05.COLUMN2.WIDTH=INT_015*80
              THISFORM.GRDC05.COLUMN2.CONTROLSOURCE='ODR.F09'
              THISFORM.GRDC05.COLUMN3.HEADER1.CAPTION='客戶料號'
              THISFORM.GRDC05.COLUMN3.WIDTH=INT_015*120
              THISFORM.GRDC05.COLUMN3.CONTROLSOURCE='ODR.F17'              
              THISFORM.GRDC05.SETFOCUS
              IF THISFORM.GRDC05.ACTIVEROW<>0
                 THISFORM.GRDC05.AFTERROWCOLCHANGE 
              ENDIF     
       ENDPROC
       PROCEDURE  GRDC05.AFTERROWCOLCHANGE
             LPARAMETERS NCOLINDEX
             FLG=ODR.F01
       ENDPROC 
       PROCEDURE CMND1.CLICK      
               FLG=ODR.F01                         
               THISFORM.RELEASE                
       ENDPROC
       PROCEDURE CMND2.CLICK
                FLG=''   
               THISFORM.RELEASE
       ENDPROC      
ENDDEFINE            
****************************************************  &&實際料號
DEFINE CLASS TXTF79 AS TEXTBOX
      READONLY=.T.
      MAXLENGTH=43
  FONTSIZE=INT_015*9
       PROCEDURE INTERACTIVECHANGE     
       IF AT('?',ALLTRIM(THIS.VALUE))<>0
          IF AT('?',ALLTRIM(THIS.VALUE))>1             
             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
          ELSE
             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
          ENDIF        
          IF _TALLY>0
             MTR_SEEK=createobject("MTR_SEEK")  
             MTR_SEEK.SHOW    
             
                THIS.VALUE=FLG
                THIS.REFRESH  
                FLG='0'   
                          
          ENDIF                                     
       ENDIF       
   ENDPROC  
ENDDEFINE   
***************************************************特殊欄位------------------轉出部門
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)  AND F04='*' AND F01<>INT_190
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE  F04='*' AND F01<>INT_190
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=createobject("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG=' '
       ENDIF   
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')         
  ENDPROC
ENDDEFINE  

*************************************************特殊欄位------------------轉入部門
DEFINE CLASS TXTF10 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14_1 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) 
       ELSE
          SELECT F01,F02 FROM A14_1 INTO CURSOR DEPART ORDER BY F01 
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=createobject("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG=' '
       ENDIF   
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=IIF(SEEK(THIS.VALUE,'A14_1'),A14_1.F02,'')         
  ENDPROC
ENDDEFINE  

***************************************************特殊輸入欄位設定-----------客戶
DEFINE CLASS TXTF06 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9       
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG=' '        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG=' '        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=!SEEK(THIS.VALUE,'C01')  
       THISFORM.PAGEFRAME1.PAGE1.TXTF20.VISIBLE=SEEK(THIS.VALUE,'C01')  
       THISFORM.PAGEFRAME1.PAGE1.LBLF20.VISIBLE=SEEK(THIS.VALUE,'C01')  
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F04,'')  
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=IIF(SEEK(THIS.VALUE,'C01'),C01.F32,'')               
       IF INT_150  &&如果預設出口不開發票
          IF IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)=2 AND IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)=2
               THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE='69'+RIGHT(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,8)
               THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)
               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THIS.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1) 
               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2
               THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
          ENDIF 
       ENDIF
  ENDPROC
ENDDEFINE
*********************
******************************************************************特殊欄位設定--發票號碼
DEFINE CLASS TXTF20 AS TEXTBOX
       READONLY=.T.
       MAXLENGTH=10
       FONTSIZE=INT_015*9
*!*	       PROCEDURE DBLCLICK
*!*	          ODM=VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))%2
*!*	          MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))+ODM-1))          
*!*	          K37='K37'+MMT
*!*	          IF FILE(K37+'.DBF')  &&如果有找到計算機發票檔才開窗選取發票
*!*	             K38='K38'+MMT
*!*	             K39='K39'+MMT
*!*	             IF !USED('&K37')
*!*	                SELECT 0
*!*	                USE (K37) ALIAS K37
*!*	             ELSE
*!*	                SELECT K37
*!*	             ENDIF
*!*	             SET ORDER TO 1
*!*	             IF !USED('&K38')
*!*	                SELECT 0
*!*	                USE (K38) ALIAS K38
*!*	             ELSE
*!*	                SELECT K38
*!*	             ENDIF
*!*	             SET ORDER TO 2
*!*	             IF !USED('&K39')
*!*	                SELECT 0
*!*	                USE (K39) ALIAS K39
*!*	             ELSE
*!*	                SELECT K39
*!*	             ENDIF
*!*	             SET ORDER TO 2
*!*	             CREATE CURSOR ELCINV (F01 C(2),F02 C(4),F03 D(8),F04 C(10),F05 N(2,0))
*!*	             INDEX ON F01+F02 TAG ELCINV
*!*	             SET ORDER TO 1
*!*	             IF INT_IVY
*!*	                SELECT K38.F03,K38.F01,K37.F05,K37.F06,K37.F07 FROM K38,K37 WHERE K38.F02=sys_oper AND K38.F03='32' AND K37.F07>0 AND K37.F01=K38.F01 AND K37.F05<=CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE) ORDER BY K38.F03,K38.F01 INTO CURSOR ELCTMP NOWAIT
*!*	             ELSE
*!*	                SELECT K38.F03,K38.F01,K37.F05,K37.F06,K37.F07 FROM K38,K37 WHERE K38.F02=sys_oper AND K38.F03='32' AND K37.F07>0 AND K37.F01=K38.F01 AND K37.F05<=CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE) AND K37.F08=RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2) ORDER BY K38.F03,K38.F01 INTO CURSOR ELCTMP NOWAIT
*!*	             ENDIF
*!*	                
*!*	             
*!*	             IF _TALLY>0

*!*	                SELECT ELCTMP
*!*	                GO TOP
*!*	                DO WHILE !EOF()
*!*	                   SELECT ELCINV
*!*	                   APPEND BLANK
*!*	                   REPLACE F01 WITH ELCTMP.F03
*!*	                   REPLACE F02 WITH ELCTMP.F01
*!*	                   REPLACE F03 WITH ELCTMP.F05
*!*	                   REPLACE F04 WITH ELCTMP.F06
*!*	                   REPLACE F05 WITH ELCTMP.F07
*!*	                   SELECT ELCTMP
*!*	                   SKIP
*!*	                ENDDO   
*!*	                SELECT ELCTMP
*!*	                USE
*!*	                SELECT ELCINV
*!*	                SEEK '32'           
*!*	                ELC_SEEK=CREATEOBJECT("ELC_SEEK")                  
*!*	                ELC_SEEK.SHOW    
*!*	                IF SEEK(FLG,'K39') AND !EMPTY(FLG) &&如果有選取發票號碼
*!*	                   THIS.VALUE=FLG
*!*	                   THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2
*!*	                   THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
*!*	       	           THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)  
*!*	       	           THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2 AND THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE>1)
*!*	       	           SELECT K39
*!*	       	           SEEK FLG
*!*	       	           IF FOUND()
*!*	       	              REPLACE F03 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
*!*	       	           ENDIF
*!*	       	           SELECT K37
*!*	       	           SEEK UKEF
*!*	       	           IF FOUND()
*!*	       	              REPLACE F07 WITH VAL(RIGHT(F04,8))-VAL(RIGHT(FLG,8))
*!*	       	               
*!*	       	                 REPLACE F05 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
*!*	       	                 
*!*	       	              REPLACE F06 WITH IIF(F07=0,'',LEFT(FLG,2)+PADL(ALLTRIM(STR(VAL(RIGHT(FLG,8))+1)),8,'0'))
*!*	       	           ENDIF
*!*	       	        ENDIF   
*!*	                SELECT ELCINV
*!*	                USE
*!*	             ELSE
*!*	               =MESSAGEBOX('您無可開立發票號碼',0+48,'提示')
*!*	             ENDIF
*!*	                SELECT K37
*!*	       	        USE
*!*	       	        SELECT K38
*!*	       	        USE
*!*	       	        SELECT K39 
*!*	       	        USE
*!*	             SELECT &AREA1
*!*	                   
*!*	          ENDIF               &&如果有找到計算機發票檔終
*!*	       ENDPROC

       PROCEDURE INTERACTIVECHANGE
               IF INT_060=.T.
                   IF LEN(ALLTRIM(THIS.VALUE))=10
                       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
*!*	                 THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1
                       THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
*!*	               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1
	                   THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F29='31',1,IIF(C01.F29='32',2,1)),1)
       	               THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01'),IIF(C01.F30='3',3,IIF(C01.F30='2',2,1)),1)  
       	               THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2 AND THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE>1)
                   ELSE   
                       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
                       THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.F.
                       THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''
                       THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''              
                  ENDIF
               ENDIF       
       ENDPROC
ENDDEFINE     
*********************************************************************發票種類
DEFINE CLASS INV_TYPE AS OPTIONGROUP
  HEIGHT=INT_015*25
  TOP=INT_015*109
  LEFT=INT_015*149
  HEIGHT=INT_015*25
  WIDTH=INT_015*120
  FONTSIZE=INT_015*9
  BUTTONCOUNT=2
  VALUE=1
  NAME='INV_TYPE'
  OPTION1.CAPTION='三聯式'
  OPTION1.TOP=INT_015*5
  OPTION1.WIDTH=INT_015*52
  OPTION1.LEFT=INT_015*5
  OPTION1.NAME='OPTION1'
  OPTION2.CAPTION='二聯式'
  OPTION2.TOP=INT_015*5
  OPTION2.WIDTH=INT_015*52
  OPTION2.LEFT=INT_015*59
  OPTION2.NAME='OPTION2'
  PROC INTERACTIVECHANGE
       IF THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2  AND THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE<>1
          THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
        ELSE  
          THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.
          THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=1          
          THISFORM.PAGEFRAME1.PAGE1.LBLF241.CAPTION=''
       ENDIF   
  ENDPROC     
*!*	  PROCEDURE INTERACTIVECHANGE
*!*	     THISFORM.PAGEFRAME1.PAGE1.TXTF22.VALUE=LEFT(THIS.DISPLAYVALUE,2)
*!*	*     THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(THIS.VALUE=1,'三聯式','二聯式')
*!*	     THISFORM.PAGEFRAME1.PAGE1.TXTF22.REFRESH
*!*	     IF THIS.VALUE=1
*!*	        THISFORM.TAX_TYPE.VISIBLE=.T. 
*!*	     ENDIF
*!*	  ENDPROC
ENDDEFINE  
*********************************************************************課稅別
DEFINE CLASS TAX_TYPE AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*109
  LEFT=INT_015*269
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*50
  ROWSOURCETYPE=1
  VALUE=1
  STYLE=2
  NAME='TAX_TYPE'
  PROCEDURE INIT
     WITH THIS 
          .ADDITEM('應稅')
          .ADDITEM('零稅')          
          .ADDITEM('免稅')          
     ENDWITH   
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
     IF THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE<>1 AND THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=2
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=2
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VISIBLE=.F.
        THISFORM.PAGEFRAME1.PAGE1.CUS_TYPE.VALUE=1
        THISFORM.PAGEFRAME1.PAGE1.LBLF241.CAPTION=''
     ENDIF
  ENDPROC
ENDDEFINE  
*********************************************************************是否經海關
DEFINE CLASS CUS_TYPE AS OPTIONGROUP
  HEIGHT=INT_015*25
  TOP=INT_015*109
  LEFT=INT_015*320
  HEIGHT=INT_015*25
  WIDTH=INT_015*160
  FONTSIZE=INT_015*9
  BUTTONCOUNT=2
  VALUE=2
  NAME='CUS_TYPE'
  OPTION1.CAPTION='不經海關'
  OPTION1.TOP=INT_015*5
  OPTION1.WIDTH=INT_015*72
  OPTION1.LEFT=INT_015*5
  OPTION1.NAME='OPTION1'
  OPTION2.CAPTION='須經海關'
  OPTION2.TOP=INT_015*5
  OPTION2.WIDTH=INT_015*72
  OPTION2.LEFT=INT_015*79
  OPTION2.NAME='OPTION2'    
ENDDEFINE  
***************************************************幣別設定
DEFINE CLASS CRCY AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*31
  LEFT=INT_015*379
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*84
  FONTSIZE=INT_015*9
  ROWSOURCETYPE=1
  STYLE=2
  NAME='CRCY'
  PROCEDURE INIT
    SELECT C00
    GO TOP 
    DO WHILE .NOT. EOF()
       L=4-LEN(ALLTRIM(F01))
       THIS.ADDITEM(F01)
       SKIP
    ENDDO
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=THIS.DISPLAYVALUE
    THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(THIS.DISPLAYVALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THIS.DISPLAYVALUE,'C00'),C00.F02,1))
    THISFORM.PAGEFRAME1.PAGE2.TXTF11.REFRESH
    THISFORM.PAGEFRAME1.PAGE2.TXTF17.REFRESH
  ENDPROC
ENDDEFINE         
***
************************************************依包裝方式轉EXCEL選擇類別
DEFINE CLASS PCKORD AS FORM
  AUTOCENTER=.T.
  CAPTION='請選擇轉出內容'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*190
  WIDTH=INT_015*245
  FONTSIZE=INT_015*9
  CLOSABLE=.F.
  CONTROLBOX=.F.
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='PCKORD'
ADD OBJECT DATA_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*17,;
      TOP=INT_015*20,;
      AUTOSIZE=.T.,;
      FONTSIZE=INT_015*12,;
      BUTTONCOUNT=4,;
      OPTION1.CAPTION='只轉內包裝資料',;
      OPTION1.TOP=INT_015*0,;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='只轉外包裝資料',;
      OPTION2.TOP=INT_015*40,;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.AUTOSIZE=.T.,;
      OPTION3.CAPTION='全部內外包資料',;
      OPTION3.TOP=INT_015*80,;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.AUTOSIZE=.T.,;       
      OPTION4.CAPTION='料號包裝量資料',;
      OPTION4.TOP=INT_015*120,;
      OPTION4.FONTSIZE=INT_015*9,;
      OPTION4.AUTOSIZE=.T.,;        
      NAME='DATA_OPTION'   
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*175,;     
      TOP=INT_015*23,;  
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*10,;
      CAPTION='\<Y.確定',;
      TOOLTIPTEXT='確認所選擇的鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*175,;
      TOP=INT_015*61,;
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*10,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'     
  *****      
 PROC INIT  

 ENDPROC  
 PROCEDURE CMND1.CLICK     
           IF!USED('C20')
              SELECT 0
              USE C20
           ELSE
              SELECT C20
           ENDIF     
           SET ORDER TO 1
           CREATE CURSOR TMP1 (出貨單號 C(10),料品編號 C(43),客戶料號 C(30),數量 N(7),出貨日期 C(2),訂單號碼 C(10),客戶單號 C(20),備註說明 C(30),產地 C(30),毛重 N(14,9),淨重 N(14,9),包裝方式 C(30))        
  	       IF THISFORM.DATA_OPTION.VALUE=1 OR THISFORM.DATA_OPTION.VALUE=3    
              SELECT B06
              SEEK LK
              IF FOUND()
                 DO WHILE B06.F01=LK
                    QTY=B06.F04            
                    SELECT C20
                    SEEK B06.F03
                    IF FOUND()
                       X=VAL(C20.F03)
                       IF X<>0
                          DO WHILE .T.
                             SELECT TMP1                 
                             APPEND BLANK
                             REPLACE 出貨單號 WITH B06.F01
                             REPLACE 料品編號 WITH B06.F03
                             REPLACE 客戶料號 WITH IIF(SEEK(B06.F09+B06.F03,'C04'),C04.F17,'')
                             REPLACE 訂單號碼 WITH B06.F09
                             REPLACE 客戶單號 WITH IIF(SEEK(B06.F09,'C03'),C03.F14,'')                              
                             REPLACE 出貨日期 WITH B06.F02                    
                             REPLACE 備註說明 WITH ALLTRIM(B06.F08)        
                             REPLACE 產地     WITH IIF(SEEK(B06.F03,'C20'),C20.F04,'')       
                             REPLACE 包裝方式 WITH IIF(SEEK(B06.F03,'C20'),C20.F02,'')
                             QTY=QTY+X*(-1)
                             IF QTY>0
                                REPLACE 數量 WITH X
                                REPLACE 毛重     WITH IIF(SEEK(B06.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                REPLACE 淨重     WITH IIF(SEEK(B06.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                             ELSE
                                REPLACE 數量 WITH QTY+X
                                REPLACE 毛重     WITH IIF(SEEK(B06.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                REPLACE 淨重     WITH IIF(SEEK(B06.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                                EXIT
                             ENDIF                             
                         ENDDO
                       ELSE
                          =MESSAGEBOX('料號:'+B06.F03+'尚未建立包裝基量資料!',0+48,'提示訊息視窗')
                       ENDIF
                    ELSE
                       =MESSAGEBOX('料號:'+B06.F03+'尚未建立包裝基量資料!',0+48,'提示訊息視窗')
                    ENDIF                    
                    SELECT B06
                    SKIP
                 ENDDO
              ENDIF 
           ENDIF     
           IF THISFORM.DATA_OPTION.VALUE=2 OR THISFORM.DATA_OPTION.VALUE=3 OR THISFORM.DATA_OPTION.VALUE=4
              IF THISFORM.DATA_OPTION.VALUE=4
                 SELECT F01,F02,F03,F09,F08,SUM(F04) FROM B06 GROUP BY F03 WHERE F01=LK INTO CURSOR TMP2 ORDER BY F03,F01 NOWAIT
              ELSE  
                SELECT F01,F02,F03,F09,F08,SUM(F04) FROM B06 GROUP BY F01,F03,F09 WHERE F01=LK INTO CURSOR TMP2 ORDER BY F01,F03,F09 NOWAIT
              ENDIF  
                IF _TALLY>0
                   SELECT TMP2
                   GO TOP       
                   DO WHILE !EOF()
                      SELECT C20
                      SEEK TMP2.F03
                      IF FOUND()
                         X=C20.F11
                         IF X<>0
                            SELECT TMP2
                            QTY=SUM_F04
                            P1=CEILING(QTY/X)   
                            FOR I= 1 TO P1     
                                SELECT TMP1                     
                                APPEND BLANK    
                                IF QTY<X         
                                   REPLACE 數量 WITH QTY           
                                ELSE
                                   REPLACE 數量 WITH X
                                   QTY=QTY-X
                                ENDIF                             
                                REPLACE 客戶料號 WITH IIF(SEEK(TMP2.F09+TMP2.F03,'C04'),C04.F17,'')
                                REPLACE 出貨日期 WITH TMP2.F02    
                                REPLACE 訂單號碼 WITH TMP2.F09
                                REPLACE 客戶單號 WITH IIF(SEEK(TMP2.F09,'C03'),C03.F14,'')                     
                                REPLACE 出貨單號 WITH TMP2.F01       
                                REPLACE 料品編號 WITH TMP2.F03
                                REPLACE 備註說明 WITH TMP2.F08
                                REPLACE 產地     WITH IIF(SEEK(TMP2.F03,'C20'),C20.F04,'')
                                REPLACE 毛重     WITH IIF(SEEK(TMP2.F03,'C20'),ROUND(C20.F13/C20.F11*數量,6),0)
                                REPLACE 淨重     WITH IIF(SEEK(TMP2.F03,'C20'),ROUND(C20.F14/C20.F11*數量,6),0)  
                                REPLACE 包裝方式 WITH IIF(SEEK(TMP2.F03,'C20'),C20.F02,'')
                            ENDFOR               
                         ELSE
                            =MESSAGEBOX('料號:'+TMP2.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')                                                           
                         ENDIF
                      ELSE
                         =MESSAGEBOX('料號:'+TMP2.F03+'尚未建立外包裝數量資料!',0+48,'提示訊息視窗')                                                                                                 
                     ENDIF                                  
                     SELECT TMP2
                     SKIP
                  ENDDO
                ENDIF                                                             
           ENDIF                   
           SELECT C20
           USE
           LK=LK+'(包裝量)'
           SELECT TMP1
     THISFORM.RELEASE  
 ENDPROC   
 ***** 
  PROCEDURE CMND2.CLICK
      THISFORM.RELEASE
  ENDPROC      
ENDDEFINE         
