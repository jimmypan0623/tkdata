****程式名稱:P03 材料請購單
CLOSE ALL
CLEAR 
HD1='P001 '
HD2='PA'
HD3='材料請購單'
FLG='0'
FCH=''
CHK=''
R=0
QTY=0
TQTY=0
AREA1='P05'
AREA2='P06'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
A24='A24'+LEFT(DTOS(DATE()),6)
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1      
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'P03'
IF !USED('A14')
   SELE 0
   USE A14
ELSE
   SELE A14
ENDIF
SET ORDER TO 1      
IF !USED('E08')
   SELECT 0
   USE E08
ELSE
   SELECT E08
ENDIF
SET ORDER TO E083      
IF !USED('B11')
   SELE 0
   USE B11
ELSE
   USE B11
ENDIF
SET ORDER TO B112   
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1      
IF !USED('D01')
   SELE 0
   USE D01 INDE D01
ELSE
   SELE D01
ENDIF
SET ORDER TO D011

IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011
IF !USED('C03')
   SELE 0
   USE C03
ELSE 
   SELE C03
ENDIF
SET ORDER TO 1
IF !USED('C04')
   SELE 0
   USE C04
ELSE 
   SELE C04
ENDIF
SET ORDER TO C041      
IF !USED('C05')
   SELE 0
   USE C05
ELSE 
   SELE C05
ENDIF
SET ORDER TO C054  
IF !USED('C20')
   SELE 0
   USE C20
ELSE 
   SELE C20
ENDIF
SET ORDER TO C201  
IF !USED('C66')
   SELE 0
   USE C66 INDE C66
ELSE
   SELE C66
ENDIF
SET ORDER TO C662   && F02+F04                
IF !USED('P07')
   SELE 0
   USE P07
ELSE 
   SELE P07
ENDIF
SET ORDER TO 1      
IF !USED('P05')
   SELE 0
   USE P05 INDE P05
ELSE
   SELE P05
ENDIF
SET ORDER TO P051
*!*	SET RELA TO F07 INTO A01 ADDI

IF !USED('P06')
   SELE 0
   USE P06 INDE P06
ELSE
   SELE P06
ENDIF
SET ORDER TO P061      
SET RELA TO F02 INTO B01
SET RELATION TO F02 INTO E08 ADDI
P03FORM=CREATEOBJECT("TKP03")
P03FORM.SHOW  
DEFINE CLASS TKP03 AS FORM
  CAPTION='P03.'+HD3
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1 
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKP03'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;      
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=4,;            
      RECORDSOURCE='P05',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=7,;            
      RECORDSOURCE='P06',;
      LINKMASTER='P05',;
      RELATIONALEXPR='F01',;
      CHILDORDER='P061',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*168,;
      LEFT=INT_015*680          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*12,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;
      CAPTION='\<A.確認',;
      NAME='ANS_BOTT'                  
  ADD OBJECT CNL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*55,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*40,;
      CAPTION='\<B.取消',;
      NAME='CNL_BOTT'     
  ADD OBJECT IODT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*97,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*63,;
      CAPTION='\<Z.預期異動',;
      NAME='IODT_BOTT'           
  ADD OBJECT INV_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*163,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*63,;
      CAPTION='\<V.庫存明細 ',;
      NAME='INV_BOTT'                 
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='請購單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF02','LABEL')     
     WITH THIS.LBLF02
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*38
          .WIDTH=INT_015*50  
          .CAPTION='請購日期'
     ENDWITH            
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='需求類別'
     ENDWITH
     THIS.ADDOBJECT('LBLF031','LABEL')
     WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*90
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='需求對象'
     ENDWITH    
     THIS.ADDOBJECT('LBLF051','LABEL')
     WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*88
         .AUTOSIZE=.T.        
     ENDWITH
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .CAPTION='需求單號'
     ENDWITH    
     THIS.ADDOBJECT('LBLF12','LABEL')
     WITH THIS.LBLF12
         .VISIBLE=.T.
         .LEFT=INT_015*154
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH    
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH         
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*318
         .TOP=INT_015*13
         .WIDTH=INT_015*50
         .CAPTION='請購人員'         
     ENDWITH    
     THIS.ADDOBJECT('LBLF071','LABEL')
     WITH THIS.LBLF071
         .VISIBLE=.T.
         .LEFT=INT_015*440
         .TOP=INT_015*13
         .AUTOSIZE=.T.
     ENDWITH 
     THIS.ADDOBJECT('LBLF11','LABEL')
     WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*318
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='入貨方式'
     ENDWITH        
     THIS.ADDOBJECT('LBLF008','LABEL')
     WITH THIS.LBLF008
         .VISIBLE=.T.
         .LEFT=INT_015*318
         .TOP=INT_015*67
         .WIDTH=INT_015*50
         .CAPTION='確認狀態'
     ENDWITH              
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*370
         .TOP=INT_015*67
         .AUTOSIZE=.T.
     ENDWITH         
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*318
         .TOP=INT_015*92
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*369
         .TOP=INT_015*92
         .AUTOSIZE=.T.
     ENDWITH         
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*318
         .TOP=INT_015*116
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*369
         .TOP=INT_015*116
         .AUTOSIZE=.T.
     ENDWITH     
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*75
          .HEIGHT=INT_015*25          
     ENDWITH        
     THIS.ADDOBJECT('TXTF03','TEXTBOX')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*20
          .HEIGHT=INT_015*25
          .MAXLENGTH=1
     ENDWITH        
     THIS.ADDOBJECT('RQRMNT_TYPE','RQRMNT')
     
     THIS.ADDOBJECT('TXTF04','TXTF04')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH     
     THIS.ADDOBJECT('TXTF06','TXTF06')          
     WITH THIS.TXTF06
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*109
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH           
     THIS.ADDOBJECT('TXTF10','TEXTBOX')          
     WITH THIS.TXTF10
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*134
          .WIDTH=INT_015*370
          .HEIGHT=INT_015*25
          .MAXLENGTH=80
     ENDWITH                
     THIS.ADDOBJECT('TXTF07','TXTF07')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*370
          .TOP=INT_015*9
          .WIDTH=INT_015*65
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH 
     THIS.ADDOBJECT('TXTF11','TEXTBOX')          
     WITH THIS.TXTF11
          .VISIBLE=.T.
          .LEFT=INT_015*370
          .TOP=INT_015*34
          .WIDTH=INT_015*65
          .HEIGHT=INT_015*25
          .MAXLENGTH=4
     ENDWITH        
     THIS.ADDOBJECT('TRANSPORT_TYPE','TRANSPORT')     
  ENDPROC 
  ************  
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF02','LABEL')
	WITH THIS.LBLF02  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*13
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF021','LABEL')
    WITH THIS.LBLF021
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*13
	     .AUTOSIZE=.T.
	ENDWITH     
    THIS.ADDOBJECT('LBLF03','LABEL')
    WITH THIS.LBLF03
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*38
	     .WIDTH=INT_015*50
	     .CAPTION='需求數量'
	ENDWITH 
    THIS.ADDOBJECT('LBLFC20F03','LABEL')
    WITH THIS.LBLFC20F03
         .VISIBLE=.T.
	     .LEFT=INT_015*180
	     .TOP=INT_015*38
	     .AUTOSIZE=.T.
	     .CAPTION='包裝基量：'
	ENDWITH     
    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='請購數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLFC20F11','LABEL')
    WITH THIS.LBLFC20F11
         .VISIBLE=.T.
	     .LEFT=INT_015*180
	     .TOP=INT_015*63
	     .AUTOSIZE=.T.
	     .CAPTION='包裝數量：'
	ENDWITH 
    THIS.ADDOBJECT('LBLFC20F15','LABEL')
    WITH THIS.LBLFC20F15
         .VISIBLE=.T.
	     .LEFT=INT_015*180
	     .TOP=INT_015*88
	     .AUTOSIZE=.T.
	     .CAPTION='最小訂購：'
	ENDWITH 
    THIS.ADDOBJECT('LBLFB11F04','LABEL')
    WITH THIS.LBLFB11F04
         .VISIBLE=.T.
	     .LEFT=INT_015*380
	     .TOP=INT_015*38
	     .AUTOSIZE=.T.
	     .CAPTION='在庫數量：'
	ENDWITH     
    THIS.ADDOBJECT('LBLFE08F20','LABEL')
    WITH THIS.LBLFE08F20
         .VISIBLE=.T.
         .LEFT=INT_015*380
         .TOP=INT_015*63
         .AUTOSIZE=.T.
         .CAPTION='最後結餘'         
    ENDWITH     	
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='需求日期'       
    ENDWITH        
    THIS.ADDOBJECT('LBLF06','LABEL')      
    WITH THIS.LBLF06
         .VISIBLE=.T.       
         .LEFT=INT_015*14
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
    ENDWITH     
    THIS.ADDOBJECT('LBLF061','LABEL')      
    WITH THIS.LBLF061
         .VISIBLE=.T.       
         .LEFT=INT_015*64
         .TOP=INT_015*113
         .AUTOSIZE=.T.
    ENDWITH         
    THIS.ADDOBJECT('LBLF90','LABEL')      
    WITH THIS.LBLF90
         .VISIBLE=.T.       
         .LEFT=INT_015*14
         .TOP=INT_015*135
         .WIDTH=INT_015*50
         .CAPTION='取消人員'
    ENDWITH     
    THIS.ADDOBJECT('LBLF901','LABEL')      
    WITH THIS.LBLF901
         .VISIBLE=.T.       
         .LEFT=INT_015*64
         .TOP=INT_015*135
         .AUTOSIZE=.T.
    ENDWITH      
    THIS.ADDOBJECT('LBLFC66','LABEL')      
    WITH THIS.LBLFC66
         .BACKCOLOR=RGB(255,255,0)
         .VISIBLE=.T.       
         .LEFT=INT_015*14
         .TOP=INT_015*155
         .AUTOSIZE=.T.
         .CAPTION=''
    ENDWITH   
	THIS.ADDOBJECT('TXTF02','TXTF02')
	WITH THIS.TXTF02      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*9
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF02'  
         .BACKCOLOR=RGB(255,255,100)
         .MOUSEPOINTER=99
         .MOUSEICON='BMPS\harrow.cur'     	     
	ENDWITH     
	THIS.ADDOBJECT('TXTF03','TEXTBOX')
	WITH THIS.TXTF03
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*34
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='99,999,999.99'
	     .NAME='TXTF03'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF04','TEXTBOX')
    WITH THIS.TXTF04
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*59
         .WIDTH=INT_015*100
         .INPUTMASK='99,999,999.99'
         .NAME='TXTF04'
    ENDWITH     
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*83
         .WIDTH=INT_015*75
         .HEIGHT=INT_015*25
         .NAME='TXTF05'                            
    ENDWITH     

  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE P05      
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(P05.F08,'',RGB(255,0,0))","COLUMN")                 
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
     ENDIF          
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF12.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !P05.F08  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !P05.F08  &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限   
        THISFORM.ANS_BOTT.ENABLED=!P05.F08 .AND. !EMPTY(A02.F08)            
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   
     THISFORM.CNL_BOTT.ENABLED=.F.  
     THISFORM.IODT_BOTT.ENABLED=.F.
     THISFORM.INV_BOTT.ENABLED=.F.
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
       SELE P06
     IF THISFORM.SHRGROUP.ENABLED=.F.
         THISFORM.GRID2.READONLY=.T.      
         THISFORM.GRID2.SETFOCUS   
*        THISFORM.ANS_BOTT.ENABLED=IIF(F23=0,.T.,.F.) .AND. IIF(F10=0,.F.,.T.)
     ENDIF   	
     IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0        
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=0                
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF901.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC20F03.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC20F11.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC20F15.CAPTION=''
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.CNL_BOTT.ENABLED=.F.
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !P05.F08  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !P05.F08  &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
        THISFORM.CNL_BOTT.ENABLED=P05.F08 .AND. EMPTY(P06.F90)=.T. .AND. !EMPTY(A02.F09)
        THISFORM.IODT_BOTT.ENABLED=.T.
        THISFORM.INV_BOTT.ENABLED=.T.
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. !P05.F08 &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC   
  PROC INIT    
        SELECT P05
        GO BOTTOM       
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   &&判斷有無新增的權限
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10       
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(P05.F08,'',RGB(255,0,0))","COLUMN")                        
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='請購單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象代號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='對象簡稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='需求單號'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P05.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P05.F04'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P05.F05'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P05.F06'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*81
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(P06.F90)=.F.,RGB(0,255,255),'')","COLUMN")                        
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='品名規格'
	   THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='需求數量'
	   THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='請購數量'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='最後結餘'
	   THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='需求日期'
	   THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='安全資料'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P06.F02'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE="TRANSFORM(P06.F03,'@R 999,999,999,999')"
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE="TRANSFORM(P06.F04,'@R 999,999,999,999')"
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE="TRANSFORM(E08.F20+ALTT(P06.F02,'1'),'@R 9,999,999,999.99')"
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P06.F05'
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='P06.F06'
	   THISFORM.GRID2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*85
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*85
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*90
       THISFORM.GRID2.COLUMN3.ALIGNMENT=1
       THISFORM.GRID2.COLUMN4.ALIGNMENT=1
       THISFORM.GRID2.COLUMN5.ALIGNMENT=1
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*100
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID2.READONLY=.T.    
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !P05.F08 &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !P05.F08 &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限 
          THISFORM.ANS_BOTT.ENABLED=!P05.F08 .AND. !EMPTY(A02.F08)
       ENDIF          
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(C20.F15<E08.F20+ALTT(P06.F02,'1'),RGB(255,255,0),'')","COLUMN") 
       THISFORM.KEY_LIST.DISPLAYVALUE='依請購單號排列'       
       JK='請購單號'
       SELE P05
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=P05.F02
  ENDPROC            
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依請購單號排列')
           .ADDITEM('依需求對象排列')
           .ADDITEM('依需求單號排列')
       ENDWITH      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE P05 
       DO CASE
          CASE THIS.DISPLAYVALUE='依請購單號排列'
               SET ORDER TO P051 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='請購單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P05.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象代號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P05.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='對象簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P05.F05'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='需求單號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P05.F06'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*81               
          CASE THIS.DISPLAYVALUE='依需求對象排列'
               SET ORDER TO P052
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='對象代號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P05.F04'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P05.F05'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*68
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='需求單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P05.F06'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81               
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='請購單號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P05.F01'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*81      
          CASE THIS.DISPLAYVALUE='依需求單號排列'
               SET ORDER TO P053
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='需求單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P05.F06'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象代號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P05.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='對象簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P05.F05'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68                                                   
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='請購單號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P05.F01'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*81                              
       ENDCASE 
        *SELE &AREA1
        THISFORM.GRID1.SETFOCUS
  ENDPROC      
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P05.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=P05.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=P05.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(P05.F03='1','客戶訂單',IIF(P05.F03='2','廠內耗用','需求預估'))       
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=P05.F04       
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=P05.F05       
       THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=P05.F06              
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=P05.F07
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(P05.F07,'A01'),A01.F03,'')
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=IIF(P05.F08=.T.,'是','否')
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.BACKCOLOR=IIF(P05.F08,RGB(255,255,0),RGB(0,255,0))       
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=P05.F09
       THISFORM.PAGEFRAME1.PAGE1.LBLF12.CAPTION=IIF(P05.F04='C6666','特殊備料',ICASE(P05.F12='1','正式訂單',P05.F12='2','預購訂單',P05.F12='3','空頭訂單',''))
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=P05.F90
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=P05.F10
       THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=ICASE(P05.F11='1','海運',P05.F11='2','空運',P05.F11='3','快遞',P05.F11='4','自取','直寄')
       THISFORM.ANS_BOTT.ENABLED=!P05.F08 .AND. !EMPTY(A02.F08)
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)   .AND. !P05.F08 &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !P05.F08 &&判斷有無刪除的權限       
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       THISFORM.REFRESH
  ENDPROC     
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=P06.F02
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=P06.F03       
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=P06.F04
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=P06.F05
       THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=P06.F06
       THISFORM.PAGEFRAME1.PAGE2.LBLF901.CAPTION=P06.F90
       THISFORM.PAGEFRAME1.PAGE2.LBLFC66.VISIBLE = IIF(P05.F08 = .T.,.F.,.T.)
       THISFORM.PAGEFRAME1.PAGE2.LBLFC66.CAPTION = IIF(SEEK('2'+ P06.F02,'C66') OR SEEK('3'+ P06.F02,'C66'),'C66.入貨異動紀錄中有此料品延後交期或取消請購之紀錄','')
       THISFORM.CNL_BOTT.ENABLED=P05.F08 .AND. EMPTY(P06.F90)=.T. .AND. !EMPTY(A02.F09)  
       THISFORM.PAGEFRAME1.PAGE2.LBLFC20F03.CAPTION=IIF(SEEK(P06.F02,'C20'),'包裝基量：' + ALLTRIM(TRANSFORM(VAL(C20.F03),"@R 999,999,999")),'')
       THISFORM.PAGEFRAME1.PAGE2.LBLFC20F11.CAPTION=IIF(SEEK(P06.F02,'C20'),'包裝數量：' + ALLTRIM(TRANSFORM(C20.F11,"@R 99,999,999,999")),'')
       THISFORM.PAGEFRAME1.PAGE2.LBLFC20F15.CAPTION=IIF(SEEK(P06.F02,'C20'),'最小訂購：' + ALLTRIM(TRANSFORM(C20.F15,"@R 99,999,999,999")),'')
       THISFORM.PAGEFRAME1.PAGE2.LBLFB11F04.CAPTION=IIF(SEEK(P06.F02+B01.F07,'B11'),'在庫數量：' + ALLTRIM(TRANSFORM(B11.F04,"@R 99,999,999,999")),'')
       THISFORM.PAGEFRAME1.PAGE2.LBLFE08F20.CAPTION='最後結餘：'+ALLTRIM(TRANSFORM(E08.F20+ALTT(P06.F02,'1'),'@R 99,999,999,999'))
       
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM. CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       THISFORM.ANS_BOTT.ENABLED=IIF(F23=0,.T.,.F.) .AND. IIF(F10=0,.F.,.T.)       
*       THISFORM.REFRESH
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.    
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.          
       HD='P001 '+SUBSTR(DTOS(DATE()),3,4)
       DO ODR_CRT   &&執行主程式新增單號程序
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS                  
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.               
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=DATE()            
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=LEFT(THISFORM.PAGEFRAME1.PAGE1.RQRMNT_TYPE.DISPLAYVALUE,1)
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.RQRMNT_TYPE.VISIBLE=.T.    
        THISFORM.PAGEFRAME1.PAGE1.RQRMNT_TYPE.VALUE=1    
        THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VISIBLE=.T.    
        THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VALUE=1    
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.  
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=SYS_OPER
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.          
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(SYS_OPER,'A01'),A01.F03,'')           
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE1.LBLF12.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=''     
        THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.DISPLAYVALUE)
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=DATE()
        IF THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE='1'
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY = .T.
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=CTOD('')
        ENDIF
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''          
        THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=''          
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF901.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC66.CAPTION = ''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC20F03.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC20F11.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFC20F15.CAPTION=''
     ENDIF   
  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     THISFORM.ANS_BOTT.ENABLED=.F.     
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE P05
        LOCK()
        IF !RLOCK()
           DO FILE_IMPACT
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
*           RETURN
        ELSE        
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VISIBLE=.T.  
           THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VALUE=VAL(P05.F11)
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
        ENDIF   
     ELSE                                                                &&處理表身修改
        SELE C04
        SEEK P06.F07+P06.F02
        IF FOUND()
           RLOCK()
           LL2=RLOCK()
        ELSE
           LL2=.T.   
        ENDIF  
        SELE P06
        RLOCK()
        IF RLOCK() .AND. LL2=.T.
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS          
        ELSE
           DO FILE_IMPACT 
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
       ENDIF        
     ENDIF   
  ENDPROC    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          IF ALIA()='P05'           &&刪除整張訂單
             SELE P05
             IF F08=.T.
                =MESSAGEBOX('此張請購單已確認無法刪除!',0+64,'提示訊息視窗')              
                RETURN
             ELSE
                PO_NO=P05.F01

                SELE RECNO() FROM P06 WHERE P06.F01=P05.F01  INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'P06')
                   LL1=RLOCK(KK1,'P06')
                ELSE
                   LL1=.T.   
                ENDIF   
                SELE RECNO() FROM C04 WHERE F03+F04=ANY (SELE F07+F02 FROM P06 WHERE F01=PO_NO) INTO ARRAY BK2              
                JJ2=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK2)
                       JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                   ENDFOR    
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
                   RLOCK(KK2,'C04')
                   LL2=RLOCK(KK2,'C04')
                ELSE
                   LL2=.T.   
                ENDIF                        
                SELE RECNO() FROM C03 WHERE F02=P05.F06 INTO ARRAY BK3              
                JJ3=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK3)
                       JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
                   ENDFOR    
                   KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
                   RLOCK(KK3,'C03')
                   LL3=RLOCK(KK3,'C03')
                ELSE
                   LL3=.T.   
                ENDIF            
                IF RLOCK('P05') .AND. LL1 .AND. LL2 .AND. LL3=.T.
                   PO_NO=P05.F01
                   IF LEN(ALLTRIM(JJ1))>0                
                      SELE P06
                      FOR I=1 TO ALEN(BK1)
                          GO BK1(I)                          
                          SELE C04
                          SEEK P06.F07+P06.F02
                          IF FOUND()
                             REPL F11 WITH F11+IIF(P06.F04<P06.F03,P06.F04,P06.F03)*(-1)
                          ENDIF
                          SELE C03
                          SEEK P06.F07
                          IF FOUND()
                             REPL F11 WITH F11-1
                          ENDIF
                          SELE P06      
                      ENDFOR
                   ENDIF    
                   DELE FROM P06 WHERE P06.F01=P05.F01
                   SELE P05
                   DELE
                   UNLOCK ALL
*!*	                   IF  SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)
*!*	                       HD='P001 '+SUBSTR(DTOS(DATE()),3,4)+PO_NO
*!*	                       DO ODR_RJT   &&執行主程式單號重用程序
*!*	                   ENDIF   
                ELSE
                   DO FILE_IMPACT 
                   RETURN                 
                ENDIF
             ENDIF          
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !P05.F08 &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !P05.F08 &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
             ENDIF     
          ELSE        
                SELE RECNO() FROM C04 WHERE F03+F04=P06.F07+P06.F02 INTO ARRAY BK2       &&刪除單筆資料       
                JJ2=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK2)
                       JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                   ENDFOR    
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
                   RLOCK(KK2,'C04')
                   LL2=RLOCK(KK2,'C04')
                ELSE
                   LL2=.T.   
                ENDIF                        
              IF RLOCK('P06') .AND.  RLOCK('P05') .AND. LL2= .T.
                 SELE C04
                 SEEK P06.F07+P06.F02
                 IF FOUND()
                    REPL F11 WITH F11+IIF(P06.F04<P06.F03,P06.F04,P06.F03)*(-1)
                 ENDIF                   
                 SELE P06
                 DELE
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
              ELSE
                 DO FILE_IMPACT                  
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0
                 SELE P05
                 PO_NO=P05.F01
                 DELE
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF 
*!*	                 IF SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)  
*!*	                    HD='P001 '+SUBSTR(DTOS(DATE()),3,4)+PO_NO
*!*	                    DO ODR_RJT
*!*	                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF  
       RELEASE ALL LIKE BK* 
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='P06'
       THISFORM.GRID2.CHILDORDER='P061'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P06.F02'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P06.F03'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P06.F04'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P06.F05'
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P06.F06'
       SELE P05 
       COD=SYS(21)
       SET ORDER TO P051
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'P05','P051')   &&若有發生單號重複
           SELECT MAX(F01) FROM P05 INTO ARRAY GB NOWAIT           
           HD='P001 '+SUBSTR(DTOS(DATE()),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           DO ODR_RPT &&執行主程式單據編號重複程序
		   THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
		   THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH               
       ENDIF
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE<>'3'
          IF THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE='1' 
             IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C03','C033')=.F.
                =MESSAGEBOX('無此筆訂單資料!',0+64,'提示訊息視窗')
                THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
                SET ORDER TO &COD
                RETURN                         
              ENDIF  
           ELSE   
             IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
                =MESSAGEBOX('無此需求對象編號請先建立!',0+64,'提示訊息視窗')
                THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
                SET ORDER TO &COD
                RETURN                         
              ENDIF             
           ENDIF
       ENDIF
         IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
            =MESSAGEBOX('無此需求對象編號請先建立!',0+64,'提示訊息視窗')
            THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
            SET ORDER TO &COD
            RETURN                         
          ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'A01')=.F.
          =MESSAGEBOX('無此人員編號請重新輸入!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF   
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          =MESSAGEBOX('請購日期不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF   
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE)
          =MESSAGEBOX('請購人員不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF        
       SELE P05          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
          REPLACE F11 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VALUE))
          REPLACE F12 WITH IIF(SEEK(F06,'C03'),C03.F15,'')
       ENDIF
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE                                                                            &&表身新增確認
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE='1'
          IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+;
             THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'C05','C054')=.F.
             =MESSAGEBOX('出貨計劃無此筆資料!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
             RETURN
          ENDIF       
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'P06')=.T. 
          =MESSAGEBOX('此料號在此張請購單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN            
       ENDIF    
       IF IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'C04','C041'),;
          (C04.F05-C04.F09-C04.F21-C04.F23)-C04.F11,1)<=0
          =MESSAGEBOX('此筆訂單資料已請購!不得再重複請購!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN
       ENDIF   
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
          =MESSAGEBOX('請購量不得為 0',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN
       ENDIF          
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
          =MESSAGEBOX('需求日期不得為空白',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
          RETURN
       ENDIF             
       SELE C04
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
       IF FOUND()
          RLOCK()
          LL1=RLOCK()
       ELSE
          LL1=.T.
       ENDIF
       SELE C03
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
       IF FOUND()
          RLOCK()
          LL2=RLOCK()
       ELSE
          LL2=.T.
       ENDIF     
       IF LL1 .AND. LL2 =.F.       
          DO FILE_IMPACT
          RETURN
       ENDIF   
       SELE C04
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
       IF FOUND()
          REPL F11 WITH IIF(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE+F11>(F05-F09-F21-F23),F05-F09-F21-F23,F11+THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE)
       ENDIF
       SELE C03
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
       IF FOUND()
          REPL F11 WITH F11+1
       ENDIF               
       SELE P06
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F06 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE          
      ENDIF
      UNLOCK ALL          
      SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE                  
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID2.SETFOCUS    
      THISFORM.ORPGROUP.NEW_BOTT.CLICK        
     ENDIF
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'A01')=.F.
           =MESSAGEBOX('無此人員編號請重新輸入!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
           RETURN
        ENDIF        
        IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
           =MESSAGEBOX('請購日期不得空白!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
           RETURN
        ENDIF   
        SELE P05
        IF RLOCK() 
           REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
           REPL F09 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')           
           REPL F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE
           REPL F11 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VALUE))
           UNLOCK ALL
        ELSE
           DO FILE_IMPACT
          RETURN   
       ENDIF    
     ELSE                                                        &&表身修改確認
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
          =MESSAGEBOX('請購量不得為 0',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN
       ENDIF          
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
          =MESSAGEBOX('需求日期不得為空白',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
          RETURN
       ENDIF                
       SELE C04
       SEEK P06.F07+P06.F02
       IF FOUND()
          REPL F11 WITH F11+IIF(P06.F04<P06.F03,P06.F04,P06.F03)*(-1)
       ENDIF
       SELE P06   
           REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
           REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
           REPLACE F06 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')           
           UNLOCK ALL
       SELE C04
       SEEK P06.F07+P06.F02
       IF FOUND()
          REPLACE F11 WITH F11+P06.F04
       ENDIF   
       SELE P06          
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX') 
      THISFORM.PAGEFRAME1.PAGE1.RQRMNT_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.TRANSPORT_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.T.
      THISFORM.ANS_BOTT.ENABLED=!P05.F08 .AND. !EMPTY(A02.F08)
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1    
          THISFORM.GRID1.ENABLED=.T.
          THISFORM.GRID2.ENABLED=.T.       
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
      ELSE
          THISFORM.GRID1.ENABLED=.F.
          THISFORM.GRID2.ENABLED=.T.       
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0         
            HD='P001 '+SUBSTR(DTOS(DATE()),3,4)+P05.F01
            DO ODR_RJT
            SELE P05               
            DELE
            SKIP -1
            IF BOF()
               GO TOP
            ENDIF               
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH
         ENDIF   
      ENDIF       
      UNLOCK ALL
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'P06'
            THISFORM.GRID2.RECORDSOURCE='P06'
            THISFORM.GRID2.CHILDORDER='P061'
            THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P06.F02'
	        THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
	        THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P06.F03'
	        THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P06.F04'
	        THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P06.F05'
	        THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P06.F06'
	     ENDIF                   
            HD='P001 '+SUBSTR(DTOS(DATE()),3,4)+PO_NO
            DO ODR_RJT
          SELE P05
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依請購單號排列'
                 SET ORDER TO P051
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依需求對象排列'
                 SET ORDER TO P052
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依需求單號排列'
                 SET ORDER TO P053
         ENDCASE   

       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK                  &&確認此張請購單
       IF MESSAGEBOX('是否確認資料無誤?',4+32+256,'請確認') = 6	 
          SELE P05
          IF RLOCK()
             SELE P06
             SEEK P05.F01
             IF FOUND()
                DO WHILE F01=P05.F01
                   SELE P07
                   APPEND BLANK
                   RLOCK()
                   REPLACE F01 WITH P06.F01
                   REPLACE F02 WITH DATE()
                   REPLACE F03 WITH P05.F04
                   REPLACE F04 WITH P05.F05
                   REPLACE F05 WITH P06.F07
                   REPLACE F06 WITH P06.F02
                   REPLACE F07 WITH P06.F04
                   REPLACE F08 WITH P06.F05
                   REPLACE F09 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')           
                   REPLACE F10 WITH P05.F07
                   REPLACE F12 WITH P05.F12
                   UNLOCK

                   SELE P06
                   SKIP
                 ENDDO 
                 SELE P05
                 REPL F08 WITH .T.
                 REPL F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')           
                 THIS.ENABLED=.F.
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
                 UNLOCK ALL
                 IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                    THISFORM.GRID1.SETFOCUS
                 ELSE
                    THISFORM.GRID2.SETFOCUS
                    THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
                 ENDIF
                 THISFORM.REFRESH      
              ENDIF 
           ELSE    
               DO FILE_IMPACT
               RETURN
           ENDIF    
        ENDIF   
   ENDPROC
   PROC CNL_BOTT.CLICK
          IF MESSAGEBOX('是否確認取消此筆請購?',4+32+256,'請確認') = 6	        
                SELE C04       &&取消單筆資料       
                SEEK P06.F07+P06.F02
                IF FOUND()
                   RLOCK()
                   LL2=RLOCK()
                ELSE
                   LL2=.T.   
                ENDIF                        
                                  
              IF RLOCK('P06') .AND. LL2 =.T.
                 SELE C04
                 SEEK P06.F07+P06.F02
                 IF FOUND()
*!*	                    REPL F11 WITH F11+IIF(P06.F04<P06.F03,P06.F04,P06.F03)*(-1)
		            REPLACE  F11 WITH 0
                 ENDIF        
                 SELE P07
                 SET ORDER TO P071                 
                 SEEK P06.F01+P06.F02
                 IF FOUND()
                    DELE
                 ENDIF               
                 SELE P06   
                 REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')+SPACE(2)+'取消'
                 THISFORM.GRID2.SETFOCUS
                 THIS.ENABLED=.F.
              ELSE            
                 DO FILE_IMPACT
                 RETURN
              ENDIF   
        ENDIF
   ENDPROC
     **********查看庫存明細
  PROC INV_BOTT.CLICK
       IF !USED('B1A')
           SELECT 0
           USE B1A
       ELSE
          SELECT B1A
       ENDIF
      SET ORDER TO 1   
	  THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(128,128,128),'COMMANDBUTTON')
         THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(128,128,128),'COMMANDBUTTON')
         THISFORM.ANS_BOTT.FORECOLOR=RGB(128,128,128)
         THISFORM.CNL_BOTT.FORECOLOR=RGB(128,128,128)
         
         THISFORM.INV_BOTT.FORECOLOR=RGB(128,128,128)
         THISFORM.IODT_BOTT.FORECOLOR=RGB(128,128,128)
         SELE B11.F01,B11.F03,A14.F02,B11.F04,B11.F05,B11.F06,B11.F08 FROM B11,A14 WHERE B11.F01<>INT_190 AND B11.F03=P06.F02 AND A14.F01=B11.F01  INTO CURSOR INV ORDER BY B11.F01
         INV_SEEK=CREATEOBJECT("INV_SEEK")  
         INV_SEEK.SHOW 
         AREA1='P05'
         SELECT &AREA2
         THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
         THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON') 
         THISFORM.ANS_BOTT.FORECOLOR=RGB(0,0,0)   
         THISFORM.CNL_BOTT.FORECOLOR=RGB(0,0,0)
        
         THISFORM.INV_BOTT.FORECOLOR=RGB(0,0,0)
         THISFORM.IODT_BOTT.FORECOLOR=RGB(0,0,0)
         THISFORM.GRID2.SETFOCUS
  ENDPROC   
*********************************查看預期異動
  PROC IODT_BOTT.CLICK
            LK=THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
            LV=THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE              
            SELE F01,F02,F03,F04 FROM D07 WHERE F02=LK  INTO CURSOR TKE081 ORDER BY F03,F01    
            SELE F01,F02,F03,F04 FROM C05 WHERE !EMPTY(C05.F15) AND C05.F02=LK INTO CURSOR TKE082 ORDER BY F03,F01       
            SELE F01,F02,F03,F04 FROM E06 WHERE F02=LK INTO CURSOR TKE083 ORDER BY F03,F01            
            SELE F01,F02,F03,F04 FROM E16 WHERE F02=LK INTO CURSOR TKE084 ORDER BY F03,F01
            CREATE CURSOR TKE08 (F01 C(12),F02 C(43),F03 D(8),F04 N(13,4))
            INDEX ON F02+DTOS(F03)+F01 TAG TKE08
            SET ORDER TO 1
            SELECT  TKE081
            GO TOP
            IDEN=0
            DO WHILE !EOF()
               SELE TKE08
               APPEND BLANK
               REPLACE  F01 WITH ALLTRIM(TKE081.F01)+IIF(IDEN>0,CHR(IDEN),'')
               REPLACE  F02 WITH TKE081.F02
               REPLACE  F03 WITH TKE081.F03
               REPLACE  F04 WITH TKE081.F04
               SELECT  TKE081
               SKIP
               IF LEFT(TKE08.F01,10)=F01
                  IDEN=IDEN+1
               ELSE
                  IDEN=0
               ENDIF
            ENDDO
            SELECT  TKE081
            USE
            SELECT  TKE082
            GO TOP
            DO WHILE !EOF()
               SELECT  TKE08
               APPEND BLANK
               REPLACE  F01 WITH TKE082.F01
               REPLACE  F02 WITH TKE082.F02
               REPLACE  F03 WITH TKE082.F03
               REPLACE  F04 WITH TKE082.F04*(-1)
               SELECT  TKE082
               SKIP
           ENDDO             
           SELE TKE082
           USE
            SELECT  TKE083
            GO TOP
            DO WHILE !EOF()
               SELECT  TKE08
               APPEND BLANK
               REPLACE  F01 WITH TKE083.F01
               REPLACE  F02 WITH TKE083.F02
               REPLACE  F03 WITH TKE083.F03
               REPLACE  F04 WITH TKE083.F04
               SELECT  TKE083
               SKIP
           ENDDO             
           SELE TKE083
           USE           
            SELECT  TKE084
            GO TOP
            DO WHILE !EOF()
               SELECT  TKE08
               APPEND BLANK
               REPLACE  F01 WITH TKE084.F01
               REPLACE  F02 WITH TKE084.F02
               REPLACE  F03 WITH TKE084.F03
               REPLACE  F04 WITH TKE084.F04*(-1)
               SELECT  TKE084
               SKIP
           ENDDO             
           SELE TKE084
           USE           
           SELECT TKE08
           SET ORDER TO 1
           GO TOP             
            
            
            SELE D07.F01,D07.F03,D07.F04,D07.F05,D07.F07,D07.F09 FROM D07 WHERE D07.F02=LK INTO CURSOR IODT1 ORDER BY D07.F03,D07.F01 &&NOWAIT&&
            SELE C05.F01,C05.F03,C05.F04,C05.F06,C05.F09 FROM C05 WHERE C05.F02=LK AND !EMPTY(C05.F15)  INTO CURSOR IODT2  ORDER BY C05.F03,C05.F01 &&NOWAIT&&
            SELE E06.F01,E06.F03,E06.F04,E06.F05,E06.F07,E06.F09 FROM E06 WHERE E06.F02=LK INTO CURSOR IODT3 ORDER BY E06.F03,E06.F01 &&NOWAIT&&                        
            SELE E16.F01,E16.F03,E16.F04,E16.F06,E16.F09 FROM E16 WHERE E16.F02=LK INTO CURSOR IODT4 ORDER BY E16.F03,E16.F01 &&NOWAIT&&         
            CREATE CURSOR IODT(F01 C(12),F03 D(8),F04 N(13,3),F08 N(13,3),F05 C(50))
            INDE ON DTOS(F03)+F01 TAG IODT
            SET ORDER TO 1
            SELE IODT1
            GO TOP
            IDEN=0
            DO WHILE !EOF()
               SELE IODT
               APPEND BLANK
               REPL F01 WITH ALLTRIM(IODT1.F01)+IIF(IDEN>0,CHR(IDEN),'')
               REPL F03 WITH IODT1.F03
               REPL F04 WITH IODT1.F04
               REPL F05 WITH '採:'+IODT1.F05+PADL(IIF(SEEK(IODT1.F05,'D01'),D01.F04,''),8,' ')+IIF(IODT1.F09='1','  ','><')+IIF(!EMPTY(IODT1.F07),'請:','')+IODT1.F07
               SELE IODT1
               SKIP
               IF LEFT(IODT.F01,10)=F01
                  IDEN=IDEN+1
               ELSE
                  IDEN=0                 
               ENDIF
            ENDDO   
            USE
            SELE IODT2
            GO TOP
            DO WHILE !EOF()
               SELE IODT
               APPEND BLANK
               REPL F01 WITH IODT2.F01
               REPL F03 WITH IODT2.F03
               REPL F04 WITH IODT2.F04*(-1)
               REPL F05 WITH '出:'+IODT2.F06+IIF(SEEK(IODT2.F06,'C01'),C01.F05,' ')+'  單:'+IODT2.F09 
               SELE IODT2
               SKIP
            ENDDO   
            USE
            SELE IODT3
            GO TOP
            DO WHILE !EOF()
               SELE IODT
               APPEND BLANK
               REPL F01 WITH IODT3.F01
               REPL F03 WITH IODT3.F03
               REPL F04 WITH IODT3.F04
               REPL F05 WITH '產:'+IODT3.F05+PADL(IIF(SEEK(IODT3.F05,'A14'),A14.F02,''),8,' ')+IIF(IODT3.F09='1','  ','><')+'出:'+IODT3.F07+IIF(SEEK(IODT3.F07,'C01'),C01.F05,'')
               SELE IODT3
               SKIP
            ENDDO   
            USE
            SELE IODT4
            GO TOP
            DO WHILE !EOF()
               SELE IODT
               APPEND BLANK
               REPL F01 WITH IODT4.F01
               REPL F03 WITH IODT4.F03
               REPL F04 WITH IODT4.F04*(-1)
               REPL F05 WITH '領:'+IODT4.F06+IIF(SEEK(IODT4.F06,'A14'),A14.F02,' ')+'  成:'+IODT4.F09          
               SELE IODT4
               SKIP
            ENDDO       
            USE                             
            ORD_NO=P05.F06 &&訂單號碼
            STD_NO=LK &&料號
            DTE_NO=LV &&希望交期  
            SELECT IODT 
            SET ORDER TO 1
            GO TOP
            IF _TALLY>0 
                IODT_SEEK=CREATEOBJECT("IODT_SEEK")  
                IODT_SEEK.SHOW  
                SELECT TKE08
                USE
	        ELSE
	          =MESSAGEBOX('無此料品之預期異動',0+48,'提示訊息視窗')
	        ENDIF          
            AREA1='P05' 
            SELECT P06
           THISFORM.GRID2.SETFOCUS    
  **********  
ENDDEFINE    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=P05.F01     
     SELECT P06.F01,;
            P06.F02,;
            P06.F03,;
            P06.F04,;
            P06.F05,;           
            P05.F02,;
            P05.F04,;                    
            P05.F05,;
            P05.F06,;
            P05.F07,;
            P05.F10,;
            P05.F11,;
            P05.F12,;
            A01.F03,;
            B01.F02,;
            B01.F01,;
            B01.F07;
     FROM P06,P05,A01,B01 WHERE P06.F01=LK AND P05.F01=LK AND A01.F01=P05.F07 AND B01.F01=P06.F02 ;
     ORDER BY P06.F02 NOWAIT
     IF _TALLY >0
*	      REPORT FORM ALLTRIM(INT_116)+'P03' PREVIEW
        REPORT FORM ALLTRIM(INT_116)+'P03' TO PRINTER PROMPT     
     ENDIF  
ENDPROC
************************************************特殊輸入欄位的設定----料號    
DEFINE CLASS TXTF02 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
         CHK_IN='0'
         PR_NO='1'
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.        
              IF THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE = '1' &&需求類別為訂單 
                   IF USED('OPT')=.T.
                       SELECT OPT 
                       USE
                   ENDIF               
                   SELECT F02,F07 FROM P06 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F02,F07 INTO CURSOR P06_TEMP
                   SELECT  0,C05.F01,C05.F02,SUM(C05.F04-C05.F05),C03.F05 FROM C05,C03  ;
                                  WHERE C05.F06+C05.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+;
                                  THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND C03.F02=C05.F01;
                                 AND (C05.F04-C05.F05)>0 GROUP BY C05.F01,C05.F02 ORDER BY C05.F01,C05.F02 INTO CURSOR OPT READWRITE                 
                   ALTER TABLE OPT ADD P06_F04  N(11,2)
                   ALTER TABLE OPT ADD P06_F05  D(8)     
                   INDE ON F01+F02 TAG OPT_1            
                   SELECT OPT
                   SET ORDER TO OPT_1
	           SELECT P06_TEMP
	           GO TOP
	           DO WHILE !EOF()             
	                  SELECT OPT
	                  SEEK P06_TEMP.F07+P06_TEMP.F02
	                  IF FOUND()
	                      DELETE 
	                  ENDIF
	                  SELECT P06_TEMP
	                  SKIP
	            ENDDO
	            SELECT P06_TEMP
	            USE
	            SELECT OPT
	            GO TOP
		    IF !EMPTY(OPT.F02)
                         OPT_SEEK=CREATEOBJECT("OPT_SEEK")  
                         OPT_SEEK.SHOW  	    
                         THIS.REFRESH
                         SELECT OPT 
                         CALC SUM(EXP_1) TO NO                            
                         DO CASE
	                        CASE NO = 1 AND CHK_IN = '1'	    
	                           	   SELECT * FROM OPT WHERE OPT.EXP_1 <> 0 ORDER BY OPT.F01,OPT.F02 INTO CURSOR OPT_TEMP
	                           	   SELECT OPT_TEMP
	                           	   THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE = OPT_TEMP.F02
				           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE = MIN(OPT_TEMP.SUM_EXP_4,IIF(SEEK(OPT_TEMP.F01+OPT_TEMP.F02,'C04','C041'),C04.F05-C04.F11,0))
				           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE = OPT_TEMP.P06_F04
				           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE = OPT_TEMP.P06_F05       
				           THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION = IIF(SEEK(OPT_TEMP.F02,'B01'),B01.F02,'')                    	   
	                           	   SELECT OPT_TEMP
	                           	   USE
	                        CASE NO >= 1 AND CHK_IN = '1'
	                           	   SELECT * FROM OPT WHERE OPT.EXP_1 <> 0 AND OPT.P06_F04 > 0 ORDER BY OPT.F01,OPT.F02 INTO CURSOR OPT_TEMP
	                           	   SELECT OPT_TEMP	         
	                           	   GO TOP
	                           	   DO WHILE !EOF()    
	                           	          IF   SEEK(OPT_TEMP.F02,'B01') = .T.   AND  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OPT_TEMP.F02,'P06') = .F. AND ;   
	                           	                IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+OPT_TEMP.F02,'C04','C041'),(C04.F05-C04.F09-C04.F21-C04.F23)-C04.F11,1) > 0
	                           	                SELECT C04
	                           	                SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+OPT_TEMP.F02
	                           	                IF FOUND()
	                           	                     RLOCK()
						             LL1=RLOCK()
						        ELSE
						             LL1=.T.
						        ENDIF
						        SELE C03
						        SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
						        IF FOUND()
						            RLOCK()
						            LL2=RLOCK()
						        ELSE
						            LL2=.T.
						        ENDIF   		
						        IF  LL1 AND LL2 = .T.  
						             SELECT C04
						             SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE + OPT_TEMP.F02
						             IF FOUND()
						                 REPLACE  C04.F11 WITH IIF(OPT_TEMP.P06_F04 + C04.F11 > (C04.F05 - C04.F09 - C04.F21 - C04.F23),C04.F05 - C04.F09 - C04.F21 - C04.F23,C04.F11 + OPT_TEMP.P06_F04)
						             ENDIF
						             SELECT C03
						             SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE 
						             IF FOUND()
						                 REPLACE  C03.F11 WITH C03.F11 + 1
						             ENDIF
	                           	                     SELECT P06
	                           	                     APPEND BLANK
	                           	                     LOCK()
	                           	                     IF RLOCK()
	                           	                         REPLACE P06.F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
	                           	                         REPLACE P06.F02 WITH OPT_TEMP.F02
	                           	                         REPLACE P06.F03 WITH MIN(OPT_TEMP.SUM_EXP_4,IIF(SEEK(OPT_TEMP.F01+OPT_TEMP.F02,'C04','C041'),C04.F05-C04.F11,0))
	                           	                         REPLACE P06.F04 WITH OPT_TEMP.P06_F04
	                           	                         REPLACE P06.F05 WITH OPT_TEMP.P06_F05
	                           	                         REPLACE P06.F06 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	                           	                         REPLACE P06.F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE 
	                           	                     ENDIF    
	                           	                ENDIF 
	                           	                UNLOCK ALL     
	                           	          ENDIF
	                           	          SELECT OPT_TEMP
	                           	          SKIP      
	                           	   ENDDO
	                           	   SELECT OPT_TEMP
	                           	   USE
	                           	   THISFORM.GRID2.ENABLED=.T.
			                   THISFORM.GRID2.SETFOCUS  
			                   THISFORM.GRID2.ENABLED=.F.  	                           	   
	                           	   THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE = ''
				           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE = 0
				           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE = 0
				           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE = CTOD('')
				           THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION = ''        	      
	                 ENDCASE    
	                 THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS 
	            ELSE
	                  =MESSAGEBOX('此需求單位之需求單號 '+THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+'在C05.出貨計畫中已無計畫,請查明後再輸入',0+64,'提示訊息視窗')
	                  THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS 
	                  RETURN
	            ENDIF    
	             ************
	      ELSE			&&需求預估與廠內需求
		     IF AT('?',ALLTRIM(THIS.VALUE))>1             
		          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE RIGHT(F98,1)='*' AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
		     ELSE
		          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE RIGHT(F98,1)='*'   
		     ENDIF 
		     SELECT MTR 
		     GO TOP
		     IF _TALLY>0  
		         MTR_SEEK=CREATEOBJECT("MTR_SEEK")  
		         MTR_SEEK.SHOW    
		         THIS.VALUE=FLG
		         THIS.REFRESH
		         FLG='0'        
		     ENDIF    
		     THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'') 
       	     THISFORM.PAGEFRAME1.PAGE2.LBLFC20F03.CAPTION=IIF(SEEK(THIS.VALUE,'C20'),'包裝基量：' + ALLTRIM(TRANSFORM(VAL(C20.F03),"@R 999,999,999")),'')
       	     THISFORM.PAGEFRAME1.PAGE2.LBLFC20F11.CAPTION=IIF(SEEK(THIS.VALUE,'C20'),'包裝數量：' + ALLTRIM(TRANSFORM(C20.F11,"@R 99,999,999,999")),'')
       	     THISFORM.PAGEFRAME1.PAGE2.LBLFC20F15.CAPTION=IIF(SEEK(THIS.VALUE,'C20'),'最小訂購：' + ALLTRIM(TRANSFORM(C20.F15,"@R 99,999,999,999")),'')
	       ENDIF        
	ENDIF  
   ENDPROC	  
   *****             
  PROCEDURE INTERACTIVECHANGE
    CHK_IN='0'
    PR_NO='1'
    IF THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE='1'
         IF USED('OPT')=.T.
             SELECT OPT 
             USE
        ENDIF  
         IF AT('?',ALLTRIM(THIS.VALUE))<>0
              IF AT('?',ALLTRIM(THIS.VALUE))>1             
                   SELECT  0,C05.F01,C05.F02,SUM(C05.F04-C05.F05),C03.F05 FROM C05,C03 ;
                   WHERE C05.F06+C05.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+;
                   THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND C03.F02=C05.F01;
                   AND (C05.F04-C05.F05)>0 AND LEFT(C05.F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) ;
                   GROUP BY C05.F01,C05.F02 ORDER BY C05.F01,C05.F02  INTO CURSOR OPT READWRITE 
              ELSE
                   SELECT 0,C05.F01,C05.F02,SUM(C05.F04-C05.F05),C03.F05 FROM C05,C03 ;
                   WHERE C05.F06+C05.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE+;
                   THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE AND C03.F02=C05.F01;
                   AND (C05.F04-C05.F05)>0  GROUP BY C05.F01,C05.F02 ORDER BY C05.F01,C05.F02 INTO CURSOR OPT READWRITE 
              ENDIF 
              SELECT OPT
              ALTER TABLE OPT ADD P06_F04  N(11,2)
              ALTER TABLE OPT ADD P06_F05  D(8)                
              INDE ON F01+F02 TAG OPT_1            
              SELECT OPT
              SET ORDER TO OPT_1
              SELECT F02,F07 FROM P06 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F02,F07 INTO CURSOR P06_TEMP
	      SELECT P06_TEMP
	      GO TOP
	      DO WHILE !EOF()                    
	             SELECT OPT
	             SEEK P06_TEMP.F07+P06_TEMP.F02
	             IF FOUND()
	                  DELETE 
	             ENDIF
	             SELECT P06_TEMP
	             SKIP
	       ENDDO
	       SELECT P06_TEMP
	       USE
	       SELECT OPT
	       GO TOP
	       IF !EMPTY(OPT.F02)	     
                    OPT_SEEK=CREATEOBJECT("OPT_SEEK")  
                    OPT_SEEK.SHOW    
                   THIS.REFRESH
                   SELECT OPT 
                   CALC SUM(EXP_1) TO NO                            
                   DO CASE
	                 CASE NO = 1 AND CHK_IN = '1'	    
	                      	   SELECT * FROM OPT WHERE OPT.EXP_1 <> 0 ORDER BY OPT.F01,OPT.F02 INTO CURSOR OPT_TEMP
	                       	   SELECT OPT_TEMP
	                       	   THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE = OPT_TEMP.F02
			           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE = MIN(OPT_TEMP.SUM_EXP_4,IIF(SEEK(OPT_TEMP.F01+OPT_TEMP.F02,'C04','C041'),C04.F05-C04.F11,0))
			           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE = OPT_TEMP.P06_F04
			           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE = OPT_TEMP.P06_F05       
			           THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION = IIF(SEEK(OPT_TEMP.F02,'B01'),B01.F02,'')                    	   
	                      	   SELECT OPT_TEMP
	                      	   USE
	                CASE NO >= 1 AND CHK_IN = '1'
	                       	   SELECT * FROM OPT WHERE OPT.EXP_1 <> 0 AND OPT.P06_F04 > 0 ORDER BY OPT.F01,OPT.F02 INTO CURSOR OPT_TEMP
	                       	   SELECT OPT_TEMP	         
	                       	   GO TOP
                           	   DO WHILE !EOF()    
                           	          IF   SEEK(OPT_TEMP.F02,'B01') = .T.   AND  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OPT_TEMP.F02,'P06') = .F. AND ;   
                           	                IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+OPT_TEMP.F02,'C04','C041'),(C04.F05-C04.F09-C04.F21-C04.F23)-C04.F11,1) > 0
                           	                SELECT C04
                           	                SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+OPT_TEMP.F02
                           	                IF FOUND()
                           	                     RLOCK()
					             LL1=RLOCK()
					        ELSE
					             LL1=.T.
					        ENDIF
					        SELE C03
					        SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
					        IF FOUND()
					            RLOCK()
					            LL2=RLOCK()
					        ELSE
					            LL2=.T.
					        ENDIF   		
					        IF  LL1 AND LL2 = .T.  
					             SELECT C04
					             SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE + OPT_TEMP.F02
					             IF FOUND()
					                 REPLACE  C04.F11 WITH IIF(OPT_TEMP.P06_F04 + C04.F11 > (C04.F05 - C04.F09 - C04.F21 - C04.F23),C04.F05 - C04.F09 - C04.F21 - C04.F23,C04.F11 + OPT_TEMP.P06_F04)
					             ENDIF
					             SELECT C03
					             SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE 
					             IF FOUND()
					                 REPLACE  C03.F11 WITH C03.F11 + 1
					             ENDIF
                           	                     SELECT P06
                           	                     APPEND BLANK
                           	                     LOCK()
                           	                     IF RLOCK()
                           	                         REPLACE P06.F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                           	                         REPLACE P06.F02 WITH OPT_TEMP.F02
                           	                         REPLACE P06.F03 WITH MIN(OPT_TEMP.SUM_EXP_4,IIF(SEEK(OPT_TEMP.F01+OPT_TEMP.F02,'C04','C041'),C04.F05-C04.F11,0))
                           	                         REPLACE P06.F04 WITH OPT_TEMP.P06_F04
                           	                         REPLACE P06.F05 WITH OPT_TEMP.P06_F05
                           	                         REPLACE P06.F06 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                           	                         REPLACE P06.F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE 
                           	                     ENDIF    
                           	                ENDIF 
                           	                UNLOCK ALL     
                           	          ENDIF
                           	          SELECT OPT_TEMP
                           	          SKIP      
                           	   ENDDO
                           	   SELECT OPT_TEMP
                           	   USE
                           	   THISFORM.GRID2.ENABLED=.T.
		                   THISFORM.GRID2.SETFOCUS  
		                   THISFORM.GRID2.ENABLED=.F.  	                           	   
                           	   THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE = ''
			           THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE = 0
			           THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE = 0
			           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE = CTOD('')
			           THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION = ''        	      
                   ENDCASE    
                   THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS 
              ELSE
                   =MESSAGEBOX('此需求單位之需求單號 '+THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+'在C05.出貨計畫中已無計畫,請查明後再輸入',0+64,'提示訊息視窗')
                   THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS 
                    RETURN
              ENDIF    
         ENDIF    
***
    ELSE &&需求預估與廠內需求
          IF AT('?',ALLTRIM(THIS.VALUE))<>0
              IF AT('?',ALLTRIM(THIS.VALUE))>1             
                  SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE RIGHT(F98,1)='*' AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
             ELSE
                  SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE RIGHT(F98,1)='*'   
              ENDIF 
              IF _TALLY>0  
                   MTR_SEEK=CREATEOBJECT("MTR_SEEK")  
                   MTR_SEEK.SHOW    
                   THIS.VALUE=FLG
                   THIS.REFRESH
                   FLG='0'        
               ENDIF    
          ENDIF  
          THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')  
       	  THISFORM.PAGEFRAME1.PAGE2.LBLFC20F03.CAPTION=IIF(SEEK(THIS.VALUE,'C20'),'包裝基量：' + ALLTRIM(TRANSFORM(VAL(C20.F03),"@R 999,999,999")),'')
       	  THISFORM.PAGEFRAME1.PAGE2.LBLFC20F11.CAPTION=IIF(SEEK(THIS.VALUE,'C20'),'包裝數量：' + ALLTRIM(TRANSFORM(C20.F11,"@R 99,999,999,999")),'')
       	  THISFORM.PAGEFRAME1.PAGE2.LBLFC20F15.CAPTION=IIF(SEEK(THIS.VALUE,'C20'),'最小訂購：' + ALLTRIM(TRANSFORM(C20.F15,"@R 99,999,999,999")),'')
     ENDIF
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------對象
DEFINE CLASS TXTF04 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
*!*	     DO CASE
*!*	        CASE THISFORM.PAGEFRAME1.PAGE1.RQRMNT_TYPE.VALUE<>2 
             IF AT('?',ALLTRIM(THIS.VALUE))<>0 
                IF AT('?',ALLTRIM(THIS.VALUE))>1             
                   SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
                ELSE
                  SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
                ENDIF          
                VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                VDR_SEEK.SHOW    
                THIS.VALUE=FLG
                THIS.REFRESH
                FLG='0'        
             ELSE
                IF LEN(ALLTRIM(THIS.VALUE))=4
                   SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
                   DO CASE
                      CASE _TALLY=1
                           THIS.VALUE=VDR.F01
                           THIS.REFRESH
                      CASE _TALLY>1
                           VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                           VDR_SEEK.SHOW    
                           THIS.VALUE=FLG
                           THIS.REFRESH
                           FLG='0'        
                    ENDCASE      
                ENDIF
             ENDIF      
            THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F05,'')  
*!*	        CASE THISFORM.PAGEFRAME1.PAGE1.RQRMNT_TYPE.VALUE=2
*!*	            IF AT('?',ALLTRIM(THIS.VALUE))<>0
*!*	               IF AT('?',ALLTRIM(THIS.VALUE))>1             
*!*	                  SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND LEN(ALLTRIM(F01))=4 AND F04='*'
*!*	               ELSE
*!*	                  SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEN(ALLTRIM(F01))=4 AND F04='*'
*!*	               ENDIF   
*!*	               DEPART_SEEK=CREATEOBJECT("DEPART_SEEK")  
*!*	               DEPART_SEEK.SHOW    
*!*	               THIS.VALUE=FLG
*!*	               THIS.REFRESH
*!*	              FLG='0'
*!*	            ENDIF   
*!*	            THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')          
*!*	     ENDCASE        
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------請購人員
DEFINE CLASS TXTF07 AS TEXTBOX
   READONLY=.T.
   MAXLENGTH=5
   FONTSIZE=INT_015*9   
   PROCEDURE INTERACTIVECHANGE
     IF AT('?',ALLTRIM(THIS.VALUE))<>0
        IF AT('?',ALLTRIM(THIS.VALUE))>1             
           SELECT F01,F03 FROM A01 INTO CURSOR MAN ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
        ELSE
           SELECT F01,F03 FROM A01 INTO CURSOR MAN ORDER BY F01    
        ENDIF   
        VDR_SEEK=CREATEOBJECT("MAN_SEEK")  
        VDR_SEEK.SHOW    
        THIS.VALUE=FLG
        THIS.REFRESH
        FLG='0'        
     ENDIF  
      THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(THIS.VALUE,'A01'),A01.F03,'')  
  ENDPROC
ENDDEFINE
***************************************************特殊欄位-----------------訂單號碼
DEFINE CLASS TXTF06 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=10
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       DO CASE
          CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE))                   
               SELECT C05.F01,C05.F06,C01.F05 FROM C05,C01  GROUP BY C05.F01 INTO CURSOR OQT; 
               ORDER BY C05.F01 WHERE C01.F01=C05.F06; 
               AND LEFT(C05.F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
               AND (C05.F04-C05.F05)>0
          CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE))                   
               SELECT C05.F01,C05.F06,C01.F05 FROM C05,C01 GROUP BY C05.F01 INTO CURSOR OQT; 
               ORDER BY C05.F01 WHERE C01.F01=C05.F06 ; 
               AND LEFT(C05.F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
               AND (C05.F04-C05.F05)>0 AND F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE              
          CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE))                   
               SELECT C05.F01,C05.F06,C01.F05 FROM C05,C01 GROUP BY C05.F01 INTO CURSOR OQT ORDER BY C05.F01;
                WHERE C01.F01=C05.F06;
               AND (C05.F04-C05.F05)>0 
          CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE))                   
               SELECT C05.F01,C05.F06,C01.F05 FROM C05,C01 GROUP BY C05.F01 INTO CURSOR OQT ORDER BY C05.F01; 
               WHERE C01.F01=C05.F06;
               AND (C05.F04-C05.F05)>0 AND C05.F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE              
       ENDCASE 
       IF _TALLY>0  
          OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
          OQT_SEEK.SHOW    
          IF LEN(ALLTRIM(FLG))>1
             THIS.VALUE=FLG
             THIS.REFRESH                    
             THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=CHK_STR
             THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(CHK_STR,'C01'),C01.F05,'')
             FLG='0'           
             CHK_STR=''
             QTY=0    
          ENDIF   
       ENDIF    
    ENDIF  

  ENDPROC     
ENDDEFINE
***************************************************需求類別設定
DEFINE CLASS RQRMNT AS COMBOBOX
  HEIGHT=INT_015*25
  FONTSIZE=INT_015*9  
  AUTOSIZE=.T.
  TOP=INT_015*59
  LEFT=INT_015*65
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*90
  ROWSOURCETYPE=1
  STYLE=2
  NAME='RQRMNT'
  PROCEDURE INIT
     WITH THIS 
         .ADDITEM('1.客戶訂單')
         .ADDITEM('2.廠內需求')
         .ADDITEM('3.需求預估')         
         .VALUE=1
     ENDWITH        
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    DO CASE
       CASE THIS.VALUE=1
            THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.
            THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.F.
            THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''    
            THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
       CASE THIS.VALUE=2
            THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.
            THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.            
            THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''                
            THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE='廠內耗用'
       CASE THIS.VALUE=3
            THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.
            THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
            THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
            THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.            
            THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE='計劃需求'
    ENDCASE                     
    THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
    THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=ALLTRIM(STR(THIS.VALUE))
    THISFORM.PAGEFRAME1.PAGE1.TXTF03.REFRESH
    THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(THIS.VALUE=1,'客戶訂單',IIF(THIS.VALUE=2,'廠內耗用','需求預估'))
  ENDPROC
ENDDEFINE 
***************************************************入貨方式設定
DEFINE CLASS TRANSPORT AS COMBOBOX
  HEIGHT=INT_015*25
  FONTSIZE=INT_015*9  
  TOP=INT_015*34
  LEFT=INT_015*370
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*66
  ROWSOURCETYPE=1
  STYLE=2
  NAME='TRANSPORT'
  PROCEDURE INIT
     WITH THIS 
         .ADDITEM('海運')
         .ADDITEM('空運')
         .ADDITEM('快遞')   
         .ADDITEM('自取')
         .ADDITEM('直寄')      
         .VALUE=1
     ENDWITH        
  ENDPROC
  PROCEDURE INTERACTIVECHANGE              
    THISFORM.PAGEFRAME1.PAGE1.TXTF11.VALUE=ALLTRIM(STR(THIS.VALUE))
    THISFORM.PAGEFRAME1.PAGE1.TXTF11.REFRESH
  ENDPROC
ENDDEFINE   
***************************************訂單號碼
DEFINE CLASS OQT_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='出貨計劃'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*320
  WIDTH=INT_015*280
  FONTSIZE=INT_015*9  
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OQT_SEEK'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*290,;
      LEFT=INT_015*10
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      WIDTH=INT_015*280,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=3,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3'
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*183,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選取此筆資料!快速鍵->ALT+S'
      NAME='CMND2'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*225,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<C.放棄',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='OQT' 
        SELE OQT
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.RECORDSOURCE='OQT'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.         
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='訂單號碼'
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OQT.F01'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶代號'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F06'         
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='客戶簡稱'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F05'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*85
         THISFORM.GRID1.SETFOCUS
         IF THISFORM.GRID1.ACTIVEROW<>0
              THISFORM.GRID1.AFTERROWCOLCHANGE 
         ENDIF         
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
           FCH='GRID1'
           FLG=OQT.F01         
           CHK_STR=OQT.F06           
      ENDPROC 
      PROCEDURE CMND1.CLICK            
          AREA1='P05'
          THISFORM.RELEASE                                            
      ENDPROC
      PROCEDURE CMND2.CLICK
          FLG='0'
          CHK_STR=''
          AREA1='P05'
         THISFORM.RELEASE
      ENDPROC    
ENDDEFINE            
********************************************************************料號 
DEFINE CLASS OPT_SEEK AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION=P05.F04+' '+ALLTRIM(P05.F05)+'  需求單號： '+P05.F06+' 之C05.出貨計劃'
  TOP=INT_015*110
  LEFT=INT_015*100      
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*325
  WIDTH=INT_015*623
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OPT_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      WIDTH=INT_015*620,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=6,;            
      RECORDSOURCE='OPT',; 
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;    
      COLUMN6.NAME='COLUMN6'     
  ADD OBJECT LBLFA AS LABEL WITH;
      AUTOSIZE=.T.,;
      VISIBLE= .F.,;
      LEFT=INT_015*410,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*302,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='需求日期不得小於計畫需求日期',;
      BACKCOLOR=RGB(255,255,0),;
      NAME='LBLFA'         
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*230,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.確定',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*320,;
      TOP=INT_015*297,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*50,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;  
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.全選',;
      TOOLTIPTEXT='全選所有資料!快速鍵->ALT+A'
      NAME='CMND3'
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*130,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.清除',;
      TOOLTIPTEXT='清除已全選之資料!快速鍵->ALT+C'
      NAME='CMND4'   
      PROCEDURE INIT 
         SELECT  OPT
         SET ORDER TO OPT_1
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')    
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN')      
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')                           
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')             
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION=''
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*20
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OPT.EXP_1'            
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料        號'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*270
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OPT.F02'
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='計畫需求數量'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE="MIN(OPT.SUM_EXP_4,IIF(SEEK(OPT.F01+OPT.F02,'C04','C041'),C04.F05-C04.F11,0))"
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*75
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='計畫需求日期'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='OPT.F05'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75         
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='請購數量'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='OPT.P06_F04'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*75
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='需求日期'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='OPT.P06_F05'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*75
         THISFORM.GRID1.SETFOCUS        
      ENDPROC
      ***
      PROC GRID1.INIT      
	 THISFORM.GRID1.COLUMN1.READONLY=.F.
	 THISFORM.GRID1.COLUMN2.READONLY=.T.
	 THISFORM.GRID1.COLUMN3.READONLY=.T.
	 THISFORM.GRID1.COLUMN4.READONLY=.T.
	 THISFORM.GRID1.COLUMN5.READONLY=.F.
	 THISFORM.GRID1.COLUMN6.READONLY=.F.
	 THISFORM.GRID1.COLUMN5.HEADER1.BACKCOLOR=RGB(128,255,0)
	 THISFORM.GRID1.COLUMN6.HEADER1.BACKCOLOR=RGB(128,255,0)
	 THISFORM.GRID1.COLUMN1.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN1.AddObject("CheckBox1","CheckBox1") 
	 THISFORM.GRID1.COLUMN1.CurrentControl="CheckBox1" 
	 THISFORM.GRID1.COLUMN1.Sparse=.F.
	 THISFORM.GRID1.COLUMN1.CheckBox1.Visible=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CAPTION=''
	 THISFORM.GRID1.COLUMN1.CheckBox1.AUTOSIZE=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CENTERED=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.BACKSTYLE=0
	 THISFORM.GRID1.COLUMN1.CheckBox1.LEFT=5
	 THISFORM.GRID1.COLUMN5.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN5.AddObject("TEXTBOX1","TEXTBOX1") 
	 THISFORM.GRID1.COLUMN5.CurrentControl="TEXTBOX1" 
	 THISFORM.GRID1.COLUMN5.Sparse=.F.	
	 THISFORM.GRID1.COLUMN5.TEXTBOX1.Visible=.T.      
	 THISFORM.GRID1.COLUMN6.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN6.AddObject("TEXTBOX2","TEXTBOX2") 
	 THISFORM.GRID1.COLUMN6.CurrentControl="TEXTBOX2" 
	 THISFORM.GRID1.COLUMN6.Sparse=.F.	
	 THISFORM.GRID1.COLUMN6.TEXTBOX2.Visible=.T. 	 
      ENDPROC
      ***      
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
           FCH='GRID1'
      ENDPROC 
      PROCEDURE CMND1.CLICK            
            SELECT OPT
            CHK_IN='1'
           THISFORM.RELEASE                                            
      ENDPROC
      PROCEDURE CMND2.CLICK
           CHK_IN='0' 
           THISFORM.RELEASE
      ENDPROC    
 **
 PROCEDURE CMND3.CLICK     
      SELECT OPT
      RE=RECNO('OPT')
      GO TOP
      DO WHILE !EOF()
	     REPLACE OPT.EXP_1 WITH 1 
             REPLACE OPT.P06_F04 WITH MIN(OPT.SUM_EXP_4,IIF(SEEK(OPT.F01+OPT.F02,'C04','C041'),C04.F05-C04.F11,0))
             REPLACE OPT.P06_F05 WITH OPT.F05      
	     SELECT OPT
	     SKIP
      ENDDO
      SELECT OPT
      GO RE  
      THISFORM.GRID1.SETFOCUS 
 ENDPROC      
  PROCEDURE CMND4.CLICK
      SELECT OPT
      RE=RECNO('OPT')
      GO TOP
      DO WHILE !EOF()
             REPLACE OPT.EXP_1 WITH 0 
             REPLACE OPT.P06_F04 WITH 0
             REPLACE OPT.P06_F05 WITH  CTOD('')   
             SELECT OPT
             SKIP
      ENDDO
      SELECT OPT
      GO RE
      THISFORM.GRID1.SETFOCUS 
 ENDPROC  
  PROC CMND1.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND1.TOP=INT_015*298
             THISFORM.CMND1.LEFT=INT_015*231
  ENDPROC     
  PROC CMND1.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND1.TOP=INT_015*297
             THISFORM.CMND1.LEFT=INT_015*230                  
  ENDPROC  
  PROC CMND2.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND2.TOP=INT_015*298
             THISFORM.CMND2.LEFT=INT_015*321
  ENDPROC     
  PROC CMND2.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND2.TOP=INT_015*297
             THISFORM.CMND2.LEFT=INT_015*320                  
  ENDPROC  
  PROC CMND3.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND3.TOP=INT_015*298
             THISFORM.CMND3.LEFT=INT_015*51
  ENDPROC     
  PROC CMND3.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND3.TOP=INT_015*297
             THISFORM.CMND3.LEFT=INT_015*50                  
  ENDPROC   
  PROC CMND4.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND4.TOP=INT_015*298
             THISFORM.CMND4.LEFT=INT_015*131
  ENDPROC     
  PROC CMND4.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND4.TOP=INT_015*297
             THISFORM.CMND4.LEFT=INT_015*130                  
  ENDPROC    
ENDDEFINE 
*********     
DEFINE CLASS CheckBox1 AS CheckBox
      PROCEDURE CLICK
         SELECT OPT
         IF THIS.VALUE=1
              REPLACE OPT.EXP_1 WITH 1
              REPLACE OPT.P06_F04 WITH MIN(OPT.SUM_EXP_4,IIF(SEEK(OPT.F01+OPT.F02,'C04','C041'),C04.F05-C04.F11,0))
              REPLACE OPT.P06_F05 WITH OPT.F05             
         ELSE
              REPLACE OPT.EXP_1 WITH 0
              REPLACE OPT.P06_F04 WITH 0
              REPLACE OPT.P06_F05 WITH CTOD('')              
         ENDIF
         THISFORM.GRID1.SETFOCUS     
   ENDPROC 
ENDDEFINE 
*********     
DEFINE CLASS TEXTBOX1 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT OPT
         IF OPT.EXP_1=1
             IF THIS.VALUE <= 0
                  =MESSAGEBOX('請購數量不得小於等於零,請重新輸入!!',0+64,'提示訊息視窗') 
                  THIS.VALUE=MIN(OPT.SUM_EXP_4,IIF(SEEK(OPT.F01+OPT.F02,'C04','C041'),C04.F05-C04.F11,0))
             ENDIF     
             REPLACE OPT.P06_F04 WITH THIS.VALUE        
         ENDIF  
         THISFORM.GRID1.SETFOCUS  
   ENDPROC 
ENDDEFINE   
*********     
DEFINE CLASS TEXTBOX2 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT OPT
         IF OPT.EXP_1=1
              REPLACE OPT.P06_F05 WITH THIS.VALUE    
             IF THIS.VALUE < OPT.F05  AND  !EMPTY(DTOC(THIS.VALUE))
                  THISFORM.LBLFA.VISIBLE=.T.
             ELSE
                  THISFORM.LBLFA.VISIBLE=.F.    
                   REPLACE OPT.P06_F05 WITH THIS.VALUE    
             ENDIF     
         ENDIF 
         THISFORM.GRID1.SETFOCUS  
   ENDPROC 
ENDDEFINE             
******************************** 計算總庫存
FUNC ALTT
     PARA TL1,TL5
     TL2=0
     SELE B11
     SEEK TL1
     IF FOUND()
        DO WHILE F03=TL1
           IF F01=INT_190 AND TL5='1'  &&若是計算預期結餘時則不將借出入倉之庫存計入
              TL2=TL2+0
           ELSE   
              TL2=TL2+F04
           ENDIF   
           SKIP               
        ENDDO
     ENDIF
     SELE &AREA2
     RETURN TL2      
***************************     