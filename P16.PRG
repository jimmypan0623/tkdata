***程式名稱:P16其他進貨費用明細
close all
clear 
FLG='0'
FCH=''
CHK=''
CHK_STR=''
R=0
QTY=0
TQTY=0
AREA1='P17_1'
AREA2='P17'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         

SELE A23
SET ORDER TO 1
SEEK LEFT(DTOS(DATE()),6)+'01'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'P16'
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1     
IF !USED('D01')
   SELE 0
   USE D01 
ELSE
   SELE D01
ENDIF
SET ORDER TO 1 
K24='K24'+LEFT(DTOS(DATE()),6)   &&發票明細檔表頭
K241='K241'+LEFT(DTOS(DATE()),6)
K242='K242'+LEFT(DTOS(DATE()),6)
IF !USED('&K24')
   SELE 0
   USE (K24) ALIA K24
ELSE
   SELE K24
ENDIF
SET ORDER TO K241  
K25='K25'+LEFT(DTOS(DATE()),6)   &&發票明細檔
K254='K254'+LEFT(DTOS(DATE()),6) 
IF !USED('&K25')
   SELE 0
   USE (K25) ALIA K25
ELSE
   SELE K25
ENDIF
SET ORDER TO K254   

P19='P19'+LEFT(DTOS(DATE()),6)
P191='P191'+LEFT(DTOS(DATE()),6)
IF !USED('&P19')
   SELE 0
   USE (P19) ALIA P19
ELSE
   SELE P19
ENDIF
SET ORDER TO 1      
D11='D11'+LEFT(DTOS(DATE()),6)
D115='D115'+LEFT(DTOS(DATE()),6)
IF !USED('&D11')
   SELE 0
   USE (D11) ALIA D11
ELSE
   SELE D11
ENDIF
SET ORDER TO D115      
P12='P12'+LEFT(DTOS(DATE()),6)
P122='P122'+LEFT(DTOS(DATE()),6)
IF !USED('&P12')
   SELE 0
   USE (P12) ALIA P12
ELSE
   SELE P12
ENDIF
SET ORDER TO P122        
P17='P17'+LEFT(DTOS(DATE()),6)
P171='P171'+LEFT(DTOS(DATE()),6)
IF !USED('&P17')
   SELE 0
   USE (P17) ALIA P17
ELSE
   SELE P17
ENDIF
SET ORDER TO 1      
SET RELA TO F05 INTO B01
CREATE CURSOR P17_1;
(F01 C(6),F02 N(10.2),F03 C(30),F04 C(17),F12 C(7),F13 C(10),F14 C(2))
INDE ON F01 TAG P17_11
SELE F01,F02,F03,F04,F12,F13,F14 FROM P17 GROUP BY F01 ORDER BY F01 INTO CURSOR P17_2
SELE P17_2
GO TOP
DO WHILE !EOF()
   SELE P17_1
   APPEND BLANK
   REPLACE  F01 WITH P17_2.F01
   REPLACE  F02 WITH P17_2.F02
   REPLACE  F03 WITH P17_2.F03
   REPLACE  F04 WITH P17_2.F04
   REPLACE F12 WITH P17_2.F12
   REPLACE F13 WITH P17_2.F13
   REPLACE F14 WITH P17_2.F14
   SELE P17_2
   SKIP   
ENDDO
SELE P17_2
USE   
SELE P17_1
SET ORDER TO 1
P16form=createobject("tkP16")
P16form.show  
define class tkP16 as form
  caption='P16.其他進貨費用明細'
  controlbox=.F.
  BORDERSTYLE=3  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  WIDTH=INT_015*789
  windowtype=1
  NAME='TKP17'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;         
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      autocenter=.t.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      autocenter=.t.
  ADD OBJECT grid1 AS grid1 WITH;
      columncount=1,;            
      RECORDSOURCE='P17_1',;      
      COLUMN1.NAME='COLUMN1'
  ADD OBJECT grid2 AS grid2 WITH;
      columncount=7,;            
      RECORDSOURCE='P17',; 
      LINKMASTER='P17_1',;
      RELATIONALEXPR='F01',;
      childorder=P171,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7'            
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*163,;
      LEFT=INT_015*663          
  ADD OBJECT PREX_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      VISIBLE=.T.,;
      AUTOSIZE=.T.,;      
      CAPTION='\<L.前期費用追加或折讓',;
      NAME='PREX_BOTT'                                   
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='送貨單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF13','LABEL')
     WITH THIS.LBLF13
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*38
          .WIDTH=INT_015*50
          .CAPTION='發票號碼'          
     ENDWITH
     THIS.ADDOBJECT('LBLF14','LABEL')
     WITH THIS.LBLF14
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*63
          .WIDTH=INT_015*50
          .CAPTION='發票日期'          
     ENDWITH     
     THIS.ADDOBJECT('LBLF02','LABEL')     
     WITH THIS.LBLF02
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*88
          .WIDTH=INT_015*50  
          .CAPTION='進貨費用'
     ENDWITH            
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH    
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF041','LABEL')
     WITH THIS.LBLF041
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=6
     ENDWITH        
     THIS.ADDOBJECT('TXTF13','TEXTBOX')          
     WITH THIS.TXTF13
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*85
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF14','TEXTBOX')          
     WITH THIS.TXTF14
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*25
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH        
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*100
          .HEIGHT=INT_015*25
          .INPUTMASK='9999999.99'
     ENDWITH        
     THIS.ADDOBJECT('TXTF03','TEXTBOX')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*134
          .WIDTH=INT_015*261
          .HEIGHT=INT_015*25
          .MAXLENGTH=36
     ENDWITH      
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF05','LABEL')
	WITH THIS.LBLF05  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF051','LABEL')
    WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*326
	     .TOP=INT_015*18
	     .autosize=.t.
	ENDWITH     
    THIS.ADDOBJECT('LBLF06','Label')
    WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*43
         .WIDTH=INT_015*50
         .CAPTION='進貨數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF07','Label')
    WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='進貨單價'         
    ENDWITH         
    THIS.ADDOBJECT('LBLFTL','Label')
    WITH THIS.LBLFTL
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='金額小計'         
    ENDWITH             
    THIS.ADDOBJECT('LBLFTL1','Label')
    WITH THIS.LBLFTL1
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*93
         .AUTOSIZE=.T.
         .CAPTION=''         
    ENDWITH                 
    THIS.ADDOBJECT('LBLF08','Label')
    WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='百 分 比'         
    ENDWITH             
    THIS.ADDOBJECT('LBLF09','Label')
    WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*143
         .WIDTH=INT_015*50
         .CAPTION='分攤金額'         
    ENDWITH                 
    THIS.ADDOBJECT('LBLF10','Label')
    WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*255
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='進貨單號'         
    ENDWITH             
    THIS.ADDOBJECT('LBLF11','Label')
    WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*255
         .TOP=INT_015*143
         .WIDTH=INT_015*50
         .CAPTION='採購單號'         
    ENDWITH         
	THIS.ADDOBJECT('TXTF05','TEXTBOX')
	WITH THIS.TXTF05      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF05'  
	ENDWITH         
	THIS.ADDOBJECT('TXTF06','TEXTBOX')
	WITH THIS.TXTF06      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='99999999.999'
	     .NAME='TXTF06'  
	ENDWITH         	
	THIS.ADDOBJECT('TXTF07','TEXTBOX')
	WITH THIS.TXTF07      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*64
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='99999999.999999'
	     .NAME='TXTF07'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF08','TEXTBOX')
	WITH THIS.TXTF08
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*114
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999.999999'
	     .NAME='TXTF08'	    
	ENDWITH     
	THIS.ADDOBJECT('TXTF09','TEXTBOX')
	WITH THIS.TXTF09
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*139
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999999.99'
	     .NAME='TXTF09'	    
	ENDWITH     	
	THIS.ADDOBJECT('TXTF10','TEXTBOX')
	WITH THIS.TXTF10
	     .VISIBLE=.T.
	     .LEFT=INT_015*310
	     .TOP=INT_015*114
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .NAME='TXTF10'	    
	ENDWITH     
	THIS.ADDOBJECT('TXTF11','TEXTBOX')
	WITH THIS.TXTF11
	     .VISIBLE=.T.
	     .LEFT=INT_015*310
	     .TOP=INT_015*139
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .NAME='TXTF11'	    
	ENDWITH 
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS   
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
        THISFORM.PREX_BOTT.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
        THISFORM.PREX_BOTT.ENABLED=.F.       
     ENDIF                
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=0
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''                   
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.)  &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限          
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
        IF FLG<>'0'
           SELECT P17
           CALCULATE SUM(F09) TO TMPQTY FOR F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           IF TMPQTY<>THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
              =MESSAGEBOX('分攤金額與表頭進貨費用不符!'+TRANSFORM(TMPQTY-THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'@R 999999999.99')+'請回表身修改或刪除為正確數字',0+48,'提示訊息視窗') 
              IF FLG='1'
                 IF messagebox('或是再由系統重算',4+32+256,'請確認') = 6	
                    SELECT P17
                    CALC SUM(F06) TO QTY FOR F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE &&以進貨數量為分攤基礎
                    seek thisform.pageframe1.page1.txtf01.value
                    TQTY=0
                    IF FOUND()                                     &&計算分攤比例
                       DO WHILE F01=thisform.pageframe1.page1.txtf01.value
                          REPLACE F08 WITH ROUND(100*F06/QTY,6) 
                          REPLACE F09 WITH ROUND(F02*F08/100,0)
                          TQTY=TQTY+F09   &&計算分攤後之總計
                          SKIP
                       ENDDO
                    ENDIF
                    THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                    THISFORM.SHRGROUP.SHURE2_BOTT.CLICK  
                 ELSE         
                    THISFORM.PAGEFRAME1.ACTIVEPAGE=2
                 ENDIF  
              ELSE
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=2
              ENDIF  
             
           ELSE                        &&與總金額相符後再重新計算百分比
              SELECT P17
              SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
              IF FOUND()
                 DO WHILE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                    REPLACE F08 WITH 100*F09/THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                    SKIP
                 ENDDO
                 SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
              ENDIF                         
              
              FLG='0' 
              THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.T.   
           ENDIF                  
        ENDIF           
     ENDIF   
     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.)
     THISFORM.PREX_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.)     
     SELE P17_1 
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE P17
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF   
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLFTL1.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限 
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無刪除的權限 
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
     ENDIF   
     
     
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
     THISFORM.PREX_BOTT.ENABLED=.F.
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
  ENDPROC     
  PROC INIT       
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
*       THISFORM.PREX_BOTT.VISIBLE=.T.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='送貨單號'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P17_1.F01'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')           
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
	   THISFORM.grid2.COLUMN3.HEADER1.CAPTION='金額小計'	   
	   THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='分攤百分比'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='分攤金額'	   
	   THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='進貨單號'	   
	   THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='採購單號'	   	   	   
	   THISFORM.GRID2.LINKMASTER='P17_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='P17.F05'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='ROUND(P17.F06*P17.F07,0)'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P17.F08'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P17.F09'	   
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P17.F10'	   
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='P17.F11'	   	   	   
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*100
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*90
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*90
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*90
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*80              
       THISFORM.grid1.READONLY=.T.      
       THISFORM.grid2.READONLY=.T.            
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限 &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
       ENDIF          
       JK='入貨單號'
       SELE P17_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P17_1.F01
  ENDPROC               
  PROC KEY_LIST.INIT 
       with this 
           .additem('依入貨單號排列')
           .VALUE=1
       endwith             
  ENDPROC 

  PROC KEY_LIST.INTERACTIVECHANGE                 

  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.childorder=''
       SELE D11
       USE
       SELE P19
       USE
       SELECT K24
       USE
       SELE K25
       USE
       SELE P12
       USE
       SELE P17
       set rela off into b01
       SET RELA OFF INTO P17_1
       USE
       SELE P17_1
       USE
       P19='P19'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       P191='P191'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&P19')
          SELE 0
          USE (P19) ALIA P19
       ELSE
          SELE P19
       ENDIF
       SET ORDER TO 1                      
	   K24='K24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)   &&發票明細檔表頭
	   K241='K241'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	   K242='K242'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	   IF !USED('&K24')
	      SELE 0
	      USE (K24) ALIA K24
	   ELSE
	      SELE K24
	   ENDIF
	   SET ORDER TO K241             
       
       K25='K25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&K25')
          SELE 0
          USE (K25) ALIA K25
       ELSE
          SELE K25
       ENDIF
       SET ORDER TO 4
           
       D11='D11'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       D115='D115'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&D11')
          SELE 0
          USE (D11) ALIA D11
       ELSE
          SELE D11
       ENDIF
       SET ORDER TO D115                           
       P12='P12'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       P122='P122'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&P12')
          SELE 0
          USE (P12) ALIA P12
       ELSE
          SELE P12
       ENDIF
       SET ORDER TO P122             
       P17='P17'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       P171='P171'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&P17')
          SELE 0
          USE (P17) ALIA P17
       ELSE
          SELE P17
       ENDIF
       SET ORDER TO 1      
       SET RELA TO F05 INTO B01
       CREATE CURSOR P17_1;
       (F01 C(6),F02 N(10.2),F03 C(30),F04 C(17),F12 C(7),F13 C(10),F14 C(2))
       INDE ON F01 TAG P17_11
       SELE F01,F02,F03,F04,F12,F13,F14 FROM P17 GROUP BY F01 ORDER BY F01 INTO CURSOR P17_2
       SELE P17_2
       GO TOP
       DO WHILE !EOF()
          SELE P17_1
          APPEND BLANK
          REPL F01 WITH P17_2.F01
          REPL F02 WITH P17_2.F02
          REPL F03 WITH P17_2.F03
          REPL F04 WITH P17_2.F04
          REPL F12 WITH P17_2.F12
          REPL F13 WITH P17_2.F13
          REPL F14 WITH P17_2.F14
          SELE P17_2
          SKIP
       ENDDO
       SELE P17_2
       USE   
       SELE P17_1
       SET ORDER TO 1
       THISFORM.GRID1.RECORDSOURCE='P17_1'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P17_1.F01'     
       THISFORM.GRID2.RECORDSOURCE='P17'
	   THISFORM.GRID2.LINKMASTER='P17_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=P171  
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='P17.F05'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='ROUND(P17.F06*P17.F07,0)'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P17.F08'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P17.F09'	   
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P17.F10'	   	   
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='P17.F11'	   	   
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   thisform.grid1.setfocus        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
       ENDIF          
  ENDPROC
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P17_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=P17_1.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=P17_1.F03
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=P17_1.F13
       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=P17_1.F14
       THISFORM.PAGEFRAME1.PAGE1.lblf041.caption=P17_1.F04
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無刪除的權限
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=P17.F05
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=P17.F06      
       THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=P17.F07
       THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=P17.F08       
       THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=P17.F09  
       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=P17.F10 
       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=P17.F11       
       THISFORM.PAGEFRAME1.PAGE2.LBLFTL1.CAPTION=TRANSFORM(ROUND(P17.F06*P17.F07,0),'@R 999999999.99')
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       if thisform.pageframe1.activepage=1
          thisform. CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       thisform.refresh
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.PREX_BOTT.ENABLED=.F.
    THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
     SELE P17_1
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=0
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=''      
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.

*     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.PREX_BOTT.ENABLED=.F. 
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE P17_1
        PO_NO=P17_1.F01
        SELE RECNO() FROM P17 WHERE P17.F01=PO_NO  INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'P17')
           LL1=RLOCK(KK1,'P17')
        ELSE 
           LL1=.T.
        ENDIF   
        SELE RECNO() FROM P19 WHERE LEFT(P19.F02,8)+P19.F05='PB'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE  AND ALLTRIM(P19.F20)='FE' INTO ARRAY BK2
        JJ2=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK2)
               JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
           ENDFOR  
           KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
           RLOCK(KK2,'P19')
           LL2=RLOCK(KK2,'P19')
        ELSE 
           LL2=.T.
        ENDIF           
        IF LL1 .AND. LL2=.T.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.  
           THISFORM.PAGEFRAME1.PAGE1.TXTF13.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF14.READONLY=.T.         
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
        ELSE 
           DO file_impact
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        endif   
     ELSE     &&修改表身資料
        SELECT P17
        RLOCK()
        IF RLOCK()          
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF06.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
        ELSE
           DO file_impact
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ENDIF
        
     ENDIF   
     
     RELEASE ALL LIKE BK*
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
      IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	    
         IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1                         
            SELE P17_1             &&刪除整張訂單
            PO_NO=P17_1.F01
            SELE RECNO() FROM P17 WHERE P17.F01=PO_NO  INTO ARRAY BK1              
            JJ1=''                
            IF _TALLY>0   
               FOR I= 1 TO ALEN(BK1)
                   JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
               ENDFOR    
               KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
               RLOCK(KK1,'P17')
               LL1=RLOCK(KK1,'P17')
            ELSE
               LL1=.T.   
            ENDIF                   
            *SELE RECNO() FROM P19 WHERE LEFT(P19.F02,8)+P19.F05=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE  AND ALLTRIM(P19.F18)='FE' INTO ARRAY BK2
             SELE RECNO() FROM P19 WHERE ALLTRIM(P19.F17)='備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入' AND LEFT(F18,2)='FE' INTO ARRAY BK2
            JJ2=''                
            IF _TALLY>0                   
               FOR I= 1 TO ALEN(BK2)
                   JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
               ENDFOR  
               KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
               RLOCK(KK2,'P19')
               LL2=RLOCK(KK2,'P19')
            ELSE 
               LL2=.T.
            ENDIF                           
            IF LL1 .AND. LL2=.T.
               IF !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE)
                  DELETE FROM K25 WHERE F01='21' AND F07=THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
                  SELECT K24
                  SEEK '21'
                  IF FOUND()
                     REPLACE F03 WITH F03+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*(-1)
                     REPLACE F04 WITH F04+ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0)*(-1)
                     REPLACE F05 WITH F05+ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*(1+INT_002/100),0)*(-1)
                     REPLACE F06 WITH F06-1
                  ENDIF
               ENDIF
               DELE FROM P17 WHERE P17.F01=PO_NO
               *DELE FROM P19 WHERE LEFT(F02,8)+F05=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE AND ALLTRIM(F18)='FE'
               DELETE FROM P19 WHERE ALLTRIM(P19.F17)='備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入' AND LEFT(F18,2)='FE'              
               DELE FROM D11 WHERE F04+F03=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+SPACE(2)+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE AND ALLTRIM(F05)='FE'+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
            ELSE
               DO file_impact                  
            ENDIF             
            SELE P17_1
            DELE
            SKIP -1
            IF BOF()
               GO TOP
            ENDIF   
            THISFORM.GRID1.SETFOCUS
            IF THISFORM.GRID1.ACTIVEROW=0
               THISFORM.CMDGROUP.ENABLED=.F.
               THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
               THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
               THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
            ELSE      
               THISFORM.CMDGROUP.ENABLED=.T.
               THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無修改的權限
               THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)    .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無刪除的權限
               THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無列印的權限
            ENDIF   
        ELSE         &&刪除表身紀錄
            SELECT P17
          
            IF RLOCK()
               DELETE 
                            
               SKIP -1
               IF BOF()
                  GO TOP
               ENDIF   
               
               FLG=IIF(FLG='2','2','1')
               THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.F.
               THISFORM.GRID2.SETFOCUS
               IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                  IF !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE)
                     DELETE FROM K25 WHERE F01='21' AND F07=THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
                     SELECT K24
                     SEEK '21'
                     IF FOUND()
                        REPLACE F03 WITH F03+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*(-1)
                        REPLACE F04 WITH F04+ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0)*(-1)
                        REPLACE F05 WITH F05+ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*(1+INT_002/100),0)*(-1)
                        REPLACE F06 WITH F06-1
                     ENDIF
                  ENDIF
               
                  DELETE FROM P19 WHERE ALLTRIM(P19.F17)='備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入' AND LEFT(F18,2)='FE'
                  DELE FROM D11 WHERE F04+F03=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+SPACE(2)+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE AND ALLTRIM(F05)='FE'+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)                  
                  SELE P17_1
                  DELE
                  SKIP -1
                  IF BOF()
                    GO TOP
                  ENDIF   
                  THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                  THISFORM.REFRESH
                  THISFORM.GRID1.SETFOCUS
                  IF THISFORM.GRID1.ACTIVEROW=0
                     THISFORM.CMDGROUP.ENABLED=.F.
                     THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                     THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                     THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                  ELSE      
                     THISFORM.CMDGROUP.ENABLED=.T.
                     THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無修改的權限
                     THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)    .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無刪除的權限
                     THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F09,.F.) &&判斷有無修改的權限&&判斷有無列印的權限
                  ENDIF  
                  
               ENDIF
            ELSE
               DO file_impact     
            ENDIF
        ENDIF       
    
     
    ENDIF   
    UNLOCK ALL
    RELEASE ALL LIKE BK*   
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='P17'
       THISFORM.GRID2.CHILDORDER=P171
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='P17.F05'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='ROUND(P17.F06*P17.F07,0)'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P17.F08'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P17.F09'	          
	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P17.F10'	   	   
	   THISFORM.GRID2.COLUMN7.CONTROLSOURCE='P17.F11'	   	   	   
       SELE P17_1 
       SET ORDER TO 1
       IF !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE))
                    oRE = CREATEOBJECT("VBScript.RegExp")  && 利用 VBScript 提供的 RegExp COM 物件
                    oRE.PATTERN="[A-Z]{2}[0-9]{8}"
                    IF !oRE.test(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE)
                        =MESSAGEBOX('發票號碼錯誤',0+48,'提示訊息視窗')
                        THISFORM.PAGEFRAME1.PAGE1.TXTF13.SETFOCUS
                        RETURN
                    ENDIF
                    IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE))
                       =MESSAGEBOX('發票日期錯誤',0+48,'提示訊息視窗')
                        THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
                        RETURN
                    ENDIF
                    
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'P12')=.F.
          =MESSAGEBOX('本月份無此進貨單號',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          RETURN
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'P17_1')=.T.
          =MESSAGEBOX('已有輸入本張入貨單之資料!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          RETURN
       ENDIF
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=0         
          =MESSAGEBOX('費用不得等於 0 !',0+48,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('備註說明不得空白 !',0+48,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          RETURN
        ENDIF                   
       SELE P17_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
          REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
          REPLACE F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
        
       THISFORM.REFRESH
       SELE P12
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF FOUND()          
          SELE D11
          APPEND BLANK
          REPL F01 WITH IIF(EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE),P12.F02,THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE)
          REPL F02 WITH P12.F07
          REPL F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPL F05 WITH 'FE'+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          REPL F06 WITH INT_011
          REPL F07 WITH ABS(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          REPL F04 WITH IIF(F07>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE          
          REPL F08 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,1,-1)
          SELE P19
          APPEND BLANK
          REPL F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+IIF(EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE),P12.F02,THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE))
          REPL F03 WITH P12.F07
          REPL F04 WITH 'FE'+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPL F06 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,1,-1)
          REPL F07 WITH ABS(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          REPL F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPL F02 WITH IIF(F08>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE          
          REPL F09 WITH '1'
          
          REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPL F13 WITH INT_011
          REPL F14 WITH 1
          REPL F17 WITH '備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入'
          REPLACE F18 WITH 'FE'
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
          IF !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE) 
              APPEND BLANK 
              REPLACE F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE)                
              REPLACE F03 WITH P12.F07
              REPLACE F04 WITH '稅額'
              REPL F05 WITH '發票:'+THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
              REPL F06 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,1,-1)
              REPL F07 WITH ABS(ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0))
              REPLACE F08 WITH ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0)
              REPL F02 WITH IIF(F08>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE  
              REPL F09 WITH '1'
              REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
               REPL F13 WITH INT_011
              REPL F14 WITH 1
              REPL F17 WITH '備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入'
              REPLACE F18 WITH 'FE'
              REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
              SELECT K25
              APPEND BLANK
              REPLACE F01 WITH '21'
              REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
              REPLACE F03 WITH P12.F07
              REPLACE F04 WITH IIF (SEEK(F03,'D01'),D01.F06,'')
              REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
              REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
              REPLACE F09 WITH '1'
              REPLACE F10 WITH ROUND(F08*INT_002/100,0)
              REPLACE F11 WITH '1'
              REPLACE F12 WITH F08+F10
              REPLACE F13 WITH '00'
              REPLACE F15 WITH 'PB'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+SPACE(2)+'運費'
              REPLACE F16 WITH '1'
              REPLACE F18 WITH '01'
              REPLACE F19 WITH THISFORM.MTH_LIST.DISPLAYVALUE 
              REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入'
              REPLACE F21 WITH INT_011
              REPLACE F22 WITH 1
              REPLACE F23 WITH F12
              REPLACE F24 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
              SELECT K24
              SEEK '21'
              IF !FOUND()
                 APPEND BLANK
                 REPLACE F01 WITH '21'
              ENDIF
              REPLACE F03 WITH F03+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
              REPLACE F04 WITH F04+ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0)
              REPLACE F05 WITH F05+ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*(1+INT_002/100),0)
              REPLACE F06 WITH F06+1
          ENDIF
         
          
          SELE P12
          DO WHILE LEFT(F21,6)=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE           
             IF !EMPTY(IIF(SEEK(P12.F03,'B01'),B01.F98,''))
                SELE P17
                APPEND BLANK                        
                REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                REPLACE F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                       
                REPLACE F05 WITH P12.F03
                REPLACE F06 WITH P12.F04
                REPLACE F07 WITH ROUND(P12.F17*P12.F18,6)
                REPLACE F10 WITH P12.F01
                REPLACE F11 WITH P12.F09
                REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
                REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
             ENDIF   
             SELE P12
             SKIP
          ENDDO
       ENDIF       
       SELE P17
       CALC SUM(F06) TO QTY FOR F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE &&以進貨數量為分攤基礎

       seek thisform.pageframe1.page1.txtf01.value
       TQTY=0
       IF FOUND()                                     &&計算分攤比例
          DO WHILE F01=thisform.pageframe1.page1.txtf01.value
             REPLACE F08 WITH ROUND(100*F06/QTY,6) 
             REPLACE F09 WITH ROUND(F02*F08/100,0)
             TQTY=TQTY+F09   &&計算分攤後之總計
             SKIP
          ENDDO
       ENDIF
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       REPLACE  F09 WITH F09+(F02-TQTY)   &&修正值加到第一筆
       IF F09<0
          TQTY=F09
          REPLACE F09 WITH 0
          SKIP
          DO WHILE TQTY<0
             TQTY=TQTY+F09
             IF TQTY<0
                REPLACE F09 WITH 0
             ELSE
                REPLACE F09 WITH TQTY
                EXIT
             ENDIF
             SKIP
          ENDDO
       ENDIF
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.  
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.       
         THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
         THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       thisform.grid2.enabled=.t.
       thisform.grid2.setfocus  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=1
    ENDIF  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1 OR FLG='1'
       IF SIGN(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)<>SIGN(P17_1.F02) 
          =MESSAGEBOX('費用金額必須為 '+IIF(SIGN(P17_1.F02)=1,'正數!','負數!'),0+48,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
           SELE P17
           SEEK P17_1.F01
           TQTY=0
           IF FOUND()
              DO WHILE F01=P17_1.F01
                 REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                 REPL F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
                 REPL F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
                 REPL F09 WITH ROUND(F02*F08/100,0)
                 TQTY=TQTY+F09
                 SKIP
              ENDDO    
           ENDIF        
           SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           REPL F09 WITH F09+(F02-TQTY)
           SELE D11
           SEEK 'FE'+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+SPACE(4)+IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+SPACE(2)+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
           IF FOUND()
              REPLACE  F07 WITH ABS(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
              REPLACE  F08 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,1,-1)              
           ENDIF   
           SELE P19
           *LOCATE FOR LEFT(F02,8)+F05=IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,'PB','BB')+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE AND ALLTRIM(F18)='FE'
           LOCATE FOR ALLTRIM(F17)='備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入' AND F05=ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
           IF FOUND()
               REPLACE F06 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE>0,1,-1)
               REPLACE  F07 WITH ABS(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
               REPLACE  F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
               REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           ENDIF
           IF !EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE)
               LOCATE FOR ALLTRIM(F17)='備註:'+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+'進貨費用明細轉入' AND F05=ALLTRIM('發票:'+THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE)
               IF FOUND()
                  REPLACE F07 WITH ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0)
                  REPLACE F08 WITH F07
                  REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
               ENDIF
               SELECT K25
               SEEK '21'+THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
               IF FOUND()
                  SELECT K24
                  SEEK '21'
                  IF FOUND()
                     REPLACE F03 WITH F03-K25.F08
                     REPLACE F04 WITH F04-K25.F10
                     REPLACE F05 WITH F05-K25.F12
                     REPLACE F03 WITH F03+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                     REPLACE F04 WITH F04+ROUND(F03*INT_002/100,0)
                     REPLACE F05 WITH F03+F04
                  ENDIF
                  SELECT K25
                  REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                  REPLACE F10 WITH ROUND(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE*INT_002/100,0)
                  REPLACE F12 WITH F08+F10
                  REPLACE F24 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
               ENDIF
           ENDIF
           SELE P17_1           
           REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPL F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.T.
           FLG='0'
    ELSE   &&表身修改確認
           
           SELECT P17          
           REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE   
           REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE   
           REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE    
           FLG='2'
           THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.F.           
    ENDIF   
    UNLOCK ALL    
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      THISFORM.grid1.ENABLED=.T.
      THISFORM.grid2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1         
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
         THISFORM.PREX_BOTT.ENABLED=.T.       
      ELSE
         THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=.T.         
         THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.T.  
         THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.T.  
         THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.T.  
         THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.T.             
      ENDIF       
      UNLOCK ALL
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'P17'
             THISFORM.GRID2.RECORDSOURCE='P17'
             THISFORM.GRID2.CHILDORDER=P171
  	        THISFORM.grid2.COLUMN1.CONTROLSOURCE='P17.F05'
	        THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	        THISFORM.grid2.COLUMN3.CONTROLSOURCE='ROUND(P17.F06*P17.F07,0)'
	         THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P17.F08'
	        THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P17.F09'	            
        	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='P17.F10'	   	   
	       THISFORM.GRID2.COLUMN7.CONTROLSOURCE='P17.F11'	   	   	        
	     ENDIF   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROCEDURE PREX_BOTT.CLICK
     DTME=THISFORM.MTH_LIST.DISPLAYVALUE
      OMT1=VAL(RIGHT(DTME,2))+1   &&計算本月最後一天為幾號
      IF OMT1>12
          OMT1=OMT1%12
          OMT2=VAL(LEFT(DTOS(CTOD(DTME+'/01')),4))+1
       ELSE
          OMT2=VAL(LEFT(DTOS(CTOD(DTME+'/01')),4))  
      ENDIF
      OMT3=RIGHT(DTOS(CTOD(ALLTRIM(STR(OMT2))+'/'+PADL(ALLTRIM(STR(OMT1)),2,'0')+'/01')-1),2)     
     CREATE CURSOR PREX;
     (F01 C(6),F02 D(8),F03 N(12,2),F04 C(43),F13 C(10),F14 C(2))
      INDEX ON F01 TAG PREX1
      PREX_SEEK=CREATEOBJECT('PREX_SEEK')
      PREX_SEEK.SHOW
      AREA1='P17_1'      
      SELE P17_1
      THISFORM.PAGEFRAME1.ACTIVEPAGE=1
      THISFORM.GRID1.SETFOCUS
  ENDPROC
enddefine    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=P17_1.F01     
     HK=LEFT(DTOC(A23.F01),5)
     SELECT P17.F01,;
            P17.F02,;
            P17.F03,;
            P17.F04,;                    
            P17.F05,;
            P17.F07,;
            A14.F02,;
            B01.F02;            
     FROM P17,A14,B01 WHERE P17.F01=LK AND A14.F01=P17.F05 AND B01.F01=P17.F03 ORDER BY P17.F03 NOWAIT
     IF _tally >0
*        REPORT FORM ALLTRIM(INT_116)+'P17' PREVIEW
         report form ALLTRIM(INT_116)+'P17' to print prompt 
     ENDIF  
ENDPROC
************
define class PREX_SEEK as form  
   AUTOCENTER=.T.
  caption='輸入欲追加之費用資料'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*420
  WIDTH=INT_015*470
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='PREX_SEEK'    
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      LEFT=INT_015*3,;
      WIDTH=INT_015*464,;
      HEIGHT=INT_015*90
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;    
      LEFT=INT_015*3,;
      TOP=INT_015*92,;
      WIDTH=INT_015*464,;
      HEIGHT=INT_015*290
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      LEFT=INT_015*3,;
      TOP=INT_015*384,;
      WIDTH=INT_015*464,;
      HEIGHT=INT_015*35    
  add object cmdgroup as cmdgroup with;      
      TOP=INT_015*349,;
      LEFT=INT_015*60
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      TOP=INT_015*385,;
      LEFT=INT_015*60
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      VISIBLE=.F.    
  ADD OBJECT LBLF01 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='送貨單號'
  ADD OBJECT LBLF02 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*124,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='入貨日期'      
  ADD OBJECT LBLF03 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='費用金額'
  ADD OBJECT LBLF13 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*164,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='發票號碼'      
  ADD OBJECT LBLF14 AS LABEL WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*314,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='發票日期'            
  ADD OBJECT LBLF04 AS LABEL WITH;
      TOP=INT_015*58,;
      LEFT=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='備註說明'        
  ADD OBJECT TXTF01 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*65,;
      HEIGHT=INT_015*25,;      
      MAXLENGTH=6,;
      NAME='TXTF01'
  ADD OBJECT TXTF02 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*174,;
      WIDTH=INT_015*85,;
      HEIGHT=INT_015*25,;
      NAME='TXTF02'      
  ADD OBJECT TXTF03 AS TEXTBOX WITH;
      TOP=INT_015*29,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*73,;
      HEIGHT=INT_015*25,;
      INPUTMASK='9999999.99',;
      ALIGNMENT=1,;
      NAME='TXTF03'      
  ADD OBJECT TXTF13 AS TEXTBOX WITH;
      TOP=INT_015*29,;
      LEFT=INT_015*215,;
      WIDTH=INT_015*95,;
      HEIGHT=INT_015*25,;     
      MAXLENGTH=10,;
      NAME='TXTF13'   
  ADD OBJECT TXTF14 AS TEXTBOX WITH;
      TOP=INT_015*29,;
      LEFT=INT_015*365,;
      WIDTH=INT_015*35,;
      HEIGHT=INT_015*25,;   
      MAXLENGTH=2,;
      NAME='TXTF14'               
  ADD OBJECT TXTF04 AS TEXTBOX WITH;
      TOP=INT_015*54,;
      LEFT=INT_015*56,;
      WIDTH=INT_015*261,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=43,;
      NAME='TXTF04'            
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*50,;
      LEFT=INT_015*350                
  add object GRID1 as GRID1 with;        
      AUTOCENTER=.T.,;
      LEFT=INT_015*10,;
      TOP=INT_015*96,;
      WIDTH=INT_015*450,;      
      HEIGHT=INT_015*255,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=4,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3' ,;
      COLUMN4.NAME='COLUMN4'     
  add object cmnd2 as commandbutton with;
      LEFT=INT_015*191,;
      TOP=INT_015*389,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<T.確認',;
      TOOLTIPTEXT='確認並離開->ALT+T'
      name='cmnd2'
      procedure init          
         AREA1='PREX'
         SELECT PREX 
         SET ORDER TO 1      
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.PNT_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.ESC_BOTT.VISIBLE=.F.            
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX') 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')          
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='PREX'
         THISFORM.GRID1.CHILDORDER='PREX1'         
         THISFORM.ORPGROUP.PNT_BOTT.VISIBLE=.F.
         THISFORM.SHRGROUP.VISIBLE=.F.
         THISFORM.SHRGROUP.ENABLED=.F.         
         thisform.setall('readonly',.t.,'textbox')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='送貨單號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='PREX.F01'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='入貨日期'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='PREX.F02'         
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='費用金額'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='PREX.F03'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*75
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='備註說明'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='PREX.F04'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*261
         THISFORM.GRID1.SETFOCUS       
         FCH='GRID1'
         IF THISFORM.GRID1.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.         
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
         ENDIF                     
         JK='送貨單號'             
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XColIndex     
         THISFORM.TXTF01.VALUE=PREX.F01
         THISFORM.TXTF02.VALUE=PREX.F02
         THISFORM.TXTF03.VALUE=PREX.F03
         THISFORM.TXTF04.VALUE=PREX.F04
         THISFORM.TXTF13.VALUE=PREX.F13
         THISFORM.TXTF14.VALUE=PREX.F14
         FCH=THISFORM.ACTIVECONTROL.NAME 
         CHK=''
         IF THIS.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.         
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.T.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.         
         ENDIF            
      ENDPROC 
      PROC ORPGROUP.NEW_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.
           THISFORM.SetAll('READONLY',.F.,'TEXTBOX')      
           THISFORM.GRID1.ENABLED=.F.               
           THISFORM.TXTF01.READONLY=.F.
           THISFORM.TXTF01.VALUE=''
           THISFORM.TXTF02.VALUE=DATE()
           THISFORM.TXTF03.VALUE=0
           THISFORM.TXTF04.VALUE=''
           THISFORM.TXTF13.VALUE=''
           THISFORM.TXTF14.VALUE=''
           THISFORM.TXTF01.SETFOCUS
      ENDPROC
      PROC ORPGROUP.EDIT_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.      
           THISFORM.SetAll('READONLY',.F.,'TEXTBOX')                                
           THISFORM.GRID1.ENABLED=.F.              
           THISFORM.TXTF01.READONLY=.T. 
            THISFORM.TXTF02.READONLY=.T.
           THISFORM.TXTF03.SETFOCUS
      ENDPROC        
      PROC ORPGROUP.DEL_BOTT.CLICK
           IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	            
               SELECT PREX
               DELETE 
               SKIP -1
               IF BOF()
                   GO TOP
               ENDIF
              THISFORM.GRID1.SETFOCUS
              IF THISFORM.GRID1.ACTIVEROW=0
                 THISFORM.CMDGROUP.ENABLED=.F.
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.   
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
                 THISFORM.SETALL('VALUE','','TEXTBOX')
              ELSE      
                 THISFORM.CMDGROUP.ENABLED=.T.

                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
              ENDIF           
           ENDIF   
      ENDPROC
      PROC SHRGROUP.SHURE1_BOTT.CLICK
                 
                 IF SEEK(THISFORM.TXTF01.VALUE,'P17')=.T.
                    =MESSAGEBOX('此送貨單號在本月已有輸入!',0+48,'提示訊息視窗')
                    THISFORM.TXTF01.SETFOCUS
                    RETURN
                 ENDIF
                 IF SEEK(THISFORM.TXTF01.VALUE,'PREX')=.T.                 
                      =MESSAGEBOX('此送貨單號已輸入!',0+48,'提示訊息視窗')
                      THISFORM.TXTF01.SETFOCUS
                      RETURN
                 ENDIF     
                 IF THISFORM.TXTF02.VALUE>CTOD(DTME+'/01')
                      =MESSAGEBOX('追加費用之日期不得大於'+DTOC(CTOD(DTME+'/01')),0+48,'提示訊息視窗')
                      THISFORM.TXTF02.SETFOCUS
                      RETURN
                  ENDIF    
                  IF THISFORM.TXTF03.VALUE=0
                      =MESSAGEBOX('金額不得為 0',0+48,'提示訊息視窗')
                      THISFORM.TXTF03.SETFOCUS
                 ENDIF     
                 IF EMPTY(THISFORM.TXTF04.VALUE)
                     =MESSAGEBOX('備註說明不得為空白',0+48,'提示訊息視窗')
                     THISFORM.TXTF04.SETFOCUS
                     RETURN
                 ENDIF    
                 IF !EMPTY(THISFORM.TXTF13.VALUE)
                     oRE = CREATEOBJECT("VBScript.RegExp")  && 利用 VBScript 提供的 RegExp COM 物件
                     oRE.PATTERN="[A-Z]{2}[0-9]{8}"
                    IF !oRE.test(THISFORM.TXTF13.VALUE)
                        =MESSAGEBOX('發票號碼錯誤',0+48,'提示訊息視窗')
                        THISFORM.TXTF13.SETFOCUS
                        RETURN
                    ENDIF
                    IF EMPTY(CTOD(DTME+'/'+THISFORM.TXTF14.VALUE))
                       =MESSAGEBOX('發票日期錯誤',0+48,'提示訊息視窗')
                        THISFORM.TXTF14.SETFOCUS
                        RETURN
                    ENDIF
                 ENDIF
                 SELECT PREX
                 APPEND BLANK
                 REPLACE F01 WITH THISFORM.TXTF01.VALUE
                 REPLACE F02 WITH THISFORM.TXTF02.VALUE                 
                 REPLACE F03 WITH THISFORM.TXTF03.VALUE
                 REPLACE F04 WITH THISFORM.TXTF04.VALUE         
                 REPLACE F13 WITH THISFORM.TXTF13.VALUE 
                 REPLACE F14 WITH THISFORM.TXTF14.VALUE         
                 SEEK THISFORM.TXTF01.VALUE
                 THISFORM.REFRESH
                THISFORM.ORPGROUP.NEW_BOTT.CLICK    
      ENDPROC         
      PROC SHRGROUP.SHURE2_BOTT.CLICK
                 IF THISFORM.TXTF03.VALUE=0
                      =MESSAGEBOX('金額不得為 0',0+48,'提示訊息視窗')
                      THISFORM.TXTF03.SETFOCUS
                 ENDIF     
                 IF EMPTY(THISFORM.TXTF04.VALUE)
                     =MESSAGEBOX('備註說明不得為空白',0+48,'提示訊息視窗')
                     THISFORM.TXTF04.SETFOCUS
                     RETURN
                 ENDIF    
                   IF !EMPTY(THISFORM.TXTF13.VALUE)
                     oRE = CREATEOBJECT("VBScript.RegExp")  && 利用 VBScript 提供的 RegExp COM 物件
                     oRE.PATTERN="[A-Z]{2}[0-9]{8}"
                    IF !oRE.test(THISFORM.TXTF13.VALUE)
                        =MESSAGEBOX('發票號碼錯誤',0+48,'提示訊息視窗')
                        THISFORM.TXTF13.SETFOCUS
                        RETURN
                    ENDIF
                    IF EMPTY(CTOD(DTME+'/'+THISFORM.TXTF14.VALUE))
                       =MESSAGEBOX('發票日期錯誤',0+48,'提示訊息視窗')
                        THISFORM.TXTF14.SETFOCUS
                        RETURN
                    ENDIF
                 ENDIF
                 SELECT PREX
                 REPLACE F01 WITH THISFORM.TXTF01.VALUE
                 REPLACE F02 WITH THISFORM.TXTF02.VALUE                 
                 REPLACE F03 WITH THISFORM.TXTF03.VALUE
                 REPLACE F04 WITH THISFORM.TXTF04.VALUE
                 REPLACE F13 WITH THISFORM.TXTF13.VALUE
                 REPLACE F14 WITH THISFORM.TXTF14.VALUE
                 THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC
      PROC SHRGROUP.ABANDON_BOTT.CLICK
           THISFORM.SHRGROUP.ENABLED=.F.
           THISFORM.SHRGROUP.VISIBLE=.F.      
           THISFORM.ORPGROUP.ENABLED=.T.
           THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.CMDGROUP.ENABLED=.T.
           THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
           THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
           THISFORM.TXTF01.READONLY=.T.
           THISFORM.GRID1.ENABLED=.T.
           THISFORM.GRID1.SETFOCUS     
           THISFORM.CMND2.ENABLED=.T.
           UNLOCK ALL      
      ENDPROC
      PROC SHRGROUP.FINISH_BOTT.CLICK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
      ENDPROC
      procedure cmnd2.click                  
          SELECT PREX 
          GO TOP
          DO WHILE !EOF()
                 HX='P12'+LEFT(DTOS(PREX.F02 ),6)
                 IF !USED('&HX')
                     SELECT 0
                     USE &HX ALIAS HX
                 ELSE
                     SELECT HX
                 ENDIF
                 SET ORDER TO 2
                 IF SEEK(PREX.F01 ,'HX')
                      SELE P17_1                           
                     APPEND BLANK
                     RLOCK()
                     IF RLOCK()
                         REPLACE F01 WITH PREX.F01 
                         REPLACE F02 WITH PREX.F03 
                         REPLACE F03 WITH PREX.F04 
                         REPLACE F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                         REPLACE F13 WITH PREX.F13
                         REPLACE F14 WITH PREX.F14
                    ENDIF                                  
                    SELE D11
                    APPEND BLANK
                    REPLACE  F01 WITH OMT3
                    REPLACE  F02 WITH HX.F07
                    REPLACE  F03 WITH PREX.F04 
                    REPLACE  F04 WITH IIF(PREX.F03>0,'PB','BB')+PREX.F01 
                    REPLACE  F05 WITH 'FE'+SUBSTR(DTOS(CTOD(DTME+'/01')),3,4)
                    REPLACE  F06 WITH INT_011
                    REPLACE  F07 WITH ABS(PREX.F03)
                    REPLACE  F08 WITH IIF(PREX.F03>0,1,-1)
                    SELE P19
                    APPEND BLANK
                    REPLACE  F01 WITH CTOD(DTME+'/'+IIF(EMPTY(PREX.F14),OMT3,PREX.F14))
                    REPLACE  F02 WITH IIF(PREX.F03>0,'PB','BB')+PREX.F01 
                    REPLACE  F03 WITH HX.F07
                    REPLACE  F04 WITH 'FE'+SUBSTR(DTOS(CTOD(DTME+'/01')),3,4)
                    REPLACE  F05 WITH PREX.F04
                    REPLACE  F06 WITH IIF(PREX.F03>0,1,-1)
                    REPLACE  F07 WITH ABS(PREX.F03)
                    REPLACE  F08 WITH PREX.F03 
                    REPLACE  F09 WITH '1'
                    REPLACE  F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    REPLACE  F13 WITH INT_011
                    REPLACE  F14 WITH 1
                    REPLACE  F17 WITH '備註:'+PREX.F01+'進貨費用明細轉入'
                    REPLACE  F18 WITH 'FE'
                    REPLACE F20 WITH PREX.F13
                   IF PREX.F03<0
                       REPLACE F21 WITH '03'
                   ENDIF    
                   
                   SELE HX
                   DO WHILE LEFT(F21,6)=PREX.F01            
                          IF !EMPTY(IIF(SEEK(HX.F03,'B01'),B01.F98,''))
                              SELE P17
                              APPEND BLANK                        
                              REPLACE F01 WITH PREX.F01 
                              REPLACE F02 WITH PREX.F03 
                              REPLACE F03 WITH PREX.F04 
                              REPLACE F04 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                       
                              REPLACE F05 WITH HX.F03
                              REPLACE F06 WITH HX.F04
                              REPLACE F07 WITH ROUND(HX.F17*HX.F18,6)
                              REPLACE F10 WITH HX.F01
                              REPLACE F11 WITH HX.F09
                              REPLACE F13 WITH PREX.F13
                              REPLACE F14 WITH PREX.F14
                         ENDIF   
                        SELE HX
                        SKIP
                   ENDDO                             
                   SELE P17
                   CALC SUM(F06) TO QTY FOR F01=PREX.F01  &&以進貨數量為分攤基礎
                   seek PREX.f01 
                   TQTY=0
                    IF FOUND()                                     &&計算分攤比例
                        DO WHILE F01=PREX.f01 
                               REPLACE F08 WITH ROUND(100*F06/QTY,6) 
                               REPLACE F09 WITH ROUND(F02*F08/100,0)
                               TQTY=TQTY+F09   &&計算分攤後之總計
                               SKIP
                       ENDDO
                    ENDIF
                    SEEK PREX.F01 
                    REPLACE  F09 WITH F09+(F02-TQTY)   &&修正值加到第一筆
                    IF F09<0
                       TQTY=F09
                       REPLACE F09 WITH 0
                       SKIP
                       DO WHILE TQTY<0
                          TQTY=TQTY+F09
                          IF TQTY<0
                             REPLACE F09 WITH 0
                          ELSE
                             REPLACE F09 WITH TQTY   
                             EXIT
                          ENDIF
                          SKIP
                       ENDDO
                    ENDIF                     
                ENDIF          
                
                SELECT HX
                USE
                SELECT PREX
                SKIP
          ENDDO
          SELECT F01,SUM(F03),F13,F14 FROM PREX GROUP BY F13 ORDER BY F13,F01 WHERE !EMPTY(F13) INTO CURSOR TXTMP NOWAIT
          IF _TALLY>0
             SELECT TXTMP
             GO TOP
             DO WHILE !EOF()
                SELECT P19
                APPEND BLANK
                REPLACE F01 WITH CTOD(DTME+'/'+TXTMP.F14)
                REPLACE F02 WITH IIF(TXTMP.SUM_F03>0,'PB','BB')+TXTMP.F01 
                REPLACE F03 WITH D11.F02
                REPLACE F04 WITH '稅額'
                REPLACE F05 WITH '發票:'+TXTMP.F13
                REPLACE F06 WITH IIF(TXTMP.SUM_F03>0,1,-1)
                REPLACE F07 WITH ABS(ROUND(TXTMP.SUM_F03*INT_002/100,0))
                REPLACE F08 WITH F06*F07
                REPLACE F09 WITH '1'
                REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                REPLACE F13 WITH INT_011
                REPLACE F14 WITH 1
                REPLACE F17 WITH '備註:'+TXTMP.F01+'進貨費用明細轉入'
                REPLACE F18 WITH 'FE'
                REPLACE F20 WITH TXTMP.F13
                SELECT K25
                APPEND BLANK
                REPLACE F01 WITH '21'
                REPLACE F02 WITH TXTMP.F14 
                REPLACE F03 WITH D11.F02
                REPLACE F04 WITH IIF (SEEK(F03,'D01'),D01.F06,'')
                REPLACE F07 WITH TXTMP.F13 
                REPLACE F08 WITH TXTMP.SUM_F03
                REPLACE F09 WITH '1'
                REPLACE F10 WITH ROUND(F08*INT_002/100,0)
                REPLACE F11 WITH '1'
                REPLACE F12 WITH F08+F10
                REPLACE F13 WITH '00'
                REPLACE F15 WITH 'PB'+TXTMP.F01+SPACE(2)+'運費'
                REPLACE F16 WITH '1'
                REPLACE F18 WITH '01'
                REPLACE F19 WITH DTME 
                REPLACE F20 WITH TXTMP.F01+'進貨費用明細轉入'
                REPLACE F21 WITH INT_011
                REPLACE F22 WITH 1
                REPLACE F23 WITH F12
                REPLACE F24 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                SELECT K24
                SEEK '21'
                IF !FOUND()
                   APPEND BLANK
                   REPLACE F01 WITH '21'
                ENDIF
                REPLACE F03 WITH F03+TXTMP.SUM_F03
                REPLACE F04 WITH F04+ROUND(TXTMP.SUM_F03*INT_002/100,0)
                REPLACE F05 WITH F05+ROUND(TXTMP.SUM_F03*(1+INT_002/100),0)
                REPLACE F06 WITH F06+1                                        
                SELECT TXTMP
                SKIP
             ENDDO
             SELECT TXTMP
             USE
          ENDIF   
          SELECT PREX
          USE          
          THISFORM.RELEASE 
      endproc    
enddefine            