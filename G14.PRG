***程式名稱 G14.期間存貨明細帳
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
R=0
CH=1
AREA1='B01_1'
AREA2='G1F'
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1
FIRST_DATE=LEFT(DTOS(A23.F01),6) &&系統月份檔第一筆開帳月份
GO BOTTOM
LAST_DATE=LEFT(DTOS(A23.F01),6)  &&系統月份檔最後一筆開帳月份
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'G14'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET ORDER TO 1         
GO TOP   
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1  

***************
G14AFORM=CREATEOBJECT("TKG14A")
G14AFORM.SHOW       
DEFINE CLASS TKG14A AS FORM
  AUTOCENTER=.T.
  CAPTION='G14 期間存貨明細查詢'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*300
  WIDTH=INT_015*340
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='TKG14A'
  ADD OBJECT LBF AS LABEL WITH;
      LEFT=INT_015*50,;
      TOP=INT_015*10,;
      AUTOSIZE=.T.,;
      BACKCOLOR=RGB(255,255,0),;
      CAPTION='請輸入查詢之日期範圍'
        
  ADD OBJECT LBLF01 AS LABEL WITH;
      LEFT=INT_015*50,;
      TOP=INT_015*150,;
      WIDTH=INT_015*50,;
      CAPTION='起始月份'
  ADD OBJECT TXTF01 AS TEXTBOX WITH;
      LEFT=INT_015*100,;
      TOP=INT_015*145,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;
      MAXLENGTH=7,;
      NAME='TXTF01'      
  ADD OBJECT LBLF02 AS LABEL WITH;
      LEFT=INT_015*190,;
      TOP=INT_015*150,;
      WIDTH=INT_015*50,;
      CAPTION='截止月份'        
  ADD OBJECT TXTF02 AS TEXTBOX WITH;
      LEFT=INT_015*240,;
      TOP=INT_015*145,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;
      MAXLENGTH=7,;
      NAME='TXTF02'    
  ADD OBJECT LBLF03 AS LABEL WITH;
      LEFT=INT_015*130,;
      TOP=INT_015*200,;
      AUTOSIZE=.T.,;
      CAPTION=''             
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*90,;
      TOP=INT_015*250,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='\<Y.確認',;
      TOOLTIPTEXT='確認所查詢條件',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*180,;
      TOP=INT_015*250,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此查詢尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
*************      
   PROCEDURE INIT 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'CHECKBOX') 
         THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')          
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
         THISFORM.TXTF01.VALUE=LEFT(DTCX(DATE()),7-INT_012)
         THISFORM.TXTF02.VALUE=LEFT(DTCX(DATE()),7-INT_012)
*!*	         THISFORM.TXTF01.VALUE=LEFT(DTOS(DATE()),4)+'/'+SUBSTR(DTOS(DATE()),5,2)
*!*	         THISFORM.TXTF02.VALUE=LEFT(DTOS(DATE()),4)+'/'+SUBSTR(DTOS(DATE()),5,2)
   ENDPROC
 ************
   PROCEDURE CMND1.CLICK
       DO CASE
  
           *CASE  LEN(ALLTRIM(THISFORM.TXTF01.VALUE))=1 .OR. LEN(ALLTRIM(THISFORM.TXTF01.VALUE))<>7
                        =MESSAGEBOX('起始日期格式不正確',0+64,'提示視窗')
                        THISFORM.TXTF01.VALUE=''
            		THISFORM.TXTF01.SETFOCUS
                        RETURN
          CASE    IIF(SEEK(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),'A23'),.F.,.T.)
             		=MESSAGEBOX('起始日期於系統中尚未有資料,系統開檔日為'+FIRST_DATE+',請重新輸入!',0+64,'提示視窗')
            		THISFORM.TXTF01.SETFOCUS
                        RETURN              
          *CASE    LEN(ALLTRIM(THISFORM.TXTF02.VALUE))=1 .OR. LEN(ALLTRIM(THISFORM.TXTF02.VALUE))<>7
                        =MESSAGEBOX('終止日期格式不正確',0+64,'提示視窗')
            		THISFORM.TXTF02.SETFOCUS
                        RETURN                    
          CASE    IIF(SEEK(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),'A23'),.F.,.T.)
             		=MESSAGEBOX('終止日期於系統中尚未有資料,目前統開檔日已到'+LAST_DATE+',請重新輸入!',0+64,'提示視窗')
            		THISFORM.TXTF02.SETFOCUS
                        RETURN                             
          CASE  CTOD(THISFORM.TXTF02.VALUE+'/01')<CTOD(THISFORM.TXTF01.VALUE+'/01')
                        =MESSAGEBOX('終止日期不得小於起始日期',0+64,'提示視窗')
            		THISFORM.TXTF02.SETFOCUS
                        RETURN                  
      ENDCASE 
      	S1=LEFT(DTOS(CTOD(THISFORM.TXTF01.VALUE+'/01')),6)
	    H1='G15'+ALLTRIM(S1)
	    F1=ALLTRIM(H1)+'.DBF'
	    K1='G11'+ALLTRIM(S1)
	    L1=ALLTRIM(K1)+'.DBF'
	    S2=LEFT(DTOS(CTOD(THISFORM.TXTF02.VALUE+'/01')),6)
	    H2='G15'+ALLTRIM(S2)
	    F2=ALLTRIM(H2)+'.DBF'
	    K2='G11'+ALLTRIM(S2)
	    L2=ALLTRIM(K2)+'.DBF'
	    CREATE CURSOR G1F (F01 C(43),F02 D(8),F03 C(1),F04 N(14,4),F05 N(16,6),F06 N(14,4),F07 C(50),F08 N(14,2))
	    INDEX ON F01+DTOS(F02) TAG G1F1
	    SET ORDER TO 1
	   DO  WHILE  FILE('&F1')=.T.   

	    	IF !USED('&L1')
	   	        SELE 0
	            USE &L1 
	       ELSE
	            SELE &L1
	       ENDIF     	       
	       SET ORDER TO 1
	       IF !USED('&F1')
	   	       SELE 0
	            USE &F1 
	       ELSE
	            SELE &F1
	       ENDIF     
	    	SELECT &H1
	    	SET RELATION TO F01 INTO &K1
	    	GO TOP	
	    	DO  WHILE !EOF()		    	        		    		
				SELECT G1F
				APPEND BLANK
				REPLACE F01 WITH &H1..F01
				REPLACE F02 WITH IIF(EMPTY(&H1..F02),CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/01') ,CTOD(LEFT(ALLTRIM(S1),4)+'/'+RIGHT(ALLTRIM(S1),2)+'/'+&H1..F02))
				REPLACE F03 WITH &H1..F03
				REPLACE F04 WITH &H1..F04
				REPLACE F05 WITH &H1..F05
				REPLACE F06 WITH &H1..F06 
				REPLACE F07 WITH &H1..F07	
				IF F03='C'
				   REPLACE F08 WITH ROUND(&H1..F04*(&H1..F05-&K1..F21)*(-1),2)
				ENDIF   			
			    SELECT &H1
			    SKIP
		   ENDDO     
		   SELECT &K1
		   USE
		   SELECT &H1
		   USE
		   IF  H1=H2
	   	      EXIT 
	*!*	   	      USE
	       ENDIF  
	       IF  ALLTRIM(STR(VAL(RIGHT(S1,2))+1))='13'
	   	        S1=ALLTRIM(STR(VAL(LEFT(S1,4))+1)+'01')
	   	        H1='G15'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	            K1='G11'+ALLTRIM(S1)
	            L1=ALLTRIM(K1)+'.DBF'  
	       ELSE
	            S1=ALLTRIM(STR(VAL(S1)+1))
	            H1='G15'+ALLTRIM(S1)
	            F1=ALLTRIM(H1)+'.DBF'  
	            K1='G11'+ALLTRIM(S1)
	            L1=ALLTRIM(K1)+'.DBF'  	            
	       ENDIF    
	ENDDO	
	SELECT F01,F02,F99 FROM B01 WHERE F01= ANY(SELECT F01 FROM G1F) INTO CURSOR B01_2 ORDER BY F01
	CREATE CURSOR B01_1 (F01 C(43),F02 C(20),F99 C(8))
	INDEX ON F01 TAG B01_11
	INDEX ON F99 TAG B01_12
	SET ORDER TO B01_11
	SELECT * FROM B01_2
	GO TOP
	DO WHILE !EOF()
	   SELECT B01_1
	   APPEND BLANK
	   REPLACE F01 WITH B01_2.F01
	   REPLACE F02 WITH B01_2.F02
	   REPLACE F99 WITH B01_2.F99
	   SELECT B01_2
	   SKIP
	ENDDO
	SELECT B01_2
	USE
      ST=ALLTRIM(THISFORM.TXTF01.VALUE)+'至'+ALLTRIM(THISFORM.TXTF02.VALUE)
      DATA_RANG=STUFF(ALLTRIM(THISFORM.TXTF01.VALUE),ATC('/',ALLTRIM(THISFORM.TXTF01.VALUE)),1,'')+'至'+ STUFF(ALLTRIM(THISFORM.TXTF02.VALUE),ATC('/',ALLTRIM(THISFORM.TXTF02.VALUE)),1,'')      
      G14BFORM=CREATEOBJECT("TKG14B")
      G14BFORM.SHOW       	 
      THISFORM.CMND2.CLICK		
  ENDPROC
 *******
     PROCEDURE CMND2.CLICK        
           IF !USED('A05')
              SELECT 0
              USE A05
           ELSE
              SELECT A05
           ENDIF
           SET ORDER TO 1
           SEEK sys_oper+'G14'
           IF FOUND()
              DELETE 
           ENDIF         
           CLOSE TABLE ALL
           THISFORM.RELEASE 
           RETURN  
      ENDPROC      
ENDDEFINE  
***********        
DEFINE CLASS TKG14B AS FORM
  CAPTION='G14.期間庫存明細'+'      資料範圍'+ST
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKG14B'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*230,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=2,;            
      RECORDSOURCE='B01_1',;      
      CHILDORDER='B01_11',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      TOP=INT_015*220,;
      HEIGHT=INT_015*300,;
      COLUMNCOUNT=8,;            
      RECORDSOURCE='G1F',; 
      LINKMASTER='B01_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER='G1F1',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7' 
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.                             
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.       
  ADD OBJECT EXCEL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*10,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*65 ,;       
      FONTSIZE=INT_015*9,;
      CAPTION='\<E.轉EXCEL',;
      NAME='EXCEL_BOTT'             
 **************          
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='料品編號'          
     ENDWITH

     THIS.ADDOBJECT('TXTF01','TEXTBOX')
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*8
          .WIDTH=INT_015*261
     ENDWITH 
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*39
         .WIDTH=INT_015*50
         .CAPTION='品名規格'
     ENDWITH
     THIS.ADDOBJECT('LBLF021','LABEL')
     WITH THIS.LBLF021
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .AUTOSIZE=.T.
          .TOP=INT_015*39
     ENDWITH 
   THIS.ADDOBJECT('LBLF99','LABEL')
     WITH THIS.LBLF99
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*64
          .WIDTH=INT_015*50
          .CAPTION='流水編號'
     ENDWITH
  THIS.ADDOBJECT('TXTF99','TEXTBOX')
     WITH THIS.TXTF99
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .WIDTH=INT_015*75
          .TOP=INT_015*59
     ENDWITH      

  ENDPROC  
******************   
 PROCEDURE PAGEFRAME1.PAGE2.INIT
  THIS.ADDOBJECT('LBLF02','LABEL')
	WITH THIS.LBLF02  
	 .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	 .WIDTH=INT_015*50
         .CAPTION='異動日期'
    ENDWITH
   THIS.ADDOBJECT('TXTF02','TEXTBOX')
	WITH THIS.TXTF02    
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*74
	     .HEIGHT=INT_015*25
	     .NAME='TXTF02'  
	ENDWITH   
  THIS.ADDOBJECT('LBLF03','LABEL')
	WITH THIS.LBLF03  
	 .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*43
	 .WIDTH=INT_015*50
         .CAPTION='單據類別'
    ENDWITH
   THIS.ADDOBJECT('TXTF03','TEXTBOX')
	WITH THIS.TXTF03
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .NAME='TXTF03'  
	ENDWITH  	
   THIS.ADDOBJECT('LBLF04','LABEL')         
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*68
         .AUTOSIZE=.T.
         .CAPTION='異動數量'
     ENDWITH 	             

   THIS.ADDOBJECT('TXTF04','TEXTBOX')
	WITH THIS.TXTF04
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*64
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .NAME='TXTF04'	    
  ENDWITH 
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='單     價'         
    ENDWITH
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*89
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .NAME='TXTF05'
    ENDWITH 
    THIS.ADDOBJECT('LBLFTL','LABEL')
    WITH THIS.LBLFTL
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='金額小計'         
    ENDWITH
    THIS.ADDOBJECT('TXTFTL','TEXTBOX')
    WITH THIS.TXTFTL
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*114
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .NAME='TXTFTL'
    ENDWITH   	        
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*143
         .WIDTH=INT_015*50
         .CAPTION='累計數量'         
    ENDWITH
    THIS.ADDOBJECT('TXTF06','TEXTBOX')
    WITH THIS.TXTF06
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*139
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .NAME='TXTF06'
    ENDWITH   	
  THIS.ADDOBJECT('LBLF07','LABEL')
    WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*168
	     .WIDTH=INT_015*50
	     .CAPTION='備註說明'
	ENDWITH         
  THIS.ADDOBJECT('TXTF07','TEXTBOX')
	WITH THIS.TXTF07
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*164
	     .WIDTH=INT_015*420
	     .HEIGHT=INT_015*25
	     .NAME='TXTF07'  
	ENDWITH 
  ENDPROC
*******************         
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE B01_1
     IF THISFORM.KEY_LIST.VALUE=1
        SET ORDER TO B01_11
     ELSE
       SET ORDER TO B01_12
     ENDIF         
     THISFORM.GRID1.ENABLED=.T.   
     THISFORM.GRID1.SETFOCUS   
     THISFORM.KEY_LIST.ENABLED=.T.
    IF THISFORM.GRID1.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F. 
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.    
        THISFORM.EXCEL_BOTT.ENABLED=.F. 
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.)
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
  ENDPROC
  *****************
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
        SELE G1F    
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS       
        THISFORM.EXCEL_BOTT.ENABLED=.F.
     IF THISFORM.GRID2.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC  
****************     
  PROC INIT      
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*9
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*9  
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.       
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.              
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')        
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146) 
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B01_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01_1.F02'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='異動日期'
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='單據類別'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='異動數量'       
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='單        價'	
       THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='金額小計'
       THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='累計數量'
       THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='銷售毛利'	
       THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='備註說明'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='G1F.F02'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='BILL(G1F.F03)'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='G1F.F04'       
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='G1F.F05'
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE="ROUND(G1F.F04*G1F.F05,2)"
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE="G1F.F06"       
       THISFORM.GRID2.COLUMN7.CONTROLSOURCE="G1F.F08"
       THISFORM.GRID2.COLUMN8.CONTROLSOURCE="G1F.F07"
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*55
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*80      
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*70
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*75
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*75
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*75
       THISFORM.GRID2.COLUMN8.WIDTH=INT_015*200
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(G1F.F08<0,RGB(255,0,0),'')","COLUMN")         
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.EXCEL_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.       
          THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.)
       ENDIF    
       THISFORM.KEY_LIST.DISPLAYVALUE='依料品編號排列'           
       JK='料品編號'   
       SELECT B01_1
       GO TOP   
  ENDPROC 
***************   
PROC KEY_LIST.INIT 
       WITH THIS
       	   .ADDITEM('依料品編號排列') 
           .ADDITEM('依流水編號排列')
       ENDWITH      
  ENDPROC 
 *************               
  PROC KEY_LIST.INTERACTIVECHANGE  
       SELECT B01_1
       DO CASE
       	  CASE THIS.DISPLAYVALUE='依料品編號排列'
       	       SET ORDER TO B01_11
       	       THISFORM.GRID1.CHILDORDER='B01_11'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料品編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B01_1.F01'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01_1.F02'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
	      CASE THIS.DISPLAYVALUE='依流水編號排列'
	    	   SET ORDER TO B01_12
	    	   THISFORM.GRID1.CHILDORDER='B01_12'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='流水編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料品編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B01_1.F99'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*75
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
	  ENDCASE
      THISFORM.GRID1.SETFOCUS  	            
  ENDPROC   
***********
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX   
       IF THISFORM.KEY_LIST.DISPLAYVALUE='依料品編號排列'   
              
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B01_1.F01
	       THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=B01_1.F02  
	       THISFORM.PAGEFRAME1.PAGE1.TXTF99.VALUE=B01_1.F99 
	         
	ENDIF       
       FCH=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.EXCEL_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.)
       ENDIF          
       CHK=''
*       THISFORM.REFRESH
  ENDPROC  
********************     
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX

	THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=G1F.F02
	THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=BILL(G1F.F03)
	THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=G1F.F04
	THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=G1F.F05
    THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=G1F.F06
    THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=G1F.F07
    THISFORM.PAGEFRAME1.PAGE2.TXTFTL.VALUE=ROUND(G1F.F06*G1F.F05,2)
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THISFORM.GRID2.COLUMN1.HEADER1.CAPTION
      CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.EXCEL_BOTT.ENABLED=.F.
       ENDIF   
*       THISFORM.REFRESH
  ENDPROC
************************  
PROC EXCEL_BOTT.CLICK     &&轉出EXCEL
     LK=B01_1.F01
     SELECT F01 料品編號,F02 異動日期,BILL(F03) 單據類別,F04 異動數量,F05 單價,ROUND(F04*F05,2) 金額小計,F06 累計數量,F08 銷售毛利,F07 備註說明  FROM G1F WHERE F01=LK ORDER BY F02 NOWAIT
     IF _TALLY>0
         FILE_NAME='G14期間存貨明細表(資料範圍'+DATA_RANG+')'   
       
	      GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
		  IF EMPTY(GCDELIMFILE)  && ESC PRESSED
	         RETURN
	      ELSE
                     ON ERROR DO FILE_IMPACT 
                    
	             COPY TO (GCDELIMFILE) TYPE XL5   
	             =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗')    
	             
	      ENDIF		      	  	
     ENDIF
 ENDPROC
ENDDEFINE    
***********************************************列印程序BILL(LEFT(B99.F01,2)) REP_NAME
PROCEDURE PNT_PRC  
  LK=B01_1.F01
  LL=B01_1.F02
  LM=B01_1.F99
  SELECT * FROM G1F WHERE F01=LK ORDER BY F02 NOWAIT
  IF _TALLY>0
     REPORT FORM ALLTRIM(INT_116)+'G14' TO PRINT PROMPT PREVIEW
  ENDIF
      
ENDPROC
************************************************單據類別     
FUNC BILL
     PARA JUK
     JO=''
     DO CASE
        CASE JUK=' '
             JO='期初'
        CASE JUK='A'
             JO='進貨單'
        CASE JUK='B'
             JO='進貨退出單'
        CASE JUK='C'
             JO='出貨單'
        CASE JUK='D'
             JO='出貨退回單'
        CASE JUK='E'
             JO='移轉單'
        CASE JUK='H'
             JO='盤差調整單'
        CASE JUK='I'
             JO='報廢單'             
        CASE JUK='K'
             JO='製令用料耗損單'
        CASE JUK='L'
             JO='退回入倉單'
        CASE JUK='M'
             JO='委外入庫單'             
        CASE JUK='N'
             JO='進貨檢驗單'
        CASE JUK='P'
             JO='製令領料單'             
        CASE JUK='Q'
             JO='額外生產耗料單'             
        CASE JUK='T'
             JO='完工入庫單'  
        CASE JUK='R'
             JO='製品退出單'               
        CASE JUK='G'
             JO='客供品進貨單'                            
        CASE JUK='Z'
             JO='樣品領用單'     
        CASE JUK='F'
             JO='樣品申請單(廠商)'        
        CASE JUK='1'
             JO='其他進貨費用'                        
     ENDCASE
     RETURN JO 