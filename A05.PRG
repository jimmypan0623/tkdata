***************A05目前作業記錄管理****************
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
R=0
AREA1='A04_1'
AREA2='A05'
IF !USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A03')
   SELE 0
   USE A03
ELSE 
   SELE A03
ENDIF
SET ORDER TO A03
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE 
   SELE A02
ENDIF
SET ORDER TO A021
SEEK SYS_OPER+'A05'
SET RELA TO F03 INTO A03
IF !USED('A04')
   SELE 0
   USE A04 INDE A04
ELSE 
   SELE A04
ENDIF
SET ORDER TO A041
SELECT A04.F01,A04.F04,A01.F03 FROM A01,A04 WHERE A04.F01 = A01.F01 AND A04.F01 <> 'zzzzz'  GROUP BY A04.F01 ORDER BY A04.F01 INTO CURSOR A04_1 READWRITE 
SELECT A04_1
INDE ON F01 TAG A04_11
GO TOP
IF !USED('A05')
   SELE 0
   USE A05 INDE A05
ELSE 
   SELE A05
ENDIF
SET ORDER TO A051
*************************建立表單A05FORM*************************         
A05FORM=CREATEOBJECT("TKA05")
A05FORM.SHOW  
DEFINE CLASS TKA05 AS FORM
  CAPTION='A05.目前作業記錄管理'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*791
  WINDOWTYPE=1
  NAME='TKA05'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH; 
      AUTOCENTER=.T.
  ADD OBJECT SHAPE2 AS SHAPE2 WITH; 
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH; 
      AUTOCENTER=.T.
**************************************************
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;      
      PAGECOUNT=2,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;              
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='登入者姓名',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='正在使用作業'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH; &&目前資料排序
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=2,;            
      RECORDSOURCE='A04_1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=3,;            
      RECORDSOURCE='A05',;
      LINKMASTER='A04_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER='A051',; 
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH; 
      AUTOSIZE=.T.
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;  
      AUTOSIZE=.T.
  ADD OBJECT SHRGROUP AS SHRGROUP WITH; 
      TOP=INT_015*165,;
      LEFT=INT_015*640 
*************************設定PAGE1***************************                
  PROCEDURE PAGEFRAME1.PAGE1.INIT   
  THIS.ADDOBJECT('LBLF01','LABEL') 
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*15
          .TOP=INT_015*25
          .WIDTH=INT_015*50
          .CAPTION='登入帳號'           
     ENDWITH
  THIS.ADDOBJECT('TXTF01','TEXTBOX')      
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*66
          .TOP=INT_015*19
          .WIDTH=INT_015*50
          .HEIGHT=INT_015*25
          .MAXLENGTH=5         
     ENDWITH  
   THIS.ADDOBJECT('LBLF03','LABEL') 
     WITH THIS.LBLF03
          .VISIBLE=.T.
          .LEFT=INT_015*15
          .TOP=INT_015*51
          .WIDTH=INT_015*50
          .CAPTION='人員姓名'    
     ENDWITH
 THIS.ADDOBJECT('TXTF03','TEXTBOX')      
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*66
          .TOP=INT_015*45
          .WIDTH=INT_015*60
          .HEIGHT=INT_015*80
   ENDWITH
    
  THIS.ADDOBJECT('LBLF04','LABEL')  
     WITH THIS.LBLF04
          .VISIBLE=.T.
          .LEFT=INT_015*15
          .TOP=INT_015*77
          .WIDTH=INT_015*50
          .CAPTION='登入時間'    
     ENDWITH     
  THIS.ADDOBJECT('TXTF04','TEXTBOX')     
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*66
          .TOP=INT_015*71
          .WIDTH=INT_015*169
          .HEIGHT=INT_015*20
          .MAXLENGTH=18      
     ENDWITH  


  ENDPROC
********************************設定PAGE2***************************    
  PROCEDURE PAGEFRAME1.PAGE2.INIT
 THIS.ADDOBJECT('LBLF02','LABEL') 
    WITH THIS.LBLF02
         .LEFT=INT_015*15
         .TOP=INT_015*25
         .CAPTION='程式編號'
         .WIDTH=INT_015*50
         .VISIBLE=.T.
    ENDWITH
  THIS.ADDOBJECT('TXTF02','TEXTBOX') 
    WITH THIS.TXTF02
         .LEFT=INT_015*66
         .TOP=INT_015*19
         .WIDTH=INT_015*70      
         .HEIGHT=INT_015*20
         .MAXLENGTH=11
         .VISIBLE=.T.
     ENDWITH
  THIS.ADDOBJECT('LBLF03','LABEL') 
    WITH THIS.LBLF03
         .LEFT=INT_015*15
         .TOP=INT_015*51
         .CAPTION='程式說明'
         .WIDTH=INT_015*50
         .VISIBLE=.T.
     ENDWITH
  THIS.ADDOBJECT('TXTF03','TEXTBOX') 
    WITH THIS.TXTF03
         .LEFT=INT_015*66
         .TOP=INT_015*45
         .WIDTH=INT_015*350    
         .HEIGHT=INT_015*20
         .MAXLENGTH=80
         .VISIBLE=.T.
     ENDWITH
THIS.ADDOBJECT('LBLF04','LABEL') 
    WITH THIS.LBLF04
         .LEFT=INT_015*15
         .TOP=INT_015*77
         .CAPTION='進入時間'
         .WIDTH=INT_015*50
         .VISIBLE=.T.
    ENDWITH
  THIS.ADDOBJECT('TXTF04','TEXTBOX') 
    WITH THIS.TXTF04
         .LEFT=INT_015*66
         .TOP=INT_015*70
         .WIDTH=INT_015*350    
         .HEIGHT=INT_015*20
         .MAXLENGTH=100
         .VISIBLE=.T.
     ENDWITH
  ENDPROC
******************
PROC INIT
       SELECT A04_1
       GO TOP
       THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
       THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)                   
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10       
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')        
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='登入帳號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='人員姓名'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='A04_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A04_1.F03'
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(A05.F04<>'1',RGB(255,0,0),'')","COLUMN")         
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='程式編號'                                         
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='程式說明'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='進入時間'
      
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='A05.F02'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='A05.F03'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE="A05.F04"
       
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*250
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*250
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID2.READONLY=.T.          
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
	      THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          
       ELSE  
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.        
	      THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限  
          
       ENDIF     
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.    
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
       JK='資料檔名'       
  ENDPROC     
******************設定PAGE1之動態動作******************        
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     SELECT  A04_1
     R=0
    THISFORM.KEY_LIST.ENABLED=.T.
    THISFORM.GRID1.ENABLED=.T.   
    THISFORM.GRID1.SETFOCUS 
    THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
    THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)
    THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.F.
    THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,0)  
    THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
     IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
         THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
         THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
         THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
         THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
         THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
         THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F. 
         THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
         
         THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
         THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
     ELSE
         THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
         THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
         THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
         THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
         THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
         THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  &&判斷有無刪除的權限  
         
     ENDIF
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.    
     THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
   ENDPROC
*****************設定PAGE2之動態動作***********
PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
    SELECT  A05
    IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
	THISFORM.GRID2.SETFOCUS         
    ENDIF 
    THISFORM.KEY_LIST.ENABLED=.F.   
    THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.F.
    THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,0)
    THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.T.
    THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,255)  
    IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        
    ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限 
    ENDIF 
	R=RECNO('&AREA1')  
	THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
        THISFORM.GRID1.ENABLED=.F.     
        
ENDPROC 
***************GRID1動態改變*********        
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
          SELECT A04_1
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A04_1.F01
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=A04_1.F03
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=A04_1.F04
  
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)    &&判斷有無刪除的權限    
          FCH=THISFORM.ACTIVECONTROL.NAME
          JK=THIS.COLUMN1.HEADER1.CAPTION  
          IF THIS.ACTIVEROW=0
              THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          ELSE
             THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          ENDIF   
          CHK=''     
*!*	      THISFORM.REFRESH
  ENDPROC  
***************GRID2動態改變***************       
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX        
       SELECT A05            
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=A05.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=A05.F03
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=A05.F04
       
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF  
*!*	       THISFORM.REFRESH
  ENDPROC
  ********************************************      
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依登入人員排列')
           .VALUE=1
       ENDWITH      
  ENDPROC

 *****************刪除***********
PROCEDURE ORPGROUP.DEL_BOTT.CLICK     
   IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        IF MESSAGEBOX('是否確定要刪除此筆資料檔之所有程式編號資料',4+32+256,'請確認')=6
             SELECT  RECNO() FROM A05 WHERE ALLTRIM(A05.F01)=ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE) INTO ARRAY BK1              
             JJ1=''                
             IF _TALLY>0   
                 FOR I= 1 TO ALEN(BK1)
                         JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                 ENDFOR    
                 KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                 RLOCK(KK1,'A05')
                 LL1=RLOCK(KK1,'A05')
             ELSE
                 LL1=.T.   
             ENDIF     
             IF LL1 AND LEN(ALLTRIM(JJ1))>0 
                 SELECT  A05
                 FOR I= 1 TO ALEN(BK1)
                         GO BK1(I) 
                         SELECT  A05 
                         DELETE
                  ENDFOR
              ENDIF 
              SELECT A04
              SEEK A04_1.F01
              IF FOUND()
                 REPLACE F01 WITH 'zzzzz'
              ENDIF 
              SELECT A04_1
              DELETE 
              
              SKIP -1
              IF BOF()
                 GO TOP
              ENDIF
              =MESSAGEBOX('此人員之操作程式編號資料已刪除成功!',0+64,'提示視窗')
              RELEASE ALL LIKE BK*         
              THISFORM.REFRESH                                 
        ENDIF  
        THISFORM.GRID1.SETFOCUS
   ELSE
        IF MESSAGEBOX('是否確定要刪除此操作編號之資料',4+32+256,'請確認')=6  
             SELECT  A05  
             LOCK()
             IF  RLOCK()
                  DELETE 
                  UNLOCK
                  SKIP -1
                  IF  BOF()
                       GO TOP
                  ENDIF   
                  THISFORM.GRID2.SETFOCUS
		          IF THISFORM.GRID2.ACTIVEROW=0 

		            
		             SELECT A04
		             SEEK A04_1.F01
		             IF FOUND()
		                REPLACE F01 WITH 'zzzzz'
		             ENDIF    
		             SELECT A04_1		             
		             DELETE 
		             SKIP -1
		             IF BOF()
		                GO TOP
		             ENDIF
		             THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
		             THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
		             THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
		             THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
		             THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
		             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
		             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
		             THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
		             THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''		       
		          ELSE
		             THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
		             THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
		             THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
		             THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
		             THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.		       
		             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
		          ENDIF 
		             =MESSAGEBOX('此筆程式編號之資料已刪除成功!',0+64,'提示視窗')		   
             ELSE
                    DO FILE_IMPACT 
                    RETURN    
             ENDIF 
        ENDIF           
    ENDIF  
  ENDPROC  
************************************

  ********************************  

ENDDEFINE 
 ***********************************************列印程序
