***程式名稱:K17發票管理
CLOSE ALL
CLEAR 
DBT_DT=DATE()
RSN_DSC=''
FTR_STR=''
FLG='0'
FCH=''
CHK=''
CHK_STR=''
R=0
QTY=0
TQTY=0
DA=''
AREA1='K25_1'
AREA2='K25'
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'K17'
IF !USED('C00')
   SELE 0
   USE C00 INDE C00
ELSE
   SELE C00
ENDIF
SET ORDER TO C001
IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011
CSTR=LEFT(C01.F01,1) &&客戶編號的第一碼
IF !USED('D01')
   SELE 0
   USE D01 
ELSE
   SELE D01
ENDIF
SET ORDER TO D011
DSTR=LEFT(D01.F01,1) &&廠商編號的第一碼
IF !USED('K2F')
   SELE 0
   USE K2F
ELSE
   SELE K2F
ENDIF
SET ORDER TO K2F1
IF !USED('K51')
   SELE 0
   USE K51 
ELSE
   SELE K51
ENDIF
SET ORDER TO K511
IF !USED('E02')
   SELE 0
   USE E02 
ELSE
   SELE E02
ENDIF
SET ORDER TO E021
ESTR=LEFT(E02.F01,1) &&外包商編號的第一碼
CREATE CURSOR SPLY;
(F01 C(5),F02 C(4),F04 C(8))
INDE ON F01 TAG SPLY1
INDE ON F04 TAG SLPY2
APPEND FROM C01
APPEND FROM D01
APPEND FROM E02
SET ORDER TO 1
B06='B06'+LEFT(DTOS(DATE()),6)
B062='B062'+LEFT(DTOS(DATE()),6)
IF !USED('&B06')
   SELE 0
   USE (B06) ALIA B06
ELSE 
   SELE B06
ENDIF
SET ORDER TO B062
C13='C13'+LEFT(DTOS(DATE()),6)
C133='C133'+LEFT(DTOS(DATE()),6)
C134='C134'+LEFT(DTOS(DATE()),6)
IF !USED('&C13')
   SELE 0
   USE (C13) ALIA C13
ELSE 
   SELE C13
ENDIF
SET ORDER TO C134
E20='E20'+LEFT(DTOS(DATE()),6)
E203='E203'+LEFT(DTOS(DATE()),6)
E204='E204'+LEFT(DTOS(DATE()),6)
IF !USED('&E20')
   SELE 0
   USE (E20) ALIA E20
ELSE 
   SELE E20
ENDIF
SET ORDER TO E204       
D19='D19'+LEFT(DTOS(DATE()),6)
D193='D193'+LEFT(DTOS(DATE()),6)
D194='D194'+LEFT(DTOS(DATE()),6)
IF !USED('&D19')
   SELE 0
   USE (D19) ALIA D19
ELSE 
   SELE D19
ENDIF
SET ORDER TO D194       
P19='P19'+LEFT(DTOS(DATE()),6)
P193='P193'+LEFT(DTOS(DATE()),6)
P194='P194'+LEFT(DTOS(DATE()),6)
P195='P195'+LEFT(DTOS(DATE()),6)
IF !USED('&P19')
   SELE 0
   USE (P19) ALIA P19
ELSE 
   SELE P19   
ENDIF
SET ORDER TO P195       
K24='K24'+LEFT(DTOS(DATE()),6)   &&發票明細檔表頭
K241='K241'+LEFT(DTOS(DATE()),6)
K242='K242'+LEFT(DTOS(DATE()),6)
IF !USED('&K24')
   SELE 0
   USE (K24) ALIA K24
ELSE
   SELE K24
ENDIF
SET ORDER TO K241 
K25='K25'+LEFT(DTOS(DATE()),6)
K256='K256'+LEFT(DTOS(DATE()),6)
K254='K254'+LEFT(DTOS(DATE()),6)
IF !USED('&K25')
   SELE 0
   USE (K25) ALIA K25
ELSE
   SELE K25
ENDIF
SET ORDER TO K254  
SET RELA TO F03 INTO SPLY
WAIT WINDOW "資料匯入中,請稍後!" AT 0,150 NOWAIT NOCLEAR
CREATE CURSOR K25_3;
(F03 C(5),F08 N(14,2),F10 N(14,2),F12 N(14,2),F13 N(4),F14 N(4),F15 N(4),F16 N(4),F17 N(4),F18 C(8))
INDE ON F03 TAG K25_31
SELECT * FROM K24 ORDER BY K24.F02 WHERE EMPTY(K24.F01) INTO CURSOR K24_TEMP
SELE K24_TEMP
GO TOP 
DO WHILE !EOF()
	   SELE K25_3
	   APPEND BLANK
	   REPL K25_3.F03 WITH K24_TEMP.F02
	   REPL K25_3.F08 WITH K24_TEMP.F03
	   REPL K25_3.F10 WITH K24_TEMP.F04
	   REPL K25_3.F12 WITH K24_TEMP.F05
	   REPL K25_3.F13 WITH K24_TEMP.F06
	   REPL K25_3.F14 WITH K24_TEMP.F07
	   REPL K25_3.F15 WITH K24_TEMP.F08
	   REPL K25_3.F16 WITH K24_TEMP.F09
	   REPL K25_3.F17 WITH K24_TEMP.F10     
	   IF ALLTRIM(K24_TEMP.F02)='作廢'
	        REPL K25_3.F18 WITH '作廢發票'
	   ELSE
	        REPL K25_3.F18 WITH IIF(INDEXSEEK(K24_TEMP.F02,.T.,'SPLY','SPLY1'),SPLY.F04,'')
	   ENDIF
	   SELE K24_TEMP
	   SKIP   
ENDDO
SELE K24_TEMP
USE   
CREATE CURSOR K25_1;
(F01 C(2),F08 N(14,2),F10 N(14,2),F12 N(14,2),F13 N(4),F14 N(4),F15 N(4),F16 N(4),F17 N(4),F18 C(40))
INDE ON F01 TAG K25_11
SELE * FROM K24 ORDER BY K24.F01 WHERE EMPTY(K24.F02) INTO CURSOR K24_TEMP
SELE K24_TEMP
GO TOP
DO WHILE !EOF()
           SELE K25_1
           APPEND BLANK
           REPL K25_1.F01 WITH K24_TEMP.F01
	   REPL K25_1.F08 WITH K24_TEMP.F03
	   REPL K25_1.F10 WITH K24_TEMP.F04
	   REPL K25_1.F12 WITH K24_TEMP.F05
	   REPL K25_1.F13 WITH K24_TEMP.F06
	   REPL K25_1.F14 WITH K24_TEMP.F07
	   REPL K25_1.F15 WITH K24_TEMP.F08
	   REPL K25_1.F16 WITH K24_TEMP.F09
	   REPL K25_1.F17 WITH K24_TEMP.F10      
   	   REPL K25_1.F18 WITH BILL(K25_1.F01)             
           SELE K24_TEMP
           SKIP   
ENDDO
SELE K24_TEMP
USE   
SELE K25_1
SET ORDER TO K25_11
WAIT CLEAR
***************
K17FORM=CREATEOBJECT("TKK17")
K17FORM.SHOW  
DEFINE CLASS TKK17 AS FORM
  CAPTION='K17.發票管理'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKK17'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*232,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=2,;            
      RECORDSOURCE='K25_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      TOP=INT_015*233,; 
      HEIGHT=INT_015*284,;  
      COLUMNCOUNT=8,;            
      RECORDSOURCE='K25',; 
      LINKMASTER='K25_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER='K254',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7',;
      COLUMN8.NAME='COLUMN8'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.                             
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T. 
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*198,;
      LEFT=INT_015*675 
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*12,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;      
      CAPTION='\<A.內容',;
      NAME='ANS_BOTT' 
  ADD OBJECT SEND_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*55,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;      
      CAPTION='\<S.上傳',;
      NAME='SEND_BOTT'         
  ADD OBJECT SPC_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*98,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;      
      CAPTION='\<K.空白',;
      NAME='SPC_BOTT'   
  ADD OBJECT CNC_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*144,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;      
      CAPTION='\<C.作廢',;
      NAME='CNC_BOTT'  
   ADD OBJECT BILL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*185,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*40,;      
      CAPTION='\<B.帳款',;
      NAME='BILL_BOTT'         
  ADD OBJECT K2F_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*78,;
      LEFT=INT_015*705,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*65,;      
      CAPTION='\<M.多重憑證',;
      NAME='K2F_BOTT'         
  ADD OBJECT BTTF06 AS COMMANDBUTTON WITH;
      TOP=INT_015*78,;
      LEFT=INT_015*450,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<W.修改報單',;
      NAME='BTTF06'
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01 
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='發票代號' 
     ENDWITH
     THIS.ADDOBJECT('LBLJLK','LABEL')
     WITH THIS.LBLJLK
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='發票類別'
     ENDWITH
     THIS.ADDOBJECT('LBLJLK1','LABEL')
     WITH THIS.LBLJLK1
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH 
     THIS.ADDOBJECT('LBLTTL1','LABEL')
     WITH THIS.LBLTTL1
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='銷售金額'
         .ALIGNMENT=2 
     ENDWITH    
     THIS.ADDOBJECT('LBLTTL11','LABEL')
     WITH THIS.LBLTTL11
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*63
         .WIDTH=INT_015*100
         .ALIGNMENT=2         
     ENDWITH               
     THIS.ADDOBJECT('LBLTTL2','LABEL')
     WITH THIS.LBLTTL2
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='營業稅額'
     ENDWITH    
     THIS.ADDOBJECT('LBLTTL21','LABEL')
     WITH THIS.LBLTTL21
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*88
         .WIDTH=INT_015*100
         .ALIGNMENT=2         
     ENDWITH                    
     THIS.ADDOBJECT('LBLTTL3','LABEL')
     WITH THIS.LBLTTL3
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .CAPTION='發票總額'
     ENDWITH         
     THIS.ADDOBJECT('LBLTTL31','LABEL')
     WITH THIS.LBLTTL31
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*113
         .WIDTH=INT_015*100
         .ALIGNMENT=2                  
     ENDWITH                  
     THIS.ADDOBJECT('LBLTTL4','LABEL')
     WITH THIS.LBLTTL4
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='應稅'
     ENDWITH                         
     THIS.ADDOBJECT('LBLTTL41','LABEL')
     WITH THIS.LBLTTL41
         .VISIBLE=.T.
         .LEFT=INT_015*44
         .TOP=INT_015*138
         .WIDTH=INT_015*50         
     ENDWITH                              
     THIS.ADDOBJECT('LBLTTL5','LABEL')
     WITH THIS.LBLTTL5
         .VISIBLE=.T.
         .LEFT=INT_015*114
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='零稅'
     ENDWITH                         
     THIS.ADDOBJECT('LBLTTL51','LABEL')
     WITH THIS.LBLTTL51
         .VISIBLE=.T.
         .LEFT=INT_015*144
         .TOP=INT_015*138
         .WIDTH=INT_015*50         
     ENDWITH                               
     THIS.ADDOBJECT('LBLTTL6','LABEL')
     WITH THIS.LBLTTL6
         .VISIBLE=.T.
         .LEFT=INT_015*214
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='免稅'
     ENDWITH                         
     THIS.ADDOBJECT('LBLTTL61','LABEL')
     WITH THIS.LBLTTL61
         .VISIBLE=.T.
         .LEFT=INT_015*244
         .TOP=INT_015*138
         .WIDTH=INT_015*50         
     ENDWITH                               
     THIS.ADDOBJECT('LBLTTL7','LABEL')
     WITH THIS.LBLTTL7
         .VISIBLE=.T.
         .LEFT=INT_015*314
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='作廢'
     ENDWITH                         
     THIS.ADDOBJECT('LBLTTL71','LABEL')
     WITH THIS.LBLTTL71
         .VISIBLE=.T.
         .LEFT=INT_015*344
         .TOP=INT_015*138
         .WIDTH=INT_015*50         
     ENDWITH                               
     THIS.ADDOBJECT('LBLTTL8','LABEL')
     WITH THIS.LBLTTL8
         .VISIBLE=.T.
         .LEFT=INT_015*414
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='空白'
     ENDWITH                         
     THIS.ADDOBJECT('LBLTTL81','LABEL')
     WITH THIS.LBLTTL81
         .VISIBLE=.T.
         .LEFT=INT_015*444
         .TOP=INT_015*138
         .WIDTH=INT_015*50         
     ENDWITH                               
     THIS.ADDOBJECT('TXTF03','TXTF03')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*25
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
          .NAME='TXTF03'
     ENDWITH
     THIS.ADDOBJECT('INV_TYPE','INV_TYPE')    
      WITH THIS.INV_TYPE
           .TOP=INT_015*9
           .LEFT=INT_015*64
           .HEIGHT=INT_015*25
  	   .WIDTH=INT_015*40
      ENDWITH
  ENDPROC 
************    
  PROCEDURE PAGEFRAME1.PAGE2.INIT
    THIS.ADDOBJECT('LBLF07','LABEL')
    WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*7
	     .WIDTH=INT_015*50
	     .CAPTION='發票號碼'
	ENDWITH       	
    THIS.ADDOBJECT('LBLF02','LABEL')
    WITH THIS.LBLF02
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*32
	     .WIDTH=INT_015*50
	     .CAPTION='發票日期'
	ENDWITH     	
    THIS.ADDOBJECT('LBLF091','LABEL')
    WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*100
         .TOP=INT_015*32
         .AUTOSIZE=.T.
    ENDWITH         
    THIS.ADDOBJECT('LBLF051','LABEL')
    WITH THIS.LBLF051	
         .VISIBLE=.T.
         .LEFT=INT_015*150
         .TOP=INT_015*32
         .AUTOSIZE=.T.
    ENDWITH     
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='報單號碼'	     
	ENDWITH       		
    THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*82
         .WIDTH=INT_015*50
         .CAPTION='銷售金額'       
    ENDWITH    
    THIS.ADDOBJECT('LBLF10','LABEL')
    WITH THIS.LBLF10
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='營業稅額'       
    ENDWITH        
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='發票總額'       
    ENDWITH            
    THIS.ADDOBJECT('LBLF03','LABEL')
    WITH THIS.LBLF03
         .VISIBLE=.T.
	     .LEFT=INT_015*298
	     .TOP=INT_015*7
	     .WIDTH=INT_015*50
	     .CAPTION='對  象  別'
	ENDWITH     	    
    THIS.ADDOBJECT('LBLF031','LABEL')
    WITH THIS.LBLF031
         .VISIBLE=.T.
	     .LEFT=INT_015*410
	     .TOP=INT_015*7
	     .AUTOSIZE=.T.
	ENDWITH     			
    THIS.ADDOBJECT('LBLF04','LABEL')    
    WITH THIS.LBLF04
         .VISIBLE=.T.           
         .LEFT=INT_015*298
         .TOP=INT_015*32
         .WIDTH=INT_015*50
         .CAPTION='統一編號'
    ENDWITH     
    THIS.ADDOBJECT('LBLF15','LABEL')    
    WITH THIS.LBLF15
         .VISIBLE=.T.           
         .LEFT=INT_015*298
         .TOP=INT_015*57
         .WIDTH=INT_015*60
         .CAPTION='憑證單號'
    ENDWITH             
    THIS.ADDOBJECT('LBLF151','LABEL')    
    WITH THIS.LBLF151
         .VISIBLE=.T.           
         .LEFT=INT_015*439
         .TOP=INT_015*57
         .WIDTH=INT_015*50
         .CAPTION=''
    ENDWITH      
    THIS.ADDOBJECT('LBLF23','LABEL')
    WITH THIS.LBLF23
         .VISIBLE=.T.    
         .LEFT=INT_015*298
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='外幣金額'       
    ENDWITH   
    THIS.ADDOBJECT('LBLF231','LABEL')
    WITH THIS.LBLF231
         .VISIBLE=.T.    
         .LEFT=INT_015*360
         .TOP=INT_015*132
         .AUTOSIZE=.T.
         .CAPTION=''       
    ENDWITH        
    THIS.ADDOBJECT('LBLF20','LABEL')
    WITH THIS.LBLF20
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*158
         .WIDTH=INT_015*50
         .CAPTION='備        註'       
    ENDWITH
    THIS.ADDOBJECT('LBLF21','LABEL')
    WITH THIS.LBLF21
         .VISIBLE=.T.    
         .LEFT=INT_015*298
         .TOP=INT_015*82
         .WIDTH=INT_015*50
         .CAPTION='幣        別'       
    ENDWITH    
    THIS.ADDOBJECT('LBLF22','LABEL')
    WITH THIS.LBLF22
         .VISIBLE=.T.    
         .LEFT=INT_015*298
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='匯        率'       
    ENDWITH     
    THIS.ADDOBJECT('LBLF16','LABEL')
    WITH THIS.LBLF16
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*185
         .WIDTH=INT_015*50
         .CAPTION='狀        態'       
    ENDWITH
    THIS.ADDOBJECT('LBLF161','LABEL')
    WITH THIS.LBLF161
         .VISIBLE=.T.    
         .LEFT=INT_015*65
         .TOP=INT_015*185
         .AUTOSIZE=.T.
         .CAPTION=''       
    ENDWITH      
    THIS.ADDOBJECT('LBLF24','LABEL')
    WITH THIS.LBLF24
         .VISIBLE=.T.    
         .LEFT=INT_015*350
         .TOP=INT_015*158
         .WIDTH=INT_015*50
         .CAPTION='安全資料'       
    ENDWITH   
    THIS.ADDOBJECT('LBLF241','LABEL')
    WITH THIS.LBLF241
         .VISIBLE=.T.    
         .LEFT=INT_015*405
         .TOP=INT_015*158
         .AUTOSIZE=.T.
         .CAPTION=''       
    ENDWITH             
    THIS.ADDOBJECT('LBLF90','LABEL')
    WITH THIS.LBLF90
         .VISIBLE=.T.    
         .LEFT=INT_015*350
         .TOP=INT_015*185
         .WIDTH=INT_015*50
         .CAPTION='確認人員'       
    ENDWITH   
    THIS.ADDOBJECT('LBLF901','LABEL')
    WITH THIS.LBLF901
         .VISIBLE=.T.    
         .LEFT=INT_015*405
         .TOP=INT_015*185
         .AUTOSIZE=.T.
         .CAPTION=''       
    ENDWITH          
	THIS.ADDOBJECT('TXTF07','TEXTBOX')
	WITH THIS.TXTF07      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*3
	     .WIDTH=INT_015*88
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=10
	     .NAME='TXTF07'  
	ENDWITH         
	THIS.ADDOBJECT('TXTF02','TEXTBOX')	
	WITH THIS.TXTF02
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*28
	     .WIDTH=INT_015*25
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=2
	     .NAME='TXTF02'	    
	ENDWITH     	 	
    THIS.ADDOBJECT('TAX_TYPE','TAX_TYPE')
    THIS.ADDOBJECT('CUS_TYPE','CUS_TYPE')    
	THIS.ADDOBJECT('TXTF06','TEXTBOX')
	WITH THIS.TXTF06      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*53
	     .WIDTH=INT_015*149
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=20
	     .NAME='TXTF06'  
	ENDWITH         		
	THIS.AddObject('BTTF06_YES','BTTF06_YES')
	THIS.AddObject('BTTF06_NO','BTTF06_NO')	
    THIS.ADDOBJECT('TXTF08','TXTF08')
    WITH THIS.TXTF08
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*78
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='99999999999.99'
         .MAXLENGTH=14
         .NAME='TXTF08'
    ENDWITH             
    THIS.ADDOBJECT('TXTF10','TEXTBOX')
    WITH THIS.TXTF10
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*103
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='99999999999.99'
         .MAXLENGTH=14
         .NAME='TXTF10'
    ENDWITH             
    THIS.ADDOBJECT('TXTF12','TXTF12')
    WITH THIS.TXTF12
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*128
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='99999999999.99'
         .MAXLENGTH=14
         .NAME='TXTF12'
    ENDWITH                 
    THIS.ADDOBJECT('TXTF03','TXTF03')
    WITH THIS.TXTF03
         .VISIBLE=.T.
         .LEFT=INT_015*349
         .TOP=INT_015*3
         .WIDTH=INT_015*50
         .HEIGHT=INT_015*25
         .MAXLENGTH=5
         .NAME='TXTF03'
    ENDWITH   
    THIS.ADDOBJECT('TXTF04','TEXTBOX')
    WITH THIS.TXTF04
         .VISIBLE=.T.
         .LEFT=INT_015*349
         .TOP=INT_015*28
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .MAXLENGTH=8
         .NAME='TXTF04'
    ENDWITH         
    THIS.ADDOBJECT('TXTF15','TEXTBOX')
    WITH THIS.TXTF15
         .VISIBLE=.T.           
         .LEFT=INT_015*349
         .TOP=INT_015*53
         .WIDTH=INT_015*85
         .HEIGHT=INT_015*25
         .MAXLENGTH=10  
         .NAME='TXTF15'
    ENDWITH     
    THIS.ADDOBJECT('MTR_TYPE','MTR_TYPE')    
    THIS.ADDOBJECT('TXTF20','TEXTBOX')
    WITH THIS.TXTF20
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*153
         .WIDTH=INT_015*280
         .HEIGHT=INT_015*25
         .MAXLENGTH=40
         .NAME='TXTF20'
    ENDWITH      
  THIS.ADDOBJECT('TXTF21','TEXTBOX')
    WITH THIS.TXTF21
         .VISIBLE=.T.           
         .LEFT=INT_015*349
         .TOP=INT_015*78
         .WIDTH=INT_015*50
         .HEIGHT=INT_015*25
         .MAXLENGTH=4
         .NAME='TXTF21'
    ENDWITH  
  THIS.ADDOBJECT('CRCY','CRCY')   
    WITH THIS.CRCY   
         .LEFT=INT_015*349
         .TOP=INT_015*78
    ENDWITH       
  THIS.ADDOBJECT('TXTF22','TXTF22')
    WITH THIS.TXTF22
         .VISIBLE=.T.           
         .LEFT=INT_015*349
         .TOP=INT_015*103
         .WIDTH=INT_015*90
         .HEIGHT=INT_015*25
         .MAXLENGTH=11
         .INPUTMASK='9999.999999'         
         .NAME='TXTF22'
    ENDWITH                   
  ENDPROC 
*********
  PROC INIT       
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*9
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*9     
       CHK_STR=ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE)
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.K2F_BOTT.VISIBLE=.F. 
       THISFORM.BTTF06.VISIBLE=.F.        
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='發票代號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='發票種類'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K25_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE="BILL(K25_1.F01)"
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='發票號碼'               
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='日期'	  
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='對 象 別'
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='稅別'
       THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='銷售金額'
       THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='營業稅額'
       THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='發票總額'
       THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='統一編號'
       THISFORM.GRID2.LINKMASTER='K25_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K25.F07'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K25.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE="SPLY.F04"
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
       THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
       THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'   	      	   
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*30
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*55
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*30
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN8.WIDTH=INT_015*70
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(K25.F16='3' .OR. K25.F16='5','',IIF(K25.F16='2',RGB(255,255,0),IIF(K25.F16='1',RGB(255,0,0),RGB(0,255,255))))","COLUMN")
       THISFORM.GRID2.SETALL("DYNAMICFORECOLOR","IIF(!EMPTY(K25.F14),RGB(0,0,128),'')",'COLUMN')
        
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
       ELSE
       THISFORM.GRID1.AFTERROWCOLCHANGE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限 
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依發票代號排列'      
       JK='發票代號'
       SELE K25_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_1.F01
  ENDPROC       
********          
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依發票代號排列')      
           .ADDITEM('依對象編號排列') 
       ENDWITH      
  ENDPROC
********   
 PROC KEY_LIST.INTERACTIVECHANGE 
   GO TOP
  THISFORM.GRID1.RECORDSOURCE='' 
  THISFORM.GRID2.LINKMASTER=''
  THISFORM.GRID2.RELATIONALEXPR=''
  THISFORM.GRID2.CHILDORDER=''
  DO CASE
      CASE THIS.DISPLAYVALUE='依發票代號排列'
		   SELECT K25_1
		   SET ORDER TO K25_11
		       	SELECT K25
		       	SET ORDER TO K254
		       	AREA1='K25_1'
		       	THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='發票代號'
       			THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_1.F01
       			THISFORM.PAGEFRAME1.PAGE1.TXTF03.WIDTH=INT_015*25
       			THISFORM.PAGEFRAME1.PAGE1.LBLJLK.CAPTION='發票類別'
       			THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=K25_1.F18
       			THISFORM.PAGEFRAME1.PAGE2.LBLF03.CAPTION='對  象  別'
       			THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=K25.F03
       			THISFORM.PAGEFRAME1.PAGE2.TXTF03.WIDTH=INT_015*50
       			THISFORM.PAGEFRAME1.PAGE2.TXTF03.MAXLENGTH=5
	       		THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=SPLY.F04
		       	THISFORM.GRID1.RECORDSOURCE='K25_1'
			THISFORM.GRID2.LINKMASTER='K25_1'
			THISFORM.GRID2.RELATIONALEXPR='F01'
			THISFORM.GRID2.CHILDORDER='K254'
			THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='發票代號'
       			THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='發票類別'
       			THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K25_1.F01'
       			THISFORM.GRID1.COLUMN2.CONTROLSOURCE="BILL(K25_1.F01)"
       			THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
       			THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
			THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='對 象 別'
		        THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='稅別'
		        THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='銷售金額'
		        THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='營業稅額'
		        THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='發票總額'
		        THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='統一編號'
		        THISFORM.GRID2.COLUMN3.CONTROLSOURCE="SPLY.F04"
			THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
		        THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
		        THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
		        THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
		        THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'
		        THISFORM.GRID2.COLUMN3.WIDTH=INT_015*55
		        THISFORM.GRID2.COLUMN4.WIDTH=INT_015*30
		        THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
		        THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
		        THISFORM.GRID2.COLUMN7.WIDTH=INT_015*80
		        THISFORM.GRID2.COLUMN8.WIDTH=INT_015*70
	      CASE THIS.DISPLAYVALUE='依對象編號排列'
	      		SELECT K25_3
		       	SET ORDER TO K25_31
		       	SELECT K25
		       	SET ORDER TO K256
		       	AREA1='K25_3'
		       	THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='對象編號'
       			THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_3.F03
       			THISFORM.PAGEFRAME1.PAGE1.TXTF03.WIDTH=INT_015*50
       			THISFORM.PAGEFRAME1.PAGE1.LBLJLK.CAPTION='對  象  別'
       			THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=IIF(SEEK(K25_3.F03,'C01'),C01.F04,IIF(SEEK(K25_3.F03,'D01'),D01.F03,''))
       			THISFORM.PAGEFRAME1.PAGE2.LBLF03.CAPTION='發票類別'
       			THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=K25.F01+' '+BILL(K25.F01)
       			THISFORM.PAGEFRAME1.PAGE2.TXTF03.WIDTH=INT_015*180
       			THISFORM.PAGEFRAME1.PAGE2.TXTF03.MAXLENGTH=40
	       		THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
		       	THISFORM.GRID1.RECORDSOURCE='K25_3'
			THISFORM.GRID2.LINKMASTER='K25_3'
			THISFORM.GRID2.RELATIONALEXPR='F03'
			THISFORM.GRID2.CHILDORDER='K256'
			THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='對象編號'
       			THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對  象  別'
       			THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K25_3.F03'
       			THISFORM.GRID1.COLUMN2.CONTROLSOURCE='K25_3.F18'
       			THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
       			THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65 
			THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='發票代號及發票類別'
			THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='稅別'
		        THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='銷售金額'
		        THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='營業稅額'
		        THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='發票總額'
		        THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='統一編號'
		        THISFORM.GRID2.COLUMN3.CONTROLSOURCE="K25.F01+'.'+BILL(K25.F01)" 
			THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
		        THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
		        THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
		        THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
		        THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'
		        THISFORM.GRID2.COLUMN3.WIDTH=INT_015*150
		        THISFORM.GRID2.COLUMN4.WIDTH=INT_015*30
		        THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
		        THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
		        THISFORM.GRID2.COLUMN7.WIDTH=INT_015*80
		        THISFORM.GRID2.COLUMN8.WIDTH=INT_015*70
              ENDCASE	      
              THISFORM.GRID1.SETFOCUS
ENDPROC 
********* 
  PROC MTH_LIST.INTERACTIVECHANGE
       CHK_STR=ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE)
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.CHILDORDER=''   
       SELECT A23
       SEEK DTOS(CTOD(CHK_STR+'/01'))
       SELECT B06
       USE
       SELE C13
       USE
       SELECT E20
       USE
       SELE D19
       USE        
       SELE P19
       USE         
       SELECT K24
       USE
       SELE K25
       SET RELA OFF INTO K25_1
       SET RELA OFF INTO SPLY
       USE
       SELE K25_1
       USE
       SELE K25_3
       USE          
       B06='B06'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       B062='B062'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B06')
          SELE 0
          USE (B06) ALIA B06
       ELSE 
          SELE B06
       ENDIF
       SET ORDER TO B062
       C13='C13'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       C133='C133'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       C134='C134'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)       
       IF !USED('&C13')
          SELE 0
          USE (C13) ALIA C13
       ELSE 
          SELE C13
       ENDIF
       SET ORDER TO &C134
       E20='E20'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       E203='E203'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)       
       E204='E204'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)              
       IF !USED('&E20')
          SELE 0
          USE (E20) ALIA E20
       ELSE 
          SELE E20
       ENDIF
       SET ORDER TO E204                   
       D19='D19'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       D193='D193'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)  
       D194='D194'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)              
       IF !USED('&D19')
          SELE 0
          USE (D19) ALIA D19
       ELSE 
          SELE D19
       ENDIF
       SET ORDER TO D194             
       P19='P19'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       P193='P193'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)       
       P194='P194'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)       
       P195='P195'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)                     
       IF !USED('&P19')
          SELE 0
          USE (P19) ALIA P19
       ELSE 
          SELE P19
       ENDIF
       SET ORDER TO P195    
	   K24='K24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)   &&發票明細檔表頭
	   K241='K241'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	   K242='K242'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	IF !USED('&K24')
	   SELE 0
	   USE (K24) ALIA K24
	ELSE
	   SELE K24
	ENDIF
	SET ORDER TO K241                         
       K25='K25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       K256='K256'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)  
       K254='K254'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)      
       IF !USED('&K25')
          SELE 0
          USE (K25) ALIA K25
       ELSE
          SELE K25
       ENDIF
       SET ORDER TO 4   
       SET RELA TO F03 INTO SPLY
    WAIT WINDOW "資料匯入中,請稍後!" AT 0,150 NOWAIT NOCLEAR       
	CREATE CURSOR K25_3;
	(F03 C(5),F08 N(14,2),F10 N(14,2),F12 N(14,2),F13 N(4),F14 N(4),F15 N(4),F16 N(4),F17 N(4),F18 C(8))
	INDE ON F03 TAG K25_31
	SELECT * FROM K24 ORDER BY K24.F02 WHERE EMPTY(K24.F01) INTO CURSOR K24_TEMP
	SELE K24_TEMP
	GO TOP 
	DO WHILE !EOF()
		   SELE K25_3
		   APPEND BLANK
		   REPL K25_3.F03 WITH K24_TEMP.F02
		   REPL K25_3.F08 WITH K24_TEMP.F03
		   REPL K25_3.F10 WITH K24_TEMP.F04
		   REPL K25_3.F12 WITH K24_TEMP.F05
		   REPL K25_3.F13 WITH K24_TEMP.F06
		   REPL K25_3.F14 WITH K24_TEMP.F07
		   REPL K25_3.F15 WITH K24_TEMP.F08
		   REPL K25_3.F16 WITH K24_TEMP.F09
		   REPL K25_3.F17 WITH K24_TEMP.F10     
		   IF ALLTRIM(K24_TEMP.F02)='作廢'
		        REPL K25_3.F18 WITH '作廢發票'
		   ELSE
		        REPL K25_3.F18 WITH IIF(INDEXSEEK(K24_TEMP.F02,.T.,'SPLY','SPLY1'),SPLY.F04,'')
		   ENDIF		   
		   SELE K24_TEMP
		   SKIP   
	ENDDO
	SELE K24_TEMP
	USE   
	CREATE CURSOR K25_1;
	(F01 C(2),F08 N(14,2),F10 N(14,2),F12 N(14,2),F13 N(4),F14 N(4),F15 N(4),F16 N(4),F17 N(4),F18 C(40))
	INDE ON F01 TAG K25_11
	SELE * FROM K24 ORDER BY K24.F01 WHERE EMPTY(K24.F02) INTO CURSOR K24_TEMP
	SELE K24_TEMP
	GO TOP
	DO WHILE !EOF()
	   SELE K25_1
	   APPEND BLANK
	   REPL K25_1.F01 WITH K24_TEMP.F01
	   REPL K25_1.F08 WITH K24_TEMP.F03
	   REPL K25_1.F10 WITH K24_TEMP.F04
	   REPL K25_1.F12 WITH K24_TEMP.F05
	   REPL K25_1.F13 WITH K24_TEMP.F06
	   REPL K25_1.F14 WITH K24_TEMP.F07
	   REPL K25_1.F15 WITH K24_TEMP.F08
	   REPL K25_1.F16 WITH K24_TEMP.F09
	   REPL K25_1.F17 WITH K24_TEMP.F10      
	   REPL K25_1.F18 WITH BILL(K25_1.F01)             
	   SELE K24_TEMP
	   SKIP   
	ENDDO
	SELE K24_TEMP
	USE  
    SELE K25_1
    SET ORDER TO K25_11
    WAIT CLEAR     
****	
	IF THIS.DISPLAYVALUE='依發票代號排列'
       SELECT K25_1
       SET ORDER TO K25_11
       AREA1='K25_1'
       THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='發票代號'
   	   THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_1.F01
   	   THISFORM.PAGEFRAME1.PAGE1.TXTF03.WIDTH=INT_015*25
   	   THISFORM.PAGEFRAME1.PAGE1.LBLJLK.CAPTION='發票類別'
   	   THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=K25_1.F18
	   THISFORM.GRID1.RECORDSOURCE='K25_1'
	   THISFORM.GRID2.RECORDSOURCE='K25'
       THISFORM.GRID2.LINKMASTER='K25_1'
	   THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.GRID2.CHILDORDER='K254'
	   THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='發票代號'
   	   THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='發票類別'
   	   THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K25_1.F01'
   	   THISFORM.GRID1.COLUMN2.CONTROLSOURCE="BILL(K25_1.F01)"
   	   THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
   	   THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='對 象 別'
	   THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='稅別'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='銷售金額'
	   THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='營業稅額'
	   THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='發票總額'
	   THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='統一編號'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K25.F07'
   	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K25.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE="SPLY.F04"
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
       THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
       THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*55
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*30
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN8.WIDTH=INT_015*70
 	ELSE
       SELECT K25_3
	   SET ORDER TO K25_31
	   AREA1='K25_3'
	   THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='對象編號'
   		THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_3.F03
   		THISFORM.PAGEFRAME1.PAGE1.TXTF03.WIDTH=INT_015*50
   		THISFORM.PAGEFRAME1.PAGE1.LBLJLK.CAPTION='對  象  別'
   		THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=IIF(SEEK(K25_3.F03,'C01'),C01.F04,IIF(SEEK(K25_3.F03,'D01'),D01.F03,''))
	   THISFORM.GRID1.RECORDSOURCE='K25_3'
	   THISFORM.GRID2.RECORDSOURCE='K25'
		THISFORM.GRID2.LINKMASTER='K25_3'
		THISFORM.GRID2.RELATIONALEXPR='F03'
		THISFORM.GRID2.CHILDORDER='K256'
		THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='對象編號'
   		THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對  象  別'
   		THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K25_3.F03'
   		THISFORM.GRID1.COLUMN2.CONTROLSOURCE='K25_3.F18'
   		THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60
   		THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65
		THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='發票代號及發票類別'
		THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='稅別'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='銷售金額'
	   THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='營業稅額'
	   THISFORM.GRID2.COLUMN7.HEADER1.CAPTION='發票總額'
	   THISFORM.GRID2.COLUMN8.HEADER1.CAPTION='統一編號'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K25.F07'	   
   	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K25.F02'
	    THISFORM.GRID2.COLUMN3.CONTROLSOURCE="K25.F01+'.'+BILL(K25.F01)" 
		THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
	    THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
	    THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
	    THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
	    THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'
	    THISFORM.GRID2.COLUMN3.WIDTH=INT_015*150
	    THISFORM.GRID2.COLUMN4.WIDTH=INT_015*30
	    THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
	    THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
	    THISFORM.GRID2.COLUMN7.WIDTH=INT_015*80
	    THISFORM.GRID2.COLUMN8.WIDTH=INT_015*70
     ENDIF    	             
       THISFORM.KEY_LIST.INTERACTIVECHANGE
       THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.REFRESH
       THISFORM.GRID1.SETFOCUS        
       IF THISFORM.GRID1.ACTIVEROW=0
           THISFORM.CMDGROUP.ENABLED=.F.
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
       ELSE
           THISFORM.CMDGROUP.ENABLED=.T.      
           THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
       ENDIF          
  ENDPROC
********        
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE K25_1      
     THISFORM.K2F_BOTT.VISIBLE=.F. 
     THISFORM.BTTF06.VISIBLE=.F.      
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F. 
     ENDIF          
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.CNC_BOTT.ENABLED=.F.
        THISFORM.SEND_BOTT.ENABLED=.F.
        THISFORM.SPC_BOTT.ENABLED=.F.
	THISFORM.BILL_BOTT.ENABLED=.F.
	THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
	 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=''     
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION=TRANSFORM(0,'@J 999,999,999,999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=TRANSFORM(0,'@J 999,999,999,999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION=TRANSFORM(0,'@J 999,999,999,999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL41.CAPTION=TRANSFORM(0,'@J 9999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL51.CAPTION=TRANSFORM(0,'@J 9999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL61.CAPTION=TRANSFORM(0,'@J 9999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL71.CAPTION=TRANSFORM(0,'@J 9999')
        THISFORM.PAGEFRAME1.PAGE1.LBLTTL81.CAPTION=TRANSFORM(0,'@J 9999')                                
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.CNC_BOTT.ENABLED=.F.
        THISFORM.SEND_BOTT.ENABLED=.F.
        THISFORM.SPC_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.BILL_BOTT.ENABLED=IIF(AREA1='K25_3' AND A02.F08='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.)  AND LEFT(K25.F15,2)<>'BE'&&&&判斷有轉帳款的權限  
     ENDIF    
     THISFORM.GRID1.SETFOCUS
  ENDPROC
*******  
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
     SELE K25 
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.    
        THISFORM.GRID2.SETFOCUS   
     ENDIF  
       IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
          THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.CNC_BOTT.ENABLED=.F.
          THISFORM.SEND_BOTT.ENABLED=.F.
          THISFORM.SPC_BOTT.ENABLED=.F.
	      THISFORM.BILL_BOTT.ENABLED=.F.
	      THISFORM.K2F_BOTT.VISIBLE=.F. 
          THISFORM.BTTF06.VISIBLE=.F. 	      
          THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
          THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
          THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''        
          THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=''     
          THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION=''     
	      THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=''   
	      THISFORM.PAGEFRAME1.PAGE2.LBLF241.CAPTION='' 
	      THISFORM.PAGEFRAME1.PAGE2.LBLF901.CAPTION='' 
       ELSE
          THISFORM.K2F_BOTT.VISIBLE= THISFORM.SHRGROUP.ENABLED=.F. AND IIF(AREA1='K25_3',.F.,.T.) AND IIF(AREA1='K25_1' AND A02.F05='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.)  
          THISFORM.BTTF06.VISIBLE=IIF(K25.F16$'35',.T.,.F.) AND K25.F01='32' AND K25.F09='2' AND A02.F12='*'       
          THISFORM.BTTF06.ENABLED=IIF(K25.F16$'35',.T.,.F.) AND K25.F01='32' AND K25.F09='2' AND A02.F12='*'                 
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
          THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.ANS_BOTT.ENABLED=THISFORM.SHRGROUP.ENABLED=.F. AND IIF(AREA1='K25_1',.T.,.F.) AND K25.F16<>'2'      
          THISFORM.CNC_BOTT.ENABLED=THISFORM.SHRGROUP.ENABLED=.F. AND !EMPTY(K25.F14) AND IIF(AREA1='K25_1',IIF(K25.F16='2' OR K25.F16='3' OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) AND !A23.F09 &&AND BETWEEN(VAL(LEFT(DTOS(DATE()),6))-VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))+VAL(LEFT(DTOS(DATE()),6))%2,0,1)
          THISFORM.SEND_BOTT.ENABLED=THISFORM.SHRGROUP.ENABLED=.F. AND IIF(AREA1='K25_1' .AND. A02.F10='*',.T.,.F.) AND EMPTY(K25.F14) AND LEFT(K25.F01,1)='3' AND (K25.F07<>LEFT(K25.F15,10) AND 'B'+CHR(VAL(LEFT(K25.F07,2)))+SUBSTR(K25.F07,3,4)<>LEFT(K25.F15,6)) AND DATE()-CTOD(CHK_STR+'/'+K25.F02)<7 AND CTOD(CHK_STR+'/'+K25.F02)<=DATE()&&上傳電子發票
          THISFORM.SPC_BOTT.ENABLED=THISFORM.SHRGROUP.ENABLED=.F. AND IIF(AREA1='K25_1' .AND. A02.F09='*',.T.,.F.)  &&空白發票
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(AREA1='K25_1' AND A02.F05='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) AND EMPTY(K25.F14)   &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(AREA1='K25_1' AND A02.F06='*',IIF(K25.F16='2' OR K25.F16='3' OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.)  AND EMPTY(K25.F14)  AND !A23.F09 &&判斷有無刪除的權限      
          THISFORM.BILL_BOTT.ENABLED=THISFORM.SHRGROUP.ENABLED=.F. AND IIF(A02.F08='*',IIF(K25.F16='2' OR K25.F16='3' OR K25.F16='5',.F.,.T.),.F.) AND LEFT(K25.F15,2)<>'BE' &&&&判斷有轉帳款的權限  
       ENDIF   
   R=RECNO('&AREA1')
   THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
   THISFORM.GRID1.ENABLED=.F.     
   THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(AREA1='K25_1',IIF(A02.F04='*',.T.,.F.),.F.) AND !A23.F09    &&判斷有無新增的權限
   THISFORM.KEY_LIST.ENABLED=.F.     
   THISFORM.MTH_LIST.ENABLED=.F.     
 ENDPROC    
**************   
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX            
       IF AREA1='K25_1'
	       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_1.F01
	       THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=K25_1.F18
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION=TRANSFORM(K25_1.F08,'@J 999,999,999,999.99')
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=TRANSFORM(K25_1.F10,'@J 999,999,999,999.99')              
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION=TRANSFORM(K25_1.F12,'@J 999,999,999,999.99')  
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL41.CAPTION=TRANSFORM(K25_1.F13,'@J 9999')              
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL51.CAPTION=TRANSFORM(K25_1.F14,'@J 9999')                     
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL61.CAPTION=TRANSFORM(K25_1.F15,'@J 9999')                     
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL71.CAPTION=TRANSFORM(K25_1.F16,'@J 9999')                     
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL81.CAPTION=TRANSFORM(K25_1.F17,'@J 9999')
	       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(AREA1='K25_1',IIF(A02.F04='*',.T.,.F.),.F.) AND !A23.F09  &&判斷有無新增的權限  
	        
           THISFORM.BILL_BOTT.ENABLED=.F.
      ELSE 
	       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=K25_3.F03
	       THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=IIF(SEEK(K25_3.F03,'C01'),C01.F04,IIF(SEEK(K25_3.F03,'D01'),D01.F03,''))
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION=TRANSFORM(K25_3.F08,'@J 999,999,999,999.99')
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=TRANSFORM(K25_3.F10,'@J 999,999,999,999.99')              
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION=TRANSFORM(K25_3.F12,'@J 999,999,999,999.99')  
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL41.CAPTION=TRANSFORM(K25_3.F13,'@J 9999')              
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL51.CAPTION=TRANSFORM(K25_3.F14,'@J 9999')                     
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL61.CAPTION=TRANSFORM(K25_3.F15,'@J 9999')                     
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL71.CAPTION=TRANSFORM(K25_3.F16,'@J 9999')                     
	       THISFORM.PAGEFRAME1.PAGE1.LBLTTL81.CAPTION=TRANSFORM(K25_3.F17,'@J 9999')  
	       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
	       
               THISFORM.BILL_BOTT.ENABLED=IIF(AREA1='K25_3' AND A02.F08='*',IIF(K25.F16='2' .OR. K25.F16='3'  .OR. K25.F16='4' .OR. K25.F16='5',.F.,.T.),.F.) AND LEFT(K25.F15,2)<>'BE' &&&&判斷有轉帳款的權限  
       ENDIF                 
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F. 
       THISFORM.ANS_BOTT.ENABLED=.F.
       THISFORM.CNC_BOTT.ENABLED=.F.
       THISFORM.SEND_BOTT.ENABLED=.F.   
       THISFORM.SPC_BOTT.ENABLED=.F.                         
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.     
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       THISFORM.REFRESH
  ENDPROC
*********       
  PROCEDURE GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       IF AREA1='K25_3'
	      THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=K25.F01+'.'+BILL(K25.F01)
	      THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''                    	       
	      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
	      THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
     	  THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.   
     	  THISFORM.CNC_BOTT.ENABLED=.F.
     	  THISFORM.SEND_BOTT.ENABLED=.F.   
     	  THISFORM.SPC_BOTT.ENABLED=.F. 
     	  THISFORM.ANS_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2,.T.,.F.) AND K25.F16<>'2'
	   ELSE
	      THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=K25.F03
	      THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=SPLY.F04
	      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(AREA1='K25_1',IIF(A02.F04='*',.T.,.F.),.F.) AND !A23.F09 &&判斷有無新增的權限  
	      THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND AREA1='K25_1' AND A02.F05='*',IIF(K25.F16='2' OR K25.F16='3' OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) AND EMPTY(K25.F14)  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND AREA1='K25_1' AND A02.F06='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.)  AND EMPTY(K25.F14) AND !A23.F09&&判斷有無刪除的權限  
	      THISFORM.ANS_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2,.T.,.F.) AND K25.F16<>'2'
	      THISFORM.CNC_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND AREA1='K25_1',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) AND !EMPTY(K25.F14) AND !A23.F09 &&AND BETWEEN(VAL(LEFT(DTOS(DATE()),6))-VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))+VAL(LEFT(DTOS(DATE()),6))%2,0,1)
	      THISFORM.SEND_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2  AND AREA1='K25_1'  AND A02.F10='*',.T.,.F.)  AND EMPTY(K25.F14) AND LEFT(K25.F01,1)='3' AND (K25.F07<>LEFT(K25.F15,10) AND 'B'+CHR(VAL(LEFT(K25.F07,2)))+SUBSTR(K25.F07,3,4)<>LEFT(K25.F15,6)) AND DATE()-CTOD(CHK_STR+'/'+K25.F02)<7 AND CTOD(CHK_STR+'/'+K25.F02)<=DATE()&&上傳電子發票
	      THISFORM.SPC_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2  AND AREA1='K25_1'  AND A02.F09='*',.T.,.F.)  &&空白發票
       ENDIF
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=K25.F02	
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=K25.F04    	
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=K25.F06	              
       THISFORM.BTTF06.VISIBLE=IIF(K25.F16$'35',.T.,.F.) AND K25.F01='32' AND K25.F09='2' AND A02.F12='*'
       THISFORM.BTTF06.ENABLED=IIF(K25.F16$'35',.T.,.F.) AND K25.F01='32' AND K25.F09='2' AND A02.F12='*'       
       THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=K25.F07
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(K25.F05='2','經海關',IIF(K25.F05='1','不經海關',''))
       THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))     
       THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=K25.F08       
       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=K25.F10
       THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=K25.F12
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=LEFT(K25.F15,10)
       THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=RIGHT(K25.F15,10)       
       THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION=IIF(K25.F16='3','已轉帳款',IIF(K25.F16='2','已作廢',IIF(K25.F16='1','尚未處裡',IIF(K25.F16='5','補開發票且已轉帳款','補開發票'))))
       THISFORM.PAGEFRAME1.PAGE2.LBLF161.BACKCOLOR=IIF(K25.F16='3',RGB(58,186,152),IIF(K25.F16='2',RGB(255,255,0),IIF(K25.F16='1',RGB(255,0,0),IIF(K25.F16='5',RGB(58,186,152),RGB(0,255,255)))))
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=K25.F20
       THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=K25.F21
       THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE=K25.F22	  
       THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=ALLTRIM(TRANSFORM(K25.F23,'999999999999.999'))
       THISFORM.PAGEFRAME1.PAGE2.LBLF241.CAPTION=K25.F24
       THISFORM.PAGEFRAME1.PAGE2.LBLF901.CAPTION=K25.F90
       THISFORM.BILL_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2  .AND. A02.F08='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) AND LEFT(K25.F15,2)<>'BE'&&判斷有轉帳款的權限         	
       THISFORM.K2F_BOTT.VISIBLE=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2,.T.,.F.) AND IIF(AREA1='K25_3',.F.,.T.) AND IIF(AREA1='K25_1' AND A02.F05='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.)  
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*     THISFORM.REFRESH
  ENDPROC
*********   
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.GRID1.ENABLED=.F.
    THISFORM.GRID2.ENABLED=.F. 
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F. 
    THISFORM.CNC_BOTT.ENABLED=.F.
    THISFORM.SEND_BOTT.ENABLED=.F.
    THISFORM.SPC_BOTT.ENABLED=.F.
    THISFORM.BILL_BOTT.ENABLED=.F.
    THISFORM.K2F_BOTT.VISIBLE=.F.
    THISFORM.BTTF06.VISIBLE=.F.
    THISFORM.BTTF06.ENABLED=.F.    
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       &&處理表頭新增
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''       
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL11.CAPTION=''
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL21.CAPTION=''        
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL31.CAPTION=''     
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL41.CAPTION=''   
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL51.CAPTION=''   
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL61.CAPTION=''   
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL71.CAPTION=''   
       THISFORM.PAGEFRAME1.PAGE1.LBLTTL81.CAPTION=''                               
       THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=''
       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.ENABLED=.T.
       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T. 
       THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.SETFOCUS         
       THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=SUBSTR(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.DISPLAYVALUE,4,22)
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=LEFT(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.DISPLAYVALUE,2)            
    ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')   
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.  
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.T.  
        THISFORM.PAGEFRAME1.PAGE2.TXTF12.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF22.READONLY=.F.      
        THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS      
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''  
        THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)   
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=''     
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=''                 
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=INT_011  
        THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE=1              
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION='0'     
        THISFORM.PAGEFRAME1.PAGE2.LBLF241.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE2.LBLF901.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE=1    
        THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VISIBLE=.T.    
        THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE=1  
        THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.F.  
        THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.DISPLAYVALUE='商品'
        THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.VISIBLE=.T.             
        THISFORM.PAGEFRAME1.PAGE2.TXTF21.VISIBLE=.F.            
        THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=INT_011            
     ENDIF   
  ENDPROC
************    
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1              &&表頭新增確認      
       THISFORM.GRID2.RECORDSOURCE='K25'
       THISFORM.GRID2.CHILDORDER=K254  
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K25.F07'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K25.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE="SPLY.F04"
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
       THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
       THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'   	  	      	             
   	   SELECT  K25_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'K25_1')=.T.
          =MESSAGEBOX('此類別發票於本月已有資料!,請直接去表身詳細資料內容新增',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.SETFOCUS
          RETURN  
       ENDIF
       SELECT  K25_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE   
       ENDIF
*      UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE      
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE         &&表身新增確認    
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE)
          =MESSAGEBOX("發票號碼不得空白",0+48,"提示訊息視窗")
          THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS
          RETURN
       ENDIF  
        IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE))          
          =MESSAGEBOX('發票日期輸入錯誤!',0+48,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(K25_1.F01+THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE,'K25')=.T.
          =MESSAGEBOX('發票號碼重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF07.SETFOCUS
          RETURN
       ENDIF  
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0
           =MESSAGEBOX('金額不得為 0 ',0+48,'提視訊息視窗')
           IF MOD(VAL(RIGHT(K25_1.F01,1)),2)=0
             THISFORM.PAGEFRAME1.PAGE2.TXTF12.SETFOCUS
           ELSE 
             THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS  
           ENDIF
           RETURN
      ENDIF   
       IF LEFT(K25_1.F01,1)='3'
          IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE) .OR. SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'SPLY')=.F.
             =MESSAGEBOX('無此對象編號!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
             RETURN
          ENDIF   
       ENDIF
      IF K25_1.F01='31'  OR  K25_1.F01='35'
          IF IIF(INDEXSEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,.T.,'C01','C011'),IIF(EMPTY(C01.F10),.F.,.T.),.F.)
              IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE) .OR. LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE))<>8 
                   =MESSAGEBOX('統一編號錯誤',0+48,'提示訊息視窗')
                   THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
                   RETURN
              ENDIF     
          ENDIF   
      ENDIF 
      ****新增各項單據之發票號碼,類別,稅別與K17發票管理一致 
      IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE) = .F. AND LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)) = 10
         IF VOA_NO(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE),ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE),ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE),ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE)),SPACE(1),ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)) = .F.	&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用) 
            =MESSAGEBOX('憑證單號有誤請洽系統管理人員',0+48,'提示訊息視窗')
            THISFORM.PAGEFRAME1.PAGE2.TXTF15.SETFOCUS
            RETURN
         ENDIF
      ENDIF 
      ****     
      SELECT  K25
      APPEND BLANK
      LOCK()       
      IF RLOCK()
  	     REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
  	     REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
	     REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
         REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
         *REPLACE F05 WITH IIF(F01='32' AND THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE<>1,ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE)),'')
         
         REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
         REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE
         REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
         REPLACE F09 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE))
         REPLACE F05 WITH IIF(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.F.,IIF(F01='31' AND F09='2','1',''),IIF(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE=2,'2','1'))
         REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
         REPLACE F11 WITH IIF(F01='21' .OR. F01='22','1','')
         REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
         REPLACE F13 WITH '00'
         REPLACE F15 WITH IIF(EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE),'',LEFT(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE,10) + ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.DISPLAYVALUE))
         REPLACE F18 WITH '01'
         REPLACE F19 WITH THISFORM.MTH_LIST.DISPLAYVALUE
         REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
         REPLACE F21 WITH ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE)
         REPLACE F22 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE    
         REPLACE F23 WITH VAL(THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION)
         REPLACE F24 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
      ENDIF
      ****新增各項應收付帳款資料
      DO CASE
         CASE LEFT(K25.F01,1) = '3' AND !EMPTY(THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION)
              SELECT C13
              SET ORDER TO C134
              SEEK LEFT(K25.F15,10)
              IF FOUND()
                 DO WHILE F02=LEFT(K25.F15,10)
                    REPLACE F17 WITH K25.F07
                    REPLACE F16 WITH ICASE(K25.F09='2','00',K25.F09='3','09',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0,'03',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) = 0,'02','06')
                    SKIP
                 ENDDO        
              ELSE
                 =MESSAGEBOX('本月無此憑證單號!請查明後再重新修正!',0+48,'提示訊息視窗')            
              ENDIF
              IF MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 AND K25.F09 = '1' 
                 SELECT  C13
                 APPEND BLANK
                 REPLACE C13.F01 WITH CTOD(ALLTRIM(CHK_STR) + '/' + K25.F02)
                 REPLACE C13.F02 WITH LEFT(K25.F15,10)
                 REPLACE C13.F03 WITH K25.F03
                 REPLACE C13.F04 WITH '稅額'
                 REPLACE C13.F05 WITH '發票:' + K25.F07
                 REPLACE C13.F06 WITH 1
                 REPLACE C13.F07 WITH K25.F10
                 REPLACE C13.F08 WITH K25.F10
                 REPLACE C13.F09 WITH IIF(SEEK(K25.F03,'C01'),C01.F15,'1')
                 REPLACE C13.F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 REPLACE C13.F13 WITH INT_011
                 REPLACE C13.F14 WITH 1
                 REPLACE C13.F19 WITH IIF(SEEK(K25.F03,'C01'),C01.F18,'')               
                 REPLACE C13.F17 WITH K25.F07   
              ENDIF   
         CASE LEFT(K25.F01,1)='2' AND !EMPTY(THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION) 
              DO CASE 
                 CASE LEFT(K25.F15,2)$'BMBR'
                      DEP = 'E20'
                 CASE LEFT(K25.F15,2)$'BABB' AND (K25.F03<>INT_117 AND K25.F03<>INT_118)
                      DEP = 'D19'
                 CASE LEFT(K25.F15,2)='PB' OR (LEFT(K25.F15,2)='BB' AND (K25.F03=INT_117 OR K25.F03=INT_118))
                      DEP='P19'
                 OTHERWISE
                      DEP = ''            
              ENDCASE 
              IF !EMPTY(DEP)
                 SELECT &DEP
                 IF DEP='P19' AND (K25.F03=INT_117 OR K25.F03=INT_118)
                    SET ORDER TO 5
                    SEEK '備註:'+SUBSTR(K25.F15,3,6)
                    IF FOUND()
                       DO WHILE LEFT(F17,11)='備註:'+SUBSTR(K25.F15,3,6) 
                          IF LEFT(F18,2)<>'FE' 
                             REPLACE F20 WITH K25.F07
                             REPLACE F19 WITH ICASE(K25.F09='2','00',K25.F09='3','09',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0,'03',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) = 0,'02','06')
                          ENDIF   
                          SKIP
                       ENDDO
                    ELSE
                       =MESSAGEBOX('本月無此憑證單號!請查明後再重新修正!',0+48,'提示訊息視窗')                                   
                    ENDIF
                 ELSE
                    SET ORDER TO 4    
                    SEEK LEFT(K25.F15,10)
                    IF FOUND()
                       DO WHILE F02=LEFT(K25.F15,10)
                          REPLACE F20 WITH K25.F07
                          REPLACE F19 WITH ICASE(K25.F09='2','00',K25.F09='3','09',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0,'03',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) = 0,'02','06')                    
                          SKIP
                       ENDDO
                    ELSE
                      =MESSAGEBOX('本月無此憑證單號!請查明後再重新修正!',0+48,'提示訊息視窗')                                   
                    ENDIF
                 ENDIF                
                 IF MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 AND K25.F09 = '1' 
                    APPEND BLANK
                    REPLACE &DEP..F01 WITH CTOD(ALLTRIM(CHK_STR) + '/' + K25.F02)
                    REPLACE &DEP..F02 WITH K25.F15                  
                    REPLACE &DEP..F03 WITH K25.F03
                    REPLACE &DEP..F04 WITH '稅額'
                    REPLACE &DEP..F05 WITH '發票:' + K25.F07
                    REPLACE &DEP..F06 WITH 1
                    REPLACE &DEP..F07 WITH K25.F10
                    REPLACE &DEP..F08 WITH K25.F10
                    REPLACE &DEP..F09 WITH IIF(SEEK(K25.F03,'D01'),D01.F13,IIF(SEEK(K25.F03,'E02'),E02.F10,'1'))
                    REPLACE &DEP..F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    REPLACE &DEP..F13 WITH INT_011
                    REPLACE &DEP..F14 WITH 1
                    REPLACE &DEP..F20 WITH K25.F07                 
                 ENDIF
              ENDIF   
      ENDCASE
      ***表頭資料紀錄
      SELECT K24
      SET ORDER TO K241
      SEEK K25.F01
      IF FOUND()
         REPLACE K24.F03 WITH K24.F03+K25.F08
         REPLACE K24.F04 WITH K24.F04+K25.F10
         REPLACE K24.F05 WITH K24.F05+K25.F12
	     DO CASE
	        CASE K25.F09='1'
	             REPLACE K24.F06 WITH K24.F06+1
	        CASE K25.F09='2'
	             REPLACE  K24.F07 WITH K24.F07+1
	        CASE K25.F09='3'
	             REPLACE  K24.F08 WITH K24.F08+1
	     ENDCASE               
      ELSE
         SELECT K24
         APPEND BLANK 
         REPLACE K24.F01 WITH K25.F01
         REPLACE K24.F03 WITH K25.F08
         REPLACE K24.F04 WITH K25.F10
         REPLACE K24.F05 WITH K25.F12
	     DO CASE
	        CASE K25.F09='1'
	             REPLACE K24.F06 WITH 1
	        CASE K25.F09='2'
	             REPLACE  K24.F07 WITH 1
	        CASE K25.F09='3'
	             REPLACE  K24.F08 WITH 1
	     ENDCASE             
      ENDIF
      SELECT K24
      SET ORDER TO K242
      SEEK K25.F03
      IF FOUND()
         REPLACE K24.F03 WITH K24.F03+K25.F08
         REPLACE K24.F04 WITH K24.F04+K25.F10
         REPLACE K24.F05 WITH K24.F05+K25.F12
	     DO CASE
	        CASE K25.F09='1'
	             REPLACE K24.F06 WITH K24.F06+1
	        CASE K25.F09='2'
	             REPLACE  K24.F07 WITH K24.F07+1
	        CASE K25.F09='3'
	             REPLACE  K24.F08 WITH K24.F08+1
	     ENDCASE               
      ELSE
         SELECT K24
         APPEND BLANK 
         REPLACE K24.F02 WITH K25.F03
         REPLACE K24.F03 WITH K25.F08
         REPLACE K24.F04 WITH K25.F10
         REPLACE K24.F05 WITH K25.F12
	     DO CASE
	        CASE K25.F09='1'
	             REPLACE K24.F06 WITH 1
	        CASE K25.F09='2'
	             REPLACE  K24.F07 WITH 1
	        CASE K25.F09='3'
	             REPLACE  K24.F08 WITH 1
	     ENDCASE             
      ENDIF          
      SELECT K25_3
      SET ORDER TO K25_31
      SEEK K25.F03
      IF FOUND()
	     REPLACE K25_3.F08 WITH K25_3.F08+K25.F08
	     REPLACE K25_3.F10 WITH K25_3.F10+K25.F10
	     REPLACE K25_3.F12 WITH K25_3.F12+K25.F12
	     DO CASE
	        CASE K25.F09='1'
	             REPLACE  K25_3.F13 WITH K25_3.F13+1
	        CASE K25.F09='2'
	             REPLACE  K25_3.F14 WITH K25_3.F14+1
	        CASE K25.F09='3'
	             REPLACE  K25_3.F15 WITH K25_3.F15+1
	     ENDCASE       
	  ELSE
	     SELECT K25_3
	     APPEND BLANK 
	     REPLACE K25_3.F03 WITH K25.F03
	     REPLACE K25_3.F08 WITH K25.F08
	     REPLACE K25_3.F10 WITH K25.F10
	     REPLACE K25_3.F12 WITH K25.F12
	     DO CASE
	        CASE K25.F09='1'
	             REPLACE  K25_3.F13 WITH 1
	        CASE K25.F09='2'
	             REPLACE  K25_3.F14 WITH 1
	        CASE K25.F09='3'
	             REPLACE  K25_3.F15 WITH 1
	     ENDCASE  	
	     REPLACE  K25_3.F18 WITH IIF(INDEXSEEK(K25_3.F03,.T.,'SPLY','SPLY1'),SPLY.F04,'') 	               
      ENDIF
      SELECT  K25_1
      LOCK()
      IF RLOCK()
         REPLACE K25_1.F08 WITH K25_1.F08+K25.F08
         REPLACE K25_1.F10 WITH K25_1.F10+K25.F10
         REPLACE K25_1.F12 WITH K25_1.F12+K25.F12
         DO CASE
            CASE K25.F09='1'
                 REPLACE K25_1.F13 WITH K25_1.F13+1
            CASE K25.F09='2'
                 REPLACE K25_1.F14 WITH K25_1.F14+1
            CASE K25.F09='3'
                 REPLACE K25_1.F15 WITH K25_1.F15+1
                 REPLACE K25_1.F18 WITH BILL(K25_1.F01)                
         ENDCASE     
      ENDIF   
      UNLOCK ALL         
      SELECT  K25
      SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID2.SETFOCUS
      THISFORM.ORPGROUP.NEW_BOTT.CLICK      
   ENDIF       
 ENDPROC  
************    
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.     
     THISFORM.CNC_BOTT.ENABLED=.F.
     THISFORM.SEND_BOTT.ENABLED=.F.
     THISFORM.SPC_BOTT.ENABLED=.F.
     THISFORM.BILL_BOTT.ENABLED=.F.
     THISFORM.K2F_BOTT.VISIBLE=.F.
     THISFORM.BTTF06.VISIBLE=.F.
     THISFORM.BTTF06.ENABLED=.F.     
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.        
     SELECT K25                                                      &&處理表身修改
     IF RLOCK() 
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
        THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS      
	    THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.    
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.T.  
        THISFORM.PAGEFRAME1.PAGE2.TXTF12.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF22.READONLY=.F.           
        THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE=VAL(K25.F09)
        THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.DISPLAYVALUE=SUBSTR(K25.F15,11,4)           
        THISFORM.PAGEFRAME1.PAGE2.TXTF21.VISIBLE=.F.              
        THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=.T.       
        THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE        
        IF K25.F01='32' AND K25.F09<>'1'
           THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.T.
           THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE=VAL(K25.F05)
        ENDIF                           
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=''
     ELSE  
        DO FILE_IMPACT 
        UNLOCK ALL
        THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
     ENDIF             
  ENDPROC
*********  
 PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
    IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE))          
       =MESSAGEBOX('發票日期輸入錯誤!',0+48,'提示訊息視窗') 
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
       RETURN
    ENDIF   
    IF THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0
       =MESSAGEBOX('金額不得為 0 ',0+48,'提視訊息視窗')
       IF MOD(VAL(RIGHT(K25_1.F01,1)),2)=0
          THISFORM.PAGEFRAME1.PAGE2.TXTF12.SETFOCUS
       ELSE 
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS  
       ENDIF
       RETURN
    ENDIF           
    IF LEFT(K25.F01,1)='3'
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE) .OR. SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'SPLY')=.F.
          =MESSAGEBOX('無此對象編號!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
    ENDIF   	
    IF K25_1.F01='31'  OR  K25_1.F01='35'
       IF IIF(INDEXSEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,.T.,'C01','C011'),IIF(EMPTY(C01.F10),.F.,.T.),.F.)
          IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE) .OR. LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE))<>8 
             =MESSAGEBOX('統一編號錯誤',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF     
       ENDIF   
    ENDIF
    ****修改各項單據之發票號碼,類別,稅別與K17發票管理一致 
    IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE) = .F. &&AND LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)) = 10
       IF VOA_NO(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE),ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE),ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE),ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE)),SPACE(1),ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)) = .F.	&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用)
          =MESSAGEBOX('憑證單號錯誤請洽系統管理人員',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF15.SETFOCUS
          RETURN
       ENDIF   
    ENDIF
    *********先修改表頭資料             
    H = K25.F01+K25.F07
    SELECT K24
    SET ORDER TO K241
    SEEK K25.F01
    IF FOUND()
       REPLACE K24.F03 WITH K24.F03+(K25.F08*(-1))
       REPLACE K24.F04 WITH K24.F04+(K25.F10*(-1))
       REPLACE K24.F05 WITH K24.F05+(K25.F12*(-1))
	   DO CASE
	      CASE K25.F09='1'
	           REPLACE K24.F06 WITH K24.F06-1
	      CASE K25.F09='2'
	           REPLACE  K24.F07 WITH K24.F07-1
	      CASE K25.F09='3'
	           REPLACE  K24.F08 WITH K24.F08-1
	   ENDCASE  
	   IF (K24.F03+K24.F04+K24.F05+K24.F06+K24.F07+K24.F08+K24.F09+K24.F10)=0   
	      SELECT K24
	      DELETE 
	   ENDIF 
       ENDIF
       SELECT K24
       SET ORDER TO K242
       SEEK K25.F03
       IF FOUND()
          REPLACE K24.F03 WITH K24.F03+(K25.F08*(-1))
          REPLACE K24.F04 WITH K24.F04+(K25.F10*(-1))
          REPLACE K24.F05 WITH K24.F05+(K25.F12*(-1))
	   DO CASE
	      CASE K25.F09='1'
	           REPLACE K24.F06 WITH K24.F06-1
	      CASE K25.F09='2'
	           REPLACE  K24.F07 WITH K24.F07-1
	      CASE K25.F09='3'
	           REPLACE  K24.F08 WITH K24.F08-1
	   ENDCASE   
	   IF (K24.F03+K24.F04+K24.F05+K24.F06+K24.F07+K24.F08+K24.F09+K24.F10)=0   
	      SELECT K24
	      DELETE 
	   ENDIF 	   
    ENDIF       
    SELECT  K25_3
    SET ORDER TO K25_31
    SEEK K25.F03
    IF FOUND()
       REPLACE K25_3.F08 WITH K25_3.F08+(K25.F08*(-1))
       REPLACE K25_3.F10 WITH K25_3.F10+(K25.F10*(-1))
       REPLACE K25_3.F12 WITH K25_3.F12+(K25.F12*(-1))
       DO CASE
          CASE K25.F09='1'
               REPLACE K25_3.F13 WITH K25_3.F13-1
          CASE K25.F09='2'
               REPLACE K25_3.F14 WITH K25_3.F14-1
          CASE K25.F09='3'
               REPLACE K25_3.F15 WITH K25_3.F15-1
       ENDCASE 
	   IF (K25_3.F08+K25_3.F10+K25_3.F12+K25_3.F13+K25_3.F14+K25_3.F15+K25_3.F16+K25_3.F17)=0   
	      SELECT K25_3
	      DELETE 
	   ENDIF           
    ENDIF           
    SELECT K25_1
    REPLACE K25_1.F08 WITH K25_1.F08+(K25.F08*(-1))
    REPLACE K25_1.F10 WITH K25_1.F10+(K25.F10*(-1))
    REPLACE K25_1.F12 WITH K25_1.F12+(K25.F12*(-1))
    DO CASE
       CASE K25.F09='1'
            REPLACE K25_1.F13 WITH K25_1.F13-1
       CASE K25.F09='2'
            REPLACE K25_1.F14 WITH K25_1.F14-1
       CASE K25.F09='3'
            REPLACE K25_1.F15 WITH K25_1.F15-1
    ENDCASE
 *****           
    SELECT K25         
    SEEK H
    IF FOUND() 
       LOCK()  
       IF RLOCK()
          REPLACE K25.F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
          REPLACE K25.F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE K25.F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          *REPLACE K25.F05 WITH IIF(F01='32' AND THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE<>1,ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE)),'')
          REPLACE K25.F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
          REPLACE K25.F07 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE
          REPLACE K25.F08 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
          REPLACE K25.F09 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE))
          REPLACE K25.F05 WITH IIF(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.F.,IIF(F01='31' AND F09='2','1',''),IIF(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE=2,'2','1'))
          REPLACE K25.F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
          REPLACE K25.F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
          IF AT('進貨費用明細轉入',THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE)>0
             REPLACE K25.F15 WITH IIF(EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE),'',LEFT(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE,10) + '運費')
          ELSE
             REPLACE K25.F15 WITH IIF(EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE),'',LEFT(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE,10) + ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.DISPLAYVALUE))
          ENDIF
          REPLACE K25.F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
          REPLACE K25.F21 WITH ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE) 
          REPLACE K25.F22 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE       
          REPLACE K25.F23 WITH VAL(THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION)    
          REPLACE K25.F24 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')  
****修改各項應收付帳款資料 
          DO CASE
             CASE LEFT(K25.F01,1) = '3' AND !EMPTY(THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION)          
	              SELECT C13
	              DELETE FROM C13 WHERE LEFT(F04,4)='稅額' AND F17=SUBSTR(H,3,10)
	              SET ORDER TO C133
	              SEEK SUBSTR(H,3,10)
	              IF FOUND()
	                 DO WHILE F17=SUBSTR(H,3,10)

	                       REPLACE F16 WITH '06'
	                       REPLACE F17 WITH SPACE(10)

	                    SKIP
	                 ENDDO   
	              ENDIF
	              SET ORDER TO C134
	              SEEK LEFT(K25.F15,10)
	              IF FOUND()
	                 DO WHILE F02=LEFT(K25.F15,10)
	                    REPLACE F17 WITH K25.F07
	                    REPLACE F16 WITH ICASE(K25.F09='2','00',K25.F09='3','09',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0,'03',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) = 0,'02','06')
	                    SKIP
	                 ENDDO
	              ELSE
                     =MESSAGEBOX('本月無此憑證單號!請查明後再重新修正!',0+48,'提示訊息視窗')            	                 
	              ENDIF
	              IF MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 AND K25.F09='1'       
	                 APPEND BLANK
	                 REPLACE C13.F01 WITH CTOD(ALLTRIM(CHK_STR) + '/' + K25.F02)
	                 REPLACE C13.F02 WITH LEFT(K25.F15,10)
	                 REPLACE C13.F03 WITH K25.F03
	                 REPLACE C13.F04 WITH '稅額'
	                 REPLACE C13.F05 WITH '發票:' + K25.F07
	                 REPLACE C13.F06 WITH 1
	                 REPLACE C13.F07 WITH K25.F10
	                 REPLACE C13.F08 WITH K25.F10
	                 REPLACE C13.F09 WITH IIF(SEEK(K25.F03,'C01'),C01.F15,'1')
	                 REPLACE C13.F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	                 REPLACE C13.F13 WITH INT_011
	                 REPLACE C13.F14 WITH 1
	                 REPLACE C13.F17 WITH K25.F07
	                 REPLACE C13.F19 WITH IIF(SEEK(K25.F03,'C01'),C01.F18,'')		          	           
	              ENDIF
             CASE LEFT(K25.F01,1) = '2' AND !EMPTY(THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION) &&AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 
                  DO CASE 
                     CASE LEFT(F15,2)$'BMBR'
                          DEP = 'E20'
                     CASE LEFT(F15,2)$'BABB' AND (F03<>INT_117 AND F03<>INT_118)
                          DEP = 'D19'
                     CASE LEFT(K25.F15,2)='PB' OR (LEFT(K25.F15,2)='BB' AND (K25.F03=INT_117 OR K25.F03=INT_118))
                          DEP='P19'
                     OTHERWISE
                          DEP = ''            
                  ENDCASE           
                  IF !EMPTY(DEP)               
                     SELECT &DEP
                     DELETE FROM &DEP WHERE LEFT(F04,4)='稅額' AND F20=SUBSTR(H,3,10)  
                     SET ORDER TO 3
                     IF SUBSTR(K25.F15,11,4)<>'運費'
                        SEEK SUBSTR(H,3,10)
                        IF FOUND()
                           DO WHILE F20=SUBSTR(H,3,10)
                              REPLACE &DEP..F20 WITH SPACE(10)
                              REPLACE &DEP..F19 WITH '06'                                
                              SKIP                                                         
                           ENDDO
                        ENDIF
                     ENDIF   
                     IF DEP='P19' AND (K25.F03=INT_117 OR K25.F03=INT_118)
                        SET ORDER TO 5 
                        SEEK '備註:'+SUBSTR(K25.F15,3,6) 
                        IF FOUND()
                           DO WHILE LEFT(F17,11)='備註:'+SUBSTR(K25.F15,3,6) 
                              IF LEFT(F18,2)<>'FE' AND SUBSTR(K25.F15,11,4)<>'運費'
                                 REPLACE F20 WITH K25.F07
                                 REPLACE F19 WITH ICASE(K25.F09='2','00',K25.F09='3','09',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0,'03',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) = 0,'02','06')
                              ENDIF   
                              SKIP
                           ENDDO
                        ELSE
                           =MESSAGEBOX('本月無此憑證單號!請查明後再重新修正!',0+48,'提示訊息視窗')                                       
                        ENDIF
                     ELSE
                        SET ORDER TO 4
                        SEEK LEFT(K25.F15,10)
                        IF FOUND()
                           DO WHILE F02=LEFT(K25.F15,10)
                              REPLACE F20 WITH K25.F07
                              REPLACE F19 WITH ICASE(K25.F09='2','00',K25.F09='3','09',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0,'03',K25.F09='1' AND MOD(VAL(RIGHT(K25.F01,1)),2) = 0,'02','06')                        
                              SKIP
                           ENDDO
                        ELSE
                           =MESSAGEBOX('本月無此憑證單號!請查明後再重新修正!',0+48,'提示訊息視窗')                                       
                        ENDIF
                     ENDIF
  	                 IF MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 AND K25.F09='1'                     
	                    APPEND BLANK
	                    REPLACE &DEP..F01 WITH CTOD(ALLTRIM(CHK_STR) + '/' + K25.F02)
	                    REPLACE &DEP..F02 WITH K25.F15
	                    REPLACE &DEP..F03 WITH K25.F03
	                    REPLACE &DEP..F04 WITH '稅額'
	                    REPLACE &DEP..F05 WITH '發票:' + K25.F07
	                    REPLACE &DEP..F06 WITH 1
	                    REPLACE &DEP..F07 WITH K25.F10
	                    REPLACE &DEP..F08 WITH K25.F10
	                    REPLACE &DEP..F09 WITH IIF(SEEK(K25.F03,'D01'),D01.F13,IIF(SEEK(K25.F03,'E02'),E02.F10,'1'))
	                    REPLACE &DEP..F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	                    REPLACE &DEP..F13 WITH INT_011
	                    REPLACE &DEP..F14 WITH 1
	                    IF SUBSTR(K25.F15,11,4)='運費'
	                       REPLACE F17 WITH '備註;'+SUBSTR(K25.F15,3,6)+'進貨費用明細轉入'
	                    ENDIF
	                    REPLACE F20 WITH K25.F07  	           
  	                ENDIF
      	        ENDIF                                
          ENDCASE  
*********
          SELECT K24
          SET ORDER TO K241
          SEEK K25.F01
          IF FOUND()
             REPLACE K24.F03 WITH K24.F03+K25.F08
             REPLACE K24.F04 WITH K24.F04+K25.F10
             REPLACE K24.F05 WITH K24.F05+K25.F12
	         DO CASE
	            CASE K25.F09='1'
	                 REPLACE K24.F06 WITH K24.F06+1
	            CASE K25.F09='2'
	                 REPLACE  K24.F07 WITH K24.F07+1
	            CASE K25.F09='3'
	                 REPLACE  K24.F08 WITH K24.F08+1
	         ENDCASE    
          ELSE
             SELECT K24
             APPEND BLANK
             REPLACE K24.F01 WITH K25.F01
             REPLACE K24.F03 WITH K25.F08
             REPLACE K24.F04 WITH K25.F10
             REPLACE K24.F05 WITH K25.F12
	         DO CASE
	            CASE K25.F09='1'
	                 REPLACE K24.F06 WITH 1
	            CASE K25.F09='2'
	                 REPLACE  K24.F07 WITH 1
	            CASE K25.F09='3'
	                 REPLACE  K24.F08 WITH 1
	         ENDCASE                	   
          ENDIF
          SELECT K24
          SET ORDER TO K242
          SEEK K25.F03
          IF FOUND()
             REPLACE K24.F03 WITH K24.F03+K25.F08
             REPLACE K24.F04 WITH K24.F04+K25.F10
             REPLACE K24.F05 WITH K24.F05+K25.F12
	         DO CASE
	            CASE K25.F09='1'
	                 REPLACE K24.F06 WITH K24.F06+1
	            CASE K25.F09='2'
	                 REPLACE  K24.F07 WITH K24.F07+1
	            CASE K25.F09='3'
	                 REPLACE  K24.F08 WITH K24.F08+1
	         ENDCASE   
          ELSE
             SELECT K24
             APPEND BLANK  
             REPLACE K24.F02 WITH K25.F03    	
             REPLACE K24.F03 WITH K25.F08
             REPLACE K24.F04 WITH K25.F10
             REPLACE K24.F05 WITH K25.F12
	         DO CASE
	            CASE K25.F09='1'
	                 REPLACE K24.F06 WITH 1
	            CASE K25.F09='2'
	                 REPLACE K24.F07 WITH 1
	            CASE K25.F09='3'
	                 REPLACE K24.F08 WITH 1
	         ENDCASE                
          ENDIF       
          SELECT K25_3
          SET ORDER TO K25_31
          SEEK K25.F03
          IF FOUND()
             REPLACE K25_3.F08 WITH K25_3.F08+K25.F08
             REPLACE K25_3.F10 WITH K25_3.F10+K25.F10
             REPLACE K25_3.F12 WITH K25_3.F12+K25.F12
             DO CASE
                CASE K25.F09='1'
                     REPLACE K25_3.F13 WITH K25_3.F13+1
                CASE K25.F09='2'
                     REPLACE K25_3.F14 WITH K25_3.F14+1
                CASE K25.F09='3'
                     REPLACE K25_3.F15 WITH K25_3.F15+1
             ENDCASE 
          ELSE
             SELECT K25_3
             APPEND BLANK  
             REPLACE K25_3.F03 WITH K25.F03
             REPLACE K25_3.F08 WITH K25.F08
             REPLACE K25_3.F10 WITH K25.F10
             REPLACE K25_3.F12 WITH K25.F12
             DO CASE
                CASE K25.F09='1'
                     REPLACE K25_3.F13 WITH 1
                CASE K25.F09='2'
                     REPLACE K25_3.F14 WITH 1
                CASE K25.F09='3'
                     REPLACE K25_3.F15 WITH 1
             ENDCASE         
          ENDIF                       
          SELECT K25_1
          REPLACE K25_1.F08 WITH F08+K25.F08
          REPLACE K25_1.F10 WITH F10+K25.F10
          REPLACE K25_1.F12 WITH F12+K25.F12  
          DO CASE
             CASE K25.F09='1'
                  REPLACE K25_1.F13 WITH K25_1.F13+1
             CASE K25.F09='2'
                  REPLACE K25_1.F14 WITH K25_1.F14+1
             CASE K25.F09='3'
                  REPLACE K25_1.F15 WITH K25_1.F15+1
          ENDCASE 
       ENDIF 
    ENDIF
    UNLOCK ALL
    SELECT K25
    IF EMPTY(K25.F15) = .T.
       SELECT K2F
       LOCATE FOR ALLTRIM(K2F.F01) = ALLTRIM(K25.F07) AND DTOS(K2F.F04) = DTOS(CTOD(ALLTRIM(CHK_STR) + '/01'))
	   IF FOUND()
	      IF EMPTY(K2F.F02) = .F.
		     REPLACE K25.F15 WITH K2F.F02 + ICASE(K2F.F03 = 'A','商品',K2F.F03 = 'B','製品',K2F.F03 = 'C','原料','')  
		     SELECT K2F
		     DELETE 
		  ENDIF
	   ENDIF 
    ENDIF
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC  
******      
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	      
          IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1  
             SELECT K25_1
          ELSE   
             SELECT K25                          
             IF RLOCK()                
                DO CASE
                   CASE LEFT(K25.F01,1) = '3' 
		                SELECT  C13
		                DELETE FROM C13 WHERE LEFT(F04,4)='稅額' AND F17=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE 
                        SET ORDER TO C133
                        SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE 
                        IF FOUND()
                           DO WHILE F17=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE                 
                              REPLACE F17 WITH ''
                              REPLACE F16 WITH '06'
                              SKIP
                           ENDDO
                        ENDIF                    	              		                
	               CASE LEFT(K25.F01,1) = '2' 
	                    DO CASE
	                       CASE LEFT(K25.F15,2)$'BMBR'
	                            DEP = 'E20'        
	                       CASE LEFT(K25.F15,2)$'BABB' AND (K25.F03<>INT_117 AND K25.F03<>INT_118)
	                            DEP = 'D19'	  
   		                   CASE LEFT(K25.F15,2)='PB' OR (LEFT(K25.F15,2)='BB' AND (K25.F03=INT_117 OR K25.F03=INT_118))
	                            DEP = 'P19'           	                       
	                       OTHERWISE
	                            DEP = ''           
	                    ENDCASE
	                    IF !EMPTY(DEP)
	                       SELECT &DEP
                           DELETE FROM &DEP WHERE LEFT(F04,4)='稅額' AND F20=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE 	                       
                           SET ORDER TO 3
                           SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE 	                       
		                   IF FOUND()
		                      DO WHILE F20=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE  
  		                            REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE  
		                            REPLACE F19 WITH '06'
		                         SKIP
		                      ENDDO
		                   ENDIF
		                ENDIF       	                               
	            ENDCASE
	            ****刪除各項單據之發票號碼,類別,稅別與K17發票管理一致 
                VOA_NO(ALLTRIM(K25.F07),ALLTRIM(K25.F03),ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE),ALLTRIM(K25.F09),ALLTRIM(K25.F15),SPACE(1)) 	&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用)   
	            ****刪除其他憑證單號
	            SELECT RECNO() FROM K2F WHERE K2F.F01 = K25.F07 AND EMPTY(K2F.F02) = .F. AND DTOS(K2F.F04) = DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')) INTO ARRAY BKF  
		        JJF = ''                
	            IF _TALLY > 0   
	               FOR I = 1 TO ALEN(BKF)
	                   JJF = JJF + ALLTRIM(STR(BKF(I))) + ','
		           ENDFOR    
		           KKF = STUFF(JJF,RAT(',',JJF,1),1,'')              
		           RLOCK(KKF,'K2F')
		           LLF = RLOCK(KKF,'K2F')
		        ELSE
		           LLF = .T.   
		        ENDIF  
		        IF LLF = .T. AND LEN(ALLTRIM(JJF)) > 0 
		           FOR I= 1 TO ALEN(BKF)
		               SELECT K2F
		               GO BKF(I)
		               VOA_NO(ALLTRIM(K25.F07),ALLTRIM(K25.F03),ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE),ALLTRIM(K25.F09),ALLTRIM(K2F.F02),SPACE(1)) 	&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用)   
		               SELECT K2F
		               DELETE   
		           ENDFOR 
		        ENDIF 	            
	            RELEASE ALL LIKE BK* 
	            ***
        	    H = K25.F01+K25.F07   
        	    SELECT K24
        	    SET ORDER TO K241
        	    SEEK K25.F01
        	    IF FOUND()     
        	       REPLACE K24.F03 WITH K24.F03+(K25.F08*(-1))
        	       REPLACE K24.F04 WITH K24.F04+(K25.F10*(-1))
        	       REPLACE K24.F05 WITH K24.F05+(K25.F12*(-1))
	               DO CASE
	                  CASE K25.F09='1' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K24.F06 WITH K24.F06-1
	                  CASE K25.F09='2' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K24.F07 WITH K24.F07-1
	                  CASE K25.F09='3' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K24.F08 WITH K24.F08-1
	                  CASE K25.F16='2'
	                       REPLACE K24.F09 WITH K24.F09-1
	                  CASE K25.F16='4'
	                       REPLACE K24.F10 WITH K24.F10-1
	               ENDCASE          	
	               IF (K24.F03+K24.F04+K24.F05+K24.F06+K24.F07+K24.F08+K24.F09+K24.F10)=0   
	                  SELECT K24
	                  DELETE 
	               ENDIF      
        	    ENDIF
        	    SELECT K24
        	    SET ORDER TO K242
        	    SEEK K25.F03
        	    IF FOUND()     
        	       REPLACE K24.F03 WITH K24.F03+(K25.F08*(-1))
        	       REPLACE K24.F04 WITH K24.F04+(K25.F10*(-1))
        	       REPLACE K24.F05 WITH K24.F05+(K25.F12*(-1))
	               DO CASE
	                  CASE K25.F09='1' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K24.F06 WITH K24.F06-1
	                  CASE K25.F09='2' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K24.F07 WITH K24.F07-1
	                  CASE K25.F09='3' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K24.F08 WITH K24.F08-1
	                  CASE K25.F16='2'
	                       REPLACE K24.F09 WITH K24.F09-1
	                  CASE K25.F16='4'
	                       REPLACE K24.F10 WITH K24.F10-1
	               ENDCASE          	     
	               IF (K24.F03+K24.F04+K24.F05+K24.F06+K24.F07+K24.F08+K24.F09+K24.F10)=0   
	                  SELECT K24
	                  DELETE 
	               ENDIF   	                      
        	    ENDIF     
	            SELE K25_3
	            SET ORDER TO K25_31
	            SEEK K25.F03
	            IF FOUND()
	               REPLACE K25_3.F08 WITH K25_3.F08+K25.F08*(-1)
	               REPLACE K25_3.F10 WITH K25_3.F10+K25.F10*(-1)
	               REPLACE K25_3.F12 WITH K25_3.F12+K25.F12*(-1)              
	               DO CASE
	                  CASE K25.F09='1' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K25_3.F13 WITH K25_3.F13-1
	                  CASE K25.F09='2' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K25_3.F14 WITH K25_3.F14-1
	                  CASE K25.F09='3' AND K25.F16<>'2' AND K25.F16<>'4'
	                       REPLACE K25_3.F15 WITH K25_3.F15-1
	                  CASE K25.F16='2' 
	                       REPLACE K25_3.F16 WITH K25_3.F16-1
	                  CASE K25.F16='4' 
	                       REPLACE K25_3.F17 WITH  K25_3.F17-1	                        	                        
	               ENDCASE   
	               IF (K25_3.F08+K25_3.F10+K25_3.F12+K25_3.F13+K25_3.F14+K25_3.F15+K25_3.F16+K25_3.F17)=0   
	                  SELECT K25_3
	                  DELETE 
	               ENDIF   	                       
	            ENDIF          	       	     
	            SELECT K25_1
	            REPLACE K25_1.F08 WITH K25_1.F08+K25.F08*(-1)
	            REPLACE K25_1.F10 WITH K25_1.F10+K25.F10*(-1)
	            REPLACE K25_1.F12 WITH K25_1.F12+K25.F12*(-1)              
	            DO CASE
	               CASE K25.F09='1' AND K25.F16<>'2' AND K25.F16<>'4'
	                    REPLACE K25_1.F13 WITH K25_1.F13-1
	               CASE K25.F09='2' AND K25.F16<>'2' AND K25.F16<>'4'
	                    REPLACE K25_1.F14 WITH K25_1.F14-1
	               CASE K25.F09='3' AND K25.F16<>'2' AND K25.F16<>'4'
	                    REPLACE K25_1.F15 WITH K25_1.F15-1
	               CASE K25.F16='2'
	                    REPLACE K25_1.F16 WITH K25_1.F16-1
	               CASE K25.F16='4'
	                    REPLACE K25_1.F17 WITH K25_1.F17-1	                        	                        
	            ENDCASE       	                            
	            SELECT K25
	            SEEK H
	            DELETE 
	            SKIP -1
	            IF BOF()
	               GO TOP
	            ENDIF   
	         ELSE
	            DO FILE_IMPACT                  
	         ENDIF      
             THISFORM.GRID2.SETFOCUS
             IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空        
                SELECT K25_1                        
                DELETE                                &&連表頭也要刪除
                SKIP -1
                IF BOF()
                   GO TOP
                ENDIF    
                THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                THISFORM.REFRESH          
             ENDIF
          ENDIF   
       ENDIF
  ENDPROC

********     
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ANS_BOTT.ENABLED=(K25.F16<>'2')     
      THISFORM.CNC_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND AREA1='K25_1',IIF(K25.F16='2' OR K25.F16='3' OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) AND !EMPTY(K25.F14) AND !A23.F09 && AND BETWEEN(VAL(LEFT(DTOS(DATE()),6))-VAL(LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6))+VAL(LEFT(DTOS(DATE()),6))%2,0,1)
      THISFORM.SEND_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND AREA1='K25_1' AND A02.F10='*',.T.,.F.) AND EMPTY(K25.F14) AND LEFT(K25.F01,1)='3' AND (K25.F07<>LEFT(K25.F15,10) AND 'B'+CHR(VAL(LEFT(K25.F07,2)))+SUBSTR(K25.F07,3,4)<>LEFT(K25.F15,6)) AND DATE()-CTOD(CHK_STR+'/'+K25.F02)<7 AND CTOD(CHK_STR+'/'+K25.F02)<=DATE()&&上傳電子發票
      THISFORM.SPC_BOTT.ENABLED=IIF(THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND AREA1='K25_1' AND A02.F09='*',.T.,.F.)  &&空白發票
      THISFORM.BILL_BOTT.ENABLED=.T.
      THISFORM.K2F_BOTT.ENABLED=.T.
      THISFORM.K2F_BOTT.VISIBLE= THISFORM.PAGEFRAME1.ACTIVEPAGE=2 AND IIF(AREA1='K25_3',.F.,.T.) AND IIF(AREA1='K25_1' AND A02.F05='*',IIF(K25.F16='2' OR K25.F16='3'  OR K25.F16='4' OR K25.F16='5',.F.,.T.),.F.) 
      THISFORM.BTTF06.VISIBLE=IIF(K25.F16$'35',.T.,.F.) AND K25.F01='32' AND K25.F09='2' AND A02.F12='*'
      THISFORM.BTTF06.ENABLED=IIF(K25.F16$'35',.T.,.F.) AND K25.F01='32' AND K25.F09='2' AND A02.F12='*'      
      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.ENABLED=.F. 
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T. 
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.      
      THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.MTR_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=.F.      
      THISFORM.PAGEFRAME1.PAGE2.TXTF21.VISIBLE=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF12.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE2.TXTF22.READONLY=.T.        
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1      
         THISFORM.GRID1.ENABLED=.T.
         THISFORM.GRID2.ENABLED=.T.
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.    
         THISFORM.ANS_BOTT.ENABLED=.F.  
         THISFORM.CNC_BOTT.ENABLED=.F.
         THISFORM.SEND_BOTT.ENABLED=.F.
         THISFORM.SPC_BOTT.ENABLED=.F.
	     THISFORM.BILL_BOTT.ENABLED=.F.
      ELSE
         THISFORM.GRID1.ENABLED=.F.
         THISFORM.GRID2.ENABLED=.T.
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
	        SELECT  K25_1
	        DELETE   
	        THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	        THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
  ENDPROC
*******  
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          IF THISFORM.GRID2.RECORDSOURCE<>'K25'
             THISFORM.GRID2.RECORDSOURCE='K25'
             THISFORM.GRID2.CHILDORDER=K254  
      	     THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K25.F07'
       	     THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K25.F02'
             THISFORM.GRID2.COLUMN3.CONTROLSOURCE="SPLY.F04"
             THISFORM.GRID2.COLUMN4.CONTROLSOURCE="IIF(K25.F09='1','應稅',IIF(K25.F09='2','零稅',IIF(K25.F09='3','免稅','')))"
             THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K25.F08'
             THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K25.F10'
             THISFORM.GRID2.COLUMN7.CONTROLSOURCE='K25.F12'
             THISFORM.GRID2.COLUMN8.CONTROLSOURCE='K25.F04'   	  	      	                      
	  	  ENDIF   
      ENDIF    
	  THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC  
*******發票明細
  PROCEDURE ANS_BOTT.CLICK

    	IF THISFORM.KEY_LIST.DISPLAYVALUE='依發票代號排列' 
    	   DO CASE 
    	      CASE LEFT(K25_1.F01,1)='3'
    	           IF LEFT(K25.F15,2)='BE'
    	              SELECT F01 異動單號,F09 訂單編號,F03 品號,F04 數量,F14 單價,ROUND(F14*F17*F04,INT_069) 小計,F11 幣別,F17 匯率 FROM B06 WHERE F20=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE INTO CURSOR INV ORDER BY F01,F03
    	           ELSE
      	              SELECT F02 異動單號,F04 訂單編號,F05 品號,F06 數量,F07 單價,F08 小計,F13 幣別,F14 匯率 FROM C13 WHERE F17=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE INTO CURSOR INV ORDER BY F02,F05
      	           ENDIF   
    	      CASE LEFT(K25_1.F01,1)='2' AND LEFT(K25.F15,2)$'BABB' AND (K25.F03<>INT_117 AND K25.F03<>INT_118)
      	           SELECT F02 異動單號,F04 訂單編號,F05 品號,F06 數量,F07 單價,F08 小計,F13 幣別,F14 匯率 FROM D19 WHERE F20=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE INTO CURSOR INV ORDER BY F02,F05    	      
      	      CASE LEFT(K25_1.F01,1)='2' AND LEFT(K25.F15,2)$'BMBR'     
                   SELECT F02 異動單號,F04 訂單編號,F05 品號,F06 數量,F07 單價,F08 小計,F13 幣別,F14 匯率 FROM E20 WHERE F20=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE INTO CURSOR INV ORDER BY F02,F05    	            	      
    	      OTHERWISE
                  SELECT F02 異動單號,F04 訂單編號,F05 品號,F06 數量,F07 單價,F08 小計,F13 幣別,F14 匯率 FROM P19 WHERE F20=THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE INTO CURSOR INV ORDER BY F02,F05    	            	          	      
    	   ENDCASE   
    	ELSE
    	   =MESSAGEBOX('請用發票號碼排列後再搜尋',0+48,'提示訊息')
    	   RETURN   
      	ENDIF	
        IF _TALLY>0
          INV_CNPT=CREATEOBJECT("INV_CNPT")  
          INV_CNPT.SHOW                  
        ELSE
          =MESSAGEBOX('對帳單無此發票號碼資料',0+48,'提示訊息視窗')   
        ENDIF  
        IF THISFORM.KEY_LIST.DISPLAYVALUE='依發票代號排列' 
           AREA1='K25_1'
        ELSE
      	   AREA1='K25_3'
        ENDIF   
     THISFORM.GRID2.SETFOCUS     
  ENDPROC  
*******多重憑證明細
  PROCEDURE K2F_BOTT.CLICK
 	 SELECT K2F.F01,K2F.F02,K2F.F03,K2F.F04,K2F.F05,K2F.F99 FROM K2F WHERE ALLTRIM(K2F.F01) = ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF07.VALUE) AND DTOS(K2F.F04) = DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')) ORDER BY K2F.F01,K2F.F02 INTO CURSOR K2F_TEMP READWRITE 
 	 INDE ON K2F_TEMP.F02 TAG K2F_TEMP1
 	 SET ORDER TO K2F_TEMP1
 	 SELECT K2F_TEMP
 	 GO TOP      
     K2F_LIST = CREATEOBJECT("K2F_LIST")  
     K2F_LIST.SHOW                   
     IF THISFORM.KEY_LIST.DISPLAYVALUE = '依發票代號排列' 
        AREA1 = 'K25_1'
     ELSE
      	AREA1 = 'K25_3'
     ENDIF     
     THISFORM.GRID2.SETFOCUS     
  ENDPROC   
  **********************修改報單
  PROCEDURE BTTF06.CLICK
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.F.
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.READONLY=.F.
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
       THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.T.       
       THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE=VAL(K25.F05)       
       THIS.Visible=.F.
       THISFORM.PAGEFRAME1.PAGE2.BTTF06_YES.VISIBLE=.T.
       THISFORM.PAGEFRAME1.PAGE2.BTTF06_NO.VISIBLE=.T.       
  ENDPROC
  ************上傳電子發票
  PROC SEND_BOTT.CLICK
       IF MESSAGEBOX('是否確定上傳張發票?',4+32+256,'請確認') = 6	
          IF RLOCK()             
             WEST_DT=DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+K25.F02))
             IF K25.F01 = '31' OR K25.F01='32'  &&上傳出貨發票
                CREATE CURSOR INV_H;    &&建立表頭檔
                (F01 C(1),F02 C(36),F03 C(19),F04 C(10),F05 C(10),F06 C(8),F07 C(10),F08 C(60),F09 C(100),F10 C(12),;
                F11 C(15),F12 C(15),F13 C(40),F14 C(10),F15 C(60),F16 C(100),F17 C(12),F18 C(15),F19 C(15),F20 C(40),;
                F21 C(200),F22 C(1),F23 C(2),F24 C(1),F25 C(6),F26 C(64),F27 C(64),F28 C(1),F29 C(7),F30 C(4),F31 N(12),;
                F32 N(12),F33 N(12),F34 C(1),F35 N(5,2),F36 N(12),F37 N(12),F38 N(12,2),F39 N(12,4),F40 C(3),F41 C(1),F42 C(1) )                 
               
                SELECT INV_H
                APPEND BLANK
                REPLACE F01 WITH 'H'
                REPLACE F02 WITH LEFT(K25.F15,10)
                REPLACE F03 WITH LEFT(DTOS(DATE()),4)+'-'+SUBSTR(DTOS(DATE()),5,2)+'-'+RIGHT(DTOS(DATE()),2)+SPACE(1)+TIME()
                REPLACE F04 WITH K25.F07
                REPLACE F05 WITH LEFT(WEST_DT,4)+'-'+SUBSTR(WEST_DT,5,2)+'-'+K25.F02
                REPLACE F06 WITH TIME()
                REPLACE F07 WITH INT_107                
                REPLACE F08 WITH CHRTRAN(INT_000,' ','')
                REPLACE F09 WITH CHRTRAN(INT_109,' ','')
                REPLACE F14 WITH IIF(!EMPTY(ALLTRIM(K25.F04)),K25.F04,'0000000000')
                REPLACE F15 WITH IIF(!EMPTY(ALLTRIM(K25.F04)),IIF(SEEK(K25.F03,'C01'),C01.F41,''),'0000')
                
                REPLACE F21 WITH K25.F03+SPACE(1)+LEFT(K25.F15,10)+SPACE(1)+IIF(K25.F21=INT_011,'','單價幣別:'+IIF(K25.F21='US  ','USD ',K25.F21))
                REPLACE F22 WITH K25.F05
                REPLACE F23 WITH '07'
                REPLACE F24 WITH '0'
                REPLACE F28 WITH 'Y'
                REPLACE F30 WITH PADR(IIF(EMPTY(ALLTRIM(K25.F04)),PADR(ALLTRIM(STR((RAND()*10000))),4,'0'),' '),4,' ')
                REPLACE F31 WITH IIF(K25.F09='1',IIF(EMPTY(K25.F04),K25.F12,K25.F08),0)
                REPLACE F32 WITH IIF(K25.F09='3',K25.F08,0)
                REPLACE F33 WITH IIF(K25.F09='2',K25.F08,0)
                REPLACE F34 WITH K25.F09
                REPLACE F35 WITH IIF(K25.F09='1',INT_002/100,0)
                REPLACE F36 WITH IIF(EMPTY(ALLTRIM(K25.F04)),0,K25.F10)  &&如果無統編則此欄填零
                REPLACE F37 WITH K25.F12
                IF K25.F21<>INT_011    &&如果非本國幣別
                   REPLACE F38 WITH K25.F23
                   REPLACE F39 WITH K25.F22
                   REPLACE F40 WITH IIF(ALLTRIM(K25.F21)='US','USD',K25.F21)
                ELSE
                   REPLACE F39 WITH 1   
                ENDIF   
                REPLACE F41 WITH IIF(K25.F01='31' AND K25.F09='2','1',' ')
                REPLACE F42 WITH IIF(SEEK(K25.F03,'C01'),C01.F47,' ')
                 
                 FILE_NAME=ALLTRIM(INT_IDT)+'INVOUT\'+'INV'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'                                    
                 STRTOFILE(INV_H.F01+INV_H.F02+INV_H.F03+INV_H.F04+INV_H.F05+INV_H.F06+INV_H.F07+INV_H.F08+INV_H.F09+INV_H.F10+INV_H.F11+INV_H.F12+INV_H.F13+INV_H.F14+INV_H.F15+;
                 INV_H.F16+INV_H.F17+INV_H.F18+INV_H.F19+INV_H.F20+INV_H.F21+INV_H.F22+INV_H.F23+INV_H.F24+INV_H.F25+INV_H.F26+INV_H.F27+INV_H.F28+INV_H.F29+;
                 INV_H.F30+PADR(LTRIM(TRANSFORM(INV_H.F31,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_H.F32,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_H.F33,'@R 999999999999')),12,' ')+INV_H.F34+;
                 PADR(LTRIM(TRANSFORM(INV_H.F35,'@R 99.99')),5,' ')+PADR(LTRIM(TRANSFORM(INV_H.F36,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_H.F37,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_H.F38,'@R 999999999.99')),12,' ')+;
                 PADR(LTRIM(TRANSFORM(INV_H.F39,'@R 9999999.9999')),12,' ')+INV_H.F40+INV_H.F41+INV_H.F42+CHR(13) + CHR(10),FILE_NAME,1)
                 *****處理列印發票表頭檔
                 IF INT_160  &&如果預設要轉列印檔
                    CREATE CURSOR INVPNT_H;
                    (F01 C(1),F02 C(36),F03 C(19),F04 C(10),F05 C(10),F06 C(8),F07 C(20),F08 C(10),F09 C(60),F10 C(100),F11 C(15),F12 C(20),F13 C(10),F14 C(60),;
                    F15 C(100),F16 C(96),F17 C(2),F18 C(4),F19 N(12),F20 N(12),F21 N(12),F22 C(1),F23 N(5,2),F24 N(12),F25 N(12),F26 C(1),F27 C(1),F28 C(32),F29 C(32),F30 C(40))
                    SELECT INVPNT_H
                    APPEND BLANK
                    REPLACE F01 WITH INV_H.F01
                    REPLACE F02 WITH INV_H.F02
                    REPLACE F03 WITH INV_H.F03
                    REPLACE F04 WITH INV_H.F04
                    REPLACE F05 WITH INV_H.F05
                    REPLACE F06 WITH INV_H.F06
                    REPLACE F07 WITH LEFT(K25.F15,10)
                    REPLACE F08 WITH INV_H.F07
                    REPLACE F09 WITH INV_H.F08
                    REPLACE F10 WITH INV_H.F09
                    REPLACE F13 WITH INV_H.F14
                    REPLACE F14 WITH IIF(SEEK(K25.F03,'C01'),C01.F41,'')
                    REPLACE F17 WITH INV_H.F23
                    REPLACE F18 WITH INV_H.F30
                    REPLACE F19 WITH INV_H.F31
                    REPLACE F20 WITH INV_H.F32
                    REPLACE F21 WITH INV_H.F33
                    REPLACE F22 WITH INV_H.F34
                    REPLACE F23 WITH INV_H.F35
                    REPLACE F24 WITH INV_H.F36
                    REPLACE F25 WITH INV_H.F37                 
                    REPLACE F27 WITH '3'
                    REPLACE F30 WITH 'USERQQ'
                    FILE_NAME=ALLTRIM(INT_IDT)+'INVPNT\'+'IVP'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'                                    
                    STRTOFILE(INVPNT_H.F01+INVPNT_H.F02+INVPNT_H.F03+INVPNT_H.F04+INVPNT_H.F05+INVPNT_H.F06+INVPNT_H.F07+INVPNT_H.F08+INVPNT_H.F09;
                    +INVPNT_H.F10+INVPNT_H.F11+INVPNT_H.F12+INVPNT_H.F13+INVPNT_H.F14+INVPNT_H.F15+INVPNT_H.F16+INVPNT_H.F17+INVPNT_H.F18;
                    +PADR(LTRIM(TRANSFORM(INVPNT_H.F19,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INVPNT_H.F20,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INVPNT_H.F21,'@R 999999999999')),12,' ')+INVPNT_H.F22+;
                    PADR(LTRIM(TRANSFORM(INVPNT_H.F23,'@R 99.99')),5,' ')+PADR(LTRIM(TRANSFORM(INVPNT_H.F24,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(INVPNT_H.F25,'@R 999999999999')),12,' ')+INVPNT_H.F26;
                    +INVPNT_H.F27+INVPNT_H.F28+INVPNT_H.F29+INVPNT_H.F30+CHR(13) + CHR(10),FILE_NAME,1)
                    SELECT INVPNT_H
                    USE
                 ENDIF   
                 SELECT INV_H
                 USE
                ************* &&處理表身                
                  CREATE CURSOR INV_M;
                  (F01 C(1),F02 C(36),F03 C(10),F04 C(10),F05 C(60),F06 N(12),F07 C(6),F08 N(12,6),F09 N(12),F10 C(3),F11 C(40),F12 C(20))                  
                  SELECT INV_M
                IF !USED('C04')
                   SELECT 0
                   USE C04
                ELSE
                   SELECT C04
                ENDIF
                SET ORDER TO 1        
                IF !USED('C03')
                   SELECT 0
                   USE C03
                ELSE
                   SELECT C03
                ENDIF
                SET ORDER TO 1      
                IF !USED('B01')
                   SELECT 0
                   USE B01
                ELSE
                  SELECT B01
                ENDIF
                SET ORDER TO 1     
                FILE_NAME1=ALLTRIM(INT_IDT)+'INVOUT\'+'INV'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT' 
                IF INT_160  &&如果預設轉入列印檔
                   FILE_NAME2=ALLTRIM(INT_IDT)+'INVPNT\'+'IVP'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT' 
                ENDIF   
                IF LEFT(K25.F15,2)='BC'   &&出貨單
                   B04 = 'B04' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			       IF !USED('&B04')
			           SELECT  0
			          USE (B04) ALIAS B04
			       ELSE
			          SELECT  B04
			       ENDIF
			       SET ORDER TO 1  	
			       SEEK LEFT(K25.F15,10)
			       IF FOUND()
			          SER_NO=1		          
			          DO WHILE B04.F01=LEFT(K25.F15,10)
			             SELECT INV_M
			             APPEND BLANK
			             REPLACE F01 WITH 'D'
			             REPLACE F02 WITH B04.F01
			             REPLACE F03 WITH K25.F07
			             REPLACE F04 WITH LEFT(WEST_DT,4)+'-'+SUBSTR(WEST_DT,5,2)+'-'+K25.F02
			             REPLACE F05 WITH IIF(SEEK(B04.F79,'B01'),B01.F99,'')+SPACE(1)+IIF(IIF(SEEK(K25.F03,'C01'),C01.F42,'')='1',B04.F03,IIF(SEEK(B04.F07+B04.F03,'C04'),C04.F17,''))
			             REPLACE F06 WITH B04.F04
			             REPLACE F08 WITH B04.F15	
			             REPLACE F09 WITH B04.F17		             		             
			             REPLACE F10 WITH PADL(ALLTRIM(STR(SER_NO)),3,'0')
			             REPLACE F11 WITH ALLTRIM(IIF(SEEK(B04.F07,'C03'),C03.F14,''))+IIF(INT_011=K25.F21,'','/'+IIF(K25.F21='US  ','USD ',K25.F21)+TRANSFORM(K25.F22,'@R 999.9999'))
			             REPLACE F12 WITH B04.F07
			             STRTOFILE(INV_M.F01+INV_M.F02+INV_M.F03+INV_M.F04+PADR(INV_M.F05,256,' ')+PADR(ALLTRIM(STR(INV_M.F06)),12,' ')+INV_M.F07+;
			             PADR(LTRIM(TRANSFORM(INV_M.F08,'@R 99999.999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_M.F09,'@R 999999999999')),12, ' ')+INV_M.F10+PADR(INV_M.F11,40,' ')+INV_M.F12+CHR(13) + CHR(10),FILE_NAME1,1)
			             IF INT_160
			                STRTOFILE(INV_M.F01+INV_M.F02+INV_M.F03+INV_M.F04+PADR(INV_M.F05,256,' ')+PADR(LTRIM(TRANSFORM(INV_M.F06,'@ 999999999999')),12,' ')+INV_M.F07+;
			                PADR(LTRIM(TRANSFORM(INV_M.F08,'@R 99999.999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_M.F09,'@R 99999999999')),12,' ')+INV_M.F10+PADR(INV_M.F11,40,' ')+CHR(13) + CHR(10),FILE_NAME2,1)  
			             ENDIF   
			             SER_NO=SER_NO+1
			             SELECT B04
			             SKIP
			          ENDDO
			       ENDIF
			       SELECT B04
			       USE
			    ELSE                 &&送貨單
			       SELECT B06
			       SET ORDER TO 1
			       SEEK LEFT(K25.F15,10)
			       IF FOUND()
			          SER_NO=1
			          DO WHILE B06.F01=LEFT(K25.F15,10)
			             SELECT INV_M
			             APPEND BLANK
			             REPLACE F01 WITH 'D'
			             REPLACE F02 WITH B06.F01
			             REPLACE F03 WITH K25.F07
			             REPLACE F04 WITH LEFT(WEST_DT,4)+'-'+SUBSTR(WEST_DT,5,2)+'-'+K25.F02
			             REPLACE F05 WITH IIF(SEEK(B06.F79,'B01'),B01.F99,'')+SPACE(1)+IIF(IIF(SEEK(K25.F03,'C01'),C01.F42,'')='1',B06.F03,IIF(SEEK(B06.F09+B06.F03,'C04'),C04.F17,''))
			             REPLACE F06 WITH B06.F04
			             REPLACE F08 WITH B06.F14
			             REPLACE F09 WITH ROUND(B06.F04*B06.F14*B06.F17,0)
			             REPLACE F10 WITH PADL(ALLTRIM(STR(SER_NO)),3,'0')
			             REPLACE F11 WITH ALLTRIM(IIF(SEEK(B06.F09,'C03'),C03.F14,''))+IIF(INT_011=K25.F21,'','/'+IIF(K25.F21='US  ','USD ',K25.F21)+TRANSFORM(K25.F22,'@R 999.9999'))
			             REPLACE F12 WITH B06.F09
			             STRTOFILE(INV_M.F01+INV_M.F02+INV_M.F03+INV_M.F04+PADR(INV_M.F05,256,' ')+PADR(LTRIM(TRANSFORM(INV_M.F06,'@R 999999999999')),12,' ')+INV_M.F07+;
			             PADR(LTRIM(TRANSFORM(INV_M.F08,'@R 99999.999999')),12,' ')+PADR(ALLTRIM(STR(INV_M.F09)),12,' ')+INV_M.F10+PADR(INV_M.F11,40,' ')+INV_M.F12+CHR(13) + CHR(10),FILE_NAME1,1)
			             STRTOFILE(INV_M.F01+INV_M.F02+INV_M.F03+INV_M.F04+PADR(INV_M.F05,256,' ')+PADR(LTRIM(TRANSFORM(INV_M.F06,'@R 999999999999')),12,' ')+INV_M.F07+;
			             PADR(LTRIM(TRANSFORM(INV_M.F08,'@R 99999.999999')),12,' ')+PADR(LTRIM(TRANSFORM(INV_M.F09,'@R 999999999999')),12,' ')+INV_M.F10+PADR(INV_M.F11,40,' ')+CHR(13) + CHR(10),FILE_NAME2,1)
			             SER_NO=SER_NO+1
			             SELECT B06
			             SKIP
			          ENDDO
			       ENDIF 
			       SELECT B06
			       SET ORDER TO 2
			    ENDIF   
			    SELECT B01 
			    USE
                SELECT C03
                USE
                SELECT C04
                USE  
                  
                        
                   
                  SELECT INV_M
                  USE
                SELECT K25    
                REPLACE F14 WITH RIGHT(DTOS(DATE()),4)           
             ELSE                               &&上傳退貨或折讓證明單
                   B05 = 'B05' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			       IF !USED('&B05')
			           SELECT  0
			          USE (B05) ALIAS B05
			       ELSE
			          SELECT  B05
			       ENDIF
			       SET ORDER TO 1  	
			       SEEK LEFT(K25.F15,10)
			       IF FOUND()
                      ODM=VAL(LEFT(DTOS(CTOD(B05.F08+'/01')),6))%2    &&先開啟發票號碼檔
                      MMT=ALLTRIM(STR(VAL(LEFT(DTOS(CTOD(B05.F08+'/01')),6))+ODM-1))          
                      K39='K39'+MMT
                      IF !USED('&K39')
                          SELECT 0
                          USE (K39) ALIAS K39
                      ELSE
                          SELECT K39
                      ENDIF
                      SET ORDER TO 2
                      SEEK B05.F20
                      IF FOUND()
                         DBT_DT=F03                        
                      ENDIF
                      SELECT K39
                      USE
                      IF DBT_DT=DATE() OR EMPTY(DBT_DT)
                         =MESSAGEBOX("B05出貨退回單中之原出貨月份無此張發票號碼!",0+48,"提示訊息視窗")
                         SELECT B05
                         USE 
                         RETURN
                      ENDIF
                    ELSE
                       =MESSAGEBOX("出貨退回單無此張單號!",0+48,"提示訊息視窗")
                       SELECT B05
                       USE
                       RETURN  
                    ENDIF      
                CREATE CURSOR DBT_H;    &&建立表頭檔
                (F01 C(1),F02 C(36),F03 C(19),F04 C(16),F05 C(10),F06 C(10),F07 C(60),F08 C(100),F09 C(12),F10 C(15),;
                F11 C(15),F12 C(40),F13 C(10),F14 C(60),F15 C(100),F16 C(12),F17 C(15),F18 C(15),F19 C(40),F20 C(10),;
                F21 N(12),F22 N(12),F23 C(1))
                SELECT DBT_H
                APPEND BLANK
                REPLACE F01 WITH 'H'                 
                REPLACE F02 WITH LEFT(K25.F15,10)
                REPLACE F03 WITH LEFT(DTOS(DATE()),4)+'-'+SUBSTR(DTOS(DATE()),5,2)+'-'+RIGHT(DTOS(DATE()),2)+SPACE(1)+TIME()
                REPLACE F04 WITH LEFT(K25.F15,10)
                REPLACE F05 WITH LEFT(WEST_DT,4)+'-'+SUBSTR(WEST_DT,5,2)+'-'+K25.F02
                REPLACE F06 WITH INT_107
               
                REPLACE F07 WITH CHRTRAN(INT_000,' ','')
                REPLACE F08 WITH CHRTRAN(INT_109,' ','')
                REPLACE F13 WITH IIF(!EMPTY(ALLTRIM(K25.F04)),K25.F04,'0000000000')
                REPLACE F14 WITH IIF(!EMPTY(ALLTRIM(K25.F04)),IIF(SEEK(K25.F03,'C01'),C01.F41,''),'0000')
                REPLACE F20 WITH '2'
                REPLACE F21 WITH ABS(K25.F10)
                REPLACE F22 WITH ABS(K25.F08)
                REPLACE F23 WITH IIF(SEEK(K25.F03,'C01'),C01.F47,'')
                FILE_NAME1=ALLTRIM(INT_IDT)+'DBTOUT\'+'DBT'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'                                    
                 STRTOFILE(DBT_H.F01+DBT_H.F02+DBT_H.F03+DBT_H.F04+DBT_H.F05+DBT_H.F06+DBT_H.F07+DBT_H.F08+DBT_H.F09+DBT_H.F10+DBT_H.F11+DBT_H.F12+DBT_H.F13+DBT_H.F14+DBT_H.F15+;
                 DBT_H.F16+DBT_H.F17+DBT_H.F18+DBT_H.F19+DBT_H.F20;                 
                 +PADR(LTRIM(TRANSFORM(DBT_H.F21,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(DBT_H.F22,'@R 999999999999')),12,' ')+DBT_H.F23+CHR(13) + CHR(10),FILE_NAME1,1)    
                 IF INT_160  &&如果預設轉入列印檔
                    *****處理列印折讓證明單表檔
                    CREATE CURSOR DBTPNT_H;
                    (F01 C(1),F02 C(36),F03 C(19),F04 C(4),F05 C(10),F06 C(10),F07 C(60),F08 C(100),F09 C(10),F10 C(60),F11 N(12),F12 N(12),F13 C(1),F14 C(40))                
                    SELECT DBTPNT_H
                    APPEND BLANK
                    REPLACE F01 WITH DBT_H.F01
                    REPLACE F02 WITH DBT_H.F02
                    REPLACE F03 WITH DBT_H.F03
                    REPLACE F04 WITH DBT_H.F04
                    REPLACE F05 WITH DBT_H.F05
                    REPLACE F06 WITH DBT_H.F06
                    REPLACE F07 WITH DBT_H.F07
                    REPLACE F08 WITH DBT_H.F08
                    REPLACE F09 WITH DBT_H.F13
                    REPLACE F10 WITH IIF(EMPTY(K25.F04),'',IIF(SEEK(K25.F03,'C01'),C01.F41,''))
                    REPLACE F11 WITH DBT_H.F21
                    REPLACE F12 WITH DBT_H.F22
                    REPLACE F13 WITH '1'
                    REPLACE F14 WITH 'USERQQ'
                    FILE_NAME2=ALLTRIM(INT_IDT)+'DBTPNT\'+'DTP'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'                                    
                    STRTOFILE(DBTPNT_H.F01+DBTPNT_H.F02+DBTPNT_H.F03+DBTPNT_H.F04+DBTPNT_H.F05+DBTPNT_H.F06+DBTPNT_H.F07+DBTPNT_H.F08+DBTPNT_H.F09+DBTPNT_H.F10;                 
                    +PADR(LTRIM(TRANSFORM(DBTPNT_H.F11,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(DBTPNT_H.F12,'@R 999999999999')),12,' ')+DBTPNT_H.F13+DBTPNT_H.F14+CHR(13) + CHR(10),FILE_NAME2,1)    
                    USE
                 ENDIF             
                 SELECT DBT_H
                 USE
                 **********處理折讓單表身
                 CREATE CURSOR DBT_M;     
                (F01 C(1),F02 C(36),F03 C(10),F04 C(10),F05 C(60),F06 N(12),F07 C(6),F08 N(12,6),F09 N(12),F10 N(12),F11 C(3),F12 C(1))
                IF !USED('C04')
                   SELECT 0
                   USE C04
                ELSE
                  SELECT C04
                ENDIF
                SET ORDER TO 1 
                IF !USED('B01')
                   SELECT 0
                   USE B01
                ELSE
                  SELECT B01
                ENDIF
                SET ORDER TO 1     
                FILE_NAME1=ALLTRIM(INT_IDT)+'DBTOUT\'+'DBT'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT' 
                IF INT_160   &&如果預設轉入列印檔
                   FILE_NAME2=ALLTRIM(INT_IDT)+'DBTPNT\'+'DTP'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'
                ENDIF    
                   SELECT B05
                   SEEK LEFT(K25.F15,10) 
			       IF FOUND()
			          SER_NO=1	
			          DO WHILE B05.F01=LEFT(K25.F15,10)	          
                         SELECT DBT_M
                         APPEND BLANK
                         REPLACE F01 WITH 'D'
                         REPLACE F02 WITH LEFT(K25.F15,10)
                         REPLACE F03 WITH K25.F07
                         REPLACE F04 WITH LEFT(DTOS(DBT_DT),4)+'-'+SUBSTR(DTOS(DBT_DT),5,2)+'-'+RIGHT(DTOS(DBT_DT),2)
                         REPLACE F05 WITH IIF(SEEK(B05.F79,'B01'),B01.F99,'')+SPACE(1)+IIF(IIF(SEEK(K25.F03,'C01'),C01.F42,'')='1',B05.F03,IIF(SEEK(B05.F11+B05.F03,'C04'),C04.F17,''))
                         REPLACE F06 WITH B05.F04
                          
                         REPLACE F09 WITH ROUND(IIF(B05.F22='34' AND B05.F23='1',B05.F04*B05.F17*B05.F18/(1+INT_002/100),B05.F04*B05.F17*B05.F18),0)
			             REPLACE F08 WITH ROUND(IIF(B05.F22='34' AND B05.F23='1',F09/B05.F04,B05.F17*B05.F18),6)	
                         REPLACE F10 WITH IIF(B05.F23='1',ROUND(F09*(INT_002/100),0),0)
                         REPLACE F11 WITH PADL(ALLTRIM(STR(SER_NO)),3,'0')
                         REPLACE F12 WITH B05.F23
                         
                         STRTOFILE(DBT_M.F01+DBT_M.F02+DBT_M.F03+DBT_M.F04+PADR(DBT_M.F05,256,' ')+PADR(ALLTRIM(STR(DBT_M.F06)),12,' ')+DBT_M.F07+;
			             PADR(LTRIM(TRANSFORM(DBT_M.F08,'@R 99999.999999')),12,' ')+PADR(LTRIM(TRANSFORM(DBT_M.F09,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(DBT_M.F10,'@R 999999999999')),12,' ')+DBT_M.F11+DBT_M.F12+CHR(13) + CHR(10),FILE_NAME1,1)
			             IF INT_160  &&如果預設轉入列印檔
			                STRTOFILE(DBT_M.F01+DBT_M.F02+DBT_M.F03+DBT_M.F04+PADR(DBT_M.F05,256,' ')+PADR(ALLTRIM(STR(DBT_M.F06)),12,' ')+DBT_M.F07+;
			                PADR(LTRIM(TRANSFORM(DBT_M.F08,'@R 99999.999999')),12,' ')+PADR(LTRIM(TRANSFORM(DBT_M.F09,'@R 999999999999')),12,' ')+PADR(LTRIM(TRANSFORM(DBT_M.F10,'@R 999999999999')),12,' ')+DBT_M.F11+DBT_M.F12+'07'+CHR(13) + CHR(10),FILE_NAME2,1)
			             ENDIF
			             SER_NO=SER_NO+1
                         SELECT B05
                         SKIP
                      ENDDO
                   ENDIF     
                   SELECT B05
                   USE
                   SELECT C04
                   USE
                   SELECT B01
                   USE 
                            
                  SELECT DBT_M
                  USE
                  SELECT K25    
                  REPLACE F14 WITH RIGHT(DTOS(DATE()),4)      
             ENDIF
             UNLOCK ALL
          ELSE
             DO FILE_IMPACT
              UNLOCK ALL
              RETURN
          ENDIF
       ENDIF                    
     THISFORM.GRID2.SETFOCUS
*!*	       THISFORM.REFRESH
  ENDPROC
  ************空白發票
  PROC SPC_BOTT.CLICK
  
  ENDPROC
 *******作廢 
  PROC CNC_BOTT.CLICK
       IF MESSAGEBOX('是否確定要做廢此張發票?',4+32+256,'請確認') = 6	
          REASON_OFDSC=CREATEOBJECT("REASON_OFDSC")  
          REASON_OFDSC.SHOW    
          IF EMPTY(ALLTRIM(RSN_DSC))
                =MESSAGEBOX("作廢原因不得空白",0+48,"提示訊息式窗")
                RETURN
          ENDIF
          IF LEFT(K25.F01,1)='3'  &&只做銷項
             WEST_DT=DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+K25.F02)) 
            
                 
            
             IF K25.F01$'3132'    &&發票作廢
                 ODM=VAL(LEFT(WEST_DT,6))%2    &&先開啟發票號碼檔
                 MMT=ALLTRIM(STR(VAL(LEFT(WEST_DT,6))+ODM-1))        
                 K39='K39'+MMT
                 IF !USED('&K39')
                     SELECT 0
                     USE (K39) ALIAS K39
                 ELSE
                     SELECT K39
                 ENDIF
                 SET ORDER TO 2               
                 SEEK K25.F07
                 IF FOUND()            
                    REPLACE F04 WITH '+'
                    REPLACE F05 WITH DATE()
                    REPLACE F06 WITH '此張發票作廢'+SPACE(1)+DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 ENDIF    
                 USE       
                FILE_NAME=ALLTRIM(INT_IDT)+'INVDSC\'+'DSC'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'   
                CREATE CURSOR DSRC (F01 C(19),F02 C(10),F03 C(10),F04 C(10),F05 C(10),F06 C(10),F07 C(8),F08 C(20),F09 C(60),F10 C(1))
                APPEND BLANK                
                REPLACE F01 WITH LEFT(DTOS(DATE()),4)+'-'+SUBSTR(DTOS(DATE()),5,2)+'-'+RIGHT(DTOS(DATE()),2)+SPACE(1)+TIME()
                REPLACE F02 WITH K25.F07
                REPLACE F03 WITH LEFT(WEST_DT,4)+'-'+SUBSTR(WEST_DT,5,2)+'-'+K25.F02
                REPLACE F04 WITH IIF(!EMPTY(ALLTRIM(K25.F04)),K25.F04,'0000000000')
                REPLACE F05 WITH INT_107
                REPLACE F06 WITH LEFT(DTOS(DATE()),4)+'-'+SUBSTR(DTOS(DATE()),5,2)+'-'+RIGHT(DTOS(DATE()),2)
                REPLACE F07 WITH TIME()
                REPLACE F08 WITH RSN_DSC
                REPLACE F10 WITH IIF(SEEK(K25.F03,'C01'),C01.F47,'')
                STRTOFILE(DSRC.F01+DSRC.F02+DSRC.F03+DSRC.F04+DSRC.F05+DSRC.F06+DSRC.F07+DSRC.F08+DSRC.F09+DSRC.F10+CHR(13) + CHR(10),FILE_NAME,1)			   
                                                                    
             ELSE       &&折讓作廢
                 FILE_NAME=ALLTRIM(INT_IDT)+'DBTDSC\'+'DTD'+DTOS(DATE())+LEFT(K25.F15,10)+'.TXT'   
                 CREATE CURSOR DBTDSC (F01 C(19),F02 C(16),F03 C(10),F04 C(10),F05 C(10),F06 C(10),F07 C(8),F08 C(20),F09 C(1))
                
                APPEND BLANK                
                REPLACE F01 WITH LEFT(DTOS(DATE()),4)+'-'+SUBSTR(DTOS(DATE()),5,2)+'-'+RIGHT(DTOS(DATE()),2)+SPACE(1)+TIME()
                REPLACE F02 WITH LEFT(K25.F15,10)
                REPLACE F03 WITH LEFT(WEST_DT,4)+'-'+SUBSTR(WEST_DT,5,2)+'-'+K25.F02
                REPLACE F04 WITH IIF(!EMPTY(ALLTRIM(K25.F04)),K25.F04,'0000000000')
                REPLACE F05 WITH INT_107
                REPLACE F06 WITH LEFT(DTOS(DATE()),4)+'-'+SUBSTR(DTOS(DATE()),5,2)+'-'+RIGHT(DTOS(DATE()),2)
                REPLACE F07 WITH TIME()
                REPLACE F08 WITH RSN_DSC
                REPLACE F09 WITH IIF(SEEK(K25.F03,'C01'),C01.F47,'')
                STRTOFILE(DBTDSC.F01+DBTDSC.F02+DBTDSC.F03+DBTDSC.F04+DBTDSC.F05+DBTDSC.F06+DBTDSC.F07+DBTDSC.F08+DBTDSC.F09+CHR(13) + CHR(10),FILE_NAME,1)	
                 
             ENDIF   
          ENDIF
          
          SELECT K2F
          SEEK K25.F07
          IF FOUND()
             DO WHILE F01=K25.F07
                DELETE
                SKIP
             ENDDO
          ENDIF      
          SELECT K25
          KK = K25.F01 + K25.F07
          IF RLOCK() 
          	 DO CASE
                CASE LEFT(K25.F01,1) = '3' &&AND K25.F09 = '1'
                     SELECT C13
                     SET ORDER TO C134
                     SEEK LEFT(K25.F15,10)
                     IF FOUND()
                        DO WHILE C13.F02=LEFT(K25.F15,10)
                           IF ALLTRIM(F05) = ALLTRIM('發票:' + K25.F07)
                              DELETE 
                           ENDIF
                           REPLACE F17 WITH ''
                           SELECT C13
                           SKIP
                        ENDDO
                     ENDIF
                     DO CASE
                        CASE LEFT(K25.F15,2)='BC' 
	                         B04 = 'B04' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			                 IF !USED('&B04')
			                    SELECT  0
			                    USE (B04) ALIAS B04
			                 ELSE
			                    SELECT  B04
			                 ENDIF 
			                 SET ORDER TO 1
			                 SEEK LEFT(K25.F15,10)
			                 IF FOUND()
			                    DO WHILE B04.F01=LEFT(K25.F15,10)
			                       REPLACE F08 WITH ''
			                       REPLACE F20 WITH ''
			                       REPLACE F22 WITH ''
			                       REPLACE F23 WITH ''
			                       SELECT B04
			                       SKIP
			                    ENDDO
			                 ENDIF
			                 SELECT B04
			                 USE
			            CASE LEFT(K25.F15,2)='BD'
			                  B05 = 'B05' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			                 IF !USED('&B05')
			                    SELECT  0
			                    USE (B05) ALIAS B05
			                 ELSE
			                    SELECT  B05
			                 ENDIF 
			                 SET ORDER TO 1
			                 SEEK LEFT(K25.F15,10)
			                 IF FOUND()
			                    DO WHILE B05.F01=LEFT(K25.F15,10)
			                       REPLACE F20 WITH ''
			                       REPLACE F22 WITH ''
			                       REPLACE F23 WITH ''
			                       SELECT B05
			                       SKIP
			                    ENDDO
			                 ENDIF
			                 SELECT B05
			                 USE
			             CASE LEFT(K25.F15,2)='BE'     
			                  SELECT B06
			                  SET ORDER TO 1
			                  SEEK LEFT(K25.F15,10)
			                 IF FOUND()
			                    DO WHILE B06.F01=LEFT(K25.F15,10)
			                       REPLACE F20 WITH ''
			                       REPLACE F22 WITH ''
			                       REPLACE F23 WITH ''
			                       REPLACE F24 WITH ''
			                       SELECT B06
			                       SKIP
			                    ENDDO
			                 ENDIF
			                 SELECT B06
			                 SET ORDER TO 2
			         ENDCASE          
                CASE K25.F01 = '21' AND K25.F09 = '1' AND LEFT(K25.F15,1) = 'B'
                      IF LEFT(K25.F15,2)$'BMBR'
                         SELECT E20
                      ELSE
                         SELECT D19
                      ENDIF                                    
                      LOCATE FOR ALLTRIM(F05) = ALLTRIM('發票:' + K25.F07)
                      IF FOUND()
                         DELETE 
                      ENDIF                                         
                CASE K25.F01 = '21' AND K25.F09 = '1' AND LEFT(K25.F15,1) = 'P'
                     SELECT P19
                     LOCATE FOR ALLTRIM(F05) = ALLTRIM('發票:' + K25.F07)
                     IF FOUND()
                        DELETE 
                     ENDIF
             ENDCASE  
             ********* 
             SELECT K24
             SET ORDER TO K241
             SEEK K25.F01
             IF FOUND()
                REPLACE K24.F03 WITH K24.F03 + (K25.F08 * (-1))
                REPLACE K24.F04 WITH K24.F04 + (K25.F10 * (-1))
                REPLACE K24.F05 WITH K24.F05 + (K25.F12 * (-1))
	            DO CASE
	               CASE K25.F09 = '1'
	                    REPLACE K24.F06 WITH K24.F06 - 1
	               CASE K25.F09 = '2'
	                    REPLACE K24.F07 WITH K24.F07 - 1
	               CASE K25.F09 = '3'
	                    REPLACE K24.F08 WITH K24.F08 - 1
	            ENDCASE
	            REPLACE K24.F09 WITH K24.F09 + 1
             ENDIF
             *****
             SELECT K24
             SET ORDER TO K242
             SEEK K25.F03
             IF FOUND()
                REPLACE K24.F03 WITH K24.F03 + (K25.F08 * (-1))
                REPLACE K24.F04 WITH K24.F04 + (K25.F10 * (-1))
                REPLACE K24.F05 WITH K24.F05 + (K25.F12 * (-1))
	            DO CASE
	               CASE K25.F09 = '1'
	                    REPLACE K24.F06 WITH K24.F06 - 1
	               CASE K25.F09 = '2'
	                    REPLACE K24.F07 WITH K24.F07 - 1
	               CASE K25.F09 = '3'
	                    REPLACE K24.F08 WITH K24.F08 - 1                           
	            ENDCASE 
	            REPLACE K24.F09 WITH K24.F09 + 1 
	         ENDIF
	         SELECT K24
             SEEK '作廢 '
             IF FOUND()       
	            REPLACE K24.F09 WITH K24.F09 + 1        
	         ELSE
	            SELECT K24 
	            APPEND BLANK 
	            REPLACE K24.F02 WITH '作廢'
	            REPLACE K24.F09 WITH 1 
	         ENDIF             
             ******          
             SELECT K25_3
             SET ORDER TO K25_31
             SEEK K25.F03 
             IF FOUND()
	            REPLACE K25_3.F08 WITH K25_3.F08 + (K25.F08 * (-1))
	            REPLACE K25_3.F10 WITH K25_3.F10 + (K25.F10 * (-1))
	            REPLACE K25_3.F12 WITH K25_3.F12 + (K25.F12 * (-1))
	            DO CASE
	               CASE K25.F09 = '1'
	                    REPLACE K25_3.F13 WITH K25_3.F13 - 1
	               CASE K25.F09 = '2'
	                    REPLACE K25_3.F14 WITH K25_3.F14 - 1
	               CASE K25.F09 = '3'
	                    REPLACE K25_3.F15 WITH K25_3.F15 - 1
	            ENDCASE 
                REPLACE K25_3.F16 WITH 1
             ENDIF   
		     SELECT K25_3
	         SEEK '作廢 '
	         IF FOUND()
		        REPLACE  K25_3.F16 WITH K25_3.F16+1     
		     ELSE
		        SELECT K25_3
		        APPEND BLANK
		        REPLACE K25_3.F03 WITH '作廢' 
		        REPLACE K25_3.F18 WITH '作廢發票' 
		        REPLACE K25_3.F16 WITH 1
		     ENDIF
		********	  
             SELECT K25_1
             REPLACE K25_1.F08 WITH K25_1.F08 + (K25.F08 * (-1))
             REPLACE K25_1.F10 WITH K25_1.F10 + (K25.F10 * (-1))
             REPLACE K25_1.F12 WITH K25_1.F12 + (K25.F12 * (-1))
             DO CASE
                CASE K25.F09 = '1'
                     REPLACE K25_1.F13 WITH K25_1.F13 - 1
                CASE K25.F09 = '2'
                     REPLACE K25_1.F14 WITH K25_1.F14 - 1
                CASE K25.F09 = '3'
                     REPLACE K25_1.F15 WITH K25_1.F15 - 1
             ENDCASE
             REPLACE K25_1.F16 WITH K25_1.F16 + 1 
	         SELECT K25
	         SET ORDER TO 4
	         SEEK KK
	         IF FOUND()
                SELECT K25 
                REPLACE K25.F16 WITH '2'  
                REPLACE F08 WITH 0
                REPLACE F10 WITH 0
                REPLACE F12 WITH 0
                REPLACE F20 WITH RSN_DSC+SPACE(2)+LEFT(F15,10)
                REPLACE F15 WITH ''
                REPLACE K25.F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	         ENDIF
	         =MESSAGEBOX('此發票號碼：'+K25.F07+'已作廢',0+48,'提示訊息視窗')
          ELSE
              DO FILE_IMPACT
              UNLOCK ALL
              RETURN
          ENDIF
     ENDIF                    
     THISFORM.GRID2.SETFOCUS
*!*	       THISFORM.REFRESH
  ENDPROC
************轉帳款
PROC BILL_BOTT.CLICK
  IF MESSAGEBOX('是否確認資料無誤可以轉入帳款?',4+32+256,'請確認') = 6	
  	 IF THISFORM.PAGEFRAME1.ACTIVEPAGE = 1 
  	    SELECT RECNO() FROM K25 WHERE K25.F03 = K25_3.F03 AND K25.F16 != '2' AND K25.F16 != '3' AND K25.F16 != '4' AND K25.F16 != '5' INTO ARRAY BK1              
        JJ1='' 
        IF _TALLY>0   
           FOR I = 1 TO ALEN(BK1)
           	   JJ1 = JJ1 + ALLTRIM(STR(BK1(I))) + ','
           ENDFOR    
           KK1 = STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'K25')
           LL1 = RLOCK(KK1,'K25')
        ELSE
           LL1 = .T.
        ENDIF  
       ********   
        IF LL1 = .T. 
           IF LEN(ALLTRIM(JJ1)) > 0 
	          SELECT  K25
		      FOR I = 1 TO ALEN(BK1)                      
		          GO BK1(I)  
		          IF K25.F16 != '2' AND K25.F16 != '3' AND K25.F16 != '4' AND K25.F16 != '5'
		             IF LEFT(K25.F01,1) = '2'  &&進項類  				                       
	                    SELECT K51
			            APPEND BLANK
			   	        REPLACE K51.F01 WITH K25.F07 
			  	        REPLACE K51.F02 WITH CTOD(CHK_STR+'/'+K25.F02 )
				        REPLACE K51.F03 WITH K25.F01 
				        REPLACE K51.F04 WITH K25.F04 
					    REPLACE K51.F05 WITH LEFT(ALLTRIM(K25.F15),10)
					    REPLACE K51.F06 WITH K25.F03 
					    REPLACE K51.F07 WITH K25.F12 
					    REPLACE K51.F08 WITH K25.F20 
				        REPLACE K51.F10 WITH K25.F12
				        REPLACE K51.F11 WITH IIF(SEEK(K25.F03,'D01'),D01.F04,IIF(SEEK(K25.F03,'E02'),E02.F04,''))
				        REPLACE K51.F12 WITH K25.F21 
				        REPLACE K51.F13 WITH K25.F22 
				        REPLACE K51.F14 WITH K25.F23
				        REPLACE K51.F15 WITH ACC_MODE(LEFT(K25.F01,1),K25.F03,K51.F02)			&&進銷項類別,對象編號,發票日期   				        		    				        
					    DO CASE			&&CDE_MODE(對象編號,進銷項,擷取資料代碼)
					       CASE CDE_MODE(K25.F03,'1','A') = '0'	&&現結
					       	    REPLACE K51.F16 WITH '現結'
					       CASE CDE_MODE(K25.F03,'1','A') = '1'	&&月結
					            REPLACE K51.F16 WITH '月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'1','C'))) + '天' 
					       CASE CDE_MODE(K25.F03,'1','A') = '2'	&&次月結
					            REPLACE K51.F16 WITH '次月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'1','C'))) + '天' 
					       CASE CDE_MODE(K25.F03,'1','A') = '3'	&&T/T
					            REPLACE K51.F16 WITH 'T/T ' + ALLTRIM(STR(CDE_MODE(K25.F03,'1','B'))) + '天'
					    ENDCASE
		        		REPLACE K51.F17 WITH CDE_MODE(K25.F03,'1','E')
	    				REPLACE K51.F18 WITH CDE_MODE(K25.F03,'1','E')
				        REPLACE K51.F19 WITH '2'
				        REPLACE K51.F20 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')					            
				        SELECT K25
				        REPLACE K25.F16 WITH IIF(K25.F16 = ' ','5','3')	
				        REPLACE K25.F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	                       
		             ELSE				&&銷項類  	
		                IF LEFT(K25.F15,2)<>'BE'                 
	                       SELECT K51
			               APPEND BLANK
			   	           REPLACE K51.F01 WITH K25.F07 
			  	           REPLACE K51.F02 WITH CTOD(CHK_STR+'/'+K25.F02 )
				           REPLACE K51.F03 WITH K25.F01 
				           REPLACE K51.F04 WITH K25.F04 
					       REPLACE K51.F05 WITH LEFT(ALLTRIM(K25.F15),10)
					       REPLACE K51.F06 WITH K25.F03 
					       REPLACE K51.F07 WITH K25.F12 
					       REPLACE K51.F08 WITH K25.F20 
				           REPLACE K51.F10 WITH K25.F12
				           REPLACE K51.F11 WITH IIF(SEEK(K25.F03,'C01'),C01.F05,'')
				           REPLACE K51.F12 WITH K25.F21 
				           REPLACE K51.F13 WITH K25.F22 
				           REPLACE K51.F14 WITH K25.F23
				           REPLACE K51.F15 WITH ACC_MODE(LEFT(K25.F01,1),K25.F03,K51.F02)			&&進銷項類別,對象編號,發票日期     				        		    				        
					       DO CASE			&&CDE_MODE(對象編號,進銷項,擷取資料代碼)
					          CASE CDE_MODE(K25.F03,'2','A') = '0'	&&現結
					       	       REPLACE K51.F16 WITH '現結'
					          CASE CDE_MODE(K25.F03,'2','A') = '1'	&&月結
					               REPLACE K51.F16 WITH '月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'2','C'))) + '天' 
					          CASE CDE_MODE(K25.F03,'2','A') = '2'	&&次月結
					               REPLACE K51.F16 WITH '次月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'2','C'))) + '天' 
					          CASE CDE_MODE(K25.F03,'2','A') = '3'	&&T/T
					               REPLACE K51.F16 WITH 'T/T ' + ALLTRIM(STR(CDE_MODE(K25.F03,'2','B'))) + '天'
					       ENDCASE
		        		   REPLACE K51.F17 WITH CDE_MODE(K25.F03,'2','E')
		        		   REPLACE K51.F18 WITH IIF(EMPTY(CDE_MODE(K25.F03,'2','F')),K51.F17,CDE_MODE(K25.F03,'2','F'))
				           REPLACE K51.F19 WITH '1'
				           REPLACE K51.F20 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')				            
				           SELECT K25
				           REPLACE K25.F16 WITH IIF(K25.F16=' ','5','3')
				           REPLACE K25.F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				        ENDIF
				     ENDIF       
			      ENDIF     
		      ENDFOR    
          ELSE
              =MESSAGEBOX('此單據已由別的工作站轉帳完成',0+64,'提示訊息視窗')
          ENDIF
	      THIS.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          UNLOCK ALL
          IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
             =MESSAGEBOX('此對象別：'+K51.F11+'已轉至立沖結餘明細帳中',0+48,'提示訊息視窗')
             THISFORM.GRID1.SETFOCUS
          ELSE
             THISFORM.GRID2.SETFOCUS
             THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
          ENDIF
          THISFORM.REFRESH
       ELSE
          DO FILE_IMPACT
          UNLOCK ALL
          RETURN
       ENDIF   
       UNLOCK ALL
       RELEASE ALL LIKE BK*  
    ELSE &&表身轉帳款(單筆轉)
  	   IF K25.F16 != '2' AND K25.F16 != '3' AND K25.F16 != '4' AND K25.F16 != '5' 
	      SELECT K25
	      IF RLOCK()
*!*			 REPLACE K25.F16 WITH IIF(K25.F16 = ' ','5','3')
             IF LEFT(K25.F01,1) = '2'  &&進項類 		          
		        SELECT K51
	          	APPEND BLANK
	          	REPLACE K51.F01 WITH K25.F07 
	          	REPLACE K51.F02 WITH CTOD(CHK_STR + '/' + K25.F02 ) 
	          	REPLACE K51.F03 WITH K25.F01 
	          	REPLACE K51.F04 WITH K25.F04 
	          	REPLACE K51.F05 WITH LEFT(ALLTRIM(K25.F15),10) 
	          	REPLACE K51.F06 WITH K25.F03 
	          	REPLACE K51.F07 WITH K25.F12
	          	REPLACE K51.F08 WITH K25.F20  
	          	REPLACE K51.F10 WITH K25.F12
	          	REPLACE K51.F11 WITH IIF(SEEK(K25.F03,'D01'),D01.F04,IIF(SEEK(K25.F03,'E02'),E02.F04,''))
			    REPLACE K51.F12 WITH K25.F21 
			    REPLACE K51.F13 WITH K25.F22 
			    REPLACE K51.F14 WITH K25.F23
			    REPLACE K51.F15 WITH ACC_MODE(LEFT(K25.F01,1),K25.F03,K51.F02)			&&進銷項類別,對象編號,發票日期     				        		    				        
*!*					REPLACE K51.F16 WITH IIF(CDE_MODE(K25.F03,'1','A') = '3','T/T ' + ALLTRIM(STR(IIF((CDE_MODE(K25.F03,'1','B') - 30) <= 0,0,CDE_MODE(K25.F03,'1','B') - 30))) + '天',BILL_MODE(CDE_MODE(K25.F03,'1','A')) + ALLTRIM(STR(CDE_MODE(K25.F03,'1','C'))) + '天')   &&,IIF(SEEK(K51.F06,'D01'),D01.F19,'')
			    DO CASE			&&CDE_MODE(對象編號,進銷項,擷取資料代碼)
			       CASE CDE_MODE(K25.F03,'1','A') = '0'	&&現結
			       	    REPLACE K51.F16 WITH '現結'
			       CASE CDE_MODE(K25.F03,'1','A') = '1'	&&月結
			            REPLACE K51.F16 WITH '月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'1','C'))) + '天' 
			       CASE CDE_MODE(K25.F03,'1','A') = '2'	&&次月結
			            REPLACE K51.F16 WITH '次月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'1','C'))) + '天' 
			       CASE CDE_MODE(K25.F03,'1','A') = '3'	&&T/T
			            REPLACE K51.F16 WITH 'T/T ' + ALLTRIM(STR(CDE_MODE(K25.F03,'1','B'))) + '天'
			    ENDCASE
		        REPLACE K51.F17 WITH CDE_MODE(K25.F03,'1','E')
*!*			    REPLACE K51.F18 WITH CDE_MODE(K25.F03,'1','E')
		        REPLACE K51.F19 WITH '2'
		        REPLACE K51.F20 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')			          
		        SELECT K25
		        REPLACE K25.F16 WITH IIF(K25.F16 = ' ','5','3')	
		        REPLACE K25.F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	                            
             ELSE 		          
		        SELECT K51
	          	APPEND BLANK
	          	REPLACE K51.F01 WITH K25.F07 
	          	REPLACE K51.F02 WITH CTOD(CHK_STR + '/' + K25.F02 ) 
	          	REPLACE K51.F03 WITH K25.F01 
	          	REPLACE K51.F04 WITH K25.F04 
	          	REPLACE K51.F05 WITH LEFT(ALLTRIM(K25.F15),10) 
	          	REPLACE K51.F06 WITH K25.F03 
	          	REPLACE K51.F07 WITH K25.F12
	          	REPLACE K51.F08 WITH K25.F20  
	          	REPLACE K51.F10 WITH K25.F12
	          	REPLACE K51.F11 WITH IIF(SEEK(K25.F03,'C01'),C01.F05,'')
			    REPLACE K51.F12 WITH K25.F21 
			    REPLACE K51.F13 WITH K25.F22 
			    REPLACE K51.F14 WITH K25.F23
			    REPLACE K51.F15 WITH ACC_MODE(LEFT(K25.F01,1),K25.F03,K51.F02)			&&進銷項類別,對象編號,發票日期  				        		    				        
*!*					REPLACE K51.F16 WITH IIF(CDE_MODE(K25.F03,'2','A') = '3','T/T ' + ALLTRIM(STR(IIF((CDE_MODE(K25.F03,'2','B') - 30) <= 0,0,CDE_MODE(K25.F03,'2','B') - 30))) + '天',BILL_MODE(CDE_MODE(K25.F03,'2','A')) + ALLTRIM(STR(CDE_MODE(K25.F03,'2','C'))) + '天')   &&,IIF(SEEK(K51.F06,'D01'),D01.F19,'')
			    DO CASE			&&CDE_MODE(對象編號,進銷項,擷取資料代碼)
			       CASE CDE_MODE(K25.F03,'2','A') = '0'	&&現結
			       	    REPLACE K51.F16 WITH '現結'
			       CASE CDE_MODE(K25.F03,'2','A') = '1'	&&月結
			            REPLACE K51.F16 WITH '月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'2','C'))) + '天' 
			       CASE CDE_MODE(K25.F03,'2','A') = '2'	&&次月結
			            REPLACE K51.F16 WITH '次月結,票期' + ALLTRIM(STR(CDE_MODE(K25.F03,'2','C'))) + '天' 
			       CASE CDE_MODE(K25.F03,'2','A') = '3'	&&T/T
			            REPLACE K51.F16 WITH 'T/T ' + ALLTRIM(STR(CDE_MODE(K25.F03,'2','B'))) + '天'			            
			    ENDCASE
		        REPLACE K51.F17 WITH CDE_MODE(K25.F03,'2','E')
		        REPLACE K51.F18 WITH IIF(EMPTY(CDE_MODE(K25.F03,'2','F')),K51.F17,CDE_MODE(K25.F03,'2','F'))
		        REPLACE K51.F19 WITH '1'
		        REPLACE K51.F20 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')			          
		        SELECT K25
		        REPLACE K25.F16 WITH IIF(K25.F16 = ' ','5','3')	
		        REPLACE K25.F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	  
		     ENDIF      
             =MESSAGEBOX('此發票號碼：'+K25.F07+'已轉至立沖結餘明細帳中',0+48,'提示訊息視窗')	
	         *THISFORM.REFRESH
             THISFORM.GRID2.SETFOCUS     			  		          	     
	      ELSE
	         DO FILE_IMPACT
	         UNLOCK ALL
	         RETURN
	      ENDIF 
	   ENDIF
     ENDIF          	  
  ELSE
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        THISFORM.GRID1.SETFOCUS
     ELSE
        THISFORM.GRID2.SETFOCUS
     ENDIF   	
  ENDIF	 
 ENDPROC

ENDDEFINE    
***********************************************列印程序
PROCEDURE PNT_PRC  
   SELE K25
   ANS_RANGE=CREATEOBJECT("ANS_RANGE")  
   ANS_RANGE.SHOW    
   IF FLG<>'1'
       =MESSAGEBOX('無此範圍資料',0+48,'警示')
   ENDIF   
   FLG='0'
ENDPROC               
***********************************************列印範圍選定
DEFINE CLASS ANS_RANGE AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION='請輸入列印資料範圍'
  TOP=INT_015*175
  LEFT=INT_015*230
  HEIGHT=INT_015*190
  WIDTH=INT_015*320
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_RANGE'
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*20,;
      TOP=INT_015*30,;
      NAME='LABEL1'
  ADD OBJECT LABEL2 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*130,;
      TOP=INT_015*30,;
      NAME='LABEL2'
  ADD OBJECT LABEL3 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*40,;
      TOP=INT_015*70,;
      NAME='LABEL3'    
  ADD OBJECT LABEL4 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*120,;
      TOP=INT_015*70,;
      NAME='LABEL4'          
  ADD OBJECT TEXT1 AS TEXTBOX WITH;
      WIDTH=INT_015*30,;
      TOP=INT_015*25,;
      LEFT=INT_015*70,;
      HEIGHT=INT_015*25,; 
      MAXLENGTH=2,; 
      NAME='TEXT1'
  ADD OBJECT TEXT2 AS TEXTBOX WITH;
      WIDTH=INT_015*55,;
      TOP=INT_015*25,;
      LEFT=INT_015*220,;
      HEIGHT=INT_015*25,; 
      MAXLENGTH=6,;        
      NAME='TEXT2'  
  ADD OBJECT TEXT3 AS TEXTBOX WITH;
      WIDTH=INT_015*30,;
      TOP=INT_015*65,;
      LEFT=INT_015*70,;
      HEIGHT=INT_015*25,; 
      MAXLENGTH=2,;        
      NAME='TEXT3'          
  ADD OBJECT TEXT4 AS TEXTBOX WITH;
      WIDTH=INT_015*30,;
      TOP=INT_015*65,;
      LEFT=INT_015*150,;
      HEIGHT=INT_015*25,; 
      MAXLENGTH=2,;        
      NAME='TEXT4'                
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*60,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*144,;  
      WIDTH=INT_015*80,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;             
      CAPTION='\<Y.執  行',;
      TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*200,;
      TOP=INT_015*144,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;             
      CAPTION='\<C.取  消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'
  PROCEDURE INIT 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
      THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')      
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')      
      DO CASE
            CASE AREA1='K25_1'        
		      THISFORM.LABEL1.CAPTION='發票字軌'
		      THISFORM.LABEL2.CAPTION='發票前六位號碼'   
		      THISFORM.LABEL3.CAPTION='序號'
		      THISFORM.LABEL4.CAPTION='∼'
		      THISFORM.TEXT2.INPUTMASK='999999'
		      THISFORM.TEXT3.INPUTMASK='99'
		      THISFORM.TEXT4.INPUTMASK='99'                                    
		      THISFORM.TEXT1.VALUE=LEFT(K25.F07,2)
		      THISFORM.TEXT2.VALUE=LEFT(RIGHT(K25.F07,8),6)
		      THISFORM.TEXT3.VALUE=IIF(VAL(RIGHT(K25.F07,2))>=0 .AND. VAL(RIGHT(K25.F07,2))<=49,'00','50')
		      THISFORM.TEXT4.VALUE=IIF(VAL(RIGHT(K25.F07,2))>=0 .AND. VAL(RIGHT(K25.F07,2))<=49,'49','99')
	    CASE AREA1='K25_3' 	 
	              THISFORM.LABEL1.CAPTION='起始對象'
		      THISFORM.LABEL2.CAPTION='截止對象'   
		      THISFORM.LABEL2.LEFT=INT_015*165
		      THISFORM.LABEL3.VISIBLE=.F.
		      THISFORM.LABEL4.VISIBLE=.F.
		      THISFORM.TEXT3.VISIBLE=.F.
		      THISFORM.TEXT4.VISIBLE=.F.
		      THISFORM.TEXT1.WIDTH=INT_015*55
		      THISFORM.TEXT2.WIDTH=INT_015*55
		      THISFORM.TEXT1.MAXLENGTH=5
		      THISFORM.TEXT2.MAXLENGTH=5                               
		      THISFORM.TEXT1.VALUE=K25_3.F03
		      THISFORM.TEXT2.VALUE=K25_3.F03      
     ENDCASE       
  ENDPROC    
  PROCEDURE CMND1.CLICK 
     DO CASE
            CASE AREA1='K25_1'   
		       IF MOD(VAL(THISFORM.TEXT3.VALUE),50)>0
			      =MESSAGEBOX('起始序號輸入錯誤!',0+48,'提示訊息視窗')
			      THISFORM.TEXT3.SETFOCUS
			      RETURN
		       ENDIF   
	      	       IF MOD(VAL(THISFORM.TEXT4.VALUE),50)<49
	                   =MESSAGEBOX('截止序號輸入錯誤!',0+48,'提示訊息視窗')
	       	           THISFORM.TEXT4.SETFOCUS
	       	           RETURN
	               ENDIF           
	     	       INV_NO_STAR=ALLTRIM(THISFORM.TEXT1.VALUE+THISFORM.TEXT2.VALUE+THISFORM.TEXT3.VALUE)
	     	       INV_NO_END=ALLTRIM(THISFORM.TEXT1.VALUE+THISFORM.TEXT2.VALUE+THISFORM.TEXT4.VALUE)
		       SELECT K25.F07,K25.F02,K25.F03,K25.F09,K25.F08,K25.F10,K25.F12,K25.F16,K25.F20;
		       FROM K25 WHERE K25.F07>=INV_NO_STAR .AND. K25.F07<=INV_NO_END;
		       ORDER BY K25.F07 NOWAIT
		       IF _TALLY >0              
			      REPORT FORM ALLTRIM(INT_116)+'K17A' TO PRINT PROMPT PREVIEW    
		              FLG='1'
		       ENDIF  
	      CASE AREA1='K25_3'    
	                 SELECT K24
	                 SET ORDER TO K242
		      	 CREATE CURSOR K25A;
			(F03 C(5),F05 C(8),F04 C(8),F07 C(10),F15 C(10),F02 C(2),F09 C(4),F12 N(15),F20 C(20),SUM_F12 N(15))
			SELECT K25.F03,K25.F04,K25.F07,K25.F15,K25.F02,K25.F09,K25.F12,K25.F20;
			FROM K25 WHERE  K25.F03>=THISFORM.TEXT1.VALUE .AND. K25.F03<=THISFORM.TEXT2.VALUE;
			ORDER BY K25.F03,K25.F02,K25.F07 INTO CURSOR K25B
			SELE K25B
			GO TOP
			POC=K25B.F03
			DO WHILE !EOF()
			       IF POC=K25B.F03
			            SELE K25A
			            APPEND BLANK
			            REPLACE  K25A.F03 WITH K25B.F03
			            REPLACE  K25A.F05 WITH IIF(LEFT(K25B.F03,1)='C',IIF(SEEK(K25B.F03,'C01'),C01.F05,''),;
			                                                 IIF(LEFT(K25B.F03,1)='V',IIF(SEEK(K25B.F03,'D01'),D01.F04,''),IIF(SEEK(K25B.F03,'E02'),E02.F04,'')))
			            REPLACE  K25A.F04 WITH K25B.F04
			            REPLACE  K25A.F07 WITH K25B.F07
			            REPLACE  K25A.F15 WITH LEFT(ALLTRIM(K25B.F15),10)
			            REPLACE  K25A.F02 WITH K25B.F02
			            REPLACE  K25A.F09 WITH IIF(K25B.F09='1','應稅',IIF(K25B.F09='2','零稅','免稅'))
			            REPLACE  K25A.F12 WITH K25B.F12
			            REPLACE  K25A.SUM_F12 WITH K25B.F12
			            REPLACE  K25A.F20 WITH K25B.F20
			       ELSE
			            SELE K25A
			            APPEND BLANK
			            REPLACE  K25A.F09 WITH '小計'			       
			            REPLACE  K25A.F12 WITH IIF(SEEK(POC,'K24'),K24.F05,0)
			            SELE K25A
			            APPEND BLANK
			            REPLACE  K25A.F03 WITH K25B.F03
			            REPLACE  K25A.F05 WITH IIF(LEFT(K25B.F03,1)='C',IIF(SEEK(K25B.F03,'C01'),C01.F05,''),;
			                                                 IIF(LEFT(K25B.F03,1)='V',IIF(SEEK(K25B.F03,'D01'),D01.F04,''),IIF(SEEK(K25B.F03,'E02'),E02.F04,'')))
			            REPLACE  K25A.F04 WITH K25B.F04
			            REPLACE  K25A.F07 WITH K25B.F07
			            REPLACE  K25A.F15 WITH LEFT(ALLTRIM(K25B.F15),10)
			            REPLACE  K25A.F02 WITH K25B.F02
			            REPLACE  K25A.F09 WITH IIF(K25B.F09='1','應稅',IIF(K25B.F09='2','零稅','免稅'))
			            REPLACE  K25A.F12 WITH K25B.F12
			            REPLACE  K25A.SUM_F12 WITH K25B.F12
			            REPLACE  K25A.F20 WITH K25B.F20			           
			       ENDIF
			       POC=K25B.F03
			       SELECT  K25B
			       SKIP   
			ENDDO
			SELE K25A
			APPEND BLANK
			REPLACE  K25A.F09 WITH '小計'		
			REPLACE  K25A.F12 WITH IIF(SEEK(POC,'K24'),K24.F05,0)	       
			GO TOP
		         IF _TALLY >0              
			       REPORT FORM ALLTRIM(INT_116)+'K17B' TO PRINT PROMPT PREVIEW   
		              FLG='1'
		        ENDIF  
		        SELECT K25B
		        USE		        
		        SELECT K25A
		        USE
	ENDCASE      
     	CLEAR  
       THISFORM.RELEASE                         
  ENDPROC
  PROCEDURE CMND2.CLICK
      FLG='1'   
      THISFORM.RELEASE
  ENDPROC      
****
 PROC CMND1.MOUSEENTER      
     LPARAMETERS nButton, nShift, nXCoord, nYCoord 
            THISFORM.CMND1.FORECOLOR=RGB(255,0,0)
            THISFORM.CMND1.TOP=INT_015*145
            THISFORM.CMND1.LEFT=INT_015*61
 ENDPROC     
 PROC CMND1.MOUSELEAVE      
     LPARAMETERS nButton, nShift, nXCoord, nYCoord 
            THISFORM.CMND1.FORECOLOR=RGB(0,0,0)  
            THISFORM.CMND1.TOP=INT_015*144
            THISFORM.CMND1.LEFT=INT_015*60                  
 ENDPROC  
 PROC CMND2.MOUSEENTER      
     LPARAMETERS nButton, nShift, nXCoord, nYCoord 
            THISFORM.CMND2.FORECOLOR=RGB(255,0,0)
            THISFORM.CMND2.TOP=INT_015*145
            THISFORM.CMND2.LEFT=INT_015*201
 ENDPROC     
 PROC CMND2.MOUSELEAVE      
     LPARAMETERS nButton, nShift, nXCoord, nYCoord 
            THISFORM.CMND2.FORECOLOR=RGB(0,0,0)  
            THISFORM.CMND2.TOP=INT_015*144
            THISFORM.CMND2.LEFT=INT_015*200                  
 ENDPROC     
ENDDEFINE           
***************************************************特殊輸入欄位設定-----------客戶或廠商
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
	 IF LEFT(K25_1.F01,1)='3'
	      HKLY='C01'
	 ELSE
	      HKLY='D01'
	 ENDIF      
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM &HKLY INTO CURSOR VDR ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM &HKLY INTO CURSOR VDR ORDER BY F01 
       ENDIF          
       VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
       VDR_SEEK.SHOW    
       THIS.VALUE=FLG
       THIS.REFRESH
       FLG='0'        
    ELSE
       IF LEN(THIS.VALUE)=4
          SELECT F02,F01,F04 FROM SPLY INTO CURSOR VDR ORDER BY F01 WHERE F01=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF
    ENDIF    
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'SPLY'),SPLY.F04,'')  
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=ICASE(SEEK(THIS.VALUE,'C01'),C01.F10,SEEK(THIS.VALUE,'D01'),D01.F06,SEEK(THIS.VALUE,'E02'),E02.F13,'')    
  ENDPROC
ENDDEFINE
**********************************************************************銷售金額
DEFINE CLASS TXTF08 AS TEXTBOX
       FONTSIZE=INT_015*9
       READONLY=.T.
       PROCEDURE INTERACTIVECHANGE
*          IF MOD(VAL(RIGHT(K25_1.F01,1)),2)<>0
             IF THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE=1
                THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=ROUND(THIS.VALUE*INT_002/100,IIF(LEFT(K25_1.F01,1)='2',INT_068,INT_069))
                THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
             ELSE
                THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=0
                THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=THIS.VALUE
             ENDIF                
*          ENDIF      
          THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=TRANSFORM(ROUND(THIS.VALUE/THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE,3),'999999999999.999')
          THISFORM.PAGEFRAME1.PAGE2.TXTF10.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF12.REFRESH              
       ENDPROC
ENDDEFINE
**********************************************************************發票總額
DEFINE CLASS TXTF12 AS TEXTBOX
       FONTSIZE=INT_015*9
       READONLY=.T.
       PROCEDURE INTERACTIVECHANGE
*          IF MOD(VAL(RIGHT(K25_1.F01,1)),2)=0
             IF THISFORM.PAGEFRAME1.PAGE2.TAX_TYPE.VALUE=1
                THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=ROUND(THIS.VALUE/(1+INT_002/100),IIF(LEFT(K25_1.F01,1)='2',INT_068,INT_069))
                THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=THIS.VALUE-THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
             ELSE
                THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=THIS.VALUE
                THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=0
             ENDIF
*          ENDIF
         THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=TRANSFORM(ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE/THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE,3),'999999999999.999')
          THISFORM.PAGEFRAME1.PAGE2.TXTF10.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.REFRESH          
       ENDPROC
ENDDEFINE
**********************************************************************匯率
DEFINE CLASS TXTF22 AS TEXTBOX
       FONTSIZE=INT_015*9
       READONLY=.T.
       PROCEDURE INTERACTIVECHANGE
          THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=TRANSFORM(ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE/THIS.VALUE,3),'999999999999.9999')       
       ENDPROC
ENDDEFINE
*********************************************************************發票種類
DEFINE CLASS INV_TYPE AS COMBOBOX
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  ROWSOURCETYPE=1
  STYLE=2
  NAME='INV_TYPE'
  PROCEDURE INIT
     WITH THIS   
          .ADDITEM('21.進項三聯式. 電子計算機')
          .ADDITEM('22.進項載有稅額之其他憑證')          
          .ADDITEM('23.三聯式. 進貨退出或折讓')          
          .ADDITEM('24.二聯式. 進貨退出或折讓')                    
          .ADDITEM('25.進項三聯式收銀機發票  ')                              
          .ADDITEM('31.銷項三聯式. 電子計算機')                                        
          .ADDITEM('32.銷項二聯式. 收銀機發票')                                                  
          .ADDITEM('33.三聯式. 銷貨退回或折讓')                                                            
          .ADDITEM('34.二聯式. 銷貨退回或折讓')
          .ADDITEM('35.銷項三聯式收銀機發票  ')                                                                                                              
          .VALUE=1
     ENDWITH   
  ENDPROC
  PROC INTERACTIVECHANGE
       THISFORM.PAGEFRAME1.PAGE1.LBLJLK1.CAPTION=SUBSTR(THIS.DISPLAYVALUE,4,22)
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=LEFT(THIS.DISPLAYVALUE,2)       
  ENDPROC     
*!*	  PROCEDURE INTERACTIVECHANGE
*!*	     THISFORM.PAGEFRAME1.PAGE1.TXTF22.VALUE=LEFT(THIS.DISPLAYVALUE,2)
*!*	*     THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(THIS.VALUE=1,'三聯式','二聯式')
*!*	     THISFORM.PAGEFRAME1.PAGE1.TXTF22.REFRESH
*!*	     IF THIS.VALUE=1
*!*	        THISFORM.TAX_TYPE.VISIBLE=.T. 
*!*	     ENDIF
*!*	  ENDPROC
ENDDEFINE  
*********************************************************************課稅別
DEFINE CLASS TAX_TYPE AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*28
  LEFT=INT_015*95
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*50
  ROWSOURCETYPE=1
  VALUE=1
  STYLE=2
  NAME='TAX_TYPE'
  PROCEDURE INIT
     WITH THIS 
          .ADDITEM('應稅')
          .ADDITEM('零稅')          
          .ADDITEM('免稅')          
     ENDWITH   
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
     IF THIS.VALUE<>1 AND THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE='32'
        THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.T.
     ELSE
        THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.F.
        THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.LBLF091.CAPTION=''
     ENDIF
     IF THIS.VALUE=1
        IF MOD(VAL(RIGHT(K25_1.F01,1)),2)=0
           THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE/(1+INT_002/100),IIF(LEFT(K25_1.F01,1)='2',INT_068,INT_069))
           THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE-THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE        
        ELSE
           THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE*INT_002/100,IIF(LEFT(K25_1.F01,1)='2',INT_068,INT_069))
           THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
        ENDIF   
     ELSE
        IF MOD(VAL(RIGHT(K25_1.F01,1)),2)=0
           THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE           
        ELSE
           THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
        ENDIF        
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=0
     ENDIF
  ENDPROC
ENDDEFINE  
*********************************************************************是否經海關
DEFINE CLASS CUS_TYPE AS OPTIONGROUP
  HEIGHT=INT_015*25
  TOP=INT_015*28
  LEFT=INT_015*140
  HEIGHT=INT_015*25
  WIDTH=INT_015*150
  FONTSIZE=INT_015*9
  BUTTONCOUNT=2
  VALUE=1
  NAME='CUS_TYPE'
  OPTION1.CAPTION='不經海關'
  OPTION1.TOP=INT_015*5
  OPTION1.WIDTH=INT_015*72
  OPTION1.LEFT=INT_015*5
  OPTION1.NAME='OPTION1'
  OPTION2.CAPTION='須經海關'
  OPTION2.TOP=INT_015*5
  OPTION2.WIDTH=INT_015*72
  OPTION2.LEFT=INT_015*79
  OPTION2.NAME='OPTION2'    
ENDDEFINE  
********************************************************************
DEFINE CLASS BTTF06_YES AS CommandButton
       HEIGHT=INT_015*25
       WIDTH=INT_015*40
       TOP=INT_015*53
       LEFT=INT_015*215
       FONTSIZE=INT_015*9
       NAME='BTTF06_YES'
       CAPTION='\<Z.確定'
       PROCEDURE CLICK
          SELECT K25
          REPLACE F05 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VALUE))
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
          THISFORM.PAGEFRAME1.PAGE2.BTTF06_NO.CLICK
       ENDPROC
ENDDEFINE
DEFINE CLASS BTTF06_NO AS CommandButton
       HEIGHT=INT_015*25
       WIDTH=INT_015*40
       TOP=INT_015*53
       LEFT=INT_015*257
       FONTSIZE=INT_015*9
       NAME='BTTF06_NO'
       CAPTION='\<Q.取消'
       PROCEDURE CLICK
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.T.
          THISFORM.PAGEFRAME1.PAGE2.TXTF06.READONLY=.T.          
          THIS.Visible=.F.
          THISFORM.PAGEFRAME1.PAGE2.BTTF06_YES.VISIBLE=.F.
          THISFORM.PAGEFRAME1.PAGE2.CUS_TYPE.VISIBLE=.F.          
          THISFORM.BTTF06.VISIBLE=.T.
          THISFORM.GRID2.SETFOCUS          
       ENDPROC
ENDDEFINE
******************************************************************交易項目
DEFINE CLASS MTR_TYPE AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*53
  LEFT=INT_015*436
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*50
  ROWSOURCETYPE=1
  VALUE=1
  STYLE=2
  NAME='MTR_TYPE'
  PROCEDURE INIT
     WITH THIS 
          .ADDITEM('商品')
          .ADDITEM('製品')          
          .ADDITEM('原料')          
     ENDWITH   
  ENDPROC
ENDDEFINE 
***************************************************幣別設定
DEFINE CLASS CRCY AS COMBOBOX
  VISIBLE=.F.
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  HEIGHT=INT_015*25  
  WIDTH=INT_015*84
  FONTSIZE=INT_015*9
  ROWSOURCETYPE=1
  STYLE=2
  NAME='CRCY'
  PROCEDURE INIT
    SELECT C00
    GO TOP 
    DO WHILE .NOT. EOF()
       L=4-LEN(ALLTRIM(F01))
       THIS.ADDITEM(F01)
       SKIP
    ENDDO
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=THIS.DISPLAYVALUE
    THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE=IIF(SEEK(THIS.DISPLAYVALUE,'C00'),C00.F02,1)
    THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=ALLTRIM(TRANSFORM(ROUND(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE/THISFORM.PAGEFRAME1.PAGE2.TXTF22.VALUE,3),'999999999999.999'))
    THISFORM.PAGEFRAME1.PAGE2.TXTF21.REFRESH
    THISFORM.PAGEFRAME1.PAGE2.TXTF22.REFRESH
  ENDPROC
ENDDEFINE  
*************************************************************發票明細  
DEFINE CLASS INV_CNPT AS FORM
  AUTOCENTER=.T.
  CAPTION='發票號碼內容明細'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*370
  WIDTH=INT_015*730
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  MAXBUTTON=.F.
  MINBUTTON=.F.  
*!*	  MOVABLE=.F.  
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='INV_CNPT'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*138,;
      LEFT=INT_015*270
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*730,;      
      HEIGHT=INT_015*340,;  
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*18,;          
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=8,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;      
      COLUMN7.NAME='COLUMN7',;
      COLUMN8.NAME='COLUMN8'      
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*443,;
      TOP=INT_015*343,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此畫面!快速鍵->ALT+X' 
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='INV' 
         THISFORM.CAPTION=THISFORM.CAPTION+'    發票號碼:'+K25.F07
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='INV'         
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='異動單號'
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='INV.異動單號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80         
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='訂單編號'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='INV.訂單編號'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='品        號'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='INV.品號'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*149
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='數        量'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='INV.數量'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*100         
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='單        價'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='INV.單價'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80                 
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='幣別'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='INV.幣別'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*30                  
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='匯        率'
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='INV.匯率'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*75
         THISFORM.GRID1.COLUMN8.HEADER1.CAPTION=INT_011+'小計'
         THISFORM.GRID1.COLUMN8.CONTROLSOURCE='INV.小計'
         THISFORM.GRID1.COLUMN8.WIDTH=INT_015*100                                             
         THISFORM.GRID1.SETFOCUS
	IF THISFORM.GRID1.ACTIVEROW<>0
	   THISFORM.GRID1.AFTERROWCOLCHANGE  
	ENDIF          
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME  
      ENDPROC 
      PROCEDURE CMND2.CLICK
          THISFORM.RELEASE
      ENDPROC      
ENDDEFINE        
*************************************************************多重憑證單號明細  
DEFINE CLASS K2F_LIST AS FORM
*!*	  AUTOCENTER=.T.
  TOP=INT_015*130
  LEFT=INT_015*160 
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*295
  WIDTH=INT_015*470
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.  
*!*	  MOVABLE=.F.  
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  CAPTION = '多重憑證單號明細'
  NAME='K2F_LIST'
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOSIZE=.T.           
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*55,;
      LEFT=INT_015*370  
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      TOP=INT_015*90,;
      WIDTH=INT_015*470,;      
      HEIGHT=INT_015*200,;  
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*18,;          
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=4,;  
      RECORDSOURCE='K2F_TEMP',;           
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
 ADD OBJECT LABEL1 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*5,;
      TOP=INT_015*11,;
      WIDTH=INT_015*50,;
      CAPTION='發票號碼'    
 ADD OBJECT TXTF1 AS TEXTBOX  WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*60,;
      TOP=INT_015*7,;
      WIDTH=INT_015*95,;
      HEIGHT=INT_015*25,;  
      NAME='TXTF1'   
 ADD OBJECT LABEL4 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*166,;
      TOP=INT_015*11,;
      WIDTH=INT_015*50,;
      CAPTION='對  象  別'    
 ADD OBJECT TXTF4 AS TEXTBOX  WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*221,;
      TOP=INT_015*7,;
      WIDTH=INT_015*65,;
      HEIGHT=INT_015*25,;  
      NAME='TXTF4'                  
 ADD OBJECT LABEL2 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*5,;
      TOP=INT_015*38,;
      WIDTH=INT_015*50,;
      CAPTION='憑證單號'     
 ADD OBJECT TXTF2 AS TXTF2 WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*60,;
      TOP=INT_015*33,;
      WIDTH=INT_015*95,;
      HEIGHT=INT_015*25,;
	  BACKCOLOR=RGB(255,255,100),;
	  MOUSEPOINTER=99,;
	  MOUSEICON='BMPS\harrow.cur',;
      MAXLENGTH=10,;    
      NAME='TXTF2'    
 ADD OBJECT LABEL3 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*166,;
      TOP=INT_015*38,;
      WIDTH=INT_015*50,;
      CAPTION='憑證類別'     
 ADD OBJECT TXTF3 AS TEXTBOX WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*221,;
      TOP=INT_015*33,;
      WIDTH=INT_015*65,;
      HEIGHT=INT_015*25,;      
      MAXLENGTH=4,;    
      NAME='TXTF3'    
 ADD OBJECT COMBOBOX3 AS COMBOBOX WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*221,;
      TOP=INT_015*33,;
      WIDTH=INT_015*65,;
      HEIGHT=INT_015*25,;      
      MAXLENGTH=4,; 
      BOUNDCOLUMN=1,;
	  STYLE=2,;        
      NAME='COMBOBOX3'         
 ADD OBJECT LABEL5 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*5,;
      TOP=INT_015*65,;
      WIDTH=INT_015*50,;
      CAPTION='備註說明'     
 ADD OBJECT TXTF5 AS TEXTBOX WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*60,;
      TOP=INT_015*60,;
      WIDTH=INT_015*227,;
      HEIGHT=INT_015*25,;      
      MAXLENGTH=100,;    
      NAME='TXTF5'   
 ADD OBJECT LABEL99 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*300,;
      TOP=INT_015*38,;
      WIDTH=INT_015*50,;
      CAPTION='安全資料'  
 ADD OBJECT LABEL991 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*355,;
      TOP=INT_015*38,;
      AUTOSIZE=.T.,;
      CAPTION=''        
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*297,;
      TOP=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<N.新增',;
      TOOLTIPTEXT='新增資料!快速鍵->ALT+N' 
      NAME='CMND1'  
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*339,;
      TOP=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<E.修改',;
      TOOLTIPTEXT='修改此筆資料!快速鍵->ALT+E' 
      NAME='CMND2'  
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      LEFT=INT_015*381,;
      TOP=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<D.刪除',;
      TOOLTIPTEXT='刪除此筆資料!快速鍵->ALT+D' 
      NAME='CMND3'                                                          
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      LEFT=INT_015*423,;
      TOP=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此畫面!快速鍵->ALT+X' 
      NAME='CMND4'  
  PROC COMBOBOX3.INIT   
  	 WITH THIS 
  	   .ADDITEM('商品')
  	   .ADDITEM('製品')
  	   .ADDITEM('原料')
  	   .VALUE = 1
  	 ENDWITH
  ENDPROC                        
  PROCEDURE INIT 
 	  AREA1='K2F_TEMP' 
 	  THISFORM.KEY_LIST.VISIBLE=.F.
  	  THISFORM.SHRGROUP.VISIBLE=.F.
  	  THISFORM.COMBOBOX3.VISIBLE=.F.
      THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
      THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
      THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
      THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')    
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMBOBOX')   
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON') 
      THISFORM.SETALL('MOVABLE',.F.,'COLUMN')        
      THISFORM.GRID1.READONLY=.T.       
      THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
      THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
      THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='憑證單號'
      THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K2F_TEMP.F02'
      THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
      THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='憑證類別'
      THISFORM.GRID1.COLUMN2.CONTROLSOURCE="ICASE(K2F_TEMP.F03 = 'A','商品',K2F_TEMP.F03 = 'B','製品',K2F_TEMP.F03 = 'C','原料','')"
      THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
      THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='備註說明'
      THISFORM.GRID1.COLUMN3.CONTROLSOURCE='K2F_TEMP.F05'
      THISFORM.GRID1.COLUMN3.WIDTH=INT_015*200
      THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='安全資料'
      THISFORM.GRID1.COLUMN4.CONTROLSOURCE='K2F_TEMP.F99'
      THISFORM.GRID1.COLUMN4.WIDTH=INT_015*100         
      THISFORM.GRID1.SETFOCUS
	  IF THISFORM.GRID1.ACTIVEROW<>0
	     THISFORM.GRID1.AFTERROWCOLCHANGE  
	  ENDIF  
	  THISFORM.TXTF1.VALUE = K25.F07
      THISFORM.TXTF4.VALUE = ICASE(SEEK(K25.F03,'C01'),C01.F05,SEEK(K25.F03,'D01'),D01.F04,SEEK(K25.F03,'E02'),E02.F04,'')	  
      THISFORM.CMND2.ENABLED = IIF(EMPTY(THISFORM.TXTF2.VALUE),.F.,.T.)
      THISFORM.CMND3.ENABLED = IIF(EMPTY(THISFORM.TXTF2.VALUE),.F.,.T.)	  
  ENDPROC	        
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       SELECT K2F_TEMP
       THISFORM.TXTF2.VALUE=K2F_TEMP.F02
       THISFORM.TXTF3.VALUE=ICASE(K2F_TEMP.F03 = 'A','商品',K2F_TEMP.F03 = 'B','製品',K2F_TEMP.F03 = 'C','原料','')
       THISFORM.COMBOBOX3.VALUE=ICASE(K2F_TEMP.F03 = 'A',1,K2F_TEMP.F03 = 'B',2,K2F_TEMP.F03 = 'C',3,1)
       THISFORM.TXTF5.VALUE=K2F_TEMP.F05
       THISFORM.LABEL991.CAPTION=K2F_TEMP.F99   
       THISFORM.CMND2.ENABLED = IIF(EMPTY(THISFORM.TXTF2.VALUE),.F.,.T.)
       THISFORM.CMND3.ENABLED = IIF(EMPTY(THISFORM.TXTF2.VALUE),.F.,.T.)
  ENDPROC
************    
  PROCEDURE CMND1.CLICK 
      THISFORM.SHRGROUP.ENABLED=.T.
      THISFORM.SHRGROUP.VISIBLE=.T.
      THISFORM.SHRGROUP.SHURE2_BOTT.ENABLED=.F.
      THISFORM.SHRGROUP.SHURE2_BOTT.VISIBLE=.F.
      THISFORM.SHRGROUP.SHURE1_BOTT.ENABLED=.T.
      THISFORM.SHRGROUP.SHURE1_BOTT.VISIBLE=.T.
      THISFORM.SHRGROUP.ABANDON_BOTT.VISIBLE=.F.
      THISFORM.SHRGROUP.FINISH_BOTT.ENABLED=.T.
      THISFORM.SHRGROUP.FINISH_BOTT.VISIBLE=.T.  
      THISFORM.GRID1.ENABLED=.F.
      THISFORM.CMND1.ENABLED=.F.
      THISFORM.CMND2.ENABLED=.F.
      THISFORM.CMND3.ENABLED=.F.      
      THISFORM.CMND4.ENABLED=.F.
      THISFORM.TXTF3.VISIBLE=.F.
      THISFORM.COMBOBOX3.VISIBLE=.T.
      THISFORM.SETALL('READONLY',.F.,'TEXTBOX')
      THISFORM.TXTF1.READONLY=.T.
      THISFORM.TXTF2.READONLY=.F.
      THISFORM.TXTF4.READONLY=.T.
      THISFORM.TXTF2.VALUE=''
      THISFORM.TXTF3.VALUE=''
      THISFORM.COMBOBOX3.VALUE=1
      THISFORM.TXTF5.VALUE=''
      THISFORM.LABEL991.CAPTION=''
      THISFORM.TXTF2.SETFOCUS
  ENDPROC    
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK  
      IF EMPTY(THISFORM.TXTF2.VALUE) = .T.
         =MESSAGEBOX('憑證單號不得空白',0+64,'提示訊息視窗')
         THISFORM.TXTF2.SETFOCUS
         RETURN
      ENDIF
      IF SEEK(THISFORM.TXTF2.VALUE,'K2F_TEMP') = .T.
         =MESSAGEBOX('此憑證單號已存在',0+64,'提示訊息視窗')
         THISFORM.TXTF2.SETFOCUS
         RETURN
      ENDIF      
      SELECT K2F_TEMP
      APPEND BLANK 
      LOCK()
      IF RLOCK()
         REPLACE K2F_TEMP.F02 WITH THISFORM.TXTF2.VALUE
         REPLACE K2F_TEMP.F03 WITH CHR(64 + THISFORM.COMBOBOX3.VALUE)
         REPLACE K2F_TEMP.F05 WITH THISFORM.TXTF5.VALUE
         REPLACE K2F_TEMP.F99 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
      ENDIF  
      UNLOCK 
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
  ENDPROC  
************ 
  PROCEDURE CMND2.CLICK
      THISFORM.SHRGROUP.ENABLED=.T.
      THISFORM.SHRGROUP.VISIBLE=.T.
      THISFORM.SHRGROUP.SHURE1_BOTT.ENABLED=.F.
      THISFORM.SHRGROUP.SHURE1_BOTT.VISIBLE=.F.
      THISFORM.SHRGROUP.SHURE2_BOTT.ENABLED=.T.
      THISFORM.SHRGROUP.SHURE2_BOTT.VISIBLE=.T.
      THISFORM.SHRGROUP.ABANDON_BOTT.VISIBLE=.T.
      THISFORM.SHRGROUP.FINISH_BOTT.ENABLED=.F.
      THISFORM.SHRGROUP.FINISH_BOTT.VISIBLE=.F.
      THISFORM.SETALL('READONLY',.F.,'TEXTBOX')
      THISFORM.GRID1.ENABLED=.F.
      THISFORM.CMND1.ENABLED=.F.
      THISFORM.CMND2.ENABLED=.F.
      THISFORM.CMND3.ENABLED=.F.
      THISFORM.CMND4.ENABLED=.F.
      THISFORM.TXTF1.READONLY=.T.
      THISFORM.TXTF2.READONLY=.T.
      THISFORM.TXTF4.READONLY=.T.
      THISFORM.TXTF3.VISIBLE=.F.
      THISFORM.COMBOBOX3.VISIBLE=.T.
      THISFORM.COMBOBOX3.VALUE=ICASE(K2F_TEMP.F03 = 'A',1,K2F_TEMP.F03 = 'B',2,K2F_TEMP.F03 = 'C',3,1)
      THISFORM.COMBOBOX3.SETFOCUS  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK  
      SELECT K2F_TEMP
      LOCK()
      IF RLOCK()
         REPLACE K2F_TEMP.F03 WITH CHR(64 + THISFORM.COMBOBOX3.VALUE)
         REPLACE K2F_TEMP.F05 WITH THISFORM.TXTF5.VALUE
         REPLACE K2F_TEMP.F99 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')         
      ELSE
         DO file_impact
         RETURN     
      ENDIF    
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK  
  ENDPROC    
************   
  PROCEDURE CMND3.CLICK
      IF MESSAGEBOX('此作業將一併刪除相關單據之發票號碼、類別與課稅別,是否確定要刪除此筆資料',4 + 32 + 256,'請確認') = 6 
         SELECT K2F_TEMP
         LOCK()
         IF RLOCK()
            SELECT K2F
            SEEK K25.F07 + K2F_TEMP.F02 + DTOS(CTOD(ALLTRIM(CHK_STR) + '/01'))
            IF FOUND()
               ****刪除相關單據之發票號碼,類別,稅別與K17發票管理一致 
               VOA_NO(ALLTRIM(K25.F07),ALLTRIM(K25.F03),ALLTRIM(K25.F01),ALLTRIM(K25.F09),ALLTRIM(K2F.F02),SPACE(1))	&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用)  
               SELECT K2F
               DELETE 
            ENDIF
            SELECT K2F_TEMP
            DELETE         
         ELSE
            DO file_impact
            RETURN 
         ENDIF
      ENDIF 
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 
  ENDPROC 
************     
  PROCEDURE CMND4.CLICK	&&離開後儲存
      ***儲存至憑證單號明細檔
      TKC = .F.
      SELECT K2F_TEMP 
      GO TOP
      DO WHILE !EOF()
         SELECT K2F
         SEEK K25.F07 + K2F_TEMP.F02 + DTOS(CTOD(ALLTRIM(CHK_STR) + '/01'))
         IF FOUND()
		    SELECT K2F
		    REPLACE K2F.F01 WITH K25.F07
		    REPLACE K2F.F02 WITH K2F_TEMP.F02
		    REPLACE K2F.F03 WITH K2F_TEMP.F03
		    REPLACE K2F.F04 WITH CTOD(ALLTRIM(CHK_STR) + '/01')
		    REPLACE K2F.F05 WITH K2F_TEMP.F05
		    REPLACE K2F.F99 WITH K2F_TEMP.F99
         ELSE
		    SELECT K2F
		    APPEND BLANK 
		    REPLACE K2F.F01 WITH K25.F07
		    REPLACE K2F.F02 WITH K2F_TEMP.F02
		    REPLACE K2F.F03 WITH K2F_TEMP.F03
		    REPLACE K2F.F04 WITH CTOD(ALLTRIM(CHK_STR) + '/01')
		    REPLACE K2F.F05 WITH K2F_TEMP.F05
		    REPLACE K2F.F99 WITH K2F_TEMP.F99
		    TKC = .T.
         ENDIF
         SELECT K2F_TEMP 
         SKIP
      ENDDO
      ***若表身憑證單號若為空白則帶入一筆資料到表身
      IF EMPTY(K25.F15) = .T. OR LEN(ALLTRIM(K25.F15)) < 10
         SELECT K2F
         SEEK K25.F07 + K2F.F02 + DTOS(CTOD(ALLTRIM(CHK_STR) + '/01'))
         IF FOUND()
         	SELECT K25
            REPLACE K25.F15 WITH K2F.F02 + ICASE(K2F.F03 = 'A','商品',K2F.F03 = 'B','製品',K2F.F03 = 'C','原料','')
            VOA_NO(ALLTRIM(K25.F07),ALLTRIM(K25.F03),ALLTRIM(K25.F01),ALLTRIM(K25.F09),SPACE(1),SPACE(1))		&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用) 
            ***再判斷課稅別然後帶入應收付帳款中
      		DO CASE
         	   CASE LEFT(K25.F01,1) = '3' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 AND K25.F09 = '1' AND !EMPTY(K25.F03)
                    SELECT  C13
	                APPEND BLANK
	                REPLACE C13.F01 WITH CTOD(ALLTRIM(CHK_STR) + '/' + K25.F02)
	                REPLACE C13.F02 WITH LEFT(K25.F15,10)
	                REPLACE C13.F03 WITH K25.F03
	                REPLACE C13.F04 WITH '稅額'
	                REPLACE C13.F05 WITH '發票:' + K25.F07
	                REPLACE C13.F06 WITH 1 
	                REPLACE C13.F07 WITH K25.F10
	                REPLACE C13.F08 WITH K25.F10 
	                REPLACE C13.F09 WITH IIF(SEEK(K25.F03,'C01'),C01.F15,'1')
	                REPLACE C13.F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	                REPLACE C13.F13 WITH INT_011
	                REPLACE C13.F14 WITH 1
	                REPLACE C13.F19 WITH IIF(SEEK(K25.F03,'C01'),C01.F18,'')  
               CASE LEFT(K25.F01,1)='2' AND MOD(VAL(RIGHT(K25.F01,1)),2) <> 0 AND K25.F09 = '1' AND !EMPTY(K25.F03) 
                    DO CASE 
                       CASE LEFT(K25.F15,2)$'BMBR'
                            DEP = 'E20'
		               CASE LEFT(K25.F15,2)$'BABB' AND (K25.F03<>INT_117 AND K25.F03<>INT_118)
		                    DEP = 'D19'
		               CASE LEFT(K25.F15,2)='PB' OR (LEFT(K25.F15,2)='BB' AND (K25.F03=INT_117 OR K25.F03=INT_118))
		               		DEP='P19'             
		               OTHERWISE
		                    DEP = ''            
		            ENDCASE 
             		IF !EMPTY(DEP)
                        SELECT &DEP
		                APPEND BLANK
		                REPLACE &DEP..F01 WITH CTOD(ALLTRIM(CHK_STR) + '/' + K25.F02)
		                REPLACE &DEP..F03 WITH K25.F03
		                REPLACE &DEP..F04 WITH '稅額'
		                REPLACE &DEP..F05 WITH '發票:' + K25.F07
		                REPLACE &DEP..F06 WITH 1 
		                REPLACE &DEP..F07 WITH K25.F10
		                REPLACE &DEP..F08 WITH K25.F10 
		                REPLACE &DEP..F09 WITH IIF(SEEK(K25.F03,'D01'),D01.F13,IIF(SEEK(K25.F03,'E02'),E02.F10,'1'))
		                REPLACE &DEP..F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
		                REPLACE &DEP..F13 WITH INT_011
		                REPLACE &DEP..F14 WITH 1
              		ENDIF
*!*			       CASE K25.F01='22' AND K25.F09='1' AND !EMPTY(K25.F03) AND LEFT(K25.F15,1)='B' AND LEN(ALLTRIM(K25.F15)) = 10
*!*	                    DO CASE 
*!*	                       CASE LEFT(K25.F15,2)$'BMBR'
*!*	                            DEP = 'E20'
*!*			               CASE LEFT(K25.F15,2)$'BABB' AND (K25.F03<>INT_117 AND K25.F03<>INT_118)
*!*			                    DEP = 'D19'
*!*			               OTHERWISE
*!*			                    DEP = 'P19'            
*!*			            ENDCASE 
*!*	             		IF !EMPTY(DEP)
*!*	                        SELECT &DEP
*!*			                REPLACE &DEP..F19 WITH '02' FOR ALLTRIM(&DEP..F02) = LEFT(ALLTRIM(K25.F15),10)
*!*			            ENDIF    
		    ENDCASE
		    SELECT K2F
            DELETE 
         ENDIF
      ENDIF
      ****修改各項單據之發票號碼,類別,稅別與K17發票管理一致 
      IF TKC = .T.
         IF MESSAGEBOX('是否要將所列憑證單號之相關單據發票號碼、類別與課稅別與此筆發票資料相同?',4 + 32 + 256,'請確認') = 6       
            IF VOA_NO(ALLTRIM(K25.F07),ALLTRIM(K25.F03),ALLTRIM(K25.F01),ALLTRIM(K25.F09),SPACE(1),SPACE(1)) = .F.	&&發票號碼,對象編號,發票類別,稅別,憑證單號(判斷刪除),憑證單號(非K2F.DBF使用) 
               =MESSAGEBOX('修改作業發生錯誤請洽系統管理人員',0+48,'提示訊息視窗')
            ENDIF
         ENDIF   
      ENDIF  
      SELECT K2F_TEMP
      USE            
      THISFORM.RELEASE
 ENDPROC 
*************   
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK  
      THISFORM.GRID1.ENABLED=.T.
      THISFORM.CMND4.ENABLED=.T.
      THISFORM.TXTF3.VISIBLE=.T.
      THISFORM.COMBOBOX3.VISIBLE=.F.
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.       
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
      THISFORM.TXTF2.READONLY=.T.
      THISFORM.GRID1.SETFOCUS
      IF THISFORM.GRID1.ACTIVEROW=0
         THISFORM.CMND2.ENABLED=.F.
         THISFORM.CMND3.ENABLED=.F.      
         THISFORM.TXTF2.VALUE=''
         THISFORM.TXTF3.VALUE=''
         THISFORM.TXTF5.VALUE=''
         THISFORM.LABEL991.CAPTION=''
      	 THISFORM.TXTF2.SETFOCUS  
	  ELSE
      	 THISFORM.CMND2.ENABLED=.T.
     	 THISFORM.CMND3.ENABLED=.T.	  
         THISFORM.TXTF2.VALUE=K2F_TEMP.F02
         THISFORM.TXTF3.VALUE=ICASE(K2F_TEMP.F03 = 'A','商品',K2F_TEMP.F03 = 'B','製品',K2F_TEMP.F03 = 'C','原料','')
         THISFORM.COMBOBOX3.VALUE=ICASE(K2F_TEMP.F03 = 'A',1,K2F_TEMP.F03 = 'B',2,K2F_TEMP.F03 = 'C',3,1)
         THISFORM.TXTF5.VALUE=K2F_TEMP.F05
         THISFORM.LABEL991.CAPTION=K2F_TEMP.F99  	        	    
      ENDIF
      THISFORM.CMND1.ENABLED=.T.
      UNLOCK ALL
  ENDPROC 
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK  
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 	
  ENDPROC     
ENDDEFINE  
***    
DEFINE CLASS TXTF2 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=10
  FONTSIZE=INT_015*9 
  PROCEDURE INTERACTIVECHANGE 
    IF AT('?',ALLTRIM(THIS.VALUE))>0
       THIS.DBLCLICK
    ENDIF
  ENDPROC
  *****
  PROCEDURE DBLCLICK 
    IF THISFORM.SHRGROUP.VISIBLE = .T. AND THIS.READONLY = .F.
  	   DO CASE
  	      CASE K25_1.F01 = '21' OR K25_1.F01 = '22' OR K25_1.F01 = '25' 	&&進項類
			   B02 = 'B02' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			   IF !USED('&B02')
			      SELECT  0
			      USE (B02) ALIAS B02
			   ELSE
			      SELECT  B02
			   ENDIF
			   SET ORDER TO 1  	
     		   SELECT B02.F01 AS F01,B02.F08 AS F02 FROM B02 WHERE B02.F07 = K25.F03 GROUP BY B02.F01 ORDER BY B02.F01 INTO CURSOR NEW_TEMP READWRITE 		   
     		   SELECT B02
     		   USE	    
  	      CASE K25_1.F01 = '23' OR K25_1.F01 = '24' 						&&進項退貨類
			   B03 = 'B03' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			   IF !USED('&B03')
			      SELECT  0
			      USE (B03) ALIAS B03
			   ELSE
			      SELECT  B03
			   ENDIF
			   SET ORDER TO 1  	
     		   SELECT B03.F01 AS F01,B03.F08 AS F02 FROM B03 WHERE B03.F07 = K25.F03 GROUP BY B03.F01 ORDER BY B03.F01 INTO CURSOR NEW_TEMP READWRITE     		   
     		   SELECT B03
     		   USE	  	    
  	      CASE K25_1.F01 = '31' OR K25_1.F01 = '32' OR K25_1.F01 = '35' 	&&銷項類
			   B04 = 'B04' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			   IF !USED('&B04')
			      SELECT  0
			      USE (B04) ALIAS B04
			   ELSE
			      SELECT  B04
			   ENDIF
			   SET ORDER TO 1  	
     		   SELECT B04.F01 AS F01,B04.F12 AS F02 FROM B04 WHERE B04.F06 = K25.F03 GROUP BY B04.F01 ORDER BY B04.F01 INTO CURSOR NEW_TEMP READWRITE     		   
     		   SELECT B04
     		   USE		   	    
  	      CASE K25_1.F01 = '33' OR K25_1.F01 = '34' 						&&銷項退貨
			   B05 = 'B05' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
			   IF !USED('&B05')
			      SELECT  0
			      USE (B05) ALIAS B05
			   ELSE
			      SELECT  B05
			   ENDIF
			   SET ORDER TO 1  	
     		   SELECT B05.F01 AS F01,B05.F07 AS F02 FROM B05 WHERE B05.F10 = K25.F03 GROUP BY B05.F01 ORDER BY B05.F01 INTO CURSOR NEW_TEMP READWRITE   		   
     		   SELECT B05
     		   USE	  	    
  	   ENDCASE
       SELECT NEW_TEMP
       INDE ON NEW_TEMP.F01 TAG NEW_TEMP1
       SET ORDER TO NEW_TEMP1	
       SELECT K2F_TEMP	 
       GO TOP
       DO WHILE !EOF()
          SELECT NEW_TEMP
          SEEK K2F_TEMP.F02
          IF FOUND()
             SELECT NEW_TEMP
             DELETE 
          ENDIF
          SELECT K2F_TEMP
          SKIP
       ENDDO	
       SELECT K2F.F02 FROM K2F WHERE DTOS(K2F.F04) = DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')) ORDER BY K2F.F02 INTO CURSOR K2FA
       SELECT K2FA	 
       GO TOP
       DO WHILE !EOF()
          SELECT NEW_TEMP
     	  SEEK K2FA.F02
     	  IF FOUND()
     	     SELECT NEW_TEMP
     	     DELETE 
     	  ENDIF
     	  SELECT K2FA
     	  SKIP
       ENDDO   
       SELECT K2FA
       USE    	   
       SELECT NEW_TEMP
       SEEK LEFT(K25.F15,10)
       IF FOUND()
     	  SELECT NEW_TEMP
     	  DELETE 
       ENDIF
  	   GO TOP
       GET_F02 = ''
       GET_F05 = ''
	   K2FNO_LIST = CREATEOBJECT("K2FNO_LIST")  
	   K2FNO_LIST.SHOW 
	   THISFORM.TXTF2.VALUE = GET_F02
	   THISFORM.TXTF5.VALUE = GET_F05	  
    ENDIF
  ENDPROC
ENDDEFINE  
*************************************************************憑證單號明細  
DEFINE CLASS K2FNO_LIST AS FORM
*!*	  AUTOCENTER=.T.
  TOP=INT_015*150
  LEFT=INT_015*230 
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*295
  WIDTH=INT_015*305
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.  
*!*	  MOVABLE=.F.  
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='K2FNO_LIST'
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      WIDTH=INT_015*175  
  ADD OBJECT GRIDD1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      TOP=INT_015*32,;
      WIDTH=INT_015*305,;      
      HEIGHT=INT_015*260,;  
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*18,;          
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=2,;  
      RECORDSOURCE='NEW_TEMP',;           
      NAME='GRIDD1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'    
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*212,;
      TOP=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.選取',;
      TOOLTIPTEXT='選取此筆資料!快速鍵->ALT+C' 
      NAME='CMND1'                          
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*255,;
      TOP=INT_015*5,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.離開',;
      TOOLTIPTEXT='取消此畫面!快速鍵->ALT+A' 
      NAME='CMND2'                
  PROCEDURE INIT 
      THISFORM.CAPTION = '憑證單號明細資料    發票號碼：' + K25.F07   
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON') 
      THISFORM.SETALL('MOVABLE',.F.,'COLUMN')        
      THISFORM.GRIDD1.READONLY=.T.       
      THISFORM.GRIDD1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
      THISFORM.GRIDD1.SETALL('FONTSIZE',INT_015*9,'HEADER')
      THISFORM.GRIDD1.COLUMN1.HEADER1.CAPTION='憑證單號'
      THISFORM.GRIDD1.COLUMN1.CONTROLSOURCE='NEW_TEMP.F01'
      THISFORM.GRIDD1.COLUMN1.WIDTH=INT_015*80
      THISFORM.GRIDD1.COLUMN2.HEADER1.CAPTION='備註說明'
      THISFORM.GRIDD1.COLUMN2.CONTROLSOURCE='NEW_TEMP.F02'
      THISFORM.GRIDD1.COLUMN2.WIDTH=INT_015*190      
      THISFORM.GRIDD1.SETFOCUS
	  IF THISFORM.GRIDD1.ACTIVEROW<>0
	     THISFORM.GRIDD1.AFTERROWCOLCHANGE  
	  ENDIF  
	  ***
	  DO CASE
	     CASE K25_1.F01 = '21' OR K25_1.F01 = '22' OR K25_1.F01 = '25' 	&&進項類
		  	  DO CASE
			     CASE LEFT(K25.F03,1) = 'V'
			          THIS.KEY_LIST.VALUE = 1          
			     CASE LEFT(K25.F03,1) = 'W'
			          THIS.KEY_LIST.VALUE = 3	     
			  ENDCASE
*!*				  ***德通外購使用
*!*				  IF K25.F03 = INT_117 OR K25.F03 = 'V0100' OR K25.F03 = 'V0109' OR K25.F03 = 'V0136' OR K25.F03 = 'V0170' OR K25.F03 = INT_118	
*!*				     THIS.KEY_LIST.VALUE = 2
*!*				  ENDIF 
			  THIS.KEY_LIST.INTERACTIVECHANGE
		 CASE K25_1.F01 = '23' OR K25_1.F01 = '24' 						&&進項退貨類
		  	  DO CASE
			     CASE LEFT(K25.F03,1) = 'V'
			          THIS.KEY_LIST.VALUE = 1          
			     CASE LEFT(K25.F03,1) = 'W'
			          THIS.KEY_LIST.VALUE = 2	     
			  ENDCASE	
			  THIS.KEY_LIST.INTERACTIVECHANGE	 
	     OTHERWISE
	          THIS.KEY_LIST.VALUE = 1  		
	  ENDCASE
  ENDPROC 
  PROC KEY_LIST.INIT 
       WITH THIS 
       		DO CASE 
        	   CASE K25_1.F01 = '21' OR K25_1.F01 = '22' OR K25_1.F01 = '25' 	&&進項類
           			.ADDITEM('依內購進貨單排列')
           			.ADDITEM('依外購進貨單排列')
           			.ADDITEM('依委外進貨單排列')
           	   CASE K25_1.F01 = '23' OR K25_1.F01 = '24' 						&&進項退貨類
           			.ADDITEM('依進貨退出單排列')
           			.ADDITEM('依委外進貨退出單排列')        	   
           	   CASE K25_1.F01 = '31' OR K25_1.F01 = '32' OR K25_1.F01 = '35' 	&&銷項類
           			.ADDITEM('依進貨單排列')           	   
           	   CASE K25_1.F01 = '33' OR K25_1.F01 = '34' 						&&銷項退貨類 
           			.ADDITEM('依進貨退出單排列')     
           	 ENDCASE
       ENDWITH           
  ENDPROC   
  PROCEDURE KEY_LIST.INTERACTIVECHANGE
	  THISFORM.GRIDD1.RECORDSOURCE=''
	  SELECT NEW_TEMP
	  USE 
   	  DO CASE 
    	 CASE K25_1.F01 = '21' OR K25_1.F01 = '22' OR K25_1.F01 = '25' 	&&進項類
       	      IF THIS.VALUE = 1		&&內購進貨單
				 IF USED('B02')
				    SELECT B02
				    USE
				 ENDIF					 
				 B02 = 'B02' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
				 IF !USED('&B02')
				    SELECT  0
				    USE (B02) ALIAS B02
				 ELSE
				    SELECT B02
				 ENDIF
				 SET ORDER TO 1  	
		     	 SELECT B02.F01 AS F01,B02.F08 AS F02 FROM B02 WHERE B02.F07 = K25.F03 GROUP BY B02.F01 ORDER BY B02.F01 INTO CURSOR NEW_TEMP READWRITE  		     	 
		     	 SELECT B02 
		     	 USE	           			   
		      ENDIF	  
       		  IF THIS.VALUE = 2		&&外購進貨單  
				 IF USED('P12')
				    SELECT P12
				    USE
				 ENDIF
				 P12 = 'P12' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
				 IF !USED('&P12')
				    SELECT  0
				    USE (P12) ALIAS P12
				 ELSE
				    SELECT P12
				 ENDIF
				 SET ORDER TO 1  	
		     	 SELECT P12.F01 AS F01,P12.F21 AS F02 FROM P12 WHERE P12.F07 = K25.F03 GROUP BY P12.F01 ORDER BY P12.F01 INTO CURSOR NEW_TEMP READWRITE 		     	 
		     	 SELECT P12
		     	 USE	           			   
		      ENDIF 	 
       		  IF THIS.VALUE = 3		&&委外進貨單 
				 IF USED('B07')
				    SELECT B07
				    USE
				 ENDIF				 
				 B07 = 'B07' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
				 IF !USED('&B07')
				    SELECT  0
				    USE (B07) ALIAS B07
				 ELSE
				    SELECT  B07
				 ENDIF
				 SET ORDER TO 1  	
		     	 SELECT B07.F01 AS F01,B07.F21 AS F02 FROM B07 WHERE B07.F07 = K25.F03 GROUP BY B07.F01 ORDER BY B07.F01 INTO CURSOR NEW_TEMP READWRITE 		     	 
		     	 SELECT B07
		     	 USE	           			   
       		  ENDIF	
       	 CASE K25_1.F01 = '23' OR K25_1.F01 = '24' 						&&進項退貨類
       		  IF THIS.VALUE = 1		&&進貨退出單
				 IF USED('B03')
				    SELECT B03
				    USE
				 ENDIF					 
				 B03 = 'B03' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
				 IF !USED('&B03')
				    SELECT  0
				    USE (B03) ALIAS B03
				 ELSE
				    SELECT  B03
				 ENDIF
				 SET ORDER TO 1  	
		     	 SELECT B03.F01 AS F01,B05.F21 AS F02 FROM B03 WHERE B03.F07 = K25.F03 GROUP BY B03.F01 ORDER BY B03.F01 INTO CURSOR NEW_TEMP READWRITE 
		         SELECT B03
		         USE	       			   
		      ENDIF   
       		  IF THIS.VALUE = 2 		&&委外進貨退出單
       		     IF USED('B56')
       		        SELECT B56
       		        USE
       		     ENDIF
       		     B56='B56' + LEFT(DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')),6)
       		     IF !USED('&B56')
       		        SELECT 0
       		        USE (B56) ALIAS B56
       		     ELSE
       		        SELECT B56
       		     ENDIF
       		     SET ORDER TO 1   
		     	 SELECT B56.F01 AS F01,B56.F21 AS F02 FROM B56 WHERE B56.F07 = K25.F03 GROUP BY B56.F01 ORDER BY B56.F01 INTO CURSOR NEW_TEMP READWRITE 
		         SELECT B56
		         USE	       			   
       		  ENDIF     
       ENDCASE
       ***
 	   SELECT NEW_TEMP
 	   INDE ON NEW_TEMP.F01 TAG NEW_TEMP1
 	   SET ORDER TO NEW_TEMP1	
 	   SELECT K2F_TEMP	 
 	   GO TOP
 	   DO WHILE !EOF()
 	      SELECT NEW_TEMP
 	      SEEK K2F_TEMP.F02
 	      IF FOUND()
 	         SELECT NEW_TEMP
 	         DELETE 
 	      ENDIF
 	      SELECT K2F_TEMP
 	      SKIP
 	   ENDDO	
 	   SELECT K2F.F02 FROM K2F WHERE DTOS(K2F.F04) = DTOS(CTOD(ALLTRIM(CHK_STR) + '/01')) ORDER BY K2F.F02 INTO CURSOR K2FA
 	   SELECT K2FA	 
 	   GO TOP
 	   DO WHILE !EOF()
 	      SELECT NEW_TEMP
 	      SEEK K2FA.F02
 	      IF FOUND()
 	         SELECT NEW_TEMP
 	         DELETE 
 	      ENDIF
 	      SELECT K2FA
 	      SKIP
 	   ENDDO   
 	   SELECT K2FA
 	   USE      
       SELECT NEW_TEMP
       SEEK LEFT(K25.F15,10)
       IF FOUND()
          SELECT NEW_TEMP
          DELETE 
       ENDIF
       GO TOP
	   GET_F02 = NEW_TEMP.F01 
	   GET_F05 = NEW_TEMP.F02         
       THISFORM.GRIDD1.RECORDSOURCE='NEW_TEMP' 
       THISFORM.GRIDD1.SETFOCUS       	          	   
  ENDPROC
  ****       
************  
  PROCEDURE CMND1.CLICK  
      SELECT NEW_TEMP
	  GET_F02 = NEW_TEMP.F01 
	  GET_F05 = NEW_TEMP.F02       
      USE  
      THISFORM.RELEASE
  ENDPROC    
  PROCEDURE CMND2.CLICK
      GET_F02 = ''
      GET_F05 = ''  
      SELECT NEW_TEMP
      USE            
      THISFORM.RELEASE
  ENDPROC 
ENDDEFINE         
************************************************發票類別     
FUNCTION BILL
     PARA JUK
     JO=''
     DO CASE
        CASE JUK='21'
             JO='進項三聯式. 電子計算機'
        CASE JUK='22'
             JO='進項載有稅額之其他憑證'
        CASE JUK='23'
             JO='三聯式. 進貨退出或折讓'
        CASE JUK='24'
             JO='二聯式. 進貨退出或折讓'
        CASE JUK='25'  
             JO='進項三聯式收銀機發票  '   
        CASE JUK='31'  
             JO='銷項三聯式. 電子計算機'           
        CASE JUK='32'  
             JO='銷項二聯式. 收銀機發票'   
        CASE JUK='33'  
             JO='三聯式. 銷貨退回或折讓'   
        CASE JUK='34'  
             JO='二聯式. 銷貨退回或折讓'   
        CASE JUK='35'  
             JO='銷項三聯式收銀機發票  '
     ENDCASE
     RETURN JO   
************************************************客戶結帳方式   
FUNCTION BILL_MODE
     PARA JUKK
     JOO=''
     DO CASE
        CASE JUKK='0'
             JOO='現結,票期'
        CASE JUKK='1'
             JOO='月結,票期'
        CASE JUKK='2'
             JOO='次月結,票期'
        CASE JUKK='3'
             JOO='T/T'
     ENDCASE
     RETURN JOO
************************************************對象之帳款收付款方式  
FUNCTION CDE_MODE
     PARA CDE1,CDE2,CDE3			&&CDE1:對象編號,CDE2:進銷項(1:進項,2:銷項),CDE3:擷取資料代碼(A:結帳方式,B:T/T之天數,C:票期天數,D:請款日,E:業務/採購 人員編號,F:業助編號,G:公司資本)
     DO CASE
        CASE CDE3 = 'A'
             CDE = '0'
        CASE CDE3 = 'B' OR CDE3 = 'C' OR CDE3 = 'G'
             CDE = 0 
        CASE CDE3 = 'D'
             CDE = '00'
        CASE CDE3 = 'E' OR CDE3 = 'F'
             CDE = ''
     ENDCASE  
     IF CDE2 = '1'	&&進項
		SELECT D01
		SET ORDER TO D011
		SEEK CDE1
		IF FOUND()
		   DO CASE
		      CASE CDE3 = 'A'		
		           CDE = D01.F13
		      CASE CDE3 = 'B' 
		      	   CDE = IIF(D01.F36 = 0,0,D01.F36)
		      CASE CDE3 = 'C' 
		           CDE = D01.F37
		      CASE CDE3 = 'D'
		           CDE = PADL(ALLTRIM(STR(D01.F38)),2,'0')
		      CASE CDE3 = 'E' 
		           CDE = D01.F39
		      CASE CDE3 = 'F'
		     	   CDE = ''
		      CASE CDE3 = 'G'
		           CDE = 0
		   ENDCASE 		   
		ELSE
		   SELECT E02
		   SET ORDER TO E021
           SEEK CDE1
           IF FOUND()
			  DO CASE
			     CASE CDE3 = 'A'		
			          CDE = E02.F10
			     CASE CDE3 = 'B' 
			     	  CDE = IIF(E02.F36 = 0,0,E02.F36)
			     CASE CDE3 = 'C' 
			          CDE = E02.F37
			     CASE CDE3 = 'D'
			          CDE = PADL(ALLTRIM(STR(E02.F38)),2,'0')
			     CASE CDE3 = 'E' 
			          CDE = E02.F39
			     CASE CDE3 = 'F'
			          CDE = ''
			     CASE CDE3 = 'G'
			          CDE = 0
			  ENDCASE 	
           ENDIF     
        ENDIF         
     ELSE			&&銷項
        SELECT C01
        SET ORDER TO C011
        SEEK CDE1
        IF FOUND()
		   DO CASE
		      CASE CDE3 = 'A'		
		           CDE = C01.F15
		      CASE CDE3 = 'B' 
		      	   CDE = IIF(C01.F36 = 0,0,C01.F36)
		      CASE CDE3 = 'C' 
		           CDE = C01.F37
		      CASE CDE3 = 'D'
		           CDE = PADL(ALLTRIM(STR(C01.F38)),2,'0')
		      CASE CDE3 = 'E' 
		           CDE = IIF(ALLTRIM(INT_209) = 'A',C01.F18,IIF(EMPTY(C01.F33),C01.F18,C01.F33))
		      CASE CDE3 = 'F'
		     	   CDE = C01.F23
		      CASE CDE3 = 'G'
		           CDE = C01.F35
		   ENDCASE
        ENDIF       
     ENDIF
     RETURN CDE
************************************************轉入帳款  
FUNCTION ACC_MODE
     PARA ACC1,ACC2,ACC3		&&ACC1:進銷項類別,ACC2:對象編號,ACC3:發票日期

          APL_DATE=0   &&請款日
          
     ACC = CTOD('')
     YEAR_NO = 0
     MON_NO = 0
     IF ACC1 = '2'		&&進項類      	
     	DO CASE
		   CASE CDE_MODE(ACC2,'1','A') ='0'  &&現結 				
*!*					IF CDE_MODE(ACC2,'1','D') > RIGHT(OMT(ACC3),2)
				   APL_DATE=VAL(CDE_MODE(ACC2,'1','D'))
				   ACC = OMT(ACC3)
*!*					ELSE
*!*					   ACC = IIF(INT_012=1,ALLTRIM(STR(YEAR(ACC3)-1911))+SUBSTR(DTOC(ACC3),3,4),LEFT(dtoc(ACC3),6)) + CDE_MODE(ACC2,'1','D')
*!*					ENDIF			
		   CASE CDE_MODE(ACC2,'1','A') = '1'   &&月結(多加1個月)    
				IF MONTH(ACC3) + 1>12
				   YEAR_NO = YEAR(ACC3) + 1
				   MON_NO = 1
				ELSE
				   YEAR_NO = YEAR(ACC3) 
				   MON_NO = MONTH(ACC3) + 1           	     
				ENDIF
                  APL_DATE=VAL(CDE_MODE(ACC2,'1','D'))

                   ACC = OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/' + CDE_MODE(ACC2,'1','D')))&&找到該月最後一天(文字)
		   CASE CDE_MODE(ACC2,'1','A') = '2'  &&次月結(多加2個月)    
				IF MONTH(ACC3) + 2 >12
				   YEAR_NO = YEAR(ACC3) + 1
				   MON_NO = (MONTH(ACC3) + 2)%12
				ELSE
				   YEAR_NO = YEAR(ACC3) 
				   MON_NO = MONTH(ACC3) + 2
				ENDIF
                   APL_DATE=VAL(CDE_MODE(ACC2,'1','D'))
                   ACC = OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/' + CDE_MODE(ACC2,'1','D')))&&找到該月最後一天(文字)
		   CASE CDE_MODE(ACC2,'1','A') = '3'   &&T/T(從次月的1號開始算起)   
                 APL_DATE=VAL(CDE_MODE(ACC2,'1','D'))
                 TT_DAY=CTOD(OMT(ACC3))+CDE_MODE(ACC2,'1','B')  &&T/T收款日
                 ACC=OMT(TT_DAY)		   
*!*		            IF (MONTH(ACC3) + 1) > 12	&&判斷次月是否大於12
*!*		               YEAR_NO = YEAR(ACC3) + INT((MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30)) /12)                       
*!*		               MON_NO = MONTH(CTOD(ALLTRIM(STR(YEAR(ACC3))) + '/' + PADL(ALLTRIM(STR(MOD((MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30)),12))),2,'0') + '/01'))
*!*		            ELSE
*!*		               IF (MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30)) > 12	&&判斷次月 + T/T天數 是否大於12
*!*		                  YEAR_NO = YEAR(ACC3) + INT((MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30)) /12)
*!*		               ELSE
*!*		                  YEAR_NO = YEAR(ACC3) 
*!*		               ENDIF
*!*					   IF (MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30)) <= 12 
*!*		                  MON_NO = MONTH(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30))),2,'0') + '/01'))
*!*		               ELSE
*!*		                  MON_NO = MONTH(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MOD(MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'1','B') / 30),12))),2,'0') + '/01'))     
*!*		               ENDIF
*!*		            ENDIF	            
*!*		                                 
*!*	                ***判斷月份         
*!*	                IF CDE_MODE(ACC2,'1','D') > RIGHT(OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/01')),2)
*!*		               ACC = OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/01'))
*!*	                ELSE
*!*	                   ACC = ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/' + CDE_MODE(ACC2,'1','D')
*!*	                ENDIF
     				    	   
     	ENDCASE
     ELSE				&&銷項類       		
        DO CASE					
           CASE CDE_MODE(ACC2,'2','A') = '0'  &&現結
*!*	                IF CDE_MODE(ACC2,'2','D') > RIGHT(OMT(ACC3),2)
                    APL_DATE=VAL(CDE_MODE(ACC2,'2','D'))
                    ACC = OMT(ACC3)
*!*	                ELSE
*!*	                   ACC = IIF(INT_012=1,ALLTRIM(STR(YEAR(ACC3)-1911))+SUBSTR(DTOC(ACC3),3,4),LEFT(dtoc(ACC3),6)) + CDE_MODE(ACC2,'2','D')           
*!*	                ENDIF
           CASE CDE_MODE(ACC2,'2','A') = '1'   &&月結 (多加1個月)  
                IF MONTH(ACC3) + 1 > 12
                   YEAR_NO = YEAR(ACC3) + 1
                   MON_NO = 1
                ELSE
                   YEAR_NO = YEAR(ACC3) 
                   MON_NO = MONTH(ACC3) + 1           	     
                ENDIF    
                   APL_DATE=VAL(CDE_MODE(ACC2,'2','D'))
                   TT_DAY=CTOD(OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/' + CDE_MODE(ACC2,'2','D'))))+CDE_MODE(ACC2,'2','C')
                   ACC = OMT(TT_DAY)&&找到該月最後一天(文字)  
                                             
           CASE CDE_MODE(ACC2,'2','A') = '2'  &&次月結(多加2個月)    
                IF MONTH(ACC3) + 2 > 12 
                   YEAR_NO = YEAR(ACC3) + 1
                   MON_NO =(MONTH(ACC3) + 2 )%12
                ELSE
                   YEAR_NO = YEAR(ACC3) 
                   MON_NO = MONTH(ACC3) + 2
                ENDIF                             
                   APL_DATE=VAL(CDE_MODE(ACC2,'2','D'))
                   TT_DAY=CTOD(OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/' + CDE_MODE(ACC2,'2','D'))))+CDE_MODE(ACC2,'2','C')
                   ACC = OMT(TT_DAY)&&找到該月最後一天(文字)    
           CASE CDE_MODE(ACC2,'2','A') = '3'   &&原T/T(從次月的1號開始算起),現改為出貨當天算起    
                 APL_DATE=VAL(CDE_MODE(ACC2,'2','D'))
*!*	                 TT_DAY=CTOD(OMT(ACC3))+CDE_MODE(ACC2,'2','B')  &&T/T收款日(月底最後一天開始加天數)
                 TT_DAY=ACC3+CDE_MODE(ACC2,'2','B')  &&T/T收款日(直接江出貨日加天數)    
                 ACC=OMT(TT_DAY)
 
*!*		            IF (MONTH(ACC3) + 1) > 12	&&判斷次月是否大於12
*!*		               YEAR_NO = YEAR(ACC3) + INT((MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30)) /12)                       
*!*		               MON_NO = MONTH(CTOD(ALLTRIM(STR(YEAR(ACC3))) + '/' + PADL(ALLTRIM(STR(MOD((MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30)),12))),2,'0') + '/01'))
*!*		            ELSE
*!*		               IF (MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30)) > 12	&&判斷次月 + T/T天數 是否大於12
*!*		                  YEAR_NO = YEAR(ACC3) + INT((MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30)) /12)
*!*		               ELSE
*!*		                  YEAR_NO = YEAR(ACC3) 
*!*		               ENDIF
*!*					   IF (MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30)) <= 12 
*!*		                  MON_NO = MONTH(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30))),2,'0') + '/01'))
*!*		               ELSE
*!*		                  MON_NO = MONTH(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MOD(MONTH(ACC3) + 1 + INT(CDE_MODE(ACC2,'2','B') / 30),12))),2,'0') + '/01'))     
*!*		               ENDIF
*!*		            ENDIF		                        
*!*	                IF CDE_MODE(ACC2,'2','D') > RIGHT(OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/01')),2)
*!*		               ACC = OMT(CTOD(ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/01'))
*!*	                ELSE
*!*	                   ACC = ALLTRIM(STR(YEAR_NO)) + '/' + PADL(ALLTRIM(STR(MON_NO)),2,'0') +'/' + CDE_MODE(ACC2,'2','D')
*!*	                ENDIF
   
     	ENDCASE	
     ENDIF
     RETURN CTOD(ALLTRIM(ACC))+APL_DATE  &&先不以請款日作本月或次月的分隔天
*!*	     RETURN CTOD(ALLTRIM(ACC))+IIF(APL_DATE<=10,APL_DATE,IIF(APL_DATE-VAL(RIGHT(ALLTRIM(ACC),2))<0,APL_DATE-VAL(RIGHT(ALLTRIM(ACC),2)),0))  
************************************************各項單據之發票號碼,類別,課稅別之新增修改刪除
FUNCTION VOA_NO
     PARA VOA1,VOA2,VOA3,VOA4,VOAC,VOANO		&&VOA1:發票號碼,VOA2:對象編號,VOA3:發票類別,VOA4:稅別,VOAC:憑證單號(判斷刪除),VOANO:憑證單號(非K2F.DBF使用)   
     TRY   
        SELECT K2F.F02 FROM K2F WHERE K2F.F01 = VOA1 AND IIF(EMPTY(VOAC) = .F.,K2F.F02 = VOAC,!EMPTY(K2F.F02)) ORDER BY K2F.F02 INTO CURSOR K2FZ READWRITE 
        IF EMPTY(VOAC) = .T. AND EMPTY(VOANO) = .F.
           SELECT K2FZ 
           APPEND BLANK 
           REPLACE K2FZ.F02 WITH VOANO          
        ENDIF
        SELECT K2FZ
        GO TOP
        DO WHILE !EOF()
           ****B02.內購進貨單
           IF LEFT(K2FZ.F02,2) = 'BA'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 		&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))						&&檔名之月份
     	      B02 ='B02' + S1 + S2  
	          IF FILE(B02+'.DBF') = .T.
	             IF USED('&B02')
	                SELECT  B02
	             ELSE
	                SELECT  0  
	                USE (B02) ALIA B02
	             ENDIF
	             SET ORDER TO 1
                 SELECT B02
                 SEEK K2FZ.F02
                 IF FOUND() AND B02.F10 = '2' AND B02.F07 = VOA2	&&需已過帳,對象編號相同
	                SELECT RECNO() FROM B02 WHERE B02.F01 = K2FZ.F02 AND B02.F10='2' AND B02.F07 = VOA2 INTO ARRAY BK2  
		            JJ2 = ''                
	                IF _TALLY > 0   
	                   FOR I = 1 TO ALEN(BK2)
	                       JJ2 = JJ2 + ALLTRIM(STR(BK2(I))) + ','
		               ENDFOR    
		               KK2 = STUFF(JJ2,RAT(',',JJ2,1),1,'')              
		               RLOCK(KK2,'B02')
		               LL2 = RLOCK(KK2,'B02')
		            ELSE
		               LL2 = .T.   
		            ENDIF  
		            IF LL2 = .T. AND LEN(ALLTRIM(JJ2)) > 0 
		               FOR I= 1 TO ALEN(BK2)
		                   SELECT B02
		                   GO BK2(I)  
		                   REPLACE B02.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE B02.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE B02.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別
		               ENDFOR 
		               SELECT D19
		               SET ORDER TO 4
		               SEEK B02.F01
		               IF FOUND()
		                  DO WHILE F02=B02.F01
		                     REPLACE F20 WITH B02.F20
		                     REPLACE F19 WITH ICASE(B02.F23='2','00',B02.F23='3','09',B02.F23='1' AND B02.F22='21','03',B02.F23='1' AND B02.F22='22','02','06')
		                     SKIP
		                  ENDDO
		               ENDIF		               
		            ENDIF    
                 ENDIF
                 SELECT B02
                 USE       
	          ENDIF     	          
           ENDIF       
           ****B03.進貨退出單
           IF LEFT(K2FZ.F02,2) = 'BB'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 	&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))					&&檔名之月份
     	      B03 ='B03' + S1 + S2  
	          IF FILE(B03+'.DBF') = .T.
	             IF USED('&B03')
	                SELECT  B03
	             ELSE
	                SELECT  0  
	                USE (B03) ALIA B03
	             ENDIF
	             SET ORDER TO 1
                 SELECT B03
                 SEEK K2FZ.F02
                 IF FOUND() AND B03.F10 = '2' AND B03.F07 = VOA2	&&需已過帳,對象編號相同
	                SELECT RECNO() FROM B03 WHERE B03.F01 = K2FZ.F02 AND B03.F10='2' AND B03.F07 = VOA2 INTO ARRAY BK3
		            JJ3 = ''                
	                IF _TALLY > 0   
	                   FOR I = 1 TO ALEN(BK3)
	                       JJ3 = JJ3 + ALLTRIM(STR(BK3(I))) + ','
		               ENDFOR    
		               KK3 = STUFF(JJ3,RAT(',',JJ3,1),1,'')              
		               RLOCK(KK3,'B03')
		               LL3 = RLOCK(KK3,'B03')
		            ELSE
		               LL3 = .T.   
		            ENDIF  
		            IF LL3 = .T. AND LEN(ALLTRIM(JJ3)) > 0 
		               FOR I= 1 TO ALEN(BK3)
		                   SELECT B03
		                   GO BK3(I)  
		                   REPLACE B03.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE B03.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE B03.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別
		               ENDFOR 
		               IF K25.F03<>INT_117 AND K25.F03<>INT_118
		                  SELECT D19
		               ELSE
		                  SELECT P19
		               ENDIF      
		               SET ORDER TO 4
		               SEEK B03.F01
		               IF FOUND()
		                  DO WHILE F02=B02.F01
		                     REPLACE F20 WITH B02.F20
		                     REPLACE F19 WITH ICASE(B03.F23='2','00',B03.F23='3','09',B03.F23='1' AND B03.F22='21','03',B03.F23='1' AND B03.F22='22','02','06')
		                     SKIP
		                  ENDDO
		               ENDIF			               
		            ENDIF    
                 ENDIF
                 SELECT B03
                 USE       
	          ENDIF  
           ENDIF        
           ****B04.出貨單
           IF LEFT(K2FZ.F02,2) = 'BC'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 	&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))					&&檔名之月份
     	      B04 ='B04' + S1 + S2  
	          IF FILE(B04+'.DBF') = .T.
	             IF USED('&B04')
	                SELECT  B04
	             ELSE
	                SELECT  0  
	                USE (B04) ALIA B04
	             ENDIF
	             SET ORDER TO 1
                 SELECT B04
                 SEEK K2FZ.F02
                 IF FOUND() AND B04.F10 = '2' AND B04.F06 = VOA2	&&需已過帳,對象編號相同
	                SELECT RECNO() FROM B04 WHERE B04.F01 = K2FZ.F02 AND B04.F10='2' AND B04.F06 = VOA2 INTO ARRAY BK4  
		            JJ4 = ''                
	                IF _TALLY > 0   
	                   FOR I = 1 TO ALEN(BK4)
	                       JJ4 = JJ4 + ALLTRIM(STR(BK4(I))) + ','
		               ENDFOR    
		               KK4 = STUFF(JJ4,RAT(',',JJ4,1),1,'')              
		               RLOCK(KK4,'B04')
		               LL4 = RLOCK(KK4,'B04')
		            ELSE
		               LL4 = .T.   
		            ENDIF  
		            IF LL4 = .T. AND LEN(ALLTRIM(JJ4)) > 0 
		               FOR I= 1 TO ALEN(BK4)
		                   SELECT B04
		                   GO BK4(I)  
		                   REPLACE B04.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE B04.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE B04.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別
		                   IF B04.F22='31' 
		                      REPLACE B04.F08 WITH IIF(B04.F23='2','1','')
		                   ENDIF
		               ENDFOR 
		               SELECT C13
		               SET ORDER TO C134
		               SEEK B04.F01
		               IF FOUND()
		                  DO WHILE F02=B04.F01
		                     REPLACE F17 WITH B04.F20
                             REPLACE F16 WITH ICASE(B04.F23='2','00',B04.F23='3','09',B04.F23='1' AND B04.F22='31','03',B04.F23='1' AND B04.F22='32','02','06')
		                     SKIP
		                  ENDDO
		               ENDIF
		            ENDIF    
                 ENDIF
                 SELECT B04
                 USE       
	          ENDIF     	          
           ENDIF
           ****B05.出貨退回單
           IF LEFT(K2FZ.F02,2) = 'BD'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 	&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))					&&檔名之月份
     	      B05 ='B05' + S1 + S2  
	          IF FILE(B05+'.DBF') = .T.
	             IF USED('&B05')
	                SELECT  B05
	             ELSE
	                SELECT  0  
	                USE (B05) ALIA B05
	             ENDIF
	             SET ORDER TO 1
                 SELECT B05
                 SEEK K2FZ.F02
                 IF FOUND() AND B05.F12 = '2' AND B05.F10 = VOA2	&&需已過帳,對象編號相同
	                SELECT RECNO() FROM B05 WHERE B05.F01 = K2FZ.F02 AND B05.F12='2' AND B05.F10 = VOA2 INTO ARRAY BK5
		            JJ5 = ''                
	                IF _TALLY > 0   
	                  FOR I = 1 TO ALEN(BK5)
	                      JJ5 = JJ5 + ALLTRIM(STR(BK5(I))) + ','
		              ENDFOR    
		              KK5 = STUFF(JJ5,RAT(',',JJ5,1),1,'')              
		              RLOCK(KK5,'B05')
		              LL5 = RLOCK(KK5,'B05')
		            ELSE
		              LL5 = .T.   
		            ENDIF  
		            IF LL5 = .T. AND LEN(ALLTRIM(JJ5)) > 0 
		               FOR I= 1 TO ALEN(BK5)
		                   SELECT B05
		                   GO BK5(I)  
		                   REPLACE B05.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE B05.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE B05.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別
		               ENDFOR 
		               SELECT C13
		               SET ORDER TO C134
		               SEEK B05.F01
		               IF FOUND()
		                  DO WHILE F02=B05.F01
		                     REPLACE F17 WITH B05.F20
                             REPLACE F16 WITH ICASE(B05.F23='2','00',B05.F23='3','09',B05.F23='1' AND B05.F22='31','03',B05.F23='1' AND B05.F22='32','02','06')
		                     SELECT C13
		                     SKIP
		                  ENDDO
		               ENDIF		               
		            ENDIF    
                 ENDIF
                 SELECT B05
                 USE       
	          ENDIF     	          
           ENDIF               
           ****B07.委外入庫單
           IF LEFT(K2FZ.F02,2) = 'BM'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 	&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))					&&檔名之月份
     	      B07 ='B07' + S1 + S2  
	          IF FILE(B07+'.DBF') = .T.
	             IF USED('&B07')
	                SELECT  B07
	             ELSE
	                SELECT  0  
	                USE (B07) ALIA B07
	             ENDIF
	             SET ORDER TO 1
                 SELECT B07
                 SEEK K2FZ.F02
                 IF FOUND() AND B07.F10 = '2' AND B07.F07 = VOA2	&&需已過帳,對象編號相同
	                SELECT RECNO() FROM B07 WHERE B07.F01 = K2FZ.F02 AND B07.F10='2' AND B07.F07 = VOA2 INTO ARRAY BK7
		            JJ7 = ''                
	                IF _TALLY > 0   
	                   FOR I = 1 TO ALEN(BK7)
	                       JJ7 = JJ7 + ALLTRIM(STR(BK7(I))) + ','
		               ENDFOR    
		               KK7 = STUFF(JJ7,RAT(',',JJ7,1),1,'')              
		               RLOCK(KK7,'B07')
		               LL7 = RLOCK(KK7,'B07')
		            ELSE
		               LL7 = .T.   
		            ENDIF  
		            IF LL7 = .T. AND LEN(ALLTRIM(JJ7)) > 0 
		               FOR I= 1 TO ALEN(BK7)
		                   SELECT B07
		                   GO BK7(I)  
		                   REPLACE B07.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE B07.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE B07.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別
		               ENDFOR 
		               SELECT E20
		               SET ORDER TO 4
		               SEEK B07.F01
		               IF FOUND()
		                  DO WHILE F02=B07.F01
		                     REPLACE F20 WITH B07.F20
		                     REPLACE F19 WITH ICASE(B07.F23='2','00',B07.F23='3','09',B07.F23='1' AND B07.F22='21','03',B07.F23='1' AND B07.F22='22','02','06')
		                     SELECT E20 
		                     SKIP
		                  ENDDO
		               ENDIF
		            ENDIF    
                 ENDIF
                 SELECT B07
                 USE       
	          ENDIF     	          
           ENDIF
           ****B56.製品退出單  
           IF LEFT(K2FZ.F02,2) = 'BR'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 	&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))					&&檔名之月份
     	      B56 ='B56' + S1 + S2  
	          IF FILE(B56+'.DBF') = .T.
	             IF USED('&B56')
	                SELECT  B56
	             ELSE
	                SELECT  0  
	                USE (B56) ALIA B56
	             ENDIF
	             SET ORDER TO 1
                 SELECT B56
                 SEEK K2FZ.F02
                 IF FOUND() AND B56.F10 = '2' AND B56.F07 = VOA2	&&需已過帳,對象編號相同
	                SELECT RECNO() FROM B56 WHERE B56.F01 = K2FZ.F02 AND B56.F10='2' AND B56.F07 = VOA2 INTO ARRAY BK8
		            JJ8 = ''                
	                IF _TALLY > 0   
	                   FOR I = 1 TO ALEN(BK8)
	                       JJ8 = JJ8 + ALLTRIM(STR(BK8(I))) + ','
		               ENDFOR    
		               KK8 = STUFF(JJ8,RAT(',',JJ8,1),1,'')              
		               RLOCK(KK8,'B56')
		               LL8 = RLOCK(KK8,'B56')
		            ELSE
		               LL8 = .T.   
		            ENDIF  
		            IF LL8 = .T. AND LEN(ALLTRIM(JJ8)) > 0 
		               FOR I= 1 TO ALEN(BK8)
		                   SELECT B56
		                   GO BK8(I)  
		                   REPLACE B56.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE B56.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE B56.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別
		               ENDFOR 
		               SELECT E20
		               SET ORDER TO 4
		               SEEK B56.F01
		               IF FOUND()
		                  DO WHILE F02=B56.F01
		                     REPLACE F20 WITH B56.F20
		                     REPLACE F19 WITH ICASE(B56.F23='2','00',B56.F23='3','09',B56.F23='1' AND B56.F22='21','03',B56.F23='1' AND B56.F22='22','02','06')
		                     SKIP
		                  ENDDO		                  
		               ENDIF
		            ENDIF    
                 ENDIF
                 SELECT B56
                 USE       
	          ENDIF     	          
           ENDIF       
             
           ****P12.外購進貨單
           IF LEFT(K2FZ.F02,2) = 'PB'
              S1 = ALLTRIM(STR(2000 + VAL(SUBSTR(ALLTRIM(K2FZ.F02),3,2)))) 	&&檔名之年份
     	      S2 = ALLTRIM(SUBSTR(ALLTRIM(K2FZ.F02),5,2))					&&檔名之月份
     	      P12 ='P12' + S1 + S2  
     	      P121 ='P121' + S1 + S2
     	      P122 ='P122' + S1 + S2
	          IF FILE(P12 + '.DBF') = .T.
	             IF USED('&P12')
	                SELECT  P12
	             ELSE
	                SELECT  0  
	                USE (P12) ALIA P12
	             ENDIF
                 IF K25.F03=INT_117 OR K25.F03=INT_118
                    SET ORDER TO P122
                    SEEK SUBSTR(K2FZ.F02,3,6)
                 ELSE
	                SET ORDER TO P121
                    SEEK K2FZ.F02
                 ENDIF   
                 IF FOUND() AND P12.F10 = '2' AND P12.F07 = VOA2	&&需已過帳,對象編號相同
                    IF K25.F03=INT_117 OR K25.F03=INT_118
                       SELECT RECNO() FROM P12 WHERE LEFT(P12.F21,6) = SUBSTR(K2FZ.F02,3,6) AND P12.F10='2' AND P12.F07 = VOA2 INTO ARRAY BK12
                    ELSE
 	                   SELECT RECNO() FROM P12 WHERE P12.F01 = K2FZ.F02 AND P12.F10='2' AND P12.F07 = VOA2 INTO ARRAY BK12
 	                ENDIF   
		            JJ12 = ''                
	                IF _TALLY > 0   
	                   FOR I = 1 TO ALEN(BK12)
	                       JJ12 = JJ12 + ALLTRIM(STR(BK12(I))) + ','
		               ENDFOR    
		               KK12 = STUFF(JJ12,RAT(',',JJ12,1),1,'')              
		               RLOCK(KK12,'P12')
		               LL12 = RLOCK(KK12,'P12')
		            ELSE
		               LL12 = .T.   
		            ENDIF  
		            IF LL12 = .T. AND LEN(ALLTRIM(JJ12)) > 0 
		               FOR I= 1 TO ALEN(BK12)
		                   SELECT P12
		                   GO BK12(I)  
		                   REPLACE P12.F20 WITH IIF(EMPTY(VOAC) = .T.,VOA1,'')		&&發票號碼 
		                   REPLACE P12.F22 WITH IIF(EMPTY(VOAC) = .T.,VOA3,'')		&&發票種類
		                   REPLACE P12.F23 WITH IIF(EMPTY(VOAC) = .T.,VOA4,'')		&&課稅別		                   
		               ENDFOR 
		               SELECT P19

		                  SET ORDER TO 4
		                  SEEK P12.F01
		                  IF FOUND()
		                     DO WHILE F02=P12.F01
		                        IF LEFT(F18,2)<>'FE'
		                           REPLACE F20 WITH P12.F20
		                           REPLACE F19 WITH ICASE(P12.F23='2','00',P12.F23='3','09',P12.F23='1' AND P12.F22='21','03',P12.F23='1' AND P12.F22='22','02','06')
		                        ENDIF   
		                        SKIP
		                     ENDDO
		                  ENDIF
		               
		            ENDIF
                 ENDIF
                 SELECT P12
                 USE       
	          ENDIF     	          
           ENDIF       
           RELEASE ALL LIKE BK*  
           SELECT K2FZ
           SKIP
        ENDDO
        SELECT K2FZ
        USE
        VOA = .T.
     CATCH  
        VOA = .F.
     ENDTRY
   RETURN VOA
   ********
   FUNCTION OMT
   PARAMETERS ACDT
          OMT1=VAL(SUBSTR(DTOS(ACDT),5,2))+1   &&計算當月最後一天為幾號
          IF OMT1>12
              OMT1=OMT1%12
              OMT2=VAL(LEFT(DTOS(ACDT),4))+1
           ELSE
              OMT2=VAL(LEFT(DTOS(ACDT),4))  
          ENDIF
          OMT3=RIGHT(DTOS(CTOD(ALLTRIM(STR(OMT2))+'/'+PADL(ALLTRIM(STR(OMT1)),2,'0')+'/01')-1),2)  &&當月最後一天
          OMT4=IIF(INT_012=1,ALLTRIM(STR(YEAR(ACDT)-1911))+SUBSTR(DTOC(ACDT),3,4),LEFT(dtoc(ACDT),6))+OMT3
          RETURN OMT4
******************作廢原因
DEFINE CLASS REASON_OFDSC AS FORM
   AUTOCENTER=.T.
   CAPTION='請輸入作廢原因'
   TOP=INT_015*180
   LEFT=INT_015*220          
   FONTSIZE=INT_015*9
   HEIGHT=INT_015*170
   WIDTH=INT_015*350
   FONTSIZE=INT_015*9
   MOVABLE=.F.
   MAXBUTTON=.F.
   MINBUTTON=.F.      
   CONTROLBOX=.F.
   BORDERSTYLE=2
   SHOWTIPS=.T.
   SHOWWINDOW=1
   WINDOWTYPE=1
   NAME='REASON_OFDSC'
   ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*20,;
      TOP=INT_015*30,;
      NAME='LABEL1'
  ADD OBJECT TEXT1 AS TEXTBOX WITH;
      TOP=INT_015*24,;
      LEFT=INT_015*110,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*175,;
      MAXLENGTH=20,;
      NAME='TEXT1'      
   
   ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
       LEFT=INT_015*60,;    
       HEIGHT=INT_015*25,;   
       TOP=INT_015*140,;  
       WIDTH=INT_015*50,;
       CAPTION='\<Y.執  行',;
       TOOLTIPTEXT='確認輸入!快速鍵->ALT+Y',;
       NAME='CMND1'
   ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
       LEFT=INT_015*130,;
       TOP=INT_015*140,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*50,;
       CAPTION='\<C.取  消',;
       TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
       NAME='CMND2'   
   PROCEDURE INIT 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
      THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')      
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')  
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.CUR','COMMANDBUTTON') 
      THISFORM.LABEL1.CAPTION='請輸入作廢原因'         
      THISFORM.TEXT1.VALUE=''             
      
   ENDPROC             
   PROCEDURE CMND1.CLICK
            
             RSN_DSC=THISFORM.TEXT1.VALUE
            THISFORM.CMND2.CLICK
   ENDPROC
   PROCEDURE CMND2.CLICK               
       THISFORM.RELEASE        
   ENDPROC         
ENDDEFINE          