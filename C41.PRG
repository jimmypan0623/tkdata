***程式名稱:C41.客供品進貨退出單
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
SEK=''
R=0
HD1='C041 '
HD2='CG'
HD3='客供品進貨退出單'
AREA1='C41_1'
AREA2='C41'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'C41'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET FILTER TO F04='*' AND EMPTY(F13)
SET ORDER TO 1   
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1     
IF !USED('B11')
   SELE 0
   USE B11 
ELSE
   SELE B11
ENDIF
SET ORDER TO B111        
B25='B25'+LEFT(DTOS(DATE()),6)    &&部門別月報表
IF !USED('&B25')
   SELE 0
   USE (B25) ALIA B25
ELSE
   SELE B25
ENDIF
SET ORDER TO 1      
B26='B26'+LEFT(DTOS(DATE()),6)   &&庫存異動記錄
IF !USED('&B26')
   SELE 0
   USE (B26) ALIA B26
ELSE
   SELE B26
ENDIF
SET ORDER TO 1      
B39='B39'+LEFT(DTOS(DATE()),6)   &&未過帳單據查詢檔
IF !USED('&B39')
   SELE 0
   USE (B39) ALIA B39
ELSE
   SELE B39
ENDIF
SET ORDER TO 1         
IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C011   
IF !USED('C42')
   SELE 0
   USE C42 INDE C42
ELSE
   SELE C42
ENDIF
SET ORDER TO 1   
C41='C41'+LEFT(DTOS(DATE()),6)
C411='C411'+LEFT(DTOS(DATE()),6)
IF !USED('&C41')
   SELE 0
   USE (C41) ALIA C41
ELSE
   SELE C41
ENDIF
SET ORDER TO 1      
SET RELA TO F03 INTO B01
CREATE CURSOR C41_1;
(F01 C(10),F02 C(2),F05 C(5),F06 C(5),F07 C(20),F08 C(17),F09 C(1),F90 C(90))
INDE ON F01 TAG C41_11
INDE ON F06+F01 TAG C41_12
INDE ON F05+F02 TAG C41_13
SELE F01,F02,F05,F06,F07,F08,F09,F90 FROM C41 GROUP BY F01 ORDER BY F01 INTO CURSOR C41_2
SELE C41_2
GO TOP
DO WHILE !EOF()
   SELE C41_1
   APPEND BLANK
   REPL F01 WITH C41_2.F01
   REPL F02 WITH C41_2.F02
   REPL F05 WITH C41_2.F05
   REPL F06 WITH C41_2.F06
   REPL F07 WITH C41_2.F07
   REPL F08 WITH C41_2.F08
   REPL F09 WITH C41_2.F09
   REPL F90 WITH C41_2.F90
   SELE C41_2
   SKIP   
ENDDO
SELE C41_2
USE   
SELE C41_1
SET ORDER TO 1
SET RELA TO F06 INTO C01
SET RELA TO F05 INTO A14 ADDI
********************
C41FORM=CREATEOBJECT("TKC41")
C41FORM.SHOW  
DEFINE CLASS TKC41 AS FORM
  CAPTION='C41.客供品進貨退出單'
  CONTROLBOX=.F.
  BORDERSTYLE=3  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKC41'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=5,;            
      RECORDSOURCE='C41_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=4,;
      RECORDSOURCE='C41',; 
      LINKMASTER='C41_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER=C411,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*558          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.過帳',;
      NAME='ANS_BOTT'      
  ********************               
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='退出單號'          
     ENDWITH
      THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH 
     THIS.ADDOBJECT('LBLF06','LABEL')     
     WITH THIS.LBLF06
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*38
          .WIDTH=INT_015*50  
          .CAPTION='客戶編號'
     ENDWITH                   
     THIS.ADDOBJECT('LBLF061','LABEL')     
     WITH THIS.LBLF061
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*38
          .AUTOSIZE=.T.
     ENDWITH 
     THIS.ADDOBJECT('TXTF06','TXTF06')          
     WITH THIS.TXTF06
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH                 
     THIS.ADDOBJECT('LBLF05','LABEL')
     WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='退料部門'
     ENDWITH    
     THIS.ADDOBJECT('LBLF051','LABEL')
     WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*63
         .AUTOSIZE=.T. 
     ENDWITH   
     THIS.ADDOBJECT('TXTF05','TXTF05')
     WITH THIS.TXTF05
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH    
     THIS.ADDOBJECT('TXTF07','TEXTBOX')        
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*150
          .HEIGHT=INT_015*25
          .MAXLENGTH=20
     ENDWITH                           
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*13
         .WIDTH=INT_015*50
         .CAPTION='退貨日期'
     ENDWITH 
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*9
          .WIDTH=INT_015*40
          .HEIGHT=INT_015*25
          .INPUTMASK='99'
          .MAXLENGTH=2
     ENDWITH         
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='過  帳  碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH      
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*88
         .AUTOSIZE=.T.
     ENDWITH        
  ENDPROC 
 **************   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF03','LABEL')
	WITH THIS.LBLF03  
	     .VISIBLE=.T.
         	.LEFT=INT_015*14
         	.TOP=INT_015*18
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF031','LABEL')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*18
	     .AUTOSIZE=.T.
	ENDWITH 
 	THIS.ADDOBJECT('TXTF03','TXTF03')
	WITH THIS.TXTF03      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF03'  
	ENDWITH    
    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*43
         .WIDTH=INT_015*50
         .CAPTION='進貨數量'         
    ENDWITH 
    THIS.ADDOBJECT('TXTF04','TEXTBOX')
	WITH THIS.TXTF04
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999999.999'
	     .NAME='TXTF04'
	ENDWITH
  THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF081','LABEL')
     WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH      	
  ENDPROC   
*************
  PROC INIT       
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='退貨單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='客戶簡稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='退料部門'
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='C41_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C41_1.F06'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='C01.F05'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C41_1.F05'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(C41_1.F09<>'2',RGB(255,0,0),'')","COLUMN")         
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'       
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='數        量'
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='安全資料'
       THISFORM.GRID2.LINKMASTER='C41_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='C41.F03'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='C41.F04'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='C41.F08'
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*135
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. C41_1.F09<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. C41_1.F09<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(C41_1.F09='2',.F.,.T.)  .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依退貨單號排列'      
       JK='退貨單號'
       SELE C41_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=C41_1.F01
  ENDPROC               
***********         
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE C41_1
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(C41_1.F09<>'2',RGB(255,0,0),'')","COLUMN")         
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS   
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF                
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''         
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''          
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. C41_1.F09<>'2' &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. C41_1.F09<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(C41_1.F09='2',.F.,.T.) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
  ENDPROC
**************  
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
     SELE C41
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF   
     IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''  
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. C41.F09<>'2'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. C41.F09<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限      
*!*	        THISFORM.ANS_BOTT.ENABLED=IIF(C41.F09='2',.F.,.T.) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.ANS_BOTT.ENABLED=.F.
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. C41_1.F09<>'2' &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
  ENDPROC   
***********
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依退貨單號排列')
           .ADDITEM('依客戶編號排列')
           .ADDITEM('依退料部門排列')
       ENDWITH      
  ENDPROC 

**********     
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE C41_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依退貨單號排列'
               SET ORDER TO 1 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='退貨單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='C41_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C41_1.F06'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='客戶簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='C01.F05'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='退料部門'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C41_1.F05'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49               
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58                              
   
          CASE THIS.DISPLAYVALUE='依客戶編號排列'
               SET ORDER TO 2
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='客戶編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='C41_1.F06'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='客戶簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C01.F05'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='退貨單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='C41_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81                                                   
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='退料部門'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C41_1.F05'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58                 
          CASE THIS.DISPLAYVALUE='依退料部門排列'
               SET ORDER TO 3
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='退料部門'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='C41_1.F05'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*58
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='退貨單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='C41_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81               
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='客戶編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C41_1.F06'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49                  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='客戶簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='C01.F05'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60                                                             
       ENDCASE 
        *SELE &AREA1
        THISFORM.GRID1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.CHILDORDER=''
       SELE A24
       USE
       SELECT A23
       SEEK DTOS(CTOD(THIS.DISPLAYVALUE+'/01'))       
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1             
       SELE B25
       USE
       B25='B25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B25')
          SELE 0
          USE (B25) ALIA B25
       ELSE
          SELE B25
       ENDIF
       SET ORDER TO 1                    
       SELE B26
       USE
       B26='B26'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B26')
          SELE 0
          USE (B26) ALIA B26
       ELSE
          SELE B26
       ENDIF
       SET ORDER TO 1                           
       SELE B39
       USE
       B39='B39'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B39')
          SELE 0
          USE (B39) ALIA B39
       ELSE
          SELE B39
       ENDIF
       SET ORDER TO 1                                  
       SELE C41
       SET RELA OFF INTO B01
       USE
       SELE C41_1
       SET RELA OFF INTO A14 
       SET RELA OFF INTO C01   
       USE
       C41='C41'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       C411='C411'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&C41')
	   SELE 0
	   USE (C41) ALIA C41
	ELSE
	   SELE C41
	ENDIF
	SET ORDER TO 1      
	SET RELA TO F03 INTO B01
	CREATE CURSOR C41_1;
	(F01 C(10),F02 C(2),F05 C(5),F06 C(5),F07 C(20),F08 C(17),F09 C(1),F90 C(17))
	INDE ON F01 TAG C41_11
	INDE ON F06+F01 TAG C41_12
	INDE ON F05+F02 TAG C41_13
	SELE F01,F02,F05,F06,F07,F08,F09,F90 FROM C41 GROUP BY F01 ORDER BY F01 INTO CURSOR C41_2
	SELE C41_2
	GO TOP
	DO WHILE !EOF()
	   SELE C41_1
	   APPEND BLANK
	   REPL F01 WITH C41_2.F01
	   REPL F02 WITH C41_2.F02
	   REPL F05 WITH C41_2.F05
	   REPL F06 WITH C41_2.F06
	   REPL F07 WITH C41_2.F07
	   REPL F08 WITH C41_2.F08
	   REPL F09 WITH C41_2.F09
	   REPL F90 WITH C41_2.F90
	   SELE C41_2
	   SKIP   
	ENDDO
	SELE C41_2
	USE   
	SELE C41_1
	SET ORDER TO 1
	SET RELA TO F06 INTO C01
	SET RELA TO F05 INTO A14 ADDI    
       THISFORM.GRID1.RECORDSOURCE='C41_1'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='C41_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C41_1.F06'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='C01.F05'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='C41_1.F05'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'  
       THISFORM.GRID2.RECORDSOURCE='C41'
       THISFORM.GRID2.LINKMASTER='C41_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=C411  
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='C41.F03'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='C41.F04'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='C41.F08'
       THISFORM.KEY_LIST.INTERACTIVECHANGE
           THISFORM.PAGEFRAME1.ACTIVEPAGE=1
           THISFORM.REFRESH
           THISFORM.GRID1.SETFOCUS        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. C41_1.F09<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. C41_1.F09<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.ANS_BOTT.ENABLED=IIF(C41_1.F09='2',.F.,.T.)  .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED              
       ENDIF          
  ENDPROC
***************  
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=C41_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=C41_1.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=C41_1.F05
       THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=C41_1.F06
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=C41_1.F07
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=C01.F05
       THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=C41_1.F08
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=IIF(C41_1.F09='2','已過帳','未過帳')
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.BACKCOLOR=IIF(C41_1.F09='2',RGB(58,186,152),RGB(255,0,0))    
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=C41_1.F90
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. C41_1.F09<>'2'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. C41_1.F09<>'2' &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED=IIF(C41_1.F09='2',.F.,.T.) .AND. IIF(A02.F08='*',.T.,.F.)          
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
  ENDPROC
***************       
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=C41.F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=C41.F04 
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=C41.F08         
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM. CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
  ENDPROC 
****************  
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
          HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          DO ODR_CRT
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.  
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''            
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF081.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''          
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''   
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')   
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.  
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''   
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0       
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''
     ENDIF   
  ENDPROC  
*************  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='C41'
       THISFORM.GRID2.CHILDORDER=C411
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='C41.F03'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='C41.F04'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='C41.F08'       
       SELE C41_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'C41')=.T.     &&如果單號重複
             SELECT MAX(F01) FROM C41 INTO ARRAY GB NOWAIT
             HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
             DO ODR_RPT
             THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
             THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH                                       
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
          =MESSAGEBOX('客戶基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       SELE RECNO() FROM C42 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE INTO ARRAY RC1
       IF _TALLY=0       
          =MESSAGEBOX('此客戶無進貨紀錄,請察明後再輸入',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS                          
          SET ORDER TO &COD
          RETURN                                     
       ENDIF   
       IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
             =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
             SET ORDER TO &COD
             RETURN            
        ENDIF       
        IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
             =MESSAGEBOX('退貨日期輸入錯誤!',0+64,'提示訊息視窗') 
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
             SET ORDER TO &COD          
             RETURN
        ENDIF    
       SELE C41_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE  
          REPLACE F08 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       SELE B39
       APPEND BLANK
       REPL F01 WITH A02.F03
       REPL F02 WITH C41_1.F01
       REPL F03 WITH C41_1.F02
       REPL F04 WITH C41_1.F06
       REPL F05 WITH C41_1.F05
       REPL F06 WITH IIF(SEEK(C41_1.F05,'A14'),A14.F02,'')
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE                                                             &&表身新增確認
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
*!*	        IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C42')=.F. .AND.;
*!*	            IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B11'),B11.F04,0)<=0
*!*	          =MESSAGEBOX('無此出貨紀錄',0+64,'提示訊息視窗')       
*!*	          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
*!*	          RETURN
*!*	       ENDIF 
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'C41')=.T.           
          =MESSAGEBOX('此料號在此張申請單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN            
       ENDIF 
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
             =MESSAGEBOX('退貨數量不得為 0 ,請重新數入數量',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF   
      IF  THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>;
      	  IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B11'),B11.F04,0)
          =MESSAGEBOX('退貨數量大於庫存數量',0+64,'提示訊息視窗')       
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN
       ENDIF             
       SELE C41
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F08 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')      
      ENDIF
      UNLOCK ALL         
      SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE                                    
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID2.SETFOCUS  
      THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
  ENDPROC
***************
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE C41_1
        PO_NO=C41_1.F01
        SELE RECNO() FROM C41 WHERE C41.F01=PO_NO AND F09<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'C41')
           LL1=RLOCK(KK1,'C41')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE C41_1           
           UNLOCK ALL
           REPL F09 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.F.
*!*	           THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
*!*	           THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.F.         
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.         
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
        ELSE 
           DO FILE_IMPACT
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ENDIF   
     ELSE                         
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.       
          SELE C41                                                      &&處理表身修改
        IF RLOCK('C41') 
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
        ELSE  
           DO FILE_IMPACT 
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       ENDIF        
     ENDIF   
  ENDPROC   
******************
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1  
*!*	     	  IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
*!*	              =MESSAGEBOX('客戶基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
*!*	              THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
*!*	              RETURN            
*!*	          ENDIF
*!*	          SELE RECNO() FROM C42 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE INTO ARRAY RC1
*!*	          IF _TALLY=0       
*!*	              =MESSAGEBOX('此客戶無進貨紀錄,請察明後再輸入',0+64,'提示訊息視窗')
*!*	              THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS                          
*!*	               RETURN                                     
*!*	          ENDIF  
*!*	           IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
*!*	              =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
*!*	              THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
*!*	              RETURN            
*!*	           ENDIF     
           IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
              =MESSAGEBOX('退貨日期輸入錯誤!',0+64,'提示訊息視窗') 
              THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
              RETURN
           ENDIF                        
           SELE C41
           SEEK C41_1.F01
           IF FOUND()
              DO WHILE F01=C41_1.F01
  		     REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                     REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
                     REPL F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE           
                     REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                     REPL F08 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')              
                     SKIP
              ENDDO    
           ENDIF        
                 SELE C41_1
          	 REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                 REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
                 REPL F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE           
                 REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                 REPL F08 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')              
           UNLOCK ALL    
     ELSE                                                        &&表身修改確認     
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
             =MESSAGEBOX('退貨數量不得為 0 ,請重新數入數量',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF   
      IF  THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>;
      	  IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B11'),B11.F04,0)
          =MESSAGEBOX('退貨數量大於庫存數量',0+64,'提示訊息視窗')       
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
          RETURN
       ENDIF             
           SELE C41                    
           REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
           REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
           REPLACE F08 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          UNLOCK ALL
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC  
*************** 
   PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6            
          IF ALIA()='C41_1'           &&刪除整張訂單
             SELE C41_1             
                PO_NO=C41_1.F01
                SELE RECNO() FROM C41 WHERE C41.F01=PO_NO  AND C41.F09<>'2' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'C41')
                   LL1=RLOCK(KK1,'C41')
                ELSE
                   LL1=.T.   
                ENDIF                                  
                IF LL1 .AND. RLOCK('C41_1')   
                   DELE FROM C41 WHERE C41.F01=PO_NO
                   SELE B39                     &&刪除未過帳單據紀錄
                   SEEK A02.F03+C41_1.F01                   
                   IF FOUND()
                      DELE
                   ENDIF   
                   SELE C41_1
                   DELE
                   SKIP -1
                   IF BOF()
                      GO TOP
                   ENDIF   
                   UNLOCK ALL
                   IF  SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                       HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                       DO ODR_RJT
                   ENDIF  
                ELSE
                   DO FILE_IMPACT                  
                ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. C41_1.F09<>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. C41_1.F09<>'2' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(C41_1.F09='2',.F.,.T.) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED                
             ENDIF     
       ELSE                                                      &&刪除單筆資料       
            IF RLOCK('C41')       
                 SELE C41
                 DELE
                 SKIP -1
                 IF BOF()
                     GO TOP
                  ENDIF   
             ELSE
                    DO FILE_IMPACT                  
             ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                 SELE B39                           &&刪除未過帳單據紀錄       
                 SEEK A02.F03+C41_1.F01
                 IF FOUND()
                    DELE
                 ENDIF                    
                 SELE C41_1                        
                 PO_NO=C41_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF  SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                     HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                     DO ODR_RJT
                 ENDIF
                 SELE C41_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF   
  ENDPROC  
*******************
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE2.TXTF04.READONLY=.T.    
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      THISFORM.GRID1.ENABLED=.T.
      THISFORM.GRID2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1         
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
      ELSE
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
            HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
            DO ODR_RJT
            SELECT  B39
            SEEK A02.F03+C41_1.F01
            SET ORDER TO 1
            IF FOUND()
               DELE            
            ENDIF   
            SELE C41_1
            DELE
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
           THISFORM.ANS_BOTT.ENABLED=IIF(C41_1.F09='2',.F.,.T.) .AND. IIF(A02.F08='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED             
      ELSE
      	    THISFORM.ANS_BOTT.ENABLED=.F.
      ENDIF
  ENDPROC
***********  
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'C41'
            THISFORM.GRID2.RECORDSOURCE='C41'
            THISFORM.GRID2.CHILDORDER=C411
            THISFORM.GRID2.COLUMN1.CONTROLSOURCE='C41.F03'
            THISFORM.GRID2.COLUMN2.CONTROLSOURCE='B01.F02'
            THISFORM.GRID2.COLUMN3.CONTROLSOURCE='C41.F04'
            THISFORM.GRID2.COLUMN4.CONTROLSOURCE='C41.F08'   
         ENDIF   
         IF INT_099=.T.
            HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
            DO ODR_RJT
         ENDIF   
         SELE C41_1
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依退貨單號排列'
                 SET ORDER TO 1
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依客戶編號排列'
                 SET ORDER TO 2
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依退料部門排列'
                 SET ORDER TO 3
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC   
*************    
  PROC ANS_BOTT.CLICK     &&過帳程序
    IF MESSAGEBOX('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	        
       SELE RECNO() FROM C41 WHERE C41.F01=C41_1.F01  AND F09<>'2' INTO ARRAY BK1              
            JJ1=''                
            IF _TALLY>0   
               FOR I= 1 TO ALEN(BK1)
                   JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
               ENDFOR    
               KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
               RLOCK(KK1,'C41')
               LL1=RLOCK(KK1,'C41')
            ELSE
               LL1=.T.   
            ENDIF
            SELE RECNO() FROM C01 WHERE F01=C41_1.F06 INTO ARRAY BK2
            JJ2=''
            IF _TALLY>0   
               FOR I= 1 TO ALEN(BK2)
                   JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
               ENDFOR    
               KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
               RLOCK(KK2,'C01')
               LL2=RLOCK(KK2,'C01')
            ELSE
               LL2=.T.   
            ENDIF    
                 ********   
          IF LL1 .AND. LL2=.T. 
             IF LEN(ALLTRIM(JJ1))>0 
                SELE C41
                FOR I= 1 TO ALEN(BK1)                      
                    GO BK1(I) 
                    SELE B11                                            &&部門庫存明細檔 
                    SEEK C41.F05+C41.F03+IIF(INT_028,C41.F06,SPACE(5))                                   &&轉入部門庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+C41.F04*(-1)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+C41.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+C41.F02))
                          ENDIF
                       ENDIF   
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH C41.F05
                       REPL F03 WITH C41.F03
                       REPL F04 WITH C41.F04*(-1)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+C41.F02))
                       IF INT_028
                          REPLACE F08 WITH C41.F06
                       ENDIF
                    ENDIF   
                    *******
                    SELE B25                                             &&分部門庫存月報表 
                    SEEK C41.F05+C41.F03
                    IF FOUND()                                                &&轉入部門報表
                       REPL F05 WITH F05+C41.F04		&&退貨數量
                       REPL F15 WITH F15+C41.F04*(-1)		&&期末數量
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH C41.F05
                       REPL F02 WITH C41.F03
                       REPL F05 WITH C41.F04
                       REPL F15 WITH C41.F04*(-1)                                                  
                    ENDIF   
                    SELE B26                                            &&庫存異動紀錄
                    APPEND BLANK                                             
                    REPL F01 WITH C41.F03                               
                    REPL F02 WITH C41.F05
                    REPL F03 WITH C41.F02
                    REPL F04 WITH C41.F04*(-1)
                    REPL F06 WITH 'J'
                    REPL F07 WITH C41.F01           
                    REPL F08 WITH '供料客戶 '+C41.F06+SPACE(2)+IIF(SEEK(C41.F06,'C01'),C01.F05,'')     
                    SELE C41
                    REPL F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    REPL F09 WITH '2'
                 ENDFOR   
                 SELE B39                    &&未過帳庫存單據查詢檔
                 SEEK A02.F03+C41_1.F01
                  IF FOUND()
                     DELE
                  ENDIF                                             
                  SELE C41_1
                  REPL F09 WITH '2'
                  REPL F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
             ELSE
                =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                SELE C41_1
                REPL F09 WITH '2'
             ENDIF           
             THIS.ENABLED=.F.
             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
             UNLOCK ALL
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
             ENDIF
             THISFORM.REFRESH
          ELSE
            DO FILE_IMPACT
            UNLOCK ALL
            RETURN
          ENDIF   
          UNLOCK ALL
         RELEASE ALL LIKE BK*
      ENDIF      
  ENDPROC
ENDDEFINE    
***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=C41_1.F01     
     HK=IIF(INT_012=1,ALLTRIM(STR(YEAR(A23.F01)-1911))+SUBSTR(DTOC(A23.F01),3,3),LEFT(dtoc(A23.F01),5))
     SELECT C41.F01,;
            C41.F02,;
            C41.F03,;
            C41.F04,;
            C41.F05,;
            C41.F06,;
            C41.F07,;
            B01.F02,;
            A14.F02,;
            C01.F04,;
            C01.F06,;
            C01.F12,;
            C01.F13;
     FROM C41,B01,A14,C01 WHERE C41.F01=LK AND B01.F01=C41.F03 AND A14.F01=C41.F05 AND C01.F01=C41.F06 ORDER BY C41.F03 NOWAIT
     IF _TALLY >0
*!*	        REPORT FORM ALLTRIM(INT_116)+'C41'  PREVIEW
         REPORT FORM ALLTRIM(INT_116)+'C41' TO PRINT PROMPT 
     ENDIF  
     CLEAR
ENDPROC
***************************************************特殊欄位------------------收料部門
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND LEN(ALLTRIM(F01))=4 AND F04='*' AND EMPTY(F13)
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEN(ALLTRIM(F01))=4 AND F04='*' AND EMPTY(F13)
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=CREATEOBJECT("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')         
  ENDPROC
ENDDEFINE 
***************************************************特殊輸入欄位設定-----------客戶
DEFINE CLASS TXTF06 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          IF EMPTY(A02.F12)
             SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) 
          ELSE
             SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
          ENDIF
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F04,'')  
  ENDPROC
ENDDEFINE 
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF03 AS TEXTBOX
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  READONLY=.T.
PROCEDURE INTERACTIVECHANGE  
SEK=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
	IF AT('?',ALLTRIM(THIS.VALUE))<>0 
		IF AT('?',ALLTRIM(THIS.VALUE))>1
			SELECT B11.F03,B11.F04 FROM B11 INTO CURSOR OPT;
          		ORDER BY B11.F03 GROUP BY B11.F03  WHERE  LEFT(B11.F03,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);
          		.AND. B11.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE .AND. B11.F04<>0;
         		.AND.  B11.F03<>ALL (SELE F03 FROM C41 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
		ELSE
          	   	SELECT B11.F03,B11.F04 FROM B11 INTO CURSOR OPT;
          		ORDER BY B11.F03 GROUP BY B11.F03  WHERE  B11.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE .AND. B11.F04<>0;
         		.AND.  B11.F03<>ALL (SELE F03 FROM C41 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
		ENDIF
		IF _TALLY>0
		       OPT_SEEK=CREATEOBJECT("OPT_SEEK")  
		       OPT_SEEK.SHOW 
		       THIS.VALUE=FLG   
		       THIS.REFRESH
		        FLG='0' 
		ENDIF 
        ELSE
        	SELECT B11.F03,B11.F04 FROM B11 INTO CURSOR OPT;
          	ORDER BY B11.F03 GROUP BY B11.F03  WHERE  B11.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE .AND. B11.F04<>0;
         	.AND.  B11.F03<>ALL (SELE F03 FROM C41 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE);
         	.AND. B11.F03=THIS.VALUE
                 IF _TALLY>0
      			THIS.VALUE=OPT.F03
		ENDIF 
        ENDIF
	THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'') 
	THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0 
  ENDPROC    
ENDDEFINE
*********************************************************************進貨記錄----依料號排列搜尋
DEFINE CLASS OPT_SEEK AS FORM
  AUTOCENTER=.T.
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*320
  WIDTH=INT_015*522
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OPT_SEEK'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*290,;
      LEFT=INT_015*10
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      WIDTH=INT_015*522,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=2,;
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*183,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選取此筆資料!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*225,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<C.放棄',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
        AREA1='OPT' 
        SELE OPT
        THISFORM.CAPTION='客供品進貨記錄   ('+IIF(SEEK(SEK,'A14'),A14.F02,'')+')'
        THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
        THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')        
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='OPT'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.         
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料        號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*261
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OPT.F03'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='庫存數量'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OPT.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*74
         THISFORM.GRID1.SETFOCUS
        SELECT OPT
         GO TOP
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
           FLG=OPT.F03     
      ENDPROC 
      PROCEDURE CMND1.CLICK         
          AREA1='C41_1'
*!*	          SELE OPT
*!*	          USE
          THISFORM.RELEASE                                            
      ENDPROC
      PROCEDURE CMND2.CLICK
          AREA1='C41_1'
          SELE OPT
          USE
         THISFORM.RELEASE
      ENDPROC    
ENDDEFINE        
