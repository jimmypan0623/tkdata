***程式名稱:外購進貨單
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
CHK_STR=''
CUS_NO=SPACE(5)
TRANS_STYLE=SPACE(14)
R=0
QTY=0
TQTY=0
HD1='P002 '
HD2='PB'
HD3='外購進貨單'
AREA1='P12_1'
AREA2='P12'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1      
B25='B25'+LEFT(DTOS(DATE()),6)    &&部門別月報表
IF !USED('&B25')
   SELE 0
   USE (B25) ALIA B25
ELSE
   SELE B25
ENDIF
SET ORDER TO 1      
B26='B26'+LEFT(DTOS(DATE()),6)   &&庫存異動記錄
IF !USED('&B26')
   SELE 0
   USE (B26) ALIA B26
ELSE
   SELE B26
ENDIF
SET ORDER TO 1      
B39='B39'+LEFT(DTOS(DATE()),6)   &&未過帳單據查詢檔
IF !USED('&B39')
   SELE 0
   USE (B39) ALIA B39
ELSE
   SELE B39
ENDIF
SET ORDER TO 1   
D11='D11'+LEFT(DTOS(DATE()),6)   &&進貨日報表檔
D115='D115'+LEFT(DTOS(DATE()),6)
IF !USED('&D11')
   SELE 0
   USE (D11) ALIA D11
ELSE
   SELE D11
ENDIF
SET ORDER TO D115                  
IF !USED('D10')                  &&進貨紀錄檔   
   SELE 0
   USE D10
ELSE
   SELE D10
ENDIF
SET ORDER TO 1      
P19='P19'+LEFT(DTOS(DATE()),6)   &&鷹付帳款對帳單檔
IF !USED('&P19')
   SELE 0
   USE (P19) ALIA P19
ELSE
   SELE P19
ENDIF
SET ORDER TO 1
K24='K24'+LEFT(DTOS(DATE()),6)   &&發票明細檔表頭
K241='K241'+LEFT(DTOS(DATE()),6)
K242='K242'+LEFT(DTOS(DATE()),6)
IF !USED('&K24')
   SELE 0
   USE (K24) ALIA K24
ELSE
   SELE K24
ENDIF
SET ORDER TO K241 
K25='K25'+LEFT(DTOS(DATE()),6)   &&發票明細檔
K254='K254'+LEFT(DTOS(DATE()),6)
IF !USED('&K25')
   SELE 0
   USE (K25) ALIA K25
ELSE
   SELE K25
ENDIF
SET ORDER TO K254     
***       
SELE A23
SET ORDER TO 1
SEEK LEFT(DTOS(DATE()),6)+'01'
SKIP
IF !EOF()
   P1I='P19'+LEFT(DTOS(A23.F01),6)     &&下個月的應付帳款明細檔
   IF !USED('&P1I')
      SELE 0
      USE (P1I) ALIA P1I
   ELSE
      SELE P1I
   ENDIF
   SET ORDER TO 1
   K2D='K24'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔表頭
   IF !USED('&K2D')
      SELE 0
      USE (K2D) ALIA K2D
   ELSE
      SELE K2D
   ENDIF
   SET ORDER TO 1        
   K2E='K25'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔
   IF !USED('&K2E')
      SELE 0
      USE (K2E) ALIA K2E
   ELSE
      SELE K2E
   ENDIF
   SET ORDER TO 4   
ELSE
   IF !USED('P1I')                    &&鷹付帳款明細月結暫存檔
      SELE 0
      USE P1I ALIA P1I
   ELSE
      SELE P1I
   ENDIF
   SET ORDER TO 1
   IF !USED('K2D')                    &&發票明細月結暫存檔表頭
      SELE 0
      USE K2D ALIA K2D
   ELSE
      SELE K2D
   ENDIF
   SET ORDER TO 1      
   IF !USED('K2E')                    &&發票明細月結暫存檔
      SELE 0
      USE K2E ALIA K2E
   ELSE
      SELE K2E
   ENDIF
   SET ORDER TO 1   
ENDIF           
*!*	IF !USED('C0Z')
*!*	   SELECT 0
*!*	   USE C0Z
*!*	ELSE
*!*	   SELECT C0Z
*!*	ENDIF
*!*	SET ORDER TO 1
*!*	IF !USED('C00')
*!*	   SELECT 0
*!*	   USE C00
*!*	ELSE
*!*	   SELECT C00
*!*	ENDIF
*!*	SET ORDER TO 1      
IF !USED('D0Z')                  &&幣別檔
   SELE 0
   USE D0Z
ELSE
   SELE D0Z
ENDIF
SET ORDER TO 1              
IF !USED('D00')                  &&幣別檔
   SELE 0
   USE D00
ELSE
   SELE D00
ENDIF
SET ORDER TO 1      
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'P12'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET FILTER TO F04='*' AND F13='*'
SET ORDER TO 1     
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1     
IF !USED('B11')
   SELE 0
   USE B11 
ELSE
   SELE B11
ENDIF
SET ORDER TO B111  
*!*	SELECT F01,F02,F26,F98 FROM B01  ORDER BY F01 NOWAIT INTO CURSOR BJ2
*!*	CREATE CURSOR BJ1 (F01 C(43),F02 C(40),F26 C(1), F98 C(3))
*!*	INDEX ON F01 TAG BJ11
*!*	SET ORDER TO 1
*!*	SELECT BJ2
*!*	GO TOP
*!*	DO WHILE !EOF()
*!*	   SELECT BJ1
*!*	   APPEND BLANK
*!*	   REPLACE F01 WITH BJ2.F01
*!*	   REPLACE F02 WITH BJ2.F02
*!*	   REPLACE F26 WITH BJ2.F26
*!*	   REPLACE F98 WITH BJ2.F98
*!*	   SELECT BJ2
*!*	   SKIP
*!*	ENDDO
*!*	SELECT BJ2
*!*	USE

IF !USED('H01')
   SELE 0
   USE H01
ELSE
   SELE H01
ENDIF
SET ORDER TO H014     
IF !USED('C01')
   SELE 0
   USE C01 INDE C01
ELSE
   SELE C01
ENDIF
SET ORDER TO C013
IF !USED('D01')
   SELE 0
   USE D01 INDE D01
ELSE
   SELE D01
ENDIF
SET ORDER TO D011
IF !USED('D07')
   SELE 0   
   USE D07
ELSE
   SELE D07
ENDIF
SET ORDER TO D074
SET FILTER TO F09='1'
IF !USED('P03')
   SELE 0
   USE P03 INDE P03
ELSE
   SELE P03
ENDIF
SET ORDER TO P031
if !used('P04')
   SELE 0
   USE P04 INDE P04
ELSE
   SELE P04
ENDIF
SET ORDER TO P041      
P12='P12'+LEFT(DTOS(DATE()),6)
P121='P121'+LEFT(DTOS(DATE()),6)
IF !USED('&P12')
   SELE 0
   USE (P12) ALIA P12
ELSE
   SELE P12
ENDIF
SET ORDER TO 1      
SET RELA TO F03 INTO B01
CREATE CURSOR P12_1;
(F01 C(10),F02 C(2),F05 C(5),F07 C(5),F10 C(1),F12 C(17),F20 C(10),F21 C(60),F22 C(2),F23 C(1),F90 C(17))
INDE ON F01 TAG P12_11
INDE ON F07+F01 TAG P12_12
INDE ON F05+F02 TAG P12_13

SELE F01,F02,F05,F07,F10,F12,F20,F21,F22,F23,F90 FROM P12 GROUP BY F01 ORDER BY F01 INTO CURSOR P12_2
SELE P12_2
GO TOP
DO WHILE !EOF()
   SELE P12_1
   APPEND BLANK
   REPL F01 WITH P12_2.F01
   REPL F02 WITH P12_2.F02
   REPL F05 WITH P12_2.F05
   REPL F07 WITH P12_2.F07
   REPL F10 WITH P12_2.F10
   REPL F12 WITH P12_2.F12
   REPL F20 WITH P12_2.F20
   REPL F21 WITH P12_2.F21
   REPL F22 WITH P12_2.F22
   REPL F23 WITH P12_2.F23
   REPL F90 WITH P12_2.F90
   SELE P12_2
   SKIP   
ENDDO
SELE P12_2
USE   
SELE P12_1
SET ORDER TO 1
SET RELA TO F07 INTO D01
SET RELA TO F05 INTO A14 ADDI
P12form=createobject("tkP12")
P12form.show  
define class tkP12 as form
  caption='P12.外購進貨單'
*!*	  autocenter=.t.
  controlbox=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  WIDTH=INT_015*789
  windowtype=1
  NAME='TKP12'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;            
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=5,;            
      RECORDSOURCE='P12_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=7,;            
      RECORDSOURCE='P12',; 
      LINKMASTER='P12_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER=P121,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*415,;
      LEFT=INT_015*10,;
      ENABLED=.T.,;
      VISIBLE=.T.                    
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      TOP=INT_015*455,;
      LEFT=INT_015*10
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*160,;
      LEFT=INT_015*610          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;          
      TOOLTIPTEXT='將資料轉入庫存及帳款或待驗檔中!快速鍵->ALT+A',;            
      CAPTION='\<A.過帳',;
      NAME='ANS_BOTT'                  
  ADD OBJECT VRT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;          
      TOOLTIPTEXT='將已過入庫存及帳款之資料轉回未過帳狀態!快速鍵->ALT+V',;      
      CAPTION='\<V.反過帳',;
      NAME='VRT_BOTT'             
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='進貨單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='廠商編號'
     ENDWITH
     THIS.ADDOBJECT('LBLF071','LABEL')
     WITH THIS.LBLF071
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH     
     THIS.ADDOBJECT('LBLF05','LABEL')     
     WITH THIS.LBLF05
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*63
          .WIDTH=INT_015*50  
          .CAPTION='收料部門'
     ENDWITH            
     THIS.ADDOBJECT('LBLF051','LABEL')     
     WITH THIS.LBLF051
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*63
          .AUTOSIZE=.T.
     ENDWITH                 
     THIS.ADDOBJECT('LBLF20','LABEL')
     WITH THIS.LBLF20
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .CAPTION='發票號碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF221','LABEL')
     WITH THIS.LBLF221
         .VISIBLE=.T.
         .LEFT=INT_015*147
         .TOP=INT_015*113
         .AUTOSIZE=.T.
         .CAPTION='三聯式'
     ENDWITH          
     THIS.ADDOBJECT('LBLF231','LABEL')
     WITH THIS.LBLF231
         .VISIBLE=.T.
         .LEFT=INT_015*265
         .TOP=INT_015*113
         .AUTOSIZE=.T.
         .CAPTION='應稅'
     ENDWITH                        
     THIS.ADDOBJECT('LBLF21','LABEL')
     WITH THIS.LBLF21
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH    
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*13
         .WIDTH=INT_015*50
         .CAPTION='進貨日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='過  帳  碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF101','LABEL')
     WITH THIS.LBLF101
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF12','LABEL')
     WITH THIS.LBLF12
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF121','LABEL')
     WITH THIS.LBLF121
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*88
         .AUTOSIZE=.T.
     ENDWITH      
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF07','TXTF07')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*34
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH             
     THIS.ADDOBJECT('TXTF05','TXTF05')          
     WITH THIS.TXTF05
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
     THIS.ADDOBJECT('TXTF20','TXTF20')          
     WITH THIS.TXTF20
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*109
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH     
     THIS.ADDOBJECT('INV_TYPE','INV_TYPE')     
     THIS.ADDOBJECT('TAX_TYPE','TAX_TYPE')                                
     THIS.ADDOBJECT('TXTF21','TEXTBOX')          
     WITH THIS.TXTF21
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*134
          .WIDTH=INT_015*300
          .HEIGHT=INT_015*25
          .MAXLENGTH=100
     ENDWITH      
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*9
          .WIDTH=INT_015*40
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH        
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
        THIS.ADDOBJECT('LBLF03','LABEL')
        WITH THIS.LBLF03  
             .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
             .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF031','LABEL')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*327
             .TOP=INT_015*18
             .autosize=.t.
        ENDWITH     
    THIS.ADDOBJECT('LBLF09','LABEL')
    WITH THIS.LBLF09
         .VISIBLE=.T.
             .LEFT=INT_015*14
             .TOP=INT_015*43
             .WIDTH=INT_015*50
             .CAPTION='採購單號'
        ENDWITH     
    THIS.ADDOBJECT('LBLF04','Label')
    WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='計價數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF15','LABEL')
    WITH THIS.LBLF15
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='備品數量'       
    ENDWITH    
    THIS.ADDOBJECT('LBLF08','LABEL')    
    WITH THIS.LBLF08
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*120
         .WIDTH=INT_015*50
         .CAPTION='採購用途'
    ENDWITH     
    THIS.ADDOBJECT('LBLF081','LABEL')    
    WITH THIS.LBLF081
         .VISIBLE=.T.           
         .LEFT=INT_015*66
         .TOP=INT_015*120
         .AUTOSIZE=.T.
         .CAPTION=''
    ENDWITH     
    THIS.ADDOBJECT('LBLF16','LABEL')    
    WITH THIS.LBLF16
         .VISIBLE=.F.           
         .LEFT=INT_015*328
         .TOP=INT_015*43
         .WIDTH=INT_015*50
         .CAPTION='幣        別'
    ENDWITH     
    THIS.ADDOBJECT('LBLF18','LABEL')    
    WITH THIS.LBLF18
         .VISIBLE=.F.           
         .LEFT=INT_015*328
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='匯        率'
    ENDWITH         
    THIS.ADDOBJECT('LBLF17','LABEL')      
    WITH THIS.LBLF17
         .VISIBLE=.F.       
         .LEFT=INT_015*328
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='單        價'
    ENDWITH     
    THIS.ADDOBJECT('LBLTTL','LABEL')
    WITH THIS.LBLTTL
         .VISIBLE=.F.
         .LEFT=INT_015*328
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='小        計'
    ENDWITH     
    THIS.ADDOBJECT('LBLTTL1','LABEL')
    WITH THIS.LBLTTL1
         .VISIBLE=.F.
         .LEFT=INT_015*380
         .TOP=INT_015*118
         .AUTOSIZE=.T.
    ENDWITH     
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
        .VISIBLE=.T.           
        .LEFT=INT_015*14
        .TOP=INT_015*145
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF121','LABEL')
    WITH THIS.LBLF121
        .VISIBLE=.T.           
        .LEFT=INT_015*65
        .TOP=INT_015*145
        .AUTOSIZE=.T.
    ENDWITH    
        THIS.ADDOBJECT('TXTF03','TXTF03')
        WITH THIS.TXTF03      
             .VISIBLE=.T.
             .LEFT=INT_015*65
             .TOP=INT_015*14
             .WIDTH=INT_015*261
             .HEIGHT=INT_015*25
             .MAXLENGTH=43
             .NAME='TXTF03'  
             .BACKCOLOR=RGB(255,255,100)
             .MOUSEPOINTER=99
             .MOUSEICON='BMPS\harrow.cur'   	               
        ENDWITH     
        THIS.ADDOBJECT('TXTF09','TXTF09')
        WITH THIS.TXTF09  
             .VISIBLE=.T.
             .LEFT=INT_015*65
             .TOP=INT_015*39
             .WIDTH=INT_015*119
             .HEIGHT=INT_015*25
             .MAXLENGTH=10
             .NAME='TXTF09'  
             .BACKCOLOR=RGB(255,255,100)
             .MOUSEPOINTER=99
             .MOUSEICON='BMPS\harrow.cur'   	               
        ENDWITH     
        THIS.ADDOBJECT('TXTF04','TEXTBOX')
        WITH THIS.TXTF04
             .VISIBLE=.T.
             .LEFT=INT_015*65
             .TOP=INT_015*64
             .WIDTH=INT_015*100
             .HEIGHT=INT_015*25
             .INPUTMASK='999999999999'
             .NAME='TXTF04'         
        ENDWITH     
    THIS.ADDOBJECT('TXTF15','TEXTBOX')
    WITH THIS.TXTF15
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*89
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='999999999999'
         .NAME='TXTF15'
    ENDWITH     
    THIS.ADDOBJECT('TXTF16','TEXTBOX')
    WITH THIS.TXTF16
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*39
         .WIDTH=INT_015*49         
         .HEIGHT=INT_015*25
         .MAXLENGTH=4
         .NAME='TXTF16'                            
    ENDWITH         
    THIS.ADDOBJECT('CRCY','CRCY')
    THIS.ADDOBJECT('TXTF18','TEXTBOX')
    WITH THIS.TXTF18
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*64
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='9999.999999'
         .NAME='TXTF18'                            
    ENDWITH         
    THIS.ADDOBJECT('TXTF17','TEXTBOX')
    WITH THIS.TXTF17
         .VISIBLE=.F.           
         .LEFT=INT_015*379
         .TOP=INT_015*89
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='9999999.999999'
         .NAME='TXTF17'                            
    ENDWITH     
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
          SELE P03     
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(P12_1.F10<>'2',RGB(255,0,0),'')","COLUMN")         
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF         
        THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
        THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)
        THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.F.
        THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,0)        
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF121.CAPTION=''           
        THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''          
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. P12_1.F10<>'2' &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. P12_1.F10<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(P12_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(P12_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)              
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)  
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
       SELE P04 
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.    
        THISFORM.GRID2.SETFOCUS   
     ENDIF
        THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.F.
        THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,0)
        THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.T.
        THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,255)          
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. P12.F10<>'2'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. P12.F10<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
        IF     A02.F10='*' &&判斷有無查看單價的權限
	        THISFORM.PAGEFRAME1.PAGE2.LBLF15.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLF16.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.TXTF16.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLF18.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.TXTF18.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLTTL.VISIBLE=.T.
	        THISFORM.PAGEFRAME1.PAGE2.LBLTTL1.VISIBLE=.T.
	 ENDIF       
        THISFORM.ANS_BOTT.ENABLED=IIF(P12.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(P12_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)                      
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. P12_1.F10<>'2' &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
  ENDPROC     
  PROC INIT       
       THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
       THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)      
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10  
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.LBLF16.VISIBLE=!EMPTY(A02.F10)
       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VISIBLE=!EMPTY(A02.F10)       
       THISFORM.PAGEFRAME1.PAGE2.LBLF17.VISIBLE=!EMPTY(A02.F10)
       THISFORM.PAGEFRAME1.PAGE2.TXTF17.VISIBLE=!EMPTY(A02.F10)
       THISFORM.PAGEFRAME1.PAGE2.LBLTTL.VISIBLE=!EMPTY(A02.F10)
       THISFORM.PAGEFRAME1.PAGE2.LBLTTL1.VISIBLE=!EMPTY(A02.F10)       
       THISFORM.PAGEFRAME1.PAGE2.LBLF18.VISIBLE=!EMPTY(A02.F10)
       THISFORM.PAGEFRAME1.PAGE2.TXTF18.VISIBLE=!EMPTY(A02.F10)       
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='進貨單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商簡稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='收料部門'
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P12_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P12_1.F07'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D01.F04'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P12_1.F05'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(P12_1.F10<>'2',RGB(255,0,0),'')","COLUMN")         
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.grid2.COLUMN3.HEADER1.CAPTION='訂單編號'
           THISFORM.grid2.COLUMN4.HEADER1.CAPTION='計價數量'
           THISFORM.grid2.COLUMN5.HEADER1.CAPTION='備品數量'
           THISFORM.grid2.COLUMN6.HEADER1.CAPTION='備註說明'
           THISFORM.grid2.COLUMN7.HEADER1.CAPTION='安全資料'
           THISFORM.GRID2.LINKMASTER='P12_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
           THISFORM.grid2.COLUMN1.CONTROLSOURCE='P12.F03'
           THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
           THISFORM.grid2.COLUMN3.CONTROLSOURCE='P12.F09'
           THISFORM.grid2.COLUMN4.CONTROLSOURCE='P12.F04'
           THISFORM.grid2.COLUMN5.CONTROLSOURCE='P12.F15'
           THISFORM.grid2.COLUMN7.CONTROLSOURCE='P12.F12'
           THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
           THISFORM.GRID2.COLUMN2.WIDTH=INT_015*100
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN7.WIDTH=INT_015*135
       THISFORM.grid1.READONLY=.T.      
       THISFORM.grid2.READONLY=.T.            
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. P12_1.F10<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. P12_1.F10<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(P12_1.F10='2',.F.,.T.)  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(P12_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)                        
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依進貨單號排列'      
       JK='訂單編號'
       SELE P12_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P12_1.F01
  ENDPROC           
  PROC KEY_LIST.INIT 
       with this 
           .additem('依進貨單號排列')
           .additem('依廠商編號排列')
           .additem('依收料部門排列')
       endwith      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE P12_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依進貨單號排列'
               set order to 1 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='進貨單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P12_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P12_1.F07'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D01.F04'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='收料部門'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P12_1.F05'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49               
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58                                
          CASE THIS.DISPLAYVALUE='依廠商編號排列'
               set order to 2
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P12_1.F07'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P04.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='進貨單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P12_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81                                                   
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='收料部門'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P12_1.F05'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58                 
          CASE THIS.DISPLAYVALUE='依收料部門排列'
               set order to 3
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='收料部門'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P12_1.F05'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*58
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='進貨單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P12_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81               
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P12_1.F07'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49                  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P04.F04'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*60                                                             
       ENDCASE 
        *SELE &AREA1
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.childorder=''
       SELE A24
       USE
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1             
       SELE B25
       USE
       B25='B25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B25')
          SELE 0
          USE (B25) ALIA B25
       ELSE
          SELE B25
       ENDIF
       SET ORDER TO 1                    
       SELE B26
       USE
       B26='B26'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B26')
          SELE 0
          USE (B26) ALIA B26
       ELSE
          SELE B26
       ENDIF
       SET ORDER TO 1                           
       SELE B39
       USE
       B39='B39'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B39')
          SELE 0
          USE (B39) ALIA B39
       ELSE
          SELE B39
       ENDIF
       SET ORDER TO 1           
       SELE D11
       USE
       D11='D11'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       D115='D115'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&D11')
          SELE 0
          USE (D11) ALIA D11
       ELSE
          SELE D11
       ENDIF
       SET ORDER TO  D115        
       SELE P1I
       USE
       SELE K2D
       USE          
       SELE K2E
       USE                          
       SELE P19
       USE
       P19='P19'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&P19')
          SELE 0
          USE (P19) ALIA P19
       ELSE
          SELE P19
       ENDIF
       SET ORDER TO 1    
       SELECT K24
       USE
	K24='K24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)   &&發票明細檔表頭
	K241='K241'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	K242='K242'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	IF !USED('&K24')
	   SELE 0
	   USE (K24) ALIA K24
	ELSE
	   SELE K24
	ENDIF
	SET ORDER TO K241           
       SELE K25
       USE
       K25='K25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       K254='K254'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&K25')
          SELE 0
          USE (K25) ALIA K25
       ELSE
          SELE K25
       ENDIF
       SET ORDER TO K254
       **
       SELE A23
       SET ORDER TO 1
       SEEK DTOS(CTOD(THIS.DISPLAYVALUE+'/01'))
       SKIP
       IF !EOF()
          P1I='P19'+LEFT(DTOS(A23.F01),6)     &&下個月的鷹付帳款明細檔
          IF !USED('&P1I')
             SELE 0
             USE (P1I) ALIA P1I
          ELSE
             SELE P1I
          ENDIF
          SET ORDER TO 1
          K2D='K24'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔表頭
          IF !USED('&K2D')
             SELE 0
             USE (K2D) ALIA K2D
          ELSE
             SELE K2D
          ENDIF
          SET ORDER TO 1          
          K2E='K25'+LEFT(DTOS(A23.F01),6)     &&下個月的發票明細檔
          IF !USED('&K2E')
             SELE 0
             USE (K2E) ALIA K2E
          ELSE
             SELE K2E
          ENDIF
          SET ORDER TO 4  
       ELSE
          IF !USED('P1I')                    &&鷹付帳款明細月結暫存檔
             SELE 0
             USE P1I ALIA P1I
          ELSE
             SELE P1I
          ENDIF
          SET ORDER TO 1
          IF !USED('K2D')                    &&發票明細月結暫存檔表頭
             SELE 0
             USE K2D ALIA K2D
          ELSE
             SELE K2D
          ENDIF
          SET ORDER TO 1           
          IF !USED('K2E')                    &&發票明細月結暫存檔
             SELE 0
             USE K2E ALIA K2E
          ELSE
             SELE K2E
          ENDIF
          SET ORDER TO 1   
       ENDIF   
       ***                       
       SELE P12
       set rela off into B01
       SET RELA OFF INTO P12_1
       USE
       SELE P12_1
       set rela off into D01
       set rela off into a14
       USE
       P12='P12'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       P121='P121'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&P12')
          SELE 0
          USE (P12) ALIA P12
       ELSE
          SELE P12
       ENDIF
       SET ORDER TO 1      
       SET RELA TO F03 INTO B01
       CREATE CURSOR P12_1;
       (F01 C(10),F02 C(2),F05 C(5),F07 C(5),F10 C(1),F12 C(17),F20 C(10),F21 C(60),F22 C(2),F23 C(1),F90 C(17))
       INDE ON F01 TAG P12_11
       INDE ON F07+F01 TAG P12_12
       INDE ON F05+F02 TAG P12_13
       SELE F01,F02,F05,F07,F10,F12,F20,F21,F22,F23,F90 FROM P12 GROUP BY F01 ORDER BY F01 INTO CURSOR P12_2
       SELE P12_2
       GO TOP
       DO WHILE !EOF()
          SELE P12_1
          APPEND BLANK
          REPL F01 WITH P12_2.F01
          REPL F02 WITH P12_2.F02
          REPL F05 WITH P12_2.F05
          REPL F07 WITH P12_2.F07
          REPL F10 WITH P12_2.F10
          REPL F12 WITH P12_2.F12
          REPL F20 WITH P12_2.F20
          REPL F21 WITH P12_2.F21
          REPL F22 WITH P12_2.F22
          REPL F23 WITH P12_2.F23
          REPL F90 WITH P12_2.F90
          SELE P12_2
          SKIP
       ENDDO
       SELE P12_2
       USE   
       SELE P12_1
       SET ORDER TO 1
       SET RELA TO F07 INTO D01
       SET RELA TO F05 INTO A14 ADDI       
       THISFORM.GRID1.RECORDSOURCE='P12_1'
       THISFORM.GRID2.RECORDSOURCE='P12'
           THISFORM.GRID2.LINKMASTER='P12_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=P121  
           THISFORM.grid2.COLUMN1.CONTROLSOURCE='P12.F03'
           THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
           THISFORM.grid2.COLUMN3.CONTROLSOURCE='P12.F09'
           THISFORM.grid2.COLUMN4.CONTROLSOURCE='P12.F04'
           THISFORM.grid2.COLUMN5.CONTROLSOURCE='P12.F15'
           THISFORM.grid2.COLUMN7.CONTROLSOURCE='P12.F12'            
       THISFORM.KEY_LIST.INTERACTIVECHANGE
           THISFORM.PAGEFRAME1.ACTIVEPAGE=1
           THISFORM.REFRESH
           thisform.grid1.setfocus        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. P12_1.F10<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. P12_1.F10<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
       ENDIF          
*!*            THISFORM.KEY_LIST.DISPLAYVALUE='依進貨單號排列'      
*!*            JK='訂單編號'
*!*            SELE P12_1
*!*            THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P12_1.F01    
*       THISFORM.REFRESH       
  ENDPROC
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P12_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=P12_1.F07
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=P12_1.F05
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=D01.F04
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=P12_1.F20
       THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE=P12_1.F21       
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=P12_1.F02
       THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=P12_1.F10
       THISFORM.PAGEFRAME1.PAGE1.LBLF121.CAPTION=P12_1.F12
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=P12_1.F90
       THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(P12_1.F22='21','三聯式',IIF(P12_1.F22='22','二聯式',''))
       THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=IIF(P12_1.F23='1','應稅',IIF(P12_1.F23='2','零稅',IIF(P12_1.F23='3','免稅','')))
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. P12_1.F10<>'2'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. P12_1.F10<>'2' &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED=IIF(P12_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED    
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(P12_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)                          
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=P12.F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=P12.F09   
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=P12.F04       
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=P12.F15
       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=P12.F16
       THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=P12.F18       
       THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=P12.F17
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=P12.F08
       THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=F12    
       THISFORM.PAGEFRAME1.PAGE2.LBLTTL1.CAPTION=TRANSFORM(ROUND(P12.F04*P12.F17*P12.F18,INT_068),'999999999999.99')
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       if thisform.pageframe1.activepage=1
          thisform. CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       thisform.refresh
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.VRT_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
*       IF INT_099=.T.
          HD='P002 '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          DO ODR_CRT 
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
          thisform.PAGEFRAME1.PAGE1.txtf01.readonly=.t.
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
*       ELSE
*          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
*          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS   
*       ENDIF           
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.        
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.F.        
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE='I000'
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=INT_117
        THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE=''
        IF INT_058=.F.  &&如果預設不帶入發票管理
            THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
            THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
            THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1            
            THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1            
        ENDIF
        THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE=''                
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)
        THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14'),A14.F02,'')
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'D01'),D01.F04,'')
        THISFORM.PAGEFRAME1.PAGE1.LBLF101.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF121.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''                
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
        THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)
        THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=INT_011
        THISFORM.PAGEFRAME1.PAGE2.CRCY.ENABLED=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)
        THISFORM.PAGEFRAME1.PAGE2.TXTF16.READONLY=IIF(A02.F08='*',.F.,.T.)
        THISFORM.PAGEFRAME1.PAGE2.TXTF17.READONLY=IIF(A02.F08='*',.F.,.T.)   
        THISFORM.PAGEFRAME1.PAGE2.TXTF18.READONLY=IIF(A02.F08='*',.F.,.T.)
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''          
        THISFORM.PAGEFRAME1.PAGE2.lblF031.caption=''                  
        THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=''               
        THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE                
        THISFORM.PAGEFRAME1.PAGE2.LBLTTL1.CAPTION=''
     ENDIF   
  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.VRT_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE P12_1
        PO_NO=P12_1.F01
        SELE RECNO() FROM P12 WHERE P12.F01=PO_NO AND F10<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'P12')
           LL1=RLOCK(KK1,'P12')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE P12_1           
           UNLOCK ALL
           REPL F10 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
            THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
            THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
            THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.
            THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.F.
             IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_058=.F. &&如果有發票號碼或預設不帶入發票管理
                 THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
                 THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=IIF(F22='21',1,2)
                 THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.          
                 DO CASE
                       CASE F23='1'
                                 THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1
                       CASE F23='2'
                                 THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=2
                       CASE F23='3'
                                  THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=3
                 ENDCASE                                                    
            ENDIF   
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
        ELSE 
           DO file_impact
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        endif   
     ELSE                         
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.         
        SELE P12                                                      &&處理表身修改
        SELE RECNO() FROM D07 WHERE F01=P12.F09 AND F02=P12.F03 INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'D07')
           LL1=RLOCK(KK1,'D07')
        ELSE
           LL1=.T.   
        ENDIF 
           SELE P04
           SEEK P12.F09+P12.F03
           IF FOUND()
              RLOCK()
              LL2=RLOCK()
           ELSE
              LL2=.T.   
           ENDIF  
        IF RLOCK('P12') .AND. LL1=.T. .AND. LL2=.T.                                               
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)           
           THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE
           THISFORM.PAGEFRAME1.PAGE2.CRCY.ENABLED=IIF(A02.F10='*',IIF(A02.F08='*',.T.,.F.),.F.)           
*           THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.F.
*           THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF16.READONLY=IIF(A02.F08='*',.F.,.T.)
           THISFORM.PAGEFRAME1.PAGE2.TXTF17.READONLY=IIF(A02.F08='*',.F.,.T.)   
           THISFORM.PAGEFRAME1.PAGE2.TXTF18.READONLY=IIF(A02.F08='*',.F.,.T.)           
*           THISFORM.PAGEFRAME1.PAGE2.TXTF07.READONLY=EMPTY(A02.F09)            
           THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
        ELSE  
           DO file_impact 
           unlock all
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       endif        
     ENDIF   
     RELEASE ALL LIKE BK*
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6            
          if ALIA()='P12_1'           &&刪除整張訂單
             SELE P12_1             
                PO_NO=P12_1.F01
                SELE RECNO() FROM P12 WHERE P12.F01=PO_NO  AND P12.F10<>'2' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'P12')
                   LL1=RLOCK(KK1,'P12')
                ELSE
                   LL1=.T.   
                ENDIF                   
                SELE RECNO() FROM D07 WHERE F01= ANY (SELE F09 FROM P12 WHERE F01=PO_NO) INTO ARRAY BK2
                JJ2=''                
                IF _TALLY>0                   
                    FOR I= 1 TO ALEN(BK2)
                        JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                    ENDFOR  
                    KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
                    RLOCK(KK2,'D07')
                    LL2=RLOCK(KK2,'D07')
                ELSE
                   LL2=.T.   
                ENDIF   
                SELE RECNO() FROM P04 WHERE F01+F02=ANY (SELE F09+F03 FROM P12 WHERE F01=PO_NO) INTO ARRAY BK3
                JJ3=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK3)
                       JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
                   ENDFOR    
                   KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
                   RLOCK(KK3,'P04')
                   LL3=RLOCK(KK3,'P04')
                ELSE
                   LL3=.T.   
                ENDIF                   
                IF LL1 .AND. LL1 .AND. LL2 .AND. LL3=.T.
                   IF LEN(ALLTRIM(JJ1))>0 
                      SELE P12
                      FOR I= 1 TO ALEN(BK1)
                          GO BK1(I) 
                          SELE D07
                          SET ORDER TO D077                   
                          SEEK P12.F09+P12.F03
                            IF FOUND()
                               QTY=P12.F04
                               DO WHILE F01+F02=P12.F09+P12.F03 
                                  IF F06=0
                                     SKIP
                                  ELSE
                                     IF QTY>F06
                                        QTY=QTY+F06*(-1)
                                        REPL F06 WITH 0
                                        SKIP
                                     ELSE
                                        REPL F06 WITH F06+QTY*(-1)
                                        EXIT
                                     ENDIF  
                                  ENDIF                    
                               ENDDO                                  
                            ENDIF                                 
                            SELE P04
                            SEEK P12.F09+P12.F03
                            IF FOUND()
                                REPL F18 WITH F18+(P12.F04)*(-1)
                            ENDIF    
                            SELE P12
                       ENDFOR                      
                   ELSE
                      =MESSAGEBOX('此張單據已由別的工作站過帳中,無法刪除!',0+64,'提示訊息視窗')
                      SELE P12_1
                      REPL F10 WITH '2'
                      UNLOCK ALL
                      RETURN   
                   ENDIF    
                   DELE FROM P12 WHERE P12.F01=PO_NO
                   SELE B39                     &&刪除未過帳單據紀錄
                   SEEK A02.F03+P12_1.F01                   
                   IF FOUND()
                      DELE
                   ENDIF   
                   SELE P12_1
                   DELE
                   UNLOCK ALL
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      DO ODR_RJT
                  ENDIF  
                ELSE
                   DO file_impact                  
                ENDIF
             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
                THISFORM.VRT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. P12_1.F10<>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. P12_1.F10<>'2' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(P12_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED   
                THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(P12_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)                                          
             ENDIF     
          ELSE        
              SELE P12                                                      &&刪除單筆資料及其進貨計劃        
              SELE RECNO() FROM D07 WHERE F01=P12.F09 AND F02=P12.F03 INTO ARRAY BK1
              JJ1=''                
                IF _TALLY>0                   
                    FOR I= 1 TO ALEN(BK1)
                        JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                    ENDFOR  
                    KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
                    RLOCK(KK1,'D07')
                    LL1=RLOCK(KK1,'D07')
                ELSE
                   LL1=.T.   
                ENDIF 
                SELE P04
                SEEK P12.F09+P12.F03
                IF FOUND()
                   RLOCK()
                   LL2=RLOCK()
                ELSE
                   LL2=.T.   
                ENDIF  
                 IF RLOCK('P12') .AND. LL1=.T. .AND. LL2=.T.
                    IF LEN(ALLTRIM(JJ1))>0
                       SELE D07
                       SET ORDER TO D077
                       SEEK P12.F09+P12.F03
                       IF FOUND()
                          QTY=P12.F04
                          DO WHILE F01+F02=P12.F09+P12.F03 
                             IF F06=0
                                SKIP
                             ELSE
                                IF QTY>F06
                                   QTY=QTY+F06*(-1)
                                   REPL F06 WITH 0
                                   SKIP
                                ELSE
                                   REPL F06 WITH F06+QTY*(-1)
                                   EXIT
                                ENDIF  
                             ENDIF                    
                           ENDDO                                  
                        ENDIF                                 
                     ENDIF                        
                     SELE P04
                     SEEK P12.F09+P12.F03
                     IF FOUND()
                        REPL F18 WITH F18+(P12.F04)*(-1)
                     ENDIF                       
                     SELE P12
                     DELE
                     SKIP -1
                     IF BOF()
                        GO TOP
                     ENDIF   
                  ELSE
                    DO file_impact                  
                  ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                 SELE B39                           &&刪除未過帳單據紀錄       
                 SEEK A02.F03+P12_1.F01
                 IF FOUND()
                    DELE
                 ENDIF                    
                 SELE P12_1                        
                 PO_NO=P12_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                     HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                     DO ODR_RJT
                 ENDIF
                 SELE P12_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF   
       RELEASE ALL LIKE BK*
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='P12'
       THISFORM.GRID2.CHILDORDER=P121
           THISFORM.grid2.COLUMN1.CONTROLSOURCE='P12.F03'
           THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
           THISFORM.grid2.COLUMN3.CONTROLSOURCE='P12.F09'
           THISFORM.grid2.COLUMN4.CONTROLSOURCE='P12.F04'
           THISFORM.grid2.COLUMN5.CONTROLSOURCE='P12.F15'
           THISFORM.grid2.COLUMN7.CONTROLSOURCE='P12.F12'       
       SELE P12_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'P12')=.T.   &&如果單號重覆
             SELE MAX(F01) FROM P12 INTO ARRAY GB NOWAIT
             HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
             DO ODR_RPT
             THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
             THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH                                           
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'D01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE)
          =MESSAGEBOX('廠商基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       SELE RECNO() FROM D07 WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE AND F04>F06 INTO ARRAY RC1
       IF _TALLY=0       
          IF ALLTRIM(A02.F09)='*'
             IF MESSAGEBOX('此廠商已無訂單可出,是否要以無訂單進貨?',4+16+0,'請確定')<>6
                THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS                          
                SET ORDER TO &COD
                RETURN                           
             ENDIF             
          ELSE
             =MESSAGEBOX('此廠商已無訂單可進貨且你沒有無訂單進貨的權限!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS             
             SET ORDER TO &COD
             RETURN                        
          ENDIF   
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
          =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('進貨日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF   
       SELE P12_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE    
          IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_058=.F.   &&如果有發票號碼或預設不帶入發票管理
             REPL F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'21','22')
             REPL F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))   
          ENDIF
          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                              
       ENDIF
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       SELE B39
       APPEND BLANK
       REPL F01 WITH A02.F03
       REPL F02 WITH P12_1.F01
       REPL F03 WITH P12_1.F02
       REPL F04 WITH P12_1.F07
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE                                                             &&表身新增確認
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       IF ALLTRIM(A02.F09)<>'*' .AND. EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)
          =MESSAGEBOX('您沒有無訂單進貨的權限!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE;
          +THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE,'P12')=.T. 
          =MESSAGEBOX('此訂單號碼及料號在此張進貨單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF09.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN            
       ENDIF           
       IF ALLTRIM(A02.F09)<>'*' .OR. !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)    &&如果沒有無訂單進貨的權限或訂單號碼欄不為空白才做以下判斷
          IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'D07')=.F.          
             =MESSAGEBOX('進貨計劃無此筆資料!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
             RETURN
          ENDIF   
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),;
             P04.F09-P04.F18,0)
             =MESSAGEBOX('計價量不得大於未進貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),;
             P04.F09-P04.F18,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF
      ENDIF    
      SELE P04                                                                                        &&寫入訂單表身
      SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
      IF FOUND()
         IF RLOCK()
            REPLACE F18 WITH F18+THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
         ELSE
            DO file_impact
            RETURN  
         ENDIF   
      ENDIF   

       SELE P12
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION
          REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE                                         
          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F13 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F26,'N')
          REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE          
          REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE
          REPLACE F17 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE          
          REPLACE F18 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE    
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                    
          REPLACE F22 WITH P12_1.F22
          REPLACE F23 WITH P12_1.F23
      ENDIF
      UNLOCK ALL         
      seek thisform.pageframe1.page1.txtf01.value+thisform.pageframe1.page2.txtf03.value+thisform.pageframe1.page2.txtf09.value                                    
      thisform.grid2.enabled=.t.
      thisform.grid2.setfocus  
      SELE D07                 
      SET ORDER TO D074                                                         &&寫入進貨計劃
      SEEK P12.F09+P12.F03
      IF FOUND()
         QTY=P12.F04
         DO WHILE F01+F02=P12.F09+P12.F03 
            IF F04-F06=0
               SKIP
            ELSE
               IF QTY>F04-F06
                  QTY=QTY+(F04-F06)*(-1)
                  REPL F06 WITH F04
                  SKIP
               ELSE
                  REPL F06 WITH F06+QTY
                  EXIT
               ENDIF  
            ENDIF                    
         ENDDO   
      ENDIF   
      THISFORM.ORPGROUP.NEW_BOTT.CLICK                        
    ENDIF
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('進貨日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
           SELE P12
           SEEK P12_1.F01
           IF FOUND()
              DO WHILE F01=P12_1.F01
                 REPL F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
                 REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
                 REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                 
                 REPL F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE
                 REPL F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE
                 IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_058=.F.  &&如果有發票號碼或預設不帶入發票管理
                    REPL F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'21','22')
                    REPL F23 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE))   
                ELSE
                    REPL F22 WITH ''
                    REPL F23 WITH ''    
                ENDIF
                REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                    
                 SKIP
              ENDDO    
           ENDIF        
           SELE P12_1
*        IF RLOCK() 
           REPL F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
           REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           IF LEN(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE))=10 OR INT_058=.F.  &&如果有發票號碼或預設不帶入發票管理           
               REPLACE  F22 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VALUE=1,'21','22')
               DO CASE
                 CASE THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=1
                      REPLACE  F23 WITH '1'
                 CASE THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=2
                      REPLACE  F23 WITH '2'
                 CASE THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VALUE=3
                      REPLACE  F23 WITH '3'
              ENDCASE
           ELSE
              REPL F22 WITH ''
              REPL F23 WITH ''   
           ENDIF           
           REPL F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE
           REPL F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                      
           REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           UNLOCK ALL
*        ELSE
*           DO file_impact
*          return   
*       ENDIF    
     ELSE                                                        &&表身修改確認     
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE<>P12.F03+P12.F09
             IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE;
                +THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE,'P12')=.T.            
                =MESSAGEBOX('此訂單號碼及料號在此張進貨單重複!',0+48,'提示訊息視窗')
                THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
                RETURN            
             ENDIF    
          ENDIF           
       IF ALLTRIM(A02.F09)<>'*'  .OR. !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)  &&如果沒有無訂單進貨的權限才做以下判斷
          IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'D07')=.F.             
             =MESSAGEBOX('進貨計劃無此筆資料!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
             RETURN
          ENDIF   
          IF THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE>;
             IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),;
             P04.F09-P04.F18+P12.F04,0)
             =MESSAGEBOX('計價量不得大於未進貨數量';
             +ALLTRIM(STR(IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),;
             P04.F09-P04.F18+P12.F04,0))),0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE2.TXTF04.SETFOCUS
             RETURN
          ENDIF          
       ENDIF   
       SELE P04
       SEEK P12.F09+P12.F03
*       IF RLOCK('P12') .AND. RLOCK('P04')      
*       IF RLOCK()
          SELE D07                 
          SET ORDER TO D077                                                          &&寫入進貨計劃
          SEEK P12.F09+P12.F03
          IF FOUND()
             QTY=P12.F04
             DO WHILE F01+F02=P12.F09+P12.F03 
                IF F06=0
                   SKIP
                ELSE
                   IF QTY>F06
                      QTY=QTY+F06*(-1)
                      REPL F06 WITH 0
                      SKIP
                   ELSE
                      REPL F06 WITH F06+QTY*(-1)
                      EXIT
                   ENDIF  
                ENDIF                    
             ENDDO   
          ENDIF                          
          SELE P04                                                              &&將訂單檔回復成為輸入前之狀態
          SEEK P12.F09+P12.F03
          IF FOUND()
             REPLACE F18 WITH F18+(P12.F04)*(-1)
          ENDIF   
           SELE P12                    
           REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
           REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE
           REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION           
           REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE
           REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                      
           REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE
           REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE
           REPLACE F17 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE
           REPLACE F18 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE
           SELE P04                                                                 &&寫回訂單檔    
           SEEK P12.F09+P12.F03
           IF FOUND()
              REPLACE F18 WITH F18+P12.F04
           ENDIF    
          SELE D07                 
          SET ORDER TO D074                                                          &&寫入進貨計劃
          SEEK P12.F09+P12.F03
          IF FOUND()
             QTY=P12.F04
             DO WHILE F01+F02=P12.F09+P12.F03 
                IF F04-F06=0
                  SKIP
                ELSE
                   IF QTY>F04-F06
                      QTY=QTY+(F04-F06)*(-1)
                      REPL F06 WITH F04
                      SKIP
                   ELSE
                      REPL F06 WITH F06+QTY
                      EXIT
                   ENDIF  
                ENDIF                    
             ENDDO   
          ENDIF                                    
          UNLOCK ALL
 *      ELSE
*         DO file_impact
*          return   
*       ENDIF   
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF20.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.TXTF03.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.T.    
      THISFORM.PAGEFRAME1.PAGE2.TXTF04.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.CRCY.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1     
          THISFORM.grid1.ENABLED=.T.
          THISFORM.grid2.ENABLED=.T. 
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
      ELSE
          THISFORM.grid1.ENABLED=.F.
          THISFORM.grid2.ENABLED=.T. 
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
            HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
            DO ODR_RJT     
            SELE B39
            SEEK A02.F03+P12_1.F01
            SET ORDER TO 1
            IF FOUND()
               DELE            
            ENDIF   
            SELE P12_1
            DELE
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH  
         ELSE
            SELE B39
            SET ORDER TO 1
            SEEK A02.F03+P12_1.F01 
            IF FOUND()
               REPL F08 WITH P12.F09            
            ENDIF   
         ENDIF   
      ENDIF       
      UNLOCK ALL
      THISFORM.ANS_BOTT.ENABLED=IIF(P12_1.F10='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED      
      THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(P12_1.F10),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)                             
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'P12'
            THISFORM.GRID2.RECORDSOURCE='P12'
            THISFORM.GRID2.CHILDORDER=P121
            THISFORM.grid2.COLUMN1.CONTROLSOURCE='P12.F03'
            THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
            THISFORM.grid2.COLUMN3.CONTROLSOURCE='P12.F09'
            THISFORM.grid2.COLUMN4.CONTROLSOURCE='P12.F04'
            THISFORM.grid2.COLUMN5.CONTROLSOURCE='P12.F15'
            THISFORM.grid2.COLUMN7.CONTROLSOURCE='P12.F12'         
          ENDIF   
          IF INT_099=.T.      
                HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                DO ODR_RJT
          ENDIF   
          SELE P12_1
          DO CASE 
             CASE THISFORM.KEY_LIST.DISPLAYVALUE='依進貨單號排列'
                  SET ORDER TO 1
             CASE THISFORM.KEY_LIST.DISPLAYVALUE='依廠商邊號排列'
                  SET ORDER TO 2
             CASE THISFORM.KEY_LIST.DISPLAYVALUE='依收料部門排列'
                  SET ORDER TO 3
          ENDCASE   
      ENDIF  
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK     &&過帳程序
       IF MESSAGEBOX('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	     
          ORGDTE=CTOD('')          
          SELE RECNO() FROM P12 WHERE P12.F01=P12_1.F01 AND F10<>'2' INTO ARRAY BK1              
               JJ1=''                
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK1)
                      JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                  ENDFOR    
                  KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                  RLOCK(KK1,'P12')
                  LL1=RLOCK(KK1,'P12')
               ELSE
                  LL1=.T.   
               ENDIF                   
               SELE RECNO() FROM D07 WHERE F01= ANY (SELE F09 FROM P12 WHERE F01=P12_1.F01) INTO ARRAY BK2
               JJ2=''                
               IF _TALLY>0                   
                  FOR I= 1 TO ALEN(BK2)
                      JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                  ENDFOR  
                  KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
                  RLOCK(KK2,'D07')
                  LL2=RLOCK(KK2,'D07')
               ELSE
                  LL2=.T.   
               ENDIF   
*!*	               SELE RECNO() FROM P04 WHERE F01+F02=ANY (SELE F09+F03 FROM P12 WHERE F01=P12_1.F01) INTO ARRAY BK3
*!*	               JJ3=''                
*!*	               IF _TALLY>0   
*!*	                  FOR I= 1 TO ALEN(BK3)
*!*	                      JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
*!*	                  ENDFOR    
*!*	                  KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
*!*	                  RLOCK(KK3,'P04')
*!*	                  LL3=RLOCK(KK3,'P04')
*!*	               ELSE
                  LL3=.T.   
*!*	               ENDIF                   
*!*	               SELE RECNO() FROM P03 WHERE F02=ANY (SELE F09 FROM P12 WHERE F01=P12_1.F01) INTO ARRAY BK4
*!*	               JJ4=''
*!*	               IF _TALLY>0   
*!*	                  FOR I= 1 TO ALEN(BK4)
*!*	                      JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
*!*	                  ENDFOR    
*!*	                  KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')              
*!*	                  RLOCK(KK4,'P03')
*!*	                  LL4=RLOCK(KK4,'P03')
*!*	               ELSE
                  LL4=.T.   
*!*	               ENDIF     
               SELE RECNO() FROM D01 WHERE F01=P12_1.F07 INTO ARRAY BK5
               JJ5=''
               IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK5)
                      JJ5=JJ5+ALLTRIM(STR(BK5(I)))+','
                  ENDFOR    
                  KK5=STUFF(JJ5,RAT(',',JJ5,1),1,'')              
                  RLOCK(KK5,'D01')
                  LL5=RLOCK(KK5,'D01')
               ELSE
                  LL5=.T.   
               ENDIF                   
               IF LL1 .AND. LL1 .AND. LL2 .AND. LL3 .AND. LL4 .AND. LL5 =.T. 
                  IF LEN(ALLTRIM(JJ1))>0 
                     IF !USED('E08')
                        SELECT 0
                        USE E08
                     ELSE
                        SELECT E08
                     ENDIF
                     SET ORDER TO E083      
                     SELE P12
                     TQTY=0
                     FTTL=0
                     FOR I= 1 TO ALEN(BK1)                      
                         GO BK1(I) 
                         IF P12.F13<>'Y'                               &&如果不需要檢驗才直接做庫存運算                      
                            TQTY=TQTY+ROUND(IIF(F18=1,F04*F17,F04*F17*F18),INT_068)
                            FTTL=FTTL+ROUND(F04*F17,2)
                            SELE B01                                            &&物料基本主檔
                            SEEK P12.F03
                            IF FOUND()
                               IF !EMPTY(F98)                                   &&如果不是虛擬料號才做庫存運算                     
                                  SELE B11                                            &&部門庫存明細檔 
                                  SEEK P12.F05+P12.F03+IIF(INT_028 AND B01.F98<>'A  ',IIF(SEEK(P12.F09+P12.F03,'D07','D074'),D07.F16,SPACE(5)),SPACE(5))
                                  IF FOUND()
                                     REPL F04 WITH F04+(P12.F04+P12.F15)
                                     IF F04=0
                                        DELE 
                                     ELSE   
                                        IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))
                                           REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))
                                           REPL F06 WITH P12.F08
                                        ENDIF
                                     ENDIF   
                                  ELSE
                                     APPEND BLANK
                                     REPL F01 WITH P12.F05
                                     REPL F03 WITH P12.F03
                                     REPL F04 WITH (P12.F04+P12.F15)
                                     REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))
                                     REPL F06 WITH P12.F08                                     
                                     IF INT_028 AND B01.F98<>'A  '
                                         REPLACE F08 WITH IIF(SEEK(P12.F09+P12.F03,'D07','D074'),D07.F16,SPACE(5))
                                     ENDIF
                                  ENDIF   
                                  SELE B25                                             &&分部門庫存月報表 
                                  SEEK P12.F05+P12.F03
                                  IF FOUND()
                                     REPL F04 WITH F04+P12.F04+P12.F15
                                     REPL F15 WITH F15+(P12.F04+P12.F15)
                                  ELSE
                                     APPEND BLANK
                                     REPL F01 WITH P12.F05
                                     REPL F02 WITH P12.F03
                                     REPL F04 WITH P12.F04+P12.F15
                                     REPL F15 WITH (P12.F04+P12.F15)                                                  
                                  ENDIF   
                                  SELE B26                                            &&庫存異動紀錄
                                  APPEND BLANK
                                  REPL F01 WITH P12.F03
                                  REPL F02 WITH P12.F05
                                  REPL F03 WITH P12.F02
                                  REPL F04 WITH (P12.F04+P12.F15)
                                  REPL F06 WITH 'A'
                                  REPL F07 WITH P12.F01
                                  REPL F08 WITH '採'+P12.F09+IIF(EMPTY(P12.F08),'','請'+P12.F08)
                               ENDIF
                            ENDIF   
                            TRANS_STYLE=''
                            SELE D07                                            &&進貨計劃
                            SET ORDER TO D074                 
                            SEEK P12.F09+P12.F03
                            IF FOUND()
                               ORGDTE=D07.F03                            
                               QTY=P12.F04
                               TRANS_STYLE=ALLTRIM(D07.F13)   &&運貨方式
                               CUS_NO=D07.F16                 &&請購需求客戶編號
                               DO WHILE F01+F02=P12.F09+P12.F03 
                                  DO CASE
                                     CASE QTY=F06
                                          SELE D07
                                          REPL F04 WITH F04+F06*(-1)
                                          REPL F06 WITH F06+QTY*(-1)
                                          IF F04=0
                                             DELE
                                          ENDIF   
                                          EXIT                                  
                                     CASE QTY>F06 
                                          SELE D07                              
                                          QTY=QTY+F06*(-1)
                                          DELE     
                                          SKIP
                                     CASE QTY<F06
                                          SELE D07                               
                                          REPL F04 WITH F04+QTY*(-1)
                                          REPL F06 WITH F06+QTY*(-1)
                                          EXIT                                     
                                  ENDCASE    
                               ENDDO               
                               SELECT E08
                               SEEK P12.F03
                               IF FOUND()
                                  REPLACE F20 WITH F20+P12.F04*(-1)
                               ELSE
                                  APPEND BLANK
                                  REPLACE F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02)
                                  REPLACE F02 WITH P12.F03
                                  REPLACE F20 WITH P12.F04*(-1)
                               ENDIF                   
                            ENDIF                                 
                            SELE D10         &&進貨紀錄
                            APPEND BLANK
                            REPLACE  F01 WITH P12.F09
                            REPLACE  F02 WITH P12.F03
                            REPLACE  F03 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02)
                            REPLACE  F04 WITH P12.F01
                            REPLACE  F05 WITH P12.F04
                            REPLACE  F06 WITH ALLTRIM(TRANS_STYLE)
                            SELE D11         &&進貨日報表
                            APPEND BLANK
                            REPLACE F01 WITH P12.F02
                            REPLACE F02 WITH P12.F07
                            REPLACE F03 WITH P12.F03
                            REPLACE F04 WITH P12.F01
                            REPLACE F05 WITH P12.F09
                            REPLACE F06 WITH INT_011
                            REPLACE F07 WITH ROUND(IIF(P12.F18=1,P12.F04*P12.F17,P12.F04*P12.F17*P12.F18),INT_068)/(P12.F04+P12.F15)
                            REPLACE F08 WITH P12.F04+P12.F15
                            REPLACE F09 WITH CUS_NO
                            REPLACE F10 WITH IIF(SEEK(F09,'C01','C011'),C01.F05,'')
                            IF ALLTRIM(INT_209) = 'A'
                                 REPL D11.F12 WITH IIF(EMPTY(D11.F09),'',IIF(INDEXSEEK(D11.F09,.T.,'C01','C011'),C01.F18,''))
                            ELSE
                                 REPL D11.F12 WITH IIF(EMPTY(D11.F09),'',IIF(INDEXSEEK(D11.F09,.T.,'C01','C011'),C01.F33,''))
                            ENDIF
                            REPL D11.F11 WITH IIF(SEEK(D11.F12,'A01'),A01.F03,'')
                            REPL D11.F13 WITH ALLTRIM(TRANS_STYLE)
                            IF P12.F02<=IIF(SEEK(P12.F07,'D01'),D01.F15,'')
                               SELE P19         &&鷹付帳款明細
                            ELSE
                               SELE P1I       &&鷹付帳款到下個月或暫存檔
                            ENDIF      
                            APPEND BLANK
                            REPL F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02)
                            REPL F02 WITH P12.F01
                            REPL F03 WITH P12.F07
                            REPL F04 WITH P12.F09
                            REPL F05 WITH P12.F03
                            REPL F06 WITH P12.F04+P12.F15
                            REPL F07 WITH (P12.F04*P12.F17)/(P12.F04+P12.F15)
                            REPL F08 WITH ROUND(IIF(P12.F18=1,P12.F04*P12.F17,P12.F04*P12.F17*P12.F18),INT_068)
                            REPL F09 WITH IIF(SEEK(P12.F07,'D01'),D01.F13,'1')
                            REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                            REPL F13 WITH P12.F16
                            REPL F14 WITH P12.F18
                            REPL F17 WITH IIF(!EMPTY(P12.F21),'備註:'+P12.F21,'')+IIF(!EMPTY(P12.F20),'發票:'+P12.F20,'')
                            REPL F19 WITH IIF(P12.F22='22' .AND. P12.F23='1','02','00')     &&若為進項二聯式應稅,則特別註明                                                 
                            REPL F20 WITH P12.F20
                            REPL F22 WITH ORGDTE
                            SELE P04           &&訂單表身
                            SEEK P12.F09+P12.F03
                            IF FOUND()
                               REPL F08 WITH F08+P12.F04
                               REPL F09 WITH F09+(P12.F04)*(-1)
                               REPL F18 WITH F18+(P12.F04)*(-1)
                            ENDIF    
                            SELE P03          &&訂單表頭
                            SEEK P12.F09
                            IF FOUND()
                               IF F08<>.T. 
                                  REPL F08 WITH .T.
                               ENDIF   
                            ENDIF 
                         ELSE                              &&需要檢驗
                            ORGDTE=IIF(SEEK(P12.F09+P12.F03,'D07','D074'),D07.F03,CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))                         
                            SELE H01
                            APPEND BLANK
                            REPLACE F01 WITH P12.F03
                            REPLACE F03 WITH P12.F01
                            REPLACE F04 WITH P12.F07
                            REPLACE F06 WITH P12.F04
                            REPLACE F10 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02)
                            REPLACE F11 WITH P12.F09
                            REPLACE F12 WITH P12.F08
                            REPLACE F13 WITH P12.F15
                            REPLACE F15 WITH P12.F16
                            REPLACE F16 WITH (P12.F04*P12.F17)/(P12.F04+P12.F15)
                            REPLACE F17 WITH P12.F18
                            REPLACE F19 WITH IIF(P12.F22='22' .AND. P12.F23='1','02','00')                                                     
                            REPLACE F20 WITH ORGDTE
                         ENDIF                                 
                         SELE P12
                         CHK_NAME=P12.F12
                         REPL F10 WITH '2'
                         REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                         REPL F19 WITH ORGDTE
                    ENDFOR   
                    SELECT E08
                    USE
                    IF LEN(ALLTRIM(P12_1.F20))=10  AND TQTY>0   AND INT_058=.T.     &&如果有發票號碼且預設帶入發票管理
                       IF P12_1.F23='1'                   &&且應稅再加入應付帳款中 
                          IF P12.F02<=IIF(SEEK(P12.F07,'D01'),D01.F15,'')
                             SELE P19         &&鷹付帳款明細
                          ELSE
                             SELE P1I       &&鷹付帳款到下個月或暫存檔
                          ENDIF                          
                          APPEND BLANK
                          REPL F01 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12_1.F02)
                          REPL F02 WITH P12_1.F01
                          REPL F03 WITH P12_1.F07
                          REPL F04 WITH '稅額'
                          REPL F05 WITH '發票:'+P12_1.F20
                          REPL F06 WITH 1
                          REPL F07 WITH ROUND(TQTY*INT_002/100,INT_068)
                          REPL F08 WITH ROUND(TQTY*INT_002/100,INT_068)
                          REPL F09 WITH IIF(SEEK(P12_1.F07,'D01'),D01.F13,'1')
                          REPL F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                          REPL F13 WITH INT_011
                          REPL F14 WITH 1
                          REPL F20 WITH P12_1.F20
                       ENDIF
                       IF P12_1.F02<=IIF(SEEK(P12_1.F07,'D01'),D01.F15,'')
                          SELE K25         &&發票明細檔
                       ELSE
                          SELE K2E       &&發票明細到下個月或暫存檔
                       ENDIF                          
                       APPEND BLANK
                       REPL F01 WITH P12_1.F22
                       IF P12_1.F02<=IIF(SEEK(P12_1.F07,'D01'),D01.F15,'')
                          REPL F02 WITH P12.F02
                          REPL F19 WITH THISFORM.MTH_LIST.DISPLAYVALUE                       
                       ELSE
                          REPL F02 WITH '01'
                          LON1=PADL(ALLTRIM(STR(VAL(RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2))+1)),2,'0')
                          LON2=IIF(LON1>'12',PADL(ALLTRIM(STR(VAL(RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,4))+1)),4,'0')+'/01',LEFT(THISFORM.MTH_LIST.DISPLAYVALUE,5)+LON1)
                          REPLACE F19 WITH LON2
                       ENDIF                                                                  
                       REPL F03 WITH P12_1.F07
                       REPL F04 WITH IIF(SEEK(P12.F07,'D01'),D01.F06,'')
                       REPL F07 WITH P12_1.F20
                       REPL F08 WITH TQTY
                       REPL F09 WITH P12_1.F23
                       REPL F10 WITH ROUND(TQTY*INT_002/100,INT_068)*IIF(P12.F23='1',1,0)
                       REPL F12 WITH F08+F10
                       REPL F13 WITH '00'
                       REPL F15 WITH P12_1.F01+IIF(B01.F98='* *','商品','原料')                       
                       REPL F16 WITH '1'
                       REPL F18 WITH '01'
                       REPLACE F20 WITH ALLTRIM(P12.F21)  
                       REPLACE F21 WITH P12.F16      &&幣別
                       REPLACE F22 WITH P12.F18      &&匯率                    
                       REPLACE F23 WITH FTTL                       
                       REPL F24 WITH ALLTRIM(CHK_NAME)
                       *******以類別分類
                       IF P12_1.F02<=IIF(SEEK(P12_1.F07,'D01'),D01.F15,'')
                          SELE K24         &&發票明細檔
                       ELSE
                          SELE K2D       &&發票明細到下個月或暫存檔
                       ENDIF                          
                       SET ORDER TO 1
                       SEEK P12_1.F22
                       IF FOUND()      								             
                           REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0)) &&營業稅額 
                           IF P12_1.F22='21'                                          
                               REPLACE F03 WITH F03+TQTY         												&&銷售金額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0)))	&&發票總額									
                           ELSE
                               REPLACE F05 WITH F05+TQTY				 							               &&發票總額
                               REPLACE F03 WITH F03+(TQTY-(ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0)))    &&銷售金額                 			
                           ENDIF                              
                           DO CASE
                                  CASE  P12_1.F23='1'
                          		      REPLACE F06 WITH F06+1    &&應稅張數
                          	  CASE  P12_1.F23='2'
                          	 	      REPLACE F07 WITH F07+1    &&零稅張數
                          	  CASE  P12_1.F23='3'	      
                          	  	      REPLACE F08 WITH F08+1   &&免稅張數
                           ENDCASE		     
                       ELSE
                           APPEND BLANK 
                           REPLACE F01 WITH P12_1.F22
                           REPLACE F04 WITH ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0) &&營業稅額 
                           IF P12_1.F22='21'                                          
                               REPLACE F03 WITH TQTY         		   &&銷售金額
                               REPLACE F05 WITH F03+F04  &&發票總額									
                           ELSE
                               REPLACE F05 WITH TQTY			   &&發票總額
                               REPLACE F03 WITH F05-F04   &&銷售金額                 			
                           ENDIF                               
                           DO CASE
                                  CASE  P12_1.F23='1'
                          		      REPLACE F06 WITH 1   &&應稅張數
                          	  CASE  P12_1.F23='2'
                          	 	      REPLACE F07 WITH 1    &&零稅張數
                          	  CASE  P12_1.F23='3'	      
                          	  	      REPLACE F08 WITH 1   &&免稅張數
                           ENDCASE
                        ENDIF  
                       *******以對象編號分類
                       SET ORDER TO 2
                       SEEK P12_1.F07
                       IF FOUND()      
                           REPLACE F04 WITH F04+(ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0)) &&營業稅額 
                           IF P12_1.F22='21'                                          
                               REPLACE F03 WITH F03+TQTY         												&&銷售金額
                               REPLACE F05 WITH F05+(TQTY+(ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0)))	&&發票總額									
                           ELSE
                               REPLACE F05 WITH F05+TQTY				 							               &&發票總額
                               REPLACE F03 WITH F03+(TQTY-(ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0)))    &&銷售金額                 			
                           ENDIF                               
                           DO CASE
                                  CASE  P12_1.F23='1'
                          		      REPLACE F06 WITH F06+1    &&應稅張數
                          	  CASE  P12_1.F23='2'
                          	 	      REPLACE F07 WITH F07+1    &&零稅張數
                          	  CASE  P12_1.F23='3'	      
                          	  	      REPLACE F08 WITH F08+1   &&免稅張數
                           ENDCASE		     
                       ELSE
                           APPEND BLANK 
                           REPLACE F02 WITH P12_1.F07
                           REPLACE F04 WITH ROUND(TQTY*INT_002/100,INT_068)*IIF(P12_1.F23='1',1,0) &&營業稅額 
                           IF P12_1.F22='21'                                          
                               REPLACE F03 WITH TQTY         		   &&銷售金額
                               REPLACE F05 WITH  F03+F04  &&發票總額									
                           ELSE
                               REPLACE F05 WITH TQTY			   &&發票總額
                               REPLACE F03 WITH  F05-F04   &&銷售金額                 			
                           ENDIF                              
                           DO CASE
                                  CASE  P12_1.F23='1'
                          		      REPLACE F06 WITH 1   &&應稅張數
                          	  CASE  P12_1.F23='2'
                          	 	      REPLACE F07 WITH 1    &&零稅張數
                          	  CASE  P12_1.F23='3'	      
                          	  	      REPLACE F08 WITH 1   &&免稅張數
                           ENDCASE
                        ENDIF  
                        ***                     
                    ENDIF                                                   
                    SELE D01                     &&廠商基本主檔
                    SEEK P12_1.F07
                    IF FOUND()
                       IF F14<CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12_1.F02)
                          REPL F14 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12_1.F02)
                       ENDIF   
                    ENDIF                    
                    SELE B39                    &&未過帳庫存單據查詢檔
                    SEEK A02.F03+P12_1.F01
                    IF FOUND()
                       DELE
                    ENDIF                                          
                    SELE P12_1
                    REPL F10 WITH '2'
                    REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                  ELSE
                     =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                     SELE P12_1
                     REPL F10 WITH '2'
                  ENDIF           
                  THIS.ENABLED=.F.
                  THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                  THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
                  UNLOCK ALL
                  IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                     THISFORM.GRID1.SETFOCUS
                  ELSE
                      THISFORM.GRID2.SETFOCUS
                      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
                  ENDIF
                  THISFORM.REFRESH
               ELSE
                 DO file_impact
                 unlock all     
                 return
               ENDIF      
          SELECT P12_1    
          UNLOCK ALL
          RELEASE ALL LIKE BK*
       ENDIF   
  ENDPROC
  PROC VRT_BOTT.CLICK     &&反過帳程序  
    if messagebox('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	   
       SELECT P12
       SET RELATION OFF INTO B01
       SELE RECNO() FROM P12 WHERE P12.F01=P12_1.F01 AND F10='2' INTO ARRAY BK1              
            JJ1=''                
            IF _TALLY>0   
               FOR I= 1 TO ALEN(BK1)
                   JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   SELE P12
                   GO BK1(I)
                   IF P12.F13='Y'
                      SELE H01
                      SEEK P12.F03+P12.F01+P12.F09
                      IF FOUND()
                         IF F06-F05<>P12.F04+P12.F15                  
                            =MESSAGEBOX('H02待檢驗資料中尚有未從H06轉入之反過帳資料!,請先至H06反過帳刪除後再做此筆反過帳!',0+48,'提示訊息視窗')
                            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                            THISFORM.REFRESH                         
                            RETURN          
                         ENDIF                                              
                      ELSE
                         =MESSAGEBOX('H02待檢驗資料中尚有未從H06轉入之反過帳資料!,請先至H06反過帳刪除後再做此筆反過帳!',0+48,'提示訊息視窗')
                         THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                         THISFORM.REFRESH                         
                         RETURN                            
                      ENDIF
                   ENDIF
               ENDFOR    
               KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
               RLOCK(KK1,'P12')
               LL1=RLOCK(KK1,'P12')
            ELSE
               LL1=.T.   
            ENDIF                   
            SELE RECNO() FROM D07 WHERE F01+F02= ANY (SELE F09+F03 FROM P12 WHERE F01=P12_1.F01) INTO ARRAY BK2
            JJ2=''                
            IF _TALLY>0                   
               FOR I= 1 TO ALEN(BK2)
                   JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                ENDFOR  
                KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
                RLOCK(KK2,'D07')
                LL2=RLOCK(KK2,'D07')
            ELSE
               LL2=.T.   
            ENDIF   
*!*	            SELE RECNO() FROM P04 WHERE F01+F02=ANY (SELE F09+F03 FROM P12 WHERE F01=P12_1.F01) INTO ARRAY BK3
*!*	            JJ3=''                
*!*	            IF _TALLY>0   
*!*	               FOR I= 1 TO ALEN(BK3)
*!*	                   JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','
*!*	               ENDFOR    
*!*	               KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
*!*	               RLOCK(KK3,'P04')
*!*	               LL3=RLOCK(KK3,'P04')
*!*	            ELSE
               LL3=.T.   
*!*	            ENDIF                   
            SELE RECNO() FROM P19 WHERE F02=P12_1.F01 INTO ARRAY BK4
            JJ4=''                
            IF _TALLY>0   
               FOR I= 1 TO ALEN(BK4)
                   JJ4=JJ4+ALLTRIM(STR(BK4(I)))+','
               ENDFOR    
               KK4=STUFF(JJ4,RAT(',',JJ4,1),1,'')              
               RLOCK(KK4,'P19')
               LL4=RLOCK(KK4,'P19')
            ELSE
               LL4=.T.   
            ENDIF           
            SELE RECNO() FROM K25 WHERE LEFT(F15,10)=P12_1.F01 INTO ARRAY BK5
            JJ5=''                
            IF _TALLY>0   
               FOR I= 1 TO ALEN(BK5)
                   JJ5=JJ5+ALLTRIM(STR(BK5(I)))+','
               ENDFOR    
               KK5=STUFF(JJ5,RAT(',',JJ5,1),1,'')              
               RLOCK(KK5,'B25')
               LL5=RLOCK(KK5,'B25')
            ELSE
               LL5=.T.   
            ENDIF                                           
            IF LL1 .AND. LL2 .AND. LL3 .AND. LL4 .AND. LL5  =.T. 
               IF LEN(ALLTRIM(JJ1))>0 
                  IF !USED('E08')
                     SELECT 0
                     USE E08
                  ELSE
                     SELECT E08
                  ENDIF
                  SET ORDER TO E083      
                  SELE P12
                  TQTY=0
                  FOR I= 1 TO ALEN(BK1)                      
                      GO BK1(I) 
                      IF P12.F13<>'Y'                               &&如果不需要檢驗才直接做庫存運算  
                         SELE D07                                            &&進貨計劃
                         SET ORDER TO D074                 
                         SEEK P12.F09+P12.F03+DTOS(P12.F19)
                         IF FOUND()
                            REPLACE F04 WITH F04+(P12.F04)
                            REPLACE F06 WITH F06+(P12.F04)
                         ELSE 
                            SELE D07
                            APPEND BLANK
                            REPLACE F01 WITH P12.F09
                            REPLACE F02 WITH P12.F03
                            REPLACE F03 WITH P12.F19
                            REPLACE F04 WITH P12.F04
                            REPLACE F05 WITH P12.F07
                            REPLACE F06 WITH P12.F04
                            REPLACE F07 WITH P12.F08
                            REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                            REPLACE F09 WITH '1'
                            REPLACE F10 WITH IIF(SEEK(P12.F09+P12.F03,'P04'),P04.F13,'')
                            REPLACE F11 WITH P12.F19
                            REPLACE F13 WITH IIF(SEEK(P12.F09+P12.F01+P12.F03,'D11'),D11.F13,'')                            
                            REPLACE F16 WITH IIF(SEEK(P12.F09+P12.F01+P12.F03,'D11'),D11.F09,'')
                         ENDIF
                         SELECT E08
                         SEEK P12.F03
                         IF FOUND()
                            REPLACE F20 WITH F20+P12.F04
                         ELSE
                           APPEND BLANK
                           REPLACE F01 WITH D07.F03
                           REPLACE F02 WITH D07.F02
                           REPLACE F20 WITH P12.F04
                         ENDIF
                         SELE D11         &&進貨日報表
                         SEEK P12.F09+P12.F01+P12.F03
                         IF FOUND()
                            DELETE FOR F05+F04+F03=P12.F09+P12.F01+P12.F03
                         ENDIF    
                         
                         
                         SELE P04           &&訂單表身
                         SEEK P12.F09+P12.F03
                         IF FOUND()
                            REPL F08 WITH F08+(P12.F04)*(-1)
                            REPL F09 WITH F09+(P12.F04)
                            REPL F18 WITH F18+(P12.F04)
                         ENDIF               
                         SELE B01                                            &&物料基本主檔
                         SEEK P12.F03
                         IF FOUND()                                          &&物料基本主檔存在才做計算
                            IF !EMPTY(F98)                                   &&如果不是虛擬料號才做庫存運算                     
                               SELE B11                                            &&部門庫存明細檔 
                               SEEK P12.F05+P12.F03+IIF(INT_028 AND B01.F98<>'A  ',IIF(SEEK(P12.F09+P12.F03,'D07','D074'),D07.F16,SPACE(5)),SPACE(5))
                               IF FOUND()
                                  REPL F04 WITH F04+(P12.F04+P12.F15)*(-1)
                                  IF F04=0
                                     DELE
                                  ELSE   
                                     IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))
                                        REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))
                                        REPL F06 WITH P12.F08
                                     ENDIF
                                  ENDIF   
                               ELSE
                                  APPEND BLANK
                                  REPL F01 WITH P12.F05
                                  REPL F03 WITH P12.F03
                                  REPL F04 WITH (P12.F04+P12.F15)*(-1)
                                  REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+P12.F02))
                                  REPL F06 WITH P12.F08                           
                                  IF INT_028 AND B01.F98<>'A  '
                                     REPLACE F08 WITH IIF(SEEK(P12.F09+P12.F03,'D07','D074'),D07.F16,SPACE(5))
                                  ENDIF       
                               ENDIF   
                               SELE B25                                             &&分部門庫存月報表 
                               SEEK P12.F05+P12.F03
                               IF FOUND()
                                  REPL F04 WITH F04+(P12.F04+P12.F15)*(-1)
                                  REPL F15 WITH F15+(P12.F04+P12.F15)*(-1)
                               ELSE
                                  APPEND BLANK
                                  REPL F01 WITH P12.F05
                                  REPL F02 WITH P12.F03
                                  REPL F04 WITH (P12.F04+P12.F15)*(-1)
                                  REPL F15 WITH (P12.F04+P12.F15)*(-1)                                                  
                               ENDIF   
*!*	                               SELE B26                                            &&庫存異動紀錄
*!*	                               APPEND BLANK
*!*	                               REPL F01 WITH P12.F03
*!*	                               REPL F02 WITH P12.F05
*!*	                               REPL F03 WITH P12.F02
*!*	                               REPL F04 WITH (P12.F04+P12.F15)*(-1)
*!*	                               REPL F06 WITH 'A'
*!*	                               REPL F07 WITH P12.F01
*!*	                               REPL F08 WITH '反過帳'                              
                            ENDIF
                         ENDIF   

                      ELSE                                     &&需要檢驗
                         SELE H01
                         SEEK P12.F03+P12.F01+P12.F09
                         IF FOUND()
                            DELE
                         ENDIF    
                      ENDIF                                  
                      SELE P12
                      REPL F10 WITH ' '
                      REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                      
                 ENDFOR   
                 SELECT B26
                 DELETE FROM B26 WHERE F07=P12_1.F01
                 SELECT E08
                 USE
                         IF P12.F02<=IIF(SEEK(P12.F07,'D01'),D01.F15,'')
                            SELE P19         &&鷹付帳款明細
                         ELSE
                            SELE P1I       &&鷹付帳款到下個月或暫存檔
                         ENDIF      
                         DELE FOR F02=P12_1.F01                 
                         SELE D10         &&進貨紀錄
                         DELETE FOR F04=P12_1.F01                   
                 SELE B39                    &&未過帳庫存單據查詢檔
                 APPEND BLANK
                 REPL F01 WITH A02.F03
                 REPL F02 WITH P12_1.F01
                 REPL F03 WITH P12_1.F02
                 REPL F04 WITH P12_1.F07
                 REPL F07 WITH P12_1.F05                                               
                 SELE P12_1
                 REPL F10 WITH ''                 
                 REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                 IF LEN(ALLTRIM(P12_1.F20))=10          &&如果有發票號碼
                      IF P12_1.F02<=IIF(SEEK(P12_1.F07,'D01'),D01.F15,'')
                          K25Rec='K25'
                          SELECT  K25         &&發票明細檔
                      ELSE
                          K25Rec='K2E'
                          SELECT  K2E       &&發票明細到下個月或暫存檔
                      ENDIF                          
                      SET ORDER TO 4
                      SEEK P12_1.F22+P12_1.F20
                      IF FOUND()  
                           IF  &K25Rec..F16='3' .OR.  &K25Rec..F16='5'  
                                 =MESSAGEBOX('此發票已作帳款沖銷(應付),故發票部份無法作反過帳!',0+64,'提示訊息視窗')  
                           ELSE     
		                IF P12_1.F02<=IIF(SEEK(P12_1.F07,'D01'),D01.F15,'')
		                     K24Rec='K24'
		                     SELECT  K24         &&發票明細檔表頭
		                ELSE
		                     K24Rec='K2D'
		                     SELECT  K2D        &&發票明細到下個月或暫存檔表頭
		                ENDIF 
		                SELECT &K24Rec    			   
	                        SET ORDER TO 1
	                        SEEK &K25Rec..F01
	                        IF FOUND()        &&找類別
	                             REPLACE &K24Rec..F03 WITH &K24Rec..F03+&K25Rec..F08*(-1)    &&銷售金額
	                             REPLACE &K24Rec..F04 WITH &K24Rec..F04+&K25Rec..F10*(-1)    &&營業稅額
		                     REPLACE &K24Rec..F05 WITH &K24Rec..F05+&K25Rec..F12*(-1)    &&發票總額
	                             DO CASE
	                                   CASE  &K25Rec..F09='1' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
	                          	              REPLACE &K24Rec..F06 WITH &K24Rec..F06-1    &&應稅張數
	                          	   CASE  &K25Rec..F09='2' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
	                          	               REPLACE &K24Rec..F07 WITH &K24Rec..F07-1    &&零稅張數
	                          	   CASE  &K25Rec..F09='3' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'	      
	                          	       	        REPLACE &K24Rec..F08 WITH &K24Rec..F08-1   &&免稅張數
	                          	   CASE  &K25Rec..F16='2'	      
	                          	       	        REPLACE &K24Rec..F09 WITH &K24Rec..F09-1   &&作廢張數
	                          	   CASE  &K25Rec..F16='4'	      
	                          	       	        REPLACE &K24Rec..F10 WITH &K24Rec..F10-1   &&空白張數                          	       	                                  	       	        
	                              ENDCASE		                             
		                      IF  (&K24Rec..F03+&K24Rec..F04+&K24Rec..F05+&K24Rec..F06+&K24Rec..F07+&K24Rec..F08+&K24Rec..F09+&K24Rec..F10)=0
		                            SELECT &K24Rec
		                            DELETE 
		                      ENDIF
	                          ENDIF       
	                          SELECT &K24Rec
	                          SET ORDER TO 2
	                          SEEK &K25Rec..F03
	                          IF FOUND()        &&找對象
	                              REPLACE &K24Rec..F03 WITH &K24Rec..F03+&K25Rec..F08*(-1)    &&銷售金額
	                              REPLACE &K24Rec..F04 WITH &K24Rec..F04+&K25Rec..F10*(-1)    &&營業稅額
	                              REPLACE &K24Rec..F05 WITH &K24Rec..F05+&K25Rec..F12*(-1)    &&發票總額
	                              DO CASE
	                                    CASE  &K25Rec..F09='1' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
	                          	                REPLACE &K24Rec..F06 WITH &K24Rec..F06-1    &&應稅張數
	                          	    CASE  &K25Rec..F09='2' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'
	                          	                REPLACE &K24Rec..F07 WITH &K24Rec..F07-1    &&零稅張數
	                          	    CASE  &K25Rec..F09='3' .AND. &K25Rec..F16<>'2' .AND. &K25Rec..F16<>'4'	      
	                          	         	REPLACE &K24Rec..F08 WITH &K24Rec..F08-1   &&免稅張數
	                          	    CASE  &K25Rec..F16='2'	      
	                          	       	        REPLACE &K24Rec..F09 WITH &K24Rec..F09-1   &&作廢張數
	                          	    CASE  &K25Rec..F16='4'	      
	                          	       	        REPLACE &K24Rec..F10 WITH &K24Rec..F10-1   &&空白張數                               	         	
	                               ENDCASE	    
	                               IF  (&K24Rec..F03+&K24Rec..F04+&K24Rec..F05+&K24Rec..F06+&K24Rec..F07+&K24Rec..F08+&K24Rec..F09+&K24Rec..F10)=0
	                                     SELECT &K24Rec
	                                     DELETE 
	                               ENDIF
                                       IF &K25Rec..F16='2'	
                                            SELECT &K24Rec
                                            SEEK '作廢 '
                                            IF FOUND()
                                                 REPLACE &K24Rec..F09 WITH &K24Rec..F09-1 
		                                 IF  (&K24Rec..F03+&K24Rec..F04+&K24Rec..F05+&K24Rec..F06+&K24Rec..F07+&K24Rec..F08+&K24Rec..F09+&K24Rec..F10)=0
		                                      SELECT &K24Rec
		                                      DELETE 
		                                 ENDIF                                                 
                                            ENDIF
                                       ENDIF	                               
	                           ENDIF                 
	                           SELECT  &K25Rec                           
	                           DELE FOR LEFT(F15,10)=P12_1.F01
	                   ENDIF     
                      ENDIF     
                 ENDIF                                                   
               ELSE
                  =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                  SELE P12_1
                  REPL F10 WITH ' '
               ENDIF           
               THIS.ENABLED=.F.
               THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
               THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
               UNLOCK ALL
               IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                  THISFORM.GRID1.SETFOCUS
               ELSE
                   THISFORM.GRID2.SETFOCUS
                   THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
               ENDIF
               THISFORM.REFRESH      
            ELSE
              DO file_impact
              unlock all
              return
            ENDIF   
       unlock all
       RELEASE ALL LIKE BK*
    ENDIF   
  ENDPROC  
enddefine    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=P12_1.F01     
     IVT=P12_1.F22
     TAT=P12_1.F23     
     SELECT P12
     CALC SUM(ROUND(F04*F17*F18,INT_068)) FOR F01=LK TO TMP1               
     HK=IIF(INT_012=1,ALLTRIM(STR(YEAR(A23.F01)-1911))+SUBSTR(DTOC(A23.F01),3,3),LEFT(dtoc(A23.F01),5))
     SELECT P12.F01,;
            P12.F02,;
            P12.F03,;
            P12.F04,;
            P12.F05,;
            P12.F07,;
            P12.F08,;                    
            P12.F09,;
            P12.F15,;
            P12.F16,;
            P12.F17,;
            P12.F18,;
            P12.F20,;
            D01.F03,;
            D01.F05,;
            D01.F08,;
            D01.F09,;
            B01.F02,;
            A14.F02;
     FROM P12,D01,B01,A14 WHERE P12.F01=LK AND D01.F01=P12.F07 AND B01.F01=P12.F03 AND A14.F01=P12.F05;
     ORDER BY P12.F03 NOWAIT
     IF _tally >0
*       REPORT FORM ALLTRIM(INT_116)+'B02'  PREVIEW
        report form ALLTRIM(INT_116)+'B02' to print prompt        
     ENDIF  
ENDPROC
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
         CHK_IN='0'
         PR_NO='1'    
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
              IF USED('OQT')=.T.
                  SELECT OQT 
                  USE
              ENDIF    
              SELECT F03,F09 FROM P12 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F09,F03 INTO CURSOR P12_TEMP     
              SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07  WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE;
                             AND (D07.F04-D07.F06)>0  AND D07.F09='1' ORDER BY F01,F03 INTO CURSOR OQT READWRITE 
              ALTER TABLE OQT ADD D07_F04  N(11,2)
              INDE ON F02+DTOS(F03)+F01 TAG OQT_1
              INDE ON F01+F02 TAG OQT_2
	      SELECT OQT 
	      SET ORDER TO OQT_2  
	      SELECT P12_TEMP
	      GO TOP
	      DO WHILE !EOF()        
	             SELECT OQT
	             SEEK P12_TEMP.F09+P12_TEMP.F03
	             IF FOUND()
	                  DELETE 
	             ENDIF
	             SELECT P12_TEMP
	             SKIP
	      ENDDO
	      SELECT P12_TEMP
	      USE
	      SELECT OQT 
              IF _TALLY>0	 
                  OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                  OQT_SEEK.SHOW                
                  THIS.REFRESH
                  SELECT OQT 
                  CALC SUM(EXP_1) TO NO
                  DO CASE
	                  CASE NO=1 AND CHK_IN='1'
		        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
			             SELECT OQT_TEMP
			             THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')			             
            			     THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
			             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.D07_F04  
			             THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=OQT_TEMP.F01
			             THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE			             
			             THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)       
			             *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'
			             *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))	    
			             *ELSE  
			                THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))	    
                         *ENDIF            
                         THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'')      
			             SELECT OQT_TEMP
			             USE	                   
	                  CASE NO>=1 AND CHK_IN='1'
		        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			             SELECT OQT_TEMP
			             GO TOP
			             DO WHILE !EOF()
			                    IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'P12')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
			                          SELECT P12
			                          APPEND BLANK 
					          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
					          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
					          REPLACE F03 WITH OQT_TEMP.F02
					          REPLACE F04 WITH OQT_TEMP.D07_F04 
					          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
					          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
					          REPLACE F08 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'') 
					          REPLACE F09 WITH OQT_TEMP.F01
					          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
					          REPLACE F13 WITH IIF(SEEK(OQT_TEMP.F02,'B01'),B01.F26,'N')     
					          REPLACE F15 WITH 0
					          REPLACE F16 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')
					          REPLACE F17 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)         
					          *IF F07='V0093'
					          *   REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(P12.F16,'C00'),C00.F02,1))
					          *ELSE
					             REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'D0Z'),D0Z.F03,IIF(SEEK(P12.F16,'D00'),D00.F02,1))	   
					          *ENDIF   
					          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
					          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                    
					          REPLACE F22 WITH P12_1.F22
					          REPLACE F23 WITH P12_1.F23			                         
				                 *寫入P04
					         SELE P04
					         SEEK P12.F09+P12.F03
					         IF FOUND()
					                   REPLACE P04.F18 WITH P04.F18+P12.F04  
					         ENDIF  
					         **寫入D07 寫入進貨計劃				                          
					        SELE D07                 
					        SET ORDER TO D074                                                         
					        SEEK P12.F09+P12.F03
					        IF FOUND()
					            QTY=P12.F04
					            DO WHILE D07.F01+D07.F02=P12.F09+P12.F03 
					                   IF D07.F04-D07.F06=0
					                        SKIP
					                   ELSE
					                        IF QTY>D07.F04-D07.F06
					                            QTY=QTY+(D07.F04-D07.F06)*(-1)
					                            REPLACE  D07.F06 WITH D07.F04
					                            SKIP
					                        ELSE
					                            REPLACE  D07.F06 WITH D07.F06+QTY
					                            EXIT
					                        ENDIF  
					                   ENDIF                    
					             ENDDO   
					        ENDIF               			                    
		                            ENDIF
			                    SELECT OQT_TEMP
			                    SKIP  
		                      ENDDO  
		                      SELECT OQT_TEMP
		                      USE
			              THISFORM.GRID2.ENABLED=.T.
			              THISFORM.GRID2.SETFOCUS  
			              THISFORM.GRID2.ENABLED=.F.         
			              THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1		             
	        		      THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
			              THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''		             
			              THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=0       
			              THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=0
			              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
	                              THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''			                              
	          ENDCASE       
		  THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS 
	      ELSE    	
	           IF ALLTRIM(A02.F09)='*'   &&判斷有無無訂單作業的權限
	               IF AT('?',ALLTRIM(THIS.VALUE))>1             
	                   SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE  LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
	               ELSE
	                   SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 
	               ENDIF        
	               IF _TALLY>0
	                   MAN_SEEK=CREATEOBJECT("MTR_SEEK")  
	                   MAN_SEEK.SHOW    
	                  THIS.VALUE=FLG
	                  THIS.REFRESH
	                  FLG='0'     
	               ENDIF    
	          ELSE
	               =MESSAGEBOX('此廠商無此料號類別的訂單或根本未下訂單!請先輸入訂單',0+64,'提示訊息視窗')
*!*		               THIS.VALUE=''
*!*		               THIS.REFRESH
	               THIS.SETFOCUS
	               RETURN   
	              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
                  ENDIF      
             ENDIF                 
         ENDIF                
  ENDPROC
 *****          
  PROCEDURE INTERACTIVECHANGE
    CHK_IN='0'
    PR_NO='1'      
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
        IF USED('OQT')=.T.
               SELECT OQT 
               USE
        ENDIF        
        SELECT F03,F09 FROM P12 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F09,F03 INTO CURSOR P12_TEMP             
        DO CASE
               CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE))                   
                          SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07 WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE; 
                          AND LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                          AND (D07.F04-D07.F06)>0 AND D07.F09='1'  ORDER BY F02,F03 INTO CURSOR OQT READWRITE 
               CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE))                   
                          SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07  WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE; 
                          AND LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                          AND (D07.F04-D07.F06)>0 AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE AND D07.F09='1' ORDER BY F02,F03 INTO CURSOR OQT READWRITE 
               CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE))                   
                           SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07 WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE;
                           AND (D07.F04-D07.F06)>0 AND D07.F09='1' ORDER BY F02,F03 INTO CURSOR OQT READWRITE 
                CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE))                   
                           SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07  WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE;
                           AND (D07.F04-D07.F06)>0 AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE AND D07.F09='1' ORDER BY F02,F03 INTO CURSOR OQT READWRITE 
        ENDCASE 
        SELECT OQT
        ALTER TABLE OQT ADD D07_F04  N(11,2)
        INDE ON F02+DTOS(F03)+F01 TAG OQT_1
        INDE ON F01+F02 TAG OQT_2
        SELECT OQT 
        SET ORDER TO OQT_2  
        SELECT P12_TEMP
        GO TOP
        DO WHILE !EOF()        
               SELECT OQT
               SEEK P12_TEMP.F09+P12_TEMP.F03
               IF FOUND()
                   DELETE 
               ENDIF
               SELECT P12_TEMP
               SKIP
        ENDDO
        SELECT P12_TEMP
        USE
        SELECT OQT         
        IF _TALLY>0  
            OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
            OQT_SEEK.SHOW                
            THIS.REFRESH
            SELECT OQT 
            CALC SUM(EXP_1) TO NO
            DO CASE
                  CASE NO=1 AND CHK_IN='1'
	        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
		             SELECT OQT_TEMP
		             THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')			             
        		     THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
		             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.D07_F04  
		             THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=OQT_TEMP.F01
		             THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE			             
		             THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)     
		             *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'
		             *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))	      
		             *ELSE
		                THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))	    
                     *ENDIF
                     THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'')      
		             SELECT OQT_TEMP
		             USE	                   
                  CASE NO>=1 AND CHK_IN='1'
	        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
		             SELECT OQT_TEMP
		             GO TOP
		             DO WHILE !EOF()
		                    IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'P12')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
		                          SELECT P12
		                          APPEND BLANK 
				          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				          REPLACE F03 WITH OQT_TEMP.F02
				          REPLACE F04 WITH OQT_TEMP.D07_F04 
				          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
				          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				          REPLACE F08 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'') 
				          REPLACE F09 WITH OQT_TEMP.F01
				          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				          REPLACE F13 WITH IIF(SEEK(OQT_TEMP.F02,'B01'),B01.F26,'N')     
				          REPLACE F15 WITH 0
				          REPLACE F16 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')
				          REPLACE F17 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)         
				          *IF F07='V0093'
				          *   REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(P12.F16,'C00'),C00.F02,1))
				          *ELSE
				             REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'D0Z'),D0Z.F03,IIF(SEEK(P12.F16,'D00'),D00.F02,1))	
				          *ENDIF      
				          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
				          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                    
				          REPLACE F22 WITH P12_1.F22
				          REPLACE F23 WITH P12_1.F23			                         
			                 *寫入P04
				         SELE P04
				         SEEK P12.F09+P12.F03
				         IF FOUND()
				                   REPLACE P04.F18 WITH P04.F18+P12.F04  
				         ENDIF  
				         **寫入D07 寫入進貨計劃				                          
				        SELE D07                 
				        SET ORDER TO D074                                                         
				        SEEK P12.F09+P12.F03
				        IF FOUND()
				            QTY=P12.F04
				            DO WHILE D07.F01+D07.F02=P12.F09+P12.F03 
				                   IF D07.F04-D07.F06=0
				                        SKIP
				                   ELSE
				                        IF QTY>D07.F04-D07.F06
				                            QTY=QTY+(D07.F04-D07.F06)*(-1)
				                            REPLACE  D07.F06 WITH D07.F04
				                            SKIP
				                        ELSE
				                            REPLACE  D07.F06 WITH D07.F06+QTY
				                            EXIT
				                        ENDIF  
				                   ENDIF                    
				             ENDDO   
				        ENDIF               			                    
	                            ENDIF
		                    SELECT OQT_TEMP
		                    SKIP  
	                      ENDDO  
	                      SELECT OQT_TEMP
	                      USE
		              THISFORM.GRID2.ENABLED=.T.
		              THISFORM.GRID2.SETFOCUS  
		              THISFORM.GRID2.ENABLED=.F.         
		              THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1		             
        		      THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
		              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
		              THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
		              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''		             
		              THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=0       
		              THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=0
		              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
                              THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''			                              
             ENDCASE       
	     THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS 
        ELSE    	         
             IF ALLTRIM(A02.F09)='*'   &&判斷有無無訂單作業的權限
                  IF AT('?',ALLTRIM(THIS.VALUE))>1             
                      SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE  LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
                 ELSE
                      SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 
                 ENDIF        
                 IF _TALLY>0
                     MAN_SEEK=CREATEOBJECT("MTR_SEEK")  
                     MAN_SEEK.SHOW    
                     THIS.VALUE=FLG
                     THIS.REFRESH
                     FLG='0'     
                 ENDIF    
            ELSE
                 =MESSAGEBOX('此廠商無此料號類別的訂單或根本未下訂單!請先輸入訂單',0+64,'提示訊息視窗')
*!*	               THIS.VALUE=''
*!*	               THIS.REFRESH
                THIS.SETFOCUS
                 RETURN   
                THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
            ENDIF      
        ENDIF
    ELSE
        IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)
            THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THIS.VALUE,'P04'),P04.F09-P04.F18,0)
            THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THIS.VALUE,'P04'),P04.F04,'NT')          
            THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE+THIS.VALUE,'P04'),P04.F05,0)          
            THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE   
            *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'   
            *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))                  
            *ELSE    
                THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))                  
            *ENDIF
            THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THIS.VALUE,'P04'),P04.F11,'')            
        ELSE
             IF ALLTRIM(A02.F09)='*'  &&如果有無訂單進貨的權限才去尋找最新詢價紀錄
                  IF !USED('P02')
                      SELECT 0
                      USE P02
                  ELSE
                      SELECT P02
                  ENDIF
                  SET ORDER TO P023   
                  THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE+THIS.VALUE,'P02','P023'),P02.F07,0)   
                  THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE+THIS.VALUE,'P02','P023'),P02.F06,INT_011) 
                  THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE 
                  *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093' 
                  *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))                                   
                  *ELSE
                     THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))       
                  *ENDIF
                  SELECT P02
                  USE  
             ENDIF                                  
        ENDIF           
    ENDIF         
    THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')      
  ENDPROC
ENDDEFINE
***************************************************特殊欄位-----------------訂單號碼
DEFINE CLASS TXTF09 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=10
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
         CHK_IN='0'
         PR_NO='2'    
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
              IF USED('OQT')=.T.
                  SELECT OQT 
                  USE
              ENDIF    
              SELECT F03,F09 FROM P12 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F09,F03 INTO CURSOR P12_TEMP     
              SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07  WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE;
                             AND (D07.F04-D07.F06)>0  AND D07.F09='1' ORDER BY F01,F03 INTO CURSOR OQT READWRITE 
              ALTER TABLE OQT ADD D07_F04  N(11,2)
              INDE ON F01+DTOS(F03)+F02 TAG OQT_1
              INDE ON F01+F02 TAG OQT_2
	      SELECT OQT 
	      SET ORDER TO OQT_2  
	      SELECT P12_TEMP
	      GO TOP
	      DO WHILE !EOF()        
	             SELECT OQT
	             SEEK P12_TEMP.F09+P12_TEMP.F03
	             IF FOUND()
	                  DELETE 
	             ENDIF
	             SELECT P12_TEMP
	             SKIP
	      ENDDO
	      SELECT P12_TEMP
	      USE
	      SELECT OQT 
              IF _TALLY>0	 
                  OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                  OQT_SEEK.SHOW                
                  THIS.REFRESH
                  SELECT OQT 
                  CALC SUM(EXP_1) TO NO
                  DO CASE
	                  CASE NO=1 AND CHK_IN='1'
		        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
			             SELECT OQT_TEMP
			             THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')			             
            			 THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
			             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.D07_F04  
			             THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=OQT_TEMP.F01
			             THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE			             
			             THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)        
			             *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'
			             *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))	    
			             *ELSE
			                THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))	    
                         *ENDIF
                         THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'')      
			             SELECT OQT_TEMP
			             USE	                   
	                  CASE NO>=1 AND CHK_IN='1'
		        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			             SELECT OQT_TEMP
			             GO TOP
			             DO WHILE !EOF()
			                    IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'P12')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
			                          SELECT P12
			                          APPEND BLANK 
					          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
					          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
					          REPLACE F03 WITH OQT_TEMP.F02
					          REPLACE F04 WITH OQT_TEMP.D07_F04 
					          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
					          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
					          REPLACE F08 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'') 
					          REPLACE F09 WITH OQT_TEMP.F01					          				          				          
					          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
					          REPLACE F13 WITH IIF(SEEK(OQT_TEMP.F02,'B01'),B01.F26,'N')     
					          REPLACE F15 WITH 0
					          REPLACE F16 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')
					          REPLACE F17 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)         
					          *IF F07='V0093'
					          *   REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(P12.F16,'C00'),C00.F02,1))	
					          *ELSE
					             REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'D0Z'),D0Z.F03,IIF(SEEK(P12.F16,'D00'),D00.F02,1))	
					          *ENDIF      
					          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
					          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                    
					          REPLACE F22 WITH P12_1.F22
					          REPLACE F23 WITH P12_1.F23			                         
				                 *寫入P04
					         SELE P04
					         SEEK P12.F09+P12.F03
					         IF FOUND()
					                   REPLACE P04.F18 WITH P04.F18+P12.F04  
					         ENDIF  
					         **寫入D07 寫入進貨計劃				                          
					        SELE D07                 
					        SET ORDER TO D074                                                         
					        SEEK P12.F09+P12.F03
					        IF FOUND()
					            QTY=P12.F04
					            DO WHILE D07.F01+D07.F02=P12.F09+P12.F03 
					                   IF D07.F04-D07.F06=0
					                        SKIP
					                   ELSE
					                        IF QTY>D07.F04-D07.F06
					                            QTY=QTY+(D07.F04-D07.F06)*(-1)
					                            REPLACE  D07.F06 WITH D07.F04
					                            SKIP
					                        ELSE
					                            REPLACE  D07.F06 WITH D07.F06+QTY
					                            EXIT
					                        ENDIF  
					                   ENDIF                    
					             ENDDO   
					        ENDIF               			                    
		                            ENDIF
			                    SELECT OQT_TEMP
			                    SKIP  
		                      ENDDO  
		                      SELECT OQT_TEMP
		                      USE
			              THISFORM.GRID2.ENABLED=.T.
			              THISFORM.GRID2.SETFOCUS  
			              THISFORM.GRID2.ENABLED=.F.         
			              THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1		             
	        		      THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
			              THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''		             
			              THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=0       
			              THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=0
			              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
	                              THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''			                              
	          ENDCASE       
		  THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS 
	      ELSE    	
		  =MESSAGEBOX('此廠商已無進貨計畫可出貨,請查明後再輸入!',0+64,'提示訊息視窗')
		  THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS 
	          RETURN
             ENDIF                 
         ENDIF             
  ENDPROC
  ****         
  PROCEDURE INTERACTIVECHANGE
    CHK_IN='0'
    PR_NO='2'      
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
        IF USED('OQT')=.T.
            SELECT OQT 
            USE
       ENDIF         
       SELECT F03,F09 FROM P12 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F09,F03 INTO CURSOR P12_TEMP       
       DO CASE
              CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F01,F02,F03,F04,F06,F07 FROM D07 WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE  AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                        AND (D07.F04-D07.F06)>0 AND D07.F09='1' ORDER BY F01,F03 INTO CURSOR OQT READWRITE 
             CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F01,F02,F03,F04,F06,F07 FROM D07 WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE  AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                        AND (D07.F04-D07.F06)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE AND D07.F09='1'  ORDER BY F01,F03 INTO CURSOR OQT READWRITE          
             CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07  WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE;
                        AND (D07.F04-D07.F06)>0 AND D07.F09='1' ORDER BY F01,F03 INTO CURSOR OQT READWRITE
             CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE))                   
                        SELECT 0,F02,F01,F03,F04,F06,F07 FROM D07 WHERE F05=THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE;
                       AND (D07.F04-D07.F06)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE AND D07.F09='1' ORDER BY F01,F03 INTO CURSOR OQT READWRITE
       ENDCASE 
       SELECT OQT 
       ALTER TABLE OQT ADD D07_F04  N(11,2)
       INDE ON F01+DTOS(F03)+F02 TAG OQT_1
       INDE ON F01+F02 TAG OQT_2
       SET ORDER TO OQT_2
       SELECT P12_TEMP
       GO TOP
       DO WHILE !EOF()
	       SELECT OQT 
	       SEEK P12_TEMP.F09+P12_TEMP.F03
	       IF FOUND()
	            DELETE 
	       ENDIF
	       SELECT P12_TEMP
	       SKIP
       ENDDO
       SELECT P12_TEMP
       USE      
       SELECT OQT        
       IF _TALLY>0  
          OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
          OQT_SEEK.SHOW    
           THIS.REFRESH
           SELECT OQT 
           CALC SUM(EXP_1) TO NO
           DO CASE
                  CASE NO=1 AND CHK_IN='1'
	        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
		             SELECT OQT_TEMP
		             THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')			             
        		     THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=OQT_TEMP.F02
		             THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=OQT_TEMP.D07_F04  
		             THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=OQT_TEMP.F01
		             THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE			             
		             THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)         
		             *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'
		             *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))	    
		             *ELSE
			            THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))	    
                     *ENDIF
                     THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'')      
			      SELECT OQT_TEMP
			      USE	                   
                  CASE NO>=1 AND CHK_IN='1'
	        	     SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
		             SELECT OQT_TEMP
		             GO TOP
		             DO WHILE !EOF()
		                    IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'P12')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
		                          SELECT P12
		                          APPEND BLANK 
				          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				          REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				          REPLACE F03 WITH OQT_TEMP.F02
				          REPLACE F04 WITH OQT_TEMP.D07_F04 
				          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
				          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				          REPLACE F08 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F11,'') 
				          REPLACE F09 WITH OQT_TEMP.F01				         				             				            
				          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				          REPLACE F13 WITH IIF(SEEK(OQT_TEMP.F02,'B01'),B01.F26,'N')     
				          REPLACE F15 WITH 0
				          REPLACE F16 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F04,'NT')
				          REPLACE F17 WITH IIF(SEEK(OQT_TEMP.F01+OQT_TEMP.F02,'P04'),P04.F05,0)         
				          *IF F07='V0093'
				          *   REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'C0Z'),C0Z.F03,IIF(SEEK(P12.F16,'C00'),C00.F02,1))	
				          *ELSE
				             REPLACE F18 WITH IIF(SEEK(P12.F16+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(P12.F02)))),'D0Z'),D0Z.F03,IIF(SEEK(P12.F16,'D00'),D00.F02,1))	
				          *ENDIF      
				          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF20.VALUE                    
				          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF21.VALUE                    
				          REPLACE F22 WITH P12_1.F22
				          REPLACE F23 WITH P12_1.F23			                         
			                 *寫入P04
				         SELE P04
				         SEEK P12.F09+P12.F03
				         IF FOUND()
				                   REPLACE P04.F18 WITH P04.F18+P12.F04  
				         ENDIF  
				         **寫入D07 寫入進貨計劃				                          
				        SELE D07                 
				        SET ORDER TO D074                                                         
				        SEEK P12.F09+P12.F03
				        IF FOUND()
				            QTY=P12.F04
				            DO WHILE D07.F01+D07.F02=P12.F09+P12.F03 
				                   IF D07.F04-D07.F06=0
				                        SKIP
				                   ELSE
				                        IF QTY>D07.F04-D07.F06
				                            QTY=QTY+(D07.F04-D07.F06)*(-1)
				                            REPLACE  D07.F06 WITH D07.F04
				                            SKIP
				                        ELSE
				                            REPLACE  D07.F06 WITH D07.F06+QTY
				                            EXIT
				                        ENDIF  
				                   ENDIF                    
				             ENDDO   
				        ENDIF               			                    
	                            ENDIF
		                    SELECT OQT_TEMP
		                    SKIP  
	                      ENDDO  
	                      SELECT OQT_TEMP
	                      USE
		              THISFORM.GRID2.ENABLED=.T.
		              THISFORM.GRID2.SETFOCUS  
		              THISFORM.GRID2.ENABLED=.F.         
		              THISFORM.PAGEFRAME1.PAGE2.CRCY.VALUE=1		             
        		      THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
		              THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=0
		              THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
		              THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''		             
		              THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=0       
		              THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=0
		              THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
                              THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''			                              
          ENDCASE       
	  THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS 
      ELSE    	
	  =MESSAGEBOX('此廠商已無進貨計畫可出貨,請查明後再輸入!',0+64,'提示訊息視窗')
	  THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS 
          RETURN
      ENDIF      	  
   ELSE    	
      IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE)
          THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),P04.F09-P04.F18,0)
          THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),P04.F04,'NT')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF17.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),P04.F05,0)          
          THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THISFORM.PAGEFRAME1.PAGE2.CRCY.DISPLAYVALUE          
          *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'
          *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'C00'),C00.F02,1))    
          *ELSE
             THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE,'D00'),D00.F02,1))    
          *ENDIF
          THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'B01'),B01.F02,'')                    
          THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE,'P04'),P04.F11,'')          
      ENDIF       
   ENDIF  
  ENDPROC     
ENDDEFINE
***************************************************特殊欄位------------------收料部門
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND LEN(ALLTRIM(F01))=4 AND F04='*' AND F13='*'
       ELSE
          SELECT F01,F02 FROM A14 INTO CURSOR DEPART ORDER BY F01 WHERE LEN(ALLTRIM(F01))=4 AND F04='*' AND F13='*'
       ENDIF   
       DEPART_SEEK=createobject("DEPART_SEEK")  
       DEPART_SEEK.SHOW    
       THIS.VALUE=FLG
       THIS.REFRESH
       FLG='0'
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')  
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------廠商
DEFINE CLASS TXTF07 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          if empty(a02.f12)
             SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) and f18=sys_oper
          else
             SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
          endif
       ELSE
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 
       ENDIF          
       VDR_SEEK=createobject("VDR_SEEK")  
       VDR_SEEK.SHOW    
       THIS.VALUE=FLG
       THIS.REFRESH
       FLG='0'        
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=createobject("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(THIS.VALUE,'D01'),D01.F04,'')  
  ENDPROC
ENDDEFINE

******************************************************************特殊欄位設定--發票號碼
DEFINE CLASS TXTF20 AS TEXTBOX
       READONLY=.T.
       MAXLENGTH=10
       FONTSIZE=INT_015*9
       PROCEDURE INTERACTIVECHANGE
           IF INT_058=.T.
               IF LEN(ALLTRIM(THIS.VALUE))=10
                   THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.T.
                   THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.T.
               ELSE   
                   THISFORM.PAGEFRAME1.PAGE1.INV_TYPE.VISIBLE=.F.
                   THISFORM.PAGEFRAME1.PAGE1.TAX_TYPE.VISIBLE=.F.
                   THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=''
                   THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=''              
               ENDIF   
           ENDIF    
       ENDPROC
ENDDEFINE     
*********************************************************************發票種類
DEFINE CLASS INV_TYPE AS optiongroup
  HEIGHT=INT_015*25
  TOP=INT_015*109
  LEFT=INT_015*145
  HEIGHT=INT_015*25
  WIDTH=INT_015*120
  FONTSIZE=INT_015*9
  buttoncount=2
  VALUE=1
  NAME='INV_TYPE'
  OPTION1.CAPTION='三聯式'
  OPTION1.TOP=INT_015*5
  OPTION1.WIDTH=INT_015*52
  OPTION1.LEFT=INT_015*5
  OPTION1.NAME='OPTION1'
  OPTION2.CAPTION='二聯式'
  OPTION2.TOP=INT_015*5
  OPTION2.WIDTH=INT_015*52
  OPTION2.LEFT=INT_015*59
  OPTION2.NAME='OPTION2'
  PROC INTERACTIVECHANGE
  ENDPROC     
*!*       PROCEDURE INTERACTIVECHANGE
*!*          THISFORM.PAGEFRAME1.PAGE1.TXTF22.VALUE=LEFT(THIS.DISPLAYVALUE,2)
*!*     *     THISFORM.PAGEFRAME1.PAGE1.LBLF221.CAPTION=IIF(THIS.VALUE=1,'三聯式','二聯式')
*!*          THISFORM.PAGEFRAME1.PAGE1.TXTF22.REFRESH
*!*          IF THIS.VALUE=1
*!*             THISFORM.TAX_TYPE.VISIBLE=.T. 
*!*          ENDIF
*!*       ENDPROC
ENDDEFINE  
*********************************************************************課稅別
DEFINE CLASS TAX_TYPE AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*109
  LEFT=INT_015*265
  FONTSIZE=INT_015*9
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*50
  ROWSOURCETYPE=1
  VALUE=1
  STYLE=2
  NAME='TAX_TYPE'
  PROCEDURE INIT
     with this 
          .additem('應稅')
          .additem('零稅')          
          .additem('免稅')          
     endwith   
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
     DO CASE
        CASE THIS.VALUE=1

        CASE THIS.VALUE=2

        CASE THIS.VALUE=3

*     THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=IIF(THIS.VALUE=1,'應稅',IIF(THIS.VALUE=2,'零稅','免稅'))
     ENDCASE
  ENDPROC
ENDDEFINE  
***************************************************幣別設定
DEFINE CLASS CRCY AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*39
  LEFT=INT_015*379
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*84
  ROWSOURCETYPE=1
  STYLE=2
  FONTSIZE=INT_015*9
  NAME='CRCY'
  PROCEDURE INIT
    SELECT D00
    GO TOP 
    DO WHILE .NOT. EOF()
       L=4-LEN(ALLTRIM(F01))
       THIS.ADDITEM(F01)
       SKIP
    ENDDO
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=THIS.DISPLAYVALUE
    *IF THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='V0093'
    *   THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THIS.DISPLAYVALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'C0Z'),C0Z.F03,IIF(SEEK(THIS.DISPLAYVALUE,'C00'),C00.F02,1))
    *ELSE    
       THISFORM.PAGEFRAME1.PAGE2.TXTF18.VALUE=IIF(SEEK(THIS.DISPLAYVALUE+DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+NOUME(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)))),'D0Z'),D0Z.F03,IIF(SEEK(THIS.DISPLAYVALUE,'D00'),D00.F02,1))
    *ENDIF
    THISFORM.PAGEFRAME1.PAGE2.TXTF16.REFRESH
    THISFORM.PAGEFRAME1.PAGE2.TXTF18.REFRESH
  ENDPROC
ENDDEFINE        
***************************************進貨計劃
DEFINE CLASS OQT_SEEK AS FORM
*!*	  AUTOCENTER=.T.
 CAPTION=ALLTRIM(D01.F03)+'         D08.進貨計劃'
  TOP=INT_015*110
  LEFT=INT_015*25     
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*325
  WIDTH=INT_015*745
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OQT_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      WIDTH=INT_015*745,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=7,;       
      RECORDSOURCE='OQT',;     
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;            
      COLUMN5.NAME='COLUMN5',;  
      COLUMN6.NAME='COLUMN6',;       
      COLUMN7.NAME='COLUMN7'  
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*230,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.確定',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*320,;
      TOP=INT_015*297,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*50,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;  
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.全選',;
      TOOLTIPTEXT='全選所有資料!快速鍵->ALT+A'
      NAME='CMND3'
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*130,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.清除',;
      TOOLTIPTEXT='清除已全選之資料!快速鍵->ALT+C'
      NAME='CMND4'       
   PROCEDURE INIT 
         SELECT P04
         SET ORDER TO P041
         SELE OQT
         SET ORDER TO OQT_1
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN') 
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')                           
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION=''
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*20
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OQT.EXP_1'                
         IF PR_NO='1'  
             THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料        號'
             THISFORM.GRID1.COLUMN2.WIDTH=INT_015*190
             THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F02'               
             THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='採購單號'
             THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F01'
             THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80      
         ELSE
             THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='採購單號'
             THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F01'
             THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
             THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='料        號'
             THISFORM.GRID1.COLUMN3.WIDTH=INT_015*190
             THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F02'        
         ENDIF
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='進貨日期'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='OQT.F03'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='計畫數量'         
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='OQT.F04-OQT.F06'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80         
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='計價數量'         
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='OQT.D07_F04'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*80         
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='採購用途'         
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='OQT.F07'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*185               
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      ***
      PROC GRID1.INIT      
	 THISFORM.GRID1.COLUMN1.READONLY=.F.
	 THISFORM.GRID1.COLUMN2.READONLY=.T.
	 THISFORM.GRID1.COLUMN3.READONLY=.T.
	 THISFORM.GRID1.COLUMN4.READONLY=.T.
	 THISFORM.GRID1.COLUMN5.READONLY=.T.
	 THISFORM.GRID1.COLUMN6.READONLY=.F.
	 THISFORM.GRID1.COLUMN7.READONLY=.T.
	 THISFORM.GRID1.COLUMN6.HEADER1.BACKCOLOR=RGB(128,255,0)
	 THISFORM.GRID1.COLUMN1.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN1.AddObject("CheckBox1","CheckBox1") 
	 THISFORM.GRID1.COLUMN1.CurrentControl="CheckBox1" 
	 THISFORM.GRID1.COLUMN1.Sparse=.F.
	 THISFORM.GRID1.COLUMN1.CheckBox1.Visible=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CAPTION=''
	 THISFORM.GRID1.COLUMN1.CheckBox1.AUTOSIZE=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CENTERED=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.BACKSTYLE=0
	 THISFORM.GRID1.COLUMN1.CheckBox1.LEFT=5
	 THISFORM.GRID1.COLUMN6.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN6.AddObject("TEXTBOX1","TEXTBOX1") 
	 THISFORM.GRID1.COLUMN6.CurrentControl="TEXTBOX1" 
	 THISFORM.GRID1.COLUMN6.Sparse=.F.	
	 THISFORM.GRID1.COLUMN6.TEXTBOX1.Visible=.T.       
      ENDPROC
      ***      
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
*!*	           FCH='GRID1'
      ENDPROC  
 PROCEDURE CMND1.CLICK
      SELECT OQT
      CHK_IN='1'
      THISFORM.RELEASE     
 ENDPROC
 PROCEDURE CMND2.CLICK
      CHK_IN='0' 
      THISFORM.RELEASE
 ENDPROC
  **
 PROCEDURE CMND3.CLICK     
      SELECT OQT
      RE=RECNO('OQT')
      GO TOP
      DO WHILE !EOF()
	     REPLACE OQT.EXP_1 WITH 1 
             REPLACE OQT.D07_F04 WITH OQT.F04-OQT.F06        
	     SELECT OQT
	     SKIP
      ENDDO
      SELECT OQT
      GO RE  
      THISFORM.GRID1.SETFOCUS 
 ENDPROC      
  PROCEDURE CMND4.CLICK
      SELECT OQT
      RE=RECNO('OQT')
      GO TOP
      DO WHILE !EOF()
	     REPLACE OQT.EXP_1 WITH 0 
             REPLACE OQT.D07_F04 WITH 0 
             SELECT OQT
             SKIP
      ENDDO
      SELECT OQT
      GO RE
      THISFORM.GRID1.SETFOCUS 
 ENDPROC  
  PROC CMND1.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND1.TOP=INT_015*298
             THISFORM.CMND1.LEFT=INT_015*231
  ENDPROC     
  PROC CMND1.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND1.TOP=INT_015*297
             THISFORM.CMND1.LEFT=INT_015*230                  
  ENDPROC  
  PROC CMND2.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND2.TOP=INT_015*298
             THISFORM.CMND2.LEFT=INT_015*321
  ENDPROC     
  PROC CMND2.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND2.TOP=INT_015*297
             THISFORM.CMND2.LEFT=INT_015*320                  
  ENDPROC  
  PROC CMND3.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND3.TOP=INT_015*298
             THISFORM.CMND3.LEFT=INT_015*51
  ENDPROC     
  PROC CMND3.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND3.TOP=INT_015*297
             THISFORM.CMND3.LEFT=INT_015*50                  
  ENDPROC   
  PROC CMND4.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND4.TOP=INT_015*298
             THISFORM.CMND4.LEFT=INT_015*131
  ENDPROC     
  PROC CMND4.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND4.TOP=INT_015*297
             THISFORM.CMND4.LEFT=INT_015*130                  
  ENDPROC    
ENDDEFINE      
*********     
DEFINE CLASS CheckBox1 AS CheckBox
      PROCEDURE CLICK
         SELECT OQT
         IF THIS.VALUE=1
              REPLACE OQT.EXP_1 WITH 1
              REPLACE OQT.D07_F04 WITH OQT.F04-OQT.F06  
         ELSE
              REPLACE OQT.EXP_1 WITH 0
              REPLACE OQT.D07_F04 WITH 0
         ENDIF
         THISFORM.GRID1.SETFOCUS     
   ENDPROC 
ENDDEFINE
*********     
DEFINE CLASS TEXTBOX1 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT OQT
         IF OQT.EXP_1=1
             DO CASE 
                   CASE THIS.VALUE<=0
                    	      THIS.VALUE=OQT.F04-OQT.F06
                    	      =MESSAGEBOX('計價數量不得小於等於零,請重新輸入!!',0+64,'提示訊息視窗')        
                  CASE THIS.VALUE>IIF(SEEK(OQT.F01+OQT.F02,'P04'),P04.F09-P04.F18,0)
                             =MESSAGEBOX('計價數量不得大於未進貨數量'+ALLTRIM(STR(P04.F09-P04.F18)),0+48,'提示訊息視窗')
                    	      THIS.VALUE=OQT.F04-OQT.F06		                        	                      
             ENDCASE   
             REPLACE OQT.D07_F04 WITH THIS.VALUE        
         ENDIF  
         THISFORM.GRID1.SETFOCUS  
   ENDPROC 
ENDDEFINE               
