******B11.庫存明細查詢
close all
clear 
FLG='0'
FCH=''
CHK=''
R=0
AREA1='A14'
AREA2='B11'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'B11'
IF !USED('C01')
   SELECT 0
   USE C01
ELSE
   SELECT C01
ENDIF
SET ORDER TO C011      
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1   
IF !USED('A14')
   SELE 0
   USE A14 INDE A14
ELSE
   SELE A14
ENDIF
SET FILTER TO F04='*'
SET ORDER TO A141
IF !USED('B1A')
   SELECT 0
   USE B1A
ELSE 
   SELECT B1A
ENDIF
SET ORDER TO B1A1      
if !used('B11')
   SELE 0
   USE B11
ELSE
   SELE B11
ENDIF
SET ORDER TO B111      
SELECT F08 FROM B11 GROUP BY F08 INTO CURSOR C01_2 NOWAIT ORDER BY F08
CREATE CURSOR C01_1 (F01 C(5),F04 C(40),F05 C(8),F18 C(5),F23 C(5),F33 C(5))
INDEX ON F01 TAG C01_11
SET ORDER TO 1
SELECT C01_2
GO TOP
DO WHILE !EOF()
   SELECT C01_1
   APPEND BLANK
   REPLACE F01 WITH C01_2.F08
   REPLACE F04 WITH IIF(SEEK(F01,'C01'),C01.F04,'')
   REPLACE F05 WITH IIF(SEEK(F01,'C01'),C01.F05,'')   
   REPLACE F18 WITH IIF(SEEK(F01,'C01'),C01.F18,'')      
   REPLACE F23 WITH IIF(SEEK(F01,'C01'),C01.F23,'')     
   REPLACE F33 WITH IIF(SEEK(F01,'C01'),C01.F33,'')                
   SELECT C01_2
   SKIP
ENDDO
SELECT C01
USE
SELECT C01_2
USE
SELECT B11
SET FILTER TO F04<>0
SET RELA TO F03 INTO B01 
SET RELATION TO F08 INTO C01_1 ADDI
SET RELATION TO F01+F03+F08 INTO B1A ADDI

B11form=createobject("tkB11")
B11form.show  
define class tkB11 as form
  caption='B11.查詢庫存明細'
*!*	  autocenter=.t.
  controlbox=.F.
  BORDERSTYLE=1 
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  width=INT_015*789
  windowtype=1
  NAME='TKB11'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='依照部門搜尋紀錄',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT grid1 AS grid1 WITH;
      columncount=2,;            
      RECORDSOURCE='A14',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT grid2 AS grid2 WITH;
      columncount=6,;            
      RECORDSOURCE='B11',;
      LINKMASTER='A14',;
      RELATIONALEXPR='F01',;
      CHILDORDER='B111',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*415,;
      LEFT=INT_015*10,;
      ENABLED=.T.,;
      VISIBLE=.T.  
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;
      TOP=INT_015*455,;
      LEFT=INT_015*10                    
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*558               
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*27
          .WIDTH=INT_015*50
          .CAPTION='部門編號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF011','LABEL')     
     WITH THIS.LBLF011
          .VISIBLE=.T.
          .LEFT=INT_015*140
          .TOP=INT_015*27
          .AUTOSIZE=.T.  
     ENDWITH            
     THIS.ADDOBJECT('TXTF01','TEXTBOX')     
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*23
          .WIDTH=INT_015*74
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
    THIS.ADDOBJECT('LBLF18','LABEL')
    WITH THIS.LBLF18
        .VISIBLE=.F.    
        .LEFT=INT_015*14
        .TOP=INT_015*139
        .WIDTH=INT_015*50
        .CAPTION='業務A'         
    ENDWITH        
    THIS.ADDOBJECT('LBLF181','LABEL')
    WITH THIS.LBLF181
        .VISIBLE=.F.    
        .LEFT=INT_015*65
        .TOP=INT_015*139
        .AUTOSIZE=.T.
    ENDWITH            
    THIS.ADDOBJECT('LBLF33','LABEL')
    WITH THIS.LBLF33
        .VISIBLE=.F. 
        .LEFT=INT_015*164
        .TOP=INT_015*139
        .WIDTH=INT_015*50
        .CAPTION='業務B'         
    ENDWITH        
    THIS.ADDOBJECT('LBLF331','LABEL')
    WITH THIS.LBLF331
        .VISIBLE=.F. 
        .LEFT=INT_015*214
        .TOP=INT_015*139
        .AUTOSIZE=.T.
    ENDWITH            
    THIS.ADDOBJECT('LBLF23','LABEL')
    WITH THIS.LBLF23
        .VISIBLE=.F.   
        .LEFT=INT_015*314
        .TOP=INT_015*139
        .WIDTH=INT_015*50
        .CAPTION='業務助理'         
    ENDWITH            
    THIS.ADDOBJECT('LBLF231','LABEL')
    WITH THIS.LBLF231
        .VISIBLE=.F.   
        .LEFT=INT_015*365
        .TOP=INT_015*139
        .AUTOSIZE=.T.
    ENDWITH                     
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF01','LABEL')
	WITH THIS.LBLF01  
         .LEFT=INT_015*14
         .TOP=INT_015*13
	     .WIDTH=INT_015*50
         .CAPTION='部門編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF011','LABEL')
    WITH THIS.LBLF011
         .LEFT=INT_015*126
	     .TOP=INT_015*13
	     .autosize=.t.
	ENDWITH     
    THIS.ADDOBJECT('LBLF03','LABEL')
    WITH THIS.LBLF03
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*14
	     .WIDTH=INT_015*50
	     .CAPTION='品        號'
	ENDWITH     
    THIS.ADDOBJECT('LBLF031','Label')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*337
         .TOP=INT_015*14
         .WIDTH=INT_015*144         
    ENDWITH     
    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*39
         .WIDTH=INT_015*50
         .CAPTION='庫存數量'       
    ENDWITH     
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*64
         .WIDTH=INT_015*50
         .CAPTION='最後異動'
    ENDWITH     
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*89
         .WIDTH=INT_015*50
         .CAPTION='採購用途'
    ENDWITH     
    THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
        .VISIBLE=INT_028        
        .LEFT=INT_015*215
        .TOP=INT_015*89
        .WIDTH=INT_015*50
        .CAPTION='使用對象'         
    ENDWITH        
    THIS.ADDOBJECT('LBLF081','LABEL')
    WITH THIS.LBLF081
        .VISIBLE=INT_028     
        .LEFT=INT_015*315
        .TOP=INT_015*89
        .AUTOSIZE=.T.
    ENDWITH    
    THIS.ADDOBJECT('LBLF10','LABEL')
    WITH THIS.LBLF10
        .VISIBLE=.T.        
        .LEFT=INT_015*14
        .TOP=INT_015*114
        .WIDTH=INT_015*50
        .CAPTION='備註說明'         
    ENDWITH            
    THIS.ADDOBJECT('LBLF18','LABEL')
    WITH THIS.LBLF18
        .VISIBLE=INT_028        
        .LEFT=INT_015*14
        .TOP=INT_015*139
        .WIDTH=INT_015*50
        .CAPTION='業務A'         
    ENDWITH        
    THIS.ADDOBJECT('LBLF181','LABEL')
    WITH THIS.LBLF181
        .VISIBLE=INT_028        
        .LEFT=INT_015*65
        .TOP=INT_015*139
        .AUTOSIZE=.T.
    ENDWITH            
    THIS.ADDOBJECT('LBLF33','LABEL')
    WITH THIS.LBLF33
        .VISIBLE=INT_028        
        .LEFT=INT_015*164
        .TOP=INT_015*139
        .WIDTH=INT_015*50
        .CAPTION='業務B'         
    ENDWITH        
    THIS.ADDOBJECT('LBLF331','LABEL')
    WITH THIS.LBLF331
        .VISIBLE=INT_028        
        .LEFT=INT_015*214
        .TOP=INT_015*139
        .AUTOSIZE=.T.
    ENDWITH            
    THIS.ADDOBJECT('LBLF23','LABEL')
    WITH THIS.LBLF23
        .VISIBLE=INT_028        
        .LEFT=INT_015*314
        .TOP=INT_015*139
        .WIDTH=INT_015*50
        .CAPTION='業務助理'         
    ENDWITH            
    THIS.ADDOBJECT('LBLF231','LABEL')
    WITH THIS.LBLF231
        .VISIBLE=INT_028        
        .LEFT=INT_015*365
        .TOP=INT_015*139
        .AUTOSIZE=.T.
    ENDWITH                
    THIS.ADDOBJECT('LBLF17','LABEL')
    WITH THIS.LBLF17
        .VISIBLE=.T.
        .LEFT=INT_015*14
        .TOP=INT_015*164
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH        
    THIS.ADDOBJECT('LBLF171','LABEL')
    WITH THIS.LBLF171
        .VISIBLE=.T.     
        .LEFT=INT_015*65
        .TOP=INT_015*164
        .AUTOSIZE=.T.
    ENDWITH                
	THIS.ADDOBJECT('TXTF01','TEXTBOX')
	WITH THIS.TXTF01      
	     .LEFT=INT_015*65
	     .TOP=INT_015*10
	     .WIDTH=INT_015*60
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=5
	     .NAME='TXTF01'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF03','TEXTBOX')
	WITH THIS.TXTF03
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*10
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF03'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF04','TEXTBOX')
    WITH THIS.TXTF04
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*35
         .WIDTH=INT_015*120
         .INPUTMASK='99999999999.9999'
         .NAME='TXTF04'
    ENDWITH     
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05     
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*60
         .WIDTH=INT_015*80
         .NAME='TXTF05'
    ENDWITH     
    THIS.ADDOBJECT('TXTF06','TEXTBOX')
    WITH THIS.TXTF06
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*85
         .WIDTH=INT_015*149
         .NAME='TXTF06'                 
    ENDWITH          
    THIS.ADDOBJECT('TXTF08','TEXTBOX')
    WITH THIS.TXTF08
         .VISIBLE=INT_028        
         .LEFT=INT_015*265
         .TOP=INT_015*85
         .WIDTH=INT_015*49
         .NAME='TXTF08'
    ENDWITH     
    THIS.ADDOBJECT('TXTF10','TEXTBOX')
    WITH THIS.TXTF10
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*110
         .WIDTH=INT_015*447
         .MAXLENGTH=100
         .NAME='TXTF10'                 
    ENDWITH                  
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.

     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   

     ENDIF                      
     IF THISFORM.KEY_LIST.DISPLAYVALUE='依部門編號排列'
        SELE A14
     ELSE
        SELE B01
     ENDIF      
     SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE 
        THISFORM.GRID1.ENABLED=.T.           
        THISFORM.GRID1.SETFOCUS                       
     IF THISFORM.GRID1.ACTIVEROW=0
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
     THISFORM.KEY_LIST.ENABLED=.T.
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE B11
     IF THISFORM.SHRGROUP.ENABLED=.F.     
        THISFORM.GRID2.READONLY=.T.     
        THISFORM.GRID2.SETFOCUS    
     ENDIF     
     THISFORM.GRID2.READONLY=.T.  
     THISFORM.GRID2.SETFOCUS 
     IF THISFORM.GRID2.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF011.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''        
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.  
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC   
  PROC INIT              
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.T.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.                
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限             
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.       
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')             
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146) 
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='部門編號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門名稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='A14.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(B11.F05>=DATE()-120 .AND. B11.F05<DATE()-90,RGB(255,255,0),IIF(B11.F05<DATE()-120,RGB(255,0,0),''))","COLUMN")                          
       THISFORM.GRID2.COLUMN5.VISIBLE=INT_028
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
	   THISFORM.grid2.COLUMN3.HEADER1.CAPTION='庫存數量'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='最後異動'
	   THISFORM.grid2.COLUMN5.HEADER1.CAPTION='使用對象'  	      	   	   
	   THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='採購用途'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B11.F03'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B11.F04'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B11.F05'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE='C01_1.F04'	   
	   THISFORM.grid2.COLUMN6.CONTROLSOURCE='B11.F06'
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*149
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*63
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80       
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*149
       THISFORM.grid1.READONLY=.T.    
       THISFORM.grid2.READONLY=.T.       
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.      
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依部門編號排列'       
       JK='部門編號'
       SELE A14
       GO TOP
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A14.F01
       THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=A14.F02
  ENDPROC           
  PROC KEY_LIST.INIT 
       with this 
           .additem('依部門編號排列')
           .additem('依料品編號排列')
           IF INT_028
             .additem('依對象編號排列')           
           ENDIF
       endwith      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE              
       SET RELATION OFF INTO B1A  
       SELECT C01_1
       SET RELATION OFF INTO B11
       SELE A14
       SET RELA OFF INTO B11
       SELE B01
       SET RELA OFF INTO B11
       SELE B11
       SET RELATION OFF INTO C01_1
       SET RELA OFF INTO A14
       SET RELA OFF INTO B01       

       DO CASE
          CASE THIS.DISPLAYVALUE='依部門編號排列'
               THISFORM.GRID1.RECORDSOURCE=''
               THISFORM.GRID1.CHILDORDER=''
               THISFORM.GRID2.LINKMASTER=''
               THISFORM.GRID2.RELATIONALEXPR=''          
               THISFORM.PAGEFRAME1.PAGE1.CAPTION='依照部門搜尋紀錄'
               SELE A14
               GO TOP               
               AREA1='A14'
               SELE B11
               SET ORDER TO B111     
               SET RELATION TO F03 INTO B01   
               SET RELATION TO F08 INTO C01_1 ADDI
               SET RELATION TO F01+F03+F08 INTO B1A ADDI               
               THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='部門編號'
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*74
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.MAXLENGTH=5
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A14.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*140
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=A14.F02
               THISFORM.PAGEFRAME1.PAGE1.LBLF18.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE1.LBLF181.VISIBLE=.F.               
               THISFORM.PAGEFRAME1.PAGE1.LBLF33.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE1.LBLF331.VISIBLE=.F.               
               THISFORM.PAGEFRAME1.PAGE1.LBLF23.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE1.LBLF231.VISIBLE=.F.       
               THISFORM.PAGEFRAME1.PAGE2.LBLF18.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF181.VISIBLE=INT_028               
               THISFORM.PAGEFRAME1.PAGE2.LBLF33.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF331.VISIBLE=INT_028               
               THISFORM.PAGEFRAME1.PAGE2.LBLF23.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF231.VISIBLE=INT_028                                                                                                                                                    
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.ENABLED=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF03.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF031.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.ENABLED=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF08.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.TXTF08.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF081.VISIBLE=INT_028               
               THISFORM.GRID1.RECORDSOURCE='A14'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='部門編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='部門名稱'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='A14.F01'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'   
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*50
               THISFORM.GRID2.LINKMASTER='A14'
               THISFORM.GRID2.RELATIONALEXPR='F01'
               THISFORM.GRID2.CHILDORDER='B111'            
               THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
               THISFORM.grid2.COLUMN1.CONTROLSOURCE='B11.F03'
               THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
               THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
               THISFORM.grid2.COLUMN2.CONTROLSOURCE='B01.F02' &&"IIF(SEEK(B11.F03,'B01'),B01.F02,'')"
               THISFORM.grid2.COLUMN2.WIDTH=INT_015*100         
               THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='使用對象'               
               THISFORM.grid2.COLUMN5.CONTROLSOURCE='C01_1.F04'  &&"IIF(SEEK(B11.F08,'C01_1'),C01_1.F04,'')"
          CASE THIS.DISPLAYVALUE='依料品編號排列'
               THISFORM.PAGEFRAME1.PAGE1.CAPTION='依照料號搜尋紀錄'        
               THISFORM.GRID1.RECORDSOURCE=''
               THISFORM.GRID1.CHILDORDER=''
               THISFORM.GRID2.LINKMASTER=''
               THISFORM.GRID2.RELATIONALEXPR=''                 
               SELE B01
               GO TOP
               AREA1='B01'
               SELE B11
               SET ORDER TO B112
               SET RELATION TO F01+F03+F08 INTO B1A         
*!*	               SET RELATION  TO F01 INTO A14  
*!*	               SET RELATION TO F08 INTO C01_1 ADDI               
               THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='料品編號'
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*261
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.MAXLENGTH=43
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B01.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*337
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B01.F02
               THISFORM.PAGEFRAME1.PAGE1.LBLF18.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE1.LBLF181.VISIBLE=.F.               
               THISFORM.PAGEFRAME1.PAGE1.LBLF33.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE1.LBLF331.VISIBLE=.F.               
               THISFORM.PAGEFRAME1.PAGE1.LBLF23.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE1.LBLF231.VISIBLE=.F.     
               THISFORM.PAGEFRAME1.PAGE2.LBLF18.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF181.VISIBLE=INT_028             
               THISFORM.PAGEFRAME1.PAGE2.LBLF33.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF331.VISIBLE=INT_028              
               THISFORM.PAGEFRAME1.PAGE2.LBLF23.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF231.VISIBLE=INT_028                                                                                                              
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.ENABLED=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF03.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF031.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.ENABLED=.F.         
               THISFORM.PAGEFRAME1.PAGE2.LBLF08.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.TXTF08.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF081.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.LEFT=INT_015*13
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.TOP=INT_015*14          
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.LEFT=INT_015*126
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.TOP=INT_015*13
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.LEFT=INT_015*65
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.TOP=INT_015*10               
               THISFORM.GRID1.RECORDSOURCE='B01'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料品編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B01.F01'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B01.F02'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149   
               THISFORM.GRID2.LINKMASTER='B01'
               THISFORM.GRID2.RELATIONALEXPR='F01'
               THISFORM.GRID2.CHILDORDER='B112'  
               THISFORM.grid2.COLUMN1.HEADER1.CAPTION='部門編號'
               THISFORM.grid2.COLUMN1.CONTROLSOURCE='B11.F01'
               THISFORM.grid2.COLUMN1.WIDTH=INT_015*50               
               THISFORM.grid2.COLUMN2.HEADER1.CAPTION='部門名稱'
               THISFORM.grid2.COLUMN2.CONTROLSOURCE="IIF(SEEK(B11.F01,'A14'),A14.F02,'')"
               THISFORM.grid2.COLUMN2.WIDTH=INT_015*50           
               THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='使用對象'               
               THISFORM.grid2.COLUMN5.CONTROLSOURCE="IIF(SEEK(B11.F08,'C01_1'),C01_1.F04,'')"
          CASE THIS.DISPLAYVALUE='依對象編號排列'

               THISFORM.PAGEFRAME1.PAGE1.CAPTION='依照部門搜尋紀錄'
               SELE C01_1
               GO TOP
               AREA1='C01_1'
               SELE B11
               SET ORDER TO B113
               SET RELATION TO F01+F03+F08 INTO B1A           
*!*	               SET RELATION  TO F03 INTO B01  
*!*	               SET RELATION TO F01 INTO A14 ADDI
               THISFORM.PAGEFRAME1.PAGE1.LBLF01.CAPTION='對象編號'
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.WIDTH=INT_015*74
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.MAXLENGTH=5
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=C01_1.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.LEFT=INT_015*140
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=C01_1.F05
               THISFORM.PAGEFRAME1.PAGE1.LBLF18.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE1.LBLF181.VISIBLE=INT_028              
               THISFORM.PAGEFRAME1.PAGE1.LBLF33.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE1.LBLF331.VISIBLE=INT_028             
               THISFORM.PAGEFRAME1.PAGE1.LBLF23.VISIBLE=INT_028
               THISFORM.PAGEFRAME1.PAGE1.LBLF231.VISIBLE=INT_028      
               THISFORM.PAGEFRAME1.PAGE2.LBLF18.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF181.VISIBLE=.F.               
               THISFORM.PAGEFRAME1.PAGE2.LBLF33.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF331.VISIBLE=.F.               
               THISFORM.PAGEFRAME1.PAGE2.LBLF23.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF231.VISIBLE=.F.                                                                      
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.ENABLED=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF03.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF031.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.TXTF03.ENABLED=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF08.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF08.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF081.VISIBLE=.F.
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.VISIBLE=.T.
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.VISIBLE=.T.               
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.VISIBLE=.T.                              
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.LEFT=INT_015*215
               THISFORM.PAGEFRAME1.PAGE2.LBLF01.TOP=INT_015*89             
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.LEFT=INT_015*335
               THISFORM.PAGEFRAME1.PAGE2.LBLF011.TOP=INT_015*89                 
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.LEFT=INT_015*265
               THISFORM.PAGEFRAME1.PAGE2.TXTF01.TOP=INT_015*85  
               THISFORM.GRID1.RECORDSOURCE='C01_1'
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='對象編號'
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象名稱'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='C01_1.F01'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='C01_1.F04'   
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
               THISFORM.GRID2.LINKMASTER='C01_1'
               THISFORM.GRID2.RELATIONALEXPR='F08'
               THISFORM.GRID2.CHILDORDER='B113'            
               THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
               THISFORM.grid2.COLUMN1.CONTROLSOURCE='B11.F03'
               THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
               THISFORM.grid2.COLUMN2.HEADER1.CAPTION='品名規格'
               THISFORM.grid2.COLUMN2.CONTROLSOURCE="IIF(SEEK(B11.F03,'B01'),B01.F02,'')"
               THISFORM.grid2.COLUMN2.WIDTH=INT_015*100                 
               THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='存放部門'               
               THISFORM.grid2.COLUMN5.CONTROLSOURCE="IIF(SEEK(B11.F01,'A14'),A14.F02,'')"
       ENDCASE      
        THISFORM.PAGEFRAME1.ACTIVEPAGE=2
        THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(B11.F05>=DATE()-120 .AND. B11.F05<DATE()-90,RGB(255,255,0),IIF(B11.F05<DATE()-120,RGB(255,0,0),''))","COLUMN")                                                        
        THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE &AREA1
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       DO CASE
          CASE THISFORM.KEY_list.DISPLAYVALUE='依部門編號排列'
               THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=A14.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=A14.F02
          CASE THISFORM.KEY_list.DISPLAYVALUE='依料品編號排列'
               THISFORM.PAGEFRAME1.page1.TXTF01.VALUE=B01.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=B01.F02
          CASE THISFORM.KEY_list.DISPLAYVALUE='依對象編號排列'  
               THISFORM.PAGEFRAME1.page1.TXTF01.VALUE=C01_1.F01
               THISFORM.PAGEFRAME1.PAGE1.LBLF011.CAPTION=C01_1.F04             
               THISFORM.PAGEFRAME1.PAGE1.LBLF181.CAPTION=IIF(SEEK(C01_1.F18,'A01'),A01.F03,'')
               THISFORM.PAGEFRAME1.PAGE1.LBLF331.CAPTION=IIF(SEEK(C01_1.F33,'A01'),A01.F03,'')       
               THISFORM.PAGEFRAME1.PAGE1.LBLF231.CAPTION=IIF(SEEK(C01_1.F23,'A01'),A01.F03,'')   
       ENDCASE
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF01.VALUE=F01
       THISFORM.PAGEFRAME1.PAGE2.LBLF011.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=F04
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=F05
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=F06
       THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=F08
       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=B1A.F10
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=C01_1.F04        
       THISFORM.PAGEFRAME1.PAGE2.LBLF181.CAPTION=IIF(SEEK(C01_1.F18,'A01'),A01.F03,'')
       THISFORM.PAGEFRAME1.PAGE2.LBLF331.CAPTION=IIF(SEEK(C01_1.F33,'A01'),A01.F03,'')       
       THISFORM.PAGEFRAME1.PAGE2.LBLF231.CAPTION=IIF(SEEK(C01_1.F23,'A01'),A01.F03,'')              
       THISFORM.PAGEFRAME1.PAGE2.LBLF171.CAPTION=B1A.F17
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       if thisform.pageframe1.activepage=1
          thisform. CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
  ENDPROC 
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.    
     THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')
     THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.F.
     THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
  ENDPROC     
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     SELECT B1A
     SEEK B11.F01+B11.F03+B11.F08
     IF !FOUND()
         APPEND BLANK 
         REPLACE F01 WITH B11.F01
         REPLACE F03 WITH B11.F03
         REPLACE F08 WITH B11.F08
     ENDIF
     REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE     
     REPLACE F17 WITH DTOC(DATE())+' '+IIF(SEEK(SYS_OPER,'A01'),A01.F03,'')
     SELE B11
     THISFORM.SHRGROUP.ABANDON_BOTT.CLICK         
  ENDPROC  
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  

      THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.F.

      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1   
           THISFORM.GRID1.ENABLED=.T.
          THISFORM.GRID2.ENABLED=.T.
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
      ELSE
           THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.T.
           THISFORM.GRID1.ENABLED=.F.
          THISFORM.GRID2.ENABLED=.T.      
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0

            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
  ENDPROC  
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
     THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC  

ENDDEFINE    


************************************************************
PROCEDURE PNT_PRC  
   CREATE CURSOR INVRT;
   (F01 C(5),F02 C(43),FIN N(16,4),FQY N(16,4),FND N(16,4),RTE N(11,6))
   INDEX ON F01+F02 TAG INVRT
   B25='B25'+LEFT(DTOS(DATE()),6)   &&本月庫存月報表檔
   IF !USED('&B25')
       SELE 0
       USE (B25) ALIA B25 INDE (B25) 
   ELSE
       SELE B25
   ENDIF
   SET ORDER TO 1     
  GO TOP
  DO WHILE !EOF()
         SELECT INVRT
         APPEND BLANK
         REPLACE FIN  WITH B25.F03
         REPLACE F01 WITH B25.F01
         REPLACE F02 WITH B25.F02
         REPLACE FQY WITH B25.F05+B25.F06+B25.F09+B25.F11+B25.F14+B25.F17+B25.F19+B25.F20
         REPLACE FND WITH B25.F15
         SELECT B25
         SKIP
  ENDDO
  SELECT B25
  USE
  IF !USED('A23')
      SELECT 0
      USE A23
  ELSE
     SELECT A23
  ENDIF       
  SET ORDER TO 1
  SEEK LEFT(DTOS(DATE()),6)+'01'
  SKIP -1 
  IF !BOF()  
      B25='B25'+LEFT(DTOS(F01),6)  &&上個月庫存月報
      IF !USED('&B25')
           SELE 0
          USE (B25) ALIA B25 INDE (B25) 
      ELSE
          SELE B25
      ENDIF
      SET ORDER TO 1      
      SELECT INVRT
      GO TOP
      DO WHILE !EOF()
             SELECT B25
             SEEK INVRT.F01+INVRT.F02
             IF FOUND()
                 SELECT INVRT
                 REPLACE FIN  WITH B25.F03
                 REPLACE FQY WITH FQY+(B25.F05+B25.F06+B25.F09+B25.F11+B25.F14+B25.F17+B25.F19+B25.F20)
                 REPLACE FND WITH FND+B25.F15        
             ELSE
                SELECT INVRT
                REPLACE FIN WITH 0             
             ENDIF     
             SELECT INVRT
             SKIP
      ENDDO
      SELECT B25
      USE
      SELECT A23
      SKIP -1
      IF BOF()
          USE
      ELSE
          B25='B25'+LEFT(DTOS(F01),6)   &&上上個月庫存月報表
          IF !USED('&B25')
               SELE 0
              USE (B25) ALIA B25 INDE (B25) 
          ELSE
              SELE B25
          ENDIF
          SET ORDER TO 1      
          SELECT INVRT
          GO TOP
          DO WHILE !EOF()
                 SELECT B25
                 SEEK INVRT.F01+INVRT.F02
                 IF FOUND()
                     SELECT INVRT
                     REPLACE FIN  WITH B25.F03
                     REPLACE FQY WITH FQY+(B25.F05+B25.F06+B25.F09+B25.F11+B25.F14+B25.F17+B25.F19+B25.F20)
                     REPLACE FND WITH FND+B25.F15    
                 ELSE
                     SELECT INVRT
                     REPLACE FIN WITH 0                                      
                 ENDIF     
                 SELECT INVRT
                 SKIP
          ENDDO
          SELECT B25
          USE      
          SELECT A23
          USE      
      ENDIF    
  ELSE
       SELECT A23
       USE
  ENDIF
  SELECT INVRT
  REPLACE RTE WITH FQY/IIF(FIN+FND<>0,(FIN+FND)/4,1)  ALL
  LK=A14.F01

              FLG='0'

            ANS_RANGE=CREATEOBJECT("ANS_RANGE")  
            ANS_RANGE.SHOW    
            IF FLG<>'1'
               =MESSAGEBOX('無此範圍資料',0+48,'警示')
            ENDIF   
            FLG='0'     


ENDPROC
*******************************

***********************************************呆滯天數範圍選定
DEFINE CLASS ANS_RANGE AS FORM
  AUTOCENTER=.T.
  CAPTION='請輸入條件範圍'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*260
  WIDTH=INT_015*250
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_RANGE'
  ADD OBJECT LABELA AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*10,;
      TOP=INT_015*25,;
      NAME='LABELA',;
      CAPTION='輸入呆滯天數'  
  ADD OBJECT LABELB AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*80,;
      TOP=INT_015*52,;
      NAME='LABELB',;
      CAPTION='或是'            
  ADD OBJECT LABELC AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*10,;
      TOP=INT_015*80,;
      NAME='LABELC',;
      CAPTION='三個月存貨週轉率低於'        
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*132,;
      TOP=INT_015*25,;
      NAME='LABEL1',;
      CAPTION='天以上(含)'
 
  
  ADD OBJECT TEXT1 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*20,;
      LEFT=INT_015*90,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*40,;
      INPUTMASK='9999',;
      ALIGNMENT=3,;
      NAME='TEXT1'

  ADD OBJECT TEXT3 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*75,;
      LEFT=INT_015*140,;
      HEIGHT=INT_015*25,;        
      WIDTH=INT_015*80,;      
      INPUTMASK='9999.999999',;
      ALIGNMENT=3,;            
      NAME='TEXT3'            
ADD OBJECT PCKCHS AS OPTIONGROUP WITH;
      LEFT=INT_015*10,;
      TOP=INT_015*123,;
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*230,;      
      BUTTONCOUNT=3,;
      OPTION1.CAPTION='全部列印',;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.LEFT=INT_015*4,;
      OPTION1.TOP=INT_015*3,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='不含零數',;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.LEFT=INT_015*84,;
      OPTION2.TOP=INT_015*3,;
      OPTION2.AUTOSIZE=.T.,;          
      OPTION3.CAPTION='只印零數',;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.LEFT=INT_015*164,;
      OPTION3.TOP=INT_015*3,;
      OPTION3.AUTOSIZE=.T.,;                
      NAME='PCKCHS'                    
ADD OBJECT OUTPUT AS OPTIONGROUP WITH;
      LEFT=INT_015*30,;
      TOP=INT_015*173,;
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*180,;      
      BUTTONCOUNT=2,;
      OPTION1.CAPTION='轉EXCEL檔',;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.LEFT=INT_015*4,;
      OPTION1.TOP=INT_015*3,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='列印報表',;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.LEFT=INT_015*94,;
      OPTION2.TOP=INT_015*3,;
      OPTION2.AUTOSIZE=.T.,;          
      NAME='OUTPUT'                         
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*40,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*214,;  
      WIDTH=INT_015*80,;
      CAPTION='\<Y.執行',;
      TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*120,;
      TOP=INT_015*214,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'
    PROCEDURE INIT 
          THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
           THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')      
           THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')
           THISFORM.OUTPUT.VALUE=1
           THISFORM.TEXT1.VALUE=0
           
           THISFORM.TEXT3.VALUE=1           

    ENDPROC

 
       PROCEDURE CMND1.CLICK
          IF !USED('C20')
              SELECT 0
              USE C20
           ELSE
              SELECT C20
           ENDIF
           SET ORDER TO 1       
          SELE B11.F01,;
          B11.F03,;
          B11.F04,;
          B11.F05,;
          B11.F06,;
          B11.F08,;
          A14.F02,;
          B01.F02,;
          B01.F37,;
          INVRT.RTE,;
          VAL(IIF(SEEK(B11.F03,'C20'),C20.F03,'')) PKS;
          FROM B11,A14,B01,INVRT WHERE B11.F01=LK AND B11.F04<>0 AND A14.F01=B11.F01 AND B01.F01=B11.F03 AND (DATE()-B11.F05>=THISFORM.TEXT1.VALUE;
           OR INVRT.RTE<THISFORM.TEXT3.VALUE)  AND INVRT.F01+INVRT.F02=B11.F01+B11.F03 ORDER BY B11.F03 INTO CURSOR BA1 NOWAIT &&
          IF _TALLY>0
              FLG='1'
              DO CASE
                 CASE THISFORM.PCKCHS.VALUE=1
                      SELECT * FROM BA1 INTO CURSOR BAA ORDER BY F03 NOWAIT
                 CASE THISFORM.PCKCHS.VALUE=2
                      SELECT * FROM BA1 WHERE F04>=PKS INTO CURSOR BAA ORDER BY F03 NOWAIT
                 CASE THISFORM.PCKCHS.VALUE=3
                      SELECT * FROM BA1 WHERE F04<PKS INTO CURSOR BAA ORDER BY F03 NOWAIT
                 
              ENDCASE
              IF THISFORM.OUTPUT.VALUE=2     &&直接列印
                 CALC SUM(F04*F37) TO TMP1
                 REPORT FORM ALLTRIM(INT_116)+'B11' TO PRINT PROMPT PREVIEW   
              ELSE                         &&轉EXCEL檔
                 
                 FILE_NAME='B11庫存明細'+'-'+B11.F01
                 IF  ALLTRIM(A02.F08)='*'    &&如果有權限看成本的話
                     SELECT BAA.F01 部門編號,A14.F02 部門名稱,BAA.F03 料號,B01.F02 品名規格,BAA.F04 庫存數量,BAA.PKS 包裝基量,B01.F37 成本單價,BAA.F05 最後異動日,BAA.F06 用途,DATE()-BAA.F05 呆滯天數,INVRT.RTE 存貨週轉率,BAA.F08 客戶編號,IIF(SEEK(BAA.F08,'C01_1'),C01_1.F05,SPACE(8)) 客戶簡稱,IIF(SEEK(IIF(SEEK(BAA.F08,'C01_1','C01_11'),C01_1.F18,SPACE(5)),'A01'),A01.F03,SPACE(8)) 業務A,;
                     IIF(SEEK(IIF(SEEK(BAA.F08,'C01_1','C01_11'),C01_1.F33,SPACE(5)),'A01'),A01.F03,SPACE(8)) 業務B,IIF(SEEK(IIF(SEEK(BAA.F08,'C01_1','C01_11'),C01_1.F23,SPACE(5)),'A01'),A01.F03,SPACE(8)) 業務助理,;
                     IIF(SEEK(BAA.F01+BAA.F03+BAA.F08,'B1A'),B1A.F10,SPACE(60)) 備註說明,IIF(SEEK(BAA.F01+BAA.F03+BAA.F08,'B1A'),B1A.F17,SPACE(17)) 安全資料 FROM BAA,B01,A14,INVRT;
                      WHERE BAA.F01=LK AND (DATE()-BAA.F05>=THISFORM.TEXT1.VALUE  OR INVRT.RTE<THISFORM.TEXT3.VALUE) AND B01.F01=BAA.F03 AND A14.F01=BAA.F01  AND INVRT.F01+INVRT.F02=BAA.F01+BAA.F03 INTO CURSOR B11A ORDER BY BAA.F01,BAA.F03 NOWAIT                      
                 ELSE                 
                     SELECT BAA.F01 部門編號,A14.F02 部門名稱,BAA.F03 料號,B01.F02 品名規格,BAA.F04 庫存數量,BAA.PKS 包裝基量,BAA.F05 最後異動日,BAA.F06 用途,DATE()-BAA.F05 呆滯天數,INVRT.RTE 存貨週轉率,BAA.F08 客戶編號,IIF(SEEK(BAA.F08,'C01_1'),C01_1.F05,SPACE(8)) 客戶簡稱,IIF(SEEK(IIF(SEEK(BAA.F08,'C01_1','C01_11'),C01_1.F18,SPACE(5)),'A01'),A01.F03,SPACE(8)) 業務A,;
                     IIF(SEEK(IIF(SEEK(BAA.F08,'C01_1','C01_11'),C01_1.F33,SPACE(5)),'A01'),A01.F03,SPACE(8)) 業務B,IIF(SEEK(IIF(SEEK(BAA.F08,'C01_1','C01_11'),C01_1.F23,SPACE(5)),'A01'),A01.F03,SPACE(8)) 業務助理,;
                     IIF(SEEK(BAA.F01+BAA.F03+BAA.F08,'B1A'),B1A.F10,SPACE(60)) 備註說明,IIF(SEEK(BAA.F01+BAA.F03+BAA.F08,'B1A'),B1A.F17,SPACE(17)) 安全資料 FROM BAA,B01,A14,INVRT ;
                      WHERE BAA.F01=LK AND (DATE()-BAA.F05>=THISFORM.TEXT1.VALUE OR INVRT.RTE<THISFORM.TEXT3.VALUE) AND B01.F01=BAA.F03 AND A14.F01=BAA.F01 AND INVRT.F01+INVRT.F02=BAA.F01+BAA.F03 INTO CURSOR B11A ORDER BY BAA.F01,BAA.F03 NOWAIT                  
                 ENDIF                                                           
  	             GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
	             IF EMPTY(GCDELIMFILE)  && ESC PRESSED
  	                RETURN
	             ELSE
	                ON ERROR DO FILE_IMPACT
                    SELECT B11A
                    IF INT_028=.F.
                       COPY TO B11KB
                       SELECT B11A 
                       USE 
                       SELECT 0 
                       USE B11KB ALIAS B11A
                       IF !USED('P05')                          
                           SELECT 0
                           USE P05
                       ELSE 
                          SELECT P05    
                       ENDIF    
                       SET ORDER TO P051
                       IF !USED('C01')
                          SELECT 0
                          USE C01
                       ELSE 
                          SELECT C01
                       ENDIF
                       SET ORDER TO C011      
                       IF !USED('C03')
                          SELECT 0
                          USE C03
                       ELSE
                          SELECT C03
                       ENDIF
                       SET ORDER TO C031      
                       SELECT B11A
                       GO TOP
                       DO WHILE !EOF()
                          SELECT P05
                          SEEK LEFT(B11A.用途,10)
                          IF FOUND()
                             SELECT B11A
                             REPLACE 客戶編號 WITH P05.F04
                          ELSE
                             SELECT C03
                             SEEK LEFT(B11A.用途,10)    
                             IF FOUND()
                                SELECT B11A
                                REPLACE 客戶編號 WITH C03.F03
                             ELSE
                                SEEK 'CA'+LEFT(B11A.用途,8)
                                IF FOUND()
                                   SELECT B11A
                                   REPLACE 客戶編號 WITH C03.F03
                                ENDIF   
                             ENDIF                            
                          ENDIF   
                          SELECT B11A
                          REPLACE 客戶簡稱 WITH IIF(SEEK(客戶編號,'C01'),C01.F04,'     ')
                          REPLACE 業務A WITH IIF(SEEK(IIF(SEEK(客戶編號,'C01'),C01.F18,'    '),'A01'),A01.F03,'     ')
                          REPLACE 業務B WITH IIF(SEEK(IIF(SEEK(客戶編號,'C01'),C01.F33,'     '),'A01'),A01.F03,'     ')
                          REPLACE 業務助理  WITH IIF(SEEK(IIF(SEEK(客戶編號,'C01'),C01.F23,'     '),'A01'),A01.F03,'     ')
                          SKIP
                       ENDDO
                      
                       SELECT P05
                       USE
                       SELECT C01
                       USE
                       SELECT C03
                       USE
                    ENDIF   
                    SELECT B11A
  	                COPY TO (GCDELIMFILE) TYPE XL5   
	                =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗')
	             ENDIF                             
	             SELECT B11A 
                 USE         
                 SELECT BAA
                 USE                                                                                        
              ENDIF                      
           ENDIF
           SELECT BA1 
           USE              
           SELECT C20
           USE
          THISFORM.CMND2.CLICK
       ENDPROC
       PROCEDURE CMND2.CLICK
                 
                 FLG='1'   
                THISFORM.RELEASE                   
       ENDPROC                 
ENDDEFINE  