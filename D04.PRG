close all
clear  
FLG='0'
CHK_STR=0
FTR_STR=0
FCH=''
CHK=''
R=0
QTY=0
TQTY=0
ASSIS_NO=''
SALES_B_NO=''
SALES_A_NO=''
FILE_NAME=''
HD1='D001 '
HD2='DA'
HD3='採購訂單'
AREA1='D03'
AREA2='D04'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
A24='A24'+LEFT(DTOS(DATE()),6)
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1  
IF !USED('C01')
   SELE 0
   USE  C01
ELSE
   SELECT  C01
ENDIF
SET ORDER TO C011   
IF !USED('D00')
   SELE 0
   USE D00
ELSE
   SELE D00
ENDIF
SET ORDER TO 1      
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'D04'
IF !USED('E08')
   SELECT 0
   USE E08
ELSE
   SELECT E08
ENDIF
SET ORDER TO E083      
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO B011
IF !USED('P05')
   SELE 0
   USE P05
ELSE
   SELE P05
ENDIF
SET ORDER TO P051
IF !USED('P06')
   SELE 0
   USE P06
ELSE
   SELE P06
ENDIF
SET ORDER TO 1
IF !USED('P07')
   SELE 0
   USE P07
ELSE
   SELE P07
ENDIF
SET ORDER TO P071 
IF !USED('D01')
   SELE 0
   USE D01 INDE D01
ELSE
   SELE D01
ENDIF
SET ORDER TO D011
     
IF !USED('D02')
   SELE 0
   USE D02 INDE D02
ELSE
   SELE D02
ENDIF
SET ORDER TO D023
IF !USED('D38')
   SELE 0
   USE D38
ELSE
  SELE D38
ENDIF
SET ORDER TO D381     
IF !USED('D07')
   SELE 0
   USE D07 INDE D07
ELSE
   SELE D07
ENDIF
SET ORDER TO D074
IF !USED('D03')
   SELE 0
   USE D03 INDE D03
ELSE
   SELE D03
ENDIF
SET ORDER TO D031
set rela to f03 into D01
SET RELA TO F07 INTO a01 addi
if !used('D04')
   SELE 0
   USE D04 
ELSE
   SELE D04
ENDIF
SET ORDER TO D041      
SET RELA TO F02 INTO B01
D04FORM=CREATEOBJECT("TKD04")
D04FORM.SHOW  
DEFINE CLASS TKD04 AS FORM
  CAPTION='D04.採購訂單'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1 
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKD04'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*250,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=3,;            
      RECORDSOURCE='D03',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      TOP=INT_015*255,;
      HEIGHT=INT_015*286,;        
      COLUMNCOUNT=5,;            
      RECORDSOURCE='D04',;
      LINKMASTER='D03',;
      RELATIONALEXPR='F02',;
      CHILDORDER='D041',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*190,;
      LEFT=INT_015*683           
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*68,;
      CAPTION='\<A.進貨計劃',;
      TOOLTIPTEXT='查看或增修刪進貨方式'
      NAME='ANS_BOTT'      
  ADD OBJECT RCC_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*85,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*68,;      
      CAPTION='\<B.進貨紀錄',;
      TOOLTIPTEXT='查看此筆之進貨紀錄',;
      NAME='RCC_BOTT'                       
  ADD OBJECT SHR_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*157,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*68,;      
      CAPTION='\<S.確認訂單',;
      TOOLTIPTEXT='確認此張採購訂單',;
      VISIBLE=INT_020,;
      ENABLED=INT_020,;
      NAME='SHR_BOTT'                               
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*8
          .WIDTH=INT_015*50
          .CAPTION='採購單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*33
         .WIDTH=INT_015*50
         .CAPTION='廠商編號'
     ENDWITH
     THIS.ADDOBJECT('LBLF031','LABEL')
     WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*33
         .AUTOSIZE=.T.
     ENDWITH
     THIS.ADDOBJECT('LBLF12','LABEL')
     WITH THIS.LBLF12
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*58
         .WIDTH=INT_015*50
         .CAPTION='交貨地點'
     ENDWITH         
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*83
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH    
     THIS.ADDOBJECT('LBLF13','LABEL')
     WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*108
         .WIDTH=INT_015*50
         .CAPTION='運貨方式'
     ENDWITH         
     THIS.ADDOBJECT('LBLF11','LABEL')
     WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*133
         .WIDTH=INT_015*50
         .CAPTION='已列印否'         
     ENDWITH         
     THIS.ADDOBJECT('LBLF111','LABEL')
     WITH THIS.LBLF111
         .VISIBLE=.T.
         .LEFT=INT_015*66
         .TOP=INT_015*133
         .AUTOSIZE=.T.
     ENDWITH              
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*8
         .WIDTH=INT_015*50
         .CAPTION='採購日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLF14','LABEL')
     WITH THIS.LBLF14
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*33
         .WIDTH=INT_015*50
         .CAPTION='交貨日期'
     ENDWITH         
     THIS.ADDOBJECT('LBLF05','LABEL')
     WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*58
         .WIDTH=INT_015*50
         .CAPTION='幣        別'
     ENDWITH    
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*83
         .WIDTH=INT_015*50
         .CAPTION='外加稅金'
     ENDWITH          
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*133
         .WIDTH=INT_015*50
         .CAPTION='採購總價'         
     ENDWITH    
     THIS.ADDOBJECT('LBLF061','LABEL')
     WITH THIS.LBLF061
         .VISIBLE=.T.
         .LEFT=INT_015*418
         .TOP=INT_015*133
         .autosize=.t.
     ENDWITH         
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*158
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*158
         .autosize=.t.
     ENDWITH         
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=INT_020
         .LEFT=INT_015*368
         .TOP=INT_015*183
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF071','LABEL')
     WITH THIS.LBLF071
         .VISIBLE=INT_020
         .LEFT=INT_015*419
         .TOP=INT_015*183
         .AUTOSIZE=.T.
     ENDWITH                   
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*4
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF03','TXTF03')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*29
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
     THIS.ADDOBJECT('TXTF12','TEXTBOX')          
     WITH THIS.TXTF12
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*54
          .WIDTH=INT_015*288
          .HEIGHT=INT_015*25
          .MAXLENGTH=40
     ENDWITH     
     THIS.ADDOBJECT('TXTF04','TEXTBOX')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*79
          .WIDTH=INT_015*288
          .HEIGHT=INT_015*25
          .MAXLENGTH=40
     ENDWITH      
     THIS.ADDOBJECT('TXTF13','TEXTBOX')          
     WITH THIS.TXTF13
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*104
          .WIDTH=INT_015*68
          .HEIGHT=INT_015*25
          .MAXLENGTH=8
     ENDWITH          
     THIS.ADDOBJECT('TRANS_STYLE','TRANS_STYLE')               
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*4
          .WIDTH=INT_015*73
          .HEIGHT=INT_015*25
     ENDWITH        
     THIS.ADDOBJECT('TXTF14','TEXTBOX')          
     WITH THIS.TXTF14
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*29
          .WIDTH=INT_015*73
          .HEIGHT=INT_015*25
     ENDWITH        
     THIS.ADDOBJECT('TXTF05','TEXTBOX')          
     WITH THIS.TXTF05
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*54
          .WIDTH=INT_015*73
          .HEIGHT=INT_015*25
          .MAXLENGTH=4
     ENDWITH      
     THIS.ADDOBJECT('CRCY','CRCY')          
     THIS.ADDOBJECT('TXTF10','TEXTBOX')          
     WITH THIS.TXTF10
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*79
          .WIDTH=INT_015*20
          .HEIGHT=INT_015*1
     ENDWITH      
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF02','LABEL')
	WITH THIS.LBLF02  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*7
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF021','LABEL')
    WITH THIS.LBLF021
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*7
	     .autosize=.t.
	ENDWITH     
	THIS.ADDOBJECT('LBLF13','LABEL')
    WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*32
	     .WIDTH=INT_015*50
	     .CAPTION='廠商料號'
	ENDWITH     
	THIS.ADDOBJECT('LBLF20','LABEL')
    WITH THIS.LBLF20
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='包裝基量'
	ENDWITH     
	THIS.ADDOBJECT('LBLF21','LABEL')
    WITH THIS.LBLF21
         .VISIBLE=.T.
         .LEFT=INT_015*328
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='最少採購'
	ENDWITH     	
    THIS.ADDOBJECT('LBLF11','Label')
    WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*328
         .TOP=INT_015*32
         .WIDTH=INT_015*50
         .CAPTION='採購用途'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF03','Label')
    WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*82
         .WIDTH=INT_015*50
         .CAPTION='採購數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='採購單價'       
    ENDWITH        
    
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='金額小計'
    ENDWITH  
    THIS.ADDOBJECT('LBLF061','LABEL')
    WITH THIS.LBLF061
         .VISIBLE=.T.           
         .LEFT=INT_015*64
         .TOP=INT_015*132
         .AUTOSIZE=.T.
    ENDWITH  
    THIS.ADDOBJECT('LBLF24','LABEL')
    WITH THIS.LBLF24
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*157
         .WIDTH=INT_015*50
         .CAPTION='備註說明'       
    ENDWITH  
    THIS.ADDOBJECT('LBLDLVD','LABEL')
    WITH THIS.LBLDLVD
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*182
         .WIDTH=INT_015*50
         .CAPTION='交        期'
    ENDWITH  
*!*	    THIS.ADDOBJECT('LBLDLVD1','LABEL')
*!*	    WITH THIS.LBLDLVD1
*!*	         .VISIBLE=.T.           
*!*	         .LEFT=INT_015*64
*!*	         .TOP=INT_015*157
*!*	         .AUTOSIZE=.T.
*!*	    ENDWITH     
   THIS.ADDOBJECT('RTGBOX','EDITBOX')&&文書編輯EDITBOX
      WITH THIS.RTGBOX
          .LEFT=INT_015*65
         .TOP=INT_015*177
         .WIDTH=INT_015*380
         .HEIGHT=INT_015*48
         .FONTSIZE=INT_015*8
         .VISIBLE=.T.
         .READONLY=.T.
         .MAXLENGTH=600
         .NAME='RTGBOX'           
    ENDWITH     
    THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*82
        .WIDTH=INT_015*50
        .CAPTION='已進貨量'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF081','LABEL')
    WITH THIS.LBLF081
        .VISIBLE=.T.           
        .LEFT=INT_015*380
        .TOP=INT_015*82
        .AUTOSIZE=.T.
    ENDWITH    
    THIS.ADDOBJECT('LBLF16','LABEL')
    WITH THIS.LBLF16
         .VISIBLE=.T.           
         .LEFT=INT_015*328
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='取消數量'                           
    ENDWITH     
    THIS.ADDOBJECT('LBLF161','LABEL')
    WITH THIS.LBLF161
         .VISIBLE=.T.           
         .LEFT=INT_015*380
         .TOP=INT_015*107
         .AUTOSIZE=.T.
    ENDWITH             
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
         .VISIBLE=.T.           
         .LEFT=INT_015*328
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='安全資料'                           
    ENDWITH     
    THIS.ADDOBJECT('LBLF121','LABEL')
    WITH THIS.LBLF121
         .VISIBLE=.T.           
         .LEFT=INT_015*380
         .TOP=INT_015*132
         .AUTOSIZE=.T.
    ENDWITH         
	THIS.ADDOBJECT('TXTF02','TXTF02')
	WITH THIS.TXTF02
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*3
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF02'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF13','TEXTBOX')
	WITH THIS.TXTF13
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*28
	     .WIDTH=INT_015*149
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=20
	     .NAME='TXTF13'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF11','TXTF11')
    WITH THIS.TXTF11
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .HEIGHT=INT_015*25
         .TOP=INT_015*28
         .WIDTH=INT_015*149
         .MAXLENGTH=20
         .NAME='TXTF11'
    ENDWITH     
    THIS.ADDOBJECT('TXTF20','TEXTBOX')
    WITH THIS.TXTF20
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*53
         .WIDTH=INT_015*100
         .INPUTMASK='99999999.99'
         .NAME='TXTF20'
    ENDWITH         
    THIS.ADDOBJECT('TXTF21','TEXTBOX')
    WITH THIS.TXTF21
         .VISIBLE=.T.           
         .LEFT=INT_015*379
         .TOP=INT_015*53
         .WIDTH=INT_015*100
         .INPUTMASK='99999999.99'
         .NAME='TXTF21'
    ENDWITH             
    THIS.ADDOBJECT('TXTF03','TEXTBOX')
    WITH THIS.TXTF03
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*78
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='99999999.99'
         .NAME='TXTF03'                            
    ENDWITH     
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05     
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*103
         .WIDTH=INT_015*100
         .INPUTMASK='9999999.999999'
         .NAME='TXTF05'
    ENDWITH     
    THIS.ADDOBJECT('CMB1','CMB1')
    WITH THIS.CMB1
         .LEFT=INT_015*166
         .TOP=INT_015*103
         .HEIGHT=INT_015*25
         .NAME='CMB1'
    ENDWITH
     THIS.ADDOBJECT('TXTF24','TEXTBOX')
     WITH THIS.TXTF24     
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*153
          .WIDTH=INT_015*255
          .HEIGHT=INT_015*25
          .MAXLENGTH=40
    ENDWITH   
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     SELE D03     
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(ALLTRIM(D03.F07)),RGB(255,0,0),'')","COLUMN")  
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
     ENDIF             
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
        THISFORM.SHR_BOTT.ENABLED=.F.
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限        
        THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.) AND EMPTY(D03.F07)
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.RCC_BOTT.ENABLED=.F.
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE D04  
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.      
        THISFORM.GRID2.SETFOCUS   
        THISFORM.ANS_BOTT.ENABLED=.T.
        THISFORM.RCC_BOTT.ENABLED=IIF(F08>0,.T.,.F.)     
        THISFORM.SHR_BOTT.ENABLED=.F.       
     ENDIF
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=''
*!*	        THISFORM.PAGEFRAME1.PAGE2.LBLDLVD1.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE2.RTGBOX.VALUE=''
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.RCC_BOTT.ENABLED=.F.        
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  

     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC   
  
  PROC INIT       
       SELECT D03
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   &&判斷有無新增的權限
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
       THISFORM.PAGEFRAME1.PAGE1.LBLF06.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限(訂單總計) 
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限       
       THISFORM.PAGEFRAME1.PAGE2.LBLF05.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限(單價)
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限
       THISFORM.PAGEFRAME1.PAGE2.LBLF06.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限(小計)
       THISFORM.PAGEFRAME1.PAGE2.LBLF061.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限    
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='採購單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='D03.F02'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D03.F03'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D01.F04'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(ALLTRIM(D03.F07)),RGB(255,0,0),'')","COLUMN")        
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'
	   THISFORM.grid2.COLUMN2.HEADER1.CAPTION='採購用途'
	   THISFORM.grid2.COLUMN3.HEADER1.CAPTION='採購數量'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='已進貨量'
	   THISFORM.grid2.COLUMN5.HEADER1.CAPTION='取消數量'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='D04.F02'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='D04.F11'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='D04.F03'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='D04.F08'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE='D04.F16'	   
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*100
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*100
*       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(D04.F22=0,RGB(255,0,0),IIF(D04.F22>0 AND D04.F22<D04.F09-D04.F18,RGB(0,255,0),''))","COLUMN")                
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(D04.F22=0,RGB(255,0,0),IIF(D04.F22>0 AND D04.F22<D04.F03-D04.F16,RGB(0,255,0),''))","COLUMN")                
       THISFORM.grid1.READONLY=.T.       
       THISFORM.grid2.READONLY=.T.           
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.SHR_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.)  AND EMPTY(D03.F07)   
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依採購單號排列'       
       JK='採購單號'
       SELE D03
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=D03.F02
  ENDPROC               
  PROC KEY_LIST.INIT 
       with this 
           .additem('依採購單號排列')
           .additem('依廠商編號排列')
       endwith      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE D03 
       DO CASE
          CASE THIS.DISPLAYVALUE='依採購單號排列'
               set order to D031 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='採購單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='D03.F02'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D03.F03'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D01.F04'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68 
          CASE THIS.DISPLAYVALUE='依廠商編號排列'
               set order to D032
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='D03.F03'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D01.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*68
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='採購單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D03.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81                                                                
       ENDCASE 
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=D03.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=D03.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=D01.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=D03.F09
       THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION=IIF(D03.F11,'是','否')
       THISFORM.PAGEFRAME1.PAGE1.LBLF111.BACKCOLOR=IIF(D03.F11,RGB(255,255,0),RGB(0,255,0))
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=D03.F07       
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=D03.F13
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=D03.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=D03.F14
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=D03.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=D03.F05
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=IIF(D03.F10,'Y','N')
       THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=D03.F12
       THISFORM.PAGEFRAME1.PAGE1.lblf061.caption=transform(D03.F06,'999999999.99')
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.SHR_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.) AND EMPTY(D03.F07)
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=F02
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=F13       
       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=F11
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=F03
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=F05       
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=F20
       THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=F21
       THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=F24
       THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=TRANSFORM(F06,'999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=TRANSFORM(F08,'999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION=TRANSFORM(F16,'999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=F12
*!*	       THISFORM.PAGEFRAME1.PAGE2.LBLDLVD1.CAPTION=DELIVER(F01,F02)       
      THISFORM.PAGEFRAME1.PAGE2.RTGBOX.VALUE=ALLTRIM(DELIVER(F01,F02))
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
       if thisform.pageframe1.activepage=1
          thisform.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
       THISFORM.ANS_BOTT.ENABLED=.T.
       THISFORM.RCC_BOTT.ENABLED=IIF(F08>0,.T.,.F.)          
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增       
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
       THISFORM.SHR_BOTT.ENABLED=.F.
       IF INT_111=.T.
          HD=HD1+SUBSTR(DTOS(DATE()),3,4)
          DO ODR_CRT
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=PO_NO
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.REFRESH    		    
             thisform.PAGEFRAME1.PAGE1.txtf02.readonly=.t.		                          
             THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
       ELSE
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS   
       ENDIF           
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.VISIBLE=.T.        
        THISFORM.PAGEFRAME1.PAGE1.CRCY.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE=INT_011
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=DATE()
        THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE='海運'             
        THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE        
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE   
        THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION='否'
        THISFORM.PAGEFRAME1.PAGE1.LBLF111.BACKCOLOR=RGB(0,255,0)
        THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=INT_071
        THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION='' 
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=DATE()
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.RCC_BOTT.ENABLED=.F.        
        THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F. 
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')   
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=EMPTY(A02.F09)
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=TRANSFORM(0,'9999999999.99')
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=''
*!*	        THISFORM.PAGEFRAME1.PAGE2.LBLDLVD1.CAPTION=''                
        THISFORM.PAGEFRAME1.PAGE2.RTGBOX.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=''
     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE RECNO() FROM D07 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'D07')
           LL1=RLOCK(KK1,'D07')
        ELSE
           LL1=.T.   
        ENDIF         
        SELE RECNO() FROM D04 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE INTO ARRAY BK2
        JJ2=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK2)
               JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
           ENDFOR  
           KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
           RLOCK(KK2,'D04')
           LL2=RLOCK(KK2,'D04')
        ELSE
           LL2=.T.   
        ENDIF                 
        SELE D03
        IF RLOCK('D03') .AND. LL1 .AND. LL2
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
           THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.VISIBLE=.T.
           THISFORM.PAGEFRAME1.PAGE1.CRCY.VISIBLE=.T.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF12.SETFOCUS        
        ELSE
           DO file_impact
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        endif   
     ELSE                                                                &&處理表身修改
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.         
        SELE D04
        LOCK()
        IF !RLOCK()
           DO file_impact 
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ELSE  
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')             
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=EMPTY(A02.F09)
           THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=SEEK(D03.F03+D04.F02+D03.F05,'D02') .AND. !EMPTY(A02.F09) 
           THISFORM.ANS_BOTT.ENABLED=.F.
           THISFORM.RCC_BOTT.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF13.SETFOCUS
       endif        
     ENDIF   
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          if ALIA()='D03'           &&刪除整張訂單
             SELE D03
             IF F08=.T.
                =MESSAGEBOX('此張訂單已有出貨行為無法整張刪除!',0+64,'提示訊息視窗')              
                RETURN
             ENDIF

                PO_NO=D03.F02
                SELE RECNO() FROM D07 WHERE D07.F01=D03.F02 INTO ARRAY BK1
                JJ1=''                
                IF _TALLY>0                   
                    FOR I= 1 TO ALEN(BK1)
                        JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                    ENDFOR  
                    KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
                    RLOCK(KK1,'D07')
                    LL1=RLOCK(KK1,'D07')
                ELSE
                   LL1=.T.   
                ENDIF   
                SELE RECNO() FROM D04 WHERE D04.F01=D03.F02  INTO ARRAY BK2              
                JJ2=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK2)
                       JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                   ENDFOR    
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
                   RLOCK(KK2,'D04')
                   LL2=RLOCK(KK2,'D04')
                ELSE
                   LL2=.T.   
                ENDIF   
                IF RLOCK('D03') .AND. LL1 .AND. LL2=.T.                
                   IF LEN(ALLTRIM(JJ1))>0 
                      SELE D07
                      FOR I=1 TO ALEN(BK1)
                          GO BK1(I)
                          IF D07.F09='1'    &&如果是已經確認交期者
                             SELE P07       &&回復請購狀態第一次                              
                             SEEK LEFT(D07.F07,10)+D07.F02
                             IF FOUND()
                                REPL F07 WITH F07+D07.F04
                             ELSE                               
                                SELE P05
                                SEEK LEFT(D07.F07,10)
                                IF FOUND()
                                   SELE P06
                                   SEEK LEFT(D07.F07,10)+D07.F02
                                   IF FOUND()
                                      SELE P07
                                      APPEND BLANK
                                      REPL F01 WITH P05.F01
                                      REPL F02 WITH P05.F02
                                      REPL F03 WITH P05.F04
                                      REPL F04 WITH P05.F05
                                      REPL F05 WITH P05.F06
                                      REPL F06 WITH P06.F02
                                      REPL F07 WITH F07+D07.F04
                                      REPL F08 WITH P06.F05
                                      REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                                      REPL F10 WITH P05.F07                                                                           
                                   ENDIF
                                ENDIF      
                             ENDIF   
                          ELSE
                             SELE P07
                             SEEK LEFT(D07.F07,10)+D07.F02
                             IF FOUND()
                                REPL F11 WITH F11+D07.F04*(-1)
                             ENDIF      
                          ENDIF
                          SELECT E08
                          SEEK D07.F02
                          IF FOUND()
                             REPLACE F20 WITH F20+D07.F04*(-1)
                          ELSE
                             APPEND BLANK
                             REPLACE F01 WITH D07.F03
                             REPLACE F02 WITH D07.F02
                             REPLACE F20 WITH D07.F04*(-1)
                          ENDIF
                          SELE D07
                      ENDFOR    
                   ENDIF    
                   DELE FROM D07 WHERE D07.F01=D03.F02
                   DELE FROM D04 WHERE D04.F01=D03.F02
                   SELE D03
                   DELE
                   SKIP -1
                   IF BOF()
                      GO TOP
                   ENDIF   
                   UNLOCK ALL
                 IF INT_111=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)
                      HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
                      DO ODR_RJT
                  ENDIF  
                ELSE
                   DO file_impact                  
                ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
             ENDIF     
          ELSE        
              SELE D04                                                      &&刪除單筆資料及其出貨計劃   
              IF F08>0
                =MESSAGEBOX('此筆記錄已有進貨行為無法刪除!',0+64,'提示訊息視窗')
                RETURN
              ENDIF                           
                 SELE RECNO() FROM D07 WHERE D07.F01=D04.F01 AND D07.F02=D04.F02 INTO ARRAY BK3 ORDER BY D07.F01,D07.F02 
                 JJ1=''
                 IF _TALLY>0         
                    FOR I= 1 TO ALEN(BK3)
                        JJ1=JJ1+ALLTRIM(STR(BK3(I)))+','
                    ENDFOR    
                    KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')           
                    RLOCK(KK1,'D07')
                    LL1=RLOCK(KK1,'D07')
                 ELSE
                    LL1=.T.
                 ENDIF      
                 IF RLOCK('D04') .AND. LL1=.T. .AND. RLOCK('D03')
                    IF LEN(ALLTRIM(JJ1))>0 
                       SELE D07
                       FOR I=1 TO ALEN(BK3)
                           GO BK3(I)
                           IF D07.F09='1'      &&如果已經確認交期
                              SELE P07
                              SEEK LEFT(D07.F07,10)+D07.F02
                              IF FOUND()
                                 REPL F07 WITH F07+D07.F04
                              ELSE
                                 SELE P05
                                 SEEK LEFT(D07.F07,10)
                                 IF FOUND()
                                    SELE P06
                                    SEEK LEFT(D07.F07,10)+D07.F02
                                    IF FOUND()
                                       SELE P07
                                       APPEND BLANK
                                       REPL F01 WITH P05.F01
                                       REPL F02 WITH P05.F02
                                       REPL F03 WITH P05.F04
                                       REPL F04 WITH P05.F05
                                       REPL F05 WITH P05.F06
                                       REPL F06 WITH P06.F02
                                       REPL F07 WITH F07+D07.F04
                                       REPL F08 WITH P06.F05
                                       REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                                       REPL F10 WITH P05.F07  
                                    ENDIF
                                 ENDIF   
                              ENDIF                          
                           ELSE
                              SELE P07
                              SEEK LEFT(D07.F07,10)+D07.F02
                              IF FOUND()
                                 REPL F11 WITH F11+D07.F04*(-1)
                              ENDIF                                 
                           ENDIF   
                           SELECT E08
                           SEEK D07.F02
                           IF FOUND()
                              REPLACE F20 WITH D07.F04*(-1)
                           ELSE
                              APPEND BLANK
                              REPLACE F01 WITH D07.F03
                              REPLACE F02 WITH D07.F02
                              REPLACE F20 WITH D07.F04*(-1)
                           ENDIF
                           SELE D07
                        ENDFOR                            
                    ENDIF                        
                    DELE FROM D07 WHERE D07.F01=D04.F01 AND D07.F02=D04.F02
                    SELECT D04
                    SELE D03
                    REPL F06 WITH F06+D04.F06*(-1)
                    SELE D04
                    DELE
                    SKIP -1
                    IF BOF()
                       GO TOP
                    ENDIF   
                 ELSE
                    DO file_impact                  
                 ENDIF                   
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0
                 SELE D03
                 PO_NO=D03.F02
                 DELE
                 IF INT_111=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)
                     HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
                     DO ODR_RJT
                 ENDIF
                 SELE D03
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF                    
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF   
       RELEASE ALL LIKE BK*
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='D04'
       THISFORM.GRID2.CHILDORDER='D041'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='D04.F02'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='D04.F11'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='D04.F03'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='D04.F08'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE='D04.F16'       
       SELE D03 
       COD=SYS(21)
       SET ORDER TO D031
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'D03')=.T.   &&如果單號重覆
           IF INT_111=.T.                               &&若是系統自動產生流水編號
               SELE MAX(F02) FROM D03 WHERE SUBSTR(F02,3,4)=SUBSTR(DTOS(DATE()),3,4) INTO ARRAY GB NOWAIT
               HD=HD1+SUBSTR(DTOS(DATE()),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
               DO ODR_RPT
		       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=PO_NO
		       THISFORM.PAGEFRAME1.PAGE1.TXTF02.REFRESH                                       
          ELSE
             =MESSAGEBOX('採購單號重複!',0+64,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
             SET ORDER TO &COD
             RETURN
          ENDIF   
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'D01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('廠商基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
          =MESSAGEBOX('採購日期不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          SET ORDER TO &COD
          RETURN
       ENDIF               
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE)
          =MESSAGEBOX('交貨日期不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
          SET ORDER TO &COD
          RETURN
       ENDIF        
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE<THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          =MESSAGEBOX('交貨日期不得小於採購日期!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          SET ORDER TO &COD
          RETURN
       ENDIF        
       SELE D03          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE          
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE
          IF INT_020=.F.
             REPLACE F07 WITH '00000'
          ENDIF   
          REPLACE F10 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE='Y',.T.,.F.)
          REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE
          REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
       ENDIF
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
       SET ORDER TO &COD
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'D04')=.T. 
          =MESSAGEBOX('此料號在此張訂單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN            
       ENDIF    
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE<=0
          =MESSAGEBOX('採購數量不得小於等於 0 !',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       SELE D04
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F06 WITH ROUND(F03*F05,INT_068)
          REPLACE F09 WITH F03
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
          REPLACE F14 WITH IIF(SEEK(LEFT(F11,10),'P07'),P07.F03,'')
          REPLACE F17 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE
          REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE
      ENDIF
      UNLOCK          
      SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE                  
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID2.SETFOCUS            
      SELE D07                                                                           &&寫入進貨計劃
      APPEND BLANK
      LOCK()
      IF RLOCK()
         REPLACE F01 WITH D04.F01
         REPLACE F02 WITH D04.F02
         REPLACE F03 WITH D03.F14
         REPLACE F04 WITH D04.F03
         REPLACE F05 WITH D03.F03
         REPLACE F07 WITH D04.F11
         REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')        
         REPLACE F09 WITH '0'
         REPLACE F11 WITH D03.F14
         REPLACE F12 WITH D04.F20
         REPLACE F13 WITH D03.F13
         REPLACE F16 WITH IIF(SEEK(LEFT(D04.F11,10),'P07'),P07.F03,'')
         SELECT E08    &&寫入預期結餘量
         SEEK D07.F02
         IF FOUND()
            REPLACE F20 WITH F20+D07.F04
         ELSE
            APPEND BLANK
            REPLACE F01 WITH D07.F03
            REPLACE F02 WITH D07.F02
            REPLACE F20 WITH D07.F04
         ENDIF
      ENDIF  
      UNLOCK
      SELE P07
      SEEK LEFT(D04.F11,10)+D04.F02
      IF FOUND()
         REPLACE P07.F11 WITH F11+D04.F03
      ENDIF
      UNLOCK   
*!*	      IF THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE<>IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'D02'),D02.F07,0) &&判斷是否與歷史單價不同
*!*	         SELE D02
*!*	         APPEND BLANK
*!*	         REPL F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
*!*	         REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
*!*	         REPL F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
*!*	         REPL F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
*!*	         REPL F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
*!*	         REPL F07 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
*!*	         REPL F08 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE
*!*	         REPL F09 WITH 1
*!*	         REPL F11 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
*!*	         REPL F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE        
*!*	      ENDIF   
      if messagebox('是否分批進貨?',4+32+256,'請確認') = 6	 
         SELE D07     
         THISFORM.ANS_BOTT.CLICK
      endif   
      SELE D03
      REPLACE F06 WITH F06+D04.F06  
      SELE D04          
      THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF               
  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
           =MESSAGEBOX('訂貨日期不得空白!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
           RETURN
        ENDIF   
        IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE)
           =MESSAGEBOX('交貨日期不得空白!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
           RETURN
        ENDIF        
        IF THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE<THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           =MESSAGEBOX('交貨日期不得小於訂貨日期!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
           RETURN
        ENDIF                        
        IF D03.F05<>THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           SELE D04
           SEEK D03.F02
           IF FOUND()
              DO WHILE F01=D03.F02
                 REPL F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
                 SKIP
              ENDDO
           ENDIF
        ENDIF                
        IF D03.F13<>THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE
           SELECT D07
           SEEK D03.F02
           IF FOUND()
              DO WHILE F01=D03.F02
                 REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE
                 SKIP
              ENDDO
           ENDIF
        ENDIF    
        SELE D03
        IF RLOCK() 
           REPL F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
           REPL F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           REPL F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
           REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE
           REPL F13 WITH THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE
           REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPL F10 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE='Y',.T.,.F.)
           REPL F12 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE
           REPL F13 WITH THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.DISPLAYVALUE                      
           UNLOCK ALL
        ELSE
           DO file_impact
          return   
       ENDIF    
     ELSE                                        &&表身修改確認
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE<D04.F08+D04.F18+D04.F16
           =MESSAGEBOX('訂單總數量不得小於已進貨數+開單位過帳量+取消量!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
           RETURN 
        ENDIF 
        IF RLOCK('D03') .AND. RLOCK('D04')
        *IF RLOCK()
           SELE D03 
           REPL F06 WITH F06+(D04.F06)*(-1)+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
           SELE D04                              
           REPLACE F09 WITH F09+(F03)*(-1)+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
           REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
           REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE*F05
           REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
           REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
           REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
           REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE           
           REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
           REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE          
           IF D04.F03<>THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
              =MESSAGEBOX('訂單數量與原數量不同,請同時修改進貨計劃',0+48,'提示訊息視窗')
              IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE>D04.F03  &&如果數量比原訂單數量多
                 SELECT E08
                 SEEK D04.F02
                 IF FOUND()
                   REPLACE F20 WITH F20+(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE-D04.F03)
                 ELSE
                   APPEND BLANK
                   REPLACE F01 WITH D03.F14
                   REPLACE F02 WITH D04.F02
                   REPLACE F20 WITH (THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE-D04.F03)
                 ENDIF
              ENDIF
              SELECT D04
              REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
              THISFORM.ANS_BOTT.CLICK
           ENDIF       
          SELE D04        
*!*	          IF F05<>F17
*!*	             REPL F17 WITH F05
*!*	             SELE D02
*!*	             APPEND BLANK
*!*	             RLOCK()
*!*	             REPL F01 WITH D03.F03
*!*	             REPL F02 WITH D03.F01
*!*	             REPL F03 WITH D04.F02
*!*	             REPL F04 WITH D04.F13
*!*	             REPL F06 WITH D03.F05
*!*	             REPL F07 WITH D04.F05
*!*	             REPL F08 WITH D04.F21
*!*	             REPL F09 WITH 1
*!*	             REPL F11 WITH D04.F01
*!*	             REPL F13 WITH D04.F20                       
*!*	          ENDIF   
             UNLOCK ALL
       ELSE
         DO file_impact
          return   
       ENDIF   
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TRANS_STYLE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.CRCY.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1   
          THISFORM.grid1.ENABLED=.T.
          THISFORM.grid2.ENABLED=.T.      
          THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.) AND EMPTY(D03.F07)
      ELSE
         THISFORM.grid1.ENABLED=.F.
         THISFORM.grid2.ENABLED=.T.         
         THISFORM.GRID2.SETFOCUS
         THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F.
         THISFORM.ANS_BOTT.ENABLED=.T.
         THISFORM.RCC_BOTT.ENABLED=IIF(F08>0,.T.,.F.)         
         IF THISFORM.GRID2.ACTIVEROW=0
              IF INT_111=.T.
                 HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
                 DO ODR_RJT
              ENDIF    
              SELE D03
              DELE
              SKIP -1
              IF BOF()
                  GO TOP
              ENDIF
              THISFORM.PAGEFRAME1.ACTIVEPAGE=1
              THISFORM.REFRESH    
         ENDIF   
      ENDIF       
      UNLOCK ALL
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'D04'
            THISFORM.GRID2.RECORDSOURCE='D04'
            THISFORM.GRID2.CHILDORDER='D041'
  	        THISFORM.grid2.COLUMN1.CONTROLSOURCE='D04.F02'
	        THISFORM.grid2.COLUMN2.CONTROLSOURCE='D04.F11'
	        THISFORM.grid2.COLUMN3.CONTROLSOURCE='D04.F03'
	        THISFORM.grid2.COLUMN4.CONTROLSOURCE='D04.F08'
	        THISFORM.grid2.COLUMN5.CONTROLSOURCE='D04.F16'         
	     ENDIF   
	     IF INT_111=.T.
            HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
            DO ODR_RJT
         ENDIF   
         SELE D03
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依採購單號排列'
                 SET ORDER TO D031
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依廠商編號排列'
                 SET ORDER TO D032
         ENDCASE   

       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK
    DO CASE
           CASE  D04.F18 <> 0
                      =MESSAGEBOX('已有開單未進量,請至B02進貨單中查詢',16,'請確認') 
                      THISFORM.GRID2.SETFOCUS
                      RETURN
           CASE  D04.F09 = 0
                      =MESSAGEBOX('此料號已有進貨量',16,'請確認') 
                      THISFORM.GRID2.SETFOCUS
                      RETURN      
           OTHERWISE
                      OUT_SEEK=CREATEOBJECT("OUT_SEEK")  
                      OUT_SEEK.SHOW    
                      FLG='0'                    
                      SELECT  D04                                       
    ENDCASE                     
  ENDPROC
  PROC RCC_BOTT.CLICK         &&進貨紀錄
       SELE F03,F04,F05 FROM D10 WHERE F01+F02=D04.F01+D04.F02  INTO CURSOR RCC ORDER BY F03
       IF _TALLY>0
         RCC_SEEK=createobject("RCC_SEEK")  
         RCC_SEEK.SHOW                                      
         AREA1='D03'
         THISFORM.GRID1.SETFOCUS
       ENDIF  
  ENDPROC    
  PROCEDURE SHR_BOTT.CLICK   &&確認訂單
     IF MESSAGEBOX('是否確資料無誤要確認此張訂單?',4+32+256,'請確認') = 6	                 
        SELECT D03
        RLOCK()
        IF RLOCK()
           REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
           UNLOCK 
        ELSE
           DO file_impact
        ENDIF   
        THIS.Enabled=.F.
        thisform.grid1.setfocus
     ENDIF   
  ENDPROC  
enddefine    
***********************************************列印程序
PROCEDURE PNT_PRC  
        PNTOPT=CREATEOBJECT("PNTOPT")  
        PNTOPT.SHOW    
ENDPROC
***********************************************列印選擇
DEFINE CLASS PNTOPT AS FORM
  AUTOCENTER=.T.
  CAPTION='請選擇列印版本'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*150
  WIDTH=INT_015*245
  FONTSIZE=INT_015*9
  CLOSABLE=.F.
  CONTROLBOX=.F.
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='PNTOPT'
ADD OBJECT DATA_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*17,;
      TOP=INT_015*20,;
      AUTOSIZE=.T.,;
      FONTSIZE=INT_015*12,;
      BUTTONCOUNT=3,;
      OPTION1.CAPTION='中文採購單(中一刀)',;
      OPTION1.TOP=INT_015*0,;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='中文採購單(A4橫列)',;
      OPTION2.TOP=INT_015*40,;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.AUTOSIZE=.T.,;       
      OPTION3.CAPTION='英文採購單        ',;
      OPTION3.TOP=INT_015*80,;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.AUTOSIZE=.T.,;  
      NAME='DATA_OPTION'   
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*175,;     
      TOP=INT_015*63,;  
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*10,;
      CAPTION='\<Y.確定',;
      TOOLTIPTEXT='確認所選擇的鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*175,;
      TOP=INT_015*101,;
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*10,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'     
  *****      
 PROC INIT  

 ENDPROC  
 PROCEDURE CMND1.CLICK     
     LK=D03.F02             
     SELECT D07.F01,;
            D07.F02,;
            D07.F03,;
            D07.F04,;
            D07.F05;
     FROM D07 WHERE D07.F01=LK INTO CURSOR D07TMP ORDER BY F02,F03
     SELECT D07TMP.F01,;
            D07TMP.F02,;
            D07TMP.F03,;
            D07TMP.F04,;
            D07TMP.F05,;
            D04.F04,;
            D04.F05,;
            D04.F11,;
            D04.F13;
            FROM D07TMP,D04 WHERE D04.F01=LK AND D04.F02=D07TMP.F02 ORDER BY D07TMP.F02,D07TMP.F03 INTO CURSOR D04TMP
      SELECT D04TMP.F01,;
             D04TMP.F02,;
             D04TMP.F03,;
             D04TMP.F04_A,;
             D04TMP.F05_A,;
             D04TMP.F04_B,;
             D04TMP.F05_B,;
             D04TMP.F11,;
             D04TMP.F13,;
             D03.F01,;
             D03.F06,;
             D03.F14,;
             D03.F12,;
             D03.F04,;
             D03.F10,;             
             D03.F13,;
             B01.F02,;      
             B01.F29,;  
             D01.F03,;
             D01.F05,;
             D01.F08,;             
             D01.F09,;
             D01.F10,;
             D01.F19;
             FROM D04TMP,D03,B01,D01 WHERE D03.F02=D04TMP.F01 AND B01.F01=D04TMP.F02;
             AND D01.F01=D04TMP.F05_A; 
             ORDER BY D04TMP.F02,D04TMP.F03 INTO CURSOR D03TMP
     IF _tally >0
        DO CASE
           CASE THISFORM.DATA_OPTION.VALUE=1
                REPORT FORM ALLTRIM(INT_116)+'D04' TO PRINTER PROMPT   
           CASE THISFORM.DATA_OPTION.VALUE=2
                REPORT FORM ALLTRIM(INT_116)+'D04A' TO PRINTER PROMPT           
*                 REPORT FORM ALLTRIM(INT_116)+'D04A' PREVIEW                       
           CASE THISFORM.DATA_OPTION.VALUE=3
                REPORT FORM ALLTRIM(INT_116)+'D04E' TO PRINTER PROMPT   
*                REPORT FORM ALLTRIM(INT_116)+'D04E' PREVIEW
        ENDCASE    
     ELSE
           =MESSAGEBOX('此採購單已全部結清無法列印!',0+64,'提示訊息視窗')           
     ENDIF  
     SELE D07TMP
     USE
     SELE D04TMP
     USE 
     SELE D03TMP    
     USE

     THISFORM.RELEASE  
 ENDPROC   
 ***** 
  PROCEDURE CMND2.CLICK
      THISFORM.RELEASE
  ENDPROC      
ENDDEFINE 
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF02 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=20
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01    
       ENDIF 
       IF _TALLY>0  
          MTR_SEEK=createobject("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF    
    ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')  
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION)
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'D02','D023'),D02.F07,0)
             THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'D02','D023'),D02.F04,'')
             THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'D02','D023'),D02.F13,1)
             THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'D02','D023'),D02.F08,1)                          
             THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'D02','D023'),D02.F14,'') 
       ELSE      
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=0
             THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
             THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=1
             THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=1  
             THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=''           
       ENDIF    
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.REFRESH
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.REFRESH
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.REFRESH
       THISFORM.PAGEFRAME1.PAGE2.TXTF21.REFRESH       
       THISFORM.PAGEFRAME1.PAGE2.TXTF24.REFRESH   
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE>0
          THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=!EMPTY(A02.F09)
       ELSE    
          THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F.
       ENDIF    

  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------廠商
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02    
       ENDIF          
       IF _TALLY>0
          VDR_SEEK=createobject("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=createobject("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'D01'),D01.F03,'')  
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=IIF(SEEK(THIS.VALUE,'D01'),D01.F17,'N')
       THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE=IIF(SEEK(THIS.VALUE,'D02'),D02.F06,INT_011)
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE
       THISFORM.PAGEFRAME1.PAGE1.CRCY.REFRESH
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.REFRESH     
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.REFRESH     
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------運貨方式
DEFINE CLASS TRANS_STYLE AS COMBOBOX 
       LEFT=INT_015*64
       TOP=INT_015*104
       HEIGHT=INT_015*25
       FONTSIZE=INT_015*9       
       ROWSOURCE='海運,空運,快遞,自取,直寄,其他'
       ROWSOURCETYPE=1
       STYLE=2
       VALUE=1
       NAME='TRANS_STYLE'
   PROCEDURE INTERACTIVECHANGE
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=THIS.DISPLAYVALUE
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.REFRESH
  ENDPROC       
ENDDEFINE
***************************************************幣別設定
DEFINE CLASS CRCY AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*54
  LEFT=INT_015*418
  FONTSIZE=INT_015*9  
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*84
  ROWSOURCETYPE=1
  STYLE=2
  NAME='CRCY'
  PROCEDURE INIT
    SELECT D00
    GO TOP 
    DO WHILE .NOT. EOF()
       L=4-LEN(ALLTRIM(F01))
       THIS.ADDITEM(F01)
       SKIP
    ENDDO
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=THIS.DISPLAYVALUE
    THISFORM.PAGEFRAME1.PAGE1.TXTF05.REFRESH
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------採購用途
DEFINE CLASS TXTF11 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=20
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       SELECT F01,F04,F02,F05,F07,F08,F11 FROM P07 INTO CURSOR POU ORDER BY F08 WHERE F07-F11>0 AND F06=THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE    
       IF _TALLY>0
          POU_SEEK=createobject("POU_SEEK")  
          POU_SEEK.SHOW    
          THIS.VALUE=FLG+CHK_STR
          THIS.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=FTR_STR                
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=10
          SELECT F01,F04,F02,F07,F08,F11 FROM P07 INTO CURSOR POU ORDER BY F08 WHERE F07-F11>0 AND F06=THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE;
          AND F01=LEFT(THIS.VALUE,10)    
          DO CASE
             CASE _TALLY=1             
                  THIS.VALUE=POU.F01+POU.F04
                  THIS.REFRESH
             CASE _TALLY>1
                  POU_SEEK=createobject("POU_SEEK")  
                  POU_SEEK.SHOW    
                  THIS.VALUE=FLG+CHK_STR
                  THIS.REFRESH            
          ENDCASE   
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=FTR_STR   
       ENDIF 
          
    ENDIF      
    AREA1='D03'

  ENDPROC
ENDDEFINE
*******************************************************待請購明細
define class POU_SEEK as form
  autocenter=.t.
  caption='待請購明細'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*340
  WIDTH=INT_015*500
  FONTSIZE=INT_015*9  
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='POU_SEEK'
  add object GRID1 as GRID with;          
      AUTOCENTER=.T.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*500,;      
      HEIGHT=INT_015*310,;    
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;  
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=6,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;      
      COLUMN5.NAME='COLUMN5',;      
      COLUMN6.NAME='COLUMN6'    
  add object cmdgroup as cmdgroup with;      
      TOP=INT_015*310,;
      LEFT=INT_015*100,;
      visible=.t.      
  add object cmnd1 as commandbutton with;
      LEFT=INT_015*273,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*315,;  
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      name='cmnd1'
  add object cmnd2 as commandbutton with;
      LEFT=INT_015*315,;
      TOP=INT_015*315,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      caption='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      name='cmnd2'
      procedure init 
         AREA1='POU' 
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='POU'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='請購單號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='POU.F01'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='需求對象'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='POU.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='請購日期'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='POU.F02'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='請購數量'        
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='POU.F07-POU.F11'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*100
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='需求日期'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='POU.F08'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*70
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='來源單號'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='POU.F05'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*70         
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XColIndex     
         FCH=THISFORM.ACTIVECONTROL.NAME  
         FLG=POU.F01+IIF(ALLTRIM(POU.F05)='計劃需求','+ ',IIF(ALLTRIM(POU.F05)='廠內耗用' ,'# ','- '))         
         CHK_STR=POU.F04
         FTR_STR=POU.F07-POU.F11
      ENDPROC 
      procedure cmnd1.click  
          SELE POU
          USE
          THISFORM.RELEASE                
      endproc
      procedure cmnd2.click
          FLG=''   
          CHK_STR=''
          FTR_STR=0          
          SELE POU
          USE 
          thisform.release
      endproc      
enddefine            
******************************************************詢價紀錄BUTTON
DEFINE CLASS CMB1 AS COMMANDBUTTON
   HEIGHT=INT_015*25
   WIDTH=INT_015*65
   TOP=INT_015*108
   LEFT=INT_015*165
   FONTSIZE=INT_015*9
   NAME='CMB1'
   CAPTION='詢價紀錄'
   TOOLTIPTEXT='查看詢價紀錄資料'
   PROC CLICK
        SELE D02        
        GF=THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
             SLP_SEEK=createobject("SLP_SEEK")  
             SLP_SEEK.SHOW    
             IF !EMPTY(FLG)
                THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=FLG
                THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=FTR_STR
                THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=CHK_STR
                THISFORM.PAGEFRAME1.PAGE2.TXTF05.REFRESH
                THISFORM.PAGEFRAME1.PAGE2.TXTF20.REFRESH
                THISFORM.PAGEFRAME1.PAGE2.TXTF21.REFRESH                                
            ENDIF               
             FLG='0'                    
             AREA1='D03'
             SELE D04
*          endif 
  ENDPROC     
ENDDEFINE      
*******************************************************詢價紀錄
define class SLP_SEEK as form
  autocenter=.t.
  caption='詢價紀錄'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*340
  WIDTH=INT_015*780
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='SLP_SEEK'
  add object GRID1 as GRID with;          
      AUTOCENTER=.T.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*780,;      
      HEIGHT=INT_015*310,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      deletemark=.f.,;
      READONLY=.T.,;
      recordsourcetype=1,;
      columncount=9,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;      
      COLUMN5.NAME='COLUMN5',;      
      COLUMN6.NAME='COLUMN6',;      
      COLUMN7.NAME='COLUMN7',;      
      COLUMN8.NAME='COLUMN8',;  
      COLUMN9.NAME='COLUMN9'    
  add object cmdgroup as cmdgroup with;      
      TOP=INT_015*310,;
      LEFT=INT_015*130,;
      visible=.t.      
  add object cmnd1 as commandbutton with;
      LEFT=INT_015*303,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*315,;  
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      name='cmnd1'
  add object cmnd2 as commandbutton with;
      LEFT=INT_015*345,;
      TOP=INT_015*315,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      caption='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      name='cmnd2'
      procedure init 
         AREA1='D02' 
        SELE D02
        SET FILTER TO F01=D03.F03 .AND. F03=GF .AND. F06=D03.F05
        SEEK D03.F03+GF
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='D02'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='異動日期'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*73
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='D02.F02'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商料號'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D02.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='單        價'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D02.F07'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='最小訂貨量'        
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='D02.F08'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='包裝基量'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='D02.F13'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='前置日數'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='D02.F09'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='交易條件'
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='D02.F10'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='備註說明'
         THISFORM.GRID1.COLUMN8.CONTROLSOURCE='D02.F14'
         THISFORM.GRID1.COLUMN8.WIDTH=INT_015*159
         THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='安全資料'
         THISFORM.GRID1.COLUMN9.CONTROLSOURCE='D02.F11'
         THISFORM.GRID1.COLUMN9.WIDTH=INT_015*74
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XColIndex     
         FCH=THISFORM.ACTIVECONTROL.NAME  
         FLG=D02.F07
         CHK_STR=D02.F08
         FTR_STR=D02.F13
      ENDPROC 
      procedure cmnd1.click  
          THISFORM.RELEASE                
          SET FILTER TO                                   
      endproc
      procedure cmnd2.click
          FLG=''   
          CHK_STR=0
          FTR_STR=0          
          thisform.release
          SET FILTER TO
      endproc      
enddefine            
*********************************************************************進貨計劃
DEFINE CLASS OUT_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='進貨計劃'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*369
  WIDTH=INT_015*401
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OUT_SEEK'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      LEFT=INT_015*3,;
      WIDTH=INT_015*395,;
      HEIGHT=INT_015*65
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;    
      LEFT=INT_015*3,;
      TOP=INT_015*67,;
      WIDTH=INT_015*395,;
      HEIGHT=INT_015*265
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      LEFT=INT_015*3,;
      TOP=INT_015*334,;
      WIDTH=INT_015*395,;
      HEIGHT=INT_015*33    
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*299,;
      LEFT=INT_015*40
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      TOP=INT_015*333,;
      LEFT=INT_015*40
  ADD OBJECT PERMIT_BOTT AS COMMANDBUTTON WITH;
      VISIBLE=.T.,;
      TOP=INT_015*338,;
      LEFT=INT_015*235,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*65,;
      CAPTION='\<Y.確認交期',;
      NAME='PERMIT_BOTT'                             
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      VISIBLE=.F.    
  ADD OBJECT LBLF03 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*7,;
      WIDTH=INT_015*50,;
      CAPTION='進貨日期'
  ADD OBJECT TXTF03 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*58,;
      WIDTH=INT_015*70,;
      HEIGHT=INT_015*25,;
      NAME='TXTF03' 
  ADD OBJECT LBLF04 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*140,;
      WIDTH=INT_015*50,;
      CAPTION='進貨數量'
  ADD OBJECT TXTF04 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*191,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      INPUTMASK='99999999.99',;
      NAME='TXTF04'
  ADD OBJECT LBLF13 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*283,;
      WIDTH=INT_015*50,;
      CAPTION='運貨方式'    
  ADD OBJECT TXTF13 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*334,;
      WIDTH=INT_015*55,;
      HEIGHT=INT_015*25,;
      NAME='TXTF13'    
ADD  OBJECT TRANS_STYLE AS COMBOBOX WITH;
       VISIBLE=.F.,;
       LEFT=INT_015*334,;
       TOP=INT_015*4,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*55,;
       FONTSIZE=INT_015*9 ,;   
       ROWSOURCE='海運,空運,快遞,自取,直寄,其他',;
       ROWSOURCETYPE=1,;
       STYLE=2,;
       VALUE=1,;
       NAME='TRANS_STYLE'
  ADD OBJECT LBLF17 AS LABEL WITH;
      TOP=INT_015*36,;
      LEFT=INT_015*7,;
      WIDTH=INT_015*50,;
      CAPTION='備註說明'
  ADD OBJECT TXTF17 AS TEXTBOX WITH;
      TOP=INT_015*32,;
      LEFT=INT_015*58,;
      WIDTH=INT_015*240,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=40,;
      NAME='TXTF17' 
  ADD OBJECT LBLF_C66 AS LABEL WITH;
      TOP=INT_015*310,;
      LEFT=INT_015*10,;
      AUTOSIZE=.T.,;
      BACKCOLOR=RGB(255,255,0),;
      CAPTION=''
  ADD OBJECT LBLQTY AS LABEL WITH;
      TOP=INT_015*310,;
      LEFT=INT_015*265,;
      AUTOSIZE=.T.,;
      CAPTION='未排入量：'    
  ADD OBJECT LBLTQTY AS LABEL WITH;
      TOP=INT_015*310,;
      LEFT=INT_015*325,;
      AUTOSIZE=.T.    
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*27,;
      LEFT=INT_015*302               
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      LEFT=INT_015*10,;
      TOP=INT_015*71,;
      WIDTH=INT_015*381,;      
      HEIGHT=INT_015*230,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=5,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',; 
      COLUMN5.NAME='COLUMN5'     
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*171,;
      TOP=INT_015*338,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+X'
      NAME='CMND2'
     PROCEDURE INIT
         THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
         THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')         
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')            
         SELE D07
         SET FILTER TO F01=D04.F01 .AND. F02=D04.F02
         CALC SUM(F04) TO TQTY
         SEEK D04.F01+D04.F02
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
         THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(D07.F09='0',RGB(255,0,0),'')","COLUMN")                  
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='D07'
         THISFORM.CMDGROUP.VISIBLE=.F.
         THISFORM.ORPGROUP.PNT_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.ESC_BOTT.VISIBLE=.F.
         THISFORM.SHRGROUP.VISIBLE=.F.
         THISFORM.SHRGROUP.ENABLED=.F.         
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='進貨日期'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*68
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='D07.F03'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='進貨數量'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D07.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*68
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='運貨方式'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D07.F13'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*50  
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='備註說明'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='D07.F17'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*130      
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='安全資料'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='D07.F08'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*90
         THISFORM.GRID1.SETFOCUS
         FCH='GRID1'
         IF THISFORM.GRID1.ACTIVEROW=0
            THISFORM.CMDGROUP.ENABLED=.F.
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
         ELSE
            THISFORM.CMDGROUP.ENABLED=.T.         
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(D04.F09-TQTY>=0,.T.,.F.)  .OR. THISFORM.GRID1.ACTIVEROW=1                          
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
             THISFORM.TXTF03.VALUE=D07.F03
             THISFORM.TXTF04.VALUE=D07.F04
            THISFORM.TXTF13.VALUE=D07.F13
            THISFORM.TXTF17.VALUE=D07.F17   
            THISFORM.LBLF_C66.CAPTION = IIF(EMPTY(D07.F14) OR D07.F14 ='4','','此筆計畫已被提出交期之異動 >> ' + ICASE(D07.F14 = '1','提前交期',D07.F14 = '2','延後交期',D07.F14 = '3','取消訂購',''))                  
         ENDIF                     
         THISFORM.LBLTQTY.CAPTION=ALLTRIM(STR(D04.F09-TQTY)) 
*!*	         THISFORM.CMND2.ENABLED=IIF(D04.F09-TQTY>=0,.T.,.F.)     
         THISFORM.CMND2.ENABLED=.T.                                     
         THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(D04.F09-TQTY<>0,.T.,.F.)               
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XColIndex     
         FCH=THISFORM.ACTIVECONTROL.NAME 
         IF THIS.ACTIVEROW=0
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
            THISFORM.PERMIT_BOTT.ENABLED=.F. 
         ELSE
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(D04.F09-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1                               
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.         
            THISFORM.PERMIT_BOTT.ENABLED=IIF(D07.F09='0',.T.,.F.)      
         ENDIF            
            THISFORM.TXTF03.VALUE=D07.F03
            THISFORM.TXTF04.VALUE=D07.F04
            THISFORM.TXTF13.VALUE=D07.F13
            THISFORM.TXTF17.VALUE=D07.F17  
            THISFORM.LBLF_C66.CAPTION = IIF(EMPTY(D07.F14) OR D07.F14 ='4','','此筆計畫已被提出交期之異動 >> ' + ICASE(D07.F14 = '1','提前交期',D07.F14 = '2','延後交期',D07.F14 = '3','取消訂購',''))                 
         IF D04.F09-TQTY>0
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
         ELSE
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.                     
         ENDIF
      ENDPROC 
 
      procedure cmnd2.click
         IF D04.F09-TQTY>0
            if messagebox('尚有'+TRANSFORM(D04.F09-TQTY,'@J 99999999.99')+'未排入進貨計劃是否取消?',4+32+256,'請確認') = 6	 
               IF A02.F06=SPACE(1)
                  =MESSAGEBOX('您沒有取消訂單的權限,請重新新增進貨計劃',0+64,'提示訊息視窗')                     
                  RETURN
               ENDIF                 
               SELECT E08
               SEEK D04.F02
               IF FOUND()
                  REPLACE F20 WITH F20+(D04.F09-TQTY)*(-1)
               ELSE
                  APPEND BLANK
                  REPLACE F01 WITH D03.F14
                  REPLACE F02 WITH D04.F02
                  REPLACE F20 WITH (D04.F09-TQTY)*(-1)
               ENDIF
               SELE D04     
               REPL D04.F16 WITH D04.F16+D04.F09-TQTY
               REPL D04.F09 WITH TQTY           
               SELE D07
*!*	            ELSE
*!*	               SELE D07               
*!*	               THISFORM.GRID1.SETFOCUS
*!*	               THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.
*!*	               RETURN   
            ENDIF               
         ENDIF 
         ***傳送郵件         
         IF EMPTY(THISFORM.TXTF03.VALUE)
            IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE'
               MAIL_TEXT = ''
               TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
               WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
               MAIL_TEXT = '採購單號：' + D04.F01 + TMPCHR + ;
     	         		   '料品編號：' + D04.F02 + TMPCHR + ;
     	         		   '需求單號：' + P05.F06 + TMPCHR + ;
     	         		   '採購用途：' + ALLTRIM(D04.F11) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)

               ***傳送給業務助理                              
               IF SEEK(LEFT(ALLTRIM(D04.F11),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D04.F11),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                  ASSIS_NO=A01.F01
                  IF OS()="Windows 5.01"
                     SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D04.F11) + '已被刪除','TEXT',MAIL_TEXT)	
                  ELSE
                     IF !EMPTY(ALLTRIM(ASSIS_NO))
                        FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                        STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已被刪除<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)
                     ENDIF   
                  ENDIF   
               ELSE
                 ASSIS_NO=''     
               ENDIF
               ***傳送給業務B
               IF SEEK(LEFT(ALLTRIM(D04.F11),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D04.F11),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                
                  SALES_B_NO=A01.F01
                  IF SALES_B_NO<>ASSIS_NO
                     IF OS()="Windows 5.01"
                         SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D04.F11) + '已被刪除','TEXT',MAIL_TEXT)	
                     ELSE
                        IF !EMPTY(ALLTRIM(SALES_B_NO))
                           FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                           STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已被刪除<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                        ENDIF   
                     ENDIF
                  ENDIF   
               ELSE
                  SALES_B_NO=''        
               ENDIF
               ***傳送給業務A
               IF SEEK(LEFT(ALLTRIM(D04.F11),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D04.F11),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                  
                  SALES_A_NO=A01.F01
                  IF SALES_A_NO<>SALES_B_NO 
                     IF OS()="Windows 5.01"
                        SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D04.F11) + '已被刪除','TEXT',MAIL_TEXT) 
                     ELSE
                        IF !EMPTY(ALLTRIM(SALES_A_NO))
                           FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                           STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已被刪除<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)
                        ENDIF   
                     ENDIF
                  ENDIF   
               ELSE
                   SALES_A_NO=''   
               ENDIF                              
               WAIT CLEAR   
            ENDIF   
         ENDIF
         ***          
         SELECT D07
         SET FILTER TO         
         THISFORM.RELEASE
      ENDPROC    
      PROC ORPGROUP.NEW_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.
           THISFORM.PERMIT_BOTT.ENABLED=.F.
           SELE D07
           CALC SUM(F04) TO TQTY
           THISFORM.TXTF03.READONLY=.F.
           THISFORM.TXTF04.READONLY=.F.
           THISFORM.TXTF13.READONLY=.F.
           THISFORM.TXTF13.VISIBLE=.F.
           THISFORM.TXTF17.READONLY=.F.
           THISFORM.TRANS_STYLE.VISIBLE=.T.
           THISFORM.TXTF03.VALUE=CTOD('')
           THISFORM.TXTF04.VALUE=D04.F09-TQTY
           THISFORM.TXTF13.VALUE=''
           THISFORM.TXTF17.VALUE=''
           THISFORM.LBLF_C66.CAPTION = ''
           THISFORM.TRANS_STYLE.VALUE = 1
           THISFORM.TXTF03.SETFOCUS
           QTY=D04.F09-TQTY
           THISFORM.LBLTQTY.CAPTION=TRANSFORM(QTY,'@J 99999999.99')
      ENDPROC
      PROC ORPGROUP.EDIT_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F. 
           THISFORM.PERMIT_BOTT.ENABLED=.F.                
           SELE D07
           RLOCK()
           IF !RLOCK()
              DO FILE_IMPACT
              THISFORM.GRID1.SETFOCUS
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 
           ELSE
              THISFORM.TXTF03.READONLY=.F.
              THISFORM.TXTF04.READONLY=.F.
              THISFORM.TXTF13.READONLY=.F.
              THISFORM.TXTF13.VISIBLE=.F.
              THISFORM.TRANS_STYLE.VISIBLE=.T.        
              THISFORM.TRANS_STYLE.DISPLAYVALUE=D07.F13
              THISFORM.TXTF03.SETFOCUS
              QTY=D07.F04           
           ENDIF                 
      ENDPROC        
      PROC ORPGROUP.DEL_BOTT.CLICK
           IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	            
              SELE D07                
              IF RLOCK()
                 IF D07.F09='1'      &&如果已確認交期
                    SELE D38
                    SEEK D07.F01+D07.F02+DTOS(D07.F03)
                    IF FOUND()
                       REPL F05 WITH DATE()
                       REPL F06 WITH 0
                       REPL F08 WITH DTOC(DATE())+IIF(SEEK(SYS_OPER,'A01'),A01.F03,'')
                    ENDIF
                    SELE P07       &&回復請購狀態                 
                    SEEK LEFT(D07.F07,10)+D07.F02
                    IF FOUND()
                       REPL F07 WITH F07+D07.F04
                    ELSE                               
                       SELE P05
                       SEEK LEFT(D07.F07,10)
                       IF FOUND()
                          SELE P06
                          SEEK LEFT(D07.F07,10)+D07.F02
                          IF FOUND()
                             SELE P07
                             APPEND BLANK
                             REPL F01 WITH P05.F01
                             REPL F02 WITH P05.F02
                             REPL F03 WITH P05.F04
                             REPL F04 WITH P05.F05
                             REPL F05 WITH P05.F06
                             REPL F06 WITH P06.F02
                             REPL F07 WITH F07+D07.F04
                             REPL F08 WITH P06.F05
                             REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                             REPL F10 WITH P05.F07                                                                           
                          ENDIF
                       ENDIF      
                    ENDIF
                    SELE D04
                    REPL F22 WITH F22+D07.F04*(-1)                       
                 ELSE
                    SELE P07
                    SEEK LEFT(D07.F07,10)+D07.F02
                    IF FOUND()
                       REPL F11 WITH F11+D07.F04*(-1)
                    ENDIF      
                 ENDIF
                 SELE D07 
                 DELE
                 UNLOCK             
                 IF BOF()
                    GO TOP
                 ELSE
                   SKIP -1   
                 ENDIF
                 BK=RECNO()
                 CALC SUM(F04) to TQTY
                 IF TQTY>0
                    GO BK
                 ENDIF        
              ELSE
                 DO file_impact                             
              ENDIF         
              THISFORM.GRID1.SETFOCUS
              IF THISFORM.GRID1.ACTIVEROW=0
                 THISFORM.CMDGROUP.ENABLED=.F.
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.   
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
                 THISFORM.SETALL('VALUE','','TEXTBOX')
                 THISFORM.TXTF03.VALUE=''
                 THISFORM.TXTF04.VALUE=''
                 THISFORM.TXTF13.VALUE=''
                 THISFORM.TXTF17.VALUE=''
                 THISFORM.PERMIT_BOTT.ENABLED=.F.
              ELSE      
                 THISFORM.CMDGROUP.ENABLED=.T.
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=iif(D04.F09-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
                 THISFORM.PERMIT_BOTT.ENABLED=IIF(D07.F09='0',.T.,.F.) 
              ENDIF           
           ENDIF   
           THISFORM.LBLTQTY.CAPTION=TRANSFORM(D04.F09-TQTY,'@J 99999999.99')
           thisform.CMND2.enabled=iif(D04.F09-TQTY>=0,.T.,.F.)
      ENDPROC
      PROC SHRGROUP.SHURE1_BOTT.CLICK
           IF SEEK(D04.F01+D04.F02+DTOS(THISFORM.TXTF03.VALUE),'D07')=.T.
              =MESSAGEBOX('進貨日期重複!',0+64,'提示訊息視窗')
              THISFORM.TXTF03.SETFOCUS
              RETURN              
           ENDIF
           IF THISFORM.TXTF03.VALUE<DATE()                       
              IF MESSAGEBOX('進貨日期小於本日，是否仍以此為進貨日?',4+32+256,'請確認') = 7	              
                 THISFORM.TXTF03.SETFOCUS
                 RETURN
               ENDIF       
           ENDIF
           SELE P07
           SEEK LEFT(D04.F11,10)+D04.F02
           IF FOUND()
              REPL F11 WITH F11+THISFORM.TXTF04.VALUE
           ENDIF   
           SELE D07
           APPEND BLANK
           RLOCK()
           REPLACE D07.F01 WITH D04.F01
           REPLACE D07.F02 WITH D04.F02
           REPLACE D07.F03 WITH THISFORM.TXTF03.VALUE
           REPLACE D07.F04 WITH THISFORM.TXTF04.VALUE
           REPLACE D07.F05 WITH D03.F03           
           REPLACE D07.F07 WITH D04.F11           
           REPLACE D07.F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPLACE D07.F09 WITH IIF(D04.F09-D04.F18=D04.F22,'1','0')
           REPLACE D07.F13 WITH ALLTRIM(THISFORM.TRANS_STYLE.DISPLAYVALUE)
           REPLACE D04.F14 WITH D04.F14
           REPLACE D07.F17 WITH THISFORM.TXTF17.VALUE 
           SELECT D07
           CALC SUM(F04) TO TQTY      
           SEEK D04.F01+D04.F02+DTOS(THISFORM.TXTF03.VALUE)           
           ***傳送郵件
           IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE'
              MAIL_TEXT = ''
              TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
              WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
              MAIL_TEXT =  '採購單號：' + D07.F01 + TMPCHR + ;
     	        		   '料品編號：' + D07.F02 + TMPCHR + ;
     	        		   '進貨日期：' + DTOC(D07.F03)+TMPCHR + ;
     	        		   '進貨數量：' + ALLTRIM(TRANSFORM(D07.F04,'@R 999,999,999,999')) + TMPCHR + ;
     	        		   '運貨方式：' + D07.F13 + TMPCHR + ;
     	        		   '備註說明：' + ALLTRIM(D07.F17) + TMPCHR + ;	        		   
     	        		   '需求單號：' + P05.F06 + TMPCHR + ;
     	        		   '採購用途：' + ALLTRIM(D07.F07) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)

              ***傳送給業務助理                        
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                 
                  ASSIS_NO=A01.F01
                 IF OS()="Windows 5.01"
                    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已新增計畫','TEXT',MAIL_TEXT)		        		    
                 ELSE                    
                    IF !EMPTY(ALLTRIM(ASSIS_NO))
                       FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                       STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已新增計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                    ENDIF   
                 ENDIF
              ELSE
                 ASSIS_NO=''   	   
              ENDIF
              ***傳送給業務B
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                 	  
                 SALES_B_NO=A01.F01
                 IF SALES_B_NO<>ASSIS_NO
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已新增計畫','TEXT',MAIL_TEXT)	 	        		    
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_B_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已新增計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       ENDIF   
                    ENDIF
                 ENDIF  
              ELSE
                 SALES_B_NO=''     
              ENDIF    
              ***傳送給業務A
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                 
                 SALES_A_NO=A01.F01
                 IF SALES_A_NO<>SALES_B_NO 
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已新增計畫','TEXT',MAIL_TEXT)      	        		    
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_A_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已新增計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       ENDIF   
                    ENDIF                    
                 ENDIF   
              ELSE
                 SALES_A_NO='' 
              ENDIF                           
              WAIT CLEAR   
           ENDIF   
           ***
           SELECT D07           
           UNLOCK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC         
      PROC SHRGROUP.SHURE2_BOTT.CLICK
           IF THISFORM.TXTF03.VALUE<DATE()                       
              IF MESSAGEBOX('進貨日期小於本日，是否仍以此為進貨日?',4+32+256,'請確認') = 7	              
                 THISFORM.TXTF03.SETFOCUS
                 RETURN
               ENDIF       
           ENDIF
           IF D07.F09='1'      &&如果已確認交期
              SELE D38     &&交期異動紀錄
              SEEK D07.F01+D07.F02+DTOS(D07.F03)
              IF FOUND()
                 IF THISFORM.TXTF03.VALUE<>F03 .OR. THISFORM.TXTF04.VALUE<>F04
                    REPL F05 WITH THISFORM.TXTF03.VALUE
                    REPL F06 WITH THISFORM.TXTF04.VALUE
                    REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                    IF THISFORM.TXTF03.VALUE<>F03
                       APPEND BLANK
                       REPL F01 WITH D07.F01
                       REPL F02 WITH D07.F02
                       REPL F03 WITH THISFORM.TXTF03.VALUE
                       REPL F04 WITH THISFORM.TXTF04.VALUE
                       REPL F07 WITH D07.F07
                       REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                       REPL F09 WITH D07.F11
                    ENDIF   
                 ENDIF   
              ENDIF   
              SELE P07       &&回復請購狀態第一二次                                            
              SEEK LEFT(D07.F07,10)+D07.F02
              IF FOUND()
                 REPL F07 WITH F07+D07.F04
                 REPL F07 WITH F07+THISFORM.TXTF04.VALUE*(-1)
                 IF F07<=0
                    DELE
                 ENDIF   
              ELSE                               
                 SELE P05
                 SEEK LEFT(D07.F07,10)
                 IF FOUND()
                    SELE P06
                    SEEK LEFT(D07.F07,10)+D07.F02
                    IF FOUND()
                       SELE P07
                       APPEND BLANK
                       REPL F01 WITH P05.F01
                       REPL F02 WITH P05.F02
                       REPL F03 WITH P05.F04
                       REPL F04 WITH P05.F05
                       REPL F05 WITH P05.F06
                       REPL F06 WITH P06.F02
                       REPL F07 WITH F07+D07.F04
                       REPL F08 WITH P06.F05
                       REPL F09 WITH IIF(SEEK(sys_oper,'A01'),A01.F03,'')
                       REPL F10 WITH P05.F07    
                       REPL F07 WITH F07+THISFORM.TXTF04.VALUE*(-1)
                       IF F07<=0
                          DELE
                       ENDIF                                                                                                 
                     ENDIF
                 ENDIF      
              ENDIF  
              SELE D04
              REPL F22 WITH F22+D07.F04*(-1)
              REPL F22 WITH F22+THISFORM.TXTF04.VALUE     
           ELSE
              SELE P07
              SEEK LEFT(D07.F07,10)+D07.F02
              IF FOUND()
                 REPL F11 WITH F11+D07.F04*(-1)
                 REPL F11 WITH F11+THISFORM.TXTF04.VALUE
              ENDIF                                  
           ENDIF  
           SELECT D07
           D07F03 = D07.F03
           D07F04 = D07.F04
           D07F13 = D07.F13          
           REPLACE D07.F07 WITH D04.F11   
           REPLACE D07.F03 WITH THISFORM.TXTF03.VALUE
           REPLACE D07.F04 WITH THISFORM.TXTF04.VALUE
           REPLACE D07.F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPLACE D07.F13 WITH ALLTRIM(THISFORM.TRANS_STYLE.DISPLAYVALUE) 
           REPLACE D07.F17 WITH THISFORM.TXTF17.VALUE 
           CALC SUM(F04) TO TQTY     
           SEEK D04.F01+D04.F02+DTOS(THISFORM.TXTF03.VALUE)                                   
           ***傳送郵件
           MAIL_TEXT = ''
           TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
           FNTCHG1=IIF(OS()="Windows 5.01","","<font color='blue'>")
           FNTCHG2=IIF(OS()="Windows 5.01","","</font>")
           IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE'
              WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
              MAIL_TEXT = '採購單號：' + D07.F01 + TMPCHR + ;
     	         		  '料品編號：' + D07.F02 + TMPCHR + ;
     	         		  '進貨日期：' +IIF(D07F03<>D07.F03,FNTCHG1,'')+DTCX(D07F03) + '  ＞＞  ' + DTCX(D07.F03) +IIF(D07F03<>D07.F03,FNTCHG2,'')+ TMPCHR + ;
     	        		  '進貨數量：' +IIF(D07F04<>D07.F04,FNTCHG1,'')+ ALLTRIM(TRANSFORM(D07F04,'@R 999,999,999,999'))  + '  ＞＞  ' + ALLTRIM(TRANSFORM(D07.F04,'@R 999,999,999,999'))+IIF(D07F04<>D07.F04,FNTCHG2,'') + TMPCHR + ;
     	         		  '運貨方式：' +IIF(D07F13<>D07.F13,FNTCHG1,'')+ D07F13 + '  ＞＞  ' + D07.F13 +IIF(D07F13<>D07.F13,FNTCHG2,'')+ TMPCHR + ;
     	         		  '備註說明：' + ALLTRIM(D07.F17) + TMPCHR + ;
     	         		  '需求單號：' + P05.F06 + TMPCHR + ;
     	         		  '採購用途：' + ALLTRIM(D07.F07) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)
              ***傳送給業務助理                            
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.   
                 ASSIS_NO=A01.F01
                 IF OS()="Windows 5.01"
                    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已更新計畫','TEXT',MAIL_TEXT) 
                 ELSE                    
                    IF !EMPTY(ALLTRIM(ASSIS_NO))
                       FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                       **STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD'+IIF(D07F03<D07.F03,' bgcolor="#FF0000"','')+'>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                    ENDIF   
                 ENDIF
              ELSE
                 ASSIS_NO=''   	     
              ENDIF 
               ***傳送給業務B
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                    		
                 SALES_B_NO=A01.F01
                 IF SALES_B_NO<>ASSIS_NO
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已更新計畫','TEXT',MAIL_TEXT)  	  
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_B_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                          **STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD'+IIF(D07F03<D07.F03,' bgcolor="#FF0000"','')+'>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       ENDIF   
                    ENDIF
                 ENDIF      
              ELSE
                 SALES_B_NO=''        
              ENDIF 
              ***傳送給業務A
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                    
                 SALES_A_NO=A01.F01
                 IF SALES_A_NO<>SALES_B_NO 
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已更新計畫','TEXT',MAIL_TEXT)		  
                    ELSE
                      IF !EMPTY(ALLTRIM(SALES_A_NO))
                         FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                         **STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                         STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD'+IIF(D07F03<D07.F03,' bgcolor="#FF0000"','')+'>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                      ENDIF   
                    ENDIF
                 ENDIF  
              ELSE
                 SALES_A_NO=''    	     
              ENDIF                            
              WAIT CLEAR  
           ENDIF   
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC
      PROC SHRGROUP.ABANDON_BOTT.CLICK
           THISFORM.SHRGROUP.ENABLED=.F.
           THISFORM.SHRGROUP.VISIBLE=.F.      
           THISFORM.ORPGROUP.ENABLED=.T.
           THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
           THISFORM.LBLTQTY.CAPTION=TRANSFORM(D04.F09-TQTY,'@R 99999999.99') 
           THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(D04.F09-TQTY<>0,.T.,.F.)                          
           THISFORM.CMND2.ENABLED=IIF(D04.F09-TQTY>=0,.T.,.F.)   
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(D04.F09-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1                                                                          
           THISFORM.LBLF_C66.CAPTION = IIF(EMPTY(D07.F14) OR D07.F14 ='4','','此筆計畫已被提出交期之異動 >> ' + ICASE(D07.F14 = '1','提前交期',D07.F14 = '2','延後交期',D07.F14 = '3','取消訂購',''))
           THISFORM.TXTF13.VISIBLE=.T.    
           THISFORM.TRANS_STYLE.VISIBLE=.F. 
           THISFORM.GRID1.ENABLED=.T.
           THISFORM.GRID1.SETFOCUS
           SELECT D07
           UNLOCK ALL      
      ENDPROC
      PROC SHRGROUP.FINISH_BOTT.CLICK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
      ENDPROC
      PROCEDURE TXTF04.VALID
         LPARAMETERS  NINDEX
         IF THIS.VALUE<=D04.F09-TQTY+IIF(THISFORM.SHRGROUP.ENABLED=.T.,QTY,D07.F04)
            NINDEX=.T.
         ELSE
            =MESSAGEBOX("出貨數量不得大於"+TRANSFORM(D04.F09-TQTY+QTY,'@J 99999999.99'),0+64,"提示視窗") 
            IF D04.F09-TQTY+QTY<0
               NINDEX=.T.
            ELSE     
               NINDEX=.F.
            ENDIF   
         ENDIF
         RETURN NINDEX
      ENDPROC 
      PROCEDURE TXTF03.VALID
         LPARAMETERS  NINDEX
         IF !EMPTY(THIS.VALUE) .AND. THIS.VALUE>=D03.F01
            NINDEX=.T.
         ELSE
            =MESSAGEBOX("進貨日期不得空白且不能小於下單日"+DTOC(D03.F01),0+64,"提示視窗")    
            NINDEX=.F.
         ENDIF
         RETURN NINDEX
      ENDPROC 
  PROC PERMIT_BOTT.CLICK      &&確認交期
       IF RLOCK('D04') .AND. RLOCK('D07') 
          SELE D04
          REPL F22 WITH F22+D07.F04
          SELE D07          
          REPLACE F09 WITH '1'
          REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
          REPLACE F11 WITH F03
          IF !EMPTY(D07.F14) AND !EMPTY(D07.F15)
             REPLACE D07.F14 WITH '4'
             REPLACE D07.F15 WITH CTOD('')
          ENDIF
          SELE P07
          SEEK LEFT(D04.F11,10)+D04.F02    &&刪除待處理請購明細資料
          IF FOUND()
             REPL F07 WITH F07+D07.F04*(-1)
             REPL F11 WITH F11+D07.F04*(-1)  
             IF F07<=0
                DELE
             ENDIF   
          ENDIF   
          SELE D38
          APPEND BLANK
          REPL F01 WITH D07.F01
          REPL F02 WITH D07.F02
          REPL F03 WITH D07.F03
          REPL F04 WITH D07.F04
          REPL F07 WITH D07.F07
          REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')          
          REPL F09 WITH D07.F11
           ***傳送郵件
           IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE'
              MAIL_TEXT = ''
              TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
              WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
              MAIL_TEXT = '採購單號：' + D07.F01 + TMPCHR + ;
     	         		  '料品編號：' + D07.F02 + TMPCHR + ;
     	         		  '進貨日期：' + DTOC(D07.F03) +TMPCHR + ;
     	        		  '進貨數量：' + ALLTRIM(TRANSFORM(D07.F04,'@R 999,999,999,999')) + TMPCHR + ;
     	         		  '運貨方式：' + D07.F13 + TMPCHR + ;
     	         		  '備註說明：' + ALLTRIM(D07.F17) + TMPCHR + ;     	         		  
     	         		  '需求單號：' + P05.F06 + TMPCHR + ;
     	         		  '採購用途：' + ALLTRIM(D07.F07) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)
     	      ***傳送給業務助理                            
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                   
                  ASIS_NO=A01.F01
                  IF OS()="Windows 5.01"		 &&如果作業系統為WINDOWS XP 
                      SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已確定交期','TEXT',MAIL_TEXT)  	   
                  ELSE
                    IF !EMPTY(ALLTRIM(ASSIS_NO))
                       FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                       STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已確認交期<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10) ,FILE_NAME,1)
                    ENDIF   
                  ENDIF               
              ELSE
                  ASSIS_NO=''        
              ENDIF    		  
               ***傳送給業務B 
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                     
                 SALES_B_NO=A01.F01   
                 IF SALES_B_NO<>ASSIS_NO
                    IF OS()="Windows 5.01"		 &&如果作業系統為WINDOWS XP 
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已確定交期','TEXT',MAIL_TEXT) 		  
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_B_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已確認交期<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10) ,FILE_NAME,1)
                       ENDIF   
                    ENDIF
                 ENDIF   
              ELSE
                 SALES_B_NO=''   	  
              ENDIF
              ***傳送給業務A
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.                   
                 SALES_A_NO=A01.F01
                 IF SALES_A_NO<>SALES_B_NO 
                    IF OS()="Windows 5.01"		 &&如果作業系統為WINDOWS XP 
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已確定交期','TEXT',MAIL_TEXT) 	  
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_A_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已確認交期<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10) ,FILE_NAME,1)
                       ENDIF   
                    ENDIF
                 ENDIF   
              ELSE
                 SALES_A_NO=''                     	  
              ENDIF                          
              WAIT CLEAR  
           ENDIF   
           ***  
       ELSE
         DO file_impact                  
       ENDIF    
       UNLOCK ALL
       THISFORM.GRID1.SETFOCUS
       THIS.ENABLED=.F.
  ENDPROC                     
enddefine            
************************************************進貨紀錄
define class RCC_SEEK as form
  autocenter=.t.
  caption='進貨紀錄'
  fontsize=INT_015*9
  height=INT_015*340
  width=INT_015*275
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  showwindow=1
  windowtype=1
  name='RCC_SEEK'
  add object GRID1 as GRID with;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      top=0,;
      width=INT_015*275,;      
      height=INT_015*310,;      
      deletemark=.f.,;
      READONLY=.T.,;
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      recordsourcetype=1,;
      columncount=3,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3'           
  add object cmdgroup as cmdgroup with;      
      top=INT_015*310,;
      left=INT_015*2,;
      visible=.t.      
  add object cmnd2 as commandbutton with;
      left=INT_015*210,;
      top=INT_015*315,;
      height=INT_015*25,;
      width=INT_015*40,;
      FONTSIZE=INT_015*9,;
      caption='\<X.離開',;
      TOOLTIPTEXT='離開此查詢尋畫面!快速鍵->ALT+X'
      name='cmnd2'
      procedure init 
         AREA1='RCC' 
         THISFORM.GRID1.READONLY=.T. 
         thisform.grid1.recordsource='RCC'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='進貨日期'
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='F03'         
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*65      
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='進(退)貨單號'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='F04'         
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='進(退)貨數量'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='F05'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*100
         THISFORM.GRID1.SETFOCUS
         IF THISFORM.GRID1.ACTIVEROW<>0
              THISFORM.GRID1.AFTERROWCOLCHANGE 
         ENDIF         
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XColIndex     
         FCH=THISFORM.ACTIVECONTROL.NAME  
      ENDPROC 
      procedure cmnd2.click
          FLG=''   
          thisform.release
      endproc      
enddefine            
*****************************交期自訂函數
FUNC DELIVER
     PARA BKK_NO,MAT
     qt_od=SPACE(0)
     sele D07
     SET ORDER TO  D074
     SEEK BKK_NO+MAT
     IF FOUND()
        DO WHILE F01+F02=BKK_NO+MAT
           IF D07.F09='1'
              IF INT_012=1
                 qt_od=qt_od+TRANSFORM(VAL(LEFT(DTOS(F03),4))-1911,'@R ###')+RIGHT(DTOC(F03),6)+'->'+ALLTRIM(TRANSFORM(F04,'@J 99999999.99'))+SPACE(3)
              ELSE
                 qt_od=qt_od+DTOC(F03)+'->'+ALLTRIM(TRANSFORM(F04,'@J 99999999.99'))+SPACE(4) 
              ENDIF  
           ENDIF    
           SKIP
        ENDDO
     ELSE
       qt_od=SPACE(0)
     ENDIF
     SELE D04
     RETURN qt_od
