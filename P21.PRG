**程式名稱:P21.樣品申請紀錄表
SET EXCL OFF
CLOSE ALL
CLEAR 
AREA1='P21_TEMP'
CK=''
FLG='0'
FCH=''
CHK=''
PD = ''
CHK_STR = ''
FILE_NAME=''
COD=0
IF !USED('A01')
   SELE 0
   USE A01
ELSE 
   SELE A01
ENDIF
SET ORDER TO A01      
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'P21'    
IF !USED('A23')	&&月份檔
    SELECT  0
    USE A23
ELSE 
   SELECT  A23
ENDIF
SET ORDER TO A231
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1             
IF !USED ('B01')
   SELE 0
   USE B01 
ELSE 
   SELE B01
ENDIF
SET ORDER TO B011
IF !USED('D01')
   SELE 0
   USE D01
ELSE 
   SELE D01
ENDIF
SET ORDER TO D011             
IF !USED('C01')
   SELE 0
   USE C01
ELSE 
   SELE C01
ENDIF
SET ORDER TO C011
IF !USED('P20')
   SELE 0
   USE P20
ELSE
  SELE P20
ENDIF
SET ORDER TO P201  
SELECT P20.*,RIGHT(DTOC(P20.F02),2) AS F02B,A01.F03 AS A01F03,C01.F05 AS C01F05,D01.F03 AS D01F03,D01.F04 AS D01F04,D01.F07 AS D01F07,D01.F23 AS D01F23;
      FROM P20,A01,C01,D01 WHERE LEFT(DTOS(P20.F02),6) = LEFT(DTOS(DATE()),6) AND P20.F03 = D01.F01 AND P20.F04 = C01.F01 AND P20.F13 = A01.F01 INTO CURSOR P21_TEMP READWRITE
INDEX ON F01+F02B+F05+F03+F04+F10 TAG P21_TEMP1
INDEX ON F03+F02B+F05+F04+F01+F10 TAG P21_TEMP2
INDEX ON F04+F02B+F05+F03+F01+F10 TAG P21_TEMP3
INDEX ON F13+F02B+F05+F03+F01+F10 TAG P21_TEMP4
INDEX ON F05+F02B+F01+F03+F04+F10 TAG P21_TEMP5
INDEX ON F11+F02B+F05+F03+F04+F01 TAG P21_TEMP6
SELECT P21_TEMP 
SET ORDER TO P21_TEMP1
COD=SYS(21)
GO TOP
*******
P21FORM=CREATEOBJECT("TKP21")
P21FORM.SHOW  
DEFINE CLASS TKP21 AS FORM
  CAPTION='P21.樣品申請紀錄表'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*791
  WINDOWTYPE=1
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      WIDTH=INT_015*170,;
      AUTOCENTER=.T.
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      LEFT=INT_015*8,;
      TOP=INT_015*32   
  ADD OBJECT KEY_LIST2 AS KEY_LIST WITH;
      LEFT=INT_015*93,;
      TOP=INT_015*32,;
      WIDTH=INT_015*85   
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=12,;      
      TOP=INT_015*61,;      
      RECORDSOURCE='P21_TEMP',; 
      HEIGHT=INT_015*465,;     
      WIDTH=INT_015*783,;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',; 
      COLUMN5.NAME='COLUMN5',;             
      COLUMN6.NAME='COLUMN6',;       
      COLUMN7.NAME='COLUMN7',;       
      COLUMN8.NAME='COLUMN8',;
      COLUMN9.NAME='COLUMN9',;   
      COLUMN10.NAME='COLUMN10',;
      COLUMN11.NAME='COLUMN11',;
      COLUMN12.NAME='COLUMN12'
   ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*0,;
      LEFT=INT_015*175,;
      ENABLED=.T.,;
      VISIBLE=.T.            
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;      
      TOP=INT_015*0,;
      LEFT=INT_015*385  
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*390,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;  
      CAPTION='\<A.確認'
  ADD OBJECT CNL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*432,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;           
      CAPTION='\<B.取消' 
  ADD OBJECT REPLY_REMARK AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*474,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<E.修改'         
  ADD OBJECT LBLF14 AS LABEL WITH;
      TOP=INT_015*38,;
      LEFT=INT_015*180,;
      HEIGHT=INT_015*23,;      
      WIDTH=INT_015*55,;
      FONTSIZE=INT_015*9,;
      CAPTION='申請狀態'     
  ADD OBJECT TXTF10 AS TEXTBOX WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*230,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*365,;
      MAXLENGTH=50,;
      FONTSIZE=INT_015*9
  ADD OBJECT LBLF98 AS LABEL WITH;
      VISIBLE=.T.,;           
      LEFT=INT_015*630,;
      TOP=INT_015*13,;
      AUTOSIZE=.T.,; 
      CAPTION='確認人員'
  ADD OBJECT LBLF99 AS LABEL WITH;
      VISIBLE=.T.,;            
      LEFT=INT_015*630,; 
      TOP=INT_015*36,; 
      AUTOSIZE=.T.,; 
      CAPTION='安全資料'         
  ADD OBJECT YES AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*690,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<Y.確定'
  ADD OBJECT NO AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*732,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<N.取消'                                          
  PROCEDURE INIT
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.
 	   CHK_STR = THISFORM.MTH_LIST.DISPLAYVALUE
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')     
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')         
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')    
       THISFORM.YES.VISIBLE=.F.
  	   THISFORM.NO.VISIBLE=.F.
       THISFORM.GRID1.LOCKCOLUMNS=2
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*75
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*160
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*130
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*65
       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*65
       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='申請日期'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='料    號'	   
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='品名規格'	   
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='申請數量'
       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='需求日期'
       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='回覆數量'
       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆交期'
       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='申請廠商'
       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='需求客戶'
       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='申請人'
       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='列印單號'  	
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P21_TEMP.F02'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P21_TEMP.F05'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_TEMP.F06'
	   THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F07'
       THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F15'
       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F12'
       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.D01F04'   
       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.C01F05'
       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.A01F03'  
       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.F11'	    
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID1.SETFOCUS    
       IF  THISFORM.GRID1.ACTIVEROW=0 
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F. 
	      THISFORM.ANS_BOTT .ENABLED=.F.
	      THISFORM.CNL_BOTT.ENABLED=.F.
          THISFORM.REPLY_REMARK.ENABLED=.F.
        ELSE
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
	      THISFORM.ANS_BOTT .ENABLED=P21_TEMP.F09 = '2' AND IIF(A02.F08='*',.T.,.F.)
	      THISFORM.CNL_BOTT.ENABLED=P21_TEMP.F09 = '1' AND IIF(A02.F09='*',.T.,.F.)
          THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F05='*',.T.,.F.) AND P21_TEMP.F09 <> '2'
        ENDIF   
        JK = '申請單號'
  ENDPROC    
  PROC KEY_LIST2.INIT
       WITH THIS 
           .ADDITEM('月份資料')
           .ADDITEM('全部資料')
       ENDWITH     
  ENDPROC
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依申請單號+料號排列')
           .ADDITEM('依申請廠商編號+料號排列')
           .ADDITEM('依需求客戶編號+料號排列')      
           .ADDITEM('依申請人員編號+料號排列')   
           .ADDITEM('依料品編號+日期排列')    
           .ADDITEM('依列印單號+料號排列')           
           .VALUE=1      
       ENDWITH      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELECT  P21_TEMP
       DO CASE
          CASE THIS.DISPLAYVALUE='依申請單號+料號排列'       
               SET ORDER TO P21_TEMP1    
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*75
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*160
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*130
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='申請日期'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='料    號'	   
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='品名規格'	   
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='申請數量'
		       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='需求日期'
		       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='回覆數量'
		       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆交期'
		       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='需求客戶'
		       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='申請人'
		       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='列印單號'  	
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.F01'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P21_TEMP.F02'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P21_TEMP.F05'
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_TEMP.F06'
			   THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F07'
		       THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F15'
		       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F12'
		       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.D01F04'   
		       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.C01F05'
		       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.A01F03'
		       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.F11'	
		       JK = '申請單號'	          	   
          CASE THIS.DISPLAYVALUE='依申請廠商編號+料號排列'       
               SET ORDER TO P21_TEMP2    
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*160
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*130
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請廠商'
			   THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料    號'	   
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='品名規格'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='日    期'
		       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='申請數量'
		       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='需求日期'
		       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆數量'
		       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='回覆交期' 
		       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='需求客戶'
		       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='申請人'
		       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='列印單號'  
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.D01F04'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P21_TEMP.F05'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"	
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P21_TEMP.F01'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_TEMP.F02'
		       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F06'
			   THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F07'
		       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F15'
		       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.F12'   
		       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.C01F05'
		       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.A01F03'
		       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.F11'	
		       JK = '申請廠商編號'	          	     
          CASE THIS.DISPLAYVALUE='依需求客戶編號+料號排列'       
               SET ORDER TO P21_TEMP3  
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*160
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*130
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='需求客戶'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料    號'	   
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='品名規格'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='申請日期'
		       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='申請數量'
		       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='需求日期'
		       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆數量'
		       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='回覆交期'
		       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='申請人'
		       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='列印單號' 
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.C01F05' 	
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P21_TEMP.F05'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P21_TEMP.F01'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_TEMP.F02'
		       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F06'
			   THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F07'
		       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F15'
		       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.F12'
		       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.D01F04' 
		       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.A01F03'   
		       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.F11'
		       JK = '需求客戶編號'
          CASE THIS.DISPLAYVALUE='依申請人員編號+料號排列'       
               SET ORDER TO P21_TEMP4    
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*75
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*160
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*130
		       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55	       
		       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請人'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='申請日期'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='料    號'	   
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='品名規格'	   
		       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='申請數量'
		       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='需求日期'
		       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆數量'
		       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='回覆交期'
		       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='需求客戶'	       
		       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='列印單號' 
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.A01F03' 	
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P21_TEMP.F01'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P21_TEMP.F02'
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P21_TEMP.F05'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
		       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F06'
			   THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F07'
		       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F15'
		       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.F12'
		       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.D01F04'   
		       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.C01F05'       
		       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.F11'	
		       JK = '申請人員編號'	
          CASE THIS.DISPLAYVALUE='依料品編號+日期排列'       
               SET ORDER TO P21_TEMP5   
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*160
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*130
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*75
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85		       
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料    號'	   
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='品名規格'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='申請日期'	   
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='申請數量'
		       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='需求日期'
		       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='回覆數量'
		       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆交期'
		       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='需求客戶'
		       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='申請人'
		       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='列印單號'  
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.F05'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P21_TEMP.F01'
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P21_TEMP.F02'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_TEMP.F06'
			   THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F07'
		       THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F15'
		       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F12'
		       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.D01F04'   
		       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.C01F05'
		       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.A01F03'
		       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.F11'	
		       JK = '料品編號'	 	          	    
          CASE THIS.DISPLAYVALUE='依列印單號+料號排列'       
               SET ORDER TO P21_TEMP6  
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*85  
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*160
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*130
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*65
		       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*55  
		       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='列印單號'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料    號'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='品名規格'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='申請日期'   
		       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='申請數量'
		       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='需求日期'
		       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆數量'
		       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='回覆交期'
		       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='需求客戶' 
		       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='申請人'
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_TEMP.F11' 	
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P21_TEMP.F05'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE="IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P21_TEMP.F01'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_TEMP.F02'
		       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_TEMP.F06'
			   THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_TEMP.F07'
		       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_TEMP.F15'
		       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P21_TEMP.F12'
		       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_TEMP.D01F04'   
		       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='P21_TEMP.C01F05'
		       THISFORM.GRID1.COLUMN12.CONTROLSOURCE='P21_TEMP.A01F03'
		       JK = '列印單號'	          	    	        
       ENDCASE 
       COD=SYS(21)
       THISFORM.GRID1.REFRESH
       THISFORM.GRID1.SETFOCUS
  ENDPROC   
  PROC KEY_LIST2.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       SELE P21_TEMP
       USE
       DO CASE
          CASE THIS.DISPLAYVALUE='月份資料'
               THISFORM.MTH_LIST.ENABLED = .T.
               CHK_STR = ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE)
          CASE THIS.DISPLAYVALUE='全部資料'
               THISFORM.MTH_LIST.ENABLED = .F.
               CHK_STR = 'Y'
       ENDCASE  
		SELECT P20.*,RIGHT(DTOC(P20.F02),2) AS F02B,A01.F03 AS A01F03,C01.F05 AS C01F05,D01.F03 AS D01F03,D01.F04 AS D01F04,D01.F07 AS D01F07,D01.F23 AS D01F23 FROM P20,A01,C01,D01;
		      WHERE IIF(CHK_STR = 'Y',.T.,LEFT(DTOS(P20.F02),6) = LEFT(DTOS(CTOD(CHK_STR+'/01')),6)) AND P20.F03 = D01.F01 AND P20.F04 = C01.F01 AND P20.F13 = A01.F01 INTO  CURSOR P21_TEMP READWRITE
		INDEX ON F01+F02B+F05+F03+F04+F10 TAG P21_TEMP1
		INDEX ON F03+F02B+F05+F04+F01+F10  TAG P21_TEMP2
		INDEX ON F04+F02B+F05+F03+F01+F10 TAG P21_TEMP3
		INDEX ON F13+F02B+F05+F03+F01+F10 TAG P21_TEMP4
		INDEX ON F05+F02B+F01+F03+F04+F10 TAG P21_TEMP5
		INDEX ON F11+F02B+F05+F03+F04+F01 TAG P21_TEMP6
		SELECT P21_TEMP 
		SET ORDER TO P21_TEMP1
		COD=SYS(21)
		GO TOP
		THISFORM.GRID1.RECORDSOURCE='P21_TEMP'
        THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.GRID1.SETFOCUS        
	   THISFORM.REFRESH
       THISFORM.GRID1.SETFOCUS    
       IF  THISFORM.GRID1.ACTIVEROW=0 
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F. 
	      THISFORM.ANS_BOTT .ENABLED=.F.
	      THISFORM.CNL_BOTT.ENABLED=.F.
          THISFORM.REPLY_REMARK.ENABLED=.F.
        ELSE
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限   
	      THISFORM.ANS_BOTT .ENABLED=P21_TEMP.F09 = '2' AND IIF(A02.F08='*',.T.,.F.)
	      THISFORM.CNL_BOTT.ENABLED=P21_TEMP.F09 = '1' AND IIF(A02.F09='*',.T.,.F.)
          THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F05='*',.T.,.F.)
        ENDIF
  ENDPROC
   PROC MTH_LIST.INTERACTIVECHANGE
		CHK_STR = THIS.DISPLAYVALUE
		THISFORM.GRID1.RECORDSOURCE=''
		SELECT P21_TEMP
		USE
		SELECT P20.*,RIGHT(DTOC(P20.F02),2) AS F02B,A01.F03 AS A01F03,C01.F05 AS C01F05,D01.F03 AS D01F03,D01.F04 AS D01F04,D01.F07 AS D01F07,D01.F23 AS D01F23 FROM P20,A01,C01,D01;
		      WHERE IIF(CHK_STR = 'Y',.T.,LEFT(DTOS(P20.F02),6) = LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)) AND P20.F03 = D01.F01 AND P20.F04 = C01.F01 AND P20.F13 = A01.F01 INTO  CURSOR P21_TEMP READWRITE
		INDEX ON F01+F02B+F05+F03+F04+F10 TAG P21_TEMP1
		INDEX ON F03+F02B+F05+F04+F01+F10  TAG P21_TEMP2
		INDEX ON F04+F02B+F05+F03+F01+F10 TAG P21_TEMP3
		INDEX ON F13+F02B+F05+F03+F01+F10 TAG P21_TEMP4
		INDEX ON F11+F02B+F05+F03+F04+F01 TAG P21_TEMP5
		SELECT P21_TEMP 
		SET ORDER TO P21_TEMP1
		COD=SYS(21)
		GO TOP
		THISFORM.GRID1.RECORDSOURCE='P21_TEMP'
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.GRID1.SETFOCUS        
	   THISFORM.REFRESH
       THISFORM.GRID1.SETFOCUS    
       IF  THISFORM.GRID1.ACTIVEROW=0 
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F. 
	      THISFORM.ANS_BOTT .ENABLED=.F.
	      THISFORM.CNL_BOTT.ENABLED=.F.
          THISFORM.REPLY_REMARK.ENABLED=.F.
        ELSE
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	      THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	      THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.    
	      THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.	        
	      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限   
	      THISFORM.ANS_BOTT .ENABLED=P21_TEMP.F09 = '2' AND IIF(A02.F08='*',.T.,.F.)
	      THISFORM.CNL_BOTT.ENABLED=P21_TEMP.F09 = '1' AND IIF(A02.F09='*',.T.,.F.)
          THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F05='*',.T.,.F.)
        ENDIF 
  ENDPROC             
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.TXTF10.VALUE=P21_TEMP.F10
       THISFORM.LBLF98.CAPTION=ICASE(P21_TEMP.F09 = '1','確認人員',P21_TEMP.F09 = '2','取消人員','') + P21_TEMP.F98
       THISFORM.LBLF99.CAPTION='安全資料' + P21_TEMP.F99
	   THISFORM.ANS_BOTT.ENABLED=P21_TEMP.F09 = '2' AND IIF(A02.F08='*',.T.,.F.)
	   THISFORM.CNL_BOTT.ENABLED=P21_TEMP.F09 = '1' AND IIF(A02.F09='*',.T.,.F.)
       THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F05='*',.T.,.F.) AND P21_TEMP.F09 <> '2'
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","ICASE(P21_TEMP.F09 = '2',RGB(255,0,0),P21_TEMP.F09 = '1' AND EMPTY(P21_TEMP.F12),RGB(255,255,0),P21_TEMP.F09 ='1' AND !EMPTY(P21_TEMP.F12),RGB(0,255,255),'')","COLUMN")
       THISFORM.GRID1.TOOLTIPTEXT=ICASE(P21_TEMP.F09 = '2',ALLTRIM(P21_TEMP.D01F04) + '無法提供此料品之申請',P21_TEMP.F09 = '1' AND EMPTY(P21_TEMP.F12),'已向' + ALLTRIM(P21_TEMP.D01F04) + '提出申請且尚未回覆交期',P21_TEMP.F09 ='1' AND !EMPTY(P21_TEMP.F12),ALLTRIM(P21_TEMP.D01F04) + '已回覆交期','')
       FCH=THISFORM.ACTIVECONTROL.NAME
       CHK=''
       THISFORM.REFRESH
  ENDPROC    
  PROCEDURE ANS_BOTT.CLICK	&&確認
   IF MESSAGEBOX('是否要確認此筆資料?',4+32+256,'請確認') = 6	 
      SELECT P21_TEMP
      LOCK() 
      IF RLOCK()
         SELECT P20
         SEEK P21_TEMP.F01 + P21_TEMP.F05 + DTOS(P21_TEMP.F02)
         IF FOUND()
	        REPLACE P20.F09 WITH '1'
	        REPLACE P20.F10 WITH '已向' + ALLTRIM(P21_TEMP.D01F04) + '提出申請作業'
	        REPLACE P20.F98 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	     ENDIF
	     SELECT P21_TEMP 
         REPLACE P21_TEMP.F09 WITH '1'
         REPLACE P21_TEMP.F10 WITH '已向' + ALLTRIM(P21_TEMP.D01F04) + '提出申請作業'
         REPLACE P21_TEMP.F98 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')  
      ELSE
         DO FILE_IMPACT
         UNLOCK ALL
         RETURN
      ENDIF 
      UNLOCK ALL 
   ENDIF
   SELECT P21_TEMP 
   THISFORM.GRID1.SETFOCUS
  ENDPROC
  PROCEDURE CNL_BOTT.CLICK	&&取消	
    THISFORM.YES.VISIBLE=.T.
	THISFORM.NO.VISIBLE=.T.	
    THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
    THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.F.
    THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
    THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
    THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
    THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
    THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F. 
	THISFORM.ANS_BOTT.ENABLED=.F.
	THISFORM.CNL_BOTT.ENABLED=.F.
    THISFORM.REPLY_REMARK.ENABLED=.F.
    THISFORM.KEY_LIST.ENABLED=.F.
    THISFORM.MTH_LIST.ENABLED=.F.
    THISFORM.GRID1.ENABLED = .F.
    THISFORM.TXTF10.READONLY = .F.
    THISFORM.TXTF10.VALUE = ALLTRIM(P21_TEMP.D01F04) + '告知為常用品故不提供樣品'
    THISFORM.LBLF98.CAPTION=''
    THISFORM.LBLF99.CAPTION=''
    THISFORM.TXTF10.SETFOCUS 
  ENDPROC 
 PROCEDURE YES.CLICK
  IF MESSAGEBOX('是否要取消此筆資料?',4+32+256,'請確認') = 6
     MAIL_TEXT = ''
     SELECT P21_TEMP
     LOCK()
     IF RLOCK()
        SELECT P20
        SEEK P21_TEMP.F01 + P21_TEMP.F05 + DTOS(P21_TEMP.F02)
        IF FOUND()
	       REPLACE P20.F09 WITH '2'
	       REPLACE P20.F10 WITH THISFORM.TXTF10.VALUE
	       REPLACE P20.F12 WITH CTOD('')
	       REPLACE P20.F15 WITH 0
	       REPLACE P20.F98 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	    ENDIF
        SELECT P21_TEMP
        REPLACE P21_TEMP.F09 WITH '2'
        REPLACE P21_TEMP.F10 WITH THISFORM.TXTF10.VALUE
        REPLACE P21_TEMP.F12 WITH CTOD('')
        REPLACE P21_TEMP.F15 WITH 0
        REPLACE P21_TEMP.F98 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
     ELSE
        DO FILE_IMPACT
        UNLOCK ALL
        RETURN
     ENDIF 
     UNLOCK ALL
     WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
     TMPCHR=IIF(OS()="Windows 5.01",CHR(13) + CHR(10),'<br/>')
	 MAIL_TEXT = '客戶名稱：' + P21_TEMP.C01F05 +TMPCHR + ;
	     	     '申請單號：' + P21_TEMP.F01 + TMPCHR + ;
	     	     '料品編號：' + P21_TEMP.F05 + TMPCHR + ;
	     	     '取消數量：' + ALLTRIM(TRANSFORM(P21_TEMP.F06,'@R 999,999')) +TMPCHR + ;
	     	     '取消原因：' + P21_TEMP.F10 + TMPCHR + ;
	     	     '取消人員：' + P21_TEMP.F98 + CHR(13) + CHR(10)
     ****傳送MAIL給申請人
      IF SEEK(P21_TEMP.F13,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
         IF OS()="Windows 5.01"
            SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P21_TEMP.D01F04 + ' 給予取消','TEXT',MAIL_TEXT)    
         ELSE
           FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
           STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被取消<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)   
         ENDIF                   
      ENDIF
      ****傳送MAIL給負責業務A
      IF SEEK(P21_TEMP.F04,'C01') = .T. AND EMPTY(C01.F18) = .F. AND ALLTRIM(P21_TEMP.F13) <> ALLTRIM(C01.F18) AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
         IF OS()="Windows 5.01"
    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P21_TEMP.D01F04 + ' 給予取消','TEXT',MAIL_TEXT) 
    	 ELSE
    	    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
            STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被取消<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)      
    	 ENDIF                      
      ENDIF
      ****傳送MAIL給負責業務B
      IF SEEK(P21_TEMP.F04,'C01') = .T. AND EMPTY(C01.F33) = .F. AND ALLTRIM(P21_TEMP.F13) <> ALLTRIM(C01.F33) AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
         IF OS()="Windows 5.01"
    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P21_TEMP.D01F04 + ' 給予取消','TEXT',MAIL_TEXT)
    	 ELSE
    	    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
            STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被取消<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)      
    	 ENDIF                       
      ENDIF
      ****傳送MAIL給負責業助
      IF SEEK(P21_TEMP.F04,'C01') = .T. AND EMPTY(C01.F23) = .F. AND ALLTRIM(P21_TEMP.F13) <> ALLTRIM(C01.F23) AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
         IF OS()="Windows 5.01"
    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P21_TEMP.D01F04 + ' 給予取消','TEXT',MAIL_TEXT)  
    	 ELSE
    	    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
            STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被取消<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)      
    	 ENDIF                     
      ENDIF
      WAIT CLEAR 
  ENDIF
  THISFORM.NO.CLICK 
 ENDPROC 
 PROCEDURE NO.CLICK &&修改取消
   THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
   THISFORM.YES.VISIBLE=.F.
   THISFORM.NO.VISIBLE=.F.
   THISFORM.GRID1.ENABLED=.T.
   THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T. 
   THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.T.
   THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限   
   THISFORM.ANS_BOTT.ENABLED=P21_TEMP.F09 = '2' AND IIF(A02.F08='*',.T.,.F.)
   THISFORM.CNL_BOTT.ENABLED=P21_TEMP.F09 = '1' AND IIF(A02.F09='*',.T.,.F.)
   THISFORM.REPLY_REMARK.ENABLED= P21_TEMP.F09 = '1' AND IIF(A02.F05='*',.T.,.F.)
   THISFORM.KEY_LIST.ENABLED=.T.
   THISFORM.MTH_LIST.ENABLED=.T.
   THISFORM.GRID1.ENABLED=.T.     
   THISFORM.GRID1.SETFOCUS
   UNLOCK ALL
   SELECT P21_TEMP
   THISFORM.REFRESH
 ENDPROC 
  PROCEDURE REPLY_REMARK.CLICK &&修改
    SELECT P21_TEMP
    REPLY_FORM=CREATEOBJECT("REPLY_FORM")  
    REPLY_FORM.SHOW  
    SELECT P21_TEMP   
    UNLOCK ALL
    THISFORM.GRID1.SETFOCUS
    THISFORM.REFRESH
 ENDPROC       
ENDDEFINE
**************************************&&修改表單
DEFINE CLASS REPLY_FORM AS FORM
  AUTOCENTER=.T.
  FONTSIZE=INT_015*9 
  TOP=INT_015*110
  LEFT=INT_015*40    
  HEIGHT=INT_015*90
  WIDTH=INT_015*520
  FONTSIZE=INT_015*9
  MOVABLE=.T.
  MAXBUTTON=.F.
  MINBUTTON=.F.      
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='REPLY_FORM'      
  ADD OBJECT LBLF05 AS LABEL WITH;
      TOP=INT_015*10,;
      LEFT=INT_015*10,;
      HEIGHT=INT_015*17,;      
      WIDTH=INT_015*60,;
      CAPTION='料品編號'   
  ADD OBJECT LBLF051 AS LABEL WITH;
      TOP=INT_015*10,;
      LEFT=INT_015*320,;
      HEIGHT=INT_015*17,;      
      AUTOSIZE=.T.,;
      CAPTION=''           
  ADD OBJECT TXTF05 AS TXTF05 WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*65,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*250,;
      MAXLENGTH=43        
  ADD OBJECT LBLF12 AS LABEL WITH;
      TOP=INT_015*36,;
      LEFT=INT_015*10,;
      HEIGHT=INT_015*17,;      
      WIDTH=INT_015*60,;
      CAPTION='回覆交期'       
  ADD OBJECT TXTF12 AS TEXTBOX WITH;
      TOP=INT_015*31,;
      LEFT=INT_015*65,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*80   
  ADD OBJECT LBLF15 AS LABEL WITH;
      TOP=INT_015*36,;
      LEFT=INT_015*208,;
      HEIGHT=INT_015*17,;      
      WIDTH=INT_015*60,;
      CAPTION='回覆數量'   
  ADD OBJECT TXTF15 AS TEXTBOX WITH;
      TOP=INT_015*31,;
      LEFT=INT_015*261,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*54,; 
      MAXLENGTH=6            
  ADD OBJECT LBLF10 AS LABEL WITH;
      TOP=INT_015*61,;
      LEFT=INT_015*10,;
      HEIGHT=INT_015*17,;      
      WIDTH=INT_015*60,;
       CAPTION='申請狀態'           
  ADD OBJECT TXTF10 AS TEXTBOX WITH;
      TOP=INT_015*56,;
      LEFT=INT_015*65,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*250,; 
      MAXLENGTH=50  
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*360,;
      TOP=INT_015*56,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.CUR',;
      CAPTION='\<A.確定',;
      TOOLTIPTEXT='確定此筆資料之修改!快速鍵->ALT+A'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*403,;
      TOP=INT_015*56,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.CUR',;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此修改畫面!快速鍵->ALT+X'
      NAME='CMND2'
 PROC INIT   
       THISFORM.CAPTION='修改廠商' + ALLTRIM(P21_TEMP.D01F04) + '回覆後之資料、' + '需求客戶：' + ALLTRIM(P21_TEMP.C01F05) + '、申請單號：' + P21_TEMP.F01
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.F.,'TEXTBOX')  
       THISFORM.TXTF05.READONLY=.F.
 	   THISFORM.TXTF05.VALUE=P21_TEMP.F05
 	   THISFORM.TXTF10.VALUE=P21_TEMP.F10
 	   THISFORM.TXTF12.VALUE=IIF(EMPTY(P21_TEMP.F12),DATE(),P21_TEMP.F12)
 	   THISFORM.TXTF15.VALUE=P21_TEMP.F15
 	   THISFORM.LBLF051.CAPTION=IIF(SEEK(P21_TEMP.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')
 	   THISFORM.LBLF051.BACKCOLOR=IIF(SEEK(P21_TEMP.F05,'B01'),RGB(192,192,192),RGB(255,255,0)) 
   ENDPROC
 PROCEDURE CMND1.CLICK
       IF SEEK(THISFORM.TXTF05.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.TXTF05.SETFOCUS
          RETURN
       ENDIF  
       IF EMPTY(THISFORM.TXTF05.VALUE)=.T.
          =MESSAGEBOX('料號不得空白!',0+48,'提示訊息視窗')          
          THISFORM.TXTF05.SETFOCUS
          RETURN
       ENDIF 
*!*	       IF EMPTY(THISFORM.TXTF12.VALUE)=.T.
*!*	          =MESSAGEBOX('回覆交期不得空白!',0+48,'提示訊息視窗')          
*!*	          THISFORM.TXTF12.SETFOCUS
*!*	          RETURN
*!*	       ENDIF
       IF THISFORM.TXTF15.VALUE < 0
          =MESSAGEBOX('回覆數量不得小於等於零!',0+48,'提示訊息視窗')          
          THISFORM.TXTF15.SETFOCUS
          RETURN
       ENDIF
       IF EMPTY(THISFORM.TXTF10.VALUE)=.T.
          =MESSAGEBOX('申請狀態不得空白!',0+48,'提示訊息視窗')          
          THISFORM.TXTF10.SETFOCUS
          RETURN
       ENDIF
       IF MESSAGEBOX('是否確定要修改此筆資料?',4+32+256,'請確認') = 6
	      P20F12 = P21_TEMP.F12
	      SELECT P21_TEMP
	      LOCK()
	      IF RLOCK()
	         SELECT P20
	         SEEK P21_TEMP.F01 + P21_TEMP.F05 + DTOS(P21_TEMP.F02)
	         IF FOUND()
		        REPLACE P20.F05 WITH THISFORM.TXTF05.VALUE
		        REPLACE P20.F10 WITH THISFORM.TXTF10.VALUE
		        REPLACE P20.F12 WITH THISFORM.TXTF12.VALUE
		        REPLACE P20.F15 WITH THISFORM.TXTF15.VALUE
		        REPLACE P20.F98 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
		     ENDIF
	         SELECT P21_TEMP
	         REPLACE P21_TEMP.F05 WITH THISFORM.TXTF05.VALUE
	         REPLACE P21_TEMP.F10 WITH THISFORM.TXTF10.VALUE
	         REPLACE P21_TEMP.F12 WITH THISFORM.TXTF12.VALUE
	         REPLACE P21_TEMP.F15 WITH THISFORM.TXTF15.VALUE
	         REPLACE P21_TEMP.F98 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
	      ELSE
	         DO FILE_IMPACT
	         UNLOCK ALL
	         RETURN
	      ENDIF 
	      IF P21_TEMP.F15 <> P21_TEMP.F06 OR P20F12 <> P21_TEMP.F12
		     WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
		     TMPCHR=IIF(OS()="Windows 5.01",CHR(13) + CHR(10),'<br/>')
			 MAIL_TEXT = '申請單號：' + P21_TEMP.F01 +TMPCHR + ;
			 			 '客戶名稱：' + P21_TEMP.C01F05 + TMPCHR + ;
			 			 '申請廠商：' + P21_TEMP.D01F04 + TMPCHR + ;
			     	     '料品編號：' + P21_TEMP.F05 + TMPCHR + ;
			     	     '需求日期：' + DTOS(P21_TEMP.F07) + TMPCHR + ;
			     	     '申請數量：' + ALLTRIM(TRANSFORM(P21_TEMP.F06,'@R 999,999')) + TMPCHR + ;
			     	     '回覆交期：' + IIF(EMPTY(P21_TEMP.F12),'尚未回覆交期',DTOS(P21_TEMP.F12)) + TMPCHR + ;
			     	     '回覆數量：' + IIF(EMPTY(P21_TEMP.F15),'尚未回覆可請數量',ALLTRIM(TRANSFORM(P21_TEMP.F15,'@R 999,999'))) + TMPCHR + ;
			     	     '修改人員：' + P21_TEMP.F98 + CHR(13) + CHR(10)
		     ****傳送MAIL給申請人
		      IF SEEK(P21_TEMP.F13,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
		         IF OS()="Windows 5.01"
		            SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已回覆交期或回覆可申請之數量、客戶：' + ALLTRIM(P21_TEMP.C01F05),'TEXT',MAIL_TEXT)      
		         ELSE
		            FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
                    STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已回覆交期或回覆可申請之數量<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)      
		         ENDIF                 
		      ENDIF
		      ****傳送MAIL給負責業務A
		      IF SEEK(P21_TEMP.F04,'C01') = .T. AND EMPTY(C01.F18) = .F. AND ALLTRIM(P21_TEMP.F13) <> ALLTRIM(C01.F18) AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
		         IF OS()="Windows 5.01"
		    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已回覆交期或回覆可申請之數量、客戶：' + ALLTRIM(P21_TEMP.C01F05),'TEXT',MAIL_TEXT)    
		    	 ELSE
		    	    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
                    STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已回覆交期或回覆可申請之數量<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)        
		    	 ENDIF               
		      ENDIF
		      ****傳送MAIL給負責業務B
		      IF SEEK(P21_TEMP.F04,'C01') = .T. AND EMPTY(C01.F33) = .F. AND ALLTRIM(P21_TEMP.F13) <> ALLTRIM(C01.F33) AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
		    	 IF OS()="Windows 5.01"
		    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已回覆交期或回覆可申請之數量、客戶：' + ALLTRIM(P21_TEMP.C01F05),'TEXT',MAIL_TEXT)   
		    	 ELSE
		    	    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
                    STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已回覆交期或回覆可申請之數量<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)                      
		         ENDIF
		      ENDIF
		      ****傳送MAIL給負責業助
		      IF SEEK(P21_TEMP.F04,'C01') = .T. AND EMPTY(C01.F23) = .F. AND ALLTRIM(P21_TEMP.F13) <> ALLTRIM(C01.F23) AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
		    	 IF OS()="Windows 5.01"
		    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已回覆交期或回覆可申請之數量、客戶：' + ALLTRIM(P21_TEMP.C01F05),'TEXT',MAIL_TEXT)   
		    	 ELSE
		    	    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(A01.F01)+'.TXT'                  
                    STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已回覆交期或回覆可申請之數量<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)                      
		         ENDIF
		      ENDIF
		      WAIT CLEAR 
	      ENDIF
       ENDIF
       THISFORM.RELEASE
       RETURN 
 ENDPROC 
 PROCEDURE CMND2.CLICK
     THISFORM.RELEASE
     RETURN 
 ENDPROC  
ENDDEFINE
***********************************************列印程序
PROCEDURE PNT_PRC  
   SELECT P21_TEMP
   ANS_RANGE=CREATEOBJECT("ANS_RANGE")  
   ANS_RANGE.SHOW   
ENDPROC
***********************************************
DEFINE CLASS ANS_RANGE AS FORM
*!*	  AUTOCENTER=.T.
  TOP=INT_015*180
  LEFT=INT_015*220   
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*145
  WIDTH=INT_015*340
  FONTSIZE=INT_015*9
  MOVABLE=.F.
  MAXBUTTON=.F.
  MINBUTTON=.F.      
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_RANGE'  
ADD OBJECT DATA_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*17,;
      TOP=INT_015*78,;
      AUTOSIZE=.T.,;
      FONTSIZE=INT_015*12,;
      BUTTONCOUNT=3,;
      OPTION1.CAPTION='列印樣品申請單',;
      OPTION1.TOP=INT_015*0,;
      OPTION1.FONTSIZE=INT_015*9,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='列印未回覆交期之樣品',;
      OPTION2.TOP=INT_015*20,;
      OPTION2.FONTSIZE=INT_015*9,;
      OPTION2.AUTOSIZE=.T.,;  
      OPTION3.CAPTION='列印需求客戶之樣品清單',;
      OPTION3.TOP=INT_015*40,;
      OPTION3.FONTSIZE=INT_015*9,;
      OPTION3.AUTOSIZE=.T.,; 
      NAME='DATA_OPTION'  
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*5,;
      TOP=INT_015*10,;
      CAPTION='申請廠商'
  ADD OBJECT LABEL11 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*115,;
      TOP=INT_015*10,;
      NAME='LABEL11'
  ADD OBJECT TEXT1 AS TEXT1 WITH;
      TOP=INT_015*6,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      MAXLENGTH=5   
  ADD OBJECT TEXT11 AS TEXT11 WITH;
      TOP=INT_015*6,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*50,;
      MAXLENGTH=5   
  ADD OBJECT LABEL2 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*5,;
      TOP=INT_015*50,;
      CAPTION='起始日期'
  ADD OBJECT TEXT2 AS TEXTBOX WITH;
      TOP=INT_015*44,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*30,;
      MAXLENGTH=2    
  ADD OBJECT LABEL3 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*130,;
      TOP=INT_015*50,;
      CAPTION='截止日期'
  ADD OBJECT TEXT3 AS TEXTBOX WITH;
      TOP=INT_015*44,;
      LEFT=INT_015*182,;
      HEIGHT=INT_015*25,; 
      WIDTH=INT_015*30,;
      MAXLENGTH=2   
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*260,;
      TOP=INT_015*20,;  
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*67,;
      CAPTION='\<Y.列    印',;
      TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'    
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*260,;
      TOP=INT_015*55,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*67,;
      CAPTION='\<E.轉EXCEL',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+E',;
      NAME='CMND2'
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      LEFT=INT_015*260,;
      TOP=INT_015*90,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*67,;
      CAPTION='\<C.取    消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND3'
  PROCEDURE INIT 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
      THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')      
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')   
      THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
      THISFORM.SETALL('MOUSEICON','BMPS\harrow.CUR','COMMANDBUTTON')
      THISFORM.TEXT11.VISIBLE = .F.
      THISFORM.TEXT1.READONLY=.F.
      THISFORM.TEXT11.READONLY=.F.
      THISFORM.TEXT1.VALUE=P21_TEMP.F03
      THISFORM.LABEL11.CAPTION=P21_TEMP.D01F04
      IF CHK_STR <> 'Y'
	     THISFORM.CAPTION='請輸入欲列印之資料範圍、資料年度/月份：' + CHK_STR
	     THISFORM.TEXT2.WIDTH=INT_015*30
	     THISFORM.TEXT3.WIDTH=INT_015*30
	     THISFORM.TEXT2.VALUE=RIGHT(DTOC(DATE()),2)
	     THISFORM.TEXT3.VALUE=RIGHT(DTOC(DATE()),2)
      ELSE
	     THISFORM.CAPTION='請輸入欲列印之資料範圍'
	     THISFORM.TEXT2.WIDTH=INT_015*65
	     THISFORM.TEXT3.WIDTH=INT_015*65
	     THISFORM.TEXT2.VALUE=DATE()
	     THISFORM.TEXT3.VALUE=DATE()
      ENDIF
      THISFORM.TEXT1.SETFOCUS
  ENDPROC
  PROCEDURE DATA_OPTION.INTERACTIVECHANGE  
  	   IF THIS.VALUE = 1 OR THIS.VALUE = 2
  	      THISFORM.TEXT1.VISIBLE = .T.
  	      THISFORM.TEXT11.VISIBLE = .F.
  	      THISFORM.LABEL1.CAPTION='申請廠商'
  	      THISFORM.LABEL11.CAPTION=P21_TEMP.D01F04
  	      THISFORM.TEXT1.VALUE=P21_TEMP.F03
  	      THISFORM.TEXT1.SETFOCUS
  	   ELSE	  
  	      THISFORM.TEXT1.VISIBLE = .F.
  	      THISFORM.TEXT11.VISIBLE = .T.
  	      THISFORM.LABEL1.CAPTION='申請客戶'
  	      THISFORM.LABEL11.CAPTION=P21_TEMP.C01F05
  	      THISFORM.TEXT11.VALUE=P21_TEMP.F04
  	      THISFORM.TEXT11.SETFOCUS
  	   ENDIF 
      IF CHK_STR <> 'Y' 
      	 IF THIS.VALUE = 1
	     	THISFORM.TEXT2.VALUE=RIGHT(DTOC(DATE()),2)
	     	THISFORM.TEXT3.VALUE=RIGHT(DTOC(DATE()),2)
	     ELSE
	      	THISFORM.TEXT2.VALUE='01'
	      	THISFORM.TEXT3.VALUE=ALLTRIM(STR(DAY_NUM(ALLTRIM(CHK_STR))))
	     ENDIF
      ELSE
	     THISFORM.TEXT2.VALUE=DATE()
	     THISFORM.TEXT3.VALUE=DATE()
      ENDIF
  ENDPROC
  PROCEDURE CMND1.CLICK  
   IF THISFORM.DATA_OPTION.VALUE = 1 OR THISFORM.DATA_OPTION.VALUE = 2
      IF SEEK(THISFORM.TEXT1.VALUE,'D01')=.F. .OR. EMPTY(THISFORM.TEXT1.VALUE)
         =MESSAGEBOX('無此廠商編號請先建立!',0+64,'提示訊息視窗')
         THISFORM.TEXT1.SETFOCUS
         RETURN
      ENDIF
   ELSE
      IF SEEK(THISFORM.TEXT11.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.TEXT11.VALUE)
         =MESSAGEBOX('無此客戶編號請先建立!',0+64,'提示訊息視窗')
         THISFORM.TEXT11.SETFOCUS
         RETURN
      ENDIF     
   ENDIF  
   IF EMPTY(CTOD(CHK_STR +'/'+THISFORM.TEXT2.VALUE)) AND CHK_STR <> 'Y'
      =MESSAGEBOX('起始日期輸入錯誤!',0+64,'提示訊息視窗') 
      THISFORM.TEXT2.SETFOCUS
      RETURN
   ENDIF  
   IF EMPTY(CTOD(CHK_STR +'/'+THISFORM.TEXT3.VALUE)) AND CHK_STR <> 'Y'
      =MESSAGEBOX('截止日期輸入錯誤!',0+64,'提示訊息視窗') 
      THISFORM.TEXT3.SETFOCUS
      RETURN 
   ENDIF 
   PD=IIF(CHK_STR <> 'Y','(' + CHK_STR + '/' + THISFORM.TEXT2.VALUE + '∼' + CHK_STR + '/' + THISFORM.TEXT3.VALUE + ')','(' + DTOC(THISFORM.TEXT2.VALUE) + '/' + DTOC(THISFORM.TEXT3.VALUE) + ')')
   DO CASE
      CASE THISFORM.DATA_OPTION.VALUE = 1
		   SELECT IIF(EMPTY(F11),1,0) AS EXP_1,P21_TEMP.* FROM P21_TEMP WHERE P21_TEMP.F03 = THISFORM.TEXT1.VALUE AND P21_TEMP.F09 = '1' AND IIF(CHK_STR <> 'Y',P21_TEMP.F02B >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02B <= THISFORM.TEXT3.VALUE,P21_TEMP.F02 >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02 <= THISFORM.TEXT3.VALUE) ORDER BY P21_TEMP.F02,P21_TEMP.F04,P21_TEMP.F05 INTO CURSOR P21_2 READWRITE
		   SELECT P21_2
		   GO TOP
		   IF _TALLY<= 0
		      =MESSAGEBOX('無此範圍資料',0+48,'警示')
		      RETURN
		      THISFORM.TEXT1.SETFOCUS
		   ELSE
		      PRN_RANGE=CREATEOBJECT("PRN_RANGE")  
		      PRN_RANGE.SHOW   
			  SELECT P21_TEMP
			  SET ORDER TO &COD
		      THISFORM.CMND3.CLICK
		   ENDIF 
      CASE THISFORM.DATA_OPTION.VALUE = 2
	       SELECT P21_TEMP.* FROM P21_TEMP WHERE P21_TEMP.F03 = THISFORM.TEXT1.VALUE AND P21_TEMP.F09<>'2' AND !EMPTY(P21_TEMP.F11) AND EMPTY(P21_TEMP.F12) AND IIF(CHK_STR <> 'Y',P21_TEMP.F02B >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02B <= THISFORM.TEXT3.VALUE,P21_TEMP.F02 >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02 <= THISFORM.TEXT3.VALUE) ORDER BY P21_TEMP.F02,P21_TEMP.F04,P21_TEMP.F05 NOWAIT
		   GO TOP
		   IF _TALLY > 0
		      REPORT FORM ALLTRIM(INT_116)+'P21B' TO PRINT PROMPT PREVIEW 
		      CLEAR
		   ELSE 
		      =MESSAGEBOX('無此範圍資料',0+48,'警示')  
		      RETURN
		      THISFORM.TEXT1.SETFOCUS
		   ENDIF
		   THISFORM.CMND3.CLICK
	  CASE THISFORM.DATA_OPTION.VALUE = 3  
	       SELECT P21_TEMP.* FROM P21_TEMP WHERE P21_TEMP.F04 = THISFORM.TEXT11.VALUE AND EMPTY(P21_TEMP.F12) = .T. AND P21_TEMP.F09 <> '2' AND IIF(CHK_STR <> 'Y',P21_TEMP.F02B >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02B <= THISFORM.TEXT3.VALUE,P21_TEMP.F02 >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02 <= THISFORM.TEXT3.VALUE) ORDER BY P21_TEMP.F01,P21_TEMP.F02,P21_TEMP.F03,P21_TEMP.F05 NOWAIT
		   GO TOP
		   IF _TALLY > 0
		      REPORT FORM ALLTRIM(INT_116)+'P21C' TO PRINT PROMPT PREVIEW 
		      CLEAR
		   ELSE 
		      =MESSAGEBOX('無此範圍資料',0+48,'警示')  
		      RETURN
		      THISFORM.TEXT11.SETFOCUS
		   ENDIF 
		   THISFORM.CMND3.CLICK     	
   ENDCASE	   
ENDPROC
  PROCEDURE CMND2.CLICK  &&轉EXCEL
   PD=IIF(CHK_STR <> 'Y','(' + CHK_STR + '/' + THISFORM.TEXT2.VALUE + '∼' + CHK_STR + '/' + THISFORM.TEXT3.VALUE + ')','(' + DTOC(THISFORM.TEXT2.VALUE) + '/' + DTOC(THISFORM.TEXT3.VALUE) + ')')
   DO CASE
      CASE THISFORM.DATA_OPTION.VALUE = 1
           FILE_NAME = 'P21樣品申請紀錄-' + ALLTRIM(THISFORM.LABEL11.CAPTION) 
		   SELECT F01 申請單號,F02 申請日期,F05 料號,F06 申請數量,F07 需求日期,F15 回覆數量,F12 回覆交期,C01F05 需求客戶,F10 申請狀態,F11 列印單號,F14 機種說明;
		   		  FROM P21_TEMP WHERE P21_TEMP.F03 = THISFORM.TEXT1.VALUE AND IIF(CHK_STR <> 'Y',P21_TEMP.F02B >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02B <= THISFORM.TEXT3.VALUE,P21_TEMP.F02 >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02 <= THISFORM.TEXT3.VALUE) ORDER BY P21_TEMP.F02,P21_TEMP.F04,P21_TEMP.F05 INTO CURSOR P21_2
      CASE THISFORM.DATA_OPTION.VALUE = 2
      	   FILE_NAME = 'P21樣品申請紀錄之未回覆交期紀錄-' + ALLTRIM(THISFORM.LABEL11.CAPTION)
		   SELECT F01 申請單號,F02 申請日期,F05 料號,F06 申請數量,F07 需求日期,F15 回覆數量,F12 回覆交期,C01F05 需求客戶,F10 申請狀態,F11 列印單號,F14 機種說明;
		   		  FROM P21_TEMP WHERE P21_TEMP.F03 = THISFORM.TEXT1.VALUE AND !EMPTY(P21_TEMP.F11) AND P21_TEMP.F09 = '1' AND IIF(CHK_STR <> 'Y',P21_TEMP.F02B >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02B <= THISFORM.TEXT3.VALUE,P21_TEMP.F02 >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02 <= THISFORM.TEXT3.VALUE) ORDER BY P21_TEMP.F02,P21_TEMP.F04,P21_TEMP.F05 INTO CURSOR P21_2
	  CASE THISFORM.DATA_OPTION.VALUE = 3  
	       FILE_NAME = 'P21樣品申請紀錄之需求客戶之樣品清單-' + ALLTRIM(THISFORM.LABEL11.CAPTION)
		   SELECT F01 申請單號,F02 申請日期,D01F04 申請廠商,F05 料號,F06 申請數量,F07 需求日期,F15 回覆數量,F12 回覆交期,F10 申請狀態,F11 列印單號,F14 機種說明;
		   		  FROM P21_TEMP WHERE P21_TEMP.F04 = THISFORM.TEXT11.VALUE  AND IIF(CHK_STR <> 'Y',P21_TEMP.F02B >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02B <= THISFORM.TEXT3.VALUE,P21_TEMP.F02 >= THISFORM.TEXT2.VALUE AND P21_TEMP.F02 <= THISFORM.TEXT3.VALUE) ORDER BY P21_TEMP.F01,P21_TEMP.F02,P21_TEMP.F03,P21_TEMP.F05 INTO CURSOR P21_2 
   ENDCASE
   SELECT P21_2	
   IF _TALLY <= 0
      =MESSAGEBOX('無此範圍資料',0+48,'警示')
      RETURN
      IF THISFORM.TEXT1.VISIBLE = .T.
		 THISFORM.TEXT1.SETFOCUS
      ELSE
         THISFORM.TEXT11.SETFOCUS
      ENDIF
   ELSE
      GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
      IF EMPTY(GCDELIMFILE)  && ESC PRESSED
         SELECT P21_2
         USE
         RETURN
         THISFORM.CMND3.CLICK
      ELSE
         ON ERROR DO FILE_IMPACT
         IF _TALLY >0
            COPY TO (GCDELIMFILE) TYPE XL5   
            =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗')
            SELECT P21_2
            USE
            THISFORM.CMND3.CLICK
         ENDIF                             
      ENDIF
   ENDIF
  THISFORM.CMND3.CLICK  
 ENDPROC
  *****
  PROCEDURE CMND3.CLICK  
      SELECT P21_TEMP 
      THISFORM.RELEASE
  ENDPROC
ENDDEFINE 
*****************************************8\***********************************************
DEFINE CLASS PRN_RANGE AS FORM
*!*	  AUTOCENTER=.T.
  FONTSIZE=INT_015*9
  TOP=INT_015*110
  LEFT=INT_015*30    
  HEIGHT=INT_015*280
  WIDTH=INT_015*740
  FONTSIZE=INT_015*9
  MOVABLE=.T.
  MAXBUTTON=.F.
  MINBUTTON=.F.      
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1  
  NAME='PRN_RANGE'
  ADD OBJECT GRID1 AS GRID WITH;       
      HIGHLIGHTROWLINEWIDTH=4,; 
      AUTOCENTER=.T.,;
      WIDTH=INT_015*740,;      
      HEIGHT=INT_015*245,;     
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,; 
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      RECORDSOURCE='P21_2',;
      COLUMNCOUNT=10,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',;      
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',; 
      COLUMN7.NAME='COLUMN7',; 
      COLUMN8.NAME='COLUMN8',;  
      COLUMN9.NAME='COLUMN9',; 
      COLUMN10.NAME='COLUMN10'   
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      LEFT=INT_015*250,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*252,;        
      WIDTH=INT_015*45,;   
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.全選',;
      TOOLTIPTEXT='全選所有資料!快速鍵->ALT+A'
      NAME='CMND3'
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      LEFT=INT_015*300,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*252,;        
      WIDTH=INT_015*45,;  
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.清除',;
      TOOLTIPTEXT='清除已全選之資料!快速鍵->ALT+C'
      NAME='CMND4'         
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*350,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*252,;        
      WIDTH=INT_015*45,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<P.列印',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+P'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*400,;
      HEIGHT=INT_015*25,;
      TOP=INT_015*252,;        
      WIDTH=INT_015*45,;   
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此畫面!快速鍵->ALT+X'
      NAME='CMND2'      
  PROCEDURE INIT 
         THISFORM.CAPTION='申請廠商：'+ P21_2.D01F04 +'   列印日期範圍：'+  PD  
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')   
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN') 
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')                           
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN7.BACKCOLOR = RGB(255,255,0)
         THISFORM.GRID1.COLUMN8.BACKCOLOR = RGB(255,255,0)
         THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(P21_2.F11),RGB(255,0,0),'')","COLUMN")
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION=''
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*20
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P21_2.EXP_1' 
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='列印狀態'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE="IIF(EMPTY(P21_2.F11),'尚未列印','已列印')"         
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='需求對象'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P21_2.C01F05'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*60
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='料   號'         
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P21_2.F05'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*190
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='申請數量'         
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P21_2.F06' 
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55    
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='需求日期'         
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P21_2.F07'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='回覆數量'         
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P21_2.F15' 
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*55    
         THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='回覆交期'         
         THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P21_2.F12'
         THISFORM.GRID1.COLUMN8.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='申請人員'         
         THISFORM.GRID1.COLUMN9.CONTROLSOURCE="IIF(SEEK(P21_2.F13,'A01'),A01.F03,'')"
         THISFORM.GRID1.COLUMN9.WIDTH=INT_015*60 
         THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='列印單號'         
         THISFORM.GRID1.COLUMN10.CONTROLSOURCE='P21_2.F11'
         THISFORM.GRID1.COLUMN10.WIDTH=INT_015*80                        
         THISFORM.GRID1.SETFOCUS                               
  ENDPROC 
  PROC GRID1.INIT      
	 THISFORM.GRID1.COLUMN1.READONLY=.F.
	 THISFORM.GRID1.COLUMN2.READONLY=.T.
	 THISFORM.GRID1.COLUMN3.READONLY=.T.
	 THISFORM.GRID1.COLUMN4.READONLY=.T.
	 THISFORM.GRID1.COLUMN5.READONLY=.T.
	 THISFORM.GRID1.COLUMN6.READONLY=.T.
	 THISFORM.GRID1.COLUMN7.READONLY=.T.
	 THISFORM.GRID1.COLUMN8.READONLY=.T.
	 THISFORM.GRID1.COLUMN9.READONLY=.T.
	 THISFORM.GRID1.COLUMN10.READONLY=.T.
	 THISFORM.GRID1.COLUMN1.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN1.AddObject("CheckBox1","CheckBox1") 
	 THISFORM.GRID1.COLUMN1.CurrentControl="CheckBox1" 
	 THISFORM.GRID1.COLUMN1.Sparse=.F.
	 THISFORM.GRID1.COLUMN1.CheckBox1.Visible=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CAPTION=''
	 THISFORM.GRID1.COLUMN1.CheckBox1.AUTOSIZE=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CENTERED=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.BACKSTYLE=0
	 THISFORM.GRID1.COLUMN1.CheckBox1.LEFT=5	 
  ENDPROC 
  *****
   PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XCOLINDEX
           THISFORM.GRID1.TOOLTIPTEXT=IIF(EMPTY(P21_2.F11),'尚未列印','已列印')
  ENDPROC 
  PROCEDURE CMND1.CLICK
	SELECT * FROM P21_2 WHERE P21_2.EXP_1 = 1 ORDER BY P21_2.C01F05,P21_2.F05 INTO CURSOR P21_3 READWRITE 
	SELECT P21_3
	IF _TALLY >0
	  PO = 'P21' + SUBSTR(ALLTRIM(CHK_STR),2,3) + RIGHT(ALLTRIM(CHK_STR),2) + RIGHT(DTOS(DATE()),2)
	  SELECT P21_TEMP.F11 FROM P21_TEMP WHERE LEFT(P21_TEMP.F11,10) = PO GROUP BY P21_TEMP.F11 ORDER BY P21_TEMP.F11 INTO CURSOR P21_1
	  SELECT P21_1
	  IF _TALLY > 0
	     SELECT  P21_1
	     GO BOTTOM
	     KP = INT(VAL(RIGHT(P21_1.F11,2))) + 1
	     PO = LEFT(P21_1.F11,10) + IIF(KP < 10, '0' + ALLTRIM(STR(KP)),ALLTRIM(STR(KP)))
	  ELSE
	     PO = 'P21' + SUBSTR(ALLTRIM(CHK_STR),2,3) + RIGHT(ALLTRIM(CHK_STR),2) + RIGHT(DTOS(DATE()),2) + '01'   
	  ENDIF 
	  SELECT  P21_1
	  USE
	  SELECT P21_3
	  GO TOP
	  DO WHILE !EOF()
         SELECT P21_TEMP
         SET ORDER TO P21_TEMP1
         SEEK P21_3.F01 + P21_3.F05 +P21_3.F03 +P21_3.F04 +P21_3.F10
         IF FOUND() AND EMPTY(P21_TEMP.F11)
            REPLACE P21_TEMP.F11 WITH PO
         ENDIF
         SELECT P20
         SET ORDER TO P201   && F01+F05+DTOS(F02)
         SEEK P21_3.F01 + P21_3.F05 + DTOS(P21_3.F02)
         IF FOUND() AND EMPTY(P20.F11)
            REPLACE P20.F11 WITH PO
         ENDIF
         IF EMPTY(P21_3.F11)
            REPLACE P21_3.F11 WITH PO
         ENDIF
         SELECT P21_3
         SKIP
	  ENDDO  
	  SELECT P21_3.F11 FROM P21_3 GROUP BY P21_3.F11 INTO CURSOR P21_PO
	  SELECT P21_PO
	  GO TOP
	  IF _TALLY > 0
	     =MESSAGEBOX('此列印作業將會預覽列印共 ' + ALLTRIM(STR(RECCOUNT('P21_PO'))) + ' 張樣品申請單',0+64,'提示訊息視窗')
	     DO WHILE !EOF()
	        SELECT P21_3.* FROM P21_3 WHERE P21_3.F11 = P21_PO.F11 ORDER BY P21_3.C01F05,P21_3.F05 NOWAIT
	        REPORT FORM ALLTRIM(INT_116)+'P21A' TO PRINT PROMPT PREVIEW 
	        CLEAR
	        SELECT P21_PO
	        SKIP
	     ENDDO 
	  ENDIF
      SELECT P21_PO
      USE  
   ELSE
      =MESSAGEBOX('請選擇欲列印之資料!',0+64,'提示訊息視窗')
      THISFORM.GRID1.SETFOCUS 
      RETURN            
   ENDIF   
   SELECT P21_3
   USE                                                                                     
   THISFORM.RELEASE 
  ENDPROC  
  PROCEDURE CMND2.CLICK   
      THISFORM.RELEASE
  ENDPROC   
 **
 PROCEDURE CMND3.CLICK     
      SELECT P21_2
      RE=RECNO('P21_2')
      GO TOP
      DO WHILE !EOF()
	     REPLACE P21_2.EXP_1 WITH 1 
	     SELECT P21_2
	     SKIP
      ENDDO
      SELECT P21_2
      GO RE  
      THISFORM.GRID1.SETFOCUS 
 ENDPROC      
  PROCEDURE CMND4.CLICK
      SELECT P21_2
      RE=RECNO('P21_2')
      GO TOP
      DO WHILE !EOF()
         REPLACE P21_2.EXP_1 WITH 0 
         SELECT P21_2
         SKIP
      ENDDO
      SELECT P21_2
      GO RE
      THISFORM.GRID1.SETFOCUS 
 ENDPROC 
ENDDEFINE 
*********     
DEFINE CLASS CheckBox1 AS CheckBox
      PROCEDURE CLICK
         SELECT P21_2
         IF THIS.VALUE=1
              REPLACE P21_2.EXP_1 WITH 1
         ELSE
              REPLACE P21_2.EXP_1 WITH 0           
         ENDIF
         THISFORM.GRID1.SETFOCUS     
      ENDPROC  
ENDDEFINE 
***************************************************特殊輸入欄位設定-----------客戶
DEFINE CLASS TEXT11 AS TEXTBOX
  READONLY=.F.
  MAXLENGTH=5
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=createobject("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=createobject("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.LABEL11.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F05,'')  
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------廠商
DEFINE CLASS TEXT1 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02    
       ENDIF          
       IF _TALLY>0
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.LABEL11.CAPTION=IIF(SEEK(THIS.VALUE,'D01'),D01.F03,'')     
  ENDPROC
ENDDEFINE
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
       ENDIF        
       IF _TALLY>0
          MTR_SEEK=createobject("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.VALUE=IIF(FLG = '0',P21_TEMP.F05,FLG )
          THIS.REFRESH
          FLG='0'     
       ENDIF          
    ENDIF  
       THISFORM.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')     
       THISFORM.LBLF051.BACKCOLOR=IIF(SEEK(THIS.VALUE,'B01'),RGB(192,192,192),RGB(255,255,0))  
  ENDPROC
ENDDEFINE