**程式名稱G12.單位成本分析表
SET EXCL OFF
CLOSE ALL
CLEAR 
QTY=0
AREA1='G13'
FLG='0'
FCH=''
CHK=''
IF !USED('A01')
    SELE 0
    USE A01
ELSE 
   SELE A01
ENDIF
SET ORDER TO A01      

IF !USED('A23')
   SELE 0
   USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'G12'   
G13='G13'+LEFT(DTOS(DATE()),6)   &&單位成本檔
IF !USED('&G13')
   SELE 0
   USE (G13) ALIA G13  
ELSE
   SELE G13
ENDIF
SET ORDER TO 1 
IF !USED('B01')
   SELECT 0
   USE B01
ELSE
   SELECT B01
ENDIF
SET ORDER TO 3      
SELECT F99,F01 FROM B01 WHERE F01 =ANY(SELECT F01 FROM G13) INTO CURSOR B01_2 ORDER BY F99
CREATE CURSOR B01_1 (F99 C(8),F01 C(43))
INDEX ON F99 TAG B01_11
SET ORDER TO 1
SET RELATION TO F01 INTO G13
SELECT B01_2
GO TOP
DO WHILE !EOF()
   SELECT B01_1
   APPEND BLANK 
   REPLACE F01 WITH B01_2.F01
   REPLACE F99 WITH B01_2.F99
   SELECT B01_2
   SKIP
ENDDO
  SELECT B01_2
  USE
SELECT G13
GO TOP
*****************
G12FORM=CREATEOBJECT("TKG12")
G12FORM.SHOW  
DEFINE CLASS TKG12 AS FORM
     CAPTION='G12.單位成本分析表'
*!*	  AUTOCENTER=.T.
     CONTROLBOX=.F.
     BORDERSTYLE=1  
     MAXBUTTON=.F.
     MINBUTTON=.F.
     MOVABLE=.F.
     CLOSABLE=.F.
     CONTROLCOUNT=57
     FONTSIZE=INT_015*9
     HEIGHT=INT_015*550
     SHOWTIPS=.T.
     SHOWWINDOW=1
     WIDTH=INT_015*789
     WINDOWTYPE=1
*!*	  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
*!*	      AUTOCENTER=.T.
*!*	  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
*!*	      AUTOCENTER=.T.
*!*	  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
*!*	      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      LEFT=INT_015*660,;
      AUTOCENTER =.T.,;
      CAPTION='資料筆數',;
      TOP=INT_015*9
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      TOP=INT_015*9
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
           AUTOCENTER=.T.,;  
          WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
            AUTOCENTER=.T.                  
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=8,;            
      RECORDSOURCE='G13',; 
      HEIGHT=INT_015*500,;     
      WIDTH=INT_015*780,;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',; 
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7' ,;     
      COLUMN8.NAME='COLUMN8'        
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;      
      TOP=INT_015*0,;
      LEFT=INT_015*435             
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*0,;
      LEFT=INT_015*220,;
      ENABLED=.T.,;
      VISIBLE=.T.  
*****************                       
PROCEDURE INIT
       SELECT G13
       GO TOP
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.
       CHK_STR=THISFORM.MTH_LIST.DISPLAYVALUE       
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*160
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*85  
       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*90         
       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*90                
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='生產品號'
	   THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='直接材料'
	   THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='直接人工'	   
  	   THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='製造費用'
  	   THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='委外工資'
  	   THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='合         計' 
  	   THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='產          量'   	   
  	   THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='平均成本'   	     	   
	   THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G13.F01'
	   THISFORM.GRID1.COLUMN2.CONTROLSOURCE='ROUND(G13.F03,2)'
	   THISFORM.GRID1.COLUMN3.CONTROLSOURCE='ROUND(G13.F04,2)'
	   THISFORM.GRID1.COLUMN4.CONTROLSOURCE='ROUND(G13.F05,2)'
	   THISFORM.GRID1.COLUMN5.CONTROLSOURCE='ROUND(G13.F06,2)'
	   THISFORM.GRID1.COLUMN6.CONTROLSOURCE='ROUND(G13.F03+G13.F04+G13.F05+G13.F06,2)'
	   THISFORM.GRID1.COLUMN7.CONTROLSOURCE='G13.F02'
	   THISFORM.GRID1.COLUMN8.CONTROLSOURCE="ROUND(IIF(G13.F02<>0,(G13.F03+G13.F04+G13.F05+G13.F06)/G13.F02,0),6)"
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID1.SETFOCUS
       JK='生產品號'
  ENDPROC     
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依生產品號排列')   
           .ADDITEM('依流水編號排列')
       ENDWITH      
  ENDPROC 
  PROCEDURE KEY_LIST.INTERACTIVECHANGE
      DO CASE
         CASE THIS.DISPLAYVALUE='依生產品號排列'
              AREA1='G13'
              SELECT G13       
              GO TOP
              THISFORM.GRID1.RECORDSOURCE='G13'
              THISFORM.GRID1.COLUMN1.WIDTH=INT_015*160
              THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
              THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
              THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75
              THISFORM.GRID1.COLUMN5.WIDTH=INT_015*85
              THISFORM.GRID1.COLUMN6.WIDTH=INT_015*85  
              THISFORM.GRID1.COLUMN7.WIDTH=INT_015*90         
              THISFORM.GRID1.COLUMN8.WIDTH=INT_015*90                
              THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='生產品號'
	          THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='直接材料'
	          THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='直接人工'	   
  	          THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='製造費用'
  	          THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='委外工資'
  	          THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='合         計' 
  	          THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='產          量'   	   
  	          THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='平均成本'   	     	   
	          THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G13.F01'
	          THISFORM.GRID1.COLUMN2.CONTROLSOURCE='ROUND(G13.F03,2)'
	          THISFORM.GRID1.COLUMN3.CONTROLSOURCE='ROUND(G13.F04,2)'
	          THISFORM.GRID1.COLUMN4.CONTROLSOURCE='ROUND(G13.F05,2)'
	          THISFORM.GRID1.COLUMN5.CONTROLSOURCE='ROUND(G13.F06,2)'
	          THISFORM.GRID1.COLUMN6.CONTROLSOURCE='ROUND(G13.F03+G13.F04+G13.F05+G13.F06,2)'
	          THISFORM.GRID1.COLUMN7.CONTROLSOURCE='G13.F02'
	          THISFORM.GRID1.COLUMN8.CONTROLSOURCE="ROUND(IIF(G13.F02<>0,(G13.F03+G13.F04+G13.F05+G13.F06)/G13.F02,0),6)"
              THISFORM.GRID1.READONLY=.T.       
              THISFORM.GRID1.SETFOCUS
              JK='生產品號'         
         CASE THIS.DISPLAYVALUE='依流水編號排列'
              AREA1='B01_1'
              SELECT B01_1
              GO TOP
              THISFORM.GRID1.RECORDSOURCE='B01_1'
              THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
              THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
              THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
              THISFORM.GRID1.COLUMN4.WIDTH=INT_015*75
              THISFORM.GRID1.COLUMN5.WIDTH=INT_015*85
              THISFORM.GRID1.COLUMN6.WIDTH=INT_015*85  
              THISFORM.GRID1.COLUMN7.WIDTH=INT_015*90         
              THISFORM.GRID1.COLUMN8.WIDTH=INT_015*90                
              THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='流水編號'
	          THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='直接材料'
	          THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='直接人工'	   
  	          THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='製造費用'
  	          THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='委外工資'
  	          THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='合         計' 
  	          THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='產          量'   	   
  	          THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='平均成本'   	     	   
	          THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B01_1.F99'
	          THISFORM.GRID1.COLUMN2.CONTROLSOURCE='ROUND(G13.F03,2)'
	          THISFORM.GRID1.COLUMN3.CONTROLSOURCE='ROUND(G13.F04,2)'
	          THISFORM.GRID1.COLUMN4.CONTROLSOURCE='ROUND(G13.F05,2)'
	          THISFORM.GRID1.COLUMN5.CONTROLSOURCE='ROUND(G13.F06,2)'
	          THISFORM.GRID1.COLUMN6.CONTROLSOURCE='ROUND(G13.F03+G13.F04+G13.F05+G13.F06,2)'
	          THISFORM.GRID1.COLUMN7.CONTROLSOURCE='G13.F02'
	          THISFORM.GRID1.COLUMN8.CONTROLSOURCE="ROUND(IIF(G13.F02<>0,(G13.F03+G13.F04+G13.F05+G13.F06)/G13.F02,0),6)"
              THISFORM.GRID1.READONLY=.T.       
              THISFORM.GRID1.SETFOCUS
              JK='流水編號'                       
               
      ENDCASE
        THISFORM.GRID1.SETFOCUS                           
	   THISFORM.REFRESH
	   thisform.grid1.setfocus           
  ENDPROC
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       CHK_STR=THISFORM.MTH_LIST.DISPLAYVALUE       
       SELECT B01_1
       SET RELATION OFF INTO G13
       USE
       SELECT G13
       USE
       G13='G13'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&G13')
          SELE 0
          USE (G13) ALIA G13
       ELSE
          SELE G13
       ENDIF
       SET ORDER TO 1      
       SELECT F99,F01 FROM B01 WHERE F01 =ANY(SELECT F01 FROM G13) INTO CURSOR B01_2 ORDER BY F99
       CREATE CURSOR B01_1 (F99 C(8),F01 C(43))
       INDEX ON F99 TAG B01_11
       SET ORDER TO 1
       SET RELATION TO F01 INTO G13
       SELECT B01_2
       GO TOP
       DO WHILE !EOF()
          SELECT B01_1
          APPEND BLANK 
          REPLACE F01 WITH B01_2.F01
          REPLACE F99 WITH B01_2.F99
          SELECT B01_2
          SKIP
       ENDDO
       SELECT B01_2
       USE       

           THISFORM.KEY_LIST.INTERACTIVECHANGE
  ENDPROC     
*********************************                  
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.REC_COUNT.CAPTION=STR(RECCOUNT('G13'))
       FCH=THISFORM.ACTIVECONTROL.NAME
       CHK=''
       THISFORM.REFRESH
  ENDPROC       
ENDDEFINE        
***********************************************列印程序
PROCEDURE PNT_PRC  
   FLG='0'
   SELE G13
   ANS_RANGE=CREATEOBJECT("ANS_RANGE")  
   ANS_RANGE.SHOW    
   IF FLG<>'1'
       =MESSAGEBOX('無此範圍資料',0+48,'警示')
   ENDIF   
   FLG='0'     
ENDPROC
***********************************************列印範圍選定
DEFINE CLASS ANS_RANGE AS FORM
  AUTOCENTER=.T.
  CAPTION='請輸入列印資料範圍'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*190
  WIDTH=INT_015*480
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_RANGE'
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*75,;
      NAME='LABEL1'
  ADD OBJECT LABEL2 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*250,;
      TOP=INT_015*75,;
      NAME='LABEL2'
  ADD OBJECT TEXT1 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*70,;
      LEFT=INT_015*80,;
      HEIGHT=INT_015*25,; 
      NAME='TEXT1'
  ADD OBJECT TEXT2 AS TEXTBOX WITH;
      AUTOSIZE=.T.,;
      TOP=INT_015*70,;
      LEFT=INT_015*300,;
      HEIGHT=INT_015*25,;         
      NAME='TEXT2'    
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*120,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*144,;  
      WIDTH=INT_015*80,;
      CAPTION='\<Y.執行',;
      TOOLTIPTEXT='確認所輸入的範圍鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*260,;
      TOP=INT_015*144,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'
 PROCEDURE INIT 
      THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
      THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')      
      THISFORM.SETALL('FONTSIZE',INT_015*9,'COMMANDBUTTON')            


              THISFORM.LABEL1.CAPTION='起始'+IIF(AREA1='G13','料號','編號')
              THISFORM.LABEL2.CAPTION='截止'+IIF(AREA1='G13','料號','編號')
              THISFORM.LABEL1.LEFT=INT_015*30
              THISFORM.LABEL2.LEFT=INT_015*30
              THISFORM.LABEL1.TOP=INT_015*35
              THISFORM.LABEL2.TOP=INT_015*90
              THISFORM.TEXT1.WIDTH=INT_015*IIF(AREA1='G13',261,90)
              THISFORM.TEXT2.WIDTH=INT_015*IIF(AREA1='G13',261,90)
              THISFORM.TEXT1.LEFT=INT_015*80
              THISFORM.TEXT2.LEFT=INT_015*80
              THISFORM.TEXT1.TOP=INT_015*30
              THISFORM.TEXT2.TOP=INT_015*85
              THISFORM.TEXT1.MAXLENGTH=IIF(AREA1='G13',43,8)            
              THISFORM.TEXT2.MAXLENGTH=IIF(AREA1='G13',43,8)                              
              THISFORM.TEXT1.VALUE=IIF(AREA1='G13',G13.F01,B01_1.F99)
              THISFORM.TEXT2.VALUE=IIF(AREA1='G13',G13.F01,B01_1.F99)            

  ENDPROC
  ***********
 PROCEDURE CMND1.CLICK 
           IF AREA1='G13'
             SELECT G13.*  FROM G13  WHERE G13.F01>=THISFORM.TEXT1.VALUE AND G13.F01<=THISFORM.TEXT2.VALUE  ORDER BY G13.F01 NOWAIT
           ELSE
             SELECT B01_1.F99,G13.* FROM B01_1,G13 WHERE B01_1.F99>=THISFORM.TEXT1.VALUE AND B01_1.F99<=THISFORM.TEXT2.VALUE  AND G13.F01=B01_1.F01 ORDER BY B01_1.F99 NOWAIT
           ENDIF  
           IF _TALLY >0              
              REPORT FORM ALLTRIM(INT_116)+'G12' TO PRINT PROMPT PREVIEW      
              FLG='1'
           ENDIF

       THISFORM.RELEASE                         
  ENDPROC
***********************  
PROCEDURE CMND2.CLICK
  THISFORM.RELEASE
   FLG='1'
ENDPROC 
ENDDEFINE  