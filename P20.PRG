***程式名稱:P20.樣品申請單
close all
clear 
FLG='0'
FCH=''
CHK=''
HK=''
R=0
CNL = ''
HD1='P020 '
HD2='PZ'
HD3='樣品申請單'
AREA1='P20_1'
AREA2='P20'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1   
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1    
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1      
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'P20'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET ORDER TO A141   
IF !USED('C01')
   SELE 0
   USE C01
ELSE 
   SELE C01
ENDIF
SET ORDER TO C011      
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO B011  
IF !USED('D01')
   SELE 0
   USE D01
ELSE 
   SELE D01
ENDIF
SET ORDER TO D011
IF !USED('P20')         &&樣品申請紀錄
   SELE 0
   USE P20
ELSE
   SELE P20
ENDIF
SET ORDER TO P201     
CREATE CURSOR P20_1;
(F01 C(10),F02 D(8),F03 C(5),F031 C(8),F04 C(5),F041 C(8),F07 D(8),F08 C(80),F09 C(1),F13 C(5),F131 C(8))
INDE ON F01+DTOS(F02) TAG P20_11
INDE ON F03+DTOS(F02) TAG P20_12
INDE ON F04+DTOS(F02) TAG P20_13
SET ORDER TO P20_11
SELECT P20.* FROM P20 WHERE LEFT(DTOS(P20.F02),6) = LEFT(DTOS(DATE()),6) GROUP BY P20.F01 ORDER BY P20.F01 INTO CURSOR P20_2
SELECT P20_2
GO TOP
DO WHILE !EOF()
   SELECT P20_1
   APPEND BLANK
   REPLACE P20_1.F01 WITH P20_2.F01
   REPLACE P20_1.F02 WITH P20_2.F02
   REPLACE P20_1.F03 WITH P20_2.F03
   REPLACE P20_1.F031 WITH IIF(SEEK(P20_2.F03,'D01'),D01.F04,'')
   REPLACE P20_1.F04 WITH P20_2.F04
   REPLACE P20_1.F041 WITH IIF(SEEK(P20_2.F04,'C01'),C01.F05,'')
   REPLACE P20_1.F07 WITH P20_2.F07
   REPLACE P20_1.F08 WITH P20_2.F08
   REPLACE P20_1.F09 WITH 'Y'
   REPLACE P20_1.F13 WITH P20_2.F13
   REPLACE P20_1.F131 WITH IIF(SEEK(P20_2.F13,'A01'),A01.F03,'')
   SELECT P20_2
   SKIP
ENDDO
SELECT P20.F01 FROM P20 WHERE EMPTY(P20.F09) AND LEFT(DTOS(P20.F02),6) = LEFT(DTOS(DATE()),6) GROUP BY P20.F01,P20.F09 ORDER BY P20.F01,P20.F09 INTO CURSOR P20_2
SELECT P20_2
GO TOP
DO WHILE !EOF()
   SELECT P20_1
   SEEK P20_2.F01
   IF FOUND()
   	  REPLACE P20_1.F09 WITH ''
   ENDIF
   SELECT P20_2
   SKIP
ENDDO
SELECT P20_2
USE
SELECT P20_1
GO BOTTOM 
P20FORM=CREATEOBJECT("TKP20")
P20FORM.SHOW  
DEFINE CLASS TKP20 AS FORM
  CAPTION='P20.樣品申請單'
  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=3  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKP20'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=5,;            
      RECORDSOURCE='P20_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;  
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;    
      COLUMN5.NAME='COLUMN5'     
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=4,;            
      RECORDSOURCE='P20',; 
      LINKMASTER='P20_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER='P201',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*558           
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*14,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*42,;
      CAPTION='\<A.確認',;
      NAME='ANS_BOTT'                  
  ADD OBJECT CNL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*42,;
      CAPTION='\<B.取消',;
      NAME='CNL_BOTT'
  ADD OBJECT MAIL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*100,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*55,;
      CAPTION='\<M.轉MAIL',;
      NAME='MAIL_BOTT'         
 ADD OBJECT INV_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*157,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*65,;
      CAPTION='\<V.庫存明細',;
      NAME='INV_BOTT'
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='申請單號'          
     ENDWITH   
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH         
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*318
         .TOP=INT_015*13
         .WIDTH=INT_015*75
         .CAPTION='申請日期'
     ENDWITH    
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*370
          .TOP=INT_015*9
          .WIDTH=INT_015*30
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH  
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*43
          .WIDTH=INT_015*50
          .CAPTION='申請廠商'          
     ENDWITH   
     THIS.ADDOBJECT('TXTF03','TXTF03')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*39
          .WIDTH=INT_015*55
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH
     THIS.ADDOBJECT('LBLF031','LABEL')
     WITH THIS.LBLF031
          .VISIBLE=.T.
          .LEFT=INT_015*125
          .TOP=INT_015*43
          .WIDTH=INT_015*50
          .CAPTION=''          
     ENDWITH  
     THIS.ADDOBJECT('LBLF13','LABEL')
     WITH THIS.LBLF13
          .VISIBLE=.T.
          .LEFT=INT_015*318
          .TOP=INT_015*43
          .WIDTH=INT_015*50
          .CAPTION='申請人員'          
     ENDWITH   
     THIS.ADDOBJECT('TXTF13','TXTF03')          
     WITH THIS.TXTF13
          .VISIBLE=.T.
          .LEFT=INT_015*370
          .TOP=INT_015*39
          .WIDTH=INT_015*55
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH
     THIS.ADDOBJECT('LBLF131','LABEL')
     WITH THIS.LBLF131
          .VISIBLE=.T.
          .LEFT=INT_015*425
          .TOP=INT_015*43
          .WIDTH=INT_015*100
          .CAPTION=''          
     ENDWITH  
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*73
          .WIDTH=INT_015*50
          .CAPTION='需求對象'          
     ENDWITH   
     THIS.ADDOBJECT('TXTF04','TXTF04')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*69
          .WIDTH=INT_015*55
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH
     THIS.ADDOBJECT('LBLF041','LABEL')
     WITH THIS.LBLF041
          .VISIBLE=.T.
          .LEFT=INT_015*125
          .TOP=INT_015*73
          .WIDTH=INT_015*100
          .CAPTION=''          
     ENDWITH 
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*103
          .WIDTH=INT_015*50
          .CAPTION='需求日期'          
     ENDWITH   
     THIS.ADDOBJECT('TXTF07','TEXTBOX')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*99
          .WIDTH=INT_015*75
          .HEIGHT=INT_015*25
     ENDWITH
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*133
          .WIDTH=INT_015*50
          .CAPTION='申請說明'          
     ENDWITH   
     THIS.ADDOBJECT('TXTF08','TEXTBOX')          
     WITH THIS.TXTF08
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*129
          .WIDTH=INT_015*250
          .HEIGHT=INT_015*25
          .MAXLENGTH=80
     ENDWITH  
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF05','LABEL')
	WITH THIS.LBLF05  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF051','LABEL')
    WITH THIS.LBLF051
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*18
	     .AUTOSIZE=.T.
	ENDWITH  
	THIS.ADDOBJECT('TXTF05','TXTF05')
	WITH THIS.TXTF05      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF05'  
	ENDWITH  
     THIS.ADDOBJECT('LBLF06','LABEL')     
     WITH THIS.LBLF06
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*44
          .WIDTH=INT_015*50  
          .CAPTION='申請數量'
     ENDWITH    
    THIS.ADDOBJECT('TXTF06','TEXTBOX')          
     WITH THIS.TXTF06
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*40
          .WIDTH=INT_015*50
          .HEIGHT=INT_015*25
          .INPUTMASK='999999'
          .MAXLENGTH=6
     ENDWITH
     THIS.ADDOBJECT('LBLF15','LABEL')     
     WITH THIS.LBLF15
          .VISIBLE=.T.
          .LEFT=INT_015*125
          .TOP=INT_015*44
          .WIDTH=INT_015*50  
          .CAPTION='回覆數量'
     ENDWITH 
     THIS.ADDOBJECT('LBLF151','LABEL')     
     WITH THIS.LBLF151
          .VISIBLE=.T.
          .LEFT=INT_015*233
          .TOP=INT_015*44
          .AUTOSIZE=.T. 
          .BACKCOLOR=RGB(255,255,0)
          .CAPTION=''
     ENDWITH   
    THIS.ADDOBJECT('TXTF15','TEXTBOX')          
     WITH THIS.TXTF15
          .VISIBLE=.T.
          .LEFT=INT_015*178
          .TOP=INT_015*40
          .WIDTH=INT_015*50
          .HEIGHT=INT_015*25
          .INPUTMASK='999999'
          .MAXLENGTH=6
     ENDWITH       
     THIS.ADDOBJECT('LBLF14','LABEL')     
     WITH THIS.LBLF14
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*71
          .WIDTH=INT_015*50  
          .CAPTION='機種說明'
     ENDWITH    
    THIS.ADDOBJECT('TXTF14','TEXTBOX')          
     WITH THIS.TXTF14
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*67
          .WIDTH=INT_015*261
          .HEIGHT=INT_015*25
          .MAXLENGTH=50
     ENDWITH  
     THIS.ADDOBJECT('LBLF10','LABEL')     
     WITH THIS.LBLF10
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*97
          .WIDTH=INT_015*50  
          .CAPTION='申請狀態'
     ENDWITH  
    THIS.ADDOBJECT('TXTF10','TEXTBOX')          
     WITH THIS.TXTF10
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*93
          .WIDTH=INT_015*261
          .HEIGHT=INT_015*25
          .MAXLENGTH=50
     ENDWITH 
    THIS.ADDOBJECT('LBLF98','LABEL')
    WITH THIS.LBLF98
        .VISIBLE=.T.           
        .LEFT=INT_015*14
        .TOP=INT_015*128
        .WIDTH=INT_015*50
        .CAPTION='確認人員'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF981','LABEL')
    WITH THIS.LBLF981
        .VISIBLE=.T.           
        .LEFT=INT_015*65
        .TOP=INT_015*128
        .AUTOSIZE=.T.
    ENDWITH       
    THIS.ADDOBJECT('LBLF99','LABEL')
    WITH THIS.LBLF99
        .VISIBLE=.T.           
        .LEFT=INT_015*14
        .TOP=INT_015*150
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF991','LABEL')
    WITH THIS.LBLF991
        .VISIBLE=.T.           
        .LEFT=INT_015*65
        .TOP=INT_015*150
        .AUTOSIZE=.T.
    ENDWITH      
  ENDPROC   
  PROC INIT       
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')     
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')         
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10  
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       HK = ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE) 
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(P20_1.F09 <> 'Y',RGB(255,0,0),'')","COLUMN") 
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","ICASE(EMPTY(P20.F09),RGB(255,255,0),P20.F09 = '2',RGB(255,0,0),'')","COLUMN")  
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='申請廠商'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商名稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='需求對象'
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='對象名稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P20_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P20_1.F03'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P20_1.F031'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P20_1.F04'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P20_1.F041'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55       
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'       
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='品名規格'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='申請數量'
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='回覆數量'
	   THISFORM.GRID2.LINKMASTER='P20_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P20.F05'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(SEEK(ALLTRIM(P20.F05),'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P20.F06'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P20.F15'
	   THISFORM.GRID2.COLUMN1.WIDTH=INT_015*200
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*200
	   THISFORM.GRID2.COLUMN3.WIDTH=INT_015*55
	   THISFORM.GRID2.COLUMN4.WIDTH=INT_015*55
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       THISFORM.REFRESH
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
          THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.MAIL_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
          THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.     
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND EMPTY(P20_1.F09) &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
          THISFORM.MAIL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)                 
       ENDIF        
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
       THISFORM.ANS_BOTT.ENABLED= .F. 
       THISFORM.CNL_BOTT.ENABLED= .F. 
       THISFORM.INV_BOTT.ENABLED=.F.
       THISFORM.KEY_LIST.DISPLAYVALUE='依申請單號排列'      
       JK='申請單號'
       SELE P20_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P20_1.F01
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE P20_1
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.CNL_BOTT.ENABLED=.F.
     THISFORM.INV_BOTT.ENABLED=.F.
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS   
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF                
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.        
        THISFORM.MAIL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE='' 
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE='' 
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''  
        THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=''      
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''           
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND EMPTY(P20_1.F09) &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&判斷有無列印的權限  
        THISFORM.MAIL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.) 
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF 
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
     SELE P20
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF   
     IF THISFORM.GRID2.ACTIVEROW=0 AND thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
        THISFORM.INV_BOTT.ENABLED=.F.
        THISFORM.MAIL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.CNL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF981.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF991.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無新增的權限
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20.F09)   &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.) AND EMPTY(P20.F09)  &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限 
        THISFORM.INV_BOTT.ENABLED=IIF(SEEK(P20.F05,'B01'),.T.,.F.)
        THISFORM.MAIL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  
        THISFORM.ANS_BOTT.ENABLED= EMPTY(P20.F09) OR P20.F09 = '2' AND IIF(A02.F08='*',.T.,.F.)
        THISFORM.CNL_BOTT.ENABLED= EMPTY(P20.F09) OR P20.F09 = '1' AND IIF(A02.F09='*',.T.,.F.)
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
  ENDPROC                    
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依申請單號排列')
           .ADDITEM('依申請廠商排列')
           .ADDITEM('依需求對象排列')
           .VALUE=1
       ENDWITH             
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE P20_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依申請單號排列'
               SET ORDER TO P20_11 
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商名稱'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='需求對象'
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='對象名稱'
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P20_1.F01'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P20_1.F03'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P20_1.F031'
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P20_1.F04'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P20_1.F041'
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*50
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55                                              
          CASE THIS.DISPLAYVALUE='依申請廠商排列'
               SET ORDER TO P20_12
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商名稱'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='需求對象'
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='對象名稱'
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P20_1.F03'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P20_1.F031'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P20_1.F01'
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P20_1.F04'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P20_1.F041'
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55
          CASE THIS.DISPLAYVALUE='依需求對象排列'
               SET ORDER TO P20_13
		       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='需求對象'
		       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象名稱'
		       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='申請單號'
		       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='申請廠商'
		       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='廠商名稱'
		       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P20_1.F04'
		       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P20_1.F041'
		       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P20_1.F01'
		       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P20_1.F03'
		       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P20_1.F031'
		       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*50
		       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55 
		       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81
		       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
		       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*55
       ENDCASE 
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       HK = ALLTRIM(THIS.DISPLAYVALUE) 
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.CHILDORDER=''
       SELE A24
       USE
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1             
       SELECT P20_1
       USE
		CREATE CURSOR P20_1;
		(F01 C(10),F02 D(8),F03 C(5),F031 C(8),F04 C(5),F041 C(8),F07 D(8),F08 C(80),F09 C(1),F13 C(5),F131 C(8))
		INDE ON F01+DTOS(F02) TAG P20_11
		INDE ON F03+DTOS(F02) TAG P20_12
		INDE ON F04+DTOS(F02) TAG P20_13
		SET ORDER TO P20_11  
		SELECT P20.* FROM P20 WHERE LEFT(DTOS(P20.F02),6) = LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6) GROUP BY P20.F01 ORDER BY P20.F01 INTO CURSOR P20_2
		SELECT P20_2
		GO TOP
		DO WHILE !EOF()
		   SELECT P20_1
		   APPEND BLANK
		   REPLACE P20_1.F01 WITH P20_2.F01
		   REPLACE P20_1.F02 WITH P20_2.F02
		   REPLACE P20_1.F03 WITH P20_2.F03
		   REPLACE P20_1.F031 WITH IIF(SEEK(P20_2.F03,'D01'),D01.F04,'')
		   REPLACE P20_1.F04 WITH P20_2.F04
		   REPLACE P20_1.F041 WITH IIF(SEEK(P20_2.F04,'C01'),C01.F05,'')
		   REPLACE P20_1.F07 WITH P20_2.F07
		   REPLACE P20_1.F08 WITH P20_2.F08
		   REPLACE P20_1.F09 WITH 'Y'
		   REPLACE P20_1.F13 WITH P20_2.F13
   		   REPLACE P20_1.F131 WITH IIF(SEEK(P20_2.F13,'A01'),A01.F03,'')
		   SELECT P20_2
		   SKIP
		ENDDO
		SELECT P20.F01 FROM P20 WHERE EMPTY(P20.F09) AND LEFT(DTOS(P20.F02),6) = LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6) GROUP BY P20.F01,P20.F09 ORDER BY P20.F01,P20.F09 INTO CURSOR P20_2
		SELECT P20_2
		GO TOP
		DO WHILE !EOF()
		   SELECT P20_1
		   SEEK P20_2.F01
		   IF FOUND()
		   	  REPLACE P20_1.F09 WITH ''
		   ENDIF
		   SELECT P20_2
		   SKIP
		ENDDO
	   SELECT P20_2
	   USE
	   SELECT P20_1    
	   GO BOTTOM     
       THISFORM.GRID1.RECORDSOURCE='P20_1'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P20_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P20_1.F03'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P20_1.F031'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P20_1.F04'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P20_1.F041'     
       THISFORM.GRID2.RECORDSOURCE='P20'
	   THISFORM.GRID2.LINKMASTER='P20_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER='P201'  
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P20.F05'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(SEEK(ALLTRIM(P20.F05),'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')"
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P20.F06'       
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P20.F15'
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   THISFORM.GRID1.SETFOCUS        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.MAIL_BOTT.ENABLED=.F.
          THISFORM.INV_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
          THISFORM.MAIL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  
          THISFORM.INV_BOTT.ENABLED=.T.  
       ENDIF  
       THISFORM.ANS_BOTT.ENABLED=.F.
       THISFORM.CNL_BOTT.ENABLED=.F.        
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
   ENDPROC
  PROCEDURE GRID1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       SELECT P20_1
       THISFORM.GRID1.TOOLTIPTEXT=IIF(P20_1.F09 <> 'Y','尚有料品未進行確認/取消之作業','')
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(P20_1.F09 <> 'Y',RGB(255,0,0),'')","COLUMN") 
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P20_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOC(P20_1.F02),2)
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=P20_1.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=P20_1.F031
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=P20_1.F04
       THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=P20_1.F041
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=P20_1.F07
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=P20_1.F08
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=P20_1.F13
       THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=P20_1.F131
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
          THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
          THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.       
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
	       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
	       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''
	       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''
       ELSE
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
          THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
          THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.       
    	  THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND EMPTY(P20_1.F09) &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)
          THISFORM.MAIL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)
       ENDIF
       THISFORM.INV_BOTT.ENABLED=.F. 
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
       THISFORM.ANS_BOTT.ENABLED= .F. 
       THISFORM.CNL_BOTT.ENABLED= .F.  
       CHK=''     
*       THISFORM.REFRESH
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       SELECT P20
       THISFORM.GRID2.TOOLTIPTEXT=ICASE(P20.F09 = '1','採購已確認此料品之申請',P20.F09 = '2','採購取消此料品之申請','採購尚未確認/取消作業')
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=P20.F05
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(P20.F05,'B01'),B01.F02,'此料號未建立於B01.基本料號主檔中')
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.BACKCOLOR=IIF(SEEK(P20.F05,'B01'),RGB(192,192,192),RGB(255,255,0))
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=P20.F06  
       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=IIF(EMPTY(P20.F09),'採購尚未確認/取消作業',P20.F10)
       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=P20.F14
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=P20.F15
       THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=IIF(P20.F09 = '1' AND P20.F15 = 0,'尚未回覆可申請之數量','')
       THISFORM.PAGEFRAME1.PAGE2.LBLF98.CAPTION=ICASE(P20.F09 = '1','確認人員',P20.F09 = '2','取消人員','')
       THISFORM.PAGEFRAME1.PAGE2.LBLF981.CAPTION=P20.F98
       THISFORM.PAGEFRAME1.PAGE2.LBLF991.CAPTION=P20.F99
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","ICASE(P20.F09 = '1',10009146,P20.F09 = '2',RGB(255,0,0),RGB(255,255,0))","COLUMN")  
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無新增的權限
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20.F09) &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.) AND EMPTY(P20.F09)  &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED= EMPTY(P20.F09) OR P20.F09 = '2' AND IIF(A02.F08='*',.T.,.F.) AND THISFORM.PAGEFRAME1.ACTIVEPAGE = 2
       THISFORM.CNL_BOTT.ENABLED= EMPTY(P20.F09) OR P20.F09 = '1' AND IIF(A02.F09='*',.T.,.F.) AND THISFORM.PAGEFRAME1.ACTIVEPAGE = 2
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)
       THISFORM.MAIL_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)
       THISFORM.INV_BOTT.ENABLED=IIF(SEEK(P20.F05,'B01'),.T.,.F.)
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
       ENDIF   
       IF THIS.ACTIVEROW=0
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''
	       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE='' 
	       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE='' 
	       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=''
	       THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''
	       THISFORM.PAGEFRAME1.PAGE2.LBLF981.CAPTION=''
	       THISFORM.PAGEFRAME1.PAGE2.LBLF991.CAPTION=''
       ENDIF
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=P20_1.F01
*       THISFORM.REFRESH
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.CNL_BOTT.ENABLED=.F.
    THISFORM.MAIL_BOTT.ENABLED=.F.
    THISFORM.INV_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
       HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
       DO ODR_CRT
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.  
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.READONLY=.T.
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOC(DATE()),2)
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=INT_117  
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''  
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=DATE()
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''  
       THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE=SYS_OPER          
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(SEEK(INT_117,'D01'),D01.F04,'')        
       THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''
       THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=IIF(SEEK(SYS_OPER,'A01'),A01.F03,'')
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS   
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.F.   
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF14.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.READONLY=IIF(IIF(A02.F08='*',.T.,.F.) AND IIF(A02.F09='*',.T.,.F.),.F.,.T.)
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=''                 
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF981.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE2.LBLF991.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS           
     ENDIF   
  ENDPROC
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='P20'
       THISFORM.GRID2.CHILDORDER='P201'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P20.F05'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(SEEK(ALLTRIM(P20.F05),'B01'),B01.F02,'')"
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P20.F06'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P20.F15'
       SELE P20_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'P20_1')=.T.     &&如果單據編號重複 
          SELECT MAX(F01) FROM P20 INTO ARRAY GB NOWAIT
          HD=HD1+SUBSTR(DTOS(DATE()),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          DO ODR_RPT
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
	      THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH	           
       ENDIF
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('申請日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF  
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'D01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('無此廠商編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
          =MESSAGEBOX('無此客戶編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF  
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE) = .T.
          =MESSAGEBOX('需求日期不得空白!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       SELE P20_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F031 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'D01'),D01.F04,'')
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          REPLACE F041 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'C01'),C01.F05,'')
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
          REPLACE F131 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE,'A01'),A01.F03,'')
       ENDIF   
       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE
*!*	       IF SEEK(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE),'B01')=.F.
*!*	          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
*!*	          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
*!*	          RETURN
*!*	       ENDIF  
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)=.T.
          =MESSAGEBOX('料號不得空白!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
          RETURN
       ENDIF 
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)),'P20')=.T.           
          =MESSAGEBOX('此料號在此張領用單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
          RETURN            
       ENDIF  
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE <= 0
          =MESSAGEBOX('申請樣品數量不得小於等於零!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
          RETURN
       ENDIF 
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE)
          =MESSAGEBOX('機種說明不得為空白!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF14.SETFOCUS
          RETURN
       ENDIF 
       SELE P20
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          REPLACE F05 WITH ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF13.VALUE
          REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
          REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE
          REPLACE F99 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF
       UNLOCK ALL         
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
       THISFORM.GRID2.ENABLED=.T.
       THISFORM.GRID2.SETFOCUS  
       THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
  ENDPROC   
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.CNL_BOTT.ENABLED=.F.
     THISFORM.MAIL_BOTT.ENABLED=.F.
     THISFORM.INV_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1   &&處理表頭修改
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F. 
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF13.READONLY=.T.
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS 
     ELSE                         
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY= IIF(IIF(A02.F08='*',.T.,.F.) AND IIF(A02.F09='*',.T.,.F.),.F.,.T.) AND !EMPTY(P20.F09)
        THISFORM.PAGEFRAME1.PAGE2.TXTF15.READONLY= IIF(IIF(A02.F08='*',.T.,.F.) AND IIF(A02.F09='*',.T.,.F.),.F.,.T.) 
        THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
        SELECT P20                                                      &&處理表身修改
        IF !RLOCK('P20') 
           DO FILE_IMPACT 
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       ENDIF        
     ENDIF   
  ENDPROC    
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('申請日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS       
          RETURN
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'D01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('無此廠商編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          RETURN            
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'C01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
          =MESSAGEBOX('無此客戶編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
          RETURN            
       ENDIF  
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE) = .T.
          =MESSAGEBOX('需求日期不得空白!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          RETURN            
       ENDIF
       SELE P20
       SEEK P20_1.F01
       IF FOUND()
          DO WHILE F01=P20_1.F01
	          REPLACE F02 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
	          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
	          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
	          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
	          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
             SKIP
          ENDDO    
       ENDIF        
      SELE P20_1
      REPLACE F02 WITH CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
      REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
      REPLACE F031 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'D01'),D01.F04,'')
      REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
      REPLACE F041 WITH IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'C01'),C01.F05,'')
      REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
      REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
    ELSE                                                        &&表身修改確認     
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE <= 0
          =MESSAGEBOX('申請樣品數量不得小於等於零!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF06.SETFOCUS
          RETURN
       ENDIF  
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE) AND CNL <> '1'
          =MESSAGEBOX('機種說明不得為空白!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF14.SETFOCUS
          RETURN
       ENDIF             
       SELE P20                   
       REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE
       REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
       IF A02.F08 = '*' AND A02.F09 = '*'
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
          REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE
       ENDIF
       REPLACE F99 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                      
    ENDIF
    UNLOCK ALL
    ***取消申請
    IF CNL = '1' AND THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE)          
          =MESSAGEBOX('取消申請之狀態說明不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS       
          RETURN
       ENDIF 
       IF MESSAGEBOX('是否要取消此筆資料?',4+32+256,'請確認') = 6
          MAIL_TEXT = ''
          SELECT P20
          LOCK()
          IF RLOCK()
             REPLACE P20.F09 WITH '2'
             REPLACE P20.F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
             REPLACE P20.F15 WITH 0
             REPLACE P20.F98 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')  
             THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''
          ELSE
             DO FILE_IMPACT
             UNLOCK ALL
             RETURN
          ENDIF 
          UNLOCK ALL
          SELECT RECNO() FROM P20 WHERE P20.F01 = P20_1.F01 AND P20.F09 = '2' INTO ARRAY BK1 
          IF _TALLY>0 
             REPLACE P20_1.F09 WITH ''
          ELSE
             REPLACE P20_1.F09 WITH 'Y'   
	      ENDIF
	      TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
	      WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
	      MAIL_TEXT = '客戶名稱：' + P20_1.F041 + TMPCHR + ;
	     	          '申請單號：' + P20_1.F01 + TMPCHR + ;
	     	          '料品編號：' + P20.F05 + TMPCHR + ;
	     	          '取消數量：' + ALLTRIM(TRANSFORM(P20.F06,'@R 999,999')) + TMPCHR + ;
	     	          '取消原因：' + P20.F10 + TMPCHR + ;
	     	          '取消人員：' + P20.F98
	      ****傳送MAIL給申請人
	      IF SEEK(P20_1.F13,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
	         APPL_NO=A01.F01
	         IF OS()="Windows 5.01"
	    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消','TEXT',MAIL_TEXT)                    
	         ELSE
	            IF !EMPTY(ALLTRIM(APPL_NO))
                   FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(APPL_NO)+'.TXT'                  
                   STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消'+'<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                ENDIF   
	         ENDIF
	      ELSE
	         APPL_NO=''   
	      ENDIF
	      ****傳送MAIL給負責業助
	      IF SEEK(P20_1.F04,'C01') = .T. AND EMPTY(C01.F23) = .F. AND ALLTRIM(P20_1.F13) <> ALLTRIM(C01.F23) AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
	         ASSIS_NO=A01.F01
	         IF ASSIS_NO<>APPL_NO
	    	    IF OS()="Windows 5.01"
	    	       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消','TEXT',MAIL_TEXT)                    
	            ELSE
	               IF !EMPTY(ALLTRIM(ASSIS_NO))
                      FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                      STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消'+'<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                   ENDIF   
	            ENDIF
	         ENDIF
	      ELSE
	         ASSIS_NO=''      
	      ENDIF
	      ****傳送MAIL給負責業務B
	      IF SEEK(P20_1.F04,'C01') = .T. AND EMPTY(C01.F33) = .F. AND ALLTRIM(P20_1.F13) <> ALLTRIM(C01.F33) AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
	         SALES_B_NO=A01.F01
	         IF SALES_B_NO<>ASSIS_NO AND SALES_B_NO<>APPL_NO
	    	    IF OS()="Windows 5.01"
	    	       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消','TEXT',MAIL_TEXT)                    
	            ELSE
	               IF !EMPTY(ALLTRIM(SALES_B_NO))
                      FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                      STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消'+'<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                   ENDIF   
	            ENDIF
	         ENDIF    
	      ELSE
	         SALES_B_NO=''   
	      ENDIF
	      ****傳送MAIL給負責業務A
	      IF SEEK(P20_1.F04,'C01') = .T. AND EMPTY(C01.F18) = .F. AND ALLTRIM(P20_1.F13) <> ALLTRIM(C01.F18) AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
	         SALES_A_NO=A01.F01
	         IF SALES_A_NO<>SALES_B_NO AND SALES_A_NO<>APPL_NO
	    	    IF OS()="Windows 5.01"
	    	       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消','TEXT',MAIL_TEXT)                    
	            ELSE
	                IF !EMPTY(ALLTRIM(SALES_A_NO))
                        FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                        STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單已被 ' + P20_1.F031 + ' 給予取消'+'<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                   ENDIF   
	            ENDIF 
	         ENDIF
	      ELSE
	         SALES_A_NO=''   
	      ENDIF
	      
	      
          WAIT CLEAR
          RELEASE ALL LIKE BK*   
      ENDIF  
    ENDIF
    SELECT P20
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	
          IF THISFORM.PAGEFRAME1.ACTIVEPAGE = 1        &&刪除整張訂單
             SELECT P20_1             
             PO_NO = P20_1.F01
             SELECT RECNO() FROM P20 WHERE P20.F01=PO_NO AND (P20.F09 = '1' OR P20.F09 = '2') INTO ARRAY BK2   
             IF _TALLY>0
                =MESSAGEBOX('此筆樣品申請單已有料品進行申請中,故無法整筆刪除!',0+64,'提示訊息視窗')
                RELEASE ALL LIKE BK*  
                RETURN
             ELSE
                SELECT RECNO() FROM P20 WHERE P20.F01 = PO_NO INTO ARRAY BK1           
                JJ1=''                
                IF _TALLY>0   
                  FOR I= 1 TO ALEN(BK1)
                      JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                  ENDFOR    
                  KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                  RLOCK(KK1,'P20')
                  LL1=RLOCK(KK1,'P20')
                ELSE
                  LL1=.T.   
                ENDIF                   
                IF LL1=.T. AND RLOCK('P20_1')       
                  DELE FROM P20 WHERE P20.F01 = PO_NO
                  SELECT P20_1
                  DELETE 
                  UNLOCK ALL
                  IF INT_099 = .T. .AND. SUBSTR(PO_NO,3,4) = SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                     HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                     DO ODR_RJT
                  ENDIF  
               ELSE
                  DO FILE_IMPACT                  
               ENDIF 
             ENDIF              
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
         		THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND EMPTY(P20_1.F09) &&判斷有無修改的權限
        		THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND EMPTY(P20_1.F09) &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
             ENDIF 
		     THISFORM.ANS_BOTT.ENABLED= .F. 
		     THISFORM.CNL_BOTT.ENABLED= .F.
             THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)      
          ELSE        
             SELECT P20                                                     &&刪除單筆資料  
             IF RLOCK('P20') AND EMPTY(P20.F09)   
                SELE P20
                DELETE 
                SKIP -1
                IF BOF()
                   GO TOP
                 ENDIF   
              ELSE
                 DO FILE_IMPACT                  
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空                  
                 SELECT P20_1                        
                 PO_NO=P20_1.F01                    
                 DELE                               &&連表頭也要刪除
                 IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                    HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                    DO ODR_RJT
                 ENDIF
                 SELE P20_1
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF
       RELEASE ALL LIKE BK*   
  ENDPROC 
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.T.
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF15.READONLY=.T.
      THISFORM.INV_BOTT.ENABLED=.T.
      THISFORM.GRID1.ENABLED=.T.
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID1.SETFOCUS 
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1         
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
      ELSE
         THISFORM.GRID1.ENABLED=.F. 
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0      
            HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
            DO ODR_RJT
            SELECT P20_1
            DELE
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
      CNL =''
      THISFORM.GRID1.SETFOCUS 
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'P20'
            THISFORM.GRID2.RECORDSOURCE='P20'
            THISFORM.GRID2.CHILDORDER='P201'
		    THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P20.F05'
		    THISFORM.GRID2.COLUMN2.CONTROLSOURCE="IIF(SEEK(ALLTRIM(P20.F05),'B01'),B01.F02,'')"
		    THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P20.F06'
		    THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P20.F15'    
	     ENDIF   
	     IF INT_099=.T.       
            HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
            DO ODR_RJT
         ENDIF   
         SELE P20_1
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依申請單號排列'
                 SET ORDER TO P20_11
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依申請廠商排列'
                 SET ORDER TO P20_12
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依需求對象排列'
                 SET ORDER TO P20_13
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC   
PROC ANS_BOTT.CLICK                  &&確認
   IF MESSAGEBOX('是否要確認此筆資料?',4+32+256,'請確認') = 6	 
      SELECT P20
      LOCK() 
      IF RLOCK()
         REPLACE P20.F09 WITH '1'
         REPLACE P20.F10 WITH '已向' + ALLTRIM(P20_1.F031) + '提出申請作業'
         REPLACE P20.F98 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')  
      ELSE
         DO FILE_IMPACT
         UNLOCK ALL
         RETURN
      ENDIF 
      UNLOCK ALL 
      SELECT RECNO() FROM P20 WHERE P20.F01 = P20_1.F01 AND EMPTY(P20.F09) INTO ARRAY BK1 
      IF _TALLY > 0 
         REPLACE P20_1.F09 WITH ''
      ELSE
         REPLACE P20_1.F09 WITH 'Y'
      ENDIF
      THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=IIF(P20.F09 = '1' AND P20.F15 = 0,'尚未回覆可申請之數量','')
      RELEASE ALL LIKE BK*  
   ENDIF
   SELECT P20
   THISFORM.GRID2.SETFOCUS
ENDPROC 
PROC CNL_BOTT.CLICK                  &&取消
      CNL ='1'
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
      THISFORM.KEY_LIST.ENABLED=.F.
      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
      THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
      THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
      THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
      THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.F.
      THISFORM.ORPGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.ENABLED=.T.
      THISFORM.SHRGROUP.VISIBLE=.T.
      THISFORM.SHRGROUP.SHURE1_BOTT.ENABLED=.F.
      THISFORM.SHRGROUP.SHURE1_BOTT.VISIBLE=.F.
      THISFORM.SHRGROUP.SHURE2_BOTT.ENABLED=.T.
      THISFORM.SHRGROUP.SHURE2_BOTT.VISIBLE=.T.
      THISFORM.SHRGROUP.ABANDON_BOTT.VISIBLE=.T.
      THISFORM.SHRGROUP.FINISH_BOTT.ENABLED=.F.
      THISFORM.SHRGROUP.FINISH_BOTT.VISIBLE=.F.
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(128,128,128),'COMMANDBUTTON')
      THISFORM.MTH_LIST.ENABLED=.F. 
      THISFORM.ANS_BOTT.ENABLED=.F.
      THISFORM.CNL_BOTT.ENABLED=.F.
      THISFORM.MAIL_BOTT.ENABLED=.F.
      THISFORM.GRID1.ENABLED=.F.   
      THISFORM.GRID2.ENABLED=.F.
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX') 
   	  THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY = .F.
      THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE = ALLTRIM(P20_1.F031) + '告知為常用品故不提供樣品'
   	  THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
ENDPROC
PROC MAIL_BOTT.CLICK	&&發MAIL 
     SELECT P20.*,C01.F05 AS C01F05,D01.F04 AS D01F04 FROM P20,C01,D01 WHERE LEFT(DTOS(P20.F02),6) = LEFT(DTOS(CTOD(HK+'/01')),6);
     		 AND C01.F01 = P20.F04 AND D01.F01 = P20.F03 AND P20.F01 = P20_1.F01 ORDER  BY P20.F05 INTO CURSOR P20ABC
     IF _TALLY > 0
          MAIL_TEXT = ''
          TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
          SELECT P20ABC
          GO TOP
          ****傳送MAIL給該廠商負責之樣品採購人員
	      WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
	      DO WHILE !EOF()
	         MAIL_TEXT = '料品編號：' + P20ABC.F05 + TMPCHR + ;
	     	             '申請數量：' + ALLTRIM(TRANSFORM(P20ABC.F06,'@R 999,999')) +TMPCHR + ;
	     	             '機種說明：' + P20ABC.F14 + TMPCHR + ;
	     	             '************************************************' + TMPCHR
	     	 SKIP        
	      ENDDO	          
	      IF SEEK(P20_1.F03,'D01') = .T. AND EMPTY(D01.F24) = .F. AND SEEK(D01.F24,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
	         PRS_NO=A01.F01 
	         IF OS()="Windows 5.01"
	    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單、需求對象：' + P20_1.F041 + '、申請廠商：' + P20_1.F031,'TEXT',MAIL_TEXT) 
	    	 ELSE
	    	    IF !EMPTY(ALLTRIM(PRS_NO))
                    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(PRS_NO)+'.TXT'                  
                    STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單、需求對象：' + P20_1.F041 + '、申請廠商：' + P20_1.F031+'<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                ENDIF  
	    	 ENDIF                      
	         =MESSAGEBOX('已將此樣品申請單傳送MAIL至樣品採購負責人' + ALLTRIM(A01.F03) + '、MAIL：' + ALLTRIM(A01.F10),0+64,'提示訊息視窗') 
	      ELSE
	         =MESSAGEBOX('請至D01.廠商基本資料中確認樣品採購人員是否空白,並至A02.操作人員資料管理中確定是否有設定MAIL!',0+64,'提示訊息視窗')    
	      ENDIF
          WAIT CLEAR 
     ENDIF
     SELECT P20ABC
     USE
     SELECT P20_1  
	 THISFORM.GRID1.SETFOCUS
ENDPROC
  PROC INV_BOTT.CLICK
         THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(128,128,128),'COMMANDBUTTON')
         THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(128,128,128),'COMMANDBUTTON')
         THISFORM.ANS_BOTT.FORECOLOR=RGB(128,128,128) 
         THISFORM.CNL_BOTT.FORECOLOR=RGB(128,128,128) 
         THISFORM.MAIL_BOTT.FORECOLOR=RGB(128,128,128) 
         THISFORM.INV_BOTT.FORECOLOR=RGB(128,128,128)  
         IF !USED('C01')
            SELECT 0
            USE C01
         ELSE
            SELECT C01
         ENDIF
         SET ORDER TO C011  
         IF !USED('B11')
            SELECT 0
            USE B11
         ELSE
            SELECT B11
         ENDIF
         SET ORDER TO B111   
         IF !USED('B1A')
            SELECT 0
            USE B1A
         ELSE
            SELECT B1A
         ENDIF
         SET ORDER TO 1  
         SELE B11.F01,B11.F03,A14.F02,B11.F04,B11.F05,B11.F08 FROM B11,A14 WHERE B11.F03=B01.F01 AND A14.F01=B11.F01  INTO CURSOR INV ORDER BY B11.F01
         INV_SEEK=CREATEOBJECT("INV_SEEK")  
         INV_SEEK.SHOW                   
         SELECT C01
         USE 
         SELECT B11
         USE 
         SELECT B1A
         USE 
		 AREA1='P20_1'
		 AREA2='P20'
         THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
         THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
         THISFORM.ANS_BOTT.FORECOLOR=RGB(0,0,0)
         THISFORM.CNL_BOTT.FORECOLOR=RGB(0,0,0)
         THISFORM.MAIL_BOTT.FORECOLOR=RGB(0,0,0)
         THISFORM.INV_BOTT.FORECOLOR=RGB(0,0,0)   
         SELECT P20_1              
         THISFORM.GRID1.SETFOCUS
  ENDPROC 
ENDDEFINE    
***********************************************列印程序
PROCEDURE PNT_PRC   
      SELECT P20.*,C01.F05 AS C01F05,D01.F04 AS D01F04 FROM P20,C01,D01 WHERE LEFT(DTOS(P20.F02),6) = LEFT(DTOS(CTOD(HK+'/01')),6);
     		 AND C01.F01 = P20.F04 AND D01.F01 = P20.F03 AND P20.F01 = P20_1.F01 ORDER  BY P20.F05 INTO CURSOR P20ABC
      IF _TALLY >0
          REPORT FORM ALLTRIM(INT_116)+'P20' TO PRINT PROMPT PREVIEW
          CLEAR
          MAIL_TEXT = ''
          TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
          SELECT P20ABC
          GO TOP
          ****傳送MAIL給該廠商負責之樣品採購人員
	      WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
	      DO WHILE !EOF()
	         MAIL_TEXT = '料品編號：' + P20ABC.F05 + TMPCHR + ;
	     	             '申請數量：' + ALLTRIM(TRANSFORM(P20ABC.F06,'@R 999,999')) + TMPCHR + ;
	     	             '機種說明：' + P20ABC.F14 +TMPCHR + ;
	     	             '************************************************' + TMPCHR
	     	 SKIP        
	      ENDDO	          
	      IF SEEK(P20_1.F03,'D01') = .T. AND EMPTY(D01.F24) = .F. AND SEEK(D01.F24,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND EMPTY(MAIL_TEXT) = .F.
	    	 PRS_NO=A01.F01 
	         IF OS()="Windows 5.01"
	    	    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：P20.樣品申請單、需求對象：' + P20_1.F041 + '、申請廠商：' + P20_1.F031,'TEXT',MAIL_TEXT)  
	    	 ELSE
	    	    IF !EMPTY(ALLTRIM(PRS_NO))
                    FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(PRS_NO)+'.TXT'                  
                    STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>P20.樣品申請單、需求對象：' + P20_1.F041 + '、申請廠商：' + P20_1.F031+'<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                ENDIF  
	    	 ENDIF                     
	      ENDIF
          WAIT CLEAR
     ENDIF
     SELECT P20ABC
     USE
     SELECT P20_1  
ENDPROC
***************************************************特殊輸入欄位設定-----------廠商
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02    
       ENDIF          
       IF _TALLY>0
          VDR_SEEK=createobject("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=createobject("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'D01'),D01.F04,'')     
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------客戶
DEFINE CLASS TXTF04 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          if empty(a02.f12)
             SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) and f18=sys_oper
          else
             SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
          endif
       ELSE
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 
       ENDIF
       IF _TALLY>0          
          VDR_SEEK=createobject("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM C01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=createobject("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=IIF(SEEK(THIS.VALUE,'C01'),C01.F05,'')  
  ENDPROC
ENDDEFINE
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
       ENDIF        
       IF _TALLY>0
          MTR_SEEK=createobject("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'     
       ENDIF          
    ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'') 
       THISFORM.PAGEFRAME1.PAGE2.LBLF051.BACKCOLOR=IIF(SEEK(THIS.VALUE,'B01'),RGB(192,192,192),RGB(255,255,0))     
  ENDPROC
ENDDEFINE