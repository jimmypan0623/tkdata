***程式名稱:C10直接材料耗用明細表
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
CHK_STR=''
R=0
QTY=0
TQTY=0
PO_NO=''
AREA1='G10_1'
AREA2='G10'
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         

IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'G10'    
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1           


G10='G10'+LEFT(DTOS(DATE()),6)
G101='G101'+LEFT(DTOS(DATE()),6)
IF !USED('&G10')
   SELE 0
   USE (G10) ALIA G10
ELSE
   SELE G10
ENDIF
SET ORDER TO G101    
SET RELA TO F02 INTO B01
CREATE CURSOR G10_1;
(F01 C(43),F02 C(40),F99 C(8),F06 N(13,2))
INDEX ON F01 TAG G10_11
INDEX ON F99 TAG G10_12
SELE F01 FROM G10 GROUP BY F01 ORDER BY G10.F01 INTO CURSOR G10_2
SELE G10_2
GO TOP
DO WHILE !EOF()
   SELE G10_1
   APPEND BLANK
   REPLACE  F01 WITH G10_2.F01
   REPLACE  F02 WITH IIF(SEEK(G10_2.F01,'B01'),B01.F02,'')   
   REPLACE  F99 WITH IIF(SEEK(G10_2.F01,'B01'),B01.F99,'')   
   REPLACE  F06 WITH TTL1(G10_1.F01)
   SELE G10_2
   SKIP   
ENDDO
SELE G10_2
USE   
SELE G10_1
SET ORDER TO G10_11 
G10FORM=CREATEOBJECT("TKG10")
G10FORM.SHOW  
DEFINE CLASS TKG10 AS FORM
  CAPTION='G10.直接材料耗用明細表'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKG10'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;               
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=2,;            
      RECORDSOURCE='G10_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=6,;            
      RECORDSOURCE='G10',; 
      LINKMASTER='G10_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER=G101,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.                             
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;   
      NEW_BOTT.VISIBLE=.F.,;
      EDIT_BOTT.VISIBLE=.F.,;
      DEL_BOTT.VISIBLE=.F.,;
      AUTOSIZE=.T.                
  ADD OBJECT EXCL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*100,;     
      CAPTION='\<L.轉EXCEL檔',;
      NAME='EXCL_BOTT' 
    
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='產出品號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='品名規格'
     ENDWITH
     THIS.ADDOBJECT('LBLF021','LABEL')
     WITH THIS.LBLF021
         .VISIBLE=.T.
         .LEFT=INT_015*64
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .AUTOSIZE=.T.
     ENDWITH     
     THIS.ADDOBJECT('LBLF99','LABEL')
     WITH THIS.LBLF99
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*61
         .WIDTH=INT_015*50
         .CAPTION='流水編號'
     ENDWITH     
     THIS.ADDOBJECT('LBLF991','LABEL')
     WITH THIS.LBLF991
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*61
         .AUTOSIZE=.T.
     ENDWITH     
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='材料成本'   
     ENDWITH    
     THIS.ADDOBJECT('LBLF061','LABEL')
     WITH THIS.LBLF061
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*88
         .AUTOSIZE=.T.      
     ENDWITH               
                          
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*230
          .HEIGHT=INT_015*25
          .MAXLENGTH=43
     ENDWITH        
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF02','LABEL')
	WITH THIS.LBLF02
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*7
	     .WIDTH=INT_015*50
         .CAPTION='使用材料'
    ENDWITH  
 	THIS.ADDOBJECT('LBLF021','LABEL')
	WITH THIS.LBLF021
	     .VISIBLE=.T.
         .LEFT=INT_015*267
         .TOP=INT_015*7
	     .WIDTH=INT_015*50
         .AUTOSIZE=.T.
    ENDWITH     
      THIS.ADDOBJECT('LBLF99','LABEL')
    WITH THIS.LBLF99
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*32
	     .WIDTH=INT_015*50
	     .CAPTION='流水編號'
	ENDWITH     	  
    THIS.ADDOBJECT('LBLF03','LABEL')
    WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='正常耗用'
	ENDWITH     

    THIS.ADDOBJECT('LBLF04','LABEL')
    WITH THIS.LBLF04
         .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*82
	     .WIDTH=INT_015*50
	     .CAPTION='異常耗用'
	ENDWITH     
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='成本單價'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='小計金額'       
    ENDWITH    
	THIS.ADDOBJECT('TXTF02','TEXTBOX')
	WITH THIS.TXTF02      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*3
	     .WIDTH=INT_015*200
	     .HEIGHT=INT_015*25
	     .NAME='TXTF02'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF99','TEXTBOX')
	WITH THIS.TXTF99    
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*28
	     .WIDTH=INT_015*80
	     .HEIGHT=INT_015*25
	     .NAME='TXTF99'  
	ENDWITH     	
	THIS.ADDOBJECT('TXTF03','TEXTBOX')
	WITH THIS.TXTF03      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*53
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999.999999'
	     .NAME='TXTF03'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF04','TEXTBOX')
	WITH THIS.TXTF04
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*78
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999.999999'
	     .NAME='TXTF04'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*103
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='999999.999999'
         .NAME='TXTF05'
    ENDWITH     
    THIS.ADDOBJECT('TXTF06','TEXTBOX')
    WITH THIS.TXTF06
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*128
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='999999.999999'
         .NAME='TXTF06'
    ENDWITH         

  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
       R=0
     SELECT  G10_1
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
    IF THISFORM.GRID1.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.EXCL_BOTT.ENABLED=.F.                   
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''     
        THISFORM.PAGEFRAME1.PAGE1.LBLF991.CAPTION=''   
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=TRANSFORM(0,'@R 9999999.999999')          
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.EXCL_BOTT.ENABLED=.T.                       
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE   
      SELE G10             
          THISFORM.GRID2.READONLY=.T.     
        THISFORM.GRID2.SETFOCUS           
     IF THISFORM.GRID2.ACTIVEROW=0 
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=0           
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
  ENDPROC     
  PROC INIT       
       CHK_STR=THISFORM.MTH_LIST.DISPLAYVALUE
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='產出品號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='流水編號'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G10_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G10_1.F99'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='使用料號'       
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='正常耗用'
	   THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='異常耗用'	  
	   THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='單    價'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='小計金額'
       THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='百分比%'   
	   THISFORM.GRID2.LINKMASTER='G10_1'
       THISFORM.GRID2.RELATIONALEXPR='F03'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='G10.F02'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='G10.F03'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='G10.F04'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='G10.F05'
  	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='ROUND(G10.F06,2)'
   	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='ROUND(100*G10.F06/G10_1.F06,2)'
	   THISFORM.GRID2.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*80
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.EXCL_BOTT.ENABLED=.F.            
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限              
          THISFORM.EXCL_BOTT.ENABLED=.T.      
       ENDIF  
       THISFORM.KEY_LIST.DISPLAYVALUE='依產出品號排列'      
       JK='產出品號'
       SELE G10_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=G10_1.F01
  ENDPROC               
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依產出品號排列')      
           .ADDITEM('依流水編號排列')   
       ENDWITH      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE
       SELECT G10_1
       IF THIS.VALUE=1
          SET ORDER TO 1
          THISFORM.PAGEFRAME1.PAGE1.LBLF01.TOP=INT_015*13
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.TOP=INT_015*9
          THISFORM.PAGEFRAME1.PAGE1.LBLF99.TOP=INT_015*61
          THISFORM.PAGEFRAME1.PAGE1.LBLF991.TOP=INT_015*61
          THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='產出品號'
          THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='流水編號'
          THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G10_1.F01'
          THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G10_1.F99'
          THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
          THISFORM.GRID1.COLUMN2.WIDTH=INT_015*60
          JK='產出品號'
       ELSE
          SET ORDER TO 2
          THISFORM.PAGEFRAME1.PAGE1.LBLF01.TOP=INT_015*61
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.TOP=INT_015*57
          THISFORM.PAGEFRAME1.PAGE1.LBLF99.TOP=INT_015*13
          THISFORM.PAGEFRAME1.PAGE1.LBLF991.TOP=INT_015*13
          THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='產出品號'
          THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='流水編號'
          THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G10_1.F01'
          THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G10_1.F99'
          THISFORM.GRID1.COLUMN2.WIDTH=INT_015*149
          THISFORM.GRID1.COLUMN1.WIDTH=INT_015*60         
          JK='流水編號'
       ENDIF
       THISFORM.GRID1.SETFOCUS
  ENDPROC

  PROC MTH_LIST.INTERACTIVECHANGE
       CHK_STR=THISFORM.MTH_LIST.DISPLAYVALUE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.CHILDORDER=''            
       SELE G10
       SET RELA OFF INTO B01
       SET RELA OFF INTO G10_1
       USE
       SELE G10_1
       USE
       G10='G10'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       G101='G101'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&G10')
          SELE 0
          USE (G10) ALIA G10
       ELSE
          SELE G10
       ENDIF
       SET ORDER TO G101      
       SET RELA TO F02 INTO B01
       CREATE CURSOR G10_1;
       (F01 C(43),F02 C(40),F99 C(8),F06 N(13,2))
       INDEX ON F01 TAG G10_11
       INDEX ON F99 TAG G10_12
       SELE F01 FROM G10 GROUP BY F01 ORDER BY G10.F01 INTO CURSOR G10_2
       SELE G10_2
       GO TOP
       DO WHILE !EOF()
          SELE G10_1
          APPEND BLANK
          REPLACE  F01 WITH G10_2.F01
          REPLACE  F02 WITH IIF(SEEK(G10_2.F01,'B01'),B01.F02,'')   
          REPLACE  F99 WITH IIF(SEEK(G10_2.F01,'B01'),B01.F99,'')   
          REPLACE  F06 WITH TTL1(G10_1.F01)
          SELE G10_2
          SKIP   
       ENDDO
       SELE G10_2
       USE   
       SELE G10_1
       SET ORDER TO G10_11  
       GO TOP
       THISFORM.GRID1.RECORDSOURCE='G10_1'
       THISFORM.GRID2.RECORDSOURCE='G10'
	   THISFORM.GRID2.LINKMASTER='G10_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=G101  
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G10_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G10_1.F99'       
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='G10.F02'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='G10.F03'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='G10.F04'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='G10.F05'
  	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='ROUND(G10.F06,2)'
   	   THISFORM.GRID2.COLUMN6.CONTROLSOURCE='ROUND(100*G10.F06/G10_1.F06,2)'            
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   THISFORM.GRID1.SETFOCUS        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.       
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限                                       
       ENDIF          
  ENDPROC
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX       
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=G10_1.F01
       THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=G10_1.F02
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=TRANSFORM(G10_1.F06,'@R 9999999.999999')
       THISFORM.PAGEFRAME1.PAGE1.LBLF991.CAPTION=G10_1.F99            
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
  ENDPROC     
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=G10.F02  
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=B01.F02        
       THISFORM.PAGEFRAME1.PAGE2.TXTF99.VALUE=B01.F99       
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=G10.F03
       THISFORM.PAGEFRAME1.PAGE2.TXTF04.VALUE=G10.F04
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=G10.F05
       THISFORM.PAGEFRAME1.PAGE2.TXTF06.VALUE=G10.F06      
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
  ENDPROC 
  PROCEDURE EXCL_BOTT.CLICK
       SELE G10_1.F01 產出品號,G10_1.F99 流水編號,G10_1.F06 材料總計,G10.F02 使用材料,B01.F99 材料流水號,G10.F03 正常耗用,G10.F04 異常耗用,G10.F05 單價,G10.F06 金額小計;
       FROM G10_1,G10,B01 WHERE G10.F01=G10_1.F01 AND B01.F01=G10.F02 ORDER BY G10_1.F01,G10.F02 NOWAIT
       IF _TALLY>0               
               FILE_NAME=LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)+'直接材料耗用明細表'   	           	        
   	           GCDELIMFILE=PUTFILE('儲存路徑',FILE_NAME,'XLS')
	           IF EMPTY(GCDELIMFILE)  && ESC PRESSED	          
                  RETURN
               ELSE
                 ON ERROR DO FILE_IMPACT
                 COPY TO (GCDELIMFILE) TYPE XL5   
		         =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗')              
               ENDIF    
        ENDIF   
       
  ENDPROC  

ENDDEFINE    
**********************************************列印程序
PROCEDURE PNT_PRC  
    SELECT G10_1.F01,G10_1.F06,G10.F02,G10.F03,G10.F04,G10.F05,G10.F06 FROM G10_1,G10 WHERE G10.F01=G10_1.F01 ORDER BY G10_1.F01,G10.F02 NOWAIT
    IF _TALLY>0
        REPORT FORM ALLTRIM(INT_116)+'G10' TO PRINT PROMPT PREVIEW      
    ENDIF
ENDPROC


*******************************************   計算材料金額
FUNC TTL1
     PARA BKK_NO
     qt_od=0
     sele G10
     SEEK BKK_NO
     IF FOUND()
         DO WHILE F01=BKK_NO            
            
                         qt_od=qt_od+f06
    
                SKIP
          ENDDO
     ELSE
       qt_od=0
     ENDIF
     SELE G10_1
     RETURN ROUND(qt_od,6)
