***程式名稱:K51.沖銷帳作業(應付)
CLOSE ALL
CLEAR 
FLG='0'
FCH=''
CHK=''
R=0
CHK_IN=''
HD1='K005 '
HD2='KB'
HD3='傳票作業(應付)'
AREA1='K51_1'
AREA2='K50'
IF ALLTRIM(INT_ACC)<>'FALSE'
   OMT4=CHR(VAL(SUBSTR(DTOS(DATE()),5,2))+IIF(VAL(SUBSTR(DTOS(DATE()),5,2))>9,55,48))
   ACC1='ACC'+ALLTRIM(SUBSTR(DTOS(DATE()),3,2)+OMT4)
   PTH=ALLTRIM(INT_ACC)+'\ACS\DA'                            &&新撰會計傳票檔
   IF FILE(PTH+'\'+ACC1+'.DBF')=.F.
      MESSAGEBOX('新傳票月份檔還未產生!請先至會計總帳系統產生月份檔',0+48,'提示訊息視窗')             
      RETURN
   ENDIF                                      
   SELECT 0
   USE &PTH\ACN ALIA ACN INDEX &PTH\ACN
   SET ORDER TO 1
   SELECT 0
   USE &PTH\&ACC1  ALIA &ACC1 INDEX &PTH\&ACC1
   SET ORDER TO 1         			                     			    
ENDIF                       
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'K51'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO A091
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO A231   
A24='A24'+LEFT(DTOS(DATE()),6)     &&單號暫存檔
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1     
IF !USED('D01')
   SELE 0
   USE D01 INDE D01
ELSE
   SELE D01
ENDIF
SET ORDER TO D011
IF !USED('E02')
   SELE 0
   USE E02 
ELSE
   SELE E02
ENDIF
SET ORDER TO E021
CREATE CURSOR DE01;
(F01 C(5),F02 C(4),F04 C(8))
INDE ON F01 TAG DE011
INDE ON F02 TAG DE012
APPEND FROM D01
APPEND FROM E02
SELECT DE01
SET ORDER TO DE011
IF !USED('K5F')
   SELE 0
   USE K5F 
ELSE 
   SELE K5F 
ENDIF
SET ORDER TO K5F1
IF !USED('K51')                  &&立沖結餘明細   
   SELE 0
   USE K51
ELSE
   SELE K51
ENDIF
SET ORDER TO K511 
K52='K52'+LEFT(DTOS(DATE()),6)	&&已沖帳款月報表
K521='K521'+LEFT(DTOS(DATE()),6)
K524='K524'+LEFT(DTOS(DATE()),6)
IF !USED('&K52')
   SELE 0
   USE (K52) ALIA K52
ELSE
   SELE K52
ENDIF
SET ORDER TO K524         
K50='K50'+LEFT(DTOS(DATE()),6)	&&傳票檔
K501='K501'+LEFT(DTOS(DATE()),6)
IF !USED('&K50')
   SELE 0
   USE (K50) ALIA K50
ELSE
   SELE K50
ENDIF
SET ORDER TO K501  
CREATE CURSOR K51_1;
(F01 C(10),F02 C(5),F03 C(1),F04 C(14),F05 D(8),F06 N(14,2),F07 C(2),F08 C(20),F13 C(1),F10 N(14,2),F90 C(17))
INDE ON F01 TAG K51_11
INDE ON F02 TAG K51_12 
SELE F01,F02,F03,F04,F05,F06,F07,F08,F13,SUM(F10),F90 FROM K50 WHERE F17='2' GROUP BY F01 ORDER BY F01 INTO CURSOR K51_2
SELE K51_2
GO TOP
DO WHILE !EOF()
   SELE K51_1
   APPEND BLANK
   REPL K51_1.F01 WITH K51_2.F01					&&傳票單號   
   REPL K51_1.F02 WITH K51_2.F02					&&對象編號
   REPL K51_1.F03 WITH K51_2.F03					&&收款方式(1現金,2支票,3折讓,4T/T,5其他) 
   REPL K51_1.F04 WITH K51_2.F04					&&支票號碼  
   REPL K51_1.F05 WITH K51_2.F05					&&支票到期日  
   REPL K51_1.F06 WITH K51_2.F06					&&收款金額    
   REPL K51_1.F07 WITH K51_2.F07					&&日期(沖帳日)
   REPL K51_1.F08 WITH K51_2.F08					&&傳票備註
   REPL K51_1.F13 WITH K51_2.F13					&&沖帳碼('  '未處裡 , 1已沖帳)
   REPL K51_1.F10 WITH K51_1.F06-K51_2.SUM_F10	&&收款金額-沖帳金額 
   REPL K51_1.F90 WITH K51_2.F90
   SELE K51_2
   SKIP   
ENDDO
SELE K51_2
USE   
SELE K51_1
SET ORDER TO K51_11
SET RELA TO F02 INTO DE01
*****************************
K51FORM=CREATEOBJECT("TKK51")
K51FORM.SHOW  
DEFINE CLASS TKK51 AS FORM
  CAPTION='K51.沖銷帳作業(應付)'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKK51'
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())    
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.    
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;           
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=4,; 
      RECORDSOURCE='K51_1',; 
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4' 
  ADD OBJECT GRID2 AS GRID2 WITH;
      COLUMNCOUNT=6,;            
      RECORDSOURCE='K50',; 
      LINKMASTER='K51_1',;
      RELATIONALEXPR='F01',;
      CHILDORDER='K501',;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*165,;
      LEFT=INT_015*650          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;          
      CAPTION='\<A.沖帳',;
      NAME='ANS_BOTT' 
  ADD OBJECT VRT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*57,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;          
      CAPTION='\<V.反沖帳',;
      NAME='VRT_BOTT'       
******************      
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='傳票單號'          
     ENDWITH
   THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH     
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='對象編號'
     ENDWITH
     THIS.ADDOBJECT('LBLF021','LABEL')
     WITH THIS.LBLF021
         .VISIBLE=.T.
         .LEFT=INT_015*120
         .TOP=INT_015*38
         .AUTOSIZE=.T.
         .CAPTION=''         
     ENDWITH     
     THIS.ADDOBJECT('TXTF02','TXTF02')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*34
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25         
          .MAXLENGTH=5
     ENDWITH            
     THIS.ADDOBJECT('LBLF03','LABEL')     
     WITH THIS.LBLF03
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*63
          .WIDTH=INT_015*50  
          .CAPTION='付款方式'
     ENDWITH 
     THIS.ADDOBJECT('PAYMENT_TYPE','PAYMENT_TYPE')
     WITH THIS.PAYMENT_TYPE
          .VISIBLE=.F.
          .LEFT=INT_015*65
          .TOP=INT_015*59   
     ENDWITH  
     THIS.ADDOBJECT('TXTF03','TEXTBOX')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*59
          .WIDTH=INT_015*120
          .HEIGHT=INT_015*25
          .MAXLENGTH=20
     ENDWITH
     THIS.ADDOBJECT('LBLF04','LABEL')     
     WITH THIS.LBLF04
          .VISIBLE=.F.
          .LEFT=INT_015*14
          .TOP=INT_015*88
          .WIDTH=INT_015*50  
          .CAPTION='支票號碼'
     ENDWITH 
     THIS.ADDOBJECT('TXTF04','TEXTBOX')          
     WITH THIS.TXTF04
          .VISIBLE=.F.
          .LEFT=INT_015*65
          .TOP=INT_015*84
          .WIDTH=INT_015*100
          .HEIGHT=INT_015*25
          .MAXLENGTH=14
     ENDWITH 
      THIS.ADDOBJECT('LBLF05','LABEL')     
     WITH THIS.LBLF05
          .VISIBLE=.F.
          .LEFT=INT_015*14
          .TOP=INT_015*113
          .WIDTH=INT_015*50  
          .CAPTION='到  期  日'
     ENDWITH 
     THIS.ADDOBJECT('TXTF05','TEXTBOX')          
     WITH THIS.TXTF05
          .VISIBLE=.F.
          .LEFT=INT_015*65
          .TOP=INT_015*109
          .WIDTH=INT_015*65
          .HEIGHT=INT_015*25
     ENDWITH 
    THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=.T.
         .LEFT=INT_015*300
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='日        期'
     ENDWITH    
    THIS.ADDOBJECT('TXTF07','TEXTBOX')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*351
          .TOP=INT_015*34
          .WIDTH=INT_015*30
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
          .INPUTMASK='99'
     ENDWITH     
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*300
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='付款金額'
     ENDWITH   
     THIS.ADDOBJECT('TXTF06','TEXTBOX')          
     WITH THIS.TXTF06
          .VISIBLE=.T.
          .LEFT=INT_015*351
          .TOP=INT_015*59
          .WIDTH=INT_015*80
          .HEIGHT=INT_015*25
          .ALIGNMENT=1
          .MAXLENGTH=14          
          .INPUTMASK='99999999999.99'
     ENDWITH      
     THIS.ADDOBJECT('LBLF08','LABEL')
     WITH THIS.LBLF08
         .VISIBLE=.T.
         .LEFT=INT_015*300
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION=IIF(ALLTRIM(INT_ACC)='FALSE','備        註','沖帳科目')
     ENDWITH      
     THIS.ADDOBJECT('TXTF08',IIF(ALLTRIM(INT_ACC)='FALSE','TEXTBOX','TXTF08'))          
     WITH THIS.TXTF08
          .VISIBLE=.T.
          .LEFT=INT_015*351
          .TOP=INT_015*84
          .WIDTH=INT_015*150
          .HEIGHT=INT_015*25
          IF ALLTRIM(INT_ACC)<>'FALSE'
             .BACKCOLOR=RGB(255,255,100)
             .MOUSEPOINTER=99
             .MOUSEICON='BMPS\harrow.cur'       	               
          ENDIF   
          .MAXLENGTH=IIF(ALLTRIM(INT_ACC)='FALSE',20,12)
     ENDWITH 
     THIS.ADDOBJECT('LBLF13','LABEL')
     WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*300
         .TOP=INT_015*113
         .WIDTH=INT_015*50
         .CAPTION='沖  帳  碼'
     ENDWITH
      THIS.ADDOBJECT('LBLF131','LABEL')
     WITH THIS.LBLF131
         .VISIBLE=.T.
         .LEFT=INT_015*351
         .TOP=INT_015*113
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*300
         .TOP=INT_015*138
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH
      THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*351
         .TOP=INT_015*138
         .AUTOSIZE=.T.
         .CAPTION=''
     ENDWITH       
  ENDPROC  
*******************   
 PROCEDURE PAGEFRAME1.PAGE2.INIT
   THIS.ADDOBJECT('LBLF09','LABEL')
	WITH THIS.LBLF09  
	     .VISIBLE=.T.
             .LEFT=INT_015*14
             .TOP=INT_015*18
	     .WIDTH=INT_015*50
             .CAPTION='發票號碼'
    ENDWITH  
    THIS.ADDOBJECT('TXTF09','TXTF09')
	WITH THIS.TXTF09      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
             .BACKCOLOR=RGB(255,255,100)
             .MOUSEPOINTER=99
             .MOUSEICON='BMPS\harrow.cur'       	     
	     .MAXLENGTH=10
	     .NAME='TXTF09'  
	ENDWITH
   THIS.ADDOBJECT('LBLF16','LABEL')
    WITH THIS.LBLF16
             .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*43
	     .WIDTH=INT_015*50
	     .CAPTION='發票總額'
	ENDWITH
   THIS.ADDOBJECT('TXTF16','TEXTBOX')
	WITH THIS.TXTF16
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .ALIGNMENT=1
             .MAXLENGTH=14          
             .INPUTMASK='99999999999.99'
	     .NAME='TXTF16'  
	ENDWITH			     
    THIS.ADDOBJECT('LBLF10','LABEL')
    WITH THIS.LBLF10
             .VISIBLE=.T.
	     .LEFT=INT_015*14
	     .TOP=INT_015*68
	     .WIDTH=INT_015*50
	     .CAPTION='沖銷金額'
	ENDWITH
    THIS.ADDOBJECT('TXTF10','TEXTBOX')
	WITH THIS.TXTF10
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*64
	     .WIDTH=INT_015*85
	     .HEIGHT=INT_015*25
	     .ALIGNMENT=1
             .MAXLENGTH=14          
             .INPUTMASK='99999999999.99'
	     .NAME='TXTF10'  
	ENDWITH
    THIS.ADDOBJECT('LBLF11','LABEL')
    WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='憑證單號'         
    ENDWITH 
    THIS.ADDOBJECT('TXTF11','TEXTBOX')
	WITH THIS.TXTF11
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*89
	     .WIDTH=INT_015*140
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=10
	     .NAME='TXTF11'	    
	ENDWITH         
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='備        註'       
    ENDWITH    
   THIS.ADDOBJECT('TXTF12','TEXTBOX')
    WITH THIS.TXTF12
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*114
         .WIDTH=INT_015*140
         .HEIGHT=INT_015*25
         .MAXLENGTH=20
         .NAME='TXTF12'
    ENDWITH  
    THIS.ADDOBJECT('LBLF14','LABEL')
	WITH THIS.LBLF14  
	     .VISIBLE=.T.
             .LEFT=INT_015*314
             .TOP=INT_015*18
	     .WIDTH=INT_015*50
             .CAPTION='發票日期'
    ENDWITH  
    THIS.ADDOBJECT('TXTF14','TEXTBOX')
	WITH THIS.TXTF14      
	     .VISIBLE=.T.
	     .LEFT=INT_015*365
	     .TOP=INT_015*14
	     .WIDTH=INT_015*70
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=10
	     .NAME='TXTF14'  
	ENDWITH 
  THIS.ADDOBJECT('ACC_AMOUNT','LABEL')
	WITH THIS.ACC_AMOUNT  
	     .VISIBLE=.T.
             .LEFT=INT_015*14
             .TOP=INT_015*144
	     .WIDTH=INT_015*50
             .CAPTION='付款餘額'
    ENDWITH  	  
    THIS.ADDOBJECT('ACC_AMOUNT1','LABEL')
	WITH THIS.ACC_AMOUNT1  
	     .VISIBLE=.T.
             .LEFT=INT_015*65
             .TOP=INT_015*144
	     .AUTOSIZE=.T.
             .CAPTION=''
    ENDWITH 
   THIS.ADDOBJECT('LBLF15','LABEL')
    WITH THIS.LBLF15
        .VISIBLE=.T.           
        .LEFT=INT_015*314
        .TOP=INT_015*118
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF151','LABEL')
    WITH THIS.LBLF151
        .VISIBLE=.T.           
        .LEFT=INT_015*365
        .TOP=INT_015*118
        .AUTOSIZE=.T.
    ENDWITH        
  ENDPROC  
 ***************   
 PROC INIT       
       HK=LEFT(ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE),5)
       THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
       THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)            
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10   
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')          
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='傳票單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='對象簡稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='日        期'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K51_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='K51_1.F02'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='DE01.F04'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='K51_1.F07'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*55
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(K51_1.F13<>'1',RGB(255,0,0),'')","COLUMN")      
       THISFORM.GRID1.TOOLTIPTEXT=IIF(K51_1.F13='1','已沖帳','未沖帳')          
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')        
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='發票號碼'
       THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='發票總額'
       THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='沖銷金額'
       THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='發票日期'
       THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='憑證單號'
       THISFORM.GRID2.COLUMN6.HEADER1.CAPTION='備        註'
       THISFORM.GRID2.LINKMASTER='K51_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K50.F09'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K50.F16'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='K50.F10'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='K50.F14'
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K50.F11'
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K50.F12'
       THISFORM.GRID2.COLUMN1.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN2.WIDTH=INT_015*60
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*60
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*120
       THISFORM.KEY_LIST.ENABLED=.T.
       THISFORM.MTH_LIST.ENABLED=.T.          
       THISFORM.ANS_BOTT.VISIBLE=.T. 
       THISFORM.VRT_BOTT.VISIBLE=.T.        
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	   THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	   THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	   THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.    
	   THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.	          
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
           THISFORM.ANS_BOTT.ENABLED=.F.
           THISFORM.VRT_BOTT.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''  
           THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''      
           THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''      
           THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''   
       ELSE   
          THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	  THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	  THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	  THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.    
	  THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.	          
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND K51_1.F13<>'1' 	 &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND K51_1.F13<>'1'	 &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   					 &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(K51_1.F13='1',.F.,.T.)  AND IIF(A02.F08='*',.T.,.F.) 		
          THISFORM.VRT_BOTT.ENABLED=IIF(K51_1.F13='1',.T.,.F.)  AND IIF(A02.F09='*',.T.,.F.)        
       ENDIF    
      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)       
       JK='傳票單號'
       SELECT  K51_1
       GO BOTTOM 
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=K51_1.F01
  ENDPROC
 ***************  
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELECT  K51_1   
     IF THISFORM.SHRGROUP.VISIBLE=.F.    
         THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(K51_1.F13<>'1',RGB(255,0,0),'')","COLUMN")      
         THISFORM.GRID1.TOOLTIPTEXT=IIF(K51_1.F13='1','已沖帳','未沖帳')   
         THISFORM.GRID1.ENABLED=.T.
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.
     ENDIF
     DO CASE 
           CASE THISFORM.KEY_LIST.DISPLAYVALUE='依傳票單號排列'
                      SET ORDER TO K51_11
           CASE THISFORM.KEY_LIST.DISPLAYVALUE='依對象編號排列'
                      SET ORDER TO K51_12
     ENDCASE      
     THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
     THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)
     THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.F.
     THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,0)    
     THISFORM.ANS_BOTT.VISIBLE=.T. 
     THISFORM.VRT_BOTT.VISIBLE=.T.             
     THISFORM.GRID1.SETFOCUS             
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
  ENDPROC
 **************************    
   PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE  
     SELECT K50
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS     
     ENDIF      
     THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.F.
     THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,0)
     THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.T.
     THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,255)     
     THISFORM.KEY_LIST.ENABLED=.F.
     THISFORM.MTH_LIST.ENABLED=.F.   
     THISFORM.ANS_BOTT.VISIBLE=.F. 
     THISFORM.VRT_BOTT.VISIBLE=.F.                 
     IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
	    THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	    THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	    THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	    THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
	    THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
	    THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
	    THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
	    THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=''
	    THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=''
	    THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''
	    THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=''
	    THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=''
	    THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''	    
            THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''	    
            THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=''	
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND K50.F13<>'1'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND K50.F13<>'1'  &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.) 					 &&&&判斷有無列印的權限  
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)  AND K51_1.F13<>'1' &&判斷有無新增的權限      
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
  ENDPROC   
****************************  
 PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       SELECT K51_1
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(K51_1.F13<>'1',RGB(255,0,0),'')","COLUMN")      
       THISFORM.GRID1.TOOLTIPTEXT=IIF(K51_1.F13='1','已沖帳','未沖帳')                       
       THISFORM.PAGEFRAME1.PAGE1.LBLF04.VISIBLE=IIF(K51_1.F03='2',.T.,.F.)		&&收款方式 : 2.支票
       THISFORM.PAGEFRAME1.PAGE1.LBLF05.VISIBLE=IIF(K51_1.F03='2',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VISIBLE=IIF(K51_1.F03='2',.T.,.F.)
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VISIBLE=IIF(K51_1.F03='2',.T.,.F.)	         
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=K51_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=K51_1.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=BILL(K51_1.F03)
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=K51_1.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=K51_1.F05
       THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=K51_1.F06
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=K51_1.F07
       THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=K51_1.F08
       THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=DE01.F04  
       THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=IIF(K51_1.F13='1','已沖帳','未沖帳')
       THISFORM.PAGEFRAME1.PAGE1.LBLF131.BACKCOLOR=IIF(K51_1.F13='1',RGB(58,186,152),RGB(255,0,0))
       THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=K51_1.F90
       IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
           THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
           THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
           THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
           THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
           THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
           THISFORM.ANS_BOTT.ENABLED=.F.
           THISFORM.VRT_BOTT.ENABLED=.F.   
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''  
           THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''    
           THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''  
           THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION='' 
        ELSE
           THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
           THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
           THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
           THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
           THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  AND K51_1.F13<>'1'  &&判斷有無修改的權限
           THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   AND K51_1.F13<>'1' &&判斷有無刪除的權限
           THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    				      &&判斷有無列印的權限  
           THISFORM.ANS_BOTT.ENABLED=IIF(K51_1.F13='1',.F.,.T.) AND IIF(A02.F08='*',.T.,.F.) 
           THISFORM.VRT_BOTT.ENABLED=IIF(K51_1.F13='1',.T.,.F.) AND IIF(A02.F09='*',.T.,.F.)       
       ENDIF          
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*!*	      THISFORM.REFRESH
  ENDPROC     
**********************************
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       SELECT K50
       THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=K50.F09
       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=K50.F10
       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=K50.F11
       THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=K50.F12
       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=K50.F14
       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=K50.F16
       THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=K50.F15
       THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND K50.F13<>'1'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND K50.F13<>'1'  &&判斷有無刪除的權限
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.) 					 &&&&判斷有無列印的權限  
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)  AND K51_1.F13<>'1' &&判斷有無新增的權限      
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM. CMDGROUP.SEEK_BOTT.ENABLED=.F.    
       ENDIF          
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
*!*	       THISFORM.REFRESH
  ENDPROC     
***********  
   PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依傳票單號排列')
           .ADDITEM('依對象編號排列')
           .VALUE=1
       ENDWITH      
  ENDPROC 
************  
   PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE K51_1 
       DO CASE
       CASE THIS.DISPLAYVALUE='依傳票單號排列'
               SET ORDER TO K51_11 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='傳票單號'
	       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象編號'
	       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='對象簡稱'
	       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='日        期'
	       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K51_1.F01'
	       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='K51_1.F02'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='DE01.F04'
	       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='K51_1.F07'
	       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
	       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
	       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*55
	       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50                      
        CASE THIS.DISPLAYVALUE='依對象編號排列'
               SET ORDER TO K51_12
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='對象編號'
	       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='對象簡稱'
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='傳票單號'
	       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='日        期'
	       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='K51_1.F02'
	       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='DE01.F04'
	       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='K51_1.F01'
	       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='K51_1.F07'
	       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
	       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*55
	       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
	       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*50                                                                 
       ENDCASE 
       THISFORM.GRID1.SETFOCUS
  ENDPROC 
*************
 PROC MTH_LIST.INTERACTIVECHANGE
       HK=LEFT(ALLTRIM(THISFORM.MTH_LIST.DISPLAYVALUE),5)
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.CHILDORDER=''
       IF ALLTRIM(INT_ACC)<>'FALSE'       &&如果要拋轉新撰會計傳票
          OMT4=CHR(VAL(RIGHT(THIS.DISPLAYVALUE,2))+IIF(VAL(RIGHT(THIS.DISPLAYVALUE,2))>9,55,48))
                       ACC2='ACC'+ALLTRIM(SUBSTR(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),3,2)+OMT4)
                       PTH=ALLTRIM(INT_ACC)+'\ACS\DA'                         &&新撰會計傳票檔
                       IF FILE(PTH+'\'+ACC2+'.DBF')=.F.
                          MESSAGEBOX('新傳票月份檔還未產生!請先至會計總帳系統產生月份檔',0+48,'提示訊息視窗')             
                          RETURN
                       ELSE
                          SELECT &ACC1
                          USE              
                          ACC1=ACC2            
                       ENDIF                                      
                       SELECT 0
                       USE &PTH\&ACC1  ALIA &ACC1 INDEX &PTH\&ACC1
                        SET ORDER TO 1         			                     			           
       ENDIF                               
       SELE A24
       USE
       SELE K50
       USE    
       SELE K51_1
       SET RELA OFF INTO DE01
       USE           
       SELECT K52
       USE       
       A24='A24'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&A24')
          SELE 0
          USE (A24) ALIA A24
       ELSE
          SELE A24
       ENDIF
       SET ORDER TO 1 
	K52='K52'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)&&已沖帳款月報表
	K521='K521'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	K524='K524'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	IF !USED('&K52')
	   SELE 0
	   USE (K52) ALIA K52
	ELSE
	   SELE K52
	ENDIF
	SET ORDER TO K524        
       K50='K50'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)	&&傳票檔
       K501='K501'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
	IF !USED('&K50')
	   SELE 0
	   USE (K50) ALIA K50
	ELSE
	   SELE K50
	ENDIF
	SET ORDER TO K501   
	CREATE CURSOR K51_1;
	(F01 C(10),F02 C(5),F03 C(1),F04 C(14),F05 D(8),F06 N(14,2),F07 C(2),F08 C(20),F13 C(1),F10 N(14,2),F90 C(17))
	INDE ON F01 TAG K51_11
	INDE ON F02 TAG K51_12
	SELE F01,F02,F03,F04,F05,F06,F07,F08,F13,SUM(F10),F90 FROM K50 WHERE F17='2' GROUP BY F01 ORDER BY F01 INTO CURSOR K51_2
	SELE K51_2
	GO TOP
	DO WHILE !EOF()
	   SELE K51_1
	   APPEND BLANK
	   REPL K51_1.F01 WITH K51_2.F01					&&傳票單號   
	   REPL K51_1.F02 WITH K51_2.F02					&&對象編號
	   REPL K51_1.F03 WITH K51_2.F03					&&付款方式(1現金,2支票,3折讓,4T/T,5其他) 
	   REPL K51_1.F04 WITH K51_2.F04					&&支票號碼  
	   REPL K51_1.F05 WITH K51_2.F05					&&支票到期日  
	   REPL K51_1.F06 WITH K51_2.F06					&&付款金額    
	   REPL K51_1.F07 WITH K51_2.F07					&&日期(沖帳日)
	   REPL K51_1.F08 WITH K51_2.F08					&&傳票備註
	   REPL K51_1.F13 WITH K51_2.F13					&&沖帳碼('  '未處裡 , 1已沖帳)
	   REPL K51_1.F10 WITH K51_1.F06-K51_2.SUM_F10	&&付款金額-沖帳金額 
	   REPL K51_1.F90 WITH K51_2.F90
	   SELE K51_2
	   SKIP   
	ENDDO
	SELE K51_2
	USE   
	SELE K51_1
	SET ORDER TO K51_11
	SET RELA TO F02 INTO DE01
       THISFORM.GRID1.RECORDSOURCE='K51_1'
       THISFORM.GRID2.RECORDSOURCE='K50'
       THISFORM.GRID2.LINKMASTER='K51_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER='K501'  
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K50.F09'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K50.F16'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='K50.F10'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='K50.F14'
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K50.F11'
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K50.F12' 
       THISFORM.KEY_LIST.ENABLED=.T.
       THISFORM.KEY_LIST.INTERACTIVECHANGE
       THISFORM.MTH_LIST.ENABLED=.T.           
       THISFORM.ANS_BOTT.VISIBLE=.T. 
       THISFORM.VRT_BOTT.VISIBLE=.T.           
       THISFORM.GRID1.READONLY=.T.      
       THISFORM.GRID2.READONLY=.T.            
       THISFORM.GRID1.SETFOCUS       
       IF THISFORM.GRID1.ACTIVEROW=0
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	   THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	   THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	   THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.    
	   THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.	          
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
           THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
           THISFORM.ANS_BOTT.ENABLED=.F.
           THISFORM.VRT_BOTT.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
           THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''  
           THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''      
           THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''  
           THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''
       ELSE
          THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
          THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	  THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	  THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	  THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.    
	  THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.	
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND K51_1.F13<>'1'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND K51_1.F13<>'1' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.ANS_BOTT.ENABLED=IIF(K51_1.F13='1',.F.,.T.)  AND IIF(A02.F08='*',.T.,.F.)           
          THISFORM.VRT_BOTT.ENABLED=IIF(K51_1.F13='1',.T.,.F.)  AND IIF(A02.F09='*',.T.,.F.)    
       ENDIF             
      THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)       
       JK='傳票單號'
       SELECT  K51_1
       GO BOTTOM 
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=K51_1.F01  
  ENDPROC   
*************  
 PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.VRT_BOTT.ENABLED=.F.
   THISFORM.GRID1.ENABLED=.F.   
   THISFORM.GRID2.ENABLED=.F.   
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
        HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
        DO ODR_CRT
        THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.      
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.F. 
	    THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=1
	    THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VISIBLE=.T.
	    THISFORM.PAGEFRAME1.PAGE1.TXTF03.VISIBLE=.F.
 	    THISFORM.PAGEFRAME1.PAGE1.LBLF04.VISIBLE=.F.
       	THISFORM.PAGEFRAME1.PAGE1.LBLF05.VISIBLE=.F.
       	THISFORM.PAGEFRAME1.PAGE1.TXTF04.VISIBLE=.F.
       	THISFORM.PAGEFRAME1.PAGE1.TXTF05.VISIBLE=.F.             
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=CTOD('')
        THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE=0            
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=RIGHT(DTOS(DATE()),2)
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.            
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=''    
        THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''  
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS              
    ELSE       
        THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS 
        IF K51_1.F10=0
             =MESSAGEBOX('付款餘額已為零,故無法新增沖帳資料!',0+64,'提示訊息視窗')
            THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 
        ELSE         
	   THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
	   THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')
	   THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.F. 
	   THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.T.  
	   THISFORM.PAGEFRAME1.PAGE2.TXTF14.READONLY=.T. 
	   THISFORM.PAGEFRAME1.PAGE2.TXTF16.READONLY=.T.
	   THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE='' 
	   THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=0
	   THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''
	   THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE='' 
	   THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE='' 
	   THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=0
	   THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''	      
        ENDIF
     ENDIF   
  ENDPROC  
***************   
 PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
   IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='K50'
       THISFORM.GRID2.CHILDORDER='K501'
       THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K50.F09'
       THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K50.F16'
       THISFORM.GRID2.COLUMN3.CONTROLSOURCE='K50.F10'
       THISFORM.GRID2.COLUMN4.CONTROLSOURCE='K50.F14'
       THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K50.F11'
       THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K50.F12'
       SELE K51_1 
       COD=SYS(21)
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'K51')=.T.
          SELE MAX(F01) FROM K51 INTO ARRAY GB NOWAIT
          HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          DO ODR_RPT
	      THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
	      THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH	   
       ENDIF
       **
        IF IIF(INDEXSEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,.F.,'D01','D011'),.F.,IIF(INDEXSEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,.F.,'E02','E021'),.F.,.T.)) OR ;
            EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE)
            =MESSAGEBOX('查無此對象編號請先建立!',0+64,'提示訊息視窗')
            THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
            SET ORDER TO &COD
            RETURN            
       ENDIF
       IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
            IF  EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
		 =MESSAGEBOX('支票號碼不得空白!',0+64,'提示訊息視窗') 
	          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
	          SET ORDER TO &COD 
	          RETURN
      	   ENDIF   
       	   IF  EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
		       =MESSAGEBOX('支票到期日不得空白',0+64,'提示訊息視窗') 
	          THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
	          SET ORDER TO &COD 
	          RETURN
      	   ENDIF   
      ENDIF	    
      IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE)
          =MESSAGEBOX('付款金額不得為零!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF06.SETFOCUS
          SET ORDER TO &COD 
          RETURN
      ENDIF   
      IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE))          
         =MESSAGEBOX('日期不得空白!',0+64,'提示訊息視窗') 
         THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
         SET ORDER TO &COD                
         RETURN
       ENDIF      
       IF INDEXSEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,.F.,'K51','K512')=.F.
           =MESSAGEBOX('此對象於K09.立沖結餘明細(應付)中已無帳款可沖銷,請查明!',0+64,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
           SET ORDER TO &COD
           RETURN           
       ENDIF
       IF ALLTRIM(INT_ACC)<>'FALSE'
          IF SEEK(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE),'ACN')=.F. OR EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE)
             =MESSAGEBOX('無此科目編號!',0+48,'提視訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
             RETURN
             SET ORDER TO &COD
          ENDIF
       ENDIF       
       SELECT  K51_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE))
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
          	REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          ENDIF
          REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE 
          REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
       ENDIF   
       THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE	 &&表身新增確認  
       IF EMPTY(K51_1.F10) OR K51_1.F10<0
           =MESSAGEBOX('已無付款餘額可沖銷,請查明後再輸入!',0+64,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
           RETURN
       ENDIF          
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE)
           =MESSAGEBOX('發票號碼不得空白!',0+64,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
           RETURN
       ENDIF         
        IF INDEXSEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,.F.,'K51','K511')=.F.                     
            =MESSAGEBOX('K09.立沖結餘明細(應付)中無此發票號碼!',0+64,'提示訊息視窗')          
            THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
            RETURN
       ENDIF 
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE,'K50')=.T.
           =MESSAGEBOX('此發票號碼在此傳票單號中已有資料,請重新輸入!',0+64,'提示訊息視窗')          
           THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
           RETURN
       ENDIF    
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE)
          =MESSAGEBOX('沖銷金額不得為零!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
          RETURN
       ENDIF  
       IF  THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE>;
       	     IIF(INDEXSEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,.T.,'K51','K511'),K51.F10,0)
       	     =MESSAGEBOX('您輸入的沖銷金額大於發票之未沖銷金額,請查明後再輸入!',0+64,'提示訊息視窗') 
             THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
             RETURN
       ENDIF
       IF  THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE>K51_1.F10
	     =MESSAGEBOX('您輸入的沖銷金額已超過付款餘額,請重新輸入!',0+64,'提示訊息視窗') 
	     THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
	      RETURN
       ENDIF       
       SELECT  K50
       APPEND BLANK
       LOCK()
       IF RLOCK()
       	   REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPLACE F03 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE))
           REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
           IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
          	REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           ENDIF
           REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
           REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
           REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE 
           REPLACE F09 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE
           REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
           REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
           REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
           REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE
           REPLACE F16 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE
           REPLACE F15 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
           REPLACE F17 WITH '2'
           SELECT K51_1
           REPLACE K51_1.F10 WITH K51_1.F10+(K50.F10*(-1))
           THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
           SELECT K51
           SET ORDER TO K511	&& F01+F06+DTOS(F02)
           SEEK K50.F09+K50.F02
           IF FOUND()
               REPLACE K51.F09 WITH K51.F09+K50.F10
           ENDIF    
       ENDIF
       UNLOCK ALL         
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE
       THISFORM.GRID2.ENABLED=.T.
       THISFORM.GRID2.SETFOCUS  
       THISFORM.ORPGROUP.NEW_BOTT.CLICK  
    ENDIF  
  ENDPROC
***************** 
 PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.VRT_BOTT.ENABLED=.F.
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1  
          SELECT K51_1
          IF RLOCK('K51_1')
	      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F. 
	      THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
	      THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
	      THISFORM.PAGEFRAME1.PAGE1.TXTF06.READONLY=.T.
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.            	      
	      THISFORM.PAGEFRAME1.PAGE1.TXTF03.VISIBLE=.F.
          THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.F.            	      
	      THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=VAL(K51_1.F03)
	      THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VISIBLE=.T.
	      THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.SETFOCUS
          ELSE  
              DO file_impact  
              UNLOCK ALL
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
          ENDIF   
     ELSE    &&處理表身修改
	  THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.                                                     
	   SELECT K50
           IF RLOCK('K50')                                           
               THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX') 
       	       THISFORM.PAGEFRAME1.PAGE2.TXTF10.READONLY=.F.
       	       THISFORM.PAGEFRAME1.PAGE2.TXTF12.READONLY=.F.
               THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
           ELSE  
               DO file_impact  
               UNLOCK ALL
               THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
          ENDIF        
      ENDIF   
  ENDPROC
*****************修改確認
   PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1 &&表頭修改確認
     	  IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
               IF  EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
		     =MESSAGEBOX('支票號碼不得空白!',0+64,'提示訊息視窗') 
	              THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
	              RETURN
      	        ENDIF   
       	        IF  EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE)
		      =MESSAGEBOX('支票到期日不得空白',0+64,'提示訊息視窗') 
	              THISFORM.PAGEFRAME1.PAGE1.TXTF05.SETFOCUS
	              RETURN
      	         ENDIF   
           ENDIF	    
           IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE))          
                =MESSAGEBOX('日期不得空白!',0+64,'提示訊息視窗') 
                THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
                RETURN
           ENDIF
           IF ALLTRIM(INT_ACC)<>'FALSE'
              IF SEEK(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE),'ACN')=.F. OR EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE)
                 =MESSAGEBOX('無此科目編號!',0+48,'提視訊息視窗')
                 THISFORM.PAGEFRAME1.PAGE1.TXTF08.SETFOCUS
                 RETURN
              ENDIF
           ENDIF           
           SELECT K51_1
           IF  RLOCK()
           	REPLACE F03 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE))
          	IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
          	     REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          	     REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          	ELSE
          	     REPLACE F04 WITH ''
           	     REPLACE F05 WITH CTOD('')     
          	ENDIF
          	REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          	REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
                SELE RECNO() FROM K50 WHERE K50.F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE  AND K50.F13<>'1' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
                   RLOCK(KK1,'K50')
                   LL1=RLOCK(KK1,'K50')
                ELSE
                   LL1=.T.   
                ENDIF           	
          	IF LL1=.T.  AND LEN(ALLTRIM(JJ1))>0
          	    SELECT K50 
                    FOR I= 1 TO ALEN(BK1)                      
	                    GO BK1(I) 
	                    REPLACE F03 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE))
		            IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
		          	 REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
		          	 REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
		            ELSE
		                 REPLACE F04 WITH ''
		                 REPLACE F05 WITH CTOD('')     
		            ENDIF
		            REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
		            REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
	            ENDFOR
	        ENDIF            
          	RELEASE ALL LIKE BK*   
           ELSE 
         	DO  FILE_IMPACT
         	RETURN
           ENDIF 
           UNLOCK ALL 
       ELSE                                                   &&表身修改確認                
           IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE)
               =MESSAGEBOX('沖銷金額不得為零!',0+64,'提示訊息視窗') 
               THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
               RETURN
           ENDIF  
           IF K50.F10<>THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
               IF THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE>;
       	            IIF(INDEXSEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,.T.,'K51','K511'),K51.F10,0)
       	            =MESSAGEBOX('您輸入的沖銷金額大於發票之未沖銷金額,請查明後再輸入!',0+64,'提示訊息視窗') 
                    THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
                    RETURN
               ENDIF             
               IF (K51_1.F10+K50.F10)<THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
                    =MESSAGEBOX('您輸入的沖銷金額已超過付款餘額,請重新輸入!',0+64,'提示訊息視窗') 
	            THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
	            RETURN
               ENDIF
               IF (K51_1.F10+K50.F10-THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE)<0
                    =MESSAGEBOX('您輸入的沖銷金額已此付款之金額呈現負數,請重新輸入!',0+64,'提示訊息視窗') 
	            THISFORM.PAGEFRAME1.PAGE2.TXTF10.SETFOCUS
	            RETURN
               ENDIF               
          ENDIF
	  SELECT K51_1
	  IF RLOCK()
	      REPLACE K51_1.F10 WITH K51_1.F10+K50.F10-THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
              SELECT K51
              SEEK K50.F09+K50.F02
              IF FOUND()
          	   REPLACE K51.F09 WITH  K51.F09+(K50.F10*(-1))+THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
              ENDIF	
              SELECT  K50
              REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE
              REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
              REPLACE F15 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'') 
              THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))           
          ELSE 
              DO  FILE_IMPACT
              RETURN
          ENDIF 	     
          UNLOCK ALL  
      ENDIF
      THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC  
*************    
 PROCEDURE ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
    IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	    
         IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1 &&表頭刪除   刪除整張訂單
              SELECT  K51_1   
              LOCK()          
              IF RLOCK()
                  PO_NO=K51_1.F01
                  SELECT  RECNO() FROM K50 WHERE K50.F01=PO_NO  AND K50.F13<>'1' INTO ARRAY BK1              
                  JJ1=''                
                  IF _TALLY>0   
                      FOR I= 1 TO ALEN(BK1)
                              JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                      ENDFOR    
                      KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
                      RLOCK(KK1,'K50')
                      LL1=RLOCK(KK1,'K50')
                  ELSE
                      LL1=.T.   
                  ENDIF 
                  IF LL1=.T. AND LEN(ALLTRIM(JJ1))>0 
                      SELECT K50 
                      FOR I= 1 TO ALEN(BK1)                      
	                      GO BK1(I) 
	                      SELECT  K51                                            &&立沖結餘明細帳庫存明細檔 
	                      SET ORDER TO K511
	                      SEEK K50.F09+K50.F02                                   
	                      IF FOUND()
	                       	    REPLACE  K51.F09 WITH K51.F09+(K50.F10*(-1))	&&開單未沖金額 
	                      ENDIF  	
	                      SELECT K50
	                      DELETE 
                      ENDFOR                    
                  ENDIF
                  RELEASE ALL LIKE BK*
                  IF  SUBSTR(K51_1.F01,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      DO ODR_RJT
                   ENDIF 
                   SELECT K51_1
                   DELETE  
             ELSE
                   DO FILE_IMPACT                  
             ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
                THISFORM.VRT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) AND K51_1.F13>'1' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  AND K51_1.F13<>'1' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(K51_1.F13='1',.F.,.T.) AND IIF(A02.F08='*',.T.,.F.)  
                THISFORM.VRT_BOTT.ENABLED=IIF(K51_1.F13='1',.T.,.F.) AND IIF(A02.F09='*',.T.,.F.)                 
             ENDIF     
        ELSE        	&&刪除單筆資料 
              SELECT  K50       
              LOCK()                                             
              IF RLOCK()     
                  SELECT K51
                  SET ORDER TO K511
                  SEEK K50.F09+K50.F02
                  IF FOUND()
                       REPLACE K51.F09 WITH K51.F09+(K50.F10*(-1))	&&開單未沖金額 
                  ENDIF                     
                  SELECT K51_1
                  REPLACE K51_1.F10 WITH K51_1.F10+K50.F10
                  SELECT K50
                  DELETE
                  UNLOCK
                  SKIP -1
                  IF BOF()
                     GO TOP
                  ENDIF                                    
              ELSE
                  DO FILE_IMPACT                  
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空連表頭也要刪除
                   IF SUBSTR(K51_1.F01,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      PO_NO=K51_1.F01
                      HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      DO ODR_RJT
                   ENDIF
                   SELECT  K51_1
                   DELETE 
                   SKIP -1
                   IF BOF()
                       GO TOP
                   ENDIF   
                  THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                  THISFORM.REFRESH          
              ENDIF
        ENDIF
    ENDIF
    UNLOCK ALL
  ENDPROC
**************     
   PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.      
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.VISIBLE=.T.   
      THISFORM.PAGEFRAME1.PAGE1.TXTF08.READONLY=.T.                  
      THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF09.READONLY=.T.
      THISFORM.GRID1.ENABLED=.T.
      THISFORM.GRID2.ENABLED=.T.      
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.KEY_LIST.ENABLED=.T.
          THISFORM.MTH_LIST.ENABLED=.T.          
          THISFORM.ANS_BOTT.VISIBLE=.T. 
          THISFORM.VRT_BOTT.VISIBLE=.T. 
          THISFORM.GRID1.SETFOCUS  
      ELSE
          THISFORM.GRID1.ENABLED=.F.
          THISFORM.GRID2.SETFOCUS
          IF THISFORM.GRID2.ACTIVEROW=0
             HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
             DO ODR_RJT
               SELECT  K51_1
               DELETE
               THISFORM.PAGEFRAME1.ACTIVEPAGE=1
               THISFORM.REFRESH  
           ENDIF   
      ENDIF       
      UNLOCK ALL
  ENDPROC
******************  
   PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
           IF THISFORM.GRID2.RECORDSOURCE<>'K50'
                THISFORM.GRID2.RECORDSOURCE='K50'
                THISFORM.GRID2.CHILDORDER=K501
                THISFORM.GRID2.COLUMN1.CONTROLSOURCE='K50.F09'
	        THISFORM.GRID2.COLUMN2.CONTROLSOURCE='K50.F16'
	        THISFORM.GRID2.COLUMN3.CONTROLSOURCE='K50.F10'
	        THISFORM.GRID2.COLUMN4.CONTROLSOURCE='K50.F14'
	        THISFORM.GRID2.COLUMN5.CONTROLSOURCE='K50.F11'
	        THISFORM.GRID2.COLUMN6.CONTROLSOURCE='K50.F12'
	   ENDIF   
	   HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
	   DO ODR_RJT
           SELECT  K51_1
           DO CASE 
                 CASE THISFORM.KEY_LIST.DISPLAYVALUE='依傳票單號排列'
                            SET ORDER TO K51_11
                 CASE THISFORM.KEY_LIST.DISPLAYVALUE='依對象編號排列'
                            SET ORDER TO K51_12
          ENDCASE   
     ENDIF  
     THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC    
**************       
  PROC ANS_BOTT.CLICK     &&沖帳程序
       IF MESSAGEBOX('是否確認資料無誤可以沖帳!',4+32+256,'請確認') = 6	 
           SELECT K51_1
           LOCK()
           IF RLOCK()
                IF K51_1.F13='1'
                   =MESSAGEBOX('此單據已由別的工作站沖帳完成',0+64,'提示訊息視窗')
                   UNLOCK ALL
                   THISFORM.GRID1.SETFOCUS
                   RETURN
                ELSE 
                   IF K51_1.F10<>0
                       =MESSAGEBOX('此筆單據之沖銷總金額不足付款金額,請查明後再沖帳!',0+64,'提示訊息視窗') 
                       UNLOCK ALL
                       THISFORM.GRID1.SETFOCUS
                       RETURN
                   ELSE
	               SELE RECNO() FROM K50 WHERE K50.F01=K51_1.F01  .AND. F13<>'1' INTO ARRAY BK1
	               JJ1=''                
	               IF _TALLY>0   
	                   FOR I= 1 TO ALEN(BK1)
	                           JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
	                   ENDFOR    
	                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
	                   RLOCK(KK1,'K50')
	                   LL1=RLOCK(KK1,'K50')
	               ELSE
	                   LL1=.T.   
	               ENDIF  
	               SELECT  RECNO() FROM K51 WHERE F01= ANY (SELE   F09 FROM K50 WHERE F01=K51_1.F01) INTO ARRAY BK2
	               JJ2=''                
	               IF _TALLY>0                   
	                   FOR I= 1 TO ALEN(BK2)
	                           JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
	                   ENDFOR  
	                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')
	                   RLOCK(KK2,'K51')
	                   LL2=RLOCK(KK2,'K51')
	               ELSE
	                   LL2=.T.   
	               ENDIF
	               IF LL1 AND LL2=.T. AND LEN(ALLTRIM(JJ1))>0 
	               	    SELECT  K50
	                    FOR I= 1 TO ALEN(BK1)                     
		                    GO BK1(I) 
		                    SELECT  K51                                            &&立沖結餘明細帳庫存明細檔 
		                    SET ORDER TO K511
		                    SEEK K50.F09+K50.F02                                   
		                    IF FOUND()
			                 SELECT  K52                                         &&已沖帳款月報表
			                 APPEND BLANK
			                 REPLACE  F01 WITH K50.F07
			                 REPLACE  F02 WITH K50.F02
			                 REPLACE  F03 WITH K50.F09
			                 REPLACE  F04 WITH K50.F10
			                 REPLACE  F05 WITH K50.F14 
			                 REPLACE  F06 WITH K50.F01
			                 REPLACE  F07 WITH K50.F11 
			                 REPLACE  F08 WITH K50.F12 
			                 REPLACE  F09 WITH IIF(INDEXSEEK(K50.F02,.T.,'D01','D011'),D01.F04,IIF(INDEXSEEK(K50.F02,.T.,'E02','E021'),E02.F04,'')) 
			                 REPLACE  F10 WITH K51.F15
			                 REPLACE  F11 WITH K51.F16
			                 REPLACE  F12 WITH K51.F17 
			                 REPLACE  F13 WITH K51.F18
			                 REPLACE  F14 WITH '2'
			                 REPLACE  F15 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
			                 REPLACE  F16 WITH K51.F03
			                 REPLACE  F17 WITH K51.F12
			                 REPLACE  F18 WITH K51.F13
			                 REPLACE  F19 WITH K51.F14
			                 SELECT  K5F                                         &&已沖帳款月報表
			                 APPEND BLANK
			                 REPLACE  F01 WITH K50.F07
			                 REPLACE  F02 WITH K50.F02
			                 REPLACE  F03 WITH K50.F09
			                 REPLACE  F04 WITH K50.F10
			                 REPLACE  F05 WITH K50.F14 
			                 REPLACE  F06 WITH K50.F01
			                 REPLACE  F07 WITH K50.F11 
			                 REPLACE  F08 WITH K50.F12 
			                 REPLACE  F09 WITH IIF(INDEXSEEK(K50.F02,.T.,'D01','D011'),D01.F04,IIF(INDEXSEEK(K50.F02,.T.,'E02','E021'),E02.F04,'')) 
			                 REPLACE  F10 WITH K51.F15
			                 REPLACE  F11 WITH K51.F16
			                 REPLACE  F12 WITH K51.F17 
			                 REPLACE  F13 WITH K51.F18
			                 REPLACE  F14 WITH '2'
			                 REPLACE  F15 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
			                 REPLACE  F16 WITH K51.F03
			                 REPLACE  F17 WITH K51.F12
			                 REPLACE  F18 WITH K51.F13
			                 REPLACE  F19 WITH K51.F14
			                 IF K51.F10>=K50.F10		&&未沖銷金額 >= 沖帳金額  
			                     IF  K51.F10-K50.F10=0 
			                   	  SELECT K51
			                   	  DELETE
			                     ELSE 	
			                          REPLACE  K51.F08 WITH K50.F12
			                     	  REPLACE  K51.F09 WITH K51.F09-K50.F10	&&開單未沖金額
			                      	  REPLACE  K51.F10 WITH K51.F10-K50.F10	&&未沖銷金額   
			                     ENDIF  	
		                         ENDIF  			                 
			                 SELECT  K50
			                 REPLACE  F13 WITH '1'
			                 REPLACE  F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')			                                         
		                   ENDIF
	                    ENDFOR   
			            SELECT  K51_1
			            REPLACE  F13 WITH '1'               			            
        			    IF ALLTRIM(INT_ACC)<>'FALSE' AND !(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE)=ALLTRIM(INT_142) OR ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE)=ALLTRIM(INT_143))
********************************************************************轉會計傳票檔        			    
                           H='K00P '+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                           SELE A09
                           SEEK H            
                           IF !FOUND()                                                  &&如果為本月第一張訂單則重頭開始編號
	                          APPEND BLANK                                                
		                      REPLACE  F01 WITH 'K00P '
	                          REPLACE  F02 WITH  SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
	                          REPLACE  F05 WITH  LEFT(F02,2)+OMT4
	                          REPLACE  F06 WITH '應付帳款沖銷傳票'
		                      REPLACE  F08 WITH ALLTRIM(F05)+'p'+'0000'
                           ENDIF
	                       RLOCK()
	                       HX=VAL(RIGHT(ALLTRIM(F08),4))+1
	                       PO_NO=LEFT(F08,4)+PADL(ALLTRIM(STR(HX)),4,'0')
	                       REPLACE  F08 WITH PO_NO                                             &&記錄本訂單號碼,本月份後續的訂單號碼將以此往下編
	                       UNLOCK                 	                 			    
        			       SELECT &ACC1
        			       FOR I=1 TO 2
                               APPEND BLANK                                                                                            
                               REPLACE tran_no WITH PO_NO
                               REPLACE tran_date WITH left(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)+THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                               REPLACE cus_no WITH K50.F02                                  
                               REPLACE cus_name1 WITH D01.F04
                               REPLACE Yymm WITH LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                               REPLACE crea_d WITH DATE()  
                               REPLACE Res_cont WITH D01.F04+SPACE(2)+THISFORM.MTH_LIST.DISPLAYVALUE
                               REPLACE  seq WITH  PADL(ALLTRIM(STR(I)),2,'0')
                               REPLACE tran_no_og WITH RIGHT(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,8)
                               IF I=2
                                  REPLACE acc_no WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE
                                  REPLACE acc_name WITH IIF(SEEK(ALLTRIM(K51_1.F08),'ACN'),ACN.acc_name,'')
                                  REPLACE amt_c WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE              
                                  REPLACE chk_no WITH K51_1.F04
                                  REPLACE chk_date WITH DTOS(K51_1.F05)
                               ELSE
                                  REPLACE acc_no WITH INT_095
                                  REPLACE acc_name WITH '應付帳款'                                              
                                  REPLACE amt_d WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE 
                               ENDIF                                           			           			           			   
        			       ENDFOR
        			       HK=STUFF(THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE,13,0,PO_NO)
        			       SELECT K50
        			       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
        			       IF FOUND()
        			          DO WHILE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
        			             REPLACE F08 WITH HK
        			             SELECT K50
        			             SKIP
        			          ENDDO
        			       ENDIF
        			       SELECT K51_1
        			       REPLACE F08 WITH HK
                        ENDIF        			       
*******************************************************轉新撰會計傳票檔結束        			    			               
	                    =MESSAGEBOX('此單據沖帳成功',0+64,'提示訊息視窗')
	               ELSE
	                    =MESSAGEBOX('此單據已由別的工作站沖帳完成',0+64,'提示訊息視窗')
                  	    UNLOCK ALL
                  	    THISFORM.GRID1.SETFOCUS
                  	    RETURN
	               ENDIF
	               RELEASE ALL LIKE BK*    
	           ENDIF                         
                ENDIF
           ELSE
                DO FILE_IMPACT
	        UNLOCK ALL
	        RETURN
           ENDIF
       ENDIF 
       UNLOCK ALL
       THISFORM.GRID1.SETFOCUS  
  ENDPROC
**********  
 PROC VRT_BOTT.CLICK     &&反沖帳程序
       IF MESSAGEBOX('是否要將此筆資料進行反中帳!',4+32+256,'請確認') = 6	
           SELECT K51_1
           LOCK()
           IF RLOCK()
                IF K51_1.F13<>'1'
                     =MESSAGEBOX('此單據尚未沖帳完成,故不得進行反沖帳之動作',0+64,'提示訊息視窗')
                     UNLOCK ALL
                     THISFORM.GRID1.SETFOCUS
                     RETURN
                ELSE
                     SELECT K52
                     SET ORDER TO K524
                     SELE RECNO() FROM K50 WHERE K50.F01=K51_1.F01  AND F13='1' INTO ARRAY BK1
          	     JJ1=''                
	             IF  _TALLY>0   
	                 FOR I= 1 TO ALEN(BK1)
	                         JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
	                 ENDFOR    
	                 KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
	                 RLOCK(KK1,'K50')
	                 LL1=RLOCK(KK1,'K50')
	             ELSE
	                 LL1=.T.   
	             ENDIF   
	             IF LL1=.T. AND LEN(ALLTRIM(JJ1))>0
	              	 SELECT   K50
	                 FOR  I= 1 TO ALEN(BK1)                     
		                  SELECT   K50
		                  GO BK1(I) 
		                  SELECT  K51                                            &&立沖結餘明細帳庫存明細檔 
		                  SET ORDER TO K511
		                  SEEK K50.F09+K50.F02                                   
		                  IF FOUND()
		                      REPLACE  K51.F09 WITH K51.F09+K50.F10
			              REPLACE  K51.F10 WITH K51.F10+K50.F10
			          ELSE		             
			              SELECT K51
			              APPEND BLANK        
			              REPLACE  K51.F01 WITH K50.F09
			              REPLACE  K51.F02 WITH K50.F14
			              REPLACE  K51.F03 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F16,'')
			              REPLACE  K51.F04 WITH IIF(INDEXSEEK(K50.F02,.T.,'D01','D011'),D01.F06,IIF(INDEXSEEK(K50.F02,.T.,'E02','E021'),E02.F13,''))
			              REPLACE  K51.F05 WITH K50.F11
			              REPLACE  K51.F06 WITH K50.F02
			              REPLACE  K51.F07 WITH K50.F16
			              REPLACE  K51.F08 WITH K50.F12
			              REPLACE  K51.F09 WITH K50.F10
			              REPLACE  K51.F10 WITH K50.F16
			              REPLACE  K51.F11 WITH IIF(INDEXSEEK(K50.F02,.T.,'D01','D011'),D01.F04,IIF(INDEXSEEK(K50.F02,.T.,'E02','E021'),E02.F04,''))
			              REPLACE  K51.F12 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F17,'')
			              REPLACE  K51.F13 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F18,0)
			              REPLACE  K51.F14 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F19,0)
			              REPLACE  K51.F15 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F10,CTOD(''))
			              REPLACE  K51.F16 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F11,'')
			              REPLACE  K51.F17 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F12,'')
			              REPLACE  K51.F18 WITH IIF(SEEK(K50.F01+K50.F07,'K52'),K52.F13,'')		
			              REPLACE  K51.F19 WITH '2'
			              REPLACE  K51.F20 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
			          ENDIF  	
			          SELECT  K52                                         &&已沖帳款月報表
			          SET ORDER TO K524
			          SEEK K50.F01
			          IF FOUND()
			              DELETE 
			          ENDIF
			          SELECT  K5F  
			          SET ORDER TO K5F4   && F06+F01                                      
			          SEEK K50.F01
			          IF FOUND()
			              DELETE 
			          ENDIF			      
			          SELECT  K50
			          REPLACE  F13 WITH ''
			          REPLACE  F90 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
			          SELECT  K51_1
			          REPLACE  F13 WITH ''		                          
	                 ENDFOR   
	                 =MESSAGEBOX('此單據反沖帳成功',0+64,'提示訊息視窗')
	                  RELEASE ALL LIKE BK*    
	             ELSE
	             	  =MESSAGEBOX('此單據已由別的工作站反沖帳完成',0+64,'提示訊息視窗')
                  	 UNLOCK ALL
                  	 THISFORM.GRID1.SETFOCUS
                  	 RETURN
                     ENDIF
                ENDIF
           ELSE
                DO FILE_IMPACT
	        UNLOCK ALL
	        RETURN
           ENDIF
      ENDIF   
      UNLOCK ALL
      THISFORM.GRID1.SETFOCUS
 ENDPROC   
ENDDEFINE    
***********************************************列印程序
PROCEDURE PNT_PRC  
   
ENDPROC
**********************************************客戶
DEFINE CLASS TXTF02 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE     
    SELECT F06 FROM K51 WHERE K51.F19='2'  ORDER BY F06 GROUP BY F06 INTO CURSOR K51_TEMP
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
         IF AT('?',ALLTRIM(THIS.VALUE))>1             
             SELECT F02,F01,F04 FROM DE01 INTO CURSOR VDR ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
         ELSE
             SELECT DE01.F02,DE01.F01,DE01.F04 FROM DE01,K51_TEMP WHERE DE01.F01=K51_TEMP.F06  INTO CURSOR VDR ORDER BY F01
         ENDIF          
         VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
         VDR_SEEK.SHOW    
         THIS.VALUE=FLG
         THIS.REFRESH
         FLG='0'        
    ENDIF    
    THISFORM.PAGEFRAME1.PAGE1.LBLF021.CAPTION=IIF(SEEK(ALLTRIM(THIS.VALUE),'DE01'),DE01.F04,'') 
    SELECT K51_TEMP
    USE
  ENDPROC
ENDDEFINE
********************************************************************付款方式
DEFINE CLASS PAYMENT_TYPE AS COMBOBOX    
   HEIGHT=INT_015*25
   WIDTH=INT_015*129
   FONTSIZE=INT_015*9 
   ROWSOURCETYPE=1
   VALUE=1
   STYLE=2
   NAME='PAYMENT_TYPE'
 PROCEDURE INIT
   THIS.ADDITEM('現金')
   THIS.ADDITEM('支票')
   THIS.ADDITEM('銀行存款')   
   THIS.ADDITEM('進貨退出')
   THIS.ADDITEM('進貨折讓')
   THIS.ADDITEM('其他')   
   IF ALLTRIM(INT_ACC)='FALSE'
      THIS.ADDITEM('匯費')
      THIS.ADDITEM('郵資')
   ENDIF   
 ENDPROC  
   PROCEDURE INTERACTIVECHANGE 	 
     IF ALLTRIM(INT_ACC)<>'FALSE'
        THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE=ICASE(THIS.Value=1,INT_093,THIS.Value=2,INT_097,THIS.Value=3,INT_106,THIS.Value=4,INT_142,THIS.Value=5,INT_143,'')
     ENDIF         
     IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
            THISFORM.PAGEFRAME1.PAGE1.LBLF04.VISIBLE=.T.
       	    THISFORM.PAGEFRAME1.PAGE1.LBLF05.VISIBLE=.T.
       	    THISFORM.PAGEFRAME1.PAGE1.TXTF04.VISIBLE=.T.
       	    THISFORM.PAGEFRAME1.PAGE1.TXTF05.VISIBLE=.T.
       	    THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.    
       	    THISFORM.PAGEFRAME1.PAGE1.TXTF05.READONLY=.F.     
            THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
            THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=DATE()
       ELSE
       	    THISFORM.PAGEFRAME1.PAGE1.LBLF04.VISIBLE=.F.
       	    THISFORM.PAGEFRAME1.PAGE1.LBLF05.VISIBLE=.F.
       	    THISFORM.PAGEFRAME1.PAGE1.TXTF04.VISIBLE=.F.
       	    THISFORM.PAGEFRAME1.PAGE1.TXTF05.VISIBLE=.F.
       ENDIF	    
  ENDPROC       
ENDDEFINE 
***************************************************特殊輸入欄位設定-----------沖帳科目編號
DEFINE CLASS TXTF08 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=10
  FONTSIZE=INT_015*9  
  PROCEDURE DBLCLICK   
      IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
         SELECT ACC_NO,ACC_NAME FROM ACN WHERE LEFT(ACC_NO,4)=ICASE(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=1,INT_093,THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2,INT_097,;
         THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=3,INT_106,THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=4,INT_142,THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=5,INT_143,'');
         AND ctrl$'13' AND acc_attr<>'9'  ORDER BY ACC_NO INTO CURSOR ACC    
         IF _TALLY>0
   		    ACC_SEEK=CREATEOBJECT("ACC_SEEK")  
		    ACC_SEEK.SHOW 		                   
		    THIS.Value=FLG
		 ELSE
		    =MESSAGEBOX('無此類別科目編號!',0+48,'提示訊息視窗')   
		    THIS.SetFocus
		    RETURN
         ENDIF
      ENDIF
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
      IF AT('?',ALLTRIM(THIS.VALUE))<>0
         IF AT('?',ALLTRIM(THIS.VALUE))>1             
            SELECT ACC_NO,ACC_NAME FROM ACN INTO CURSOR ACC ORDER BY ACC_NO WHERE LEFT(ACC_NO,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
         ELSE
            SELECT ACC_NO,ACC_NAME FROM ACN WHERE LEFT(ACC_NO,4)=ICASE(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=1,INT_093,THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2,INT_097,;
            THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=3,INT_106,THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=4,INT_142,THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=5,INT_143,'');
            AND ctrl$'13' AND acc_attr<>'9'  ORDER BY ACC_NO INTO CURSOR ACC    
         ENDIF
         IF _TALLY>0  
   		    ACC_SEEK=CREATEOBJECT("ACC_SEEK")  
		    ACC_SEEK.SHOW 		                   
		    THIS.Value=FLG
         ENDIF    
      ENDIF  
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------發票號碼
DEFINE CLASS TXTF09 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=10
  FONTSIZE=INT_015*9  
  PROCEDURE DBLCLICK   
       CHK_IN='0'
       IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
       	    IF USED('INV')=.T.
                 SELECT INV  
                 USE
            ENDIF  
            SELECT F09 FROM K50 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F09 INTO CURSOR K50_TEMP
	    SELECT  0,F01,F02,F10,F05,F07,F08,F09,F12,F13 FROM K51 WHERE K51.F06=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE AND K51.F19='2'  AND (K51.F10-K51.F09)>0 ;
	    ORDER BY K51.F02  INTO CURSOR INV READWRITE
	    ALTER TABLE INV ADD CHARGE  N(14,2)
  	    INDE ON F01 TAG INV_1
	    SELECT INV
	    SET ORDER TO INV_1
	    SELECT K50_TEMP
	    GO TOP
	    DO WHILE !EOF()
		   SELECT INV
		   SEEK K50_TEMP.F09
		   IF FOUND()
		        DELETE 
		   ENDIF
		   SELECT K50_TEMP
		   SKIP
	    ENDDO   
	    SELECT INV	 
	    IF _TALLY>0
		 INV_TYPE=CREATEOBJECT("INV_TYPE")  
		 INV_TYPE.SHOW    
		THIS.REFRESH
		SELECT INV
		CALC SUM(EXP_1) TO NO
		DO CASE
	              CASE NO=1 AND CHK_IN='1'
	           	         SELECT * FROM INV WHERE INV.EXP_1<>0 AND  INV.CHARGE<>0 ORDER BY INV.F01 INTO CURSOR INV_TEMP
		                 SELECT INV_TEMP	           	    
	           	         THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=INV_TEMP.F01
	           	         THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=INV_TEMP.CHARGE 	&&沖銷金額
		                 THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=INV_TEMP.F05			&&憑證單號
		                 THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=INV_TEMP.F08			&&發票備註
		                 THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=INV_TEMP.F02			&&發票日期
		                 THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=INV_TEMP.F07			&&發票總額
		                 SELECT INV_TEMP
		                 USE
	              CASE NO>1 AND CHK_IN='1'
		           	 SELECT * FROM INV WHERE INV.EXP_1<>0 AND INV.CHARGE<>0 ORDER BY INV.F01 INTO CURSOR INV_TEMP
			         SELECT INV_TEMP
			         GO TOP
			         DO WHILE !EOF()
				        SELECT  K50
					APPEND BLANK
				       	REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				        REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
				        REPLACE F03 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE))
				        REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
				        IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
				             REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
				        ENDIF
				        REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
				        REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				        REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE 
				        REPLACE F09 WITH INV_TEMP.F01
				        REPLACE F10 WITH INV_TEMP.CHARGE			             
				        REPLACE F11 WITH INV_TEMP.F05
				        REPLACE F12 WITH INV_TEMP.F08
				        REPLACE F14 WITH INV_TEMP.F02
				        REPLACE F16 WITH INV_TEMP.F07
				        REPLACE F15 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				        REPLACE F17 WITH '2'
				        SELECT K51_1
				        REPLACE K51_1.F10 WITH K51_1.F10+(K50.F10*(-1))
				        THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
				        SELECT K51
				        SET ORDER TO K511	&& F01+F06+DTOS(F02)
				        SEEK K50.F09+K50.F02
				        IF FOUND()
				            REPLACE K51.F09 WITH K51.F09+K50.F10
				        ENDIF  
				        SELECT INV_TEMP
				        SKIP  
			        ENDDO  
			        SELECT INV_TEMP
			        USE
				THISFORM.GRID2.ENABLED=.T.
				THISFORM.GRID2.SETFOCUS  
				THISFORM.GRID2.ENABLED=.F. 
				THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE='' 
				THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE='' &&沖銷金額
				THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''&&發票總額
				THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''&&憑證單號
			    	THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=''&&發票備註
				THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=''&&發票日期        	           
	        ENDCASE
		THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
		THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS     	  		
	    ELSE	
		=MESSAGEBOX('此對象於K09.立沖結餘明細(應付)中已無帳款可沖銷!',0+64,'提示訊息視窗') 
		THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
		RETURN     		
	    ENDIF  
       ENDIF
    ENDPROC       
 ****        
     PROCEDURE INTERACTIVECHANGE 
	CHK_IN='0'
	SELECT F09 FROM K50 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F09 INTO CURSOR K50_TEMP
	IF AT('?',ALLTRIM(THIS.VALUE))<>0 
	       IF USED('INV')=.T.
                    SELECT INV  
                    USE
                ENDIF  
		IF AT('?',ALLTRIM(THIS.VALUE))>1
			SELECT 0,F01,F02,F10,F05,F07,F08,F09,F12,F13 FROM K51 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) ;
         		AND K51.F06=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE AND K51.F19='2'  AND (K51.F10-K51.F09)>0;
         		ORDER BY K51.F02  INTO CURSOR INV READWRITE
         		ALTER TABLE INV ADD CHARGE  N(14,2)
         		INDE ON F01 TAG INV_1
		ELSE
          	   	SELECT 0,F01,F02,F10,F05,F07,F08,F09,F12,F13 FROM K51 WHERE K51.F06=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE;
          	   	AND K51.F19='2'  AND (K51.F10-K51.F09)>0 ORDER BY K51.F02  INTO CURSOR INV READWRITE
          	   	ALTER TABLE INV ADD CHARGE  N(14,2)
          	   	INDE ON F01 TAG INV_1
		ENDIF
		SELECT INV
		SET ORDER TO INV_1
		SELECT K50_TEMP
		GO TOP
		DO WHILE !EOF()
		       SELECT INV
		       SEEK K50_TEMP.F09
		       IF FOUND()
		            DELETE 
		       ENDIF
		       SELECT K50_TEMP
		       SKIP
		ENDDO
		SELECT INV
		IF _TALLY>0
		       INV_TYPE=CREATEOBJECT("INV_TYPE")  
		       INV_TYPE.SHOW    
		       THIS.REFRESH
		       ***
		        SELECT INV
			CALC SUM(EXP_1) TO NO
			DO CASE
			      CASE NO=1 AND CHK_IN='1'
		        	         SELECT * FROM INV WHERE INV.EXP_1<>0 AND  INV.CHARGE<>0 ORDER BY INV.F01 INTO CURSOR INV_TEMP
			                 SELECT INV_TEMP	           	    
		           	        THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE=INV_TEMP.F01
		           	        THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=INV_TEMP.CHARGE 	&&沖銷金額
			                THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=INV_TEMP.F05			&&憑證單號
			                THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=INV_TEMP.F08			&&發票備註
			                THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=INV_TEMP.F02			&&發票日期
			                THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=INV_TEMP.F07			&&發票總額
			                SELECT INV_TEMP
			                USE
		             CASE NO>1 AND CHK_IN='1'
			           	SELECT * FROM INV WHERE INV.EXP_1<>0 AND INV.CHARGE<>0 ORDER BY INV.F01 INTO CURSOR INV_TEMP
				        SELECT INV_TEMP
				        GO TOP
				        DO WHILE !EOF()
				              SELECT  K50
					      APPEND BLANK
				       	      REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				              REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
				              REPLACE F03 WITH ALLTRIM(STR(THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE))
				              REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
				              IF THISFORM.PAGEFRAME1.PAGE1.PAYMENT_TYPE.VALUE=2
				          	   REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
				              ENDIF
				              REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF06.VALUE
				              REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				              REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF08.VALUE 
				              REPLACE F09 WITH INV_TEMP.F01
				              REPLACE F10 WITH INV_TEMP.CHARGE			             
				              REPLACE F11 WITH INV_TEMP.F05
				              REPLACE F12 WITH INV_TEMP.F08
				              REPLACE F14 WITH INV_TEMP.F02
				              REPLACE F16 WITH INV_TEMP.F07
				              REPLACE F15 WITH IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
				              REPLACE F17 WITH '2'
				              SELECT K51_1
				              REPLACE K51_1.F10 WITH K51_1.F10+(K50.F10*(-1))
				              THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
				              SELECT K51
				              SET ORDER TO K511	&& F01+F06+DTOS(F02)
				              SEEK K50.F09+K50.F02
				              IF FOUND()
				                  REPLACE K51.F09 WITH K51.F09+K50.F10
				              ENDIF  
				              SELECT INV_TEMP
				              SKIP  
			               ENDDO  
			               SELECT INV_TEMP
			               USE
				       THISFORM.GRID2.ENABLED=.T.
				       THISFORM.GRID2.SETFOCUS
				       THISFORM.GRID2.ENABLED=.F.   
				       THISFORM.PAGEFRAME1.PAGE2.TXTF09.VALUE='' 
				       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE='' &&沖銷金額
				       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=''&&發票總額
				       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''&&憑證單號
			    	       THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=''&&發票備註
				       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=''&&發票日期        	           
			 ENDCASE
			 SELECT INV
			 USE
			 THISFORM.PAGEFRAME1.PAGE2.ACC_AMOUNT1.CAPTION=ALLTRIM(TRANSFORM(K51_1.F10,'@R 999,999,999,999.99'))
			 THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS     	    	       
		ELSE	       
		       =MESSAGEBOX('此對象於K09.立沖結餘明細(應付)中已無帳款可沖銷!',0+64,'提示訊息視窗') 
		       THISFORM.PAGEFRAME1.PAGE2.TXTF09.SETFOCUS
		       RETURN           	       
		ENDIF 
	ELSE
	       THISFORM.PAGEFRAME1.PAGE2.TXTF10.VALUE=IIF(INDEXSEEK(THIS.VALUE,.T.,'K51','K511'),K51.F10-K51.F09,'') &&沖銷金額
	       THISFORM.PAGEFRAME1.PAGE2.TXTF16.VALUE=IIF(INDEXSEEK(THIS.VALUE,.T.,'K51','K511'),K51.F07,'')&&發票總額
	       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=IIF(INDEXSEEK(THIS.VALUE,.T.,'K51','K511'),K51.F05,'')&&憑證單號
	       THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=IIF(INDEXSEEK(THIS.VALUE,.T.,'K51','K511'),K51.F08,'')&&發票備註
	       THISFORM.PAGEFRAME1.PAGE2.TXTF14.VALUE=IIF(INDEXSEEK(THIS.VALUE,.T.,'K51','K511'),K51.F02,'')&&發票日期		
        ENDIF
    ENDPROC    
ENDDEFINE  
*****************發票號碼搜尋畫面
DEFINE CLASS INV_TYPE AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION='發票編號一纜表'
  TOP=INT_015*150
  LEFT=INT_015*60     
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*250
  WIDTH=INT_015*650
  MAXBUTTON=.F.
  MINBUTTON=.F.  
*!*	  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='INV_TYPE'
  ADD OBJECT GRDD01 AS GRID WITH;     
      AUTOCENTER=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      TOP=0,;
      WIDTH=INT_015*650,;      
      HEIGHT=INT_015*220,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=10,;            
      RECORDSOURCE='INV',;    
      NAME='GRDD01',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;  
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',; 
      COLUMN5.NAME='COLUMN5',;  
      COLUMN6.NAME='COLUMN6',; 
      COLUMN7.NAME='COLUMN7',;      
      COLUMN8.NAME='COLUMN8',;  
      COLUMN9.NAME='COLUMN9',; 
      COLUMN10.NAME='COLUMN10'  
 ADD OBJECT LABEL1 AS LABEL WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*450,;
      TOP=INT_015*230,;
      AUTOSIZE=.T.,;
       CAPTION='付款餘額'     
 ADD OBJECT TXTF1 AS TEXTBOX WITH;
      VISIBLE=.T.,;
      LEFT=INT_015*502,;
      TOP=INT_015*223,;
      WIDTH=INT_015*85,;
      HEIGHT=INT_015*25,;      
      ALIGNMENT=1,;
      INPUTMASK='99999999999.99',; 
      MAXLENGTH=14,;   
      NAME='TXTF1'           
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*230,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*222,;        
      WIDTH=INT_015*80,;      
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.確定',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*320,;
      TOP=INT_015*222,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*50,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*222,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.全選',;
      TOOLTIPTEXT='全選所有資料!快速鍵->ALT+A'
      NAME='CMND3'
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*130,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*222,;        
      WIDTH=INT_015*80,;   
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.清除',;
      TOOLTIPTEXT='清除已全選之資料!快速鍵->ALT+C'
      NAME='CMND4'            
 PROCEDURE INIT 
         THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
         THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')                
         THISFORM.GRDD01.SETALL('FONTSIZE',INT_015*9,'COLUMN') 
         THISFORM.GRDD01.SETALL('FONTSIZE',INT_015*9,'HEADER') 
          THISFORM.SETALL('MOVABLE',.F.,'COLUMN')  
         THISFORM.TXTF1.VALUE=K51_1.F10
         THISFORM.GRDD01.COLUMN1.HEADER1.CAPTION=''
         THISFORM.GRDD01.COLUMN1.WIDTH=INT_015*20
         THISFORM.GRDD01.COLUMN1.CONTROLSOURCE='INV.EXP_1'
         THISFORM.GRDD01.COLUMN2.HEADER1.CAPTION='發票號碼'
         THISFORM.GRDD01.COLUMN2.WIDTH=INT_015*75
         THISFORM.GRDD01.COLUMN2.CONTROLSOURCE='INV.F01'
         THISFORM.GRDD01.COLUMN3.HEADER1.CAPTION='發票日期'
         THISFORM.GRDD01.COLUMN3.WIDTH=INT_015*65
         THISFORM.GRDD01.COLUMN3.CONTROLSOURCE='INV.F02'
         THISFORM.GRDD01.COLUMN4.HEADER1.CAPTION='未沖銷金額'
         THISFORM.GRDD01.COLUMN4.WIDTH=INT_015*65
         THISFORM.GRDD01.COLUMN4.CONTROLSOURCE='INV.F10-INV.F09'
         THISFORM.GRDD01.COLUMN5.HEADER1.CAPTION='幣別'
         THISFORM.GRDD01.COLUMN5.WIDTH=INT_015*30
         THISFORM.GRDD01.COLUMN5.CONTROLSOURCE='INV.F12'        
         THISFORM.GRDD01.COLUMN6.HEADER1.CAPTION='匯率'
         THISFORM.GRDD01.COLUMN6.WIDTH=INT_015*65
         THISFORM.GRDD01.COLUMN6.CONTROLSOURCE='INV.F13'        
         THISFORM.GRDD01.COLUMN7.HEADER1.CAPTION='外幣未沖金額'
         THISFORM.GRDD01.COLUMN7.WIDTH=INT_015*80
         THISFORM.GRDD01.COLUMN7.CONTROLSOURCE="IIF(INV.F13=0,0,ROUND((INV.F10-INV.F09)/INV.F13,3))"        
         THISFORM.GRDD01.COLUMN8.HEADER1.CAPTION='沖銷金額'
         THISFORM.GRDD01.COLUMN8.WIDTH=INT_015*65
         THISFORM.GRDD01.COLUMN8.CONTROLSOURCE='INV.CHARGE'
         THISFORM.GRDD01.COLUMN9.HEADER1.CAPTION='備        註'
         THISFORM.GRDD01.COLUMN9.WIDTH=INT_015*130
         THISFORM.GRDD01.COLUMN9.CONTROLSOURCE='INV.F08'
         THISFORM.GRDD01.COLUMN10.HEADER1.CAPTION='憑證單號'
         THISFORM.GRDD01.COLUMN10.WIDTH=INT_015*100
         THISFORM.GRDD01.COLUMN10.CONTROLSOURCE='INV.F05'         
         THISFORM.GRDD01.SETFOCUS                  
         SELECT INV
         GO TOP
 ENDPROC 
 PROC GRDD01.INIT
	THISFORM.GRDD01.COLUMN1.READONLY=.F.
	THISFORM.GRDD01.COLUMN2.READONLY=.T.
	THISFORM.GRDD01.COLUMN3.READONLY=.T.
	THISFORM.GRDD01.COLUMN4.READONLY=.T.
	THISFORM.GRDD01.COLUMN5.READONLY=.T.
	THISFORM.GRDD01.COLUMN6.READONLY=.T.
	THISFORM.GRDD01.COLUMN7.READONLY=.T.
	THISFORM.GRDD01.COLUMN8.READONLY=.F.
	THISFORM.GRDD01.COLUMN9.READONLY=.F.
	THISFORM.GRDD01.COLUMN10.READONLY=.T.
	THISFORM.GRDD01.COLUMN8.HEADER1.BACKCOLOR=RGB(128,255,0)
	THISFORM.GRDD01.COLUMN9.HEADER1.BACKCOLOR=RGB(128,255,0)
	THISFORM.GRDD01.COLUMN1.removeobject("TEXT1")
	THISFORM.GRDD01.COLUMN1.AddObject("CheckBox1","CheckBox1") 
	THISFORM.GRDD01.COLUMN1.CurrentControl="CheckBox1" 
	THISFORM.GRDD01.COLUMN1.Sparse=.F.
	THISFORM.GRDD01.COLUMN1.CheckBox1.Visible=.T.
	THISFORM.GRDD01.COLUMN1.CheckBox1.CAPTION=''
	THISFORM.GRDD01.COLUMN1.CheckBox1.AUTOSIZE=.T.
	THISFORM.GRDD01.COLUMN1.CheckBox1.CENTERED=.T.
	THISFORM.GRDD01.COLUMN1.CheckBox1.BACKSTYLE=0
	THISFORM.GRDD01.COLUMN1.CheckBox1.LEFT=5
	THISFORM.GRDD01.COLUMN8.removeobject("TEXT1")
	THISFORM.GRDD01.COLUMN8.AddObject("TEXTBOX1","TEXTBOX1") 
	THISFORM.GRDD01.COLUMN8.CurrentControl="TEXTBOX1" 
	THISFORM.GRDD01.COLUMN8.Sparse=.F.	
	THISFORM.GRDD01.COLUMN8.TEXTBOX1.Visible=.T.
	THISFORM.GRDD01.COLUMN9.removeobject("TEXT1")
	THISFORM.GRDD01.COLUMN9.AddObject("TEXTBOX2","TEXTBOX") 
	THISFORM.GRDD01.COLUMN9.CurrentControl="TEXTBOX2" 
	THISFORM.GRDD01.COLUMN9.Sparse=.F.	
	THISFORM.GRDD01.COLUMN9.TEXTBOX2.Visible=.T.		
  ENDPROC 
  PROC GRDD01.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
*!*	       THISFORM.GRDD01.SETALL("DYNAMICBACKCOLOR","IIF(INV.EXP_1=1,RGB(255,255,128),'')","COLUMN") 
	  SELECT  SUM(CHARGE) FROM INV WHERE INV.EXP_1<>0 INTO CURSOR INV_TEMP
	  THISFORM.TXTF1.VALUE=K51_1.F10-INV_TEMP.SUM_CHARGE
	  THISFORM.GRDD01.SETFOCUS
	  SELECT INV_TEMP
	  USE     
   ENDPROC 
   **
 PROCEDURE CMND1.CLICK
      SELECT INV
      CALC SUM(CHARGE) TO SUM_CHARGE
      DO CASE
             CASE  (K51_1.F10-SUM_CHARGE)<0
                        =MESSAGEBOX('總沖銷金額大於付款餘額,請重新輸入!!',0+64,'提示訊息視窗') 
                        GO TOP
                        THISFORM.GRDD01.SETFOCUS      
             CASE  SUM_CHARGE>K51_1.F10
                        =MESSAGEBOX('總沖銷金額大於付款餘額,請重新輸入!!',0+64,'提示訊息視窗') 
                        GO TOP
                        THISFORM.GRDD01.SETFOCUS
             CASE  SUM_CHARGE<0
                        =MESSAGEBOX('總沖銷金額呈現負數,請重新輸入!!',0+64,'提示訊息視窗') 
                        GO TOP
                        THISFORM.GRDD01.SETFOCUS                       
            OTHERWISE     
		         CHK_IN='1'
		         SELECT K50_TEMP
		         USE
		         THISFORM.RELEASE 
       ENDCASE        
 ENDPROC
 PROCEDURE CMND2.CLICK
      CHK_IN='0'
      SELECT K50_TEMP
      USE      
      THISFORM.RELEASE
 ENDPROC  
 **
 PROCEDURE CMND3.CLICK     
      SELECT INV
      RE=RECNO('INV')
      GO TOP
      DO WHILE !EOF()
	     REPLACE INV.EXP_1 WITH 1 
	     REPLACE INV.CHARGE WITH INV.F10-INV.F09
	     SELECT INV
	     SKIP
      ENDDO
      CALC SUM(CHARGE) TO SUM_CHARGE
      THISFORM.TXTF1.VALUE=K51_1.F10-SUM_CHARGE
      SELECT INV
      GO RE  
      THISFORM.GRDD01.SETFOCUS 
 ENDPROC      
  PROCEDURE CMND4.CLICK
      SELECT INV
      RE=RECNO('INV')
      GO TOP
      DO WHILE !EOF()
             REPLACE INV.EXP_1 WITH 0 
             REPLACE INV.CHARGE WITH 0
             SELECT INV
             SKIP
      ENDDO
      SELECT INV
      GO RE
      THISFORM.TXTF1.VALUE=K51_1.F10
      THISFORM.GRDD01.SETFOCUS 
 ENDPROC 
  PROC CMND1.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND1.TOP=INT_015*223
             THISFORM.CMND1.LEFT=INT_015*231
  ENDPROC     
  PROC CMND1.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND1.TOP=INT_015*222
             THISFORM.CMND1.LEFT=INT_015*230                  
  ENDPROC  
  PROC CMND2.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND2.TOP=INT_015*223
             THISFORM.CMND2.LEFT=INT_015*321
  ENDPROC     
  PROC CMND2.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND2.TOP=INT_015*222
             THISFORM.CMND2.LEFT=INT_015*320                  
  ENDPROC  
  PROC CMND3.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND3.TOP=INT_015*223
             THISFORM.CMND3.LEFT=INT_015*51
  ENDPROC     
  PROC CMND3.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND3.TOP=INT_015*222
             THISFORM.CMND3.LEFT=INT_015*50                  
  ENDPROC   
  PROC CMND4.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND4.TOP=INT_015*223
             THISFORM.CMND4.LEFT=INT_015*131
  ENDPROC     
  PROC CMND4.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND4.TOP=INT_015*222
             THISFORM.CMND4.LEFT=INT_015*130                  
  ENDPROC    
ENDDEFINE   
*********     
DEFINE CLASS CheckBox1 AS CheckBox
      PROCEDURE CLICK
         SELECT INV
         IF THIS.VALUE=1
              REPLACE INV.EXP_1 WITH 1
              REPLACE INV.CHARGE WITH INV.F10-INV.F09
              THISFORM.TXTF1.VALUE=THISFORM.TXTF1.VALUE-INV.CHARGE
         ELSE
              REPLACE INV.EXP_1 WITH 0
              THISFORM.TXTF1.VALUE=THISFORM.TXTF1.VALUE+INV.CHARGE
              REPLACE INV.CHARGE WITH 0
         ENDIF
         THISFORM.GRDD01.SETFOCUS     
   ENDPROC 
ENDDEFINE 
*********     
DEFINE CLASS TEXTBOX1 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT INV
         IF INV.EXP_1=1
             DO CASE
                   CASE THIS.VALUE<0
                    	      THIS.VALUE=INV.F10-INV.F09
                    	      REPLACE INV.CHARGE WITH INV.F10-INV.F09
                    	      =MESSAGEBOX('沖銷金額不得小於零,請重新輸入!!',0+64,'提示訊息視窗')
                    	      THISFORM.GRDD01.SETFOCUS                         
                   CASE (INV.F10-INV.F09)<THIS.VALUE
                    	      THIS.VALUE=INV.F10-INV.F09
                    	      REPLACE INV.CHARGE WITH INV.F10-INV.F09                   
                               =MESSAGEBOX('沖銷金額不得大於未沖銷金額,請重新輸入!!',0+64,'提示訊息視窗') 
                               THISFORM.GRDD01.SETFOCUS     			      	
		   OTHERWISE 	
			      THISFORM.TXTF1.VALUE=THISFORM.TXTF1.VALUE-THIS.VALUE 
			      THISFORM.GRDD01.SETFOCUS		         
             ENDCASE              
         ENDIF  
   ENDPROC 
ENDDEFINE 
**************************************沖帳會計科目搜尋畫面         
DEFINE CLASS ACC_SEEK AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION='會計科目編號一纜表'
  TOP=INT_015*150
  LEFT=INT_015*200      
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*250
  WIDTH=INT_015*350
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ACC_SEEK'
  ADD OBJECT GRDD01 AS GRID WITH;          
      AUTOCENTER=.T.,;
      TOP=0,;
      WIDTH=INT_015*350,;      
      HEIGHT=INT_015*220,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      ALLOWCELLSELECTION=.F.,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=2,;            
      RECORDSOURCE='ACC',;      
      NAME='GRDD01',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2'      
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*75,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*223,;        
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\HARROW.CUR',;        
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*200,;
      TOP=INT_015*223,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;     
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\HARROW.CUR',;         
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      NAME='CMND2'
 PROCEDURE INIT 
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN')
         THISFORM.GRDD01.SETALL('FONTSIZE',INT_015*9,'COLUMN') 
         THISFORM.GRDD01.SETALL('FONTSIZE',INT_015*9,'HEADER')          
         THISFORM.GRDD01.COLUMN1.HEADER1.CAPTION='科目編號'
         THISFORM.GRDD01.COLUMN1.WIDTH=INT_015*100
         THISFORM.GRDD01.COLUMN1.CONTROLSOURCE='ACC.ACC_NO'
         THISFORM.GRDD01.COLUMN2.HEADER1.CAPTION='科目名稱'
         THISFORM.GRDD01.COLUMN2.WIDTH=INT_015*129
         THISFORM.GRDD01.COLUMN2.CONTROLSOURCE='ACC.ACC_NAME'
         THISFORM.GRDD01.SETFOCUS
         IF THISFORM.GRDD01.ACTIVEROW<>0
              THISFORM.GRDD01.AFTERROWCOLCHANGE 
         ENDIF 
 ENDPROC
 PROCEDURE  GRDD01.AFTERROWCOLCHANGE
     LPARAMETERS NCOLINDEX
          FLG=ACC.ACC_NO
 ENDPROC 
 PROCEDURE CMND1.CLICK                               
          THISFORM.RELEASE      
          CLEAR EVENT          
 ENDPROC
 PROCEDURE CMND2.CLICK
          FLG=''   
          THISFORM.RELEASE
  ENDPROC      
ENDDEFINE  
**************
FUNC BILL
     PARA JUK
     JO=''
     DO CASE
        CASE JUK='1'
             JO='現金'
        CASE JUK='2'
             JO='支票'
        CASE JUK='3'
             JO='銀行存款'
        CASE JUK='4'
             JO='進貨退出'             
        CASE JUK='5'
             JO='進貨折讓'                          
        CASE JUK='6'  
             JO='其他'                                      
        CASE JUK='7'  
             JO='匯費'
        CASE JUK='8'  
             JO='郵資'                                         
     ENDCASE
     RETURN JO   
**********************
