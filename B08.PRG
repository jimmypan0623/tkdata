***程式名稱:製令領料單
close all
clear 
FLG='0'
FCH=''
CHK=''
CHK_STR=''
R=0
QTY=0
TQTY=0
HD1='B007 '
HD2='BP'
HD3='製令領料單'
AREA1='B08_1'
AREA2='B08'

IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1         
IF !USED('C20')
   SELE 0
   USE C20
ELSE
   SELE C20
ENDIF
SET ORDER TO 1
IF !USED('C03')
   SELECT 0
   USE C03
ELSE
   SELECT 0
   USE C03
ENDIF
SET ORDER TO C031      
IF !USED('E11')
   SELE 0
   USE E11
ELSE
   SELE E11
ENDIF
SET ORDER TO E111     
IF !USED('E16')
   SELE 0
   USE E16
ELSE
   SELE E16
ENDIF
SET ORDER TO E164      

B25='B25'+LEFT(DTOS(DATE()),6)    &&部門別月報表
IF !USED('&B25')
   SELE 0
   USE (B25) ALIA B25
ELSE
   SELE B25
ENDIF
SET ORDER TO 1      
B26='B26'+LEFT(DTOS(DATE()),6)   &&庫存異動記錄
IF !USED('&B26')
   SELE 0
   USE (B26) ALIA B26
ELSE
   SELE B26
ENDIF
SET ORDER TO 1      
B39='B39'+LEFT(DTOS(DATE()),6)   &&未過帳單據查詢檔
IF !USED('&B39')
   SELE 0
   USE (B39) ALIA B39
ELSE
   SELE B39
ENDIF
SET ORDER TO 1      
SELE A23
SET ORDER TO 1
SEEK LEFT(DTOS(DATE()),6)+'01'
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK sys_oper+'B08'
IF !USED('A14')
   SELE 0
   USE A14
ELSE 
   SELE A14
ENDIF
SET ORDER TO 1
SET FILTER TO F04='*'
CREATE CURSOR A14_1 (F01 C(5),F02 C(8))
INDE ON F01 TAG A14_11
SELE F01,F02 FROM A14 WHERE F04='*' AND F05='*' INTO CURSOR A14_2 ORDER BY F01
GO TOP
DO WHILE !EOF()
   SELE A14_1
   APPEND BLANK
   REPL F01 WITH A14_2.F01
   REPL F02 WITH A14_2.F02
   SELE A14_2
   SKIP
ENDDO   
SELE A14_2
USE 
SELE A14_1
SET ORDER TO 1     
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1   
set filter to !EMPTY(F98)  
IF !USED('B11')
   SELE 0
   USE B11 
ELSE
   SELE B11
ENDIF
SET ORDER TO B111 
B08='B08'+LEFT(DTOS(DATE()),6)
B081='B081'+LEFT(DTOS(DATE()),6)
IF !USED('&B08')
   SELE 0
   USE (B08) ALIA B08
ELSE
   SELE B08
ENDIF
SET ORDER TO 1      
SET RELA TO F08 INTO B01
SET RELATION TO F07+F08 INTO B11 ADDITIVE 
CREATE CURSOR B08_1;
(F01 C(10),F02 C(2),F07 C(5),F13 C(1),F04 C(5),F06 C(17),F90 C(17))
INDE ON F01 TAG B08_11
INDE ON F07 TAG B08_12
INDE ON F04 TAG B08_13
SET RELA TO F07 INTO A14 
SET RELA TO F04 INTO A14_1 ADDI
SELE F01,F02,F07,F13,F04,F06,F90 FROM B08 GROUP BY F01 ORDER BY F01 INTO CURSOR B08_2
SELE B08_2
GO TOP
DO WHILE !EOF()
   SELE B08_1
   APPEND BLANK
   REPL F01 WITH B08_2.F01
   REPL F02 WITH B08_2.F02
   REPL F07 WITH B08_2.F07
   REPL F13 WITH B08_2.F13 
   REPL F04 WITH B08_2.F04
   REPL F06 WITH B08_2.F06
   REPL F90 WITH B08_2.F90
   SELE B08_2
   SKIP   
ENDDO
SELE B08_2
USE   
SELE B08_1
SET ORDER TO 1
B08form=createobject("tkB08")
B08form.show  
define class tkB08 as form
  caption='B08.製令領料單'
  controlbox=.F.
  BORDERSTYLE=3  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  controlcount=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  showtips=.t.
  showwindow=1
  WIDTH=INT_015*789
  windowtype=1
  NAME='TKB08'
  add object shape1 as shape1 with;
      autocenter=.t.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  with;
      caption=str(reccount())        
  add object shape2 as shape2 with;
      autocenter=.t.
  add object shape3 as shape3 with;
      autocenter=.t.            
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*200,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      autocenter=.t.,;
      WIDTH=INT_015*130
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
      autocenter=.t.
  ADD OBJECT grid1 AS grid1 WITH;
      columncount=5,;            
      RECORDSOURCE='B08_1',;      
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'      
  ADD OBJECT grid2 AS grid2 WITH;
      columncount=6,;            
      RECORDSOURCE='B08',; 
      LINKMASTER='B08_1',;
      RELATIONALEXPR='F01',;
      childorder=B081,;  
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*173,;
      LEFT=INT_015*558          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*13,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;      
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.過帳',;
      NAME='ANS_BOTT'             
ADD OBJECT VRT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*55,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*55,;      
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\harrow.cur',;   
      TOOLTIPTEXT='將已過入庫存及帳款之資料轉回未過帳狀態!快速鍵->ALT+V',;      
      CAPTION='\<V.反過帳',;
      NAME='VRT_BOTT'           
 ADD OBJECT CHGMT_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*112,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*45,;
      CAPTION='\<C.換料',;
      NAME='CHGMT_BOTT'                             
 ADD OBJECT EXCEL_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*160,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*65,;
      CAPTION='\<T.轉EXCEL',;
      NAME='EXCEL_BOTT'                 
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*13
          .WIDTH=INT_015*50
          .CAPTION='領用單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF07','LABEL')     
     WITH THIS.LBLF07
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*63
          .WIDTH=INT_015*50  
          .CAPTION='發料部門'
     ENDWITH            
     THIS.ADDOBJECT('LBLF071','LABEL')     
     WITH THIS.LBLF071
          .VISIBLE=.T.
          .LEFT=INT_015*115
          .TOP=INT_015*63
          .AUTOSIZE=.T.
     ENDWITH                 
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='領用部門'
     ENDWITH    
     THIS.ADDOBJECT('LBLF041','LABEL')
     WITH THIS.LBLF041
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*88
         .AUTOSIZE=.T. 
     ENDWITH    
*!*	     THIS.ADDOBJECT('LBLF08','LABEL')
*!*	     WITH THIS.LBLF08
*!*	         .VISIBLE=.T.
*!*	         .LEFT=INT_015*14
*!*	         .TOP=INT_015*138
*!*	         .WIDTH=INT_015*50
*!*	         .CAPTION='備註說明'
*!*	     ENDWITH    
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*13
         .WIDTH=INT_015*50
         .CAPTION='領用日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLF13','LABEL')
     WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*38
         .WIDTH=INT_015*50
         .CAPTION='過  帳  碼'
     ENDWITH    
     THIS.ADDOBJECT('LBLF131','LABEL')
     WITH THIS.LBLF131
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*38
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*63
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF061','LABEL')
     WITH THIS.LBLF061
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*63
         .AUTOSIZE=.T.
     ENDWITH    
     THIS.ADDOBJECT('LBLF90','LABEL')
     WITH THIS.LBLF90
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*88
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF901','LABEL')
     WITH THIS.LBLF901
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*88
         .AUTOSIZE=.T.
     ENDWITH        
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*9
          .WIDTH=INT_015*81
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF07','TXTF07')          
     WITH THIS.TXTF07
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*59
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
     THIS.ADDOBJECT('TXTF04','TXTF04')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*84
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH                               
*!*	     THIS.ADDOBJECT('TXTF08','TEXTBOX')          
*!*	     WITH THIS.TXTF08
*!*	          .VISIBLE=.T.
*!*	          .LEFT=INT_015*64
*!*	          .TOP=INT_015*134
*!*	          .WIDTH=INT_015*140
*!*	          .HEIGHT=INT_015*25
*!*	          .MAXLENGTH=15
*!*	     ENDWITH      
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*9
          .WIDTH=INT_015*40
          .HEIGHT=INT_015*25
          .MAXLENGTH=2
     ENDWITH        
  ENDPROC   
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF08','LABEL')
	WITH THIS.LBLF08  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*18
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF081','LABEL')
    WITH THIS.LBLF081
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*18
	     .autosize=.t.
	ENDWITH     
	THIS.ADDOBJECT('LBLF05','LABEL')
	WITH THIS.LBLF05
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*43
	     .WIDTH=INT_015*50
         .CAPTION='製令編號'
    ENDWITH  	
    THIS.ADDOBJECT('LBLF10','Label')
    WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*68
         .WIDTH=INT_015*50
         .CAPTION='應領數量'         
    ENDWITH         
    THIS.ADDOBJECT('LBLF101','Label')
    WITH THIS.LBLF101
         .VISIBLE=.T.
         .LEFT=INT_015*64
         .TOP=INT_015*68
         .AUTOSIZE=.T.
         .CAPTION=''         
    ENDWITH             
    THIS.ADDOBJECT('LBLF12','Label')
    WITH THIS.LBLF12
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*93
         .WIDTH=INT_015*50
         .CAPTION='領用數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF03','Label')
    WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*118
         .WIDTH=INT_015*50
         .CAPTION='備料單號'         
    ENDWITH         
    THIS.ADDOBJECT('LBLF031','Label')
    WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*65
         .TOP=INT_015*118
         .AUTOSIZE=.T.
         .CAPTION=''         
    ENDWITH             
    THIS.ADDOBJECT('LBLF7911','LABEL')
    WITH THIS.LBLF7911
         .VISIBLE=INT_029       
         .LEFT=INT_015*14
         .TOP=INT_015*143
         .AUTOSIZE=.T.
         .CAPTION='在庫數量'
    ENDWITH                
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
        .VISIBLE=.T.           
        .LEFT=INT_015*328
        .TOP=INT_015*143
        .WIDTH=INT_015*50
        .CAPTION='安全資料'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF061','LABEL')
    WITH THIS.LBLF061
        .VISIBLE=.T.           
        .LEFT=INT_015*380
        .TOP=INT_015*143
        .AUTOSIZE=.T.
    ENDWITH    
	THIS.ADDOBJECT('TXTF08','TXTF08')
	WITH THIS.TXTF08      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*14
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF08'  
             .BACKCOLOR=RGB(255,255,100)	   
             .MOUSEPOINTER=99               
             .MOUSEICON='BMPS\harrow.cur'                  	                  
	ENDWITH     
	THIS.ADDOBJECT('TXTF05','TXTF05')
	WITH THIS.TXTF05      
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*39
	     .WIDTH=INT_015*90
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=12
	     .NAME='TXTF05'  
             .BACKCOLOR=RGB(255,255,100)	   
             .MOUSEPOINTER=99               
             .MOUSEICON='BMPS\harrow.cur'                         
             .MOUSEICON='BMPS\harrow.cur'                  	                        	     
	ENDWITH     	
	THIS.ADDOBJECT('TXTF12','TEXTBOX')
	WITH THIS.TXTF12
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*89
	     .WIDTH=INT_015*100
	     .HEIGHT=INT_015*25
	     .INPUTMASK='999999999.9999'
	     .NAME='TXTF12'	    
	ENDWITH     
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.activate
     R=0
     SELE B08_1
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B08_1.F13<>'2',RGB(255,0,0),'')","COLUMN")         
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS   
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.MTH_LIST.ENABLED=.T.
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
       THISFORM.MTH_LIST.ENABLED=.F.   
     ENDIF                
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.VRT_BOTT.ENABLED=.F.
        THISFORM.EXCEL_BOTT.ENABLED=.F.        
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''           
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B08_1.F13<>'2' &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B08_1.F13<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)    &&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B08_1.F13='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B08_1.F13),.F.,.T.)  .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED 
        THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F10='*',.T.,.F.)                
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
     ENDIF   
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.);
     .AND. !IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)
     THISFORM.CHGMT_BOTT.ENABLED=.F.
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.activate
     SELE B08
     IF THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.GRID2.READONLY=.T.   
        THISFORM.GRID2.SETFOCUS   
     ENDIF   
     IF THISFORM.GRID2.ACTIVEROW=0 .and. thisform.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.CHGMT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B08.F13<>'2'  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B08.F13<>'2' &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)  &&&&判斷有無列印的權限  
        THISFORM.ANS_BOTT.ENABLED=IIF(B08.F13='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
        THISFORM.CHGMT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B08.F13<>'2' .AND. !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   .AND. B08_1.F13<>'2' &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
     THISFORM.MTH_LIST.ENABLED=.F.     
    THISFORM.EXCEL_BOTT.ENABLED=.F.
   
  ENDPROC     
  PROC INIT       
       thisform.setall('height',INT_015*25,'textbox')
       thisform.setall('height',INT_015*17,'label')     
       thisform.setall('FONTSIZE',INT_015*9,'textbox')
       thisform.setall('FONTSIZE',INT_015*9,'label')         
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.EXCEL_BOTT.ENABLED=IIF(A02.F10='*',.T.,.F.)                       
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID1.setall('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='移轉單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='發料部門編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='發料部門簡稱'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='領用部門編號'
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='領用部門簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B08_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B08_1.F07'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE="A14.F02"       
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B08_1.F04'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'       
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(B08_1.F13<>'2',RGB(255,0,0),'')","COLUMN")         
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'COLUMN')
       thisform.GRID2.setall('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.grid2.COLUMN1.HEADER1.CAPTION='料品編號'       
       THISFORM.grid2.COLUMN2.HEADER1.CAPTION='製令號碼'
       THISFORM.grid2.COLUMN3.HEADER1.CAPTION='應領數量'
	   THISFORM.grid2.COLUMN4.HEADER1.CAPTION='領用數量'
	   THISFORM.grid2.COLUMN5.HEADER1.CAPTION='數量小計'	   
	   THISFORM.grid2.COLUMN6.HEADER1.CAPTION='在庫數量'	
	   THISFORM.GRID2.LINKMASTER='B08_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B08.F08'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B08.F05'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B08.F10'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B08.F12'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE="IIF(B08.F14>0,B08.F14,'')"
	   *THISFORM.grid2.COLUMN6.CONTROLSOURCE="IIF(B08.F14>0,B11.F04,'')"
	   THISFORM.grid2.COLUMN6.CONTROLSOURCE="B11.F04"
	   THISFORM.grid2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*80
       THISFORM.grid2.COLUMN3.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*80
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*90  
       THISFORM.GRID2.COLUMN6.WIDTH=INT_015*90      
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(B11.F04-B08.F14<0 AND B08.F14>0 AND EMPTY(B08.F13),RGB(255,255,0),'')","COLUMN")  
       THISFORM.grid1.READONLY=.T.      
       THISFORM.grid2.READONLY=.T.            
       THISFORM.grid1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B08_1.F13<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B08_1.F13<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限       
          THISFORM.ANS_BOTT.ENABLED=IIF(B08_1.F13='2',.F.,.T.)  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED
          THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B08_1.F13),.F.,.T.)  .AND. IIF(A02.F12='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED 
       ENDIF          
*       THISFORM.KEY_LIST.DISPLAYVALUE='依移轉單號排列'      
       JK='領用單號'
       SELE B08_1
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B08_1.F01
  ENDPROC               
  PROC KEY_LIST.INIT 
       with this 
           .additem('依領用單號排列')
           .additem('依發料部門排列')
           .additem('依領用部門排列')
           .VALUE=1
       endwith             
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE B08_1 
       DO CASE
          CASE THIS.DISPLAYVALUE='依領用單號排列'
               set order to 1 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='領用單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B08_1.F01'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='發料部門編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B08_1.F07'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='發料部門簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='領用部門編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B08_1.F04'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49               
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='領用部門簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80                                
          CASE THIS.DISPLAYVALUE='依發料部門排列'
               set order to 2
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='發料部門編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B08_1.F07'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='發料部門簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='領用單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B08_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81                                                   
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='領用部門編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B08_1.F04'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='領用部門簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*58                 
          CASE THIS.DISPLAYVALUE='依領用部門排列'
               set order to 3
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='領用部門編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B08_1.F04'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='領用部門簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='A14_1.F02'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='領用單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='B08_1.F01'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81               
               THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='發料部門編號'
               THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B08_1.F07'
               THISFORM.GRID1.COLUMN4.WIDTH=INT_015*49                  
               THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='發料部門簡稱'
               THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14.F02'
               THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80                                                            
       ENDCASE 
        THISFORM.grid1.SETFOCUS
  ENDPROC      
  PROC MTH_LIST.INTERACTIVECHANGE
       THISFORM.GRID1.RECORDSOURCE=''
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.LINKMASTER=''
       THISFORM.GRID2.RELATIONALEXPR=''
       THISFORM.GRID2.childorder=''

       SELECT A23
       SEEK DTOS(CTOD(THIS.DISPLAYVALUE+'/01'))
              
       SELE B25
       USE
       B25='B25'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B25')
          SELE 0
          USE (B25) ALIA B25
       ELSE
          SELE B25
       ENDIF
       SET ORDER TO 1                    
       SELE B26
       USE
       B26='B26'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B26')
          SELE 0
          USE (B26) ALIA B26
       ELSE
          SELE B26
       ENDIF
       SET ORDER TO 1                           
       SELE B39
       USE
       B39='B39'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B39')
          SELE 0
          USE (B39) ALIA B39
       ELSE
          SELE B39
       ENDIF
       SET ORDER TO 1                                  
       SELE B08
       set rela off into b01
       SET RELA OFF INTO B08_1
       SET RELATION OFF INTO B11
       USE
       SELE B08_1
       SET RELA OFF INTO A14
       SET RELA OFF INTO A14_1
       USE
       B08='B08'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       B081='B081'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&B08')
          SELE 0
          USE (B08) ALIA B08
       ELSE
          SELE B08
       ENDIF
       SET ORDER TO 1      
       SET RELA TO F08 INTO B01
       SET RELATION TO F07+F08 INTO B11 ADDI
       CREATE CURSOR B08_1;
       (F01 C(10),F02 C(2),F07 C(5),F13 C(1),F04 C(5),F06 C(17),F90 C(17))
       INDE ON F01 TAG B08_11
       INDE ON F07 TAG B08_12
       INDE ON F04 TAG B08_13
       SELE F01,F02,F07,F13,F04,F06,F90 FROM B08 GROUP BY F01 ORDER BY F01 INTO CURSOR B08_2
       SELE B08_2
       GO TOP
       DO WHILE !EOF()
          SELE B08_1
          APPEND BLANK
          REPL F01 WITH B08_2.F01
          REPL F02 WITH B08_2.F02
          REPL F07 WITH B08_2.F07         
          REPL F13 WITH B08_2.F13
          REPL F04 WITH B08_2.F04
          REPL F06 WITH B08_2.F06
          REPL F90 WITH B08_2.F90
          SELE B08_2
          SKIP
       ENDDO
       SELE B08_2
       USE   
       SELE B08_1
       SET ORDER TO 1
       SET RELA TO F07 INTO A14
       SET RELA TO F04 INTO A14_1 ADDI
       THISFORM.GRID1.RECORDSOURCE='B08_1'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='B08_1.F01'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='B08_1.F07'       
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='A14.F02'       
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='B08_1.F04'              
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='A14_1.F02'
       THISFORM.GRID2.RECORDSOURCE='B08'
	   THISFORM.GRID2.LINKMASTER='B08_1'
       THISFORM.GRID2.RELATIONALEXPR='F01'      
       THISFORM.GRID2.CHILDORDER=B081  
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B08.F08'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B08.F05'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B08.F10'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B08.F12'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE="IIF(B08.F14>0,B08.F14,' ')"
	   THISFORM.grid2.COLUMN6.CONTROLSOURCE="IIF(B08.F14>0,B11.F04,' ')"
       THISFORM.KEY_LIST.INTERACTIVECHANGE
	   THISFORM.PAGEFRAME1.ACTIVEPAGE=1
	   THISFORM.REFRESH
	   thisform.grid1.setfocus        
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F.
          THISFORM.VRT_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B08_1.F13<>'2'  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B08_1.F13<>'2' &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.ANS_BOTT.ENABLED=IIF(B08_1.F13='2',.F.,.T.)  .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED  
          THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B08_1.F13),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)             
       ENDIF          
*!*	       THISFORM.KEY_LIST.DISPLAYVALUE='依出貨單號排列'      
*!*	       JK='訂單編號'
*!*	       SELE B08_1
*!*	       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B08_1.F01	   
*       THISFORM.REFRESH       
  ENDPROC
  PROC grid1.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=B08_1.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=B08_1.F07
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=A14.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=B08_1.F04
       THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=A14_1.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=B08_1.F02
       THISFORM.PAGEFRAME1.PAGE1.lblF131.caption=B08_1.F13
       THISFORM.PAGEFRAME1.PAGE1.lblF061.caption=B08_1.F06
       THISFORM.PAGEFRAME1.PAGE1.lblF901.caption=B08_1.F90
       THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B08_1.F13<>'2'  &&判斷有無修改的權限
       THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)  .AND. B08_1.F13<>'2' &&判斷有無刪除的權限
       THISFORM.ANS_BOTT.ENABLED=IIF(B08_1.F13='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED  
       THISFORM.VRT_BOTT.ENABLED=IIF(EMPTY(B08_1.F13),.F.,.T.) .AND. IIF(A02.F12='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED .AND.!IIF(SEEK(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),'A23','A231'),A23.F07,.F.)      
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
       ENDIF   
       CHK=''     
*       thisform.refresh
  ENDPROC     
  PROC grid2.AFTERROWCOLCHANGE
       LPARAMETERS nColIndex
       THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=B08.F08
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=B08.F05
       THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=B08.F12      
       THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=B08.F06
       THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(B08.F10,'@R 9999999.9999')
       THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=B08.F03
       THISFORM.PAGEFRAME1.PAGE2.LBLF7911.CAPTION='在庫數量:'+TRANSFORM(B11.F04,'@R 99999999999.99')      
       THISFORM.CHGMT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.) .AND. B08.F13<>'2' .AND. !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE) .AND. THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=B08_1.F01
       if thisform.pageframe1.activepage=1
          thisform.CMDGROUP.SEEK_BOTT.ENABLED=.F.
       ENDIF   
*       thisform.refresh
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK    
    THISFORM.KEY_LIST.ENABLED=.F. 
    THISFORM.MTH_LIST.ENABLED=.F. 
    THISFORM.ANS_BOTT.ENABLED=.F.
    THISFORM.VRT_BOTT.ENABLED=.F.
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
          HD1='B007 '
          HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
          HD2='BP'
          HD3='製令領料單'
          IF !USED('A09')
             SELECT 0
             USE A09
          ELSE
             SELECT A09
          ENDIF
          SET ORDER TO 1
          A24='A24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
          IF !USED('&A24')
             SELE 0
             USE (A24) ALIA A24
          ELSE
             SELE A24
           ENDIF
           SET ORDER TO 1                   
          DO ODR_CRT 
          SELECT A24
          USE 
          SELECT A09
          USE
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH
        thisform.PAGEFRAME1.PAGE1.txtf01.readonly=.t.
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.    
        THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=''                
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=RIGHT(DTOS(DATE()),2)
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF131.CAPTION=''       
        THISFORM.PAGEFRAME1.PAGE1.LBLF901.CAPTION=''         
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')     
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''          
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=''                  
        THISFORM.PAGEFRAME1.PAGE2.lblF081.caption=''               
        THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(0,'@R 99999999.9999')
        THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=''               
        THISFORM.PAGEFRAME1.PAGE2.LBLF031.CAPTION=''                       
     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.MTH_LIST.ENABLED=.F. 
     THISFORM.ANS_BOTT.ENABLED=.F.     
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        PO_NO=B08_1.F01     
        SELE RECNO() FROM B08 WHERE B08.F01=PO_NO AND F13<>'2' INTO ARRAY BK1
        JJ1=''                
        IF _TALLY>0                   
           FOR I= 1 TO ALEN(BK1)
               JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
           ENDFOR  
           KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
           RLOCK(KK1,'B08')
           LL1=RLOCK(KK1,'B08')
        ELSE 
           =MESSAGEBOX('此單據已由別的工作站過帳中無法修改!',0+64,'提示訊息視窗')
           SELE B08_1           
           UNLOCK ALL
           REPL F13 WITH '2'
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK   
        ENDIF   
        IF LL1 =.T.
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.F.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
        ELSE 
           DO file_impact
           UNLOCK ALL
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        endif   
     ELSE             
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.            
        SELE E16
        SEEK B08.F05+B08.F08
        IF FOUND()
           RLOCK()
           LL1=RLOCK()
        ELSE
           LL1=.T.   
        ENDIF   
        SELE E11
        SEEK B08.F05+B08.F08
        IF FOUND()
           RLOCK()
           LL2=RLOCK()
        ELSE
           LL2=.T.
        ENDIF      
        SELE B08                                                      &&處理表身修改
        IF RLOCK() .AND. LL1 .AND. LL2=.T.
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX') 
           THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=B08.F08
           THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=B08.F12
           THISFORM.PAGEFRAME1.PAGE2.TXTF12.SETFOCUS
        ELSE  
           DO file_impact 
           unlock all
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK           
       endif        
     ENDIF   
     RELEASE ALL LIKE BK*
  endproc    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF messagebox('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          if ALIA()='B08_1'           &&刪除整張訂單
             
             SELE B08_1             
                PO_NO=B08_1.F01
                SELE RECNO() FROM B08 WHERE B08.F01=PO_NO  AND B08.F13<>'2' INTO ARRAY BK1              
                JJ1=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK1)
                       JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                   ENDFOR    
                   KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
                   RLOCK(KK1,'B08')
                   LL1=RLOCK(KK1,'B08')
                ELSE
                   LL1=.T.   
                ENDIF    
                SELE E16
                SELE RECNO() FROM E16 WHERE E16.F01+E16.F02=ANY(SELE F05+F08 FROM B08 WHERE B08.F01=PO_NO) INTO ARRAY BK2
                JJ2=''
                IF _TALLY>0
                   FOR I=1 TO ALEN(BK2)
                       JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','                               
                   ENDFOR
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
                   RLOCK(KK2,'E16')
                   LL2=RLOCK(KK2,'E16')
                ELSE
                   LL2=.T.   
                ENDIF                           
                SELE E11
                SELE RECNO() FROM E11 WHERE E11.F01+E11.F04=ANY(SELE F05+F08 FROM B08 WHERE B08.F01=PO_NO) INTO ARRAY BK3
                JJ3=''
                IF _TALLY>0
                   FOR I=1 TO ALEN(BK3)
                       JJ3=JJ3+ALLTRIM(STR(BK3(I)))+','                               
                   ENDFOR
                   KK3=STUFF(JJ3,RAT(',',JJ3,1),1,'')              
                   RLOCK(KK3,'E11')
                   LL3=RLOCK(KK3,'E11')
                ELSE
                   LL3=.T.   
                ENDIF                   
                IF LL1 .AND. LL2 .AND. LL3 .AND. RLOCK('B08_1')=.T.
                   SELE B08
                   FOR I=1 TO ALEN(BK1)
                       GO BK1(I)
                       SELE E16
                       SEEK B08.F05+B08.F08
                       IF FOUND()
                          REPL F05 WITH F05+MIN(B08.F10,B08.F12)*(-1)
                       ENDIF                 
                       SELE E11
                       SEEK B08.F05+B08.F08
                       IF FOUND()
                          REPLACE F13 WITH F13+MIN(B08.F10,B08.F12)*(-1)
                       ENDIF            
                       SELE B08
                   ENDFOR    
                   
                   DELE FROM B08 WHERE B08.F01=PO_NO
                   SELE B39                     &&刪除未過帳單據紀錄
                   SEEK A02.F03+B08_1.F01                   
                   IF FOUND()
                      DELE
                   ENDIF   
                   SELE B08_1
                   DELE
                   UNLOCK ALL
                   IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      HD1='B007 '
                      HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      HD2='BP'
                      HD3='製令領料單'
                      A24='A24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                      IF !USED('&A24')
                         SELE 0
                         USE (A24) ALIA A24
                      ELSE
                         SELE A24
                      ENDIF
                      SET ORDER TO 1                   
                      DO ODR_RJT           
                      SELECT A24
                      USE            
                   ENDIF  
                ELSE
                   DO file_impact                  
                ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
                THISFORM.ANS_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  .AND. B08_1.F13>'2' &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   .AND. B08_1.F13<>'2' &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
                THISFORM.ANS_BOTT.ENABLED=IIF(B08_1.F13='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.)  .AND. !THISFORM.SHRGROUP.ENABLED                
             ENDIF     
          ELSE        
              SELE E16
              SEEK B08.F05+B08.F08
              IF FOUND()
                 RLOCK()
                 LL1=RLOCK()
              ELSE
                 LL1=.T.
              ENDIF      
              SELE E11
              SEEK B08.F05+B08.F08
              IF FOUND()
                 RLOCK()
                 LL2=RLOCK()
              ELSE
                 LL2=.T.   
              ENDIF
              SELE B08                                                      &&刪除單筆資料  
              IF LL1 .AND. LL2 .AND. RLOCK('B08')=.T.
                 SELE E16
                 SEEK B08.F05+B08.F08
                 IF FOUND()
                    REPL F05 WITH F05+MIN(B08.F10,B08.F12)*(-1)
                 ENDIF                                        
                 SELE E11
                 SEEK B08.F05+B08.F08
                 IF FOUND()
                    REPL F13 WITH F13+MIN(B08.F10,B08.F12)*(-1)
                 ENDIF                    
                 SELE B08
                 DELE
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF   
              ELSE
                 DO file_impact                  
                 RETURN
              ENDIF     
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0         &&如果單身被刪空
                   SELE B39                           &&刪除未過帳單據紀錄       
                   SEEK A02.F03+B08_1.F01
                   IF FOUND()
                       DELE
                   ENDIF                    
                   SELE B08_1                        
                   PO_NO=B08_1.F01                    
                   DELE                               &&連表頭也要刪除
                   IF INT_099=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)
                      HD1='B007 '
                      HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                      HD2='BP'
                      HD3='製令領料單'
                      A24='A24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                      IF !USED('&A24')
                         SELE 0
                         USE (A24) ALIA A24
                      ELSE
                         SELE A24
                      ENDIF
                      SET ORDER TO 1                   
                      DO ODR_RJT 
                      SELECT A24
                      USE
                   ENDIF
                   SELE B08_1
                   SKIP -1
                   IF BOF()
                       GO TOP
                   ENDIF   
                   THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                   THISFORM.REFRESH          
               ELSE
                    THISFORM.SHRGROUP.FINISH_BOTT.CLICK    
              ENDIF
          ENDIF
       ENDIF
       RELEASE ALL LIKE BK*   
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='B08'
       THISFORM.GRID2.CHILDORDER=B081
	   THISFORM.grid2.COLUMN1.CONTROLSOURCE='B08.F08'
	   THISFORM.grid2.COLUMN2.CONTROLSOURCE='B08.F05'
	   THISFORM.grid2.COLUMN3.CONTROLSOURCE='B08.F10'
	   THISFORM.grid2.COLUMN4.CONTROLSOURCE='B08.F12'
	   THISFORM.grid2.COLUMN5.CONTROLSOURCE="IIF(B08.F14>0,B08.F14,'')"
	   THISFORM.grid2.COLUMN6.CONTROLSOURCE="IIF(B08.F14>0,B11.F04,'')"
       SELE B08_1 
       COD=SYS(21)
       SET ORDER TO 1
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE,'B08')=.T.   &&如果單號重複
             SELE MAX(F01) FROM B08 INTO ARRAY GB NOWAIT
             HD1='B007 '
             HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
             HD2='BP'
             HD3='製令領料單'                       
             IF !USED('A09')
                SELECT 0
                USE A09
             ELSE
                SELECT A09
             ENDIF
             SET ORDER TO 1      
             A24='A24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
             IF !USED('&A24')
                 SELE 0
                 USE (A24) ALIA A24
             ELSE
                 SELE A24
             ENDIF
             SET ORDER TO 1                   
             DO ODR_RPT
             SELECT A24
             USE
             SELECT A09
             USE
	         THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=PO_NO
		     THISFORM.PAGEFRAME1.PAGE1.TXTF01.REFRESH   		           
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE)
          =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'A14_1')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
          =MESSAGEBOX('工作部門主檔中無此編號或無此部門之製令請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF       
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'E16','E163')=.F.
         =MESSAGEBOX('此領用部門未有生產計劃不可領料!',0+48,'提示訊息視窗')
         THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
         SET ORDER TO &COD
         RETURN
       ENDIF  
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('領用日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          SET ORDER TO &COD          
          RETURN
       ENDIF   
       SELE B08_1          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF   
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
       SET ORDER TO &COD
       SELE B39
       APPEND BLANK
       REPL F01 WITH A02.F03
       REPL F02 WITH B08_1.F01
       REPL F03 WITH B08_1.F02
       REPL F05 WITH B08_1.F07
       REPL F06 WITH IIF(SEEK(B08_1.F07,'A14'),A14.F02,'')
       REPL F07 WITH B08_1.F04
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE                                                   &&表身新增確認
       SELE E11
       SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
       IF FOUND()
          RLOCK()
          IF RLOCK()=.F.
             DO file_impact
             THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS
             return
          ENDIF
       ENDIF    
       SELE E16
       SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
       IF FOUND()
          RLOCK()
          IF RLOCK()=.F.
             DO file_impact
             THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS
             return
          ENDIF
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS
          RETURN
       ENDIF   
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
           IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE,'E16')=.F.
              =MESSAGEBOX('無此筆領用計劃!',0+48,'提示訊息視窗')
              THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS
              RETURN           
           ENDIF
       ENDIF
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE<=0
          =MESSAGEBOX('領用數量不得小於等於 0',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF12.SETFOCUS
          RETURN
       ENDIF   
       IF VAL(THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION)>0
           IF THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE>VAL(THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION)
                =MESSAGEBOX('領用數量不得大於應領數量',0+48,'提示訊息示窗')
                THISFORM.PAGEFRAME1.PAGE2.TXTF12.SETFOCUS
                RETURN
           ENDIF       
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE+PADL(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE,12,'0'),'B08')=.T.           
          =MESSAGEBOX('此製令領用料號在此張領用單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.REFRESH
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS
          RETURN            
       ENDIF           
       SELE B08
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE
          REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
          REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
          REPLACE F10 WITH VAL(THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION)
          REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
       ENDIF
       SELE E11
       SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE    &&寫入製令表身檔 
       IF FOUND()
          REPLACE F13 WITH F13+MIN(B08.F10,B08.F12)
       ENDIF       
       SELE E16                                                                         &&寫入領料計劃
       SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
       IF FOUND()          
          REPLACE F05 WITH MIN(B08.F10,B08.F12)
       ENDIF       
       UNLOCK ALL         
       SELE B08
       seek thisform.pageframe1.page1.txtf01.value+thisform.pageframe1.page2.txtF08.value+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
       thisform.grid2.enabled=.t.
       thisform.grid2.setfocus  

       THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       IF EMPTY(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/'+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE))          
          =MESSAGEBOX('領用日期輸入錯誤!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
          RETURN
        ENDIF           
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'A14_1')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE)
          =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
          RETURN            
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE,'A14')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE)
          =MESSAGEBOX('工作部門主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF07.SETFOCUS
          RETURN            
       ENDIF       
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE,'E16','E163')=.F.
         =MESSAGEBOX('此領用部門未有生產計劃不可領料!',0+48,'提示訊息視窗')
         THISFORM.PAGEFRAME1.PAGE1.TXTF04.SETFOCUS
         RETURN
       ENDIF          
           SELE B08
           SEEK B08_1.F01
           IF FOUND()
              DO WHILE F01=B08_1.F01
                 REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                 REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
                 REPL F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                 
                 REPL F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
                 SKIP
              ENDDO    
           ENDIF        
        SELE B08_1
           REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
           REPL F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
           REPL F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
           REPL F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')
     ELSE                                                        &&表身修改確認     
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')          
          THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS
          RETURN
       ENDIF   
       IF B08.F10>0
           IF THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE>B08.F10
                =MESSAGEBOX('領用數量不得大於應領數量',0+48,'提示訊息示窗')
                THISFORM.PAGEFRAME1.PAGE2.TXTF12.SETFOCUS
                RETURN
           ENDIF       
       ENDIF
       SELE E11
       SEEK B08.F05+B08.F08
       IF FOUND()
          REPLACE F13 WITH F13+MIN(B08.F10,B08.F12)*(-1) &&MIN(B08.F10,B08.F12)
       ENDIF   
       SELE E16
       SEEK B08.F05+B08.F08
       IF FOUND()
          REPL F05 WITH F05+MIN(B08.F10,B08.F12)*(-1)
       ENDIF        
       SELE B08                    
       REPLACE F08 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
       REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE      
       REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')          
       SELE E16                                                                         &&寫入領料計劃
       SEEK THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
       IF FOUND()
          REPLACE F05 WITH F05+MIN(B08.F10,B08.F12)
          REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')        
       ENDIF                           
       SELE E11                         &&寫入製令表身
       SEEK B08.F05+B08.F08
       IF FOUND()
          REPLACE F13 WITH F13+MIN(B08.F10,B08.F12)
       ENDIF   
       SELECT B08
       H=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE
       SEEK H
       IF FOUND()           
           K=0
           DO WHILE F01+F08=H
                  REPLACE F14 WITH 0
                  K=K+F12
                  SKIP 
           ENDDO
           SKIP -1
           REPLACE F14 WITH K
       ENDIF
    ENDIF   
    CHK_STR=thisform.pageframe1.page1.txtf01.value+thisform.pageframe1.page2.txtF08.value+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
    THISFORM.SHRGROUP.FINISH_BOTT.CLICK
    SEEK CHK_STR
*           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  procedure SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF07.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE1.TXTF04.READONLY=.T.  
      THISFORM.PAGEFRAME1.PAGE2.TXTF08.READONLY=.T.   
      THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=.T.         
      
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      THISFORM.grid1.ENABLED=.T.
      THISFORM.grid2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1         
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.MTH_LIST.ENABLED=.T.      
      ELSE
         THISFORM.GRID2.SETFOCUS
         IF THISFORM.GRID2.ACTIVEROW=0
              HD1='B007 '
              HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
              HD2='BP'
              HD3='製令領料單'                      
              A24='A24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
              IF !USED('&A24')
                 SELE 0
                 USE (A24) ALIA A24
              ELSE
                 SELE A24
              ENDIF
              SET ORDER TO 1                   
              DO ODR_RJT
              SELECT A24
              USE
              SELE B39
              SEEK A02.F03+B08_1.F01
              SET ORDER TO 1
              IF FOUND()
                  DELE            
              ENDIF   
              SELE B08_1
              DELE
              THISFORM.PAGEFRAME1.ACTIVEPAGE=1
              THISFORM.REFRESH  
         ENDIF   
      ENDIF       
      UNLOCK ALL
      THISFORM.ANS_BOTT.ENABLED=IIF(B08_1.F13='2',.F.,.T.) .AND. IIF(A02.F11='*',.T.,.F.) .AND. !THISFORM.SHRGROUP.ENABLED               
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
         IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
              IF THISFORM.GRID2.RECORDSOURCE<>'B08'
                 THISFORM.GRID2.RECORDSOURCE='B08'
                 THISFORM.GRID2.CHILDORDER=B081
	             THISFORM.grid2.COLUMN1.CONTROLSOURCE='B08.F08'
	             THISFORM.grid2.COLUMN2.CONTROLSOURCE='B08.F05'
	             THISFORM.grid2.COLUMN3.CONTROLSOURCE='B08.F10'
	             THISFORM.grid2.COLUMN4.CONTROLSOURCE='B08.F12'
	             THISFORM.grid2.COLUMN5.CONTROLSOURCE="IIF(B08.F14>0,B08.F14,'')"        
	             THISFORM.grid2.COLUMN6.CONTROLSOURCE="IIF(B08.F14>0,B11.F04,'')"     
	          ENDIF   
	          IF INT_099=.T.      
	             HD1='B007 '
                 HD=HD1+SUBSTR(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),3,4)+PO_NO
                 HD2='BP'
                 HD3='製令領料單'
                 A24='A24'+LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)
                 IF !USED('&A24')
                    SELE 0
                    USE (A24) ALIA A24
                 ELSE
                    SELE A24
                 ENDIF
                 SET ORDER TO 1                   
                 DO ODR_RJT
                 SELECT A24
                 USE
             ENDIF   
              SELE B08_1
              DO CASE 
                    CASE THISFORM.KEY_LIST.DISPLAYVALUE='依領用單號排列'
                               SET ORDER TO 1
                    CASE THISFORM.KEY_LIST.DISPLAYVALUE='依發料部門排列'
                               SET ORDER TO 2
                     CASE THISFORM.KEY_LIST.DISPLAYVALUE='依領用部門排列'
                                SET ORDER TO 3
               ENDCASE   
         ELSE
                SELECT B08
                UKEF=B08_1.F01
                    SEEK UKEF                                         &&重算累計數量
                    H=B08.F01+B08.F08
                    SEEK H
                    DO WHILE F01=UKEF   
                            K=0
                           IF FOUND()            
                                DO WHILE F01+F08=H
                                       REPLACE F14 WITH 0
                                       IF INT_056='Y'
                                           K=K+IIF(!EMPTY(F05),F12,0)
                                       ELSE
                                           K=K+F12    
                                       ENDIF    
                                      SKIP                                      
                                ENDDO
                                SKIP -1                                
                                     QS=B08.F01+B08.F08+B08.F05                                                                                                
                                IF IIF(SEEK(B08.F08,'B01'),B01.F39,'')='B'   AND INT_056='Y'&&若必須整批領料

                                    SELECT C20
                                    SEEK B08.F08
                                    IF FOUND() AND VAL(C20.F03)>0
                                        M=CEILING(K/VAL(C20.F03))*VAL(C20.F03)-K
                                        K=K+M
                                        IF M>0
                                            SELECT B08
                                            SEEK H+SPACE(12)
                                            IF !FOUND()
                                                 APPEND BLANK 
                                                 REPLACE F01 WITH B08_1.F01 &&THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
                                                 REPLACE F02 WITH B08_1.F02 &&THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
                                                 REPLACE F04 WITH B08_1.F04 &&THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
                                                 REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	                                                                                                                                                                                                                             
                                                 REPLACE F07 WITH B08_1.F07 &&THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE                                        
                                                 REPLACE F08 WITH SUBSTR(QS,11,43)
                                            ENDIF     
                                            REPLACE F12 WITH M
                                        ENDIF
                                     ENDIF   
                                     SELECT B08
                                     SEEK QS                                    
                                ENDIF    
                                 SELECT B08
                                     QS=B08.F01+B08.F08+B08.F05                                                                                                    
                                REPLACE F14 WITH K
                                SKIP
                           ENDIF
                           H=F01+F08
                    ENDDO                                            
         ENDIF  
         THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK     &&過帳程序
       if messagebox('是否確認資料無誤可以過帳?',4+32+256,'請確認') = 6	 
          SELECT B08
          SET RELATION OFF INTO B01          
          SET RELATION OFF INTO B11
          SELE RECNO() FROM B08 WHERE B08.F01=B08_1.F01  AND F13<>'2' INTO ARRAY BK1              
          JJ1=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK1)
                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
             ENDFOR    
             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
             RLOCK(KK1,'B08')
             LL1=RLOCK(KK1,'B08')
          ELSE
             LL1=.T.   
          ENDIF 
          
          SELE RECNO() FROM E11 WHERE F01+F04=ANY(SELE F05+F08 FROM B08 WHERE F01=B08_1.F01) INTO ARRAY BK2
          JJ2=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK2)
                 JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
             ENDFOR    
             KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
             RLOCK(KK2,'E11')
             LL2=RLOCK(KK2,'E11')
          ELSE
             LL2=.T.   
          ENDIF                                                 
          IF LL1 .AND. LL2  =.T. 
             IF LEN(ALLTRIM(JJ1))>0 
                SELE B08
                FOR I= 1 TO ALEN(BK1)                      
                    GO BK1(I) 
                    SELE B11                                            &&部門庫存明細檔 
                    SEEK B08.F07+B08.F08+IIF(INT_028,IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5)),SPACE(5))                              &&發料部門庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+(B08.F12)*(-1)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                          ENDIF
                       ENDIF   
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B08.F07
                       REPL F03 WITH B08.F08
                       REPL F04 WITH (B08.F12)*(-1)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                       IF INT_028
                          REPLACE F08 WITH IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5))
                       ENDIF  
                    ENDIF   
                    SEEK B08.F04+B08.F08+IIF(INT_028,IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5)),SPACE(5))                 &&收料部門庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+B08.F12
                       IF F04=0
                          DELETE 
                       ENDIF   
                       IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                          REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                       ENDIF
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B08.F04
                       REPL F03 WITH B08.F08
                       REPL F04 WITH B08.F12
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                       IF INT_028
                           REPLACE F08 WITH IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5))
                       ENDIF
                    ENDIF                            
                    *******
                    SELE B25                                             &&分部門庫存月報表 
                    SEEK B08.F07+B08.F08
                    IF FOUND()                                                     &&發料部門報表
                       REPLACE  F09 WITH F09+B08.F12
                       REPLACE F15 WITH F15+B08.F12*(-1)
                    ELSE
                       APPEND BLANK
                       REPLACE  F01 WITH B08.F07
                       REPLACE  F02 WITH B08.F08
                       REPLACE  F09 WITH B08.F12
                       REPLACE F15 WITH B08.F12*(-1)
                    ENDIF   
                    SEEK B08.F04+B08.F08                                           &&收料部門報表
                    IF FOUND()
                        REPLACE  F08 WITH F08+B08.F12
                        REPLACE F15 WITH F15+B08.F12
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B08.F04
                       REPL F02 WITH B08.F08
                       REPL F08 WITH B08.F12    
                       REPLACE F15 WITH B08.F12                                             
                    ENDIF                         
                    SELE E11
                    SEEK B08.F05+B08.F08
                    IF FOUND()
                       REPLACE F13 WITH F13+B08.F12*(-1)
                       REPLACE F08 WITH F08+B08.F12
                    ENDIF   
                    SELE B08
                    REPL F13 WITH '2'
                    REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                    
                    REPLACE F03 WITH  IIF(SEEK(F05+F08,'E16'),E16.F14,'')
                 ENDFOR   
                 SELE F01,F02,F04,F07,F08,SUM(F12) FROM B08 WHERE F01=B08_1.F01 GROUP BY F08 ORDER BY F08 INTO CURSOR B08_4
                 SELE B08_4
                 GO TOP
                 DO WHILE !EOF()
                    SELE B26                       &&庫存異動紀錄                                                                                   
                    APPEND BLANK               &&轉出                                 
                    REPL F01 WITH B08_4.F08                               
                    REPL F02 WITH B08_4.F07
                    REPL F03 WITH B08_4.F02
                    REPL F04 WITH B08_4.SUM_F12*(-1)
                    REPL F06 WITH 'P'
                    REPL F07 WITH B08_4.F01
                    REPL F08 WITH IIF(SEEK(B08_4.F04,'A14'),'發料給'+A14.F02+'生產','')                      
                    APPEND BLANK                                               &&轉入                      
                    REPL F01 WITH B08_4.F08
                    REPL F02 WITH B08_4.F04
                    REPL F03 WITH B08_4.F02
                    REPL F04 WITH B08_4.SUM_F12
                    REPL F06 WITH 'P'
                    REPL F07 WITH B08_4.F01 
                    REPL F08 WITH IIF(SEEK(B08_4.F07,'A14'),'向'+A14.F02+'領用上線','')
                    SELE B08_4
                    SKIP
                 ENDDO  
                 SELE B08_4
                 USE                 
                 SELE B39                    &&未過帳庫存單據查詢檔
                 SEEK A02.F03+B08_1.F01
                  IF FOUND()
                     DELE
                  ENDIF                                             
                  SELE B08_1
                  REPL F13 WITH '2'
                  REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')  
             ELSE
                =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                SELE B08_1
                REPL F13 WITH '2'
             ENDIF           
             THIS.ENABLED=.F.
             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.             
             UNLOCK ALL
             SELECT B08
                  SET RELATION TO F08 INTO B01                   
                  SET RELATION TO F07+F08 INTO B11 ADDITIVE 
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.
             ENDIF
             THISFORM.REFRESH
          ELSE
            DO file_impact
            unlock all
            return
          ENDIF   
          unlock all
         RELEASE ALL LIKE BK*
      ENDIF      
  ENDPROC
******************************************************
  PROC VRT_BOTT.CLICK     &&反過帳程序
       if messagebox('是否確定要過帳?',4+32+256,'請確認') = 6	 
          SELECT B08
          SET RELATION OFF INTO B01
          SET RELATION OFF INTO B11
          SELE RECNO() FROM B08 WHERE B08.F01=B08_1.F01  AND F13='2' INTO ARRAY BK1              
          JJ1=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK1)
                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
             ENDFOR    
             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
             RLOCK(KK1,'B08')
             LL1=RLOCK(KK1,'B08')
          ELSE
             LL1=.T.   
          ENDIF 
          
          SELE RECNO() FROM E11 WHERE F01+F04=ANY(SELE F05+F08 FROM B08 WHERE F01=B08_1.F01) INTO ARRAY BK2
          JJ2=''                
          IF _TALLY>0   
             FOR I= 1 TO ALEN(BK2)
                 JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
             ENDFOR    
             KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
             RLOCK(KK2,'E11')
             LL2=RLOCK(KK2,'E11')
          ELSE
             LL2=.T.   
          ENDIF                                                 
          IF LL1 .AND. LL2  =.T. 
             IF LEN(ALLTRIM(JJ1))>0 
                SELE B08
                FOR I= 1 TO ALEN(BK1)                      
                    GO BK1(I) 
                    SELE B11                                            &&部門庫存明細檔 
                    SEEK B08.F07+B08.F08+IIF(INT_028,IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5)),SPACE(5))                              &&發料部門庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+(B08.F12)
                       IF F04=0
                          DELE
                       ELSE   
                          IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                             REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                          ENDIF
                       ENDIF   
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B08.F07
                       REPL F03 WITH B08.F08
                       REPL F04 WITH B08.F12
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                       IF INT_028
                          REPLACE F08 WITH IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5))
                       ENDIF  
                    ENDIF   
                    SEEK B08.F04+B08.F08+IIF(INT_028,IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5)),SPACE(5))                 &&收料部門庫存明細 
                    IF FOUND()
                       REPL F04 WITH F04+B08.F12*(-1)
                       IF F04=0
                          DELETE 
                       ENDIF   
                       IF F05<CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                          REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                       ENDIF
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B08.F04
                       REPL F03 WITH B08.F08
                       REPL F04 WITH B08.F12*(-1)
                       REPL F05 WITH CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/'+B08.F02))
                       IF INT_028
                           REPLACE F08 WITH IIF(SEEK('CA'+LEFT(B08.F05,8),'C03'),C03.F03,SPACE(5))
                       ENDIF
                    ENDIF                            
                    *******
                    SELE B25                                             &&分部門庫存月報表 
                    SEEK B08.F07+B08.F08
                    IF FOUND()                                                     &&發料部門報表
                       REPLACE  F09 WITH F09+B08.F12*(-1)
                       REPLACE F15 WITH F15+B08.F12
                    ELSE
                       APPEND BLANK
                       REPLACE  F01 WITH B08.F07
                       REPLACE  F02 WITH B08.F08
                       REPLACE  F09 WITH F09+B08.F12*(-1)
                       REPLACE F15 WITH B08.F12
                    ENDIF   
                    SEEK B08.F04+B08.F08                                           &&收料部門報表
                    IF FOUND()
                        REPLACE F08 WITH F08+B08.F12*(-1)
                        REPLACE F15 WITH F15+B08.F12*(-1)
                        
                    ELSE
                       APPEND BLANK
                       REPL F01 WITH B08.F04
                       REPL F02 WITH B08.F08
                       REPLACE F08 WITH F08+B08.F12*(-1)
                       REPLACE F15 WITH B08.F12*(-1)                                             
                    ENDIF                         
                    SELE E11
                    SEEK B08.F05+B08.F08
                    IF FOUND()
                       REPLACE F13 WITH F13+B08.F12
                       REPLACE F08 WITH F08+B08.F12*(-1)
                    ENDIF   
                    SELE B08
                    REPL F13 WITH ''
                    REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')                    
                    REPLACE F03 WITH  ''
                 ENDFOR   
                
               
                    SELE B26                       &&庫存異動紀錄                                                                                   

                 DELETE FROM B26 WHERE F07=B08_1.F01     
                 SELE B39                    &&未過帳庫存單據查詢檔
                 SEEK A02.F03+B08_1.F01
                  IF !FOUND()
                     APPEND BLANK
                     REPL F01 WITH A02.F03
                     REPL F02 WITH B08_1.F01
                     REPL F03 WITH B08_1.F02
                     REPL F05 WITH B08_1.F07
                     REPL F06 WITH IIF(SEEK(B08_1.F07,'A14'),A14.F02,'')
                     REPL F07 WITH B08_1.F04
                  ENDIF                                             
                  SELE B08_1
                  REPL F13 WITH ''
                  REPL F90 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')  
             ELSE
                =MESSAGEBOX('此單據已由別的工作站過帳完成',0+64,'提示訊息視窗')
                SELE B08_1
                REPL F13 WITH ''
             ENDIF           
             THIS.ENABLED=.F.
             THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
             THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
                     
             UNLOCK ALL
             SELECT B08
             SET RELATION TO F08 INTO B01
             SET RELATION TO F07+F08 INTO B11 ADDITIVE 
             IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
                THISFORM.GRID1.SETFOCUS
             ELSE
                 THISFORM.GRID2.SETFOCUS
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)
             ENDIF
             THISFORM.REFRESH
          ELSE
            DO file_impact
            unlock all
            return
          ENDIF   
          unlock all
         RELEASE ALL LIKE BK*
      ENDIF      
  ENDPROC
******************************************************
PROCEDURE CHGMT_BOTT.CLICK
       CHGMT_SEEK=CREATEOBJECT("CHGMT_SEEK")
	   CHGMT_SEEK.SHOW    
	   IF LEN(ALLTRIM(FLG))>0
	      
	      CHK_STR=thisform.pageframe1.page1.txtf01.value+FLG+THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
	      
	      THISFORM.SHRGROUP.FINISH_BOTT.CLICK    
	      SEEK CHK_STR
	   ELSE
	      FLG=''
	      THISFORM.GRID2.SETFOCUS
	   ENDIF   
	   FLG='' 
       CHK_STR=''
ENDPROC
******************************************************  
PROC EXCEL_BOTT.CLICK
           IF !USED('E03')
               SELECT 0
               USE E03
           ELSE
              SELECT E03
           ENDIF
           SET ORDER TO 1       
           SELECT B08.F01 領料單號,B08.F02 領用日期,B08.F07 發料單位,B08.F04 領用單位,;
           B08.F05 製令編號,IIF(SEEK(B08.F05,'E03'),E03.F01,'') 完成品號,B08.F08 領用料號,B08.F12 領用數量,B01.F37 成本單價;
           FROM B08,B01 WHERE B08.F13='2' AND B01.F01=B08.F08 ;
            INTO CURSOR B08_K ORDER BY B08.F01,B08.F05,B08.F08 NOWAIT
            IF _TALLY>0
	         FILENAME=LEFT(DTOS(CTOD(THISFORM.MTH_LIST.DISPLAYVALUE+'/01')),6)+'製令領用單'
		 GCDELIMFILE=PUTFILE('儲存路徑',FILENAME,'XLS')
		 IF !EMPTY(GCDELIMFILE) 
		      ON ERROR DO FILE_IMPACT
		      COPY TO (GCDELIMFILE) TYPE XL5     
		       =MESSAGEBOX('儲存成功',0+64,'提示訊息視窗') 
		  ENDIF     
            ELSE
                  =MESSAGEBOX('無已過帳單據資料!',0+48,'提示訊息視窗')
            ENDIF		  
            SELECT B08_K
            USE
            SELECT E03
            USE 
            SELECT B08_1            
       THISFORM.GRID1.SETFOCUS
  ENDPROC   
enddefine    

***********************************************列印程序
PROCEDURE PNT_PRC  
     LK=B08_1.F01     
     HK=IIF(INT_012=2,LEFT(DTOC(A23.F01),5),ALLTRIM(STR(VAL(LEFT(DTOS(A23.F01),4))-1911))+SUBSTR(DTOC(A23.F01),3,3))
     FRMDPT=IIF(SEEK(B08_1.F07,'A14'),A14.F02,'')
     TODDPT=IIF(SEEK(B08_1.F04,'A14'),A14_1.F02,'')
     SELECT B08.F01,;
            B08.F02,;
            B08.F12,;                    
            B08.F07,;
            B08.F08,;
            B08.F04,;
            B08.F05,;
            B08.F14,;
            B01.F02;            
     FROM B08,B01 WHERE B08.F01=LK AND B01.F01=B08.F08 ORDER BY B08.F08,B08.F05 NOWAIT
     IF _tally >0
       FRMDPT=IIF(SEEK(B08_1.F07,'A14'),A14.F02,'')
       TODDPT=IIF(SEEK(B08_1.F04,'A14'),A14.F02,'')
*        REPORT FORM ALLTRIM(INT_116)+'B08' PREVIEW
         report form ALLTRIM(INT_116)+'B08' to print prompt 
     ENDIF  
ENDPROC
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF08 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
         CHK_IN='0'
         PR_NO='1'
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
              IF USED('OQT')=.T.
                  SELECT OQT 
                  USE
              ENDIF
              SELECT F08,F05 FROM B08 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F05,F08 INTO CURSOR B08_TEMP
              IF EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE))                   
                  SELECT 0,F02,F01,F03,F04,F05 FROM E16 INTO CURSOR OQT READWRITE; 
                  ORDER BY F02,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;                               
                 AND (E16.F04-E16.F05)>0
             ELSE  
                  SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT ORDER BY F02,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;
                 AND (E16.F04-E16.F05)>0 AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE  READWRITE            
             ENDIF         
             SELECT OQT     
             ALTER TABLE OQT ADD E11_F07  N(14,4)
              INDE ON F02+DTOS(F03)+F01 TAG OQT_1
              INDE ON F01+F02 TAG OQT_2
	      SELECT OQT 
	      SET ORDER TO OQT_2  
	      SELECT B08_TEMP
	      GO TOP
	      DO WHILE !EOF()
	             SELECT OQT 
	             SEEK B08_TEMP.F05+B08_TEMP.F08
	             IF FOUND()
	                  DELETE 
	             ENDIF
	             SELECT B08_TEMP
	             SKIP
	      ENDDO
	      SELECT B08_TEMP
	      USE
	      SELECT OQT 	      
               IF _TALLY>0
                    OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                    OQT_SEEK.SHOW  
                    THIS.REFRESH
                    SELECT OQT 
                    CALC SUM(EXP_1) TO NO
                    DO CASE
	                   CASE NO=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=OQT_TEMP.F02
			              THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=OQT_TEMP.E11_F07  
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=OQT_TEMP.F01
			              THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(OQT_TEMP.F04-OQT_TEMP.F05,'@R 999999999.9999')
			              SELECT OQT_TEMP
			              USE	                   
	                   CASE NO>=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              GO TOP
			              DO WHILE !EOF()
			                 IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B08')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
			                     SELECT  B08
				                 APPEND BLANK
				                 REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				                 REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				                 REPLACE F08 WITH OQT_TEMP.F02
				                 REPLACE F12 WITH OQT_TEMP.E11_F07  
				                 REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				                 REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
				                 REPLACE F05 WITH OQT_TEMP.F01
				                 REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	
				                 REPLACE F10 WITH OQT_TEMP.F04-OQT_TEMP.F05	
				                 SELECT E16
				                 SEEK B08.F05+B08.F08
				                 IF FOUND()
				                      REPLACE F05 WITH F05+B08.F12
				                 ENDIF
				                 SELECT E11
				                 SEEK B08.F05+B08.F08
				                 IF FOUND()
				                     REPLACE F13 WITH F13+B08.F12
				                 ENDIF 	                 
					         ENDIF       				            
			                    SELECT OQT_TEMP
			                    SKIP 
		                      ENDDO  
		                      SELECT OQT_TEMP
		                      USE
			              THISFORM.GRID2.ENABLED=.T.
			              THISFORM.GRID2.SETFOCUS  
			              THISFORM.GRID2.ENABLED=.F.                 
			              THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0   
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE='' 
			              THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION='0'                                    
	            ENDCASE       
		    THISFORM.PAGEFRAME1.PAGE2.TXTF08.SETFOCUS 
              ENDIF            
         ENDIF      
  ENDPROC       
  PROCEDURE INTERACTIVECHANGE
         CHK_IN='0'
         PR_NO='1'
         IF AT('?',ALLTRIM(THIS.VALUE))<>0
             IF USED('OQT')=.T.
                  SELECT OQT 
                 USE
             ENDIF
             SELECT F08,F05 FROM B08 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F08,F05 INTO CURSOR B08_TEMP  
             DO CASE
                   CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05 FROM E16 INTO CURSOR OQT READWRITE; 
                              ORDER BY F02,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE; 
                              AND LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                              AND (E16.F04-E16.F05)>0
                   CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT READWRITE; 
                              ORDER BY F02,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE; 
                              AND LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                              AND (E16.F04-E16.F05)>0 AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE              
                   CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT ORDER BY F02,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;
                             AND (E16.F04-E16.F05)>0 READWRITE
                   CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT ORDER BY F02,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;
                              AND (E16.F04-E16.F05)>0 AND F01=THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE  READWRITE            
            ENDCASE 
            SELECT OQT 
            ALTER TABLE OQT ADD E11_F07  N(14,4)
            INDE ON F02+DTOS(F03)+F01 TAG OQT_1   
            INDE ON F01+F02 TAG OQT_2  
            SET ORDER TO OQT_2 
	    SELECT B08_TEMP
	    GO TOP
	    DO WHILE !EOF()
	           SELECT OQT 
	           SEEK B08_TEMP.F05+B08_TEMP.F08
	           IF FOUND()
	                DELETE 
	           ENDIF
	           SELECT B08_TEMP
	           SKIP
	    ENDDO
	    SELECT B08_TEMP
	    USE
	    SELECT OQT 
            IF _TALLY>0  
                SELECT OQT 
	        SET ORDER TO OQT_1 
                OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                OQT_SEEK.SHOW   
                THIS.REFRESH
                SELECT OQT 
                CALC SUM(EXP_1) TO NO   
                DO CASE
                   CASE NO=1 AND CHK_IN='1'
                        SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
		                SELECT OQT_TEMP
			            THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=OQT_TEMP.F02
			            THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=OQT_TEMP.E11_F07  
			            THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=OQT_TEMP.F01
			            THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(OQT_TEMP.F04-OQT_TEMP.F05,'@R 999999999.9999')
			            SELECT OQT_TEMP
			            USE	                                       
	               CASE NO>=1 AND CHK_IN='1'
		                SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			            SELECT OQT_TEMP
			            GO TOP
			            DO WHILE !EOF()
			               IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B08')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
			                  SELECT  B08
				              APPEND BLANK
				              REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				              REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				              REPLACE F08 WITH OQT_TEMP.F02
				              REPLACE F12 WITH OQT_TEMP.E11_F07  
				              REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				              REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
				              REPLACE F05 WITH OQT_TEMP.F01
				              REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	
				              REPLACE F10 WITH OQT_TEMP.F04-OQT_TEMP.F05		 
				              SELECT E16
				              SEEK B08.F05+B08.F08
				              IF FOUND()
				                 REPLACE F05 WITH F05+B08.F12
				              ENDIF
				              SELECT E11
				              SEEK B08.F05+B08.F08
				              IF FOUND()
				                 REPLACE F13 WITH F13+B08.F12
				              ENDIF 	      				                             
					       ENDIF       				            
			               SELECT OQT_TEMP
			               SKIP 
		                 ENDDO  
		                 SELECT OQT_TEMP
		                  USE
			         THISFORM.GRID2.ENABLED=.T.
			         THISFORM.GRID2.SETFOCUS  
			         THISFORM.GRID2.ENABLED=.F.                 
			         THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''
			         THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0   
			         THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE='' 
			         THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION='0'                                    
                ENDCASE    
            ENDIF       			                         
    ELSE
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE)
          THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE+THIS.VALUE,'E16'),E16.F04-E16.F05,0)       
          THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE,'@R 9999999.9999')
       ENDIF          
    ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'')      
  ENDPROC

ENDDEFINE
***************************************************特殊欄位-----------------製令號碼
DEFINE CLASS TXTF05 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=12
  FONTSIZE=INT_015*9
  PROCEDURE DBLCLICK 
         CHK_IN='0'
         PR_NO='2'
         IF THISFORM.SHRGROUP.VISIBLE=.T.  AND THIS.ReadOnly =.F.
              IF USED('OQT')=.T.
                  SELECT OQT 
                  USE
              ENDIF
              SELECT F08,F05 FROM B08 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F05,F08 INTO CURSOR B08_TEMP
              IF EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE))                   
                  SELECT 0,F02,F01,F03,F04,F05 FROM E16 INTO CURSOR OQT READWRITE; 
                  ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;                               
                 AND (E16.F04-E16.F05)>0
             ELSE  
                  SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;
                 AND (E16.F04-E16.F05)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE  READWRITE            
             ENDIF         
             SELECT OQT     
             ALTER TABLE OQT ADD E11_F07  N(14,4)
              INDE ON F01+DTOS(F03)+F02 TAG OQT_1
              INDE ON F01+F02 TAG OQT_2
	      SELECT OQT 
	      SET ORDER TO OQT_2  
	      SELECT B08_TEMP
	      GO TOP
	      DO WHILE !EOF()
	             SELECT OQT 
	             SEEK B08_TEMP.F05+B08_TEMP.F08
	             IF FOUND()
	                  DELETE 
	             ENDIF
	             SELECT B08_TEMP
	             SKIP
	      ENDDO
	      SELECT B08_TEMP
	      USE
	      SELECT OQT 	      
               IF _TALLY>0
                    OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                    OQT_SEEK.SHOW  
                    THIS.REFRESH
                    SELECT OQT 
                    CALC SUM(EXP_1) TO NO
                    DO CASE
	                   CASE NO=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=OQT_TEMP.F02
			              THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=OQT_TEMP.E11_F07  
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=OQT_TEMP.F01
			              THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(OQT_TEMP.F04-OQT_TEMP.F05,'@R 999999999.9999')
			              SELECT OQT_TEMP
			              USE	                   
	                   CASE NO>=1 AND CHK_IN='1'
		        	      SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			              SELECT OQT_TEMP
			              GO TOP
			              DO WHILE !EOF()
			                     IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B08')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
			                         SELECT  B08
				                 APPEND BLANK
				                 REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				                 REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				                 REPLACE F08 WITH OQT_TEMP.F02
				                 REPLACE F12 WITH OQT_TEMP.E11_F07  
				                 REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				                 REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
				                 REPLACE F05 WITH OQT_TEMP.F01
				                 REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	
				                 REPLACE F10 WITH OQT_TEMP.F04-OQT_TEMP.F05		
				                 SELECT E16
				                 SEEK B08.F05+B08.F08
				                 IF FOUND()
				                      REPLACE F05 WITH F05+B08.F12
				                 ENDIF
				                 SELECT E11
				                 SEEK B08.F05+B08.F08
				                 IF FOUND()
				                     REPLACE F13 WITH F13+B08.F12
				                 ENDIF 	      				                                  
					    ENDIF       				            
			                    SELECT OQT_TEMP
			                    SKIP 
		                      ENDDO  
		                      SELECT OQT_TEMP
		                      USE
			              THISFORM.GRID2.ENABLED=.T.
			              THISFORM.GRID2.SETFOCUS  
			              THISFORM.GRID2.ENABLED=.F.                 
			              THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''
			              THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0   
			              THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE='' 
			              THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION='0'                                    
	            ENDCASE       
		        THISFORM.PAGEFRAME1.PAGE2.TXTF05.SETFOCUS 
              ENDIF            
         ENDIF      
  ENDPROC         
  PROCEDURE INTERACTIVECHANGE
         CHK_IN='0'
         PR_NO='2'
         IF AT('?',ALLTRIM(THIS.VALUE))<>0
             IF USED('OQT')=.T.
                  SELECT OQT 
                 USE
             ENDIF
             SELECT F08,F05 FROM B08 WHERE F01=THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE ORDER BY F05,F08 INTO CURSOR B08_TEMP  
             DO CASE
                   CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05 FROM E16 INTO CURSOR OQT READWRITE; 
                              ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE; 
                              AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                              AND (E16.F04-E16.F05)>0
                   CASE AT('?',ALLTRIM(THIS.VALUE))>1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT READWRITE; 
                              ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE; 
                              AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1);    
                              AND (E16.F04-E16.F05)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE              
                   CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;
                             AND (E16.F04-E16.F05)>0 READWRITE
                   CASE AT('?',ALLTRIM(THIS.VALUE))=1 .AND. !EMPTY(ALLTRIM(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE))                   
                              SELECT 0,F02,F01,F03,F04,F05  FROM E16 INTO CURSOR OQT ORDER BY F01,F03 WHERE F06=THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE;
                              AND (E16.F04-E16.F05)>0 AND F02=THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE  READWRITE            
            ENDCASE 
            SELECT OQT 
            ALTER TABLE OQT ADD E11_F07  N(14,4)
            INDE ON F02+DTOS(F03)+F01 TAG OQT_1   
            INDE ON F01+F02 TAG OQT_2  
            SET ORDER TO OQT_2 
	    SELECT B08_TEMP
	    GO TOP
	    DO WHILE !EOF()
	           SELECT OQT 
	           SEEK B08_TEMP.F05+B08_TEMP.F08
	           IF FOUND()
	                DELETE 
	           ENDIF
	           SELECT B08_TEMP
	           SKIP
	    ENDDO
	    SELECT B08_TEMP
	    USE
	    SELECT OQT 
            IF _TALLY>0  
                SELECT OQT 
	        SET ORDER TO OQT_1 
                OQT_SEEK=CREATEOBJECT("OQT_SEEK")  
                OQT_SEEK.SHOW   
                THIS.REFRESH
                SELECT OQT 
                CALC SUM(EXP_1) TO NO   
                DO CASE
                      CASE NO=1 AND CHK_IN='1'
                   	        SELECT * FROM OQT  WHERE OQT.EXP_1<>0 ORDER BY OQT.F02 INTO CURSOR OQT_TEMP
		                SELECT OQT_TEMP
			        THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=OQT_TEMP.F02
			        THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=OQT_TEMP.E11_F07  
			        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=OQT_TEMP.F01
			        THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(OQT_TEMP.F04-OQT_TEMP.F05,'@R 999999999.9999')
			        SELECT OQT_TEMP
			        USE	                                       
	               CASE NO>=1 AND CHK_IN='1'
		                 SELECT * FROM OQT  WHERE OQT.EXP_1<>0  ORDER BY OQT.F02 DESC INTO CURSOR OQT_TEMP
			         SELECT OQT_TEMP
			         GO TOP
			         DO WHILE !EOF()
			                IF  SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE+OQT_TEMP.F02+OQT_TEMP.F01,'B08')=.F.  AND IIF(SEEK(OQT_TEMP.F02,'B01'),.T.,.F.)
			                     SELECT  B08
				             APPEND BLANK
				             REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
				             REPLACE F02 WITH PADL(ALLTRIM(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE),2,'0')
				             REPLACE F08 WITH OQT_TEMP.F02
				             REPLACE F12 WITH OQT_TEMP.E11_F07  
				             REPLACE F07 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF07.VALUE
				             REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
				             REPLACE F05 WITH OQT_TEMP.F01
				             REPLACE F06 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')	
				             REPLACE F10 WITH OQT_TEMP.F04-OQT_TEMP.F05		 
				                 SELECT E16
				                 SEEK B08.F05+B08.F08
				                 IF FOUND()
				                      REPLACE F05 WITH F05+B08.F12
				                 ENDIF
				                 SELECT E11
				                 SEEK B08.F05+B08.F08
				                 IF FOUND()
				                     REPLACE F13 WITH F13+B08.F12
				                 ENDIF 	      				                             
					        ENDIF       				            
			                SELECT OQT_TEMP
			                SKIP 
		                 ENDDO  
		                 SELECT OQT_TEMP
		                  USE
			         THISFORM.GRID2.ENABLED=.T.
			         THISFORM.GRID2.SETFOCUS  
			         THISFORM.GRID2.ENABLED=.F.                 
			         THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE=''
			         THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=0   
			         THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE='' 
			         THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION='0'                                    
                ENDCASE    
            ENDIF     
    ELSE 
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE)
          THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE=IIF(SEEK(THIS.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE,'E16'),E16.F04-E16.F05,0)       
          THISFORM.PAGEFRAME1.PAGE2.LBLF101.CAPTION=TRANSFORM(THISFORM.PAGEFRAME1.PAGE2.TXTF12.VALUE,'@R 99999999.9999')
       ENDIF   
    ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF08.VALUE,'B01'),B01.F02,'')      
  ENDPROC     
ENDDEFINE
***************************************************特殊欄位------------------發料部門
DEFINE CLASS TXTF07 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14  INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F04='*'
       ELSE
          SELECT F01,F02 FROM A14  INTO CURSOR DEPART ORDER BY F01 WHERE F04='*'
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=createobject("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')         
  ENDPROC
ENDDEFINE  
*************************************************特殊欄位------------------收料部門
DEFINE CLASS TXTF04 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5 
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM A14_1 INTO CURSOR DEPART ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1) AND F01=ANY(SELE F06 FROM E16 WHERE F04-F05>0)
       ELSE
          SELECT F01,F02 FROM A14_1 INTO CURSOR DEPART ORDER BY F01 WHERE  F01=ANY(SELE F06 FROM E16 WHERE F04-F05>0)
       ENDIF   
       IF _TALLY>0
          DEPART_SEEK=createobject("DEPART_SEEK")  
          DEPART_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'
       ENDIF   
    ENDIF   
       THISFORM.PAGEFRAME1.PAGE1.LBLF041.CAPTION=IIF(SEEK(THIS.VALUE,'A14'),A14.F02,'')         
  ENDPROC
ENDDEFINE  

*********************************************************************領料計劃----依料號排列搜尋
DEFINE CLASS OPT_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='領料計劃'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*320
  WIDTH=INT_015*550
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OPT_SEEK'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*290,;
      LEFT=INT_015*10
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      WIDTH=INT_015*550,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=4,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*183,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選取此筆資料!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*225,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.放棄',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='OPT' 
         SELE OPT
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='OPT'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.         
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料        號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*261
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OPT.F02'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='製令號碼'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OPT.F01'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='需求日期'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OPT.F03'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*74
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='應領數量'         
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='OPT.F04-OPT.F05'   
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*100      
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
           FCH='GRID1'
      ENDPROC 
      PROCEDURE CMND1.CLICK            
           FLG=OPT.F02         
           CHK_STR=OPT.F01
           QTY=OPT.F04-OPT.F05      
          AREA1='B08_1'
          THISFORM.RELEASE                                            
      ENDPROC
      PROCEDURE CMND2.CLICK
          FLG='0'
          CHK_STR=''
          QTY=0
          AREA1='B08_1'
         THISFORM.RELEASE
      ENDPROC    
ENDDEFINE            
***************************************領料計劃-------依製令編號排列搜尋
DEFINE CLASS OOQT_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='領料計劃'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*320
  WIDTH=INT_015*550
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OOQT_SEEK'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*290,;
      LEFT=INT_015*10
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      WIDTH=INT_015*550,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=4,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4'
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*183,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選取此筆資料!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*225,;
      TOP=INT_015*295,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.放棄',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='OQT' 
         SELE OQT
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')        
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='OQT'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.         
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='製令編號'
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OQT.F01'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料        號'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*261
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F02'         
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='需求日期'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F03'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*74
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='應領數量'         
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='OQT.F04-OQT.F05'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*100       
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
           FCH='GRID1'
      ENDPROC 
      PROCEDURE CMND1.CLICK            
           FLG=OQT.F01         
           CHK_STR=OQT.F02
           QTY=OQT.F04-OQT.F05      
          AREA1='B08_1'
          THISFORM.RELEASE                                            
      ENDPROC
      PROCEDURE CMND2.CLICK
          FLG='0'
          CHK_STR=''
          QTY=0
          AREA1='B08_1'
         THISFORM.RELEASE
      ENDPROC    
ENDDEFINE            
***********************************************************************
***************************************領料計劃
DEFINE CLASS OQT_SEEK AS FORM
*!*	  AUTOCENTER=.T.
  CAPTION=ALLTRIM(A14.F02)+'         E16.領料計劃'
  TOP=INT_015*110
  LEFT=INT_015*125    
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*325
  WIDTH=INT_015*535
  FONTSIZE=INT_015*9
  MAXBUTTON=.F.
  MINBUTTON=.F.    
  CLOSABLE=.F.
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OQT_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      WIDTH=INT_015*535,;      
      HEIGHT=INT_015*293,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=6,;       
      RECORDSOURCE='OQT',;     
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;            
      COLUMN5.NAME='COLUMN5',;  
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*230,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.確定',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*320,;
      TOP=INT_015*297,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;    
      FONTSIZE=INT_015*9,;      
      CAPTION='\<X.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
  ADD OBJECT CMND3 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*50,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;  
      FONTSIZE=INT_015*9,;
      CAPTION='\<A.全選',;
      TOOLTIPTEXT='全選所有資料!快速鍵->ALT+A'
      NAME='CMND3'
  ADD OBJECT CMND4 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*130,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*297,;        
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<C.清除',;
      TOOLTIPTEXT='清除已全選之資料!快速鍵->ALT+C'
      NAME='CMND4'               
   PROCEDURE INIT 

         SELE OQT
         SET ORDER TO OQT_1
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')   
         THISFORM.SETALL('MOVABLE',.F.,'COLUMN') 
         THISFORM.SETALL('MOUSEPOINTER',99,'COMMANDBUTTON')
         THISFORM.SETALL('MOUSEICON','BMPS\harrow.cur','COMMANDBUTTON')                           
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION=''
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*20
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='OQT.EXP_1'       
         IF PR_NO='1'  
             THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='料        號'
             THISFORM.GRID1.COLUMN2.WIDTH=INT_015*180
             THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F02'               
             THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='製令號碼'
             THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F01'
             THISFORM.GRID1.COLUMN3.WIDTH=INT_015*80      
         ELSE
             THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='製令號碼'
             THISFORM.GRID1.COLUMN2.CONTROLSOURCE='OQT.F01'
             THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
             THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='料        號'
             THISFORM.GRID1.COLUMN3.WIDTH=INT_015*180
             THISFORM.GRID1.COLUMN3.CONTROLSOURCE='OQT.F02'        
         ENDIF
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='上線日期'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='OQT.F03'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*65
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='應領數量'         
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='OQT.F04-OQT.F05'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80     
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='領用數量'         
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='OQT.E11_F07'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*80     

         THISFORM.GRID1.SETFOCUS
      ENDPROC
      ***
      PROC GRID1.INIT      
	 THISFORM.GRID1.COLUMN1.READONLY=.F.
	 THISFORM.GRID1.COLUMN2.READONLY=.T.
	 THISFORM.GRID1.COLUMN3.READONLY=.T.
	 THISFORM.GRID1.COLUMN4.READONLY=.T.
	 THISFORM.GRID1.COLUMN5.READONLY=.T.
	 THISFORM.GRID1.COLUMN6.READONLY=.F.
	 THISFORM.GRID1.COLUMN6.HEADER1.BACKCOLOR=RGB(128,255,0)
	 THISFORM.GRID1.COLUMN1.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN1.AddObject("CheckBox1","CheckBox1") 
	 THISFORM.GRID1.COLUMN1.CurrentControl="CheckBox1" 
	 THISFORM.GRID1.COLUMN1.Sparse=.F.
	 THISFORM.GRID1.COLUMN1.CheckBox1.Visible=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CAPTION=''
	 THISFORM.GRID1.COLUMN1.CheckBox1.AUTOSIZE=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.CENTERED=.T.
	 THISFORM.GRID1.COLUMN1.CheckBox1.BACKSTYLE=0
	 THISFORM.GRID1.COLUMN1.CheckBox1.LEFT=5
	 THISFORM.GRID1.COLUMN6.removeobject("TEXT1")
	 THISFORM.GRID1.COLUMN6.AddObject("TEXTBOX1","TEXTBOX1") 
	 THISFORM.GRID1.COLUMN6.CurrentControl="TEXTBOX1" 
	 THISFORM.GRID1.COLUMN6.Sparse=.F.	
	 THISFORM.GRID1.COLUMN6.TEXTBOX1.Visible=.T.      	 
      ENDPROC
      ***
      PROC GRID1.AFTERROWCOLCHANGE
           LPARAMETERS XCOLINDEX
*!*	           FCH='GRID1'
      ENDPROC 
 PROCEDURE CMND1.CLICK
      SELECT OQT
      CHK_IN='1'
      THISFORM.RELEASE     
 ENDPROC
 PROCEDURE CMND2.CLICK
      CHK_IN='0' 
      THISFORM.RELEASE
 ENDPROC  
 **
 PROCEDURE CMND3.CLICK     
      SELECT OQT
      RE=RECNO('OQT')
      GO TOP
      DO WHILE !EOF()
	     REPLACE OQT.EXP_1 WITH 1 
             REPLACE OQT.E11_F07 WITH (OQT.F04-OQT.F05)
	     SELECT OQT
	     SKIP
      ENDDO
      SELECT OQT
      GO RE  
      THISFORM.GRID1.SETFOCUS 
 ENDPROC      
  PROCEDURE CMND4.CLICK
      SELECT OQT
      RE=RECNO('OQT')
      GO TOP
      DO WHILE !EOF()
             REPLACE OQT.EXP_1 WITH 0 
             REPLACE OQT.E11_F07 WITH 0
             SELECT OQT
             SKIP
      ENDDO
      SELECT OQT
      GO RE
      THISFORM.GRID1.SETFOCUS 
 ENDPROC  
  PROC CMND1.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND1.TOP=INT_015*298
             THISFORM.CMND1.LEFT=INT_015*231
  ENDPROC     
  PROC CMND1.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND1.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND1.TOP=INT_015*297
             THISFORM.CMND1.LEFT=INT_015*230                  
  ENDPROC  
  PROC CMND2.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND2.TOP=INT_015*298
             THISFORM.CMND2.LEFT=INT_015*321
  ENDPROC     
  PROC CMND2.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND2.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND2.TOP=INT_015*297
             THISFORM.CMND2.LEFT=INT_015*320                  
  ENDPROC  
  PROC CMND3.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND3.TOP=INT_015*298
             THISFORM.CMND3.LEFT=INT_015*51
  ENDPROC     
  PROC CMND3.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND3.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND3.TOP=INT_015*297
             THISFORM.CMND3.LEFT=INT_015*50                  
  ENDPROC   
  PROC CMND4.MOUSEENTER      
       LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(255,0,0)
             THISFORM.CMND4.TOP=INT_015*298
             THISFORM.CMND4.LEFT=INT_015*131
  ENDPROC     
  PROC CMND4.MOUSELEAVE      
        LPARAMETERS nButton, nShift, nXCoord, nYCoord 
             THISFORM.CMND4.FORECOLOR=RGB(0,0,0)  
             THISFORM.CMND4.TOP=INT_015*297
             THISFORM.CMND4.LEFT=INT_015*130                  
  ENDPROC    
ENDDEFINE 
*********     
DEFINE CLASS CheckBox1 AS CheckBox
      PROCEDURE CLICK
         SELECT OQT
         IF THIS.VALUE=1
              REPLACE OQT.EXP_1 WITH 1
              REPLACE OQT.E11_F07 WITH (OQT.F04-OQT.F05)
               
         ELSE
              REPLACE OQT.EXP_1 WITH 0
              REPLACE OQT.E11_F07 WITH 0
                 
         ENDIF
         THISFORM.GRID1.SETFOCUS     
   ENDPROC 
ENDDEFINE 
*********     
DEFINE CLASS TEXTBOX1 AS TEXTBOX
  PROCEDURE INTERACTIVECHANGE 
         SELECT OQT
         IF OQT.EXP_1=1
             DO CASE 
                   CASE THIS.VALUE<=0
                    	      THIS.VALUE=(OQT.F04-OQT.F05)
                    	      =MESSAGEBOX('領用數量不得小於等於零,請重新輸入!!',0+64,'提示訊息視窗')        
                  CASE THIS.VALUE>OQT.F04-OQT.F05
			     =MESSAGEBOX('領用數量不得大於'+TRANSFORM(OQT.F04-OQT.F05,'@R 999999999.9999'),0+48,'提示訊息視窗') 
                    	      THIS.VALUE=(OQT.F04-OQT.F05)		                        	      
             ENDCASE   
             REPLACE OQT.E11_F07 WITH THIS.VALUE        
         ENDIF  
         THISFORM.GRID1.SETFOCUS  
   ENDPROC 
ENDDEFINE   
****************************************更換料號輸入畫面
DEFINE CLASS CHGMT_SEEK AS FORM
  AUTOCENTER=.T.
  
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*190
  WIDTH=INT_015*396
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='CHGMT_SEEK'
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*75,;
      FONTSIZE=INT_015*9,;
      NAME='LABEL1'
 ADD OBJECT TEXT1 AS TEXTBOX WITH;     
      TOP=INT_015*70,;
      WIDTH=INT_015*269,;
      LEFT=INT_015*120,;
      HEIGHT=INT_015*25,; 
      FONTSIZE=INT_015*9,;
      MAXLENGTH=43,;
      NAME='TEXT1'
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*100,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*144,;  
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;      
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\HARROW.CUR',;              
      CAPTION='\<Y.執行',;
      TOOLTIPTEXT='確認搜尋所輸入的料號!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      AUTOSIZE=.T.,;
      LEFT=INT_015*240,;
      TOP=INT_015*144,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*80,;
      FONTSIZE=INT_015*9,;
      MOUSEPOINTER=99,;
      MOUSEICON='BMPS\HARROW.CUR',;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消搜尋作業!快速鍵->ALT+C',;
      NAME='CMND2'
  PROCEDURE INIT 
      THISFORM.LABEL1.CAPTION='輸入更換料號'
      THISFORM.Caption='原始料號:'+B08.F08
      THISFORM.TEXT1.READONLY=.F.     
      THISFORM.TEXT1.VALUE=''       
  ENDPROC    
   PROCEDURE TEXT1.INTERACTIVECHANGE     
       IF AT('?',ALLTRIM(THIS.VALUE))<>0
          IF AT('?',ALLTRIM(THIS.VALUE))>1             
             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98) AND LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
          ELSE
             SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE !EMPTY(F98)   
          ENDIF        
          IF _TALLY>0
             MTR_SEEK=createobject("MTR_SEEK")  
             MTR_SEEK.SHOW    
             THIS.VALUE=FLG
             THIS.REFRESH                  
          ENDIF                                     
       ENDIF       
   ENDPROC  
  PROCEDURE CMND1.CLICK 
      IF EMPTY(ALLTRIM(THISFORM.TEXT1.VALUE))
        =MESSAGEBOX('料號欄位不得空白',0+48,'提示訊息視窗')
        THISFORM.TEXT1.SETFOCUS
        RETURN
      ELSE
        FLG=THISFORM.TEXT1.VALUE
      ENDIF                     
      IF !SEEK(FLG,'B01')
         =MESSAGEBOX('物料基本主檔無此料號!',0+48,'提示訊息視窗')
         FLG=''                 
      ELSE           
         SELE E11      &&寫入製令表身更改料號
         SEEK B08.F05+B08.F08
         IF FOUND()
            REPLACE F04 WITH FLG
         ENDIF   
         SELE E16                &&寫入領料計畫更改料號
         SEEK B08.F05+B08.F08
         IF FOUND()
            REPL F02 WITH FLG
         ENDIF                        
         SELECT B08
         REPLACE F08 WITH FLG   &&寫回領料單表身擋更改料號
      ENDIF      
      THISFORM.RELEASE              
  ENDPROC
  PROCEDURE CMND2.CLICK
       FLG=''        
       THISFORM.RELEASE
  ENDPROC      
ENDDEFINE         


