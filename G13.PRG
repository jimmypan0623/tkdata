**程式名稱:G13.進銷耗存明細表
SET EXCL OFF
*!*	G11='G11'+LEFT(DTOS(DATE()),6)   &&月報表檔
*!*	IF FILE(G11+'.DBF')=.T.
*!*		IF !USED('&G11')
*!*		   SELE 0
*!*		   USE (G11) ALIA G11 INDE (G11)
*!*		ELSE
*!*		   SELE G11
*!*		ENDIF
*!*		SET ORDER TO 1  
*!*		IF RECCOUNT('G11')=0
*!*			=MESSAGEBOX(STR(VAL(LEFT(DTOS(DATE()),4))-1911)+'年'+RIGHT(LEFT(DTOS(DATE()),6),2)+'月之月加權平均成本(G08)尚未計算,請計算後再執行',0+64,'提示訊息視窗')
*!*			SELE G11
*!*			USE
*!*		RETURN           
*!*		ENDIF
*!*	ELSE
*!*		=MESSAGEBOX('月份檔尚未建立故無資料,請重新輸入!',0+64,'提示視窗')
*!*		RETURN
*!*	ENDIF	
CLOSE ALL
CLEAR 
AREA1='G11'
FLG='0'
FCH=''
CHK=''
IF !USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE 
   SELE A01
ENDIF
SET ORDER TO 1
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'G13'      
IF !USED('A23')
    SELE 0
    USE A23
ELSE 
   SELE A23
ENDIF
SET ORDER TO 1 
IF !USED ('B01')
   SELE 0
   USE B01 
ELSE 
   SELE B01
ENDIF
SET ORDER TO 1      
G13='G13'+LEFT(DTOS(DATE()),6)   &&單位成本檔
IF !USED('&G13')
   SELE 0
   USE (G13) ALIA G13 
ELSE
   SELE G13
ENDIF
SET ORDER TO 1          
CALCULATE SUM(F03+F04+F05+F06) TO QTY FOR F02=0
G11='G11'+LEFT(DTOS(DATE()),6)   &&月報表檔
IF !USED('&G11')
   SELE 0
   USE (G11) ALIA G11 INDE (G11)
ELSE
   SELE G11
ENDIF
SET ORDER TO 1          
G15='G15'+LEFT(DTOS(DATE()),6)   &&月報表檔
IF !USED('&G15')
   SELE 0
   USE (G15) ALIA G15 
ELSE
   SELE G15
ENDIF
SET ORDER TO 1                  
*******************
G13FORM=CREATEOBJECT("TKG13")
G13FORM.SHOW  
DEFINE CLASS TKG13 AS FORM
  CAPTION='G13.進銷耗存明細表'
*  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=3  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      TOP=INT_015*38,;
      LEFT=INT_015*630,;
      WIDTH=INT_015*60.,;
      CAPTION='總庫存金額'
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT()),;
      TOP=INT_015*38
  ADD OBJECT MTH_LIST AS MTH_LIST WITH;
  	  LEFT=INT_015*85,;
      AUTOCENTER=.T.      
  ADD OBJECT GRID1 AS GRID1 WITH;
           COLUMNCOUNT=13,;            
           RECORDSOURCE='G11',; 
           TOP=INT_015*61,;  
           HEIGHT=INT_015*465,;     
          WIDTH=INT_015*780,;     
          COLUMN1.NAME='COLUMN1',;
          COLUMN2.NAME='COLUMN2',;
          COLUMN3.NAME='COLUMN3',; 
          COLUMN4.NAME='COLUMN4',; 
          COLUMN5.NAME='COLUMN5',;             
          COLUMN6.NAME='COLUMN6',;       
          COLUMN7.NAME='COLUMN7',;       
          COLUMN8.NAME='COLUMN8',;
          COLUMN9.NAME='COLUMN9',;
          COLUMN10.NAME='COLUMN10',;
          COLUMN11.NAME='COLUMN11',;
          COLUMN12.NAME='COLUMN12',;     
          COLUMN13.NAME='COLUMN13' &&增加空白欄使畫面方便觀看
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;      
      TOP=INT_015*0,;
      LEFT=INT_015*500              
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      TOP=INT_015*0,;
      LEFT=INT_015*173,;
      ENABLED=.T.,;
      VISIBLE=.T.
  ADD OBJECT COST_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*388,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*75,;      
      CAPTION='\<T.轉平均成本',;
      NAME='COST_BOTT'                          
  ADD OBJECT LIST_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*465,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*65,;      
      CAPTION='\<L.異動紀錄',;
      NAME='LIST_BOTT'     
  ADD OBJECT REPLY_REMARK AS COMMANDBUTTON WITH;
      TOP=INT_015*5,;
      LEFT=INT_015*533,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*95,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<E.修改期末單價'            
   ADD OBJECT LBLF01 AS LABEL WITH;
      TOP=INT_015*40,;
      LEFT=INT_015*180,;
      HEIGHT=INT_015*17,;      
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*9,;
       CAPTION='期末單價'            
  ADD OBJECT TXTF01 AS TEXTBOX WITH;
      ALIGNMENT=1,;
      TOP=INT_015*33,;
      LEFT=INT_015*230,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*100,;
      MAXLENGTH=15,;
      FONTSIZE=INT_015*9       
   ADD OBJECT LBLF02 AS LABEL WITH;
      TOP=INT_015*40,;
      LEFT=INT_015*340,;
      HEIGHT=INT_015*17,;      
      WIDTH=INT_015*50,;
      FONTSIZE=INT_015*9,;
       CAPTION='期末小計'        
  ADD OBJECT TXTF02 AS TEXTBOX WITH;
      ALIGNMENT=1,;
      TOP=INT_015*33,;
      LEFT=INT_015*390,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*100,;
      MAXLENGTH=16,;
      FONTSIZE=INT_015*9    
  ADD OBJECT YES AS COMMANDBUTTON WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*510,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<Y.確定'
  ADD OBJECT NO AS COMMANDBUTTON WITH;
      TOP=INT_015*33,;
      LEFT=INT_015*552,;
      HEIGHT=INT_015*25,;      
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<N.取消'           
***********************      
  PROCEDURE INIT
       SELE G11
       CALC SUM(F31) TO INV_CNT
       GO TOP
       THISFORM.YES.VISIBLE=.F.
       THISFORM.NO.VISIBLE=.F.
       THISFORM.REC_COUNT.CAPTION=TRANSFORM(ROUND(INV_CNT+QTY,2),'@R 99999999999.99')
*!*	       CHK_STR=IIF(SEEK(DTOS(CTOD((THISFORM.MTH_LIST.DISPLAYVALUE+'/01'))),'A23','A231'),LEFT(DTOC(A23.F01),5),'')
	   CHK_STR=LEFT(THISFORM.MTH_LIST.DISPLAYVALUE,4)+'年'+RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2)+'月'
       THISFORM.ORPGROUP.NEW_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.EDIT_BOTT.VISIBLE=.F.
       THISFORM.ORPGROUP.DEL_BOTT.VISIBLE=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')   
       THISFORM.GRID1.SETALL('READONLY',.T.,'COLUMN') 
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')           
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*149
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN4.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN5.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN6.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN7.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN8.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN9.WIDTH=INT_015*85
       THISFORM.GRID1.COLUMN10.WIDTH=INT_015*85       
       THISFORM.GRID1.COLUMN11.WIDTH=INT_015*85       
       THISFORM.GRID1.COLUMN12.WIDTH=INT_015*85  
       THISFORM.GRID1.COLUMN13.WIDTH=INT_015*60 
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='料        號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='期初數量'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='淨進貨量'
       THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='淨出貨量'  
       THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='生產數量' 
       THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='生產耗用'   
       THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='盤差數量'
       THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='損耗數量'  
       THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='期末數量'  
       THISFORM.GRID1.COLUMN10.HEADER1.CAPTION='期末單價' 
       THISFORM.GRID1.COLUMN11.HEADER1.CAPTION='期末小計'   
       THISFORM.GRID1.COLUMN12.HEADER1.CAPTION='銷貨毛利(%)'  
       THISFORM.GRID1.COLUMN13.HEADER1.CAPTION='' 
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G11.F02'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G11.F03'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='G11.F04'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='G11.F05'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='G11.F06'
       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='G11.F07'
       THISFORM.GRID1.COLUMN7.CONTROLSOURCE='G11.F09'
       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='G11.F10'
       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='G11.F11'	
       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='G11.F21'	 
       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='G11.F31'	
       THISFORM.GRID1.COLUMN12.CONTROLSOURCE="IIF(G11.F15=0,0,ROUND((G11.F15-G11.F21)/G11.F15*100,2))" 
       THISFORM.GRID1.COLUMN13.CONTROLSOURCE=''	
       THISFORM.GRID1.COLUMN10.READONLY=.F.
       THISFORM.GRID1.COLUMN11.READONLY=.F.       
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(G11.F15!=0 .AND. (G11.F15-G11.F21)<0,RGB(255,0,0),'')","COLUMN")   
       JK='料品編號'
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
	THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.          
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.LIST_BOTT.ENABLED=.F.
          THISFORM.COST_BOTT.ENABLED=.F.
          THISFORM.REPLY_REMARK.ENABLED=.F.
          THISFORM.TXTF01.VALUE=''
          THISFORM.TXTF02.VALUE=''          
       ELSE
	THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
	THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.       
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.LIST_BOTT.ENABLED=IIF(A02.F08='*',.T.,.F.) &&判斷有無查看內容明細的權限 
          THISFORM.COST_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.) &&判斷有無轉平均成本單價的權限 
          THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F10='*',.T.,.F.) &&修改平均單價的權限 
       ENDIF          
  ENDPROC 
*********************     
  PROC MTH_LIST.INTERACTIVECHANGE
*!*	       CHK_STR=IIF(SEEK(DTOS(CTOD((THIS.DISPLAYVALUE+'/01'))),'A23','A231'),LEFT(DTOC(A23.F01),5),'')
	   CHK_STR=LEFT(THISFORM.MTH_LIST.DISPLAYVALUE,4)+'年'+RIGHT(THISFORM.MTH_LIST.DISPLAYVALUE,2)+'月'
       THISFORM.GRID1.RECORDSOURCE=''
       SELECT G13
       USE
       G13='G13'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
		IF !USED('&G13')
		   SELE 0
		   USE (G13) ALIA G13 
		ELSE
		   SELE G13
		ENDIF
		SET ORDER TO 1   
       CALCULATE SUM(F03+F04+F05+F06) TO QTY FOR F02=0
       SELECT G15
       USE
       G15='G15'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
		IF !USED('&G15')
		   SELE 0
		   USE (G15) ALIA G15 
		ELSE
		   SELE G15
		ENDIF
		SET ORDER TO 1   
       SELE G11
       USE
       G11='G11'+LEFT(DTOS(CTOD(THIS.DISPLAYVALUE+'/01')),6)
       IF !USED('&G11')
          SELE 0
          USE (G11) ALIA G11
       ELSE
          SELE G11
       ENDIF
       SET ORDER TO 1    
       SELE G11
       CALC SUM(F31) TO INV_CNT
       GO TOP
       THISFORM.REC_COUNT.CAPTION=TRANSFORM(ROUND(INV_CNT+QTY,2),'@R 99999999999.99')
       THISFORM.GRID1.RECORDSOURCE='G11'            	   
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='G11.F02'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='G11.F03'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='G11.F04'
       THISFORM.GRID1.COLUMN4.CONTROLSOURCE='G11.F05'
       THISFORM.GRID1.COLUMN5.CONTROLSOURCE='G11.F06'
       THISFORM.GRID1.COLUMN6.CONTROLSOURCE='G11.F07'
       THISFORM.GRID1.COLUMN7.CONTROLSOURCE='G11.F09'
       THISFORM.GRID1.COLUMN8.CONTROLSOURCE='G11.F10'
       THISFORM.GRID1.COLUMN9.CONTROLSOURCE='G11.F11'	
       THISFORM.GRID1.COLUMN10.CONTROLSOURCE='G11.F21'	 
       THISFORM.GRID1.COLUMN11.CONTROLSOURCE='G11.F31'	
       THISFORM.GRID1.COLUMN12.CONTROLSOURCE="IIF(G11.F15=0,0,ROUND((G11.F15-G11.F21)/G11.F15*100,2))"     
       THISFORM.GRID1.COLUMN13.CONTROLSOURCE=''
	   THISFORM.GRID1.SETFOCUS        
	   THISFORM.REFRESH
       IF THISFORM.GRID1.ACTIVEROW=0
	THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.          
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.LIST_BOTT.ENABLED=.F.
          THISFORM.COST_BOTT.ENABLED=.F.
          THISFORM.REPLY_REMARK.ENABLED=.F.
          THISFORM.TXTF01.VALUE=''
          THISFORM.TXTF02.VALUE=''
       ELSE
	THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
	THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
	THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
	THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
	THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.       
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限    
          THISFORM.LIST_BOTT.ENABLED=IIF(A02.F08='*',.T.,.F.) &&判斷有無查看內容明細的權限 
          THISFORM.COST_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.) &&判斷有無轉平均成本單價的權限 
          THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F10='*',.T.,.F.) &&修改平均單價的權限 
       ENDIF       
  ENDPROC     
****************   
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX     
       THISFORM.GRID1.TOOLTIPTEXT=IIF(G11.F15!=0 .AND. (G11.F15-G11.F21)<0,'銷貨毛利呈現負數','')
       THISFORM.TXTF01.VALUE=G11.F21
       THISFORM.TXTF02.VALUE=G11.F31
       FCH=THISFORM.ACTIVECONTROL.NAME
       CHK=''
       THISFORM.REFRESH
  ENDPROC
 **************修改平均單價
  PROCEDURE REPLY_REMARK.CLICK 
        THISFORM.MTH_LIST.ENABLED=.F.
        THISFORM.GRID1.ENABLED=.F.
        THISFORM.YES.VISIBLE=.T.
        THISFORM.NO.VISIBLE=.T.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.LIST_BOTT.ENABLED=.F.
        THISFORM.COST_BOTT.ENABLED=.F.
        THISFORM.REPLY_REMARK.ENABLED=.F.
	THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
	THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
	THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
	THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.        
	THISFORM.TXTF01.READONLY = .F.
   	SELECT G11
   	LOCK()
        IF !RLOCK()
	    DO FILE_IMPACT
	    RETURN
	ENDIF 
	THISFORM.TXTF01.SETFOCUS
  ENDPROC  
*********** 
 PROC YES.CLICK &&修改確認
    SELECT G11       
     IF  RLOCK()
     	  REPLACE G11.F21 WITH THISFORM.TXTF01.VALUE
     	  REPLACE G11.F31 WITH G11.F21 * G11.F11 
     ELSE 
          DO FILE_IMPACT
         RETURN
     ENDIF	  
    THISFORM.NO.CLICK
 ENDPROC
 *********
 PROC NO.CLICK &&修改取消
   THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
   THISFORM.MTH_LIST.ENABLED=.T.
   THISFORM.YES.VISIBLE=.F.
   THISFORM.NO.VISIBLE=.F.
   THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限     
   THISFORM.LIST_BOTT.ENABLED=IIF(A02.F08='*',.T.,.F.) &&判斷有無查看內容明細的權限 
   THISFORM.COST_BOTT.ENABLED=IIF(A02.F09='*',.T.,.F.) &&判斷有無轉平均成本單價的權限 
   THISFORM.REPLY_REMARK.ENABLED=IIF(A02.F10='*',.T.,.F.) &&修改平均單價的權限    
   THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
   THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
   THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T. 
   THISFORM.ORPGROUP.ESC_BOTT.ENABLED=.T.
   THISFORM.GRID1.ENABLED=.T.     
   THISFORM.GRID1.SETFOCUS
   THISFORM.REFRESH
 ENDPROC  
 ***
*!*	 PROCEDURE TXTF01.INTERACTIVECHANGE
*!*	    THISFORM.TXTF02.VALUE = THISFORM.TXTF01.VALUE * G11.F11 
*!*	 ENDPROC  
***************轉平均成本單價  
 PROCEDURE COST_BOTT.CLICK
	IF MESSAGEBOX('是否確定要將所有料號的平均單價轉至B01之平均成本單價!',4+32+256,'請確認') = 6
		SELE G11
		NOW_POINT=G11.F02
		GO TOP
		DO WHILE !EOF()
			SELE B01
			SEEK G11.F02
			IF FOUND() 
   		       IF G11.F21>0
				 REPLACE  B01.F37 WITH G11.F21
               ENDIF		
			ENDIF
			SELE G11
			SKIP	
		ENDDO
		SELE G11
		SEEK NOW_POINT
		=MESSAGEBOX('轉換成功',0+32,'提示訊息視窗')   
	ENDIF
    THISFORM.GRID1.SETFOCUS    
 ENDPROC     
 **************內容明細 
  PROCEDURE LIST_BOTT.CLICK
     PO_NO=G11.F02     
      	 SELE G15.F01,G15.F02,G15.F03,G15.F04,G15.F05,G15.F07,ROUND(G15.F04*G15.F05,2),G15.F06 FROM G15 WHERE G15.F01=PO_NO INTO CURSOR LIS ORDER BY G15.F02

       IF _TALLY>0
          LIS_CNPT=CREATEOBJECT("LIS_CNPT")  
          LIS_CNPT.SHOW                  
       ELSE
          =MESSAGEBOX('無此料號之明細',0+48,'提示訊息視窗')   
       ENDIF 
       SELE G11
       THISFORM.GRID1.SETFOCUS    
  ENDPROC  
ENDDEFINE  
********************************************* 
DEFINE CLASS LIS_CNPT AS FORM
  AUTOCENTER=.T.
  CAPTION='內容明細'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*300
  WIDTH=INT_015*750
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='LIS_CNPT'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*268,;
      LEFT=INT_015*270
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*750,;      
      HEIGHT=INT_015*270,;  
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*18,;          
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=7,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5',;
      COLUMN6.NAME='COLUMN6',;
      COLUMN7.NAME='COLUMN7'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*443,;
      TOP=INT_015*273,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C' 
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='LIS' 
         THISFORM.CAPTION=THISFORM.CAPTION+'    料號:   '+LIS.F01
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='LIS'         
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='日期'
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='LIS.F02'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*30
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='單據類別'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE="IIF(LIS.F04=0 AND (LIS.F03='B' OR LIS.F03='D'),STUFF(BILL(LIS.F03),5,4,'折讓'),BILL(LIS.F03))"
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*85
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='異動數量'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='LIS.F04'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*85         
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='單    價'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='LIS.F05'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*85                             
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='小    計'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='LIS.EXP_7'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*85
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='累計數量'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='LIS.F06'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*85                                             
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='備註說明'
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='LIS.F07'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*270                            
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME  
      ENDPROC 
      PROCEDURE CMND2.CLICK
          SELE LIS
          USE
          AREA1='G11'
         THISFORM.RELEASE
      ENDPROC      
ENDDEFINE         
***********************************************列印程序
PROCEDURE PNT_PRC 
   SELE G11
   ANS_CHOICE=CREATEOBJECT("ANS_CHOICE")  
   ANS_CHOICE.SHOW    
ENDPROC
********************************************************
DEFINE CLASS ANS_CHOICE AS FORM
  AUTOCENTER=.T.
  CAPTION='請選擇資料列印之選項'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*86
  WIDTH=INT_015*210
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='ANS_CHOICE'
ADD OBJECT DATA_OPTION AS OPTIONGROUP WITH;
      LEFT=INT_015*28,;
      TOP=INT_015*10,;
      AUTOSIZE=.T.,;
      FONTSIZE=INT_015*12,;
      BUTTONCOUNT=3,;
      OPTION1.CAPTION='部品列印',;
      OPTION1.TOP=0,;
      OPTION1.AUTOSIZE=.T.,;
      OPTION2.CAPTION='線材列印',;
      OPTION2.TOP=20,;
      OPTION2.AUTOSIZE=.T.,;
      OPTION3.CAPTION='全部列印',;
      OPTION3.TOP=40,;
      OPTION3.AUTOSIZE=.T.,;
      NAME='DATA_OPTION'       
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*130,;     
      TOP=INT_015*11,;  
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      CAPTION='\<Y.確定',;
      TOOLTIPTEXT='確認所選擇的鍵值!快速鍵->ALT+Y',;
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*130,;
      TOP=INT_015*51,;
      HEIGHT=INT_015*25,;    
      WIDTH=INT_015*50,;
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消作業!快速鍵->ALT+C',;
      NAME='CMND2'      
  *****    
PROCEDURE CMND1.CLICK 
  DO CASE
  	 CASE THISFORM.DATA_OPTION.VALUE=1
  	 	CH=1
  	 	  DATA_RANGE='(部品類)'
  	 	  FILE_NAME=CHK_STR+'進銷耗存明細表'+DATA_RANGE
  	 	  SELECT G11.F02,G11.F03,G11.F04,G11.F05,G11.F06,G11.F07,G11.F09,G11.F10,G11.F11,G11.F21,G11.F31,G11.F15;
  	 	  FROM G11,B01 ORDER BY G11.F02 WHERE G11.F02=B01.F01 .AND. B01.F97!='Y';
  	 	  AND (G11.F03<>0 OR G11.F04<>0 OR G11.F05<>0 OR G11.F06<>0 OR G11.F07<>0 OR G11.F09<>0 OR G11.F10<>0 OR G11.F11<>0 OR G11.F24<>0 OR G11.F26<>0 OR G11.F33<>0)  NOWAIT  
  	 	  FLG='0'	 	 
  	 CASE THISFORM.DATA_OPTION.VALUE=2
  	 	  CH=2
  	 	  DATA_RANGE='(線材類)'
  	 	  FILE_NAME=CHK_STR+'進銷耗存明細表'+DATA_RANGE
  	 	  SELECT G11.F02,G11.F03,G11.F04,G11.F05,G11.F06,G11.F07,G11.F09,G11.F10,G11.F11,G11.F21,G11.F31,G11.F15;
  	 	  FROM G11,B01 ORDER BY G11.F02 WHERE G11.F02=B01.F01 .AND. B01.F97='Y';
                  AND (G11.F03<>0 OR G11.F04<>0 OR G11.F05<>0 OR G11.F06<>0 OR G11.F07<>0 OR G11.F09<>0 OR G11.F10<>0 OR G11.F11<>0 OR G11.F24<>0 OR G11.F26<>0 OR G11.F33<>0)  NOWAIT
                  FLG='1'
  	 CASE THISFORM.DATA_OPTION.VALUE=3 
  	 	  CH=3
  	 	  DATA_RANGE='(全部)'
  	 	  FILE_NAME=CHK_STR+'進銷耗存明細表'+DATA_RANGE
		  SELECT F02,F03,F04,F05,F06,F07,F09,F10,F11,F21,F31,F15 FROM G11 ORDER BY F02;
		  WHERE  (F03<>0 OR F04<>0 OR F05<>0 OR F06<>0 OR F07<>0 OR F09<>0 OR F10<>0 OR F11<>0 OR F24>0 OR F26>0 OR F33<>0) NOWAIT
		  FLG='1'
  ENDCASE
  REPORT FORM ALLTRIM(INT_116)+'G13' PREVIEW
  SELECT G11.F02 品名,B01.F02 品名規格,B01.F99 流水總號,G11.F03 期初數量,G11.F13 期初單價,G11.F23 期初小計,G11.F04 淨進貨量,G11.F14 進貨單價,;
         G11.F24 進貨小計,G11.F05 淨出貨量,G11.F15 出貨單價,G11.F25 出貨小計,G11.F06 生產數量,G11.F16 生產單價,G11.F26 生產小計,;
 	     G11.F07 產耗數量,G11.F17 產耗單價,G11.F27 產耗小計,G11.F09 盤差數量,G11.F19 盤差單價,G11.F29 盤差小計,G11.F10 損耗數量,;
  	     G11.F20 損耗單價,G11.F30 損耗小計,G11.F11 期末數量,;
  	     G11.F21 期末單價,G11.F31 期末小計 FROM G11,B01 ORDER BY G11.F02;
  	     WHERE G11.F02=B01.F01 AND IIF(CH=1,B01.F97!='Y',IIF(CH=2,B01.F97='Y',.T.)) AND (G11.F03<>0 OR G11.F04<>0 OR G11.F05<>0 OR G11.F06<>0 OR G11.F07<>0 OR G11.F09<>0 OR G11.F10<>0 OR G11.F11<>0 OR G11.F24>0 OR G11.F26>0 OR G11.F33<>0) NOWAIT 
  COPY TO &FILE_NAME TYPE XL5
  CLEAR
  THISFORM.RELEASE 
  CH=0                        
 ENDPROC
 ***** 
 PROCEDURE CMND2.CLICK
      THISFORM.RELEASE
 ENDPROC      
ENDDEFINE      
************************************************單據類別     
FUNC BILL
     PARA JUK
     JO=''
     DO CASE
        CASE JUK=' '
             JO='期初'
        CASE JUK='A'
             JO='進貨單'
        CASE JUK='B'
             JO='進貨退出單'
        CASE JUK='C'
             JO='出貨單'
        CASE JUK='D'
             JO='出貨退回單'
        CASE JUK='E'
             JO='移轉單'
        CASE JUK='H'
             JO='盤差調整單'
        CASE JUK='I'
             JO='報廢單'             
        CASE JUK='K'
             JO='製令用料耗損單'
        CASE JUK='L'
             JO='退回入倉單'
        CASE JUK='M'
             JO='委外入庫單'             
        CASE JUK='N'
             JO='進貨檢驗單'
        CASE JUK='P'
             JO='製令領料單'             
        CASE JUK='Q'
             JO='額外生產耗料單'             
        CASE JUK='T'
             JO='完工入庫單'  
        CASE JUK='R'
             JO='製品退出單'               
        CASE JUK='G'
             JO='客供品進貨單'                            
        CASE JUK='Z'
             JO='樣品領用單'     
        CASE JUK='F'
             JO='樣品申請單(廠商)'        
        CASE JUK='1'
             JO='其他進貨費用'                        
     ENDCASE
     RETURN JO 