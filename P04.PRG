***P04.外採購處理單
CLOSE ALL
CLEAR  
FLG='0'
CHK_STR=0
FTR_STR=0
FCH=''
CHK=''
R=0
QTY=0
ASSIS_NO=''
SALES_B_NO=''
SALES_A_NO=''
TQTY=0
HD1='P004 '
HD2='PO'
HD3='外購訂單'
FILE_NAME=''
DSPT=''
AREA1='P03'
AREA2='P04'
IF !USED('A09')
   SELE 0
   USE A09
ELSE
   SELE A09
ENDIF
SET ORDER TO 1
A24='A24'+LEFT(DTOS(DATE()),6)
IF !USED('&A24')
   SELE 0
   USE (A24) ALIA A24
ELSE
   SELE A24
ENDIF
SET ORDER TO 1   
IF !USED('E08')
   SELECT 0
   USE E08
ELSE
   SELECT E08
ENDIF
SET ORDER TO E083      
IF !USED('C01')
   SELE 0
   USE  C01
ELSE
   SELECT  C01
ENDIF
SET ORDER TO C011
IF !USED('D00')
   SELE 0
   USE D00
ELSE
   SELE D00
ENDIF
SET ORDER TO 1      
IF ! USED('A01')
   SELE 0
   USE A01 INDE A01
ELSE
   SELE A01
ENDIF      
SET ORDER TO A01
IF !USED('A02')
   SELE 0
   USE A02 INDE A02
ELSE
   SELE A02
ENDIF
SET ORDER TO A021      
SEEK SYS_OPER+'P04'
IF !USED('B01')
   SELE 0
   USE B01 INDE B01
ELSE
   SELE B01
ENDIF
SET ORDER TO 1
IF !USED('P05')
   SELE 0
   USE P05
ELSE
   SELE P05
ENDIF
SET ORDER TO P051
IF !USED('P06')
   SELE 0
   USE P06
ELSE
   SELE P06
ENDIF
SET ORDER TO 1
IF !USED('P07')
   SELE 0
   USE P07
ELSE
   SELE P07
ENDIF
SET ORDER TO 1 
IF !USED('D01')
   SELE 0
   USE D01 INDE D01
ELSE
   SELE D01
ENDIF
SET ORDER TO D011
     
IF !USED('P02')
   SELE 0
   USE P02 INDE P02
ELSE
   SELE P02
ENDIF
SET ORDER TO P023
IF !USED('P38')
   SELE 0
   USE P38
ELSE
  SELE P38
ENDIF
SET ORDER TO 1     
IF !USED('D07')
   SELE 0
   USE D07 INDE D07
ELSE
   SELE D07
ENDIF
SET ORDER TO D074
IF !USED('P03')
   SELE 0
   USE P03 INDE P03
ELSE
   SELE P03
ENDIF
SET ORDER TO P031
SET RELA TO F03 INTO D01
SET RELA TO F07 INTO A01 ADDI
IF !USED('P04')
   SELE 0
   USE P04 
ELSE
   SELE P04
ENDIF
SET ORDER TO P041      
SET RELA TO F02 INTO B01
P04FORM=CREATEOBJECT("TKP04")
P04FORM.SHOW  
DEFINE CLASS TKP04 AS FORM
  CAPTION='P04.外採購處理單'
*!*	  AUTOCENTER=.T.
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  CONTROLCOUNT=57
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*550
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WIDTH=INT_015*789
  WINDOWTYPE=1
  NAME='TKP04'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      AUTOCENTER=.T.
  ADD OBJECT LBL_REC AS LBL_REC WITH;
      AUTOCENTER =.T.
  ADD OBJECT REC_COUNT AS REC_COUNT  WITH;
      CAPTION=STR(RECCOUNT())        
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;
      AUTOCENTER=.T.
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      AUTOCENTER=.T.
  ADD OBJECT PAGEFRAME1 AS PAGEFRAME WITH;
      LEFT=INT_015*236,;
      WIDTH=INT_015*540,;
      HEIGHT=INT_015*250,;
      FONTSIZE=INT_015*9,;
      PAGECOUNT=2,;
      TABSTRETCH=1,;
      ACTIVEPAGE=1,;
      VISIBLE=.T.,;
      PAGE1.NAME='PAGE1',;
      PAGE1.VISIBLE=.T.,;
      PAGE1.CAPTION='表頭資料',;
      PAGE2.NAME='PAGE2',;
      PAGE2.VISIBLE=.T.,;
      PAGE2.CAPTION='表身詳細資料內容'   
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      AUTOCENTER=.T.
  ADD OBJECT GRID1 AS GRID1 WITH;
      COLUMNCOUNT=3,;            
      RECORDSOURCE='P03',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3'      
  ADD OBJECT GRID2 AS GRID2 WITH;
      TOP=INT_015*256,;
      HEIGHT=INT_015*264,;
      COLUMNCOUNT=5,;            
      RECORDSOURCE='P04',;
      LINKMASTER='P03',;
      RELATIONALEXPR='F02',;
      CHILDORDER='P041',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;
      COLUMN3.NAME='COLUMN3',;
      COLUMN4.NAME='COLUMN4',;
      COLUMN5.NAME='COLUMN5'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;
      AUTOSIZE=.T.              
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      AUTOSIZE=.T.              
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*210,;
      LEFT=INT_015*683          
  ADD OBJECT ANS_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*15,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*68,;
      CAPTION='\<Z.進貨計劃',;
      TOOLTIPTEXT='查看或增修刪進貨方式'
      NAME='ANS_BOTT'      
  ADD OBJECT RCC_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*85,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*68,;      
      CAPTION='\<B.進貨紀錄',;
      TOOLTIPTEXT='查看此筆之進貨紀錄',;
      NAME='RCC_BOTT'                       
  ADD OBJECT SHR_BOTT AS COMMANDBUTTON WITH;
      TOP=INT_015*490,;
      LEFT=INT_015*157,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;
      WIDTH=INT_015*68,;      
      CAPTION='\<S.確認訂單',;
      TOOLTIPTEXT='確認此張採購訂單',;
      VISIBLE=INT_020,;
      ENABLED=INT_020,;
      NAME='SHR_BOTT'                             
  PROCEDURE PAGEFRAME1.PAGE1.INIT     
     THIS.ADDOBJECT('LBLF02','LABEL')
     WITH THIS.LBLF02
          .VISIBLE=.T.
          .LEFT=INT_015*14
          .TOP=INT_015*8
          .WIDTH=INT_015*50
          .CAPTION='採購單號'          
     ENDWITH
     THIS.ADDOBJECT('LBLF03','LABEL')
     WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*33
         .WIDTH=INT_015*50
         .CAPTION='廠商編號'
     ENDWITH
     THIS.ADDOBJECT('LBLF031','LABEL')
     WITH THIS.LBLF031
         .VISIBLE=.T.
         .LEFT=INT_015*115
         .TOP=INT_015*33
         .AUTOSIZE=.T.
     ENDWITH
     THIS.ADDOBJECT('LBLF12','LABEL')
     WITH THIS.LBLF12
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*58
         .WIDTH=INT_015*50
         .CAPTION='交貨地點'
     ENDWITH         
     THIS.ADDOBJECT('LBLF04','LABEL')
     WITH THIS.LBLF04
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*83
         .WIDTH=INT_015*50
         .CAPTION='備註說明'
     ENDWITH       
     THIS.ADDOBJECT('LBLF11','LABEL')
     WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*133
         .WIDTH=INT_015*50
         .CAPTION='已列印否'         
     ENDWITH         
     THIS.ADDOBJECT('LBLF111','LABEL')
     WITH THIS.LBLF111
         .VISIBLE=.T.
         .LEFT=INT_015*66
         .TOP=INT_015*133
         .AUTOSIZE=.T.
     ENDWITH              
     THIS.ADDOBJECT('LBLF01','LABEL')
     WITH THIS.LBLF01
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*8
         .WIDTH=INT_015*50
         .CAPTION='採購日期'
     ENDWITH    
     THIS.ADDOBJECT('LBLF14','LABEL')
     WITH THIS.LBLF14
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*33
         .WIDTH=INT_015*50
         .CAPTION='交貨日期'
     ENDWITH         
     THIS.ADDOBJECT('LBLF05','LABEL')
     WITH THIS.LBLF05
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*58
         .WIDTH=INT_015*50
         .CAPTION='幣        別'
     ENDWITH    
     THIS.ADDOBJECT('LBLF10','LABEL')
     WITH THIS.LBLF10
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*83
         .WIDTH=INT_015*50
         .CAPTION='外加稅金'
     ENDWITH          
     THIS.ADDOBJECT('LBLF06','LABEL')
     WITH THIS.LBLF06
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*133
         .WIDTH=INT_015*50
         .CAPTION='採購總價'         
     ENDWITH    
     THIS.ADDOBJECT('LBLF061','LABEL')
     WITH THIS.LBLF061
         .VISIBLE=.T.
         .LEFT=INT_015*418
         .TOP=INT_015*133
         .AUTOSIZE=.T.
     ENDWITH         
     THIS.ADDOBJECT('LBLF09','LABEL')
     WITH THIS.LBLF09
         .VISIBLE=.T.
         .LEFT=INT_015*368
         .TOP=INT_015*158
         .WIDTH=INT_015*50
         .CAPTION='安全資料'
     ENDWITH    
     THIS.ADDOBJECT('LBLF091','LABEL')
     WITH THIS.LBLF091
         .VISIBLE=.T.
         .LEFT=INT_015*419
         .TOP=INT_015*158
         .AUTOSIZE=.T.
     ENDWITH         
     THIS.ADDOBJECT('LBLF07','LABEL')
     WITH THIS.LBLF07
         .VISIBLE=INT_020
         .LEFT=INT_015*368
         .TOP=INT_015*183
         .WIDTH=INT_015*50
         .CAPTION='確認人員'
     ENDWITH    
     THIS.ADDOBJECT('LBLF071','LABEL')
     WITH THIS.LBLF071
         .VISIBLE=INT_020
         .LEFT=INT_015*419
         .TOP=INT_015*183
         .AUTOSIZE=.T.
     ENDWITH              
     THIS.ADDOBJECT('TXTF02','TEXTBOX')          
     WITH THIS.TXTF02
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*4
          .WIDTH=INT_015*90
          .HEIGHT=INT_015*25
          .MAXLENGTH=10
     ENDWITH        
     THIS.ADDOBJECT('TXTF03','TXTF03')          
     WITH THIS.TXTF03
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*29
          .WIDTH=INT_015*49
          .HEIGHT=INT_015*25
          .MAXLENGTH=5
     ENDWITH        
     THIS.ADDOBJECT('TXTF12','TEXTBOX')          
     WITH THIS.TXTF12
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*54
          .WIDTH=INT_015*288
          .HEIGHT=INT_015*25
          .MAXLENGTH=40
     ENDWITH     
     THIS.ADDOBJECT('TXTF04','TEXTBOX')          
     WITH THIS.TXTF04
          .VISIBLE=.T.
          .LEFT=INT_015*64
          .TOP=INT_015*79
          .WIDTH=INT_015*288
          .HEIGHT=INT_015*25
          .MAXLENGTH=40
     ENDWITH                         
     THIS.ADDOBJECT('TXTF01','TEXTBOX')          
     WITH THIS.TXTF01
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*4
          .WIDTH=INT_015*73
          .HEIGHT=INT_015*25
     ENDWITH        
     THIS.ADDOBJECT('TXTF14','TEXTBOX')          
     WITH THIS.TXTF14
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*29
          .WIDTH=INT_015*73
          .HEIGHT=INT_015*25
     ENDWITH        
     THIS.ADDOBJECT('TXTF05','TEXTBOX')          
     WITH THIS.TXTF05
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*54
          .WIDTH=INT_015*73
          .HEIGHT=INT_015*25
          .MAXLENGTH=4
     ENDWITH      
     THIS.ADDOBJECT('CRCY','CRCY')          
     THIS.ADDOBJECT('TXTF10','TEXTBOX')          
     WITH THIS.TXTF10
          .VISIBLE=.T.
          .LEFT=INT_015*418
          .TOP=INT_015*79
          .WIDTH=INT_015*20
          .HEIGHT=INT_015*1
     ENDWITH      
  ENDPROC   
  *********
  PROCEDURE PAGEFRAME1.PAGE2.INIT
	THIS.ADDOBJECT('LBLF02','LABEL')
	WITH THIS.LBLF02  
	     .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*7
	     .WIDTH=INT_015*50
         .CAPTION='料品編號'
    ENDWITH  
    THIS.ADDOBJECT('LBLF021','LABEL')
    WITH THIS.LBLF021
         .VISIBLE=.T.
         .LEFT=INT_015*327
	     .TOP=INT_015*7
	     .AUTOSIZE=.T.
	     .CAPTION=''
	ENDWITH     
	THIS.ADDOBJECT('LBLF13','LABEL')
    WITH THIS.LBLF13
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*32
	     .WIDTH=INT_015*50
	     .CAPTION='廠商料號'
	ENDWITH     
	THIS.ADDOBJECT('LBLF15','LABEL')
    WITH THIS.LBLF15
         .VISIBLE=.T.
         .LEFT=INT_015*14
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='產  地  別'
	ENDWITH     	
	THIS.ADDOBJECT('LBLF151','LABEL')
    WITH THIS.LBLF151
         .VISIBLE=.T.
         .LEFT=INT_015*87
	     .TOP=INT_015*57
	     .AUTOSIZE=.T.
	     .CAPTION=''
	ENDWITH     		
	THIS.ADDOBJECT('LBLF20','LABEL')
    WITH THIS.LBLF20
         .VISIBLE=.T.
         .LEFT=INT_015*175
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='包裝基量'
	ENDWITH     
	THIS.ADDOBJECT('LBLF21','LABEL')
    WITH THIS.LBLF21
         .VISIBLE=.T.
         .LEFT=INT_015*333
	     .TOP=INT_015*57
	     .WIDTH=INT_015*50
	     .CAPTION='最少採購'
	ENDWITH     	
    THIS.ADDOBJECT('LBLF11','LABEL')
    WITH THIS.LBLF11
         .VISIBLE=.T.
         .LEFT=INT_015*333
         .TOP=INT_015*32
         .WIDTH=INT_015*50
         .CAPTION='採購用途'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF03','LABEL')
    WITH THIS.LBLF03
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*82
         .WIDTH=INT_015*50
         .CAPTION='採購數量'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF05','LABEL')
    WITH THIS.LBLF05
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='採購單價'       
    ENDWITH        
  THIS.ADDOBJECT('LBLF23','LABEL')
    WITH THIS.LBLF23
         .VISIBLE=.T.
         .LEFT=INT_015*14
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='運貨方式'         
    ENDWITH     
    THIS.ADDOBJECT('LBLF24','LABEL')
    WITH THIS.LBLF24
         .VISIBLE=.T.    
         .LEFT=INT_015*14
         .TOP=INT_015*157
         .WIDTH=INT_015*50
         .CAPTION='備註說明'       
    ENDWITH  
    THIS.ADDOBJECT('LBLF06','LABEL')
    WITH THIS.LBLF06
         .VISIBLE=.T.           
         .LEFT=INT_015*333
         .TOP=INT_015*132
         .WIDTH=INT_015*50
         .CAPTION='金額小計'
    ENDWITH  
    THIS.ADDOBJECT('LBLF061','LABEL')
    WITH THIS.LBLF061
         .VISIBLE=.T.           
         .LEFT=INT_015*384
         .TOP=INT_015*132
         .AUTOSIZE=.T.
    ENDWITH  
    THIS.ADDOBJECT('LBLDLVD','LABEL')
    WITH THIS.LBLDLVD
         .VISIBLE=.T.           
         .LEFT=INT_015*14
         .TOP=INT_015*182
         .WIDTH=INT_015*50
         .CAPTION='交        期'
    ENDWITH  
*!*	    THIS.ADDOBJECT('LBLDLVD1','LABEL')
*!*	    WITH THIS.LBLDLVD1
*!*	         .VISIBLE=.T.           
*!*	         .LEFT=INT_015*64
*!*	         .TOP=INT_015*182
*!*	         .AUTOSIZE=.T.
*!*	    ENDWITH      
   THIS.ADDOBJECT('RTGBOX','EDITBOX')&&文書編輯EDITBOX
      WITH THIS.RTGBOX
          .LEFT=INT_015*65
         .TOP=INT_015*178
         .WIDTH=INT_015*380
         .HEIGHT=INT_015*48
         .FONTSIZE=INT_015*8
         .VISIBLE=.T.
         .READONLY=.T.
         .MAXLENGTH=600
         .NAME='RTGBOX'           
    ENDWITH  
    THIS.ADDOBJECT('LBLF08','LABEL')
    WITH THIS.LBLF08
        .VISIBLE=.T.           
        .LEFT=INT_015*333
        .TOP=INT_015*82
        .WIDTH=INT_015*50
        .CAPTION='已進貨量'         
    ENDWITH    
    THIS.ADDOBJECT('LBLF081','LABEL')
    WITH THIS.LBLF081
        .VISIBLE=.T.           
        .LEFT=INT_015*385
        .TOP=INT_015*82
        .AUTOSIZE=.T.
    ENDWITH    
    THIS.ADDOBJECT('LBLF16','LABEL')
    WITH THIS.LBLF16
         .VISIBLE=.T.           
         .LEFT=INT_015*333
         .TOP=INT_015*107
         .WIDTH=INT_015*50
         .CAPTION='取消數量'                           
    ENDWITH     
    THIS.ADDOBJECT('LBLF161','LABEL')
    WITH THIS.LBLF161
         .VISIBLE=.T.           
         .LEFT=INT_015*385
         .TOP=INT_015*107
         .AUTOSIZE=.T.
    ENDWITH             
    THIS.ADDOBJECT('LBLF12','LABEL')
    WITH THIS.LBLF12
         .VISIBLE=.T.           
         .LEFT=INT_015*333
         .TOP=INT_015*157
         .WIDTH=INT_015*50
         .CAPTION='安全資料'                           
    ENDWITH     
    THIS.ADDOBJECT('LBLF121','LABEL')
    WITH THIS.LBLF121
         .VISIBLE=.T.           
         .LEFT=INT_015*385
         .TOP=INT_015*157
         .AUTOSIZE=.T.
    ENDWITH         
	THIS.ADDOBJECT('TXTF02','TXTF02')
	WITH THIS.TXTF02
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*3
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=43
	     .NAME='TXTF02'  
	ENDWITH     
	THIS.ADDOBJECT('TXTF13','TEXTBOX')
	WITH THIS.TXTF13
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*28
	     .WIDTH=INT_015*261
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=20
	     .NAME='TXTF13'	    
	ENDWITH     
    THIS.ADDOBJECT('TXTF11','TXTF11')
    WITH THIS.TXTF11
         .VISIBLE=.T.           
         .LEFT=INT_015*384
         .HEIGHT=INT_015*25
         .TOP=INT_015*28
         .WIDTH=INT_015*149
         .MAXLENGTH=20
         .NAME='TXTF11'
    ENDWITH     
	THIS.ADDOBJECT('TXTF15','TEXTBOX')
	WITH THIS.TXTF15
	     .VISIBLE=.T.
	     .LEFT=INT_015*65
	     .TOP=INT_015*53
	     .WIDTH=INT_015*20
	     .HEIGHT=INT_015*25
	     .MAXLENGTH=2
	     .NAME='TXTF15'	    
	ENDWITH         
    THIS.ADDOBJECT('AREA_NO','AREA_NO')               
    THIS.ADDOBJECT('TXTF20','TEXTBOX')
    WITH THIS.TXTF20
         .VISIBLE=.T.           
         .LEFT=INT_015*226
         .TOP=INT_015*53
         .WIDTH=INT_015*100
         .INPUTMASK='99999999.99'
         .NAME='TXTF20'
    ENDWITH         
    THIS.ADDOBJECT('TXTF21','TEXTBOX')
    WITH THIS.TXTF21
         .VISIBLE=.T.           
         .LEFT=INT_015*384
         .TOP=INT_015*53
         .WIDTH=INT_015*100
         .INPUTMASK='99999999.99'
         .NAME='TXTF21'
    ENDWITH             
    THIS.ADDOBJECT('TXTF03','TEXTBOX')
    WITH THIS.TXTF03
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*78
         .WIDTH=INT_015*100
         .HEIGHT=INT_015*25
         .INPUTMASK='99999999.99'
         .NAME='TXTF03'                            
    ENDWITH     
    THIS.ADDOBJECT('TXTF05','TEXTBOX')
    WITH THIS.TXTF05     
         .VISIBLE=.T.           
         .LEFT=INT_015*65
         .TOP=INT_015*103
         .WIDTH=INT_015*100
         .INPUTMASK='9999999.999999'
         .NAME='TXTF05'
    ENDWITH     
    THIS.ADDOBJECT('CMB1','CMB1')
    WITH THIS.CMB1
         .LEFT=INT_015*166
         .TOP=INT_015*103
         .HEIGHT=INT_015*25
         .NAME='CMB1'
    ENDWITH
  THIS.ADDOBJECT('TXTF23','TEXTBOX')
    WITH THIS.TXTF23     
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*128
          .WIDTH=INT_015*100
          .HEIGHT=INT_015*25
          .MAXLENGTH=14
    ENDWITH  
    THIS.ADDOBJECT('TRANS_STYLE','TRANS_STYLE') 
    THIS.ADDOBJECT('TXTF24','TEXTBOX')
    WITH THIS.TXTF24     
          .VISIBLE=.T.
          .LEFT=INT_015*65
          .TOP=INT_015*153
          .WIDTH=INT_015*255
          .HEIGHT=INT_015*25
          .MAXLENGTH=40
  ENDWITH   
  ENDPROC       
  PROCEDURE PAGEFRAME1.PAGE1.ACTIVATE
     R=0
     SELE P03        
     IF THISFORM.SHRGROUP.VISIBLE=.F.
        THISFORM.GRID1.ENABLED=.T.   
        THISFORM.GRID1.SETFOCUS 
        THISFORM.KEY_LIST.ENABLED=.T.
        THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(ALLTRIM(P03.F07)),RGB(255,0,0),'')","COLUMN")                 
     ELSE
       THISFORM.KEY_LIST.ENABLED=.F.   
     ENDIF           
        THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
        THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)
        THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.F.
        THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,0)       
    IF THISFORM.GRID1.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.SETALL('VALUE','','TEXTBOX')        
        THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.      
        THISFORM.SHR_BOTT.ENABLED=.F.
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限        
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
        THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.) AND EMPTY(P03.F07)    
     ENDIF   
     THISFORM.ANS_BOTT.ENABLED=.F.
     THISFORM.RCC_BOTT.ENABLED=.F.
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)     
  ENDPROC
  PROCEDURE PAGEFRAME1.PAGE2.ACTIVATE
     SELE P04  
     IF THISFORM.SHRGROUP.ENABLED=.F.
         THISFORM.GRID2.READONLY=.T.      
        THISFORM.GRID2.SETFOCUS   
        THISFORM.ANS_BOTT.ENABLED=.T.        
        THISFORM.RCC_BOTT.ENABLED=IIF(P04.F08>0,.T.,.F.)
        THISFORM.SHR_BOTT.ENABLED=.F.
     ENDIF     
        THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.F.
        THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,0)
        THISFORM.PAGEFRAME1.PAGE2.FONTITALIC=.T.
        THISFORM.PAGEFRAME1.PAGE2.FORECOLOR=RGB(0,0,255)      
     IF THISFORM.GRID2.ACTIVEROW=0 .AND. THISFORM.SHRGROUP.ENABLED=.F.
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.F.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.F.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE2.SETALL('VALUE','','TEXTBOX')
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF23.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=''
*!*	        THISFORM.PAGEFRAME1.PAGE2.LBLDLVD1.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE2.RTGBOX.VALUE=''
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.RCC_BOTT.ENABLED=.F.        
     ELSE
        THISFORM.CMDGROUP.TOP_BOTT.ENABLED=.T.      
        THISFORM.CMDGROUP.UP_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.NEXT_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.END_BOTT.ENABLED=.T.
        THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
        THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
        THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
        THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
     ENDIF   
     R=RECNO('&AREA1')
     THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(RECNO('&AREA1')=R,RGB(255,255,0),'')","COLUMN")
     THISFORM.GRID1.ENABLED=.F.     
     THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   &&判斷有無新增的權限
     THISFORM.KEY_LIST.ENABLED=.F.     
  ENDPROC   
  
  PROC INIT       
       SELECT P03
       GO TOP
       THISFORM.PAGEFRAME1.PAGE1.FONTITALIC=.T.
       THISFORM.PAGEFRAME1.PAGE1.FORECOLOR=RGB(0,0,255)      
       THISFORM.PAGEFRAME1.PAGE1.FONTSIZE=INT_015*10
       THISFORM.PAGEFRAME1.PAGE2.FONTSIZE=INT_015*10   
       THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(A02.F04='*',.T.,.F.)   &&判斷有無新增的權限
       THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限  
       THISFORM.PAGEFRAME1.PAGE1.LBLF06.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限(訂單總計) 
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限       
       THISFORM.PAGEFRAME1.PAGE2.LBLF05.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限(單價)
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限
       THISFORM.PAGEFRAME1.PAGE2.LBLF06.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限(小計)
       THISFORM.PAGEFRAME1.PAGE2.LBLF061.VISIBLE=IIF(A02.F10='*',.T.,.F.) &&判斷有無查看單價權限                             
       THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
       THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
       THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')       
       THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
       THISFORM.SHRGROUP.VISIBLE=.F.
       THISFORM.SHRGROUP.ENABLED=.F.
       THISFORM.GRID1.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID2.BACKCOLOR=IIF(SEEK(sys_oper,'A01'),IIF(A01.F11=0,10009146,A01.F11),10009146)
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
       THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='採購單號'
       THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商編號'
       THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商簡稱'
       THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P03.F02'
       THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P03.F03'
       THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D01.F04'
       THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
       THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
       THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68
       THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(EMPTY(ALLTRIM(P03.F07)),RGB(255,0,0),'')","COLUMN")                
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'COLUMN')
       THISFORM.GRID2.SETALL('FONTSIZE',INT_015*9,'HEADER')       
       THISFORM.GRID2.COLUMN1.HEADER1.CAPTION='料品編號'
	   THISFORM.GRID2.COLUMN2.HEADER1.CAPTION='採購用途'
	   THISFORM.GRID2.COLUMN3.HEADER1.CAPTION='採購數量'
	   THISFORM.GRID2.COLUMN4.HEADER1.CAPTION='已進貨量'
	   THISFORM.GRID2.COLUMN5.HEADER1.CAPTION='取消數量'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P04.F02'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='P04.F11'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P04.F03'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P04.F08'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P04.F16'	   
	   THISFORM.GRID2.COLUMN1.WIDTH=INT_015*149
	   THISFORM.GRID2.COLUMN2.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN3.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN4.WIDTH=INT_015*100
       THISFORM.GRID2.COLUMN5.WIDTH=INT_015*100
*       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(P04.F22=0,RGB(255,0,0),IIF(P04.F22>0 AND P04.F22<P04.F09-P04.F18,RGB(0,255,0),''))","COLUMN")                
       THISFORM.GRID2.SETALL("DYNAMICBACKCOLOR","IIF(P04.F22=0,RGB(255,0,0),IIF(P04.F22>0 AND P04.F22<P04.F03-P04.F16,RGB(0,255,0),''))","COLUMN")                
       THISFORM.GRID1.READONLY=.T.       
       THISFORM.GRID2.READONLY=.T.           
       THISFORM.GRID1.SETFOCUS
       IF THISFORM.GRID1.ACTIVEROW=0
          THISFORM.CMDGROUP.ENABLED=.F.
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
          THISFORM.SHR_BOTT.ENABLED=.F.
       ELSE
          THISFORM.CMDGROUP.ENABLED=.T.      
          THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
          THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
          THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限        
          THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.)  AND EMPTY(P03.F07)
       ENDIF          
       THISFORM.KEY_LIST.DISPLAYVALUE='依採購單號排列'       
       JK='採購單號'
       SELE P03
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=P03.F02
  ENDPROC               
  PROC KEY_LIST.INIT 
       WITH THIS 
           .ADDITEM('依採購單號排列')
           .ADDITEM('依廠商編號排列')
       ENDWITH      
  ENDPROC 
  PROC KEY_LIST.INTERACTIVECHANGE                 
       SELE P03 
       DO CASE
          CASE THIS.DISPLAYVALUE='依採購單號排列'
               SET ORDER TO P031 
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='採購單號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P03.F02'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*81
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P03.F03'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D01.F04'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*68 
          CASE THIS.DISPLAYVALUE='依廠商編號排列'
               SET ORDER TO P032
               THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='廠商編號'
               THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P03.F03'
               THISFORM.GRID1.COLUMN1.WIDTH=INT_015*49
               THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商簡稱'
               THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D01.F04'
               THISFORM.GRID1.COLUMN2.WIDTH=INT_015*68
               THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='採購單號'
               THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P03.F02'
               THISFORM.GRID1.COLUMN3.WIDTH=INT_015*81                                                                
       ENDCASE 
        THISFORM.GRID1.SETFOCUS
  ENDPROC      
  PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=P03.F02
       THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=P03.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=D01.F03
       THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=P03.F09
       THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=P03.F07       
       THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION=IIF(P03.F11,'是','否')
       THISFORM.PAGEFRAME1.PAGE1.LBLF111.BACKCOLOR=IIF(P03.F11,RGB(255,255,0),RGB(0,255,0))
       THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=P03.F01
       THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=P03.F14
       THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE=P03.F04
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=P03.F05
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=IIF(P03.F10,'Y','N')
       THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=P03.F12
       THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=TRANSFORM(P03.F06,'999999999.99')
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION  
       IF THIS.ACTIVEROW=0
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.SHR_BOTT.ENABLED=.F.          
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.) AND EMPTY(P03.F07)
       ENDIF   
       CHK=''     
*       THISFORM.REFRESH
  ENDPROC     
  PROC GRID2.AFTERROWCOLCHANGE
       LPARAMETERS NCOLINDEX
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=P04.F02
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=B01.F02
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=P04.F13       
       THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=P04.F11
       THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=P04.F03
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=P04.F05       
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=P04.F15              
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=P04.F20
       THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=P04.F21
       THISFORM.PAGEFRAME1.PAGE2.TXTF23.VALUE=P04.F23
       THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=P04.F24
       THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=IIF(AT(P04.F15,INT_161)=0 .OR. EMPTY(P04.F15),'',SUBSTR(INT_161,AT(P04.F15,INT_161)+2,6))
       THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION=TRANSFORM(P04.F06,'999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=TRANSFORM(P04.F08,'999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION=TRANSFORM(P04.F16,'999999999.99')
       THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=P04.F12
*!*	       THISFORM.PAGEFRAME1.PAGE2.LBLDLVD1.CAPTION=ALLTRIM(DELIVER(P04.F01,P04.F02))
       THISFORM.PAGEFRAME1.PAGE2.RTGBOX.VALUE=ALLTRIM(DELIVER(P04.F01,P04.F02))
       THISFORM.GRID2.TOOLTIPTEXT=IIF(P04.F22=0,'未回覆交期',IIF(P04.F22>0 AND P04.F22<P04.F03-P04.F16,'回覆交期一半',''))
       FCH=THISFORM.ACTIVECONTROL.NAME
       JK=THIS.COLUMN1.HEADER1.CAPTION
       CHK=THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
       IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.F.
          THISFORM.ANS_BOTT.ENABLED=.F. 
       ELSE
          THISFORM.CMDGROUP.SEEK_BOTT.ENABLED=.T.
          THISFORM.ANS_BOTT.ENABLED=.T.
       ENDIF           
       THISFORM.RCC_BOTT.ENABLED=IIF(P04.F08>0,.T.,.F.)       
  ENDPROC 
  PROCEDURE ORPGROUP.NEW_BOTT.CLICK  
    THISFORM.KEY_LIST.ENABLED=.F. 
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1       
       THISFORM.GRID2.RECORDSOURCE=''
       THISFORM.GRID2.CHILDORDER=''
       THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭新增       
       THISFORM.GRID1.ENABLED=.F.   
       THISFORM.GRID2.ENABLED=.F.   
       THISFORM.SHR_BOTT.ENABLED=.F.
       IF INT_112=.T.
          HD=HD1+SUBSTR(DTOS(DATE()),3,4)
          DO ODR_CRT
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=PO_NO
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.REFRESH    		    
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.		                          
             THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
       ELSE
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=''
          THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS   
       ENDIF           
        THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE1.CRCY.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE=INT_011
        THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE=INT_117
        THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE=DATE() 
        THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE   
        THISFORM.PAGEFRAME1.PAGE1.LBLF111.CAPTION='否'
        THISFORM.PAGEFRAME1.PAGE1.LBLF111.BACKCOLOR=RGB(0,255,0)
        THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE=INT_071  
        THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(SEEK(INT_117,'D01'),D01.F04,'')
        THISFORM.PAGEFRAME1.PAGE1.LBLF061.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF091.CAPTION=''
        THISFORM.PAGEFRAME1.PAGE1.LBLF071.CAPTION=''                
        THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE=DATE()
     ELSE
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.              &&處理表身新增
        THISFORM.GRID2.ENABLED=.F.   
        THISFORM.ANS_BOTT.ENABLED=.F.
        THISFORM.RCC_BOTT.ENABLED=.F.        
        THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F. 
        THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.VISIBLE=.T.  
        THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')   
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.F.
        THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE=''        
        THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.AREA_NO.VISIBLE=.T.
        THISFORM.PAGEFRAME1.PAGE2.AREA_NO.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.LBLF151.CAPTION=''        
        THISFORM.PAGEFRAME1.PAGE2.LBLF161.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=0
        THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=EMPTY(A02.F09)
        THISFORM.PAGEFRAME1.PAGE2.LBLF081.CAPTION=TRANSFORM(0,'999999999.99')
        THISFORM.PAGEFRAME1.PAGE2.LBLF121.CAPTION=''
*!*	        THISFORM.PAGEFRAME1.PAGE2.LBLDLVD1.CAPTION=''                
        THISFORM.PAGEFRAME1.PAGE2.RTGBOX.VALUE=''
        THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=1
        THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
        THISFORM.PAGEFRAME1.PAGE2.LBLF061.CAPTION='0'
        THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.DISPLAYVALUE='海運'             
        THISFORM.PAGEFRAME1.PAGE2.TXTF23.VALUE=THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.DISPLAYVALUE 
        THISFORM.PAGEFRAME1.PAGE2.TXTF23.VALUE=''      
        THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=''
     ENDIF   

  ENDPROC  
  PROCEDURE ORPGROUP.EDIT_BOTT.CLICK
     THISFORM.KEY_LIST.ENABLED=.F. 
     THISFORM.GRID1.ENABLED=.F.   
     THISFORM.GRID2.ENABLED=.F.   
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
        SELE P03
        LOCK()
        IF !RLOCK()
           DO FILE_IMPACT
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ELSE
           THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.F.,'TEXTBOX')     &&處理表頭修改
           THISFORM.PAGEFRAME1.PAGE1.TXTF02.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
           THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           THISFORM.PAGEFRAME1.PAGE1.CRCY.VISIBLE=.T.
           THISFORM.PAGEFRAME1.PAGE2.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE1.TXTF12.SETFOCUS
        ENDIF   
     ELSE                                                                &&處理表身修改
        THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.         
        SELE P04
        LOCK()
        IF !RLOCK()
           DO FILE_IMPACT 
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
        ELSE  
           THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.F.,'TEXTBOX')             
           THISFORM.PAGEFRAME1.PAGE2.TXTF05.READONLY=EMPTY(A02.F09)
           THISFORM.PAGEFRAME1.PAGE2.AREA_NO.VISIBLE=.T.
           THISFORM.PAGEFRAME1.PAGE2.AREA_NO.DISPLAYVALUE=IIF(EMPTY(P04.F15),'',SUBSTR(INT_161,AT(P04.F15,INT_161),8))
           THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=SEEK(P03.F03+P04.F02+P03.F05,'P02') .AND. !EMPTY(A02.F09) 
           THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.DISPLAYVALUE=THISFORM.PAGEFRAME1.PAGE2.TXTF23.VALUE
           THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.VISIBLE=.T.
           THISFORM.ANS_BOTT.ENABLED=.F.
           THISFORM.RCC_BOTT.ENABLED=.F.
           THISFORM.PAGEFRAME1.PAGE2.TXTF13.SETFOCUS
       ENDIF        
     ENDIF   
  ENDPROC    
  PROC ORPGROUP.DEL_BOTT.CLICK                    &&刪除資料程序
       IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	        
          IF ALIA()='P03'           &&刪除整張訂單
             SELE P03
             IF F08=.T.
                =MESSAGEBOX('此張訂單已有出貨行為無法整張刪除!',0+64,'提示訊息視窗')              
                RETURN
             ENDIF
                PO_NO=P03.F02
                SELE RECNO() FROM D07 WHERE D07.F01=P03.F02 INTO ARRAY BK1
                JJ1=''                
                IF _TALLY>0                   
                    FOR I= 1 TO ALEN(BK1)
                        JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
                    ENDFOR  
                    KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')
                    RLOCK(KK1,'D07')
                    LL1=RLOCK(KK1,'D07')
                ELSE
                   LL1=.T.   
                ENDIF   
                SELE RECNO() FROM P04 WHERE P04.F01=P03.F02  INTO ARRAY BK2              
                JJ2=''                
                IF _TALLY>0   
                   FOR I= 1 TO ALEN(BK2)
                       JJ2=JJ2+ALLTRIM(STR(BK2(I)))+','
                   ENDFOR    
                   KK2=STUFF(JJ2,RAT(',',JJ2,1),1,'')              
                   RLOCK(KK2,'P04')
                   LL2=RLOCK(KK2,'P04')
                ELSE
                   LL2=.T.   
                ENDIF   
                IF RLOCK('P03') .AND. LL1 .AND. LL2=.T.                
                   IF LEN(ALLTRIM(JJ1))>0 
                      SELE D07
                      FOR I=1 TO ALEN(BK1)
                          GO BK1(I)
                          IF D07.F09='1'    &&如果是已經確認交期者
                             SELE P07       &&回復請購狀態第一次                              
                             SEEK LEFT(D07.F07,10)+D07.F02
                             IF FOUND()
                                REPL F07 WITH F07+D07.F04
                             ELSE                               
                                SELE P05
                                SEEK LEFT(D07.F07,10)
                                IF FOUND()
                                   SELE P06
                                   SEEK LEFT(D07.F07,10)+D07.F02
                                   IF FOUND()
                                      SELE P07
                                      APPEND BLANK
                                      REPL F01 WITH P05.F01
                                      REPL F02 WITH P05.F02
                                      REPL F03 WITH P05.F04
                                      REPL F04 WITH P05.F05
                                      REPL F05 WITH P05.F06
                                      REPL F06 WITH P06.F02
                                      REPL F07 WITH F07+D07.F04
                                      REPL F08 WITH P06.F05
                                      REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
                                      REPL F10 WITH P05.F07                                                                           
                                   ENDIF
                                ENDIF      
                             ENDIF   
                          ELSE
                             SELE P07
                             SEEK LEFT(D07.F07,10)+D07.F02
                             IF FOUND()
                                REPL F11 WITH F11+D07.F04*(-1)
                             ENDIF      
                          ENDIF
                          SELECT E08
                          SEEK D07.F02
                          IF FOUND()
                             REPLACE F20 WITH F20+D07.F04*(-1)
                          ELSE
                             APPEND BLANK
                             REPLACE F01 WITH D07.F03
                             REPLACE F02 WITH D07.F02
                             REPLACE F20 WITH D07.F04*(-1)
                          ENDIF
                          SELE D07
                      ENDFOR    
                   ENDIF                      
                   DELE FROM D07 WHERE D07.F01=P03.F02
                   DELE FROM P04 WHERE P04.F01=P03.F02
                   SELE P03
                   DELE
                   SKIP -1
                   IF BOF()
                      GO TOP
                   ENDIF   
                   UNLOCK ALL
                 IF INT_112=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)                     
                     HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
                     DO ODR_RJT
                  ENDIF  
                ELSE
                   DO FILE_IMPACT                  
                ENDIF             
             THISFORM.GRID1.SETFOCUS
             IF THISFORM.GRID1.ACTIVEROW=0
                THISFORM.CMDGROUP.ENABLED=.F.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.               
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=.F.
             ELSE      
                THISFORM.CMDGROUP.ENABLED=.T.
                THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(A02.F05='*',.T.,.F.)  &&判斷有無修改的權限
                THISFORM.ORPGROUP.DEL_BOTT.ENABLED=IIF(A02.F06='*',.T.,.F.)   &&判斷有無刪除的權限
                THISFORM.ORPGROUP.PNT_BOTT.ENABLED=IIF(A02.F07='*',.T.,.F.)   &&判斷有無列印的權限
             ENDIF     
          ELSE        
              SELE P04                                                      &&刪除單筆資料及其出貨計劃   
              IF F08>0
                =MESSAGEBOX('此筆記錄已有進貨行為無法刪除!',0+64,'提示訊息視窗')
                RETURN
              ENDIF                           
                 SELE RECNO() FROM D07 WHERE D07.F01=P04.F01 AND D07.F02=P04.F02 INTO ARRAY BK3 ORDER BY D07.F01,D07.F02 
                 JJ1=''
                 IF _TALLY>0         
                    FOR I= 1 TO ALEN(BK3)
                        JJ1=JJ1+ALLTRIM(STR(BK3(I)))+','
                    ENDFOR    
                    KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')           
                    RLOCK(KK1,'D07')
                    LL1=RLOCK(KK1,'D07')
                 ELSE
                    LL1=.T.
                 ENDIF      
                 IF RLOCK('P04') .AND. LL1=.T. .AND. RLOCK('P03')
                    IF LEN(ALLTRIM(JJ1))>0 
                       SELE D07
                       FOR I=1 TO ALEN(BK3)
                           GO BK3(I)
                           IF D07.F09='1'      &&如果已經確認交期
                              SELE P07
                              SEEK LEFT(D07.F07,10)+D07.F02
                              IF FOUND()
                                 REPL F07 WITH F07+D07.F04
                              ELSE
                                 SELE P05
                                 SEEK LEFT(D07.F07,10)
                                 IF FOUND()
                                    SELE P06
                                    SEEK LEFT(D07.F07,10)+D07.F02
                                    IF FOUND()
                                       SELE P07
                                       APPEND BLANK
                                       REPL F01 WITH P05.F01
                                       REPL F02 WITH P05.F02
                                       REPL F03 WITH P05.F04
                                       REPL F04 WITH P05.F05
                                       REPL F05 WITH P05.F06
                                       REPL F06 WITH P06.F02
                                       REPL F07 WITH F07+D07.F04
                                       REPL F08 WITH P06.F05
                                       REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
                                       REPL F10 WITH P05.F07  
                                    ENDIF
                                 ENDIF   
                              ENDIF                          
                           ELSE
                              SELE P07
                              SEEK LEFT(D07.F07,10)+D07.F02
                              IF FOUND()
                                 REPL F11 WITH F11+D07.F04*(-1)
                              ENDIF                                 
                           ENDIF   
                           SELECT E08    &&計算最終結餘量
                           SEEK D07.F02
                           IF FOUND()
                              REPLACE F20 WITH F20+D07.F04*(-1)
                           ELSE
                              APPEND BLANK
                              REPLACE F01 WITH D07.F03
                              REPLACE F02 WITH D07.F02
                              REPLACE F20 WITH D07.F04*(-1)
                           ENDIF
                           SELE D07
                        ENDFOR                            
                    ENDIF                        
                    DELE FROM D07 WHERE D07.F01=P04.F01 AND D07.F02=P04.F02
                    SELECT P04
                    REPLACE P03.F06 WITH P03.F06+P04.F06*(-1)
                    SELE P04
                    DELE
                    SKIP -1
                    IF BOF()
                       GO TOP
                    ENDIF   
                 ELSE
                    DO FILE_IMPACT                  
                 ENDIF                   
              THISFORM.GRID2.SETFOCUS
              IF THISFORM.GRID2.ACTIVEROW=0
                 SELE P03
                 PO_NO=P03.F02
                 DELE
                 IF INT_112=.T. .AND. SUBSTR(PO_NO,3,4)=SUBSTR(DTOS(DATE()),3,4)  
                    HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
                    DO ODR_RJT  
                 ENDIF
                 SELE P03
                 SKIP -1
                 IF BOF()
                    GO TOP
                 ENDIF                    
                 THISFORM.PAGEFRAME1.ACTIVEPAGE=1 
                 THISFORM.REFRESH          
              ENDIF
          ENDIF
       ENDIF   
       RELEASE ALL LIKE BK*
  ENDPROC  
  PROCEDURE SHRGROUP.SHURE1_BOTT.CLICK               &&新增確認
    IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
       THISFORM.GRID2.RECORDSOURCE='P04'
       THISFORM.GRID2.CHILDORDER='P041'
	   THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P04.F02'
	   THISFORM.GRID2.COLUMN2.CONTROLSOURCE='P04.F11'
	   THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P04.F03'
	   THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P04.F08'
	   THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P04.F16'       
       SELE P03 
       COD=SYS(21)
       SET ORDER TO P031
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE,'P03')=.T.    &&如果單號重複
           IF INT_112=.T.
              SELECT MAX(F02) FROM P03 WHERE SUBSTR(F02,3,4)=SUBSTR(DTOS(DATE()),3,4) INTO ARRAY GB NOWAIT
              HD=HD1+SUBSTR(DTOS(DATE()),3,4)+THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
              DO ODR_RPT
              THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE=PO_NO
	          THISFORM.PAGEFRAME1.PAGE1.TXTF02.REFRESH	              		           
          ELSE
             =MESSAGEBOX('採購單號重複!',0+48,'提示訊息視窗')
             THISFORM.PAGEFRAME1.PAGE1.TXTF02.SETFOCUS
             SET ORDER TO &COD
             RETURN
          ENDIF   
       ENDIF
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE,'D01')=.F. .OR. EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE)
          =MESSAGEBOX('廠商基本主檔中無此編號請先建立!',0+64,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE1.TXTF03.SETFOCUS
          SET ORDER TO &COD
          RETURN            
       ENDIF
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
          =MESSAGEBOX('採購日期不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          SET ORDER TO &COD
          RETURN
       ENDIF               
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE)
          =MESSAGEBOX('交貨日期不得空白!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
          SET ORDER TO &COD
          RETURN
       ENDIF        
       IF THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE<THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          =MESSAGEBOX('交貨日期不得小於採購日期!',0+64,'提示訊息視窗') 
          THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
          SET ORDER TO &COD
          RETURN
       ENDIF        
       SELE P03          
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE          
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE
          IF INT_020=.F.
             REPLACE F07 WITH '00000'
          ENDIF   
          REPLACE F10 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE='Y',.T.,.F.)
          REPLACE F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
          REPLACE F12 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE
          REPLACE F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
       ENDIF
*       UNLOCK
       SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
       SET ORDER TO &COD
       THISFORM.PAGEFRAME1.PAGE1.ENABLED=.F.
       THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.  
       THISFORM.PAGEFRAME1.ACTIVEPAGE=2
       THISFORM.ORPGROUP.NEW_BOTT.CLICK
       THISFORM.REFRESH
    ELSE
       IF SEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'B01')=.F.
          =MESSAGEBOX('物料基本主檔中無此料號!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN
       ENDIF   
       IF SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,'P04')=.T. 
          =MESSAGEBOX('此料號在此張訂單重複!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF02.SETFOCUS
          RETURN            
       ENDIF    
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE<=0
          =MESSAGEBOX('採購數量不得小於等於 0 !',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
          RETURN
       ENDIF   
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)
          =MESSAGEBOX('產地別不得空白!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.AREA_NO.SETFOCUS
          RETURN
       ENDIF   
       SELE P04
       APPEND BLANK
       LOCK()
       IF RLOCK()
          REPLACE F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
          REPLACE F02 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
          REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
          REPLACE F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
          REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F06 WITH ROUND(F03*F05,INT_068)
          REPLACE F09 WITH F03
          REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
          REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
          REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
          REPLACE F14 WITH IIF(SEEK(LEFT(F11,10),'P07'),P07.F03,'')
          REPLACE F15 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE          
          REPLACE F17 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
          REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
          REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE
          REPLACE F23 WITH THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.DISPLAYVALUE
          REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE
      ENDIF
      UNLOCK          
      SEEK THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE                  
      THISFORM.GRID2.ENABLED=.T.
      THISFORM.GRID2.SETFOCUS            
      SELE D07                                                                           &&寫入進貨計劃
      APPEND BLANK
      LOCK()
      IF RLOCK()
         REPLACE F01 WITH P04.F01
         REPLACE F02 WITH P04.F02
         REPLACE F03 WITH P03.F14
         REPLACE F04 WITH P04.F03
         REPLACE F05 WITH P03.F03
         REPLACE F07 WITH P04.F11
         REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')           
         REPLACE F09 WITH '0'
         REPLACE F10 WITH P04.F13
         REPLACE F11 WITH P03.F14
         REPLACE F12 WITH P04.F20
         REPLACE F13 WITH P04.F23
         REPLACE F16 WITH IIF(SEEK(LEFT(P04.F11,10),'P07'),P07.F03,'')
         SELECT E08    &&再寫入最終結餘量
         SEEK D07.F02
         IF FOUND()
            REPLACE F20 WITH F20+D07.F04
         ELSE
            APPEND BLANK
            REPLACE F01 WITH D07.F03
            REPLACE F02 WITH D07.F02
            REPLACE F20 WITH D07.F04
         ENDIF
      ENDIF  
      UNLOCK
      SELE P07
      SEEK LEFT(P04.F11,10)+P04.F02
      IF FOUND()
         REPLACE P07.F11 WITH F11+P04.F03
      ENDIF 
      UNLOCK  
*!*	      IF THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE<>IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02'),P02.F07,0) &&判斷是否與歷史單價不同
*!*	         SELE P02
*!*	         APPEND BLANK
*!*	         REPL F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE
*!*	         REPL F02 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
*!*	         REPL F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
*!*	         REPL F04 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
*!*	         REPL F06 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
*!*	         REPL F07 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
*!*	         REPL F08 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE
*!*	         REPL F09 WITH 1
*!*	         REPL F11 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF02.VALUE
*!*	         REPL F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE        
*!*	      ENDIF   
      IF MESSAGEBOX('是否分批出貨?',4+32+256,'請確認') = 6	 
         SELE D07     
         THISFORM.ANS_BOTT.CLICK
      ENDIF   
      SELECT P03
      REPLACE P03.F06 WITH P03.F06+P04.F06    
      SELE P04               
      THISFORM.ORPGROUP.NEW_BOTT.CLICK      
    ENDIF               
  
  ENDPROC
  PROCEDURE SHRGROUP.SHURE2_BOTT.CLICK                          &&修改確認
     IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1

        IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE)
           =MESSAGEBOX('訂貨日期不得空白!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF01.SETFOCUS
           RETURN
        ENDIF   
        IF EMPTY(THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE)
           =MESSAGEBOX('交貨日期不得空白!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
           RETURN
        ENDIF        
        IF THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE<THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           =MESSAGEBOX('交貨日期不得小於訂貨日期!',0+48,'提示訊息視窗') 
           THISFORM.PAGEFRAME1.PAGE1.TXTF14.SETFOCUS
           RETURN
        ENDIF                        
        IF P03.F05<>THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
           SELE P04
           SEEK P03.F02
           IF FOUND()
              DO WHILE F01=P03.F02
                 REPL F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE
                 SKIP
              ENDDO
           ENDIF
        ENDIF                    
        SELE P03
        IF RLOCK() 
           REPL F14 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF14.VALUE
           REPL F01 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF01.VALUE
           REPL F04 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF04.VALUE
           REPL F05 WITH THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE
           REPL F13 WITH THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.DISPLAYVALUE
           REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
           REPL F10 WITH IIF(THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE='Y',.T.,.F.)
           REPL F12 WITH THISFORM.PAGEFRAME1.PAGE1.TXTF12.VALUE  
           UNLOCK ALL
        ELSE
           DO FILE_IMPACT
          RETURN   
       ENDIF    
     ELSE                                        &&表身修改確認
        IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE<P04.F08+P04.F18+P04.F16
           =MESSAGEBOX('訂單總數量不得小於已進貨數+開單位過帳量+取消量!',0+48,'提示訊息視窗')
           THISFORM.PAGEFRAME1.PAGE2.TXTF03.SETFOCUS
           RETURN 
        ENDIF 
       IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)
          =MESSAGEBOX('產地別不得空白!',0+48,'提示訊息視窗')
          THISFORM.PAGEFRAME1.PAGE2.AREA_NO.SETFOCUS
          RETURN
       ENDIF           
        IF RLOCK('P03') .AND. RLOCK('P04')
        *IF RLOCK()
           REPL P03.F06 WITH P03.F06+(P04.F06)*(-1)+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE*THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
           SELE P04                              
           IF F13<>THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
              SELECT D07
              SEEK P04.F01+P04.F02
              IF FOUND()
                 DO WHILE F01+F02=P04.F01+P04.F02
                  
                    REPLACE F10 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
                    SELECT D07
                    SKIP
                 ENDDO
              ENDIF
              SELECT P04
           ENDIF
           REPLACE F09 WITH F09+(F03)*(-1)+THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
           REPLACE F05 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE
           REPLACE F06 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE*F05
           REPLACE F11 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF11.VALUE
           REPLACE F13 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE
           REPLACE F15 WITH LEFT(THISFORM.PAGEFRAME1.PAGE2.AREA_NO.DISPLAYVALUE,2)
           REPLACE F20 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE
           REPLACE F21 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE           
           REPLACE F12 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')      
           REPLACE F23 WITH THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.DISPLAYVALUE
           REPLACE F24 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE        
           IF P04.F03<>THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
              =MESSAGEBOX('訂單數量與原數量不同,請同時修改進貨計劃',0+48,'提示訊息視窗')              
              IF THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE>P04.F03   &&若比原來採購數量多則要去加入最終結餘量
                 SELECT E08
                 SEEK P04.F02
                 IF FOUND()
                    REPLACE F20 WITH F20+(THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE-P04.F03)
                 ELSE
                    APPEND BLANK
                    REPLACE F01 WITH P03.F14
                    REPLACE F02 WITH P04.F02
                    REPLACE F20 WITH (THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE-P04.F03)
                 ENDIF
              ENDIF
              SELECT P04
              REPLACE F03 WITH THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE
              THISFORM.ANS_BOTT.CLICK
           ENDIF       
          SELE P04        
*!*	          IF F05<>F17  &&與歷史單價不同
*!*	             REPL F17 WITH F05
*!*	             SELE P02
*!*	             APPEND BLANK
*!*	             RLOCK()
*!*	             REPL F01 WITH P03.F03
*!*	             REPL F02 WITH P03.F01
*!*	             REPL F03 WITH P04.F02
*!*	             REPL F04 WITH P04.F13
*!*	             REPL F06 WITH P03.F05
*!*	             REPL F07 WITH P04.F05
*!*	             REPL F08 WITH P04.F21
*!*	             REPL F09 WITH 1
*!*	             REPL F11 WITH P04.F01
*!*	             REPL F13 WITH P04.F20  
*!*	             REPL F14 WITH P04.F24                   
*!*	          ENDIF   
             UNLOCK ALL
       ELSE
         DO FILE_IMPACT
          RETURN   
       ENDIF   
    ENDIF   
    THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
  ENDPROC   
  PROCEDURE SHRGROUP.ABANDON_BOTT.CLICK
      THISFORM.SHRGROUP.ENABLED=.F.
      THISFORM.SHRGROUP.VISIBLE=.F.      
      THISFORM.ORPGROUP.ENABLED=.T.
      THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.CMDGROUP.ENABLED=.T.
      THISFORM.CMDGROUP.SETALL('ENABLED',.T.,'COMMANDBUTTON')
      THISFORM.CMDGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
      THISFORM.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE2.SETALL('READONLY',.T.,'TEXTBOX')  
      THISFORM.PAGEFRAME1.PAGE1.TXTF03.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF02.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TXTF11.READONLY=.T.
      THISFORM.PAGEFRAME1.PAGE2.TRANS_STYLE.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.CRCY.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE2.AREA_NO.VISIBLE=.F.
      THISFORM.PAGEFRAME1.PAGE1.ENABLED=.T.
      THISFORM.PAGEFRAME1.PAGE2.ENABLED=.T.
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1     
         THISFORM.GRID1.ENABLED=.T.
         THISFORM.GRID2.ENABLED=.T.
         THISFORM.GRID1.SETFOCUS
         THISFORM.KEY_LIST.ENABLED=.T.
         THISFORM.SHR_BOTT.ENABLED=IIF(A02.F11='*',.T.,.F.) AND EMPTY(P03.F07)
      ELSE
         THISFORM.GRID1.ENABLED=.F.
         THISFORM.GRID2.ENABLED=.T.
         THISFORM.GRID2.SETFOCUS
         THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F.
         THISFORM.ANS_BOTT.ENABLED=.T.
         THISFORM.RCC_BOTT.ENABLED=IIF(F08>0,.T.,.F.)         
         IF THISFORM.GRID2.ACTIVEROW=0
            IF INT_112=.T.
               HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
               DO ODR_RJT
            ENDIF    
            SELE P03
            DELE
            SKIP -1
            IF BOF()
               GO TOP
            ENDIF
            THISFORM.PAGEFRAME1.ACTIVEPAGE=1
            THISFORM.REFRESH    
         ENDIF   
      ENDIF       
      UNLOCK ALL
  ENDPROC
  PROCEDURE SHRGROUP.FINISH_BOTT.CLICK
      IF THISFORM.PAGEFRAME1.ACTIVEPAGE=1
         IF THISFORM.GRID2.RECORDSOURCE<>'P04'
            THISFORM.GRID2.RECORDSOURCE='P04'
            THISFORM.GRID2.CHILDORDER='P041'
  	        THISFORM.GRID2.COLUMN1.CONTROLSOURCE='P04.F02'
	        THISFORM.GRID2.COLUMN2.CONTROLSOURCE='P04.F11'
	        THISFORM.GRID2.COLUMN3.CONTROLSOURCE='P04.F03'
	        THISFORM.GRID2.COLUMN4.CONTROLSOURCE='P04.F08'
	        THISFORM.GRID2.COLUMN5.CONTROLSOURCE='P04.F16'         
	     ENDIF   
	     IF INT_112=.T.
            HD=HD1+SUBSTR(DTOS(DATE()),3,4)+PO_NO
            DO ODR_RJT
         ENDIF   
         SELE P03
         DO CASE 
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依採購單號排列'
                 SET ORDER TO P031
            CASE THISFORM.KEY_LIST.DISPLAYVALUE='依廠商編號排列'
                 SET ORDER TO P032
         ENDCASE   
       ENDIF  
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
  ENDPROC     
  PROC ANS_BOTT.CLICK
    DO CASE
           CASE  P04.F19 <> 0
                      =MESSAGEBOX('已有開單未退量,請至P13外購進貨退出單中查詢',16,'請確認') 
                      THISFORM.GRID2.SETFOCUS
                      RETURN
           CASE  P04.F09 = 0
                      =MESSAGEBOX('此料號已有進貨量',16,'請確認') 
                      THISFORM.GRID2.SETFOCUS
                      RETURN      
           OTHERWISE
                      OUT_SEEK=CREATEOBJECT("OUT_SEEK")  
                      OUT_SEEK.SHOW    
                      FLG='0'                    
                      SELECT P04                                       
    ENDCASE       
  ENDPROC
  PROC RCC_BOTT.CLICK         &&進貨紀錄
       SELE F03,F04,F05,F06 FROM D10 WHERE F01+F02=P04.F01+P04.F02  INTO CURSOR RCC ORDER BY F03
       IF _TALLY>0
         RCC_SEEK=CREATEOBJECT("RCC_SEEK")  
         RCC_SEEK.SHOW                                      
         AREA1='P03'
         THISFORM.GRID1.SETFOCUS
       ENDIF  
  ENDPROC    
  PROCEDURE SHR_BOTT.CLICK   &&確認訂單
     IF MESSAGEBOX('是否確資料無誤要確認此張訂單?',4+32+256,'請確認') = 6	                 
        SELECT P03
        RLOCK()
        IF RLOCK()
           REPLACE F07 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
           UNLOCK 
        ELSE
           DO file_impact
        ENDIF   
        THIS.Enabled=.F.
        thisform.grid1.setfocus
     ENDIF   
  ENDPROC
ENDDEFINE    
***********************************************列印程序
PROCEDURE PNT_PRC  
     SELE P03
     REPL F11 WITH .T.
     LK=P03.F02             
     SELECT D07.F01,;
            D07.F02,;
            D07.F03,;
            D07.F04,;
            D07.F05,;
            D07.F13;
     FROM D07 WHERE D07.F01=LK INTO CURSOR D07TMP ORDER BY F02,F03
     SELECT D07TMP.F01,;
            D07TMP.F02,;
            D07TMP.F03,;
            D07TMP.F04,;
            D07TMP.F05,;
            D07TMP.F13,;
            P04.F04,;
            P04.F05,;
            P04.F11,;
            P04.F13;
            FROM D07TMP,P04 WHERE P04.F01=LK AND P04.F02=D07TMP.F02 ORDER BY D07TMP.F02,D07TMP.F03 INTO CURSOR P04TMP
      SELECT P04TMP.F01,;
             P04TMP.F02,;
             P04TMP.F03,;
             P04TMP.F04_A,;
             P04TMP.F05_A,;
             P04TMP.F04_B,;
             P04TMP.F05_B,;
             P04TMP.F11,;
             P04TMP.F13_A,;
             P04TMP.F13_B,;
             P03.F01,;
             P03.F06,;
             P03.F14,;
             P03.F12,;
             P03.F04,;
             P03.F10,;             
             B01.F02,;             
             D01.F03,;
             D01.F05,;
             D01.F08,;             
             D01.F09,;
             D01.F10,;
             D01.F19;
             FROM P04TMP,P03,B01,D01 WHERE P03.F02=P04TMP.F01 AND B01.F01=P04TMP.F02;
             AND D01.F01=P04TMP.F05_A; 
             ORDER BY P04TMP.F02,P04TMP.F03 INTO CURSOR P03TMP
     IF _TALLY >0
          IF MESSAGEBOX('是否要列印英文採購單?',4+32+256,'請確認') = 6	  
*!*	               REPORT FORM ALLTRIM(INT_116)+'P04A' TO PRINT PROMPT PREVIEW  
               REPORT FORM ALLTRIM(INT_116)+'P04A' TO PRINTER PROMPT 
          ELSE
*!*	               REPORT FORM ALLTRIM(INT_116)+'P04' TO PRINTER PROMPT  PREVIEW
               REPORT FORM ALLTRIM(INT_116)+'P04' TO PRINTER PROMPT 
          ENDIF               
     ELSE        
        =MESSAGEBOX('此採購單已全部結清無法列印!',0+48,'提示訊息視窗')                
     ENDIF
     SELE D07TMP
     USE  
     SELE P04TMP
     USE
     SELE P03TMP
     USE 
ENDPROC
************************************************特殊輸入欄位的設定----料號
DEFINE CLASS TXTF02 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=43
  FONTSIZE=INT_015*9
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01 WHERE LEFT(F01,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)    
       ELSE
          SELECT F01,F02 FROM B01 INTO CURSOR MTR ORDER BY F01    
       ENDIF 
       IF _TALLY>0  
          MTR_SEEK=CREATEOBJECT("MTR_SEEK")  
          MTR_SEEK.SHOW    
          THIS.Value=FLG
          *THIS.VALUE=ICASE(!EMPTY(THIS.VALUE) AND EMPTY(FLG),THIS.VALUE,EMPTY(THIS.VALUE) AND !EMPTY(FLG),FLG,'')
          THIS.REFRESH
          FLG='0'        
       ENDIF    
    ENDIF 
     
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION=IIF(SEEK(THIS.VALUE,'B01'),B01.F02,'') 
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=IIF(SEEK(THIS.VALUE,'B01'),B01.F49,'')        
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)       
          THISFORM.PAGEFRAME1.PAGE2.AREA_NO.DISPLAYVALUE=ALLTRIM(SUBSTR(INT_161,AT(IIF(SEEK(THIS.VALUE,'B01'),B01.F49,''),INT_161),8))
       ENDIF   
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION)
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F07,0)
             THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F04,'')
             THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F13,1)
             THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F08,1)
             THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE+THIS.VALUE+THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F14,'')     
       ELSE      
             THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=0
             THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE=''
             THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=1
             THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=1  
             THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE=''           
       ENDIF    
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.REFRESH
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.REFRESH
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.REFRESH
       THISFORM.PAGEFRAME1.PAGE2.TXTF21.REFRESH  
       THISFORM.PAGEFRAME1.PAGE2.TXTF24.REFRESH     
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE>0
          THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=!EMPTY(A02.F09)
       ELSE    
          THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F.
       ENDIF    
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------廠商
DEFINE CLASS TXTF03 AS TEXTBOX
  READONLY=.T.
  MAXLENGTH=5
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF AT('?',ALLTRIM(THIS.VALUE))<>0 
       IF AT('?',ALLTRIM(THIS.VALUE))>1             
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE LEFT(F02,AT('?',THIS.VALUE)-1)=LEFT(THIS.VALUE,AT('?',THIS.VALUE)-1)
       ELSE
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02    
       ENDIF          
       IF _TALLY>0
          VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
          VDR_SEEK.SHOW    
          THIS.VALUE=FLG
          THIS.REFRESH
          FLG='0'        
       ENDIF   
    ELSE
       IF LEN(ALLTRIM(THIS.VALUE))=4
          SELECT F02,F01,F04 FROM D01 INTO CURSOR VDR ORDER BY F02 WHERE F02=ALLTRIM(THIS.VALUE)
          DO CASE
             CASE _TALLY=1
                  THIS.VALUE=VDR.F01
                  THIS.REFRESH
             CASE _TALLY>1
                  VDR_SEEK=CREATEOBJECT("VDR_SEEK")  
                  VDR_SEEK.SHOW    
                  THIS.VALUE=FLG
                  THIS.REFRESH
                  FLG='0'        
          ENDCASE      
       ENDIF    
    ENDIF      
       THISFORM.PAGEFRAME1.PAGE1.LBLF031.CAPTION=IIF(SEEK(THIS.VALUE,'D01'),D01.F03,'')  
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.VALUE=IIF(SEEK(THIS.VALUE,'D01'),D01.F17,'N')
       THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE=IIF(SEEK(THIS.VALUE,'P02'),P02.F06,INT_011)
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=THISFORM.PAGEFRAME1.PAGE1.CRCY.DISPLAYVALUE
       THISFORM.PAGEFRAME1.PAGE1.CRCY.REFRESH
       THISFORM.PAGEFRAME1.PAGE1.TXTF05.REFRESH     
       THISFORM.PAGEFRAME1.PAGE1.TXTF10.REFRESH     
  ENDPROC
ENDDEFINE
***************************************************特殊輸入欄位設定-----------運貨方式       ROWSOURCE='海運,空運,DHL,FEDEX,直取,其他'
DEFINE CLASS TRANS_STYLE AS COMBOBOX 
       LEFT=INT_015*65
       TOP=INT_015*128
       HEIGHT=INT_015*25
       WIDTH=INT_015*100
       FONTSIZE=INT_015*9    
       ROWSOURCE='海運,空運,快遞,自取,直寄,其他'
       ROWSOURCETYPE=1
       STYLE=0
       VALUE=1
       NAME='TRANS_STYLE'
   PROCEDURE INTERACTIVECHANGE
       THISFORM.PAGEFRAME1.PAGE2.TXTF23.VALUE=THIS.DISPLAYVALUE
       THISFORM.PAGEFRAME1.PAGE2.TXTF23.REFRESH
  ENDPROC       
ENDDEFINE
***************************************************幣別設定
DEFINE CLASS CRCY AS COMBOBOX
  HEIGHT=INT_015*25
  AUTOSIZE=.T.
  TOP=INT_015*54
  LEFT=INT_015*418
  FONTSIZE=INT_015*9  
  BOUNDCOLUMN=1
  COLUMNCOUNT=1
  WIDTH=INT_015*84
  ROWSOURCETYPE=1
  STYLE=2
  NAME='CRCY'
  PROCEDURE INIT
    SELECT D00
    GO TOP 
    DO WHILE .NOT. EOF()
       L=4-LEN(ALLTRIM(F01))
       THIS.ADDITEM(F01)
       SKIP
    ENDDO
  ENDPROC
  PROCEDURE INTERACTIVECHANGE
    THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE=THIS.DISPLAYVALUE
    THISFORM.PAGEFRAME1.PAGE1.TXTF05.REFRESH
  ENDPROC
ENDDEFINE  
***************************************************特殊輸入欄位設定-----------採購用途
DEFINE CLASS TXTF11 AS TEXTBOX 
  READONLY=.T.
  MAXLENGTH=20
  FONTSIZE=INT_015*9  
  PROCEDURE INTERACTIVECHANGE
    IF EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE) <> .T. AND INDEXSEEK(THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE,.F.,'B01','B011') =.T.
       IF LEN(ALLTRIM(THIS.VALUE)) = 10
          SELECT F01,F04,F02,F07,F08,F11,F05 FROM P07 WHERE P07.F07 - P07.F11 > 0 AND P07.F06 = THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE AND P07.F01 = LEFT(THIS.VALUE,10) ORDER BY P07.F08 INTO CURSOR POU       
       ELSE   
          SELECT F01,F04,F02,F07,F08,F11,F05 FROM P07 WHERE P07.F07 - P07.F11 > 0 AND P07.F06 = THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE ORDER BY P07.F08 INTO CURSOR POU 
       ENDIF
       SELECT POU
       GO TOP  
       IF _TALLY > 0
          POU_SEEK=CREATEOBJECT("POU_SEEK")  
          POU_SEEK.SHOW    
          THIS.VALUE=ALLTRIM(FLG) + CHK_STR
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE = FTR_STR  
       ENDIF
    ELSE
       CH_NO = ''
       IF AT('?',ALLTRIM(THIS.VALUE)) <> 0
          IF AT('?',ALLTRIM(THIS.VALUE)) > 1
             SELECT F01,F03,F04,F02,F06,F07,F08,F11,F05 FROM P07 WHERE P07.F07 - P07.F11 > 0 AND LEFT(P07.F01,AT('?',THIS.VALUE)-1) = LEFT(THIS.VALUE,AT('?',THIS.VALUE) - 1) ORDER BY P07.F01,P07.F08 INTO CURSOR POU 
          ELSE
             SELECT F01,F03,F04,F02,F06,F07,F08,F11,F05 FROM P07 WHERE P07.F07 - P07.F11 > 0 ORDER BY P07.F01,P07.F08 INTO CURSOR POU     
          ENDIF      
       ENDIF
       IF LEN(ALLTRIM(THIS.VALUE)) = 10 
          SELECT F01,F03,F04,F02,F06,F07,F08,F11,F05 FROM P07 WHERE P07.F07 - P07.F11 > 0 AND P07.F01 = LEFT(ALLTRIM(THIS.VALUE),10) ORDER BY P07.F01,P07.F08 INTO CURSOR POU       
       ENDIF	
       IF _TALLY > 0 AND USED('POU')
          POU2_SEEK=CREATEOBJECT("POU2_SEEK")  
          POU2_SEEK.SHOW    
          THIS.VALUE=ALLTRIM(FLG) + CHK_STR
          THISFORM.PAGEFRAME1.PAGE2.TXTF03.VALUE = FTR_STR  
       ENDIF
       THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE = CH_NO
       THISFORM.PAGEFRAME1.PAGE2.LBLF021.CAPTION = IIF(EMPTY(CH_NO),'',IIF(SEEK(CH_NO,'B01'),B01.F02,''))
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE = IIF(SEEK(CH_NO,'B01'),B01.F49,'')
       IF !EMPTY(THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE)       
          THISFORM.PAGEFRAME1.PAGE2.AREA_NO.DISPLAYVALUE = ALLTRIM(SUBSTR(INT_161,AT(IIF(SEEK(CH_NO,'B01'),B01.F49,''),INT_161),8))
       ENDIF  
       THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE = IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE + THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE + THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F07,0)
       THISFORM.PAGEFRAME1.PAGE2.TXTF13.VALUE = IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE + THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE + THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F04,'')
       THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE = IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE + THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE + THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F13,1)
       THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE = IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE + THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE + THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F08,1)
       THISFORM.PAGEFRAME1.PAGE2.TXTF24.VALUE = IIF(SEEK(THISFORM.PAGEFRAME1.PAGE1.TXTF03.VALUE + THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE + THISFORM.PAGEFRAME1.PAGE1.TXTF05.VALUE,'P02','P023'),P02.F14,'')     
       IF THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE>0
          THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=!EMPTY(A02.F09)
       ELSE    
          THISFORM.PAGEFRAME1.PAGE2.CMB1.VISIBLE=.F.
       ENDIF                                 
    ENDIF
    THIS.REFRESH
    AREA1='P03'
  ENDPROC
ENDDEFINE
*******************************************************待請購明細
DEFINE CLASS POU_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='待請購明細'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*340
  WIDTH=INT_015*500
  FONTSIZE=INT_015*9  
  MAXBUTTON=.F.
  MINBUTTON=.F.  
  CONTROLBOX=.F.
  CLOSABLE=.F.
  BORDERSTYLE=1
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='POU_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*500,;      
      HEIGHT=INT_015*310,;    
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;  
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      ALLOWCELLSELECTION=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      ALLOWROWSIZING=.F.,;
      COLUMNCOUNT=6,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;      
      COLUMN5.NAME='COLUMN5',;     
      COLUMN6.NAME='COLUMN6'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*310,;
      LEFT=INT_015*100,;
      VISIBLE=.T.      
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*273,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*315,;  
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*315,;
      TOP=INT_015*315,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='POU' 
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='POU'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='請購單號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='POU.F01'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='需求對象'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='POU.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='請購日期'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='POU.F02'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*70
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='請購數量'        
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='POU.F07-POU.F11'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*100
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='需求日期'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='POU.F08'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*70
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='來源單號'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='POU.F05'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*80         
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME  
         FLG=POU.F01+IIF(ALLTRIM(POU.F05)='計劃需求','+ ',IIF(ALLTRIM(POU.F05)='廠內耗用' ,'# ', '- '))
         CHK_STR=POU.F04
         FTR_STR=POU.F07-POU.F11
      ENDPROC 
      PROCEDURE CMND1.CLICK  
          SELE POU
          USE
          THISFORM.RELEASE                
      ENDPROC
      PROCEDURE CMND2.CLICK
          FLG=''   
          CHK_STR=''
          FTR_STR=0          
          SELE POU
          USE 
          THISFORM.RELEASE
      ENDPROC      
ENDDEFINE 
*****************************************************採購用途
DEFINE CLASS POU2_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='待請購明細'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*340
  WIDTH=INT_015*680
  FONTSIZE=INT_015*9  
  MAXBUTTON=.F.
  MINBUTTON=.F.  
  CONTROLBOX=.F.
  CLOSABLE=.F.
  BORDERSTYLE=1
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='POU2_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*680,;      
      HEIGHT=INT_015*310,;    
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;  
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      ALLOWCELLSELECTION=.T.,;
      HIGHLIGHTROWLINEWIDTH=4,;
      ALLOWROWSIZING=.F.,;      
      COLUMNCOUNT=7,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;      
      COLUMN5.NAME='COLUMN5',; 
      COLUMN6.NAME='COLUMN6',;    
      COLUMN7.NAME='COLUMN7'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*310,;
      LEFT=INT_015*200,;
      VISIBLE=.T.      
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*373,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*315,;  
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*415,;
      TOP=INT_015*315,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='POU' 
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='POU'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='請購單號'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='POU.F01'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='需求對象'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='POU.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*70         
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='請購料號'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*200
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='POU.F06'         
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='請購日期'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='POU.F02'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*70
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='請購數量'        
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='POU.F07-POU.F11'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='需求日期'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='POU.F08'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*70
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='來源單號'
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='POU.F05'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*80         
         THISFORM.GRID1.SETFOCUS
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME  
         FLG=POU.F01+IIF(ALLTRIM(POU.F05)='計劃需求','+ ',IIF(ALLTRIM(POU.F05)='廠內耗用' ,'# ','- '))
         CHK_STR=POU.F04
         FTR_STR=POU.F07-POU.F11
         CH_NO=POU.F06
      ENDPROC 
      PROCEDURE CMND1.CLICK  
          SELE POU
          USE
          THISFORM.RELEASE                
      ENDPROC
      PROCEDURE CMND2.CLICK
          FLG=''   
          CHK_STR=''
          FTR_STR=0   
          CH_NO=''       
          SELE POU
          USE 
          THISFORM.RELEASE
      ENDPROC      
ENDDEFINE               
***************************************************特殊輸入欄位設定-----------產地別
DEFINE CLASS AREA_NO AS COMBOBOX 
       LEFT=INT_015*65
       TOP=INT_015*53
       HEIGHT=INT_015*25
       FONTSIZE=INT_015*9       
       ROWSOURCE=INT_161
       ROWSOURCETYPE=1
       STYLE=2
       VALUE=1
       NAME='AREA_NO'
   PROCEDURE INTERACTIVECHANGE
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.VALUE=LEFT(THIS.DISPLAYVALUE,2)
       THISFORM.PAGEFRAME1.PAGE2.TXTF15.REFRESH
  ENDPROC       
ENDDEFINE
******************************************************詢價紀錄BUTTON
DEFINE CLASS CMB1 AS COMMANDBUTTON
   HEIGHT=INT_015*25
   WIDTH=INT_015*65
   TOP=INT_015*108
   LEFT=INT_015*165
   FONTSIZE=INT_015*9
   NAME='CMB1'
   CAPTION='詢價紀錄'
   TOOLTIPTEXT='查看詢價紀錄資料'
   PROC CLICK
        SELE P02        
        GF=THISFORM.PAGEFRAME1.PAGE2.TXTF02.VALUE
             SLP_SEEK=CREATEOBJECT("SLP_SEEK")  
             SLP_SEEK.SHOW    
             IF !EMPTY(FLG)
                THISFORM.PAGEFRAME1.PAGE2.TXTF05.VALUE=FLG
                THISFORM.PAGEFRAME1.PAGE2.TXTF20.VALUE=FTR_STR
                THISFORM.PAGEFRAME1.PAGE2.TXTF21.VALUE=CHK_STR
                THISFORM.PAGEFRAME1.PAGE2.TXTF05.REFRESH
                THISFORM.PAGEFRAME1.PAGE2.TXTF20.REFRESH
                THISFORM.PAGEFRAME1.PAGE2.TXTF21.REFRESH                                
            ENDIF               
             FLG='0'                    
             AREA1='P03'
             SELE P04
*          ENDIF 
  ENDPROC     
ENDDEFINE       
*******************************************************詢價紀錄
DEFINE CLASS SLP_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='詢價紀錄'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*340
  WIDTH=INT_015*780
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='SLP_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      TOP=INT_015*0,;
      WIDTH=INT_015*780,;      
      HEIGHT=INT_015*310,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=9,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;      
      COLUMN4.NAME='COLUMN4',;      
      COLUMN5.NAME='COLUMN5',;      
      COLUMN6.NAME='COLUMN6',;      
      COLUMN7.NAME='COLUMN7',;      
      COLUMN8.NAME='COLUMN8',;      
      COLUMN9.NAME='COLUMN9'
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*310,;
      LEFT=INT_015*130,;
      VISIBLE=.T.      
  ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
      LEFT=INT_015*303,;    
      HEIGHT=INT_015*25,;   
      TOP=INT_015*315,;  
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<S.選取',;
      TOOLTIPTEXT='選擇游標所指的紀錄!快速鍵->ALT+S'
      NAME='CMND1'
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*345,;
      TOP=INT_015*315,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;      
      CAPTION='\<C.取消',;
      TOOLTIPTEXT='取消此搜尋畫面!快速鍵->ALT+C'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='P02' 
        SELE P02
        SET FILTER TO F01=P03.F03 .AND. F03=GF .AND. F06=P03.F05
        SEEK P03.F03+GF
         GO TOP
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='P02'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='異動日期'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*73
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='P02.F02'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='廠商料號'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='P02.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*200
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='單        價'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='P02.F07'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='最小訂貨量'        
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='P02.F08'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='包裝基量'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='P02.F13'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN6.HEADER1.CAPTION='前置日數'
         THISFORM.GRID1.COLUMN6.CONTROLSOURCE='P02.F09'
         THISFORM.GRID1.COLUMN6.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN7.HEADER1.CAPTION='交易條件'
         THISFORM.GRID1.COLUMN7.CONTROLSOURCE='P02.F10'
         THISFORM.GRID1.COLUMN7.WIDTH=INT_015*83
         THISFORM.GRID1.COLUMN8.HEADER1.CAPTION='備註說明'
         THISFORM.GRID1.COLUMN8.CONTROLSOURCE='P02.F14'
         THISFORM.GRID1.COLUMN8.WIDTH=INT_015*159
         THISFORM.GRID1.COLUMN9.HEADER1.CAPTION='安全資料'
         THISFORM.GRID1.COLUMN9.CONTROLSOURCE='P02.F11'
         THISFORM.GRID1.COLUMN9.WIDTH=INT_015*74
         THISFORM.GRID1.SETFOCUS
         IF THISFORM.GRID1.ACTIVEROW<>0
              THISFORM.GRID1.AFTERROWCOLCHANGE 
         ENDIF         
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME  
         FLG=P02.F07
         CHK_STR=P02.F08
         FTR_STR=P02.F13
      ENDPROC 
      PROCEDURE CMND1.CLICK  
          THISFORM.RELEASE                
          SET FILTER TO                                   
      ENDPROC
      PROCEDURE CMND2.CLICK
          FLG=''   
          CHK_STR=0
          FTR_STR=0          
          THISFORM.RELEASE
          SET FILTER TO
      ENDPROC      
ENDDEFINE            
*********************************************************************進貨計劃
DEFINE CLASS OUT_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='進貨計劃'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*369
  WIDTH=INT_015*401
  FONTSIZE=INT_015*9
  CONTROLBOX=.F.
  BORDERSTYLE=1  
  MAXBUTTON=.F.
  MINBUTTON=.F.
  MOVABLE=.F.
  CLOSABLE=.F.
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='OUT_SEEK'
  ADD OBJECT SHAPE1 AS SHAPE1 WITH;
      LEFT=INT_015*3,;
      WIDTH=INT_015*395,;
      HEIGHT=INT_015*65
  ADD OBJECT SHAPE2 AS SHAPE2 WITH;    
      LEFT=INT_015*3,;
      TOP=INT_015*67,;
      WIDTH=INT_015*395,;
      HEIGHT=INT_015*265
  ADD OBJECT SHAPE3 AS SHAPE3 WITH;
      LEFT=INT_015*3,;
      TOP=INT_015*334,;
      WIDTH=INT_015*395,;
      HEIGHT=INT_015*33    
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*299,;
      LEFT=INT_015*40
  ADD OBJECT ORPGROUP AS ORPGROUP WITH;    
      TOP=INT_015*333,;
      LEFT=INT_015*40
  ADD OBJECT PERMIT_BOTT AS COMMANDBUTTON WITH;
      VISIBLE=.T.,;
      TOP=INT_015*338,;
      LEFT=INT_015*235,;
      HEIGHT=INT_015*25,;
      FONTSIZE=INT_015*9,;      
      WIDTH=INT_015*65,;
      CAPTION='\<Y.確認交期',;
      NAME='PERMIT_BOTT'                             
  ADD OBJECT KEY_LIST AS KEY_LIST WITH;
      VISIBLE=.F.    
  ADD OBJECT LBLF03 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*7,;
      WIDTH=INT_015*50,;
      CAPTION='進貨日期'
  ADD OBJECT TXTF03 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*58,;
      WIDTH=INT_015*70,;
      HEIGHT=INT_015*25,;
      NAME='TXTF03' 
  ADD OBJECT LBLF04 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*140,;
      WIDTH=INT_015*50,;
      CAPTION='進貨數量'
  ADD OBJECT TXTF04 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*191,;
      WIDTH=INT_015*80,;
      HEIGHT=INT_015*25,;
      INPUTMASK='99999999.99',;
      NAME='TXTF04'
  ADD OBJECT LBLF13 AS LABEL WITH;
      TOP=INT_015*8,;
      LEFT=INT_015*283,;
      WIDTH=INT_015*50,;
      CAPTION='運貨方式'    
  ADD OBJECT TXTF13 AS TEXTBOX WITH;
      TOP=INT_015*4,;
      LEFT=INT_015*334,;
      WIDTH=INT_015*55,;
      HEIGHT=INT_015*25,;
      NAME='TXTF13'    
ADD  OBJECT TRANS_STYLE AS COMBOBOX WITH;
       VISIBLE=.F.,;
       LEFT=INT_015*334,;
       TOP=INT_015*4,;
       HEIGHT=INT_015*25,;
       WIDTH=INT_015*55,;
       FONTSIZE=INT_015*9 ,;   
       ROWSOURCE='海運,空運,快遞,自取,直寄,其他',;
       ROWSOURCETYPE=1,;
       STYLE=2,;
       VALUE=1,;
       NAME='TRANS_STYLE'
  ADD OBJECT LBLF17 AS LABEL WITH;
      TOP=INT_015*36,;
      LEFT=INT_015*7,;
      WIDTH=INT_015*50,;
      CAPTION='備註說明'
  ADD OBJECT TXTF17 AS TEXTBOX WITH;
      TOP=INT_015*32,;
      LEFT=INT_015*58,;
      WIDTH=INT_015*240,;
      HEIGHT=INT_015*25,;
      MAXLENGTH=40,;
      NAME='TXTF17' 
  ADD OBJECT LBLF_C66 AS LABEL WITH;
      TOP=INT_015*310,;
      LEFT=INT_015*10,;
      AUTOSIZE=.T.,;
      BACKCOLOR=RGB(255,255,0),;
      CAPTION=''
  ADD OBJECT LBLQTY AS LABEL WITH;
      TOP=INT_015*310,;
      LEFT=INT_015*265,;
      AUTOSIZE=.T.,;
      CAPTION='未排入量：'    
  ADD OBJECT LBLTQTY AS LABEL WITH;
      TOP=INT_015*310,;
      LEFT=INT_015*325,;
      AUTOSIZE=.T.    
  ADD OBJECT SHRGROUP AS SHRGROUP WITH;
      TOP=INT_015*27,;
      LEFT=INT_015*302               
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      LEFT=INT_015*10,;
      TOP=INT_015*71,;
      WIDTH=INT_015*381,;      
      HEIGHT=INT_015*230,;      
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;      
      DELETEMARK=.F.,;
      READONLY=.T.,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=5,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',; 
      COLUMN4.NAME='COLUMN4',; 
      COLUMN5.NAME='COLUMN5'     
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*171,;
      TOP=INT_015*338,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='取消此作業畫面!快速鍵->ALT+X'
      NAME='CMND2'
     PROCEDURE INIT
         THISFORM.SETALL('HEIGHT',INT_015*25,'TEXTBOX')
         THISFORM.SETALL('HEIGHT',INT_015*17,'LABEL')         
         THISFORM.SETALL('FONTSIZE',INT_015*9,'TEXTBOX')
         THISFORM.SETALL('FONTSIZE',INT_015*9,'LABEL')           
         SELECT D07
         SET FILTER TO F01=P04.F01 .AND. F02=P04.F02
         CALC SUM(F04) TO TQTY
         SEEK P04.F01+P04.F02
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')
         THISFORM.GRID1.SETALL("DYNAMICBACKCOLOR","IIF(D07.F09='0',RGB(255,0,0),'')","COLUMN")                  
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='D07'
         THISFORM.CMDGROUP.VISIBLE=.F.
         THISFORM.ORPGROUP.PNT_BOTT.VISIBLE=.F.
         THISFORM.ORPGROUP.ESC_BOTT.VISIBLE=.F.
         THISFORM.SHRGROUP.VISIBLE=.F.
         THISFORM.SHRGROUP.ENABLED=.F.         
         THISFORM.SETALL('READONLY',.T.,'TEXTBOX')
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='進貨日期'
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*68
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='D07.F03'
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='進貨數量'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='D07.F04'
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*68
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='運貨方式'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='D07.F13'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*50  
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='備註說明'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='D07.F17'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*130      
         THISFORM.GRID1.COLUMN5.HEADER1.CAPTION='安全資料'
         THISFORM.GRID1.COLUMN5.CONTROLSOURCE='D07.F08'
         THISFORM.GRID1.COLUMN5.WIDTH=INT_015*90
         THISFORM.GRID1.SETFOCUS
         FCH='GRID1'
         IF THISFORM.GRID1.ACTIVEROW=0      
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
            THISFORM.PERMIT_BOTT.ENABLED=.F. 
         ELSE          
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.)  .OR. THISFORM.GRID1.ACTIVEROW=1                          
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
            THISFORM.PERMIT_BOTT.ENABLED=IIF(D07.F09='0',.T.,.F.)  AND !EMPTY(P03.F07)    
            THISFORM.TXTF03.VALUE=D07.F03
            THISFORM.TXTF04.VALUE=D07.F04
            THISFORM.TXTF13.VALUE=D07.F13
            THISFORM.TXTF17.VALUE=D07.F17   
            THISFORM.LBLF_C66.CAPTION = IIF(EMPTY(D07.F14) OR D07.F14 ='4','','此筆計畫已被提出交期之異動 >> ' + ICASE(D07.F14 = '1','提前交期',D07.F14 = '2','延後交期',D07.F14 = '3','取消訂購',''))
         ENDIF                     
         THISFORM.LBLTQTY.CAPTION=ALLTRIM(STR(P04.F09-TQTY))
         THISFORM.CMND2.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.) 
	 	 THISFORM.CMND2.ENABLED=.T.                    
         THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(P04.F09-TQTY<>0,.T.,.F.)               
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
         LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME 
         IF THIS.ACTIVEROW=0        
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.
            THISFORM.PERMIT_BOTT.ENABLED=.F. 
         ELSE               
            THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1                               
            THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.         
	         THISFORM.PERMIT_BOTT.ENABLED=IIF(D07.F09='0',.T.,.F.)  AND !EMPTY(P03.F07)                                        
         ENDIF            
            THISFORM.TXTF03.VALUE=D07.F03
            THISFORM.TXTF04.VALUE=D07.F04
            THISFORM.TXTF13.VALUE=D07.F13
            THISFORM.TXTF17.VALUE=D07.F17                
            THISFORM.LBLF_C66.CAPTION = IIF(EMPTY(D07.F14) OR D07.F14 ='4','','此筆計畫已被提出交期之異動 >> ' + ICASE(D07.F14 = '1','提前交期',D07.F14 = '2','延後交期',D07.F14 = '3','取消訂購',''))
         IF P04.F09-TQTY>0
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
         ELSE
            THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.F.                     
         ENDIF
      ENDPROC 
 
      PROCEDURE CMND2.CLICK   &&離開進貨計劃視窗畫面
         IF P04.F18>TQTY
            =MESSAGEBOX('進貨計劃的總數量小於開單未進量',0+64,'提示訊息視窗')
            RETURN
         ELSE
            IF P04.F18>0
               TMPQTY=P04.F18
               SELECT D07
               SEEK P04.F01+P04.F02
               IF FOUND()
                  
                     DO WHILE F01+F02=P04.F01+P04.F02 
                        IF TMPQTY>0
                           IF TMPQTY<=F04
                              REPLACE F06 WITH TMPQTY
                           ELSE
                              REPLACE F06 WITH F04
                           ENDIF
                           TMPQTY=TMPQTY-F06
                        ELSE
                           REPLACE F06 WITH 0   
                        ENDIF     
                        SELECT D07
                        SKIP
                     ENDDO
                 
               ENDIF
            ENDIF       
         ENDIF
         IF P04.F09-TQTY>0  
            IF MESSAGEBOX('尚有'+TRANSFORM(P04.F09-TQTY,'@J 99999999.99')+'未排入進貨計劃是否取消?',4+32+256,'請確認') = 6	 
               IF A02.F06=SPACE(1)
                  =MESSAGEBOX('您沒有取消訂單的權限,請重新新增進貨計劃',0+64,'提示訊息視窗')                     
                  RETURN
               ENDIF             
               SELECT E08
               SEEK P04.F02
               IF FOUND()
                  REPLACE F20 WITH F20+(P04.F09-TQTY)*(-1)
               ELSE
                  APPEND BLANK
                  REPLACE F01 WITH P03.F14
                  REPLACE F02 WITH P04.F02
                  REPLACE F20 WITH (P04.F09-TQTY)*(-1)
               ENDIF    
               SELE P04     
               REPLACE P04.F16 WITH P04.F16+P04.F09-TQTY
               REPLACE P04.F09 WITH TQTY           
               SELECT D07

            ENDIF               
         ENDIF
         ***傳送郵件         
         IF EMPTY(THISFORM.TXTF03.VALUE)
            IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE' 
               MAIL_TEXT = ''
               TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
               WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
               MAIL_TEXT = '採購單號：' + P04.F01 + TMPCHR + ;
     	         		   '料品編號：' + P04.F02 + TMPCHR + ;
     	         		   '需求單號：' + P05.F06 + TMPCHR + ;
     	         		   '採購用途：' + ALLTRIM(P04.F11) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)
     	       ***傳送給業務助理     	       
               IF SEEK(LEFT(ALLTRIM(P04.F11),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) ='Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(P04.F11),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                  ASSIS_NO=A01.F01
                  IF OS()="Windows 5.01"
                     SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(P04.F11) + '已被刪除','TEXT',MAIL_TEXT)
                  ELSE
                     IF !EMPTY(ALLTRIM(ASSIS_NO))
                        FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                        STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已被刪除<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)
                     ENDIF   
                  ENDIF   
               ELSE
                 ASSIS_NO=''   
               ENDIF    	
               ***傳送給業務B
               IF SEEK(LEFT(ALLTRIM(P04.F11),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) ='Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(P04.F11),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                  SALES_B_NO=A01.F01
                  IF SALES_B_NO<>ASSIS_NO
                     IF OS()="Windows 5.01"
                        SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(P04.F11) + '已被刪除','TEXT',MAIL_TEXT)
                     ELSE
                        IF !EMPTY(ALLTRIM(SALES_B_NO))
                           FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                           STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已被刪除<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                        ENDIF   
                     ENDIF
                  ENDIF   
               ELSE
                  SALES_B_NO=''   
               ENDIF         	   
               ***傳送給業務A
               IF SEEK(LEFT(ALLTRIM(P04.F11),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) ='Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(P04.F11),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                  SALES_A_NO=A01.F01
                  IF SALES_A_NO<>SALES_B_NO 
                     IF OS()="Windows 5.01"
                        SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(P04.F11) + '已被刪除','TEXT',MAIL_TEXT)
                     ELSE
                        IF !EMPTY(ALLTRIM(SALES_A_NO))
                           FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                           STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已被刪除<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)
                        ENDIF   
                     ENDIF
                  ENDIF   
               ELSE
                   SALES_A_NO=''   
               ENDIF                                                     
               WAIT CLEAR  
            ENDIF   
         ENDIF
         ***             
         DSPT=''            &&結束進貨計劃畫面離開前先把到貨分配暫存變數清空
         SELECT D07
         SET FILTER TO      
         THISFORM.RELEASE
      ENDPROC    
      PROC ORPGROUP.NEW_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F.
           THISFORM.PERMIT_BOTT.ENABLED=.F.
           SELE D07
           CALC SUM(F04) TO TQTY
           THISFORM.TXTF03.READONLY=.F.
           THISFORM.TXTF04.READONLY=.F.
           THISFORM.TXTF13.READONLY=.F.
           THISFORM.TXTF17.READONLY=.F.
           THISFORM.TXTF13.VISIBLE=.F.
           THISFORM.TRANS_STYLE.VISIBLE=.T.
           THISFORM.TXTF03.VALUE=CTOD('')
           THISFORM.TXTF04.VALUE=P04.F09-TQTY
           THISFORM.TXTF13.VALUE=''
           THISFORM.TXTF17.VALUE=''
           THISFORM.LBLF_C66.CAPTION = ''
           THISFORM.TRANS_STYLE.VALUE=1
           THISFORM.TXTF03.SETFOCUS
           QTY=P04.F09-TQTY
           THISFORM.LBLTQTY.CAPTION=TRANSFORM(QTY,'@J 99999999.99')
      ENDPROC
      PROC ORPGROUP.EDIT_BOTT.CLICK
           THISFORM.CMND2.ENABLED=.F. 
           THISFORM.PERMIT_BOTT.ENABLED=.F.                
           SELE D07
           RLOCK()
           IF !RLOCK()
              DO FILE_IMPACT
              THISFORM.GRID1.SETFOCUS
              THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 
           ELSE
              THISFORM.TXTF03.READONLY=.F.
              THISFORM.TXTF04.READONLY=.F.
              THISFORM.TXTF13.READONLY=.F.
              THISFORM.TXTF13.VISIBLE=.F.
              THISFORM.TRANS_STYLE.VISIBLE=.T.        
              THISFORM.TRANS_STYLE.DISPLAYVALUE=D07.F13
              THISFORM.TXTF03.SETFOCUS
              QTY=D07.F04           
           ENDIF                 
      ENDPROC      
      *******  
      PROC ORPGROUP.DEL_BOTT.CLICK
           IF MESSAGEBOX('是否確定要刪除此筆資料',4+32+256,'請確認') = 6	            
              SELE D07       
              DSPT=D07.F18                      &&暫存原來到貨分配說明
              IF RLOCK()
                 IF D07.F09='1'      &&如果已確認交期
                    SELE P38
                    SEEK D07.F01+D07.F02+DTOS(D07.F03)
                    IF FOUND()
                       H=''
                       CHG_ORD=CREATEOBJECT('CHG_ORD')
                       CHG_ORD.SHOW
                       SELE P38
                       REPL F05 WITH DATE()
                       REPL F06 WITH 0
                       REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
                       REPL F10 WITH H
                    ENDIF
                    SELE P07       &&回復請購狀態                 
                    SEEK LEFT(D07.F07,10)+D07.F02
                    IF FOUND()
                       REPL F07 WITH F07+D07.F04
                    ELSE                               
                       SELE P05
                       SEEK LEFT(D07.F07,10)
                       IF FOUND()
                          SELE P06
                          SEEK LEFT(D07.F07,10)+D07.F02
                          IF FOUND()
                             SELE P07
                             APPEND BLANK
                             REPL F01 WITH P05.F01
                             REPL F02 WITH P05.F02
                             REPL F03 WITH P05.F04
                             REPL F04 WITH P05.F05
                             REPL F05 WITH P05.F06
                             REPL F06 WITH P06.F02
                             REPL F07 WITH F07+D07.F04
                             REPL F08 WITH P06.F05
                             REPL F09 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
                             REPL F10 WITH P05.F07                                                                           
                          ENDIF
                       ENDIF      
                    ENDIF
                    SELE P04
                    REPL F22 WITH F22+D07.F04*(-1)                       
                 ELSE
                    SELE P07
                    SEEK LEFT(D07.F07,10)+D07.F02
                    IF FOUND()
                       REPL F11 WITH F11+D07.F04*(-1)
                    ENDIF      
                 ENDIF
                 SELECT D07
                 DELETE
                 UNLOCK             
                 IF BOF()
                    GO TOP
                 ELSE
                   SKIP -1   
                 ENDIF
                 BK=RECNO()
                 CALC SUM(F04) TO TQTY
                 IF TQTY>0
                    GO BK
                 ENDIF        
              ELSE
                 DO FILE_IMPACT                             
              ENDIF         
              THISFORM.GRID1.SETFOCUS
              IF THISFORM.GRID1.ACTIVEROW=0
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=.F.
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.F.   
                 THISFORM.ORPGROUP.NEW_BOTT.ENABLED=.T.            
                 THISFORM.SETALL('VALUE','','TEXTBOX')
                 THISFORM.TXTF03.VALUE=''
                 THISFORM.TXTF04.VALUE=''
                 THISFORM.TXTF13.VALUE=''
                 THISFORM.TXTF17.VALUE=''
                 THISFORM.PERMIT_BOTT.ENABLED=.F.
              ELSE      
                 THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1
                 THISFORM.ORPGROUP.DEL_BOTT.ENABLED=.T.
                 THISFORM.PERMIT_BOTT.ENABLED=IIF(D07.F09='0',.T.,.F.) AND !EMPTY(P03.F07)
              ENDIF           
           ENDIF   
           THISFORM.LBLTQTY.CAPTION=TRANSFORM(P04.F09-TQTY,'@J 99999999.99')
           THISFORM.CMND2.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.)
      ENDPROC
      *****
      PROC SHRGROUP.SHURE1_BOTT.CLICK
           IF SEEK(P04.F01+P04.F02+DTOS(THISFORM.TXTF03.VALUE),'D07')=.T.
              =MESSAGEBOX('進貨日期重複!',0+64,'提示訊息視窗')
              THISFORM.TXTF03.SETFOCUS
              RETURN              
           ENDIF
           IF THISFORM.TXTF03.VALUE<DATE()                       
              IF MESSAGEBOX('進貨日期小於本日，是否仍以此為進貨日?',4+32+256,'請確認') = 7	              
                 THISFORM.TXTF03.SETFOCUS
                 RETURN
               ENDIF       
           ENDIF
           SELECT P07
           SEEK LEFT(P04.F11,10)+P04.F02
           IF FOUND()
              REPL F11 WITH F11+THISFORM.TXTF04.VALUE
           ENDIF   
           SELE D07
           APPEND BLANK
           RLOCK()
           REPLACE D07.F01 WITH P04.F01
           REPLACE D07.F02 WITH P04.F02
           REPLACE D07.F03 WITH THISFORM.TXTF03.VALUE
           REPLACE D07.F04 WITH THISFORM.TXTF04.VALUE
           REPLACE D07.F05 WITH P03.F03           
           REPLACE D07.F07 WITH P04.F11           
           REPLACE D07.F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
           REPLACE D07.F09 WITH IIF(P04.F09-P04.F18=P04.F22,'1','0')
           REPLACE D07.F10 WITH P04.F13
           REPLACE D07.F13 WITH ALLTRIM(THISFORM.TRANS_STYLE.DISPLAYVALUE)
           REPLACE D07.F16 WITH P04.F14
           REPLACE D07.F17 WITH THISFORM.TXTF17.VALUE       
           IF !EMPTY(ALLTRIM(DSPT))
               REPLACE D07.F18 WITH DSPT    &&假設有其他筆刪除，或是有修改數量比原數量少時，暫存變數便會先記錄其到貨分配說明，新增時補到此筆的到貨說明欄位
           ENDIF    
           SELECT D07
           CALC SUM(F04) TO TQTY      
           SEEK P04.F01+P04.F02+DTOS(THISFORM.TXTF03.VALUE)           
           ***傳送郵件
           IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE' 
              MAIL_TEXT = ''
              TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
              WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
              MAIL_TEXT =  '採購單號：' + D07.F01 + TMPCHR + ;
     	        		   '料品編號：' + D07.F02 + TMPCHR + ;
     	        		   '進貨日期：' + DTCX(D07.F03)+ TMPCHR + ;
     	        		   '進貨數量：' + ALLTRIM(TRANSFORM(D07.F04,'@R 999,999,999,999')) + TMPCHR + ;
     	        		   '運貨方式：' + D07.F13 + TMPCHR + ;
     	        		   '備註說明：' + ALLTRIM(D07.F17) + TMPCHR + ;
     	        		   '需求單號：' + P05.F06 + TMPCHR + ;
     	        		   '採購用途：' + ALLTRIM(D07.F07) + SPACE(2) + P05.F04 + CHR(13) + CHR(10) 
     	       ***傳送給業務助理
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                 ASSIS_NO=A01.F01
                 IF OS()="Windows 5.01"
                    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已新增計畫','TEXT',MAIL_TEXT)     	        		    
                 ELSE                    
                    IF !EMPTY(ALLTRIM(ASSIS_NO))
                       FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                       STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已新增計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                    ENDIF   
                 ENDIF
              ELSE
                 ASSIS_NO=''   
              ENDIF  		   
              ***傳送給業務B             
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                 SALES_B_NO=A01.F01
                 IF SALES_B_NO<>ASSIS_NO
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已新增計畫','TEXT',MAIL_TEXT)     	        		    
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_B_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已新增計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       ENDIF   
                    ENDIF
                 ENDIF  
              ELSE
                 SALES_B_NO=''    
              ENDIF      
              ***傳送給業務A
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.
                 SALES_A_NO=A01.F01
                 IF SALES_A_NO<>SALES_B_NO 
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已新增計畫','TEXT',MAIL_TEXT)      	        		    
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_A_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已新增計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       ENDIF   
                    ENDIF                    
                 ENDIF   
              ELSE
                 SALES_A_NO='' 
              ENDIF 
                      
             
              WAIT CLEAR   
           ENDIF   
           ***
           UNLOCK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC         
      PROC SHRGROUP.SHURE2_BOTT.CLICK
           IF THISFORM.TXTF03.VALUE<DATE()                       
              IF MESSAGEBOX('進貨日期小於本日，是否仍以此為進貨日?',4+32+256,'請確認') = 7	              
                 THISFORM.TXTF03.SETFOCUS
                 RETURN
               ENDIF       
           ENDIF
           IF D07.F09='1'      &&如果已確認交期
              SELE P38     &&交期異動紀錄
              SEEK D07.F01+D07.F02+DTOS(D07.F03)
              IF FOUND()
                 IF THISFORM.TXTF03.VALUE<>F03 .OR. THISFORM.TXTF04.VALUE<>F04
                    H=''
                    CHG_ORD=CREATEOBJECT("CHG_ORD")  
                    CHG_ORD.SHOW    
                    SELE P38
                    REPL F05 WITH THISFORM.TXTF03.VALUE
                    REPL F06 WITH THISFORM.TXTF04.VALUE
                    REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
                    REPL F10 WITH H             
                    IF THISFORM.TXTF03.VALUE<>F03
                       APPEND BLANK
                       REPL F01 WITH D07.F01
                       REPL F02 WITH D07.F02
                       REPL F03 WITH THISFORM.TXTF03.VALUE
                       REPL F04 WITH THISFORM.TXTF04.VALUE
                       REPL F07 WITH D07.F07
                       REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
                       REPL F09 WITH D07.F11   
                       REPL F10 WITH H                   
                    ENDIF   
                 ENDIF   
              ENDIF   
              SELE P07       &&回復請購狀態第一二次                                            
              SEEK LEFT(D07.F07,10)+D07.F02
              IF FOUND()
                 REPL F07 WITH F07+D07.F04
                 REPL F07 WITH F07+THISFORM.TXTF04.VALUE*(-1)
                 IF F07<=0
                    DELE
                 ENDIF   
              ELSE                               
                 SELE P05
                 SEEK LEFT(D07.F07,10)
                 IF FOUND()
                    SELE P06
                    SEEK LEFT(D07.F07,10)+D07.F02
                    IF FOUND()
                       SELE P07
                       APPEND BLANK
                       REPL F01 WITH P05.F01
                       REPL F02 WITH P05.F02
                       REPL F03 WITH P05.F04
                       REPL F04 WITH P05.F05
                       REPL F05 WITH P05.F06
                       REPL F06 WITH P06.F02
                       REPL F07 WITH F07+D07.F04
                       REPL F08 WITH P06.F05
                       REPL F09 WITH IIF(SEEK(SYS_OPER,'A01'),A01.F03,'')
                       REPL F10 WITH P05.F07    
                       REPL F07 WITH F07+THISFORM.TXTF04.VALUE*(-1)
                       IF F07<=0
                          DELE
                       ENDIF                                                                                                 
                     ENDIF
                 ENDIF      
              ENDIF 
              SELE P04
              REPLACE  F22 WITH F22+D07.F04*(-1)
              REPLACE  F22 WITH F22+THISFORM.TXTF04.VALUE     
           ELSE
              SELE P07
              SEEK LEFT(D07.F07,10)+D07.F02
              IF FOUND()
                 REPLACE  F11 WITH F11+D07.F04*(-1)
                 REPLACE  F11 WITH F11+THISFORM.TXTF04.VALUE
              ENDIF                                           
           ENDIF      
           SELECT D07
           D07F03 = D07.F03
           D07F04 = D07.F04
           D07F13 = D07.F13          
           REPLACE D07.F07 WITH P04.F11 
           REPLACE D07.F03 WITH THISFORM.TXTF03.VALUE
           REPLACE D07.F04 WITH THISFORM.TXTF04.VALUE
           REPLACE D07.F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
           REPLACE D07.F13 WITH ALLTRIM(THISFORM.TRANS_STYLE.DISPLAYVALUE) 
           REPLACE D07.F17 WITH THISFORM.TXTF17.VALUE   
           IF D07F04<>D07.F04
              IF D07.F04< D07F04
                 DSPT=D07.F18         &&比原數量少時要先記錄到貨分配說明等待新增到別筆
              ELSE
                 IF EMPTY(ALLTRIM(D07.F18)) AND !EMPTY(ALLTRIM(DSPT))   &&筆原數量多時表示有刪除別筆補到此筆進貨數量
                    REPLACE D07.F18 WITH DSPT    &&判斷原來有無到貨分配說明如果沒有就以先前記錄的變數補上去
                 ENDIF   
              ENDIF
           ENDIF
           CALC SUM(F04) TO TQTY            
           SEEK P04.F01+P04.F02+DTOS(THISFORM.TXTF03.VALUE)           
                          
           ***傳送郵件
           MAIL_TEXT = ''
           TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
           FNTCHG1=IIF(OS()="Windows 5.01","","<font color='blue'>")
           FNTCHG2=IIF(OS()="Windows 5.01","","</font>")
           IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE' AND (D07F03 <> D07.F03 OR D07F04<>D07.F04 OR D07F13 <> D07.F13) 
              WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
              MAIL_TEXT = '採購單號：' + D07.F01 + TMPCHR + ;
     	         		  '料品編號：' + D07.F02 + TMPCHR + ;
     	         		  '進貨日期：' +IIF(D07F03<>D07.F03,FNTCHG1,'')+DTCX(D07F03) + '  ＞＞  ' + DTCX(D07.F03) +IIF(D07F03<>D07.F03,FNTCHG2,'')+ TMPCHR + ;
     	        		  '進貨數量：' +IIF(D07F04<>D07.F04,FNTCHG1,'')+ ALLTRIM(TRANSFORM(D07F04,'@R 999,999,999,999'))  + '  ＞＞  ' + ALLTRIM(TRANSFORM(D07.F04,'@R 999,999,999,999'))+IIF(D07F04<>D07.F04,FNTCHG2,'') + TMPCHR + ;
     	         		  '運貨方式：' +IIF(D07F13<>D07.F13,FNTCHG1,'')+ D07F13 + '  ＞＞  ' + D07.F13 +IIF(D07F13<>D07.F13,FNTCHG2,'')+ TMPCHR + ;
     	         		  '備註說明：' + ALLTRIM(D07.F17) + TMPCHR + ;
     	         		  '需求單號：' + P05.F06 + TMPCHR + ;
     	         		  '採購用途：' + ALLTRIM(D07.F07) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)
     	      ***傳送給業務助理                            
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.  
                 ASSIS_NO=A01.F01
                 IF OS()="Windows 5.01"
                    SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已更新計畫','TEXT',MAIL_TEXT)  	  
                 ELSE                    
                    IF !EMPTY(ALLTRIM(ASSIS_NO))
                       FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                       **STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                       STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD'+IIF(D07F03<D07.F03,' bgcolor="#FF0000"','')+'>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                    ENDIF   
                 ENDIF
              ELSE
                 ASSIS_NO=''   
              ENDIF    		  
              ***傳送給業務B 
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.   
                 SALES_B_NO=A01.F01
                 IF SALES_B_NO<>ASSIS_NO
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已更新計畫','TEXT',MAIL_TEXT) 	  
                    ELSE
                       IF !EMPTY(ALLTRIM(SALES_B_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                          **STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD'+IIF(D07F03<D07.F03,' bgcolor="#FF0000"','')+'>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1)                           
                       ENDIF   
                    ENDIF
                 ENDIF      
              ELSE
                 SALES_B_NO=''   
              ENDIF
              ***傳送給業務A
              IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.   
                 SALES_A_NO=A01.F01
                 IF SALES_A_NO<>SALES_B_NO 
                    IF OS()="Windows 5.01"
                       SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已更新計畫','TEXT',MAIL_TEXT)  	  
                    ELSE
                      IF !EMPTY(ALLTRIM(SALES_A_NO))
                         FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                         **STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                         STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD'+IIF(D07F03<D07.F03,' bgcolor="#FF0000"','')+'>已更新計劃<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10),FILE_NAME,1) 
                      ENDIF   
                    ENDIF
                 ENDIF  
              ELSE
                 SALES_A_NO=''    
              ENDIF
              
              
              WAIT CLEAR  
           ENDIF   
           ***     
                 
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK    
      ENDPROC
      PROC SHRGROUP.ABANDON_BOTT.CLICK
           THISFORM.SHRGROUP.ENABLED=.F.
           THISFORM.SHRGROUP.VISIBLE=.F.      
           THISFORM.ORPGROUP.ENABLED=.T.
           THISFORM.ORPGROUP.SETALL('FORECOLOR',RGB(0,0,0),'COMMANDBUTTON')
           THISFORM.SETALL('READONLY',.T.,'TEXTBOX') 
           THISFORM.LBLTQTY.CAPTION=TRANSFORM(P04.F09-TQTY,'@R 99999999.99') 
           THISFORM.ORPGROUP.NEW_BOTT.ENABLED=IIF(P04.F09-TQTY<>0,.T.,.F.)                          
*!*	           THISFORM.CMND2.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.)   
           THISFORM.CMND2.ENABLED= .T.
           THISFORM.ORPGROUP.EDIT_BOTT.ENABLED=IIF(P04.F09-TQTY>=0,.T.,.F.) .OR. THISFORM.GRID1.ACTIVEROW=1    
           THISFORM.LBLF_C66.CAPTION = IIF(EMPTY(D07.F14) OR D07.F14 ='4','','此筆計畫已被提出交期之異動 >> ' + ICASE(D07.F14 = '1','提前交期',D07.F14 = '2','延後交期',D07.F14 = '3','取消訂購',''))
           THISFORM.TXTF13.VISIBLE=.T.    
           THISFORM.TRANS_STYLE.VISIBLE=.F.                                                                    
           THISFORM.GRID1.ENABLED=.T.
           THISFORM.GRID1.SETFOCUS
           SELECT D07         
           UNLOCK ALL      
      ENDPROC
      PROC SHRGROUP.FINISH_BOTT.CLICK
           THISFORM.SHRGROUP.ABANDON_BOTT.CLICK
      ENDPROC
      PROCEDURE TXTF04.VALID
         LPARAMETERS  NINDEX
         IF THIS.VALUE<=P04.F09-TQTY+IIF(THISFORM.SHRGROUP.ENABLED=.T.,QTY,D07.F04)
            NINDEX=.T.
         ELSE
            =MESSAGEBOX("出貨數量不得大於"+TRANSFORM(P04.F09-TQTY+QTY,'@J 99999999.99'),0+64,"提示視窗") 
            IF P04.F09-TQTY+QTY<0
               NINDEX=.T.
            ELSE     
               NINDEX=.F.
            ENDIF   
         ENDIF
         RETURN NINDEX
      ENDPROC 
      PROCEDURE TXTF03.VALID
         LPARAMETERS  NINDEX
         IF !EMPTY(THIS.VALUE) .AND. THIS.VALUE>=P03.F01
            NINDEX=.T.
         ELSE
            =MESSAGEBOX("進貨日期不得空白且不能小於下單日"+DTCX(P03.F01),0+64,"提示視窗")    
            NINDEX=.F.
         ENDIF
         RETURN NINDEX
      ENDPROC 
      *****
  PROC PERMIT_BOTT.CLICK      &&確認交期
       IF RLOCK('P04') .AND. RLOCK('D07') 
          SELE P04
          REPL F22 WITH F22+D07.F04
          SELECT D07   
          REPLACE F09 WITH '1'
          REPLACE F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
          REPLACE F11 WITH F03
          IF !EMPTY(D07.F14) AND !EMPTY(D07.F15)
             REPLACE D07.F14 WITH '4'
             REPLACE D07.F15 WITH CTOD('')
          ENDIF
          ********
	   IF !USED('C05')
	      SELE 0
	      USE C05 INDE C05
	   ELSE
	      SELE C05
	   ENDIF
	   SET ORDER TO C051          
           SELECT P05
           SEEK LEFT(ALLTRIM(D07.F07),10)
           IF FOUND()          
	          SELE RECNO() FROM C05 WHERE C05.F01=P05.F06  INTO ARRAY BK1              
	          JJ1=''                
	          IF _TALLY>0   
	             FOR I= 1 TO ALEN(BK1)
	                 JJ1=JJ1+ALLTRIM(STR(BK1(I)))+','
	             ENDFOR    
	             KK1=STUFF(JJ1,RAT(',',JJ1,1),1,'')              
	             RLOCK(KK1,'C05')
	             LL1=RLOCK(KK1,'C05')
	          ELSE
	             LL1=.T.   
	          ENDIF   
	           IF LL1=.T. .AND. LEN(ALLTRIM(JJ1))>0      
	                SELECT C05
	                FOR I= 1 TO ALEN(BK1)                      
                                GO BK1(I)  
                        IF C05.F01=P05.F06 .AND. EMPTY(C05.F10) .AND. EMPTY(C05.F12)
*!*			                    REPLACE  C05.F07 WITH  IIF(INT_012=1,PADL(ALLTRIM(STR(YEAR(DATE())-1911)),3,' ')+RIGHT(DTOC(DATE()),6),dtoc(DATE())+' ')+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
*!*			                    REPLACE  C05.F10 WITH  D07.F11 
		                    REPLACE  C05.F12 WITH '1'    
		                ENDIF                     
                    ENDFOR        
	           ENDIF   
                   RELEASE ALL LIKE BK*
          ENDIF
	  SELECT C05
	  USE
          ******              
          SELE P07
          SEEK LEFT(P04.F11,10)+P04.F02    &&刪除待處理請購明細資料
          IF FOUND()
             REPL F07 WITH F07+D07.F04*(-1)
             REPL F11 WITH F11+D07.F04*(-1)  
             IF F07<=0
                DELE
             ENDIF   
          ENDIF   
          SELE P38
          APPEND BLANK
          REPL F01 WITH D07.F01
          REPL F02 WITH D07.F02
          REPL F03 WITH D07.F03
          REPL F04 WITH D07.F04
          REPL F07 WITH D07.F07
          REPL F08 WITH DTCX(DATE())+IIF(SEEK(sys_oper,'A01'),A01.F03,'')   
          REPL F09 WITH D07.F11    
           ***傳送郵件
           IF ALLTRIM(INT_DNS) <> 'FALSE' AND ALLTRIM(INT_MAI) <> 'FALSE' 
              MAIL_TEXT = ''
              TMPCHR=IIF(OS()="Windows 5.01",CHR(13)+CHR(10),'<br/>')
              WAIT WINDOW "傳送郵件,請稍後!" AT 0,150 NOWAIT NOCLEAR
              MAIL_TEXT = '採購單號：' + D07.F01 + TMPCHR + ;
     	         		  '料品編號：' + D07.F02 + TMPCHR + ;
     	         		  '進貨日期：' + DTCX(D07.F03) + TMPCHR + ;
     	        		  '進貨數量：' + ALLTRIM(TRANSFORM(D07.F04,'@R 999,999,999,999')) + TMPCHR + ;
     	         		  '運貨方式：' + D07.F13 + TMPCHR + ;
     	         		  '備註說明：' + ALLTRIM(D07.F17) + TMPCHR + ;
     	         		  '需求單號：' + P05.F06 + TMPCHR + ;
     	         		  '採購用途：' + ALLTRIM(D07.F07) + SPACE(2) + P05.F04 + CHR(13) + CHR(10)
     	       
     	           ***傳送給業務助理                            
                  IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F23,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.    
                     ASIS_NO=A01.F01
                     IF OS()="Windows 5.01"		 &&如果作業系統為WINDOWS XP 
                        SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已確定交期','TEXT',MAIL_TEXT)  	  
                     ELSE
                       IF !EMPTY(ALLTRIM(ASSIS_NO))
                          FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(ASSIS_NO)+'.TXT'                  
                          STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已確認交期<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10) ,FILE_NAME,1)
                       ENDIF   
                     ENDIF               
                  ELSE
                     ASSIS_NO=''        
                  ENDIF    		                
                  ***傳送給業務B 
                  IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F33,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.    
                     SALES_B_NO=A01.F01   
                     IF SALES_B_NO<>ASSIS_NO
                        IF OS()="Windows 5.01"		 &&如果作業系統為WINDOWS XP 
                           SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已確定交期','TEXT',MAIL_TEXT) 		  
                        ELSE
                           IF !EMPTY(ALLTRIM(SALES_B_NO))
                              FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_B_NO)+'.TXT'                  
                              STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已確認交期<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10) ,FILE_NAME,1)
                           ENDIF   
                        ENDIF
                     ENDIF   
                  ELSE
                     SALES_B_NO=''   
                  ENDIF
                  ***傳送給業務A
                  IF SEEK(LEFT(ALLTRIM(D07.F07),10),'P05') AND SEEK(P05.F04,'C01') AND SEEK(C01.F18,'A01') = .T. AND ALLTRIM(A01.F06) = 'Y' AND AT('@',A01.F10) <> 0 AND LEFT(ALLTRIM(D07.F07),2) = 'PA' AND EMPTY(MAIL_TEXT) = .F.  
                     SALES_A_NO=A01.F01
                     IF SALES_A_NO<>SALES_B_NO 
                        IF OS()="Windows 5.01"		 &&如果作業系統為WINDOWS XP 
                           SEND_MAIL(ALLTRIM(INT_MAI),ALLTRIM(A01.F10),ALLTRIM(INT_DNS),'系統通知：D08.進貨計畫之 ' + ALLTRIM(D07.F07) + '已確定交期','TEXT',MAIL_TEXT) 	  
                        ELSE
                           IF !EMPTY(ALLTRIM(SALES_A_NO))
                              FILE_NAME=ALLTRIM(INT_DAT)+ALLTRIM(SALES_A_NO)+'.TXT'                  
                              STRTOFILE('<TR><TD>'+MAIL_TEXT+'<TD>已確認交期<TD>'+TTOC(DATETIME())+ CHR(13) + CHR(10) ,FILE_NAME,1)
                           ENDIF   
                        ENDIF
                     ENDIF   
                 ELSE
                    SALES_A_NO=''    
                 ENDIF                           
                 WAIT CLEAR  
                
           ENDIF   
           ***         
       ELSE
         DO FILE_IMPACT                  
       ENDIF    
       UNLOCK ALL 
       THISFORM.SHRGROUP.ABANDON_BOTT.CLICK 
       THISFORM.GRID1.SETFOCUS
       THIS.ENABLED=.F.
  ENDPROC                     
ENDDEFINE            
****************************************輸入異動單號畫面
DEFINE CLASS CHG_ORD AS FORM
  AUTOCENTER=.T.
  CAPTION='輸入異動單號'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*175
  WIDTH=INT_015*325
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='CHG_ORD'
  ADD OBJECT LABEL1 AS LABEL WITH;
      AUTOSIZE=.T.,;
      HEIGHT=INT_015*25,;
      LEFT=INT_015*30,;
      TOP=INT_015*75,;
      FONTSIZE=INT_015*9,;
      NAME='LABEL1'
      ADD OBJECT TEXT1 AS TEXTBOX WITH;
          AUTOSIZE=.T.,;
          TOP=INT_015*70,;
          WIDTH=INT_015*180,;
          LEFT=INT_015*120,;
          HEIGHT=INT_015*25,; 
          FONTSIZE=INT_015*9,;
          NAME='TEXT1'
      ADD OBJECT CMND1 AS COMMANDBUTTON WITH;
          AUTOSIZE=.T.,;
          LEFT=INT_015*60,;    
          HEIGHT=INT_015*25,;   
          TOP=INT_015*144,;  
          WIDTH=INT_015*80,;
          FONTSIZE=INT_015*9,;          
          CAPTION='\<Y.執行',;
          TOOLTIPTEXT='確認搜尋所輸入的單號!快速鍵->ALT+Y',;
          NAME='CMND1'
      ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
          AUTOSIZE=.T.,;
          LEFT=INT_015*200,;
          TOP=INT_015*144,;
          HEIGHT=INT_015*25,;
          WIDTH=INT_015*80,;
          FONTSIZE=INT_015*9,;
          CAPTION='\<C.取消',;
          TOOLTIPTEXT='取消搜尋作業!快速鍵->ALT+C',;
          NAME='CMND2'
      PROCEDURE INIT 
          THISFORM.LABEL1.CAPTION='異動單號'
          THISFORM.TEXT1.VALUE=''
      ENDPROC    
      PROCEDURE CMND1.CLICK 
           H=THISFORM.TEXT1.VALUE       
          
           THISFORM.RELEASE                
      ENDPROC
      PROCEDURE CMND2.CLICK
          THISFORM.RELEASE
      ENDPROC      
ENDDEFINE            
************************************************進貨紀錄
DEFINE CLASS RCC_SEEK AS FORM
  AUTOCENTER=.T.
  CAPTION='進貨紀錄'
  FONTSIZE=INT_015*9
  HEIGHT=INT_015*345
  WIDTH=INT_015*360
  CONTROLBOX=.F.
  BORDERSTYLE=2
  SHOWTIPS=.T.
  SHOWWINDOW=1
  WINDOWTYPE=1
  NAME='RCC_SEEK'
  ADD OBJECT GRID1 AS GRID WITH;          
      AUTOCENTER=.T.,;
      ALLOWCELLSELECTION=.F.,;
      TOP=0,;
      WIDTH=INT_015*359,;      
      HEIGHT=INT_015*310,;      
      DELETEMARK=.F.,;
      READONLY=.T.,;
      ROWHEIGHT=INT_015*18,;
      HEADERHEIGHT=INT_015*19,;
      RECORDSOURCETYPE=1,;
      COLUMNCOUNT=4,;            
      NAME='GRID1',;
      COLUMN1.NAME='COLUMN1',;
      COLUMN2.NAME='COLUMN2',;      
      COLUMN3.NAME='COLUMN3',;   
      COLUMN4.NAME='COLUMN4'         
  ADD OBJECT CMDGROUP AS CMDGROUP WITH;      
      TOP=INT_015*310,;
      LEFT=INT_015*47,;
      VISIBLE=.T.      
  ADD OBJECT CMND2 AS COMMANDBUTTON WITH;
      LEFT=INT_015*255,;
      TOP=INT_015*315,;
      HEIGHT=INT_015*25,;
      WIDTH=INT_015*40,;
      FONTSIZE=INT_015*9,;
      CAPTION='\<X.離開',;
      TOOLTIPTEXT='離開此查詢尋畫面!快速鍵->ALT+X'
      NAME='CMND2'
      PROCEDURE INIT 
         AREA1='RCC' 
         THISFORM.GRID1.READONLY=.T. 
         THISFORM.GRID1.RECORDSOURCE='RCC'
         THISFORM.CMDGROUP.SEEK_BOTT.VISIBLE=.F.
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'COLUMN')
         THISFORM.GRID1.SETALL('FONTSIZE',INT_015*9,'HEADER')         
         THISFORM.GRID1.COLUMN1.HEADER1.CAPTION='進貨日期'
         THISFORM.GRID1.COLUMN1.CONTROLSOURCE='F03'         
         THISFORM.GRID1.COLUMN1.WIDTH=INT_015*65      
         THISFORM.GRID1.COLUMN2.HEADER1.CAPTION='進(退)貨單號'
         THISFORM.GRID1.COLUMN2.CONTROLSOURCE='F04'         
         THISFORM.GRID1.COLUMN2.WIDTH=INT_015*80
         THISFORM.GRID1.COLUMN3.HEADER1.CAPTION='進(退)貨數量'
         THISFORM.GRID1.COLUMN3.CONTROLSOURCE='F05'
         THISFORM.GRID1.COLUMN3.WIDTH=INT_015*100
         THISFORM.GRID1.COLUMN4.HEADER1.CAPTION='運貨方式'
         THISFORM.GRID1.COLUMN4.CONTROLSOURCE='F06'
         THISFORM.GRID1.COLUMN4.WIDTH=INT_015*80         
         THISFORM.GRID1.SETFOCUS
         IF THISFORM.GRID1.ACTIVEROW<>0
              THISFORM.GRID1.AFTERROWCOLCHANGE 
         ENDIF         
      ENDPROC
      PROC GRID1.AFTERROWCOLCHANGE
       LPARAMETERS XCOLINDEX     
         FCH=THISFORM.ACTIVECONTROL.NAME  
      ENDPROC 
      PROCEDURE CMND2.CLICK
          FLG=''   
          THISFORM.RELEASE
      ENDPROC      
ENDDEFINE            
*****************************交期自訂函數
FUNC DELIVER
     PARA BKK_NO,MAT
     QT_OD=SPACE(0)
     SELE D07
     SET ORDER TO  D074
     SEEK BKK_NO+MAT
     IF FOUND()
        DO WHILE F01+F02=BKK_NO+MAT
           IF D07.F09='1'
              IF INT_012=1
                 qt_od=qt_od+TRANSFORM(VAL(LEFT(DTOS(F03),4))-1911,'@R ###')+RIGHT(DTOC(F03),6)+'->'+ALLTRIM(TRANSFORM(F04,'@J 99999999.99'))+SPACE(3)
              ELSE
                 QT_OD=QT_OD+DTOC(D07.F03)+'->'+ALLTRIM(TRANSFORM(D07.F04,'@J 99999999.99'))+SPACE(4)
              ENDIF   
           ENDIF    
           SELECT D07
           SKIP
        ENDDO
     ELSE
       QT_OD=SPACE(0)
     ENDIF
     SELE P04
     RETURN QT_OD
